---
title: æ•™ç¨‹ 4ï¼šè®¤è¯å’Œæƒé™
date: 2021-04-13 10:27:57
permalink: /drf-tutorial/authentication-and-permissions/
categories:
  - ğŸ“–æ–‡æ¡£ä¹¦ç±
  - Django-REST-framework æ•™ç¨‹ä¸­æ–‡ç‰ˆ
tags:
  - DRF
---

ç°åœ¨æˆ‘ä»¬çš„ API æ²¡æœ‰ä»»ä½•é™åˆ¶è°å¯ä»¥ç¼–è¾‘åˆ é™¤ä»£ç ç‰‡æ®µï¼Œæˆ‘ä»¬éœ€è¦ä¸€äº›æ›´å¥½çš„åŠŸèƒ½æ¥æ»¡è¶³ä¸‹åˆ—è¦æ±‚ï¼š

*   ä»£ç ç‰‡æ®µéœ€è¦å’Œåˆ›å»ºè€…è¿›è¡Œå…³è”
*   åªæœ‰è®¤è¯ç”¨æˆ·å¯ä»¥åˆ›å»ºæ–°çš„ä»£ç ç‰‡æ®µ
*   åªæœ‰åˆ›å»ºè€…æ‰èƒ½ä¿®æ”¹æˆ–åˆ é™¤ä»£ç ç‰‡æ®µ
*   æœªè®¤è¯ç”¨æˆ·åªæœ‰åªè¯»æƒé™

å‘æ¨¡å‹ä¸­æ–°å¢å­—æ®µ
--------

`Snippet`æ¨¡å‹éœ€è¦ä½œå‡ºä¸€äº›æ”¹å˜ã€‚é¦–å…ˆæ·»åŠ  2 ä¸ªå­—æ®µï¼Œä¸€ä¸ªå­—æ®µç”¨äºè¡¨æ˜è°åˆ›å»ºäº†è¿™ä¸ªä»£ç ç‰‡æ®µï¼Œå¦ä¸€ä¸ªç”¨æ¥å­˜å‚¨é«˜äº®çš„ HTML ä»£ç ã€‚

ç¼–è¾‘`models.py`ä¸­å…³äº`Snippet`çš„æ¨¡å‹ï¼Œæ–°å¢ä¸‹åˆ—ä»£ç ï¼š
```python
owner = models.ForeignKey('auth.User', related_name='snippets', on_delete=models.CASCADE)
highlighted = models.TextField()
```
ä¹Ÿè¦ç¡®ä¿å½“å®ä¾‹è¢«ä¿å­˜æ—¶ï¼Œä½¿ç”¨`pygments`åº“æ¥æ­£ç¡®å¤„ç† highlighted å­—æ®µã€‚

æ‰€ä»¥éœ€è¦å¼•å…¥ä¸€äº›é¢å¤–çš„åŒ…ï¼š
```python
from pygments.lexers import get_lexer_by_name
from pygments.formatters.html import HtmlFormatter
from pygments import highlight
```

æ¥ä¸‹æ¥ï¼Œæ·»åŠ `.save()`åˆ°æ¨¡å‹ä¸­ï¼š
```python
def save(self, *args, **kwargs):
    """
    ä½¿ç”¨pygmentsæ¥åˆ›å»ºé«˜äº®çš„HTMLä»£ç ã€‚
    """
    lexer = get_lexer_by_name(self.language)
    linenos = self.linenos and 'table' or False
    options = self.title and {'title': self.title} or {}
    formatter = HtmlFormatter(style=self.style, linenos=linenos,
                                full=True, **options)
    self.highlighted = highlight(self.code, lexer, formatter)
    super(Snippet, self).save(*args, **kwargs)
```

å®Œæˆä¸Šé¢çš„æ­¥éª¤åï¼Œæˆ‘ä»¬éœ€è¦æ›´æ–°æ•°æ®åº“è¡¨ã€‚æ­£å¸¸æƒ…å†µä¸‹æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ•°æ®åº“è¿ç§»ä»»åŠ¡æ¥å®ç°è¿™ä¸ªç›®æ ‡ï¼Œä½†åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œæˆ‘ä»¬åˆ é™¤æ•´ä¸ªæ•°æ®åº“é‡æ–°å»ºè¡¨ï¼š
```shell
rm -f tmp.db db.sqlite3
rm -r snippets/migrations
python manage.py makemigrations snippets
python manage.py migrate
```

ä½ ä¹Ÿè®¸è¿˜éœ€è¦åˆ›å»ºå‡ ä¸ªç”¨æˆ·æ¥æµ‹è¯• APIï¼Œæœ€ç®€ä¾¿çš„åŠæ³•è¿˜æ˜¯ä½¿ç”¨`python manage.py createsuperuser`å‘½ä»¤ã€‚
```python
python manage.py createsuperuser
```

ä¸ºç”¨æˆ·æ¨¡å‹æ·»åŠ æ¥å£
---------

ç°åœ¨æˆ‘ä»¬æœ‰ä¸€äº›ç”¨æˆ·äº†ï¼Œæˆ‘ä»¬æœ€å¥½åœ¨ API ä¸­æ·»åŠ äº›ç”¨æˆ·ç›¸å…³çš„æ¥å£ã€‚ä¿®æ”¹`serializers.py`å¹¶æ·»åŠ ä¸‹åˆ—ä»£ç ï¼š
```python
from django.contrib.auth.models import User

class UserSerializer(serializers.ModelSerializer):
    snippets = serializers.PrimaryKeyRelatedField(many=True, queryset=Snippet.objects.all())

    class Meta:
        model = User
        fields = ('id', 'username', 'snippets')
```

å› ä¸º `'snippets'` å’Œç”¨æˆ·æ˜¯ä¸€ç§åå‘å…³è”ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸ä¼šåŒ…å«åœ¨`ModelSerializer`ç±»ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ‰‹åŠ¨æ·»åŠ ã€‚

æˆ‘ä»¬ä¹Ÿéœ€è¦å¯¹`views.py`è¿›è¡Œä¿®æ”¹ï¼Œå¦å¤–ç”¨æˆ·é¡µé¢æ˜¯åªè¯»çš„ï¼Œæ‰€ä»¥ä½¿ç”¨`ListAPIView`ä»¥åŠ `RetrieveAPIView`è¿™ 2 ä¸ªé€šç”¨ç±»è§†å›¾ï¼š
```python
from django.contrib.auth.models import User


class UserList(generics.ListAPIView):
    queryset = User.objects.all()
    serializer_class = UserSerializer


class UserDetail(generics.RetrieveAPIView):
    queryset = User.objects.all()
    serializer_class = UserSerializer

```

ç¡®ä¿å¼•å…¥äº†`UserSerializer`ç±»ï¼š
```python
from snippets.serializers import UserSerializer
```

æœ€åè¿˜éœ€è¦å¯¹å…¶è¿›è¡Œ URL çš„é…ç½®ï¼Œä¿®æ”¹`urls.py`ï¼Œæ·»åŠ ä¸‹åˆ—ä»£ç ï¼š
```python
path('users/', views.UserList.as_view()),
path('users/<int:pk>/', views.UserDetail.as_view()),
```
å…³è” user å’Œ snippet
--------------

ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä»£ç ç‰‡æ®µï¼Œæ˜¯æ²¡æ³•å’Œç”¨æˆ·è¿›è¡Œå…³è”çš„ã€‚å› ä¸ºç”¨æˆ·ä¿¡æ¯æ˜¯é€šè¿‡ request è·å–è€Œä¸æ˜¯ä»¥ serialized æ•°æ®ä¼ é€’çš„ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æˆ‘ä»¬éœ€è¦é‡å†™ snippet è§†å›¾ä¸­`.perform_create()`æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å‡†è®¸æˆ‘ä»¬ä¿®æ”¹å®ä¾‹å¦‚ä½•è¢«ä¿å­˜ã€å¤„ç†ä»»ä½•ç”± request æˆ– requested URL ä¼ é€’è¿›æ¥çš„éšå«æ•°æ®ã€‚

ä¿®æ”¹`SnippetList`ï¼Œæ–°å¢ä¸‹åˆ—ä»£ç ï¼š
```python
def perform_create(self, serializer):
    serializer.save(owner=self.request.user)
```

ç°åœ¨`create()`æ–¹æ³•å°†è·å¾—ä¸€ä¸ªæ–°çš„å­—æ®µ`'owner'`,å€¼å°±æ˜¯ request ä¸­çš„ç”¨æˆ·ä¿¡æ¯ã€‚

æ›´æ–° serializer
------------

ç°åœ¨ä»£ç ç‰‡æ®µå’Œåˆ›å»ºè€…ä¹‹é—´å»ºç«‹äº†è”ç³»ï¼Œç°åœ¨éœ€è¦ä¿®æ”¹`SnippetSerializer`æ¥åæ˜ è¿™ä¸€å˜åŒ–ã€‚ä¿®æ”¹`serializers.py`æ·»åŠ ä¸‹åˆ—ä»£ç ï¼š
```python
owner = serializers.ReadOnlyField(source='owner.username')
```
:::tip
æ³¨æ„ï¼šç¡®ä¿ä½ ä¹Ÿæ·»åŠ äº†'owner'åˆ°å†…éƒ¨ç±»`Meta`ä¸­çš„ fields å­—æ®µé‡Œã€‚
:::
è¿™ä¸ªå­—æ®µæ­£åœ¨åšä¸€äº›éå¸¸æœ‰è¶£çš„äº‹æƒ…ã€‚`source`å‚æ•°æ§åˆ¶å“ªä¸ªå±æ€§ç”¨äºå¡«å……å­—æ®µï¼Œå¹¶å¯ä»¥æŒ‡å‘åºåˆ—åŒ–å®ä¾‹ä¸Šçš„ä»»ä½•å±æ€§ã€‚å®ƒä¹Ÿå¯ä»¥é‡‡ç”¨ä¸Šé¢æ‰€ç¤ºçš„ç‚¹ç¬¦å·ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒå°†éå†ç»™å®šçš„å±æ€§ï¼Œä¸ Django çš„æ¨¡æ¿è¯­è¨€ä½¿ç”¨çš„æ–¹å¼ç±»ä¼¼ã€‚

è¿™é‡Œæˆ‘ä»¬è¿˜ä½¿ç”¨äº†`ReadOnlyField`ç±»å‹ï¼Œä¸åŒäºå…¶ä»–å­—æ®µç±»å‹ï¼Œæ¯”å¦‚`CharField`, `BooleanField`ç­‰ã€‚è¿™ç§ç±»å‹æ˜¯åªè¯»çš„ï¼Œç”¨äºè¿›è¡Œåºåˆ—åŒ–æ—¶å€™çš„å±•ç¤ºï¼Œå¹¶ä¸”ååºåˆ—åŒ–æ—¶ä¸ä¼šè¢«ä¿®æ”¹ã€‚è¿™é‡Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨`CharField(read_only=True)`æ¥æ›¿ä»£å®ƒã€‚

æ·»åŠ æƒé™è®¤è¯
------

ç°åœ¨æˆ‘ä»¬å°†ä»£ç ç‰‡æ®µå’Œç”¨æˆ·è¿›è¡Œäº†å…³è”ï¼Œä½†æˆ‘ä»¬éœ€è¦ç¡®ä¿åªæœ‰è®¤è¯ç”¨æˆ·æ‰èƒ½åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤ä»£ç ç‰‡æ®µã€‚

REST framework åŒ…å«äº†å¤šç§è®¤è¯ç±»ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨`IsAuthenticatedOrReadOnly`ï¼Œè¿™ä¸ªç±»ç¡®ä¿äº†åªæœ‰è®¤è¯ç”¨æˆ·æ‰æœ‰è¯»å†™æƒé™ï¼Œæœªè®¤è¯ç”¨æˆ·åˆ™åªæœ‰åªè¯»æƒé™ã€‚

ä¿®æ”¹`views.py`,æ·»åŠ ï¼š
```python
from rest_framework import permissions
```  

ç„¶åä¿®æ”¹`SnippetList`å’Œ`SnippetDetail`ç±»ï¼Œæ·»åŠ ï¼š
```python
permission_classes = [permissions.IsAuthenticatedOrReadOnly]
```

æ·»åŠ ç™»å½•åŠŸèƒ½
------

å¦‚æœä½ ç°åœ¨æ‰“å¼€æµè§ˆå™¨ï¼Œä½ ä¼šå‘ç°ä½ æ— æ³•åˆ›å»ºæ–°çš„ä»£ç ç‰‡æ®µäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯ç”¨ç”¨æˆ·ç™»å½•åŠŸèƒ½ã€‚ç¼–è¾‘`tutorial/urls.py`æ–°å¢ä»£ç :
```python
from django.conf.urls import include
```

åœ¨æœ€åï¼Œæ·»åŠ ï¼š
```python
urlpatterns += [
    path('api-auth/', include('rest_framework.urls')),
]
```

ä½ å¯ä»¥å°†'api-auth'æ›¿æ¢æˆä»»ä½•ä½ å–œæ¬¢çš„å­—ç¬¦ä¸²ï¼Œå”¯ä¸€çš„é™åˆ¶å°±æ˜¯ namespace å¿…é¡»ä¸º'rest\_framework'ã€‚åœ¨ Django1.9+çš„ç‰ˆæœ¬ä¸­ï¼ŒREST framework å°†è‡ªåŠ¨è®¾ç½®ï¼Œæ‰€ä»¥æ— éœ€ç†ä¼šã€‚

ç°åœ¨å†æ¬¡åˆ·æ–°é¡µé¢å°†åœ¨å³ä¸Šè§’çœ‹åˆ°'Login'æŒ‰é’®ï¼Œç™»å½•åå°±å¯ä»¥åˆ›å»ºæ–°ä»£ç ç‰‡æ®µäº†ã€‚

å½“ä½ åˆ›å»ºäº†å‡ ä¸ªä»£ç ç‰‡æ®µåï¼Œè®¿é—®`/users/`é¡µé¢ï¼Œå°±ä¼šçœ‹åˆ°æ¯ä¸ªç”¨æˆ·å¯¹åº”çš„ä»£ç ç‰‡æ®µçš„ä¸»é”®åˆ—è¡¨äº†ã€‚

å¯¹è±¡çº§åˆ«çš„æƒé™
-------

ç°åœ¨æ‰€æœ‰äººéƒ½å¯ä»¥æµè§ˆä»£ç ç‰‡æ®µäº†ï¼Œæ¥ä¸‹æ¥å®ç°åªæœ‰åˆ›å»ºè€…æ‰èƒ½åˆ é™¤æˆ–ä¿®æ”¹è‡ªå·±çš„ä»£ç ç‰‡æ®µåŠŸèƒ½ã€‚æƒ³å®ç°è¿™ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰æƒé™è®¤è¯æ–¹æ³•ã€‚

æ–°å»ºæ–‡ä»¶`permissions.py`ï¼š
```python
from rest_framework import permissions


class IsOwnerOrReadOnly(permissions.BasePermission):
    """
    è‡ªå®šä¹‰æƒé™ï¼Œåªæœ‰åˆ›å»ºè€…æ‰èƒ½ç¼–è¾‘
    """

    def has_object_permission(self, request, view, obj):
        # Read permissions are allowed to any request,
        # so we'll always allow GET, HEAD or OPTIONS requests.
        if request.method in permissions.SAFE_METHODS:
            return True

        # Write permissions are only allowed to the owner of the snippet.
        return obj.owner == request.user
```

æ¥ä¸‹æ¥ä¿®æ”¹`SnippetDetail`è§†å›¾ï¼š
```python
permission_classes = [permissions.IsAuthenticatedOrReadOnly,
                      IsOwnerOrReadOnly]
```
    

å¹¶ç¡®ä¿å¼•å…¥äº†æ‰€éœ€çš„ç±»ï¼š
```python
from snippets.permissions import IsOwnerOrReadOnly
``` 

å†æ¬¡æ‰“å¼€æµè§ˆå™¨ï¼Œå¦‚æœä½ æ˜¯è¿™ä¸ªä»£ç ç‰‡æ®µçš„åˆ›å»ºè€…çš„è¯ï¼Œä½ ä¼šçœ‹åˆ°'DELETE'å’Œ'PUT'æ“ä½œæŒ‰é’®ã€‚

ä¸º API è°ƒç”¨æ·»åŠ è®¤è¯ä¿¡æ¯
------------

å› ä¸ºæˆ‘ä»¬æ·»åŠ äº†æƒé™è®¤è¯ï¼Œæ‰€ä»¥æˆ‘ä»¬æƒ³ç¼–è¾‘ä»»ä½•ä»£ç ç‰‡æ®µæ—¶éƒ½éœ€è¦æä¾›è®¤è¯ä¿¡æ¯ã€‚æˆ‘ä»¬å¹¶æ²¡æœ‰è®¾ç½®ä»»ä½•è®¤è¯ç›¸å…³çš„ç±»ï¼Œç›®å‰é»˜è®¤çš„è®¤è¯æ–¹æ³•æ˜¯`SessionAuthentication`å’Œ`BasicAuthentication`ã€‚

å½“æˆ‘ä»¬ä½¿ç”¨æµè§ˆå™¨è®¿é—®æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ç™»å½•ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å¤„ç† session ä¿¡æ¯ç”¨äºè®¤è¯ã€‚å½“æˆ‘ä»¬ä½¿ç”¨ç¼–ç¨‹æ–¹å¼è°ƒç”¨ API æ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ˜¾å¼çš„ä¸ºæ¯ä¸ªè¯·æ±‚æä¾›è®¤è¯ä¿¡æ¯ã€‚

å¦‚æœæˆ‘ä»¬å°è¯•åˆ›å»ºä¸€ä¸ªä»£ç ç‰‡æ®µè€Œæœªæä¾›è®¤è¯æ¶ˆæ¯çš„è¯ï¼Œæˆ‘ä»¬ä¼šå¾—åˆ°ä¸€ä¸ªé”™è¯¯è¿”å›ï¼š
```shell
http POST http://127.0.0.1:8000/snippets/ code="print 123"

{
    "detail": "Authentication credentials were not provided."
}
```    

è€Œæä¾›ç”¨æˆ·åå’Œå¯†ç å°±å¯ä»¥åˆ›å»ºäº†ï¼š
```shell
http -a tom:password123 POST http://127.0.0.1:8000/snippets/ code="print 789"

{
    "id": 5,
    "owner": "tom",
    "title": "foo",
    "code": "print 789",
    "linenos": false,
    "language": "python",
    "style": "friendly"
}
```

## æ€»ç»“

ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»åœ¨ Web API ä¸Šè·å¾—äº†ä¸€ç»„ç›¸å½“ç»†ç²’åº¦çš„æƒé™ï¼Œä»¥åŠç³»ç»Ÿç”¨æˆ·å’Œä»–ä»¬åˆ›å»ºçš„ä»£ç ç‰‡æ®µçš„ç«¯ç‚¹ã€‚

åœ¨æœ¬æ•™ç¨‹çš„ç¬¬ 5 éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†äº†è§£å¦‚ä½•é€šè¿‡ä¸ºçªå‡ºæ˜¾ç¤ºçš„ä»£ç ç‰‡æ®µåˆ›å»º HTML ç«¯ç‚¹æ¥å°†æ‰€æœ‰ä¸œè¥¿è”ç³»åœ¨ä¸€èµ·ï¼Œå¹¶é€šè¿‡ä¸ºç³»ç»Ÿå†…çš„å…³ç³»ä½¿ç”¨è¶…é“¾æ¥æ¥æ”¹è¿› API çš„å†…èšæ€§ã€‚