---
title: æ•™ç¨‹ 2ï¼šRequests å’Œ Responses
date: 2021-04-13 10:26:46
permalink: /drf-tutorial/requests-and-responses/
categories:
  - ğŸ“–æ–‡æ¡£ä¹¦ç±
  - Django-REST-framework æ•™ç¨‹ä¸­æ–‡ç‰ˆ
tags:
  - DRF
---

ä»æœ¬ç« å¼€å§‹ï¼Œæˆ‘ä»¬å°†å¼€å§‹æ¢ç´¢æ¡†æ¶çš„æ ¸å¿ƒï¼Œè¿™é‡Œå…ˆä»‹ç»ä¸€äº›é‡è¦çš„æ¦‚å¿µã€‚

Request å¯¹è±¡
---------

REST framework ä½¿ç”¨ä¸€ä¸ªå«`Requests`çš„å¯¹è±¡æ‰©å±•äº†åŸç”Ÿçš„`HttpRequest`ï¼Œå¹¶æä¾›äº†æ›´çµæ´»çš„è¯·æ±‚å¤„ç†ã€‚`Requests`å¯¹è±¡çš„æ ¸å¿ƒå±æ€§å°±æ˜¯`request.data`ï¼Œå’Œ`requests.POST`ç±»ä¼¼ï¼Œä½†æ›´å¼ºå¤§ï¼š
```shell
request.POST  # åªå¤„ç†formæ•°æ®.åªæ¥å—'POST'æ–¹æ³•.
request.data  # å¤„ç†ä»»æ„æ•°æ®.æ¥å—'POST','PUT'å’Œ'PATCH'æ–¹æ³•.
```

Response å¯¹è±¡
----------

REST framework ä¹Ÿæä¾›äº†ä¸€ä¸ªè·å–æœªæ¸²æŸ“ï¼ˆunrenderedï¼‰å†…å®¹ä¸º`TemplateResponse`ç±»å‹çš„`Response`å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨å†…å®¹åå•†æ¥ç¡®å®šè¿”å›ç»™å®¢æˆ·ç«¯çš„æ­£ç¡®å†…å®¹ç±»å‹ã€‚(åŸæ–‡å¦‚ä¸‹ï¼Œè¿™å¥è¯æˆ‘æ€ä¹ˆç¿»è¯‘éƒ½è§‰å¾—åˆ«æ‰­ï¼Œæ„æ€å°±æ˜¯å®¢æˆ·ç«¯è¦ç¥ç ç±»å‹å®ƒè¿”å›ç¥ç ç±»å‹)

> REST framework also introduces a Response object, which is a type of TemplateResponse that takes unrendered content and uses content negotiation to determine the correct content type to return to the client.
```shell
    return Response(data)  # è¿”å›ç±»å‹ç”±å‘å‡ºè¯·æ±‚çš„å®¢æˆ·ç«¯å†³å®š
```

çŠ¶æ€ç 
---

ä½¿ç”¨æ•°å­— HTTP çŠ¶æ€ç å¹¶ä¸æ€»æ˜¯æ˜“äºé˜…è¯»çš„ï¼Œå¹¶ä¸”å½“ä½ å¾—åˆ°ä¸€ä¸ªé”™è¯¯çš„çŠ¶æ€ç æ—¶ä¸å®¹æ˜“å¼•èµ·æ³¨æ„ã€‚REST framework ä¸ºæ¯ä¸ªçŠ¶æ€ç éƒ½æä¾›äº†æ›´æ˜æ˜¾çš„æ ‡å¿—ï¼Œæ¯”å¦‚`status`æ¨¡å—ä¸­çš„`HTTP_400_BAD_REQUEST`ï¼Œä½¿ç”¨å®ƒä»¬æ›¿ä»£æ•°å­—æ˜¯ä¸€ä¸ªå¥½æ³¨æ„ã€‚

è£…é¥° API è§†å›¾
-------

REST framework æä¾›äº† 2 ç§è£…é¥°å™¨æ¥ç¼–å†™è§†å›¾ï¼š

1.  åŸºäºå‡½æ•°è§†å›¾çš„`@api_view`
2.  åŸºäºç±»è§†å›¾çš„`APIView`

è¿™äº›è£…é¥°å™¨æä¾›äº†å°‘è®¸åŠŸèƒ½ï¼Œæ¯”å¦‚ç¡®ä¿åœ¨è§†å›¾ä¸­æ¥æ”¶`Request`å®ä¾‹ï¼Œæ·»åŠ  context åˆ°`Resonse`å¯¹è±¡æ¥å†³å®šè¿”å›ç±»å‹ã€‚

æ­¤å¤–è¿˜æä¾›äº†é€‚å½“çš„é”™è¯¯å¤„ç†ï¼Œæ¯”å¦‚`405 Method Not Allowed`ã€å¹¶å¤„ç†åœ¨ä½¿ç”¨æ ¼å¼é”™è¯¯çš„è¾“å…¥æ¥è®¿é—®`request.data`æ—¶å‘ç”Ÿçš„ä»»ä½•`ParseError`å¼‚å¸¸ã€‚

ååŒå·¥ä½œ
----

ç°åœ¨æˆ‘ä»¬ä½¿ç”¨è¿™äº›ç»„ä»¶æ¥æ”¹å†™ views.

æˆ‘ä»¬ä¸å†éœ€è¦`JSONResponse`ç±»äº†ï¼Œåˆ é™¤å®ƒåä¿®æ”¹ä»£ç å¦‚ä¸‹ï¼š
```python
from rest_framework import status
from rest_framework.decorators import api_view
from rest_framework.response import Response
from snippets.models import Snippet
from snippets.serializers import SnippetSerializer


@api_view(['GET', 'POST'])
def snippet_list(request):
    """
    å±•ç¤ºæˆ–åˆ›å»ºsnippets.
    """
    if request.method == 'GET':
        snippets = Snippet.objects.all()
        serializer = SnippetSerializer(snippets, many=True)
        return Response(serializer.data)

    elif request.method == 'POST':
        serializer = SnippetSerializer(data=request.data)
        if serializer.is_valid():
            serializer.save()
            return Response(serializer.data, status=status.HTTP_201_CREATED)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)  
```
æ”¹é€ åçš„ä»£ç æ›´ç®€æ´äº†ï¼Œå¹¶ä¸”æ›´åƒ Formsã€‚ä¹Ÿä½¿ç”¨äº†å‘½ååçš„çŠ¶æ€ç è®© Response å«ä¹‰æ›´åŠ æ˜æ˜¾ã€‚

æ¥ä¸‹æ¥ä¿®æ”¹å•ä¸€çš„ snippets è§†å›¾ï¼š
```python
@api_view(['GET', 'PUT', 'DELETE'])
def snippet_detail(request, pk):
    """
    ä¿®æ”¹æˆ–åˆ é™¤ä¸€ä¸ªsnippet.
    """
    try:
        snippet = Snippet.objects.get(pk=pk)
    except Snippet.DoesNotExist:
        return Response(status=status.HTTP_404_NOT_FOUND)

    if request.method == 'GET':
        serializer = SnippetSerializer(snippet)
        return Response(serializer.data)

    elif request.method == 'PUT':
        serializer = SnippetSerializer(snippet, data=request.data)
        if serializer.is_valid():
            serializer.save()
            return Response(serializer.data)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)

    elif request.method == 'DELETE':
        snippet.delete()
        return Response(status=status.HTTP_204_NO_CONTENT)
    
```
ä¸€åˆ‡éƒ½æ˜¯å¦‚æ­¤ç†Ÿæ‚‰ï¼Œè¿™å’ŒåŸç”Ÿçš„ Django Form å¾ˆåƒã€‚

æ³¨æ„ï¼Œæˆ‘ä»¬å¹¶æ²¡æœ‰æ˜¾å¼åœ°å£°æ˜ request å’Œ response ä¸­çš„å†…å®¹ç±»å‹ï¼Œ`request.data`å¯ä»¥å¤„ç†è¯·æ±‚ä¼ å…¥çš„ json ç±»å‹æ•°æ®ï¼Œä¹Ÿå¯ä»¥å¤„ç†å…¶ä»–ç±»å‹æ•°æ®ã€‚åŒç†ï¼ŒResponse å¯¹è±¡ä¹Ÿå¯ä»¥ä¸ºæˆ‘ä»¬è¿”å›æ­£ç¡®çš„æ•°æ®ç±»å‹ã€‚

ä¸º URL æ·»åŠ å¯é€‰çš„æ•°æ®æ ¼å¼åç¼€
---------------

æˆ‘ä»¬çš„ responses æ”¯æŒå¤šç§è¿”å›æ ¼å¼ï¼Œåˆ©ç”¨è¿™ç‚¹æˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ URL ä¸­æ·»åŠ æ ¼å¼åç¼€çš„æ–¹æ³•æ¥è·å–å•ä¸€æ•°æ®ç±»å‹ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬çš„ URL å¯ä»¥å¤„ç†ç±»ä¼¼`http://example.com/api/items/4/.json`è¿™æ ·çš„æ ¼å¼ã€‚

é¦–å…ˆåœ¨ views æ·»åŠ `format`å‚æ•°ï¼š
```python
def snippet_list(request, format=None):
    pass
```
å’Œ
```python
def snippet_detail(request, pk, format=None):
    pass
```

ç„¶åä¿®æ”¹`urls.py`ï¼Œæ·»åŠ `format_suffix_patterns`ï¼š
```python
from django.urls import path
from rest_framework.urlpatterns import format_suffix_patterns
from snippets import views

urlpatterns = [
    path('snippets/', views.snippet_list),
    path('snippets/<int:pk>', views.snippet_detail),
]

urlpatterns = format_suffix_patterns(urlpatterns)
```

æˆ‘ä»¬ä¸éœ€è¦æ·»åŠ ä»»ä½•é¢å¤–ä¿¡æ¯ï¼Œå®ƒç»™æˆ‘ä»¬ä¸€ä¸ªç®€å•æ¸…æ™°çš„æ–¹æ³•å»è·å–æŒ‡å®šæ ¼å¼çš„æ•°æ®ã€‚

æµ‹è¯•
--

å’Œä¸Šä¸€ç« ä¸€æ ·ï¼Œæˆ‘ä»¬ä½¿ç”¨å‘½ä»¤è¡Œæ¥è¿›è¡Œæµ‹è¯•ã€‚å°½ç®¡ä¸ºäº†æ›´å¥½åœ°å¤„ç†å¼‚å¸¸æ·»åŠ äº†ç›¸åº”çš„é”™è¯¯å¤„ç†ï¼Œä½†ä¸€åˆ‡è¿˜æ˜¯é‚£ä¹ˆç®€å•ï¼š
```shell
    http http://127.0.0.1:8000/snippets/
    
    HTTP/1.1 200 OK
    ...
    [
      {
        "id": 1,
        "title": "",
        "code": "foo = \"bar\"\n",
        "linenos": false,
        "language": "python",
        "style": "friendly"
      },
      {
        "id": 2,
        "title": "",
        "code": "print \"hello, world\"\n",
        "linenos": false,
        "language": "python",
        "style": "friendly"
      }
    ]
    
```
æˆ‘ä»¬å¯ä»¥é€šè¿‡æ§åˆ¶`Accept`æ¥æ§åˆ¶è¿”å›çš„æ•°æ®ç±»å‹ï¼š
```shell
http http://127.0.0.1:8000/snippets/ Accept:application/json  # Request JSON
http http://127.0.0.1:8000/snippets/ Accept:text/html         # Request HTML
```  

æˆ–è€…é€šè¿‡æ·»åŠ æ ¼å¼åç¼€ï¼š
```shell
http http://127.0.0.1:8000/snippets.json  # JSON suffix
http http://127.0.0.1:8000/snippets.api   # Browsable API suffix
```

åŒæ ·çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡`Content-Type`æ§åˆ¶å‘é€è¯·æ±‚çš„æ•°æ®ç±»å‹ï¼š
```shell
# POST using form data
http --form POST http://127.0.0.1:8000/snippets/ code="print 123"

{
    "id": 3,
    "title": "",
    "code": "print 123",
    "linenos": false,
    "language": "python",
    "style": "friendly"
}

# POST using JSON
http --json POST http://127.0.0.1:8000/snippets/ code="print 456"

{
    "id": 4,
    "title": "",
    "code": "print 456",
    "linenos": false,
    "language": "python",
    "style": "friendly"
}
```

æˆ–æ‰“å¼€æµè§ˆå™¨è®¿é—®`http://127.0.0.1:8000/snippets/`

æ˜“è¯»æ€§
---

ç”±äº API æ ¹æ®å®¢æˆ·ç«¯å‘å‡ºçš„è¯·æ±‚æ¥å†³å®šè¿”å›çš„æ•°æ®ç±»å‹ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨æµè§ˆå™¨è®¿é—®æ—¶é»˜è®¤è¦æ±‚è¿”å› HTML æ•°æ®æ ¼å¼ï¼Œè¿™ä½¿æˆ‘ä»¬çš„ API åœ¨æµè§ˆå™¨è®¿é—®æ—¶ç»“æœæ ¼å¼ååˆ†æ˜“è¯»ã€‚

ä½¿ç”¨æµè§ˆå™¨è®¿é—®æ—¶è¿”å›æ˜“äºé˜…è¯»ç»“æœæ˜¯ä¸€ä¸ªå·¨å¤§çš„è¿›æ­¥ï¼Œè¿™è®©æˆ‘ä»¬æ›´å®¹æ˜“çš„å¼€å‘ã€ä½¿ç”¨ APIã€‚è¿™ä½¿å…¶ä»–äººå‘˜æ›´åŠ æ–¹ä¾¿çš„ä½¿ç”¨ã€æ£€æŸ¥ APIã€‚

## æ¥ä¸‹æ¥

åœ¨ç¬¬ 3 éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†å¼€å§‹ä½¿ç”¨åŸºäºç±»çš„è§†å›¾ï¼Œå¹¶çœ‹çœ‹æ³›å‹è§†å›¾å¦‚ä½•å‡å°‘æˆ‘ä»¬éœ€è¦ç¼–å†™çš„ä»£ç é‡ã€‚