---
title: Python ä¸­æ›´ä¼˜é›…çš„æ—¥å¿—è®°å½•æ–¹æ¡ˆ loguru
tags: 
  - ç¼–ç 
  - Loguru
top: 5
categories: 
  - ğŸ’» å·¥ä½œ
  - ğŸPython
  - å…¨æ ˆä¹‹è·¯
  - ç¬¬ä¸‰æ–¹åº“
date: 2020-05-23 18:21:46
permalink: /pylibs/loguru/
author: å´”åº†æ‰
link: https://cuiqingcai.com/7776.html
---

åœ¨ Python ä¸­ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬å¯èƒ½ç›´æ¥ç”¨è‡ªå¸¦çš„ logging æ¨¡å—æ¥è®°å½•æ—¥å¿—ï¼ŒåŒ…æ‹¬æˆ‘ä¹‹å‰çš„æ—¶å€™ä¹Ÿæ˜¯ä¸€æ ·ã€‚åœ¨ä½¿ç”¨æ—¶æˆ‘ä»¬éœ€è¦é…ç½®ä¸€äº› Handlerã€Formatter æ¥è¿›è¡Œä¸€äº›å¤„ç†ï¼Œæ¯”å¦‚æŠŠæ—¥å¿—è¾“å‡ºåˆ°ä¸åŒçš„ä½ç½®ï¼Œæˆ–è€…è®¾ç½®ä¸€ä¸ªä¸åŒçš„è¾“å‡ºæ ¼å¼ï¼Œæˆ–è€…è®¾ç½®æ—¥å¿—åˆ†å—å’Œå¤‡ä»½ã€‚ä½†å…¶å®ä¸ªäººæ„Ÿè§‰ logging ç”¨èµ·æ¥å…¶å®å¹¶ä¸æ˜¯é‚£ä¹ˆå¥½ç”¨ï¼Œå…¶å®ä¸»è¦è¿˜æ˜¯é…ç½®è¾ƒä¸ºç¹çã€‚

## å¸¸è§ä½¿ç”¨

é¦–å…ˆçœ‹çœ‹ logging å¸¸è§çš„è§£å†³æ–¹æ¡ˆå§ï¼Œæˆ‘ä¸€èˆ¬ä¼šé…ç½®è¾“å‡ºåˆ°æ–‡ä»¶ã€æ§åˆ¶å°å’Œ Elasticsearchã€‚è¾“å‡ºåˆ°æ§åˆ¶å°å°±ä»…ä»…æ˜¯æ–¹ä¾¿ç›´æ¥æŸ¥çœ‹çš„ï¼›è¾“å‡ºåˆ°æ–‡ä»¶æ˜¯æ–¹ä¾¿ç›´æ¥å­˜å‚¨ï¼Œä¿ç•™æ‰€æœ‰å†å²è®°å½•çš„å¤‡ä»½ï¼›è¾“å‡ºåˆ° Elasticsearchï¼Œç›´æ¥å°† Elasticsearch ä½œä¸ºå­˜å‚¨å’Œåˆ†æçš„ä¸­å¿ƒï¼Œä½¿ç”¨ Kibana å¯ä»¥éå¸¸æ–¹ä¾¿åœ°åˆ†æå’ŒæŸ¥çœ‹è¿è¡Œæƒ…å†µã€‚ æ‰€ä»¥åœ¨è¿™é‡Œæˆ‘åŸºæœ¬ä¼šå¯¹ logging åšå¦‚ä¸‹çš„å°è£…å†™æ³•ï¼š
 
```python
import logging  
import sys  
from os import makedirs  
from os.path import dirname, exists  
  
from cmreslogging.handlers import CMRESHandler  
  
loggers = {}  
  
LOG_ENABLED = True  # æ˜¯å¦å¼€å¯æ—¥å¿—  
LOG_TO_CONSOLE = True  # æ˜¯å¦è¾“å‡ºåˆ°æ§åˆ¶å°  
LOG_TO_FILE = True  # æ˜¯å¦è¾“å‡ºåˆ°æ–‡ä»¶  
LOG_TO_ES = True  # æ˜¯å¦è¾“å‡ºåˆ° Elasticsearch  
  
LOG_PATH = './runtime.log'  # æ—¥å¿—æ–‡ä»¶è·¯å¾„  
LOG_LEVEL = 'DEBUG'  # æ—¥å¿—çº§åˆ«  
LOG_FORMAT = '%(levelname)s - %(asctime)s - process: %(process)d - %(filename)s - %(name)s - %(lineno)d - %(module)s - %(message)s'  # æ¯æ¡æ—¥å¿—è¾“å‡ºæ ¼å¼  
ELASTIC_SEARCH_HOST = 'eshost'  # Elasticsearch Host  
ELASTIC_SEARCH_PORT = 9200  # Elasticsearch Port  
ELASTIC_SEARCH_INDEX = 'runtime'  # Elasticsearch Index Name  
APP_ENVIRONMENT = 'dev'  # è¿è¡Œç¯å¢ƒï¼Œå¦‚æµ‹è¯•ç¯å¢ƒè¿˜æ˜¯ç”Ÿäº§ç¯å¢ƒ  
  
def get_logger(name=None):  
 """  
 get logger by name  
 :param name: name of logger  
 :return: logger  
 """  
 global loggers  
  
 if not name: name = __name__  
  
 if loggers.get(name):  
 return loggers.get(name)  
  
 logger = logging.getLogger(name)  
 logger.setLevel(LOG_LEVEL)  
  
 # è¾“å‡ºåˆ°æ§åˆ¶å°  
 if LOG_ENABLED and LOG_TO_CONSOLE:  
 stream_handler = logging.StreamHandler(sys.stdout)  
 stream_handler.setLevel(level=LOG_LEVEL)  
 formatter = logging.Formatter(LOG_FORMAT)  
 stream_handler.setFormatter(formatter)  
 logger.addHandler(stream_handler)  
  
 # è¾“å‡ºåˆ°æ–‡ä»¶  
 if LOG_ENABLED and LOG_TO_FILE:  
 # å¦‚æœè·¯å¾„ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ—¥å¿—æ–‡ä»¶æ–‡ä»¶å¤¹  
 log_dir = dirname(log_path)  
 if not exists(log_dir): makedirs(log_dir)  
 # æ·»åŠ  FileHandler  
 file_handler = logging.FileHandler(log_path, encoding='utf-8')  
 file_handler.setLevel(level=LOG_LEVEL)  
 formatter = logging.Formatter(LOG_FORMAT)  
 file_handler.setFormatter(formatter)  
 logger.addHandler(file_handler)  
  
 # è¾“å‡ºåˆ° Elasticsearch  
 if LOG_ENABLED and LOG_TO_ES:  
 # æ·»åŠ  CMRESHandler  
 es_handler = CMRESHandler(hosts=[{'host': ELASTIC_SEARCH_HOST, 'port': ELASTIC_SEARCH_PORT}],  
 # å¯ä»¥é…ç½®å¯¹åº”çš„è®¤è¯æƒé™  
 auth_type=CMRESHandler.AuthType.NO_AUTH,   
 es_index_name=ELASTIC_SEARCH_INDEX,  
 # ä¸€ä¸ªæœˆåˆ†ä¸€ä¸ª Index  
 index_name_frequency=CMRESHandler.IndexNameFrequency.MONTHLY,  
 # é¢å¤–å¢åŠ ç¯å¢ƒæ ‡è¯†  
 es_additional_fields={'environment': APP_ENVIRONMENT}   
 )  
 es_handler.setLevel(level=LOG_LEVEL)  
 formatter = logging.Formatter(LOG_FORMAT)  
 es_handler.setFormatter(formatter)  
 logger.addHandler(es_handler)  
  
 # ä¿å­˜åˆ°å…¨å±€ loggers  
 loggers[name] = logger  
 return logger  
 
 ```

å®šä¹‰å®Œäº†æ€ä¹ˆä½¿ç”¨å‘¢ï¼Ÿåªéœ€è¦ä½¿ç”¨å®šä¹‰çš„æ–¹æ³•è·å–ä¸€ä¸ª loggerï¼Œç„¶å log å¯¹åº”çš„å†…å®¹å³å¯ï¼š

```plain
logger = get_logger()  
logger.debug('this is a message')  
```
è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

```plain
DEBUG - 2019-10-11 22:27:35,923 - process: 99490 - logger.py - __main__ - 81 - logger - this is a message  
```
æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªå®šä¹‰çš„åŸºæœ¬å®ç°å§ã€‚é¦–å…ˆè¿™é‡Œä¸€äº›å¸¸é‡æ˜¯ç”¨æ¥å®šä¹‰ logging æ¨¡å—çš„ä¸€äº›åŸºæœ¬å±æ€§çš„ï¼Œæ¯”å¦‚ `LOG_ENABLED` ä»£è¡¨æ˜¯å¦å¼€å¯æ—¥å¿—åŠŸèƒ½ï¼Œ`LOG_TO_ES` ä»£è¡¨æ˜¯å¦å°†æ—¥å¿—è¾“å‡ºåˆ° Elasticsearchï¼Œå¦å¤–è¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„æ—¥å¿—åŸºæœ¬é…ç½®ï¼Œå¦‚ `LOG_FORMAT` é…ç½®äº†æ—¥å¿—æ¯ä¸ªæ¡ç›®è¾“å‡ºçš„åŸºæœ¬æ ¼å¼ï¼Œå¦å¤–è¿˜æœ‰ä¸€äº›è¿æ¥çš„å¿…è¦ä¿¡æ¯ã€‚è¿™äº›å˜é‡å¯ä»¥å’Œè¿è¡Œæ—¶çš„å‘½ä»¤è¡Œæˆ–ç¯å¢ƒå˜é‡å¯¹æ¥èµ·æ¥ï¼Œå¯ä»¥æ–¹ä¾¿åœ°å®ç°ä¸€äº›å¼€å…³å’Œé…ç½®çš„æ›´æ¢ã€‚ ç„¶åå®šä¹‰äº†è¿™ä¹ˆä¸€ä¸ª get_logger æ–¹æ³•ï¼Œæ¥æ”¶ä¸€ä¸ªå‚æ•° nameã€‚é¦–å…ˆè¯¥æ–¹æ³•æ‹¿åˆ° name ä¹‹åï¼Œä¼šåˆ°å…¨å±€çš„ loggers å˜é‡é‡Œé¢æŸ¥æ‰¾ï¼Œloggers å˜é‡æ˜¯ä¸€ä¸ªå…¨å±€å­—å…¸ï¼Œå¦‚æœæœ‰å·²ç»å£°æ˜è¿‡çš„ loggerï¼Œç›´æ¥å°†å…¶è·å–è¿”å›å³å¯ï¼Œä¸ç”¨å†å°†å…¶äºŒæ¬¡åˆå§‹åŒ–ã€‚å¦‚æœ loggers é‡Œé¢æ²¡æœ‰æ‰¾åˆ° name å¯¹åº”çš„ loggerï¼Œé‚£å°±è¿›è¡Œåˆ›å»ºå³å¯ã€‚åˆ›å»º logger ä¹‹åï¼Œå¯ä»¥ä¸ºå…¶æ·»åŠ å„ç§å¯¹åº”çš„ Handlerï¼Œå¦‚è¾“å‡ºåˆ°æ§åˆ¶å°å°±ç”¨ StreamHandlerï¼Œè¾“å‡ºåˆ°æ–‡ä»¶å°±ç”¨ FileHandler æˆ– RotatingFileHandlerï¼Œè¾“å‡ºåˆ° Elasticsearch å°±ç”¨ CMRESHandlerï¼Œåˆ†åˆ«é…ç½®å¥½å¯¹åº”çš„ä¿¡æ¯å³å¯ã€‚ æœ€åå‘¢ï¼Œå°†æ–°å»ºçš„ logger ä¿å­˜åˆ°å…¨å±€çš„ loggers é‡Œé¢å¹¶è¿”å›å³å¯ï¼Œè¿™æ ·å¦‚æœæœ‰åŒåçš„ logger ä¾¿å¯ä»¥ç›´æ¥æŸ¥æ‰¾ loggers ç›´æ¥è¿”å›äº†ã€‚ åœ¨è¿™é‡Œä¾èµ–äº†é¢å¤–çš„è¾“å‡ºåˆ° Elasticsearch çš„åŒ…ï¼Œå«åš CMRESHandlerï¼Œå®ƒå¯ä»¥æ”¯æŒå°†æ—¥å¿—è¾“å‡ºåˆ° Elasticsearch é‡Œé¢ï¼Œå¦‚æœè¦ä½¿ç”¨çš„è¯å¯ä»¥å®‰è£…ä¸€ä¸‹ï¼š

```plain
pip install CMRESHandler  
```
å…¶ GitHub åœ°å€æ˜¯ï¼šhttps://github.com/cmanaha/python-elasticsearch-loggerï¼Œå…·ä½“çš„ä½¿ç”¨æ–¹å¼å¯ä»¥çœ‹çœ‹å®ƒçš„å®˜æ–¹è¯´æ˜ï¼Œå¦‚é…ç½®è®¤è¯ä¿¡æ¯ï¼Œé…ç½® Index åˆ†éš”ä¿¡æ¯ç­‰ç­‰ã€‚ å¥½ï¼Œä¸Šé¢å°±æ˜¯æˆ‘ä¹‹å‰å¸¸ç”¨çš„ logging é…ç½®ï¼Œé€šè¿‡å¦‚ä¸Šçš„é…ç½®ï¼Œæˆ‘å°±å¯ä»¥å®ç°å°† logging è¾“å‡ºåˆ°ä¸‰ä¸ªä½ç½®ï¼Œå¹¶å¯ä»¥å®ç°å¯¹åº”çš„æ•ˆæœã€‚æ¯”å¦‚è¾“å‡ºåˆ° Elasticsearch ä¹‹åï¼Œæˆ‘å°±å¯ä»¥éå¸¸æ–¹ä¾¿åœ°ä½¿ç”¨ Kibana æ¥æŸ¥çœ‹å½“å‰è¿è¡Œæƒ…å†µï¼ŒERROR Log çš„æ¯”ä¾‹ç­‰ç­‰ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š 

![](https://qiniu.cuiqingcai.com/2019-10-13-143457.png) 

ä¹Ÿå¯ä»¥åœ¨å®ƒçš„åŸºç¡€ä¸Šåšæ›´è¿›ä¸€æ­¥çš„ç»Ÿè®¡åˆ†æã€‚

## loguru

ä¸Šé¢çš„å®ç°æ–¹å¼å·²ç»æ˜¯ä¸€ä¸ªè¾ƒä¸ºå¯è¡Œçš„é…ç½®æ–¹æ¡ˆäº†ã€‚ç„¶è€Œï¼Œæˆ‘è¿˜æ˜¯ä¼šæ„Ÿè§‰åˆ°æœ‰äº› Handler é…èµ·æ¥éº»çƒ¦ï¼Œå°¤å…¶æ˜¯æ–°å»ºä¸€ä¸ªé¡¹ç›®çš„å¾ˆå¤šæ—¶å€™æ‡’å¾—å»å†™ä¸€äº›é…ç½®ã€‚å³ä½¿æ˜¯ä¸ç”¨ä¸Šæ–‡çš„é…ç½®ï¼Œç”¨æœ€åŸºæœ¬çš„å‡ è¡Œ logging é…ç½®ï¼Œåƒå¦‚ä¸‹çš„é€šç”¨é…ç½®ï¼š

```python
import logging  
logging.basicConfig(level = logging.INFO,format = '%(asctime)s - %(name)s - %(levelname)s - %(message)s')  
logger = logging.getLogger(__name__)  
```
æˆ‘ä¹Ÿæ‡’å¾—å»å†™ï¼Œæ„Ÿè§‰å¹¶ä¸æ˜¯ä¸€ä¸ªä¼˜é›…çš„å®ç°æ–¹å¼ã€‚ æœ‰éœ€æ±‚å°±æœ‰åŠ¨åŠ›å•Šï¼Œè¿™ä¸ï¼Œå°±æœ‰äººå®ç°äº†è¿™ä¹ˆä¸€ä¸ªåº“ï¼Œå«åš loguruï¼Œå¯ä»¥å°† log çš„é…ç½®å’Œä½¿ç”¨æ›´åŠ ç®€å•å’Œæ–¹ä¾¿ã€‚ ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒåˆ°åº•æ˜¯æ€ä¹ˆç”¨çš„å§ã€‚

## å®‰è£…

é¦–å…ˆï¼Œè¿™ä¸ªåº“çš„å®‰è£…æ–¹å¼å¾ˆç®€å•ï¼Œå°±ç”¨åŸºæœ¬çš„ pip å®‰è£…å³å¯ï¼ŒPython 3 ç‰ˆæœ¬çš„å®‰è£…å¦‚ä¸‹ï¼š

```plain
pip3 install loguru  
```
å®‰è£…å®Œæ¯•ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨é¡¹ç›®é‡Œä½¿ç”¨è¿™ä¸ª loguru åº“äº†ã€‚

## åŸºæœ¬ä½¿ç”¨

é‚£ä¹ˆè¿™ä¸ªåº“æ€ä¹ˆæ¥ç”¨å‘¢ï¼Ÿæˆ‘ä»¬å…ˆç”¨ä¸€ä¸ªå®ä¾‹æ„Ÿå—ä¸‹ï¼š


```plain
from loguru import logger  
  
logger.debug('this is a debug message')  
```
çœ‹åˆ°äº†å§ï¼Œä¸éœ€è¦é…ç½®ä»€ä¹ˆä¸œè¥¿ï¼Œç›´æ¥å¼•å…¥ä¸€ä¸ª loggerï¼Œç„¶åè°ƒç”¨å…¶ debug æ–¹æ³•å³å¯ã€‚ åœ¨ loguru é‡Œé¢æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªä¸»è¦å¯¹è±¡ï¼Œé‚£å°±æ˜¯ loggerï¼Œloguru é‡Œé¢æœ‰ä¸”ä»…æœ‰ä¸€ä¸ª loggerï¼Œè€Œä¸”å®ƒå·²ç»è¢«æå‰é…ç½®äº†ä¸€äº›åŸºç¡€ä¿¡æ¯ï¼Œæ¯”å¦‚æ¯”è¾ƒå‹å¥½çš„æ ¼å¼åŒ–ã€æ–‡æœ¬é¢œè‰²ä¿¡æ¯ç­‰ç­‰ã€‚ ä¸Šé¢çš„ä»£ç è¿è¡Œç»“æœå¦‚ä¸‹ï¼š

```plain
2019-10-13 22:46:12.367 | DEBUG    | __main__:<module>:4 - this is a debug message  
```
å¯ä»¥çœ‹åˆ°å…¶é»˜è®¤çš„è¾“å‡ºæ ¼å¼æ˜¯ä¸Šé¢çš„å†…å®¹ï¼Œæœ‰æ—¶é—´ã€çº§åˆ«ã€æ¨¡å—åã€è¡Œå·ä»¥åŠæ—¥å¿—ä¿¡æ¯ï¼Œä¸éœ€è¦æ‰‹åŠ¨åˆ›å»º loggerï¼Œç›´æ¥ä½¿ç”¨å³å¯ï¼Œå¦å¤–å…¶è¾“å‡ºè¿˜æ˜¯å½©è‰²çš„ï¼Œçœ‹èµ·æ¥ä¼šæ›´åŠ å‹å¥½ã€‚ ä»¥ä¸Šçš„æ—¥å¿—ä¿¡æ¯æ˜¯ç›´æ¥è¾“å‡ºåˆ°æ§åˆ¶å°çš„ï¼Œå¹¶æ²¡æœ‰è¾“å‡ºåˆ°å…¶ä»–çš„åœ°æ–¹ï¼Œå¦‚æœæƒ³è¦è¾“å‡ºåˆ°å…¶ä»–çš„ä½ç½®ï¼Œæ¯”å¦‚å­˜ä¸ºæ–‡ä»¶ï¼Œæˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ä¸€è¡Œä»£ç å£°æ˜å³å¯ã€‚ ä¾‹å¦‚å°†ç»“æœåŒæ—¶è¾“å‡ºåˆ°ä¸€ä¸ª runtime.log æ–‡ä»¶é‡Œé¢ï¼Œå¯ä»¥è¿™ä¹ˆå†™ï¼š

```plain
from loguru import logger  
  
logger.add('runtime.log')  
logger.debug('this is a debug')  
```
å¾ˆç®€å•å§ï¼Œæˆ‘ä»¬ä¹Ÿä¸éœ€è¦å†å£°æ˜ä¸€ä¸ª FileHandler äº†ï¼Œå°±ä¸€è¡Œ add è¯­å¥æå®šï¼Œè¿è¡Œä¹‹åä¼šå‘ç°ç›®å½•ä¸‹ runtime.log é‡Œé¢åŒæ ·å‡ºç°äº†åˆšåˆšæ§åˆ¶å°è¾“å‡ºçš„ DEBUG ä¿¡æ¯ã€‚ ä¸Šé¢å°±æ˜¯ä¸€äº›åŸºæœ¬çš„ä½¿ç”¨ï¼Œä½†è¿™è¿˜è¿œè¿œä¸å¤Ÿï¼Œä¸‹é¢æˆ‘ä»¬æ¥è¯¦ç»†äº†è§£ä¸‹å®ƒçš„ä¸€äº›åŠŸèƒ½æ¨¡å—ã€‚

## è¯¦ç»†ä½¿ç”¨

æ—¢ç„¶æ˜¯æ—¥å¿—ï¼Œé‚£ä¹ˆæœ€å¸¸è§çš„å°±æ˜¯è¾“å‡ºåˆ°æ–‡ä»¶äº†ã€‚loguru å¯¹è¾“å‡ºåˆ°æ–‡ä»¶çš„é…ç½®æœ‰éå¸¸å¼ºå¤§çš„æ”¯æŒï¼Œæ¯”å¦‚æ”¯æŒè¾“å‡ºåˆ°å¤šä¸ªæ–‡ä»¶ï¼Œåˆ†çº§åˆ«åˆ†åˆ«è¾“å‡ºï¼Œè¿‡å¤§åˆ›å»ºæ–°æ–‡ä»¶ï¼Œè¿‡ä¹…è‡ªåŠ¨åˆ é™¤ç­‰ç­‰ã€‚ ä¸‹é¢æˆ‘ä»¬åˆ†åˆ«çœ‹çœ‹è¿™äº›æ€æ ·æ¥å®ç°ï¼Œè¿™é‡ŒåŸºæœ¬ä¸Šå°±æ˜¯ add æ–¹æ³•çš„ä½¿ç”¨ä»‹ç»ã€‚å› ä¸ºè¿™ä¸ª add æ–¹æ³•å°±ç›¸å½“äºç»™ logger æ·»åŠ äº†ä¸€ä¸ª Handlerï¼Œå®ƒç»™æˆ‘ä»¬æš´éœ²äº†è®¸å¤šå‚æ•°æ¥å®ç° Handler çš„é…ç½®ï¼Œä¸‹é¢æˆ‘ä»¬æ¥è¯¦ç»†ä»‹ç»ä¸‹ã€‚ é¦–å…ˆçœ‹çœ‹å®ƒçš„æ–¹æ³•å®šä¹‰å§ï¼š
  
```python
def add(self,
        sink,
        *,
        level=_defaults.LOGURU_LEVEL,
        format=_defaults.LOGURU_FORMAT,
        filter=_defaults.LOGURU_FILTER,
        colorize=_defaults.LOGURU_COLORIZE,
        serialize=_defaults.LOGURU_SERIALIZE,
        backtrace=_defaults.LOGURU_BACKTRACE,
        diagnose=_defaults.LOGURU_DIAGNOSE,
        enqueue=_defaults.LOGURU_ENQUEUE,
        catch=_defaults.LOGURU_CATCH,
        **kwargs):
    pass
```
çœ‹çœ‹å®ƒçš„æºä»£ç ï¼Œå®ƒæ”¯æŒè¿™ä¹ˆå¤šçš„å‚æ•°ï¼Œå¦‚ levelã€formatã€filterã€color ç­‰ç­‰ï¼Œå¦å¤–æˆ‘ä»¬è¿˜æ³¨æ„åˆ°å®ƒæœ‰ä¸ªéå¸¸é‡è¦çš„å‚æ•° sinkï¼Œæˆ‘ä»¬çœ‹çœ‹å®˜æ–¹æ–‡æ¡£ï¼šå¯ä»¥äº†è§£åˆ°é€šè¿‡ [sink](https://loguru.readthedocs.io/en/stable/api/logger.html#sink) æˆ‘ä»¬å¯ä»¥ä¼ å…¥å¤šç§ä¸åŒçš„æ•°æ®ç»“æ„ï¼Œæ±‡æ€»å¦‚ä¸‹ï¼š

*   sink å¯ä»¥ä¼ å…¥ä¸€ä¸ª file å¯¹è±¡ï¼Œä¾‹å¦‚ `sys.stderr` æˆ–è€… `open('file.log', 'w')` éƒ½å¯ä»¥ã€‚
*   sink å¯ä»¥ç›´æ¥ä¼ å…¥ä¸€ä¸ª `str` å­—ç¬¦ä¸²æˆ–è€… `pathlib.Path` å¯¹è±¡ï¼Œå…¶å®å°±æ˜¯ä»£è¡¨æ–‡ä»¶è·¯å¾„çš„ï¼Œå¦‚æœè¯†åˆ«åˆ°æ˜¯è¿™ç§ç±»å‹ï¼Œå®ƒä¼šè‡ªåŠ¨åˆ›å»ºå¯¹åº”è·¯å¾„çš„æ—¥å¿—æ–‡ä»¶å¹¶å°†æ—¥å¿—è¾“å‡ºè¿›å»ã€‚
*   sink å¯ä»¥æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œå¯ä»¥è‡ªè¡Œå®šä¹‰è¾“å‡ºå®ç°ã€‚
*   sink å¯ä»¥æ˜¯ä¸€ä¸ª logging æ¨¡å—çš„ Handlerï¼Œæ¯”å¦‚ FileHandlerã€StreamHandler ç­‰ç­‰ï¼Œæˆ–è€…ä¸Šæ–‡ä¸­æˆ‘ä»¬æåˆ°çš„ CMRESHandler ç…§æ ·ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œè¿™æ ·å°±å¯ä»¥å®ç°è‡ªå®šä¹‰ Handler çš„é…ç½®ã€‚
*   sink è¿˜å¯ä»¥æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„ç±»ï¼Œå…·ä½“çš„å®ç°è§„èŒƒå¯ä»¥å‚è§å®˜æ–¹æ–‡æ¡£ã€‚

æ‰€ä»¥è¯´ï¼Œåˆšæ‰æˆ‘ä»¬æ‰€æ¼”ç¤ºçš„è¾“å‡ºåˆ°æ–‡ä»¶ï¼Œä»…ä»…ç»™å®ƒä¼ äº†ä¸€ä¸ª str å­—ç¬¦ä¸²è·¯å¾„ï¼Œä»–å°±ç»™æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œå°±æ˜¯è¿™ä¸ªåŸç†ã€‚

###  åŸºæœ¬å‚æ•°

ä¸‹é¢æˆ‘ä»¬å†äº†è§£ä¸‹å®ƒçš„å…¶ä»–å‚æ•°ï¼Œä¾‹å¦‚ formatã€filterã€level ç­‰ç­‰ã€‚ å…¶å®å®ƒä»¬çš„æ¦‚å¿µå’Œæ ¼å¼å’Œ logging æ¨¡å—éƒ½æ˜¯åŸºæœ¬ä¸€æ ·çš„äº†ï¼Œä¾‹å¦‚è¿™é‡Œä½¿ç”¨ formatã€filterã€level æ¥è§„å®šè¾“å‡ºçš„æ ¼å¼ï¼š

```plain
logger.add('runtime.log', format="{time} {level} {message}", filter="my_module", level="INFO")  
```

#### è®°å½•çš„å­—å…¸

| é”®       | æè¿°                                               | å±æ€§                 |
|-----------|-----------------------------------------------------------|----------------------------|
| elapsed   | è‡ªç¨‹åºå¯åŠ¨ä»¥æ¥ç»è¿‡çš„æ—¶é—´          | See [`datetime.timedelta`](https://docs.python.org/3/library/datetime.html#datetime.timedelta)    |
| exception | å¦‚æœæœ‰å¼‚å¸¸åˆ™æŠ›å‡ºï¼Œå¦åˆ™è¿”å› None           | type, value,
traceback     |
| extra     | ç”¨æˆ·ç»‘å®šçš„å­—å…¸å±æ€§ (å‚é˜… `bind()`) | None                       |
| file      | è¿›è¡Œæ—¥å¿—è°ƒç”¨çš„æ–‡ä»¶                 | name \(default\),
path     |
| function  | è°ƒç”¨çš„å‡½æ•°å         | None                       |
| level     | è°ƒç”¨çš„æ—¥å¿—ç­‰çº§                    | name (default\),
no, icon |
| line      | æºç çš„è¡Œæ•°                       | None                       |
| message   | è®°å½•çš„æ—¥å¿—ä¿¡æ¯(æ²¡æœ‰è¢«æ ¼å¼åŒ–çš„)                  | None                       |
| module    | è°ƒç”¨çš„æ¨¡å—               | None                       |
| name      | è°ƒç”¨çš„`__name__`           | None                       |
| process   | è°ƒç”¨çš„è¿›ç¨‹            | name, id \(default\)       |
| thread    | è°ƒç”¨çš„çº¿ç¨‹           | name, id \(default\)       |
| time      | è°ƒç”¨çš„å½“åœ°æ—¶é—´ï¼ˆlocal timeï¼‰       | å‚é˜… [`datetime.datetime`](https://docs.python.org/3/library/datetime.html#datetime.datetime)     |

å‚é˜…[list of available record tokens](https://loguru.readthedocs.io/en/stable/api/logger.html#record)

###  åˆ é™¤ sink

å¦å¤–æ·»åŠ  sink ä¹‹åæˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹å…¶è¿›è¡Œåˆ é™¤ï¼Œç›¸å½“äºé‡æ–°åˆ·æ–°å¹¶å†™å…¥æ–°çš„å†…å®¹ã€‚ åˆ é™¤çš„æ—¶å€™æ ¹æ®åˆšåˆš add æ–¹æ³•è¿”å›çš„ id è¿›è¡Œåˆ é™¤å³å¯ï¼Œçœ‹ä¸‹é¢çš„ä¾‹å­ï¼š


```python
from loguru import logger  
  
trace = logger.add('runtime.log')  
logger.debug('this is a debug message')  
logger.remove(trace)  
logger.debug('this is another debug message')  
```
çœ‹è¿™é‡Œï¼Œæˆ‘ä»¬é¦–å…ˆ add äº†ä¸€ä¸ª sinkï¼Œç„¶åè·å–å®ƒçš„è¿”å›å€¼ï¼Œèµ‹å€¼ä¸º traceã€‚éšåè¾“å‡ºäº†ä¸€æ¡æ—¥å¿—ï¼Œç„¶åå°† trace å˜é‡ä¼ ç»™ remove æ–¹æ³•ï¼Œå†æ¬¡è¾“å‡ºä¸€æ¡æ—¥å¿—ï¼Œçœ‹çœ‹ç»“æœæ˜¯æ€æ ·çš„ã€‚ æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š

```plain
2019-10-13 23:18:26.469 | DEBUG    | __main__:<module>:4 - this is a debug message  
2019-10-13 23:18:26.469 | DEBUG    | __main__:<module>:6 - this is another debug message  
```
æ—¥å¿—æ–‡ä»¶ runtime.log å†…å®¹å¦‚ä¸‹ï¼š

```plain
2019-10-13 23:18:26.469 | DEBUG    | __main__:<module>:4 - this is a debug message  
```
å¯ä»¥å‘ç°ï¼Œåœ¨è°ƒç”¨ remove æ–¹æ³•ä¹‹åï¼Œç¡®å®å°†å†å² log åˆ é™¤äº†ã€‚ä½†å®é™…ä¸Šè¿™å¹¶ä¸æ˜¯åˆ é™¤ï¼Œåªä¸è¿‡æ˜¯å°† sink å¯¹è±¡ç§»é™¤ä¹‹åï¼Œåœ¨è¿™ä¹‹å‰çš„å†…å®¹ä¸ä¼šå†è¾“å‡ºåˆ°æ—¥å¿—ä¸­ã€‚ è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å®ç°æ—¥å¿—çš„åˆ·æ–°é‡æ–°å†™å…¥æ“ä½œã€‚

### rotation é…ç½®

ç”¨äº† loguru æˆ‘ä»¬è¿˜å¯ä»¥éå¸¸æ–¹ä¾¿åœ°ä½¿ç”¨ rotation é…ç½®ï¼Œæ¯”å¦‚æˆ‘ä»¬æƒ³ä¸€å¤©è¾“å‡ºä¸€ä¸ªæ—¥å¿—æ–‡ä»¶ï¼Œæˆ–è€…æ–‡ä»¶å¤ªå¤§äº†è‡ªåŠ¨åˆ†éš”æ—¥å¿—æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ä½¿ç”¨ add æ–¹æ³•çš„ rotation å‚æ•°è¿›è¡Œé…ç½®ã€‚ æˆ‘ä»¬çœ‹çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š
```plain
logger.add('runtime_{time}.log', rotation="500 MB")  
```
é€šè¿‡è¿™æ ·çš„é…ç½®æˆ‘ä»¬å°±å¯ä»¥å®ç°æ¯ 500MB å­˜å‚¨ä¸€ä¸ªæ–‡ä»¶ï¼Œæ¯ä¸ª log æ–‡ä»¶è¿‡å¤§å°±ä¼šæ–°åˆ›å»ºä¸€ä¸ª log æ–‡ä»¶ã€‚æˆ‘ä»¬åœ¨é…ç½® log åå­—æ—¶åŠ ä¸Šäº†ä¸€ä¸ª time å ä½ç¬¦ï¼Œè¿™æ ·åœ¨ç”Ÿæˆæ—¶å¯ä»¥è‡ªåŠ¨å°†æ—¶é—´æ›¿æ¢è¿›å»ï¼Œç”Ÿæˆä¸€ä¸ªæ–‡ä»¶ååŒ…å«æ—¶é—´çš„ log æ–‡ä»¶ã€‚ å¦å¤–æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ rotation å‚æ•°å®ç°å®šæ—¶åˆ›å»º log æ–‡ä»¶ï¼Œä¾‹å¦‚ï¼š
```plain
logger.add('runtime_{time}.log', rotation='00:00')  
```
è¿™æ ·å°±å¯ä»¥å®ç°æ¯å¤© 0 ç‚¹æ–°åˆ›å»ºä¸€ä¸ª log æ–‡ä»¶è¾“å‡ºäº†ã€‚ å¦å¤–æˆ‘ä»¬ä¹Ÿå¯ä»¥é…ç½® log æ–‡ä»¶çš„å¾ªç¯æ—¶é—´ï¼Œæ¯”å¦‚æ¯éš”ä¸€å‘¨åˆ›å»ºä¸€ä¸ª log æ–‡ä»¶ï¼Œå†™æ³•å¦‚ä¸‹ï¼š

```plain
logger.add('runtime_{time}.log', rotation='1 week')  
```
è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å®ç°ä¸€å‘¨åˆ›å»ºä¸€ä¸ª log æ–‡ä»¶äº†ã€‚

### retention é…ç½®

å¾ˆå¤šæƒ…å†µä¸‹ï¼Œä¸€äº›éå¸¸ä¹…è¿œçš„ log å¯¹æˆ‘ä»¬æ¥è¯´å¹¶æ²¡æœ‰ä»€ä¹ˆç”¨å¤„äº†ï¼Œå®ƒç™½ç™½å æ®äº†ä¸€äº›å­˜å‚¨ç©ºé—´ï¼Œä¸æ¸…é™¤æ‰å°±ä¼šéå¸¸æµªè´¹ã€‚retention è¿™ä¸ªå‚æ•°å¯ä»¥é…ç½®æ—¥å¿—çš„æœ€é•¿ä¿ç•™æ—¶é—´ã€‚ æ¯”å¦‚æˆ‘ä»¬æƒ³è¦è®¾ç½®æ—¥å¿—æ–‡ä»¶æœ€é•¿ä¿ç•™ 10 å¤©ï¼Œå¯ä»¥è¿™ä¹ˆæ¥é…ç½®ï¼š

```plain
logger.add('runtime.log', retention='10 days')  
```
è¿™æ · log æ–‡ä»¶é‡Œé¢å°±ä¼šä¿ç•™æœ€æ–° 10 å¤©çš„ logï¼Œå¦ˆå¦ˆå†ä¹Ÿä¸ç”¨æ‹…å¿ƒ log æ²‰ç§¯çš„é—®é¢˜å•¦ã€‚

### compression é…ç½®

loguru è¿˜å¯ä»¥é…ç½®æ–‡ä»¶çš„å‹ç¼©æ ¼å¼ï¼Œæ¯”å¦‚ä½¿ç”¨ zip æ–‡ä»¶æ ¼å¼ä¿å­˜ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š
```plain
logger.add('runtime.log', compression='zip')  
```
è¿™æ ·å¯ä»¥æ›´åŠ èŠ‚çœå­˜å‚¨ç©ºé—´ã€‚

### å­—ç¬¦ä¸²æ ¼å¼åŒ–

loguru åœ¨è¾“å‡º log çš„æ—¶å€™è¿˜æä¾›äº†éå¸¸å‹å¥½çš„å­—ç¬¦ä¸²æ ¼å¼åŒ–åŠŸèƒ½ï¼Œåƒè¿™æ ·ï¼š

```plain
logger.info('If you are using Python {}, prefer {feature} of course!', 3.6, feature='f-strings')  
```
è¿™æ ·åœ¨æ·»åŠ å‚æ•°å°±éå¸¸æ–¹ä¾¿äº†ã€‚

### Traceback è®°å½•

åœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œå¦‚æœé‡åˆ°è¿è¡Œé”™è¯¯ï¼Œè€Œæˆ‘ä»¬åœ¨æ‰“å°è¾“å‡º log çš„æ—¶å€™ä¸‡ä¸€ä¸å°å¿ƒæ²¡æœ‰é…ç½®å¥½ Traceback çš„è¾“å‡ºï¼Œå¾ˆæœ‰å¯èƒ½æˆ‘ä»¬å°±æ²¡æ³•è¿½è¸ªé”™è¯¯æ‰€åœ¨äº†ã€‚ ä½†ç”¨äº† loguru ä¹‹åï¼Œæˆ‘ä»¬ç”¨å®ƒæä¾›çš„è£…é¥°å™¨å°±å¯ä»¥ç›´æ¥è¿›è¡Œ Traceback çš„è®°å½•ï¼Œç±»ä¼¼è¿™æ ·çš„é…ç½®å³å¯ï¼š

```plain
@logger.catch  
def my_function(x, y, z):  
 # An error? It's caught anyway!  
 return 1 / (x + y + z)  
```
æˆ‘ä»¬åšä¸ªæµ‹è¯•ï¼Œæˆ‘ä»¬åœ¨è°ƒç”¨æ—¶ä¸‰ä¸ªå‚æ•°éƒ½ä¼ å…¥ 0ï¼Œç›´æ¥å¼•å‘é™¤ä»¥ 0 çš„é”™è¯¯ï¼Œçœ‹çœ‹ä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µï¼š

```plain
my_function(0, 0, 0)  
```
è¿è¡Œå®Œæ¯•ä¹‹åï¼Œå¯ä»¥å‘ç° log é‡Œé¢å°±å‡ºç°äº† Traceback ä¿¡æ¯ï¼Œè€Œä¸”ç»™æˆ‘ä»¬è¾“å‡ºäº†å½“æ—¶çš„å˜é‡å€¼ï¼ŒçœŸçš„æ˜¯ä¸èƒ½å†èµäº†ï¼ç»“æœå¦‚ä¸‹ï¼š

```plain
> File "run.py", line 15, in <module>  
 my_function(0, 0, 0)  
 â”” <function my_function at 0x1171dd510>  
  
 File "/private/var/py/logurutest/demo5.py", line 13, in my_function  
 return 1 / (x + y + z)  
 â”‚   â”‚   â”” 0  
 â”‚   â”” 0  
 â”” 0  
  
ZeroDivisionError: division by zero  
```
å› æ­¤ï¼Œç”¨ loguru å¯ä»¥éå¸¸æ–¹ä¾¿åœ°å®ç°æ—¥å¿—è¿½è¸ªï¼Œdebug æ•ˆç‡å¯èƒ½è¦é«˜ä¸Šåå€äº†ï¼Ÿ å¦å¤– loguru è¿˜æœ‰å¾ˆå¤šå¾ˆå¤šå¼ºå¤§çš„åŠŸèƒ½ï¼Œè¿™é‡Œå°±ä¸å†ä¸€ä¸€å±•å¼€è®²è§£äº†ï¼Œæ›´å¤šçš„å†…å®¹å¤§å®¶å¯ä»¥çœ‹çœ‹ loguru çš„å®˜æ–¹æ–‡æ¡£è¯¦ç»†äº†è§£ä¸€ä¸‹ï¼š[https://loguru.readthedocs.io/en/stable/index.html](https://loguru.readthedocs.io/en/stable/index.html)ã€‚ çœ‹å®Œä¹‹åï¼Œæ˜¯æ—¶å€™æŠŠè‡ªå·±çš„ logging æ¨¡å—æ›¿æ¢æˆ loguru å•¦ï¼

## ä»£ç å®è·µ

### æ™®é€šä½¿ç”¨
```python
from loguru import logger

debugfile = '/var/log/logit.log'

logger.remove(handler_id=None)  # ä¸è¾“å‡ºstdout
logger.add(debugfile,
           format="{time:YYYY-MM-DD at HH:mm:ss} {level} at Line: {line} Model_name is: **{name}**, Function:{function}, MSG is:{message}",
           rotation="50 MB",
           encoding='utf-8',
           enqueue=True, retention="10 days")

# consoleä¸­å¯ä»¥çœ‹åˆ°ä¸åŒé¢œè‰²è¾“å‡º
logger.info("====str======")
logger.debug("ä¸­æ–‡test")
logger.error("ä¸­æ–‡test")
logger.warning("-----start logging-------")
```

### é…ç½®åˆ° flask

```python
import logging
import sys

from pathlib import Path

from flask import Flask
from loguru import logger

app = Flask(__name__)

class InterceptHandler(logging.Handler):
    def emit(self, record):
        logger_opt = logger.opt(depth=6, exception=record.exc_info)
        logger_opt.log(record.levelname, record.getMessage())



def configure_logging(flask_app: Flask):
    """é…ç½®æ—¥å¿—"""
    path = Path(flask_app.config['LOG_PATH'])
    if not path.exists():
        path.mkdir(parents=True)
    log_name = Path(path, 'sips.log')


    logging.basicConfig(handlers=[InterceptHandler(level='INFO')], level='INFO')
    logger.configure(handlers=[{"sink": sys.stderr, "level": 'INFO'}])  # é…ç½®æ—¥å¿—åˆ°æ ‡å‡†è¾“å‡ºæµ
    logger.add(
        log_name, rotation="500 MB", encoding='utf-8', colorize=False, level='INFO'
    )   # é…ç½®æ—¥å¿—åˆ°è¾“å‡ºåˆ°æ–‡ä»¶
```

## ç›¸å…³é“¾æ¥
- [Table of contents â€” loguru documentation](https://loguru.readthedocs.io/en/stable/)
- [Python ä¸­æ›´ä¼˜é›…çš„æ—¥å¿—è®°å½•æ–¹æ¡ˆ loguru | é™è§…](https://cuiqingcai.com/7776.html) 
- [æ—¥å¿—åº“ Loguru ä½¿ç”¨æ•™ç¨‹ - Huanghuang's Blog](https://huangkai1008.github.io/post/python/loguru/)  