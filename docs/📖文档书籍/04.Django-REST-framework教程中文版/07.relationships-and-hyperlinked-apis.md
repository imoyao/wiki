---
title: æ•™ç¨‹ 5ï¼šRelationships å’Œ Hyperlinked
date: 2021-04-13 10:28:18
permalink: /drf-tutorial/relationships-and-hyperlinked-apis/
categories:
  - ğŸ“–æ–‡æ¡£ä¹¦ç±
  - Django-REST-framework æ•™ç¨‹ä¸­æ–‡ç‰ˆ
tags:
  - DRF
---

ç›®å‰æˆ‘ä»¬ä½¿ç”¨ä¸»é”®æ¥è¡¨ç¤ºæ¨¡å‹ä¹‹é—´çš„å…³ç³»ã€‚åœ¨æœ¬ç« ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è¶…é“¾æ¥å…³ç³»æ¥æé«˜ API çš„å†…èšæ€§ä»¥åŠå¯è¯»æ€§ã€‚

ä¸º API åˆ›å»ºä¸€ä¸ªæ ¹ URL
------------

ç°åœ¨æˆ‘ä»¬'snippets'å’Œ'users'åˆ›å»ºäº†ç›¸åº”çš„ URLï¼Œä½†æˆ‘ä»¬çš„ API æ²¡æœ‰ä¸€ä¸ªç»Ÿä¸€çš„å…¥å£ã€‚æˆ‘ä»¬ä½¿ç”¨æ—©äº›ä»‹ç»çš„æ™®é€šå‡½æ•°è§†å›¾å’Œ`@api_view`è£…é¥°å™¨æ¥åˆ›å»ºä¸€ä¸ªï¼Œç¼–è¾‘`snippets/views.py`æ·»åŠ ä¸‹é¢ä»£ç ï¼š
```python
from rest_framework.decorators import api_view
from rest_framework.response import Response
from rest_framework.reverse import reverse


@api_view(['GET'])
def api_root(request, format=None):
    return Response({
        'users': reverse('user-list', request=request, format=format),
        'snippets': reverse('snippet-list', request=request, format=format)
    })
```
è¿™é‡Œæœ‰ä¸¤ä»¶äº‹éœ€è¦æ³¨æ„ï¼šé¦–å…ˆæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯ REST æ¡†æ¶æä¾›çš„`reverse`å‡½æ•°æ¥è¿”å›å®Œå…¨é™å®šçš„ URL;ç¬¬äºŒï¼ŒURL é€šè¿‡ç¨åå®šä¹‰åœ¨`snippets/urls.py`ä¸­çš„åå­—æ¥è¢«è¯†åˆ«ã€‚

ä¸ºè¯­æ³•é«˜äº®åŠŸèƒ½åˆ›å»º URL
------------

å¾ˆæ˜æ˜¾çš„ä¸€ä»¶äº‹å°±æ˜¯æˆ‘ä»¬è¿˜æ²¡ä¸ºè¯­æ³•é«˜äº®åŠŸèƒ½åˆ›å»º URLã€‚

ä¸å…¶å®ƒçš„ API ä¸åŒï¼Œè¿™ä¸ªæ¥å£æˆ‘ä»¬æƒ³ä½¿ç”¨ HTML æ¥è¡¨ç¤ºè€Œä¸æ˜¯ JSONã€‚REST æ¡†æ¶æä¾›äº† 2 ç§å‘ˆç° HTML çš„æ–¹æ³•ï¼Œä¸€ç§æ˜¯ä½¿ç”¨æ¨¡æ¿æ¸²æŸ“ï¼Œå¦ä¸€ç§åˆ™æ˜¯ä½¿ç”¨å·²ç»æ„å»ºå¥½çš„ HTML ä»£ç ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ç¬¬äºŒç§æ–¹å¼ã€‚

å¦ä¸€ä¸ªéœ€è¦è€ƒè™‘çš„å°±æ˜¯ä¸å­˜åœ¨é€šç”¨ç±»è§†å›¾æ¥ä¾›æˆ‘ä»¬åˆ›å»ºè¯­æ³•é«˜äº®è§†å›¾ä½¿ç”¨ï¼Œæ‰€ä»¥è¿™é‡Œä¸è¿”å›ä¸€ä¸ªå¯¹è±¡å®ä¾‹ï¼Œè€Œæ˜¯è¿”å›å¯¹è±¡å®ä¾‹çš„å±æ€§ã€‚

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨æœ€åŸºç¡€çš„ç±»è§†å›¾çš„`get()`æ–¹æ³•è€Œéé€šç”¨ç±»è§†å›¾ï¼Œåœ¨`snippets/views.py`ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š
```python
from rest_framework import renderers
from rest_framework.response import Response

class SnippetHighlight(generics.GenericAPIView):
    queryset = Snippet.objects.all()
    renderer_classes = (renderers.StaticHTMLRenderer,)

    def get(self, request, *args, **kwargs):
        snippet = self.get_object()
        return Response(snippet.highlighted)
```

å°±åƒå¾€å¸¸ä¸€æ ·ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ä¸ºæ–°çš„è§†å›¾æ¥åˆ›å»º URL é…ç½®ã€‚ä¿®æ”¹`snippets/urls.py`ï¼Œæ·»åŠ ï¼š
```python
path('', views.api_root),
```
åŒæ—¶ä¸º snippet highlights æ·»åŠ  url åŒ¹é…ï¼š
```python
path('snippets/<int:pk>/highlight/', views.SnippetHighlight.as_view()),
```

ä½¿ç”¨è¶…é“¾æ¥
-----

åœ¨ Web API ä¸­å¤„ç†å®ä½“ä¹‹é—´çš„å…³ç³»æ˜¯ä¸€ä»¶éå¸¸å¤´ç–¼çš„äº‹æƒ…ã€‚ä¸‹é¢æœ‰å‡ ç§ä¸åŒçš„æ–¹æ³•æ¥è¡¨ç¤ºå…³ç³»ï¼š

*   ä½¿ç”¨ä¸»é”®
*   ä½¿ç”¨è¶…é“¾æ¥
*   åœ¨ç›¸å…³å®ä½“é—´ä½¿ç”¨å”¯ä¸€çš„ slug å­—æ®µè¡¨ç¤º
*   åœ¨ç›¸å…³å®ä½“é—´ä½¿ç”¨é»˜è®¤çš„å­—ç¬¦ä¸²è¡¨ç¤º
*   å°†ç›¸å…³çš„å­å®ä½“åµŒå¥—åˆ°ä¸Šçº§å…³ç³»ä¸­
*   å…¶ä»–è‡ªå®šä¹‰æ–¹æ³•

REST framework æ”¯æŒä¸Šè¿°æ‰€æœ‰æ–¹æ³•ï¼Œå¹¶ä¸”å¯ä»¥åº”ç”¨äºæ­£å‘å…³ç³»ã€åå‘å…³ç³»æˆ–ç±»ä¼¼é€šç”¨å¤–é”®è¿™ç±»è‡ªå®šä¹‰ç®¡ç†é¡¹ä¸­ã€‚

åœ¨è¿™é‡Œæˆ‘ä»¬åœ¨å®ä½“é—´ä½¿ç”¨è¶…é“¾æ¥æ¥è¿›è¡Œå…³è”ï¼Œä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„æˆ‘ä»¬éœ€è¦ä¿®æ”¹ serializersï¼Œä½¿ç”¨`HyperlinkedModelSerializer`æ¥æ›¿ä»£åŸå…ˆçš„`ModelSerializer`ï¼š

*   `HyperlinkedModelSerializer` é»˜è®¤ä¸åŒ…å«ä¸»é”®
*   `HyperlinkedModelSerializer` è‡ªåŠ¨åŒ…å« URL å­—æ®µ `HyperlinkedIdentityField`
*   ä½¿ç”¨ `HyperlinkedRelatedField` æ¥æ›¿ä»£ `PrimaryKeyRelatedField` è¡¨ç¤ºå…³ç³»

æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„æ”¹å†™ä»£ç ï¼Œç¼–è¾‘`snippets/serializers.py`ï¼š
```python
class SnippetSerializer(serializers.HyperlinkedModelSerializer):
    owner = serializers.ReadOnlyField(source='owner.username')
    highlight = serializers.HyperlinkedIdentityField(view_name='snippet-highlight', format='html')

    class Meta:
        model = Snippet
        fields = ['url', 'id', 'highlight', 'owner',
                  'title', 'code', 'linenos', 'language', 'style']


class UserSerializer(serializers.HyperlinkedModelSerializer):
    snippets = serializers.HyperlinkedRelatedField(many=True, view_name='snippet-detail', read_only=True)

    class Meta:
        model = User
        fields = ['url', 'id', 'username', 'snippets']
```  

è¿™é‡Œæ–°å¢äº†ä¸€ä¸ª`highlight`å­—æ®µï¼Œè¿™ä¸ªå­—æ®µå’Œ`url`å­—æ®µç±»å‹ç›¸åŒï¼ŒåŒºåˆ«å°±æ˜¯å®ƒæŒ‡å‘`snippet-highlight`è€Œé`snippet-detail`ã€‚

ç”±äºæˆ‘ä»¬æœ‰`.json`æ ¼å¼çš„åç¼€ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿè¦æŒ‡æ˜`highlight`å­—æ®µä½¿ç”¨`.html`æ¥è¿”å›ç›¸åº”çš„æ ¼å¼ã€‚

ä¸º URL å‘½å
------

å¦‚æœæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåŸºäºè¶…é“¾æ¥çš„ APIï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿æ¯ä¸ª URL éƒ½è¢«å‘½åäº†ã€‚è®©æˆ‘ä»¬çœ‹çœ‹é‚£äº›éœ€è¦è¢«å‘½åçš„ URLï¼š

*   æ ¹ URL åŒ…å«'user-list'å’Œ'snippet-list'
*   snippet serializer åŒ…å«æŒ‡å‘'snippet-highlight'çš„å­—æ®µ
*   user serializer åŒ…å«æŒ‡å‘'snippet-detail'çš„å­—æ®µ
*   snippet serializers å’Œ user serializers åŒ…å«'url'å­—æ®µï¼Œè¿™ä¸ªå­—æ®µé»˜è®¤æŒ‡å‘'{model\_name}-detail',è¿™é‡Œåˆ†åˆ«æ˜¯'snippet-detail'å’Œ'user-detail'

æœ€ç»ˆï¼Œæˆ‘ä»¬çš„`snippets/urls.py`å¦‚ä¸‹ï¼š

```python
from django.urls import path
from rest_framework.urlpatterns import format_suffix_patterns
from snippets import views

# API endpoints
urlpatterns = format_suffix_patterns([
    path('', views.api_root),
    path('snippets/',
        views.SnippetList.as_view(),
        name='snippet-list'),
    path('snippets/<int:pk>/',
        views.SnippetDetail.as_view(),
        name='snippet-detail'),
    path('snippets/<int:pk>/highlight/',
        views.SnippetHighlight.as_view(),
        name='snippet-highlight'),
    path('users/',
        views.UserList.as_view(),
        name='user-list'),
    path('users/<int:pk>/',
        views.UserDetail.as_view(),
        name='user-detail')
])
```
    

åˆ†é¡µ
--

åˆ—è¡¨è§†å›¾å¯èƒ½ä¸ºç”¨æˆ·è¿”å›å¾ˆå¤šä»£ç ç‰‡æ®µï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹ç»“æœè¿›è¡Œåˆ†é¡µï¼Œå¹¶ä¸”å¯ä»¥éå†æ¯ä¸ªå•ç‹¬çš„é¡µé¢ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åˆ†é¡µæ¥ä¿®æ”¹é»˜è®¤çš„åˆ—è¡¨æ ·å¼ï¼Œä¿®æ”¹`tutorial/settings.py`æ·»åŠ ï¼š

```python
REST_FRAMEWORK = {
    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',
    'PAGE_SIZE': 10
}
```

æ³¨æ„ï¼Œæ‰€æœ‰å…³äº REST æ¡†æ¶çš„è®¾å®šéƒ½åœ¨ä¸€ä¸ªå«åš`'REST_FRAMEWORK'`çš„å­—å…¸ä¸­ï¼Œè¿™å¸®åŠ©æˆ‘ä»¬å°†è®¾å®šä¿¡æ¯å’Œå…¶ä»–çš„åº“åˆ†ç¦»å¼€æ¥ã€‚

å¦‚æœéœ€è¦çš„è¯æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå®šä¹‰åˆ†é¡µæ ·å¼ï¼Œä½†è¿™é‡Œæˆ‘ä»¬å…ˆä½¿ç”¨é»˜è®¤é€‰é¡¹ã€‚

æµ‹è¯•
--

æ‰“å¼€æµè§ˆå™¨ï¼Œå°±ä¼šå‘ç°ä½ å¯ä»¥ä½¿ç”¨è¶…é“¾æ¥æ¥ç®€å•çš„æµè§ˆ API äº†ã€‚ä½ ä¹Ÿä¼šåœ¨ snippet ä¸­çœ‹åˆ°'highlight'é“¾æ¥,è¿™å°†è¿”å›é«˜äº®çš„ HTML æ ¼å¼ä»£ç ã€‚

åœ¨æœ¬æ•™ç¨‹çš„ç¬¬ 6 éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†çœ‹çœ‹å¦‚ä½•ä½¿ç”¨è§†å›¾å’Œè·¯ç”±å™¨æ¥å‡å°‘æ„å»º API æ‰€éœ€çš„ä»£ç é‡ã€‚