---
title: æ•™ç¨‹ 1ï¼šåºåˆ—åŒ–
date: 2021-04-13 10:25:59
permalink: /drf-tutorial/serialization/
categories:
  - ğŸ“–æ–‡æ¡£ä¹¦ç±
  - Django-REST-framework æ•™ç¨‹ä¸­æ–‡ç‰ˆ
tags:
  - DRF
---

åœ¨è¿™ä¸ªæ•™ç¨‹ä¸­å°†åˆ›å»ºä¸€ä¸ªæ”¯æŒä»£ç é«˜äº®å±•ç¤ºçš„ APIã€‚æˆ‘ä»¬ä¼šä»‹ç»ç»„æˆ REST framework çš„å„ä¸ªç»„ä»¶ï¼Œå¹¶ä¸”è®©ä½ æ˜ç™½è¿™äº›ç»„ä»¶æ˜¯å¦‚ä½•ç›¸äº’åä½œçš„ã€‚ è¿™ç¯‡æ•™ç¨‹ä¼šæ¯”è¾ƒæ·±å…¥ï¼Œæ‰€ä»¥å¼€å§‹ä¹‹å‰ä½ åº”è¯¥å‡†å¤‡å¥½é›¶é£Ÿå’Œå•¤é…’ã€‚å¦‚æœä½ ä»…ä»…æƒ³å¤§æ¦‚äº†è§£ï¼Œè¯·çœ‹[å¿«é€Ÿå…¥é—¨](/drf-tutorial/quickstart/)ã€‚


::: tip
æç¤ºï¼šè¿™ç¯‡æ•™ç¨‹çš„æºç å¯ä»¥åœ¨[tomchristie/rest-framework-tutorial](https://github.com/tomchristie/rest-framework-tutorial)æ‰¾åˆ°ï¼Œä¹Ÿæä¾›äº†åœ¨çº¿ç‰ˆä¾›å¤§å®¶æµ‹è¯•ï¼Œè¯·ç‚¹å‡»[è¿™é‡Œ](http://restframework.herokuapp.com/)ã€‚
:::

è®¾ç½®ä¸€ä¸ªæ–°è™šæ‹Ÿç¯å¢ƒ
---------

é¦–å…ˆæˆ‘ä»¬ä½¿ç”¨`virtualenv`åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç¯å¢ƒï¼Œè¿™æ ·å¯ä»¥å¾ˆå¥½çš„å’Œå…¶ä»–é¡¹ç›®éš”ç¦»æ‰€éœ€çš„ä¾èµ–åº“ï¼š

    virtualenv envplainplainplainplain
    source env/bin/activate
    

ç„¶ååœ¨è™šæ‹Ÿç¯å¢ƒä¸­å®‰è£…éœ€è¦çš„ä¾èµ–ï¼š

    pip install djangoplain
    pip install djangorestframework
    pip install pygments # è¿™ä¸ªç”¨äºè¯­æ³•é«˜äº®
    

**æ³¨æ„**ä½¿ç”¨`deactive`æ¥é€€å‡ºè™šæ‹Ÿç¯å¢ƒï¼Œæ›´å¤šä¿¡æ¯è¯·çœ‹[virtualenvæ–‡æ¡£](http://www.virtualenv.org/en/latest/index.html)ã€‚

å¼€å§‹
--

é¦–å…ˆæˆ‘ä»¬æ¥åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®ï¼š
```shell
    cd ~
    django-admin.py startproject tutorial
    cd tutorial
```

æ¥ä¸‹æ¥åˆ›å»ºä¸€ä¸ª APPï¼š
```plain
    python manage.py startapp snippets
    
```
ç„¶åç¼–è¾‘`tutorial/settings.py`ï¼ŒæŠŠæˆ‘ä»¬çš„`snippets`å’Œ`rest_framework`æ·»åŠ åˆ°`INSTALLED_APPS`ï¼š
```python
    INSTALLED_APPS = (
        ...
        'rest_framework',
        'snippets.apps.SnippetsConfig',
    )
```

åˆ›å»º Model
-------

é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª`Snippet`æ¨¡å‹æ¥å­˜å‚¨ä»£ç ç‰‡æ®µã€‚æ³¨æ„ï¼šå†™æ³¨é‡Šæ˜¯ä¸€ä¸ªå¥½ç¼–ç¨‹ä¹ æƒ¯ï¼Œä¸è¿‡ä¸ºäº†ä¸“æ³¨äºä»£ç æœ¬èº«ï¼Œæˆ‘ä»¬åœ¨ä¸‹é¢çœç•¥äº†æ³¨é‡Šã€‚ç¼–è¾‘`snippets/models.py`ï¼š
```python
    from django.db import models
    from pygments.lexers import get_all_lexers
    from pygments.styles import get_all_styles
    
    LEXERS = [item for item in get_all_lexers() if item[1]]
    LANGUAGE_CHOICES = sorted([(item[1][0], item[0]) for item in LEXERS])
    STYLE_CHOICES = sorted((item, item) for item in get_all_styles())
    
    
    class Snippet(models.Model):
        created = models.DateTimeField(auto_now_add=True)
        title = models.CharField(max_length=100, blank=True, default='')
        code = models.TextField()
        linenos = models.BooleanField(default=False)
        language = models.CharField(choices=LANGUAGE_CHOICES, default='python', max_length=100)
        style = models.CharField(choices=STYLE_CHOICES, default='friendly', max_length=100)
    
        class Meta:
            ordering = ('created',)
    
```
æ¥ä¸‹æ¥åœ¨æ•°æ®åº“ä¸­å»ºè¡¨ï¼š
```python
python manage.py makemigrations snippets
python manage.py migrate
```

åˆ›å»º Serializer ç±»
-------------

ç¬¬ä¸€æ­¥æˆ‘ä»¬éœ€è¦ä¸º API æä¾›ä¸€ä¸ªåºåˆ—åŒ–ä»¥åŠååºåˆ—åŒ–çš„æ–¹æ³•ï¼Œç”¨æ¥æŠŠ snippet å¯¹è±¡è½¬åŒ–æˆ json æ•°æ®æ ¼å¼ï¼Œåˆ›å»º serializers å’Œåˆ›å»º Django è¡¨å•ç±»ä¼¼ã€‚æˆ‘ä»¬åœ¨`snippets`ç›®å½•åˆ›å»ºä¸€ä¸ª`serializers.py`ï¼š
```python
    from rest_framework import serializers
    from snippets.models import Snippet, LANGUAGE_CHOICES, STYLE_CHOICES
    
    
    class SnippetSerializer(serializers.Serializer):
        pk = serializers.IntegerField(read_only=True)
        title = serializers.CharField(required=False, allow_blank=True, max_length=100)
        code = serializers.CharField(style={'base_template': 'textarea.html'})
        linenos = serializers.BooleanField(required=False)
        language = serializers.ChoiceField(choices=LANGUAGE_CHOICES, default='python')
        style = serializers.ChoiceField(choices=STYLE_CHOICES, default='friendly')
    
        def create(self, validated_data):
            """
            å¦‚æœæ•°æ®åˆæ³•å°±åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªsnippetå®ä¾‹
            """
            return Snippet.objects.create(**validated_data)
    
        def update(self, instance, validated_data):
            """
            å¦‚æœæ•°æ®åˆæ³•å°±æ›´æ–°å¹¶è¿”å›ä¸€ä¸ªå­˜åœ¨çš„snippetå®ä¾‹
            """
            instance.title = validated_data.get('title', instance.title)
            instance.code = validated_data.get('code', instance.code)
            instance.linenos = validated_data.get('linenos', instance.linenos)
            instance.language = validated_data.get('language', instance.language)
            instance.style = validated_data.get('style', instance.style)
            instance.save()
            return instance
    
```
åœ¨ç¬¬ä¸€éƒ¨åˆ†æˆ‘ä»¬å®šä¹‰äº†åºåˆ—åŒ–/ååºåˆ—åŒ–çš„å­—æ®µï¼Œ`creat()`å’Œ`update()`æ–¹æ³•åˆ™å®šä¹‰äº†å½“æˆ‘ä»¬è°ƒç”¨`serializer.save()`æ—¶å¦‚ä½•æ¥åˆ›å»ºæˆ–ä¿®æ”¹ä¸€ä¸ªå®ä¾‹ã€‚

serializer ç±»å’Œ Django çš„ Form ç±»å¾ˆåƒï¼Œå¹¶ä¸”åŒ…å«äº†ç›¸ä¼¼çš„å±æ€§æ ‡è¯†ï¼Œæ¯”å¦‚`required`ã€ `max_length`å’Œ`default`ã€‚

è¿™äº›æ ‡è¯†ä¹Ÿèƒ½æ§åˆ¶åºåˆ—åŒ–åçš„å­—æ®µå¦‚ä½•å±•ç¤ºï¼Œæ¯”å¦‚æ¸²æŸ“æˆ HTMLã€‚ä¸Šé¢çš„`{'base_template': 'textarea.html'}`å’Œåœ¨ Django çš„ Form ä¸­è®¾å®š`widget=widgets.Textarea`æ˜¯ç­‰æ•ˆçš„ã€‚ è¿™ä¸€ç‚¹åœ¨æ§åˆ¶ API åœ¨æµè§ˆå™¨ä¸­å¦‚ä½•å±•ç¤ºæ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œæˆ‘ä»¬åé¢çš„æ•™ç¨‹ä¸­ä¼šçœ‹åˆ°ã€‚

æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨`ModelSerializer`ç±»æ¥èŠ‚çœæ—¶é—´ï¼Œåç»­ä¹Ÿä¼šä»‹ç»ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆæ˜¾å¼çš„å®šä¹‰ serializerã€‚

ä½¿ç”¨ serializer
------------

ç»§ç»­ä¹‹å‰æˆ‘ä»¬å…ˆæ¥ç†Ÿæ‚‰ä¸€ä¸‹æˆ‘ä»¬çš„ serializer ç±»ï¼Œæ‰“å¼€ Django shell:
```shell
python manage.py shell
```
å¼•å…¥ç›¸å…³çš„ä»£ç ååˆ›å»º 2 ä¸ª snippet å®ä¾‹ï¼š
```python
from snippets.models import Snippet
from snippets.serializers import SnippetSerializer
from rest_framework.renderers import JSONRenderer
from rest_framework.parsers import JSONParser

snippet = Snippet(code='foo = "bar"\n')
snippet.save()

snippet = Snippet(code='print "hello, world"\n')
snippet.save()
``` 

ç°åœ¨æˆ‘ä»¬æœ‰äº†å¯ä»¥æ“ä½œçš„å®ä¾‹äº†ï¼Œè®©æˆ‘ä»¬æ¥åºåˆ—åŒ–ä¸€ä¸ªå®ä¾‹ï¼š
```python
serializer = SnippetSerializer(snippet)
serializer.data
# {'pk': 2, 'title': u'', 'code': u'print "hello, world"\n', 'linenos': False, 'language': u'python', 'style': u'friendly'}
```

è¿™é‡Œæˆ‘ä»¬æŠŠ snippet è½¬æ¢æˆäº† Python åŸºæœ¬æ•°æ®ç±»å‹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æŠŠå…¶è½¬æ¢æˆ json æ•°æ®ï¼š
```python
content = JSONRenderer().render(serializer.data)
content
# '{"pk": 2, "title": "", "code": "print \\"hello, world\\"\\n", "linenos": false, "language": "python", "style": "friendly"}'
```

ååºåˆ—åŒ–ä¹Ÿç±»ä¼¼ï¼Œæˆ‘ä»¬å…ˆæŠŠä¸€ä¸ª stream è½¬æ¢æˆ python åŸºæœ¬æ•°æ®ç±»å‹ï¼š
```python
from django.utils.six import BytesIO

stream = BytesIO(content)
data = JSONParser().parse(stream)
```

ç„¶åå°†å…¶è½¬æ¢ä¸ºå®ä¾‹ï¼š
```python
serializer = SnippetSerializer(data=data)
serializer.is_valid()
# True
serializer.validated_data
# OrderedDict([('title', ''), ('code', 'print "hello, world"\n'), ('linenos', False), ('language', 'python'), ('style', 'friendly')])
serializer.save()
# <Snippet: Snippet object>
```

å¯ä»¥çœ‹å‡ºè¿™å’Œ Django çš„ Form å¤šä¹ˆç›¸ä¼¼ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ serializer ç¼–å†™ view æ—¶è¿™ä¸€ç‰¹æ•ˆä¼šæ›´æ˜æ˜¾ã€‚

æˆ‘ä»¬ä¹Ÿå¯ä»¥åºåˆ—åŒ–å®ä¾‹çš„é›†åˆï¼Œä»…éœ€è¦è®¾ç½® serializer çš„å‚æ•°`many=True`å³å¯ï¼š
```python
    serializer = SnippetSerializer(Snippet.objects.all(), many=True)
    serializer.data
    # [OrderedDict([('pk', 1), ('title', u''), ('code', u'foo = "bar"\n'), ('linenos', False), ('language', 'python'), ('style', 'friendly')]), OrderedDict([('pk', 2), ('title', u''), ('code', u'print "hello, world"\n'), ('linenos', False), ('language', 'python'), ('style', 'friendly')]), OrderedDict([('pk', 3), ('title', u''), ('code', u'print "hello, world"'), ('linenos', False), ('language', 'python'), ('style', 'friendly')])]
   ``` 

ä½¿ç”¨ ModelSerializers
------------------

æˆ‘ä»¬çš„`SnippetSerializer`ç±»å’Œ`Snippet`æ¨¡å‹æœ‰å¤ªå¤šé‡å¤çš„ä»£ç ï¼Œå¦‚æœè®©ä»£ç æ›´ç®€æ´å°±æ›´å¥½äº†ã€‚

Django æä¾›äº†`Form`ç±»å’Œ`ModelForm`ç±»ï¼ŒåŒæ ·çš„ï¼ŒREST framework æä¾›äº†`Serializer`ç±»å’Œ`ModelSerializer`ã€‚

è®©æˆ‘ä»¬ä½¿ç”¨`ModelSerializer`æ¥é‡æ„ä»£ç ï¼Œç¼–è¾‘`snippets/serializers.py`ï¼š
```python
    class SnippetSerializer(serializers.ModelSerializer):
        class Meta:
            model = Snippet
            fields = ('id', 'title', 'code', 'linenos', 'language', 'style')
```

æˆ‘ä»¬å¯ä»¥é€šè¿‡æ‰“å°è¾“å‡ºæ¥æ£€æŸ¥ serializer åŒ…å«å“ªäº›å­—æ®µï¼Œæ‰“å¼€ Django shell å¹¶è¾“å…¥ä¸€ä¸‹ä»£ç ï¼š
```python
from snippets.serializers import SnippetSerializer
serializer = SnippetSerializer()
print(repr(serializer))
# SnippetSerializer():
#    id = IntegerField(label='ID', read_only=True)
#    title = CharField(allow_blank=True, max_length=100, required=False)
#    code = CharField(style={'base_template': 'textarea.html'})
#    linenos = BooleanField(required=False)
#    language = ChoiceField(choices=[('Clipper', 'FoxPro'), ('Cucumber', 'Gherkin'), ('RobotFramework', 'RobotFramework'), ('abap', 'ABAP'), ('ada', 'Ada')...
#    style = ChoiceField(choices=[('autumn', 'autumn'), ('borland', 'borland'), ('bw', 'bw'), ('colorful', 'colorful')...

```
è¯·è®°ä½`ModelSerializer`å¹¶æ²¡æœ‰ä½¿ç”¨ä»»ä½•é»‘ç§‘æŠ€ï¼Œå®ƒä»…ä»…æ˜¯ä¸€ä¸ªåˆ›å»º serializer ç±»çš„ç®€å•æ–¹æ³•ï¼š

*   è‡ªåŠ¨æ£€æµ‹å­—æ®µ
*   ç®€å•çš„å®šä¹‰äº†`create()`å’Œ`update()`æ–¹æ³•ã€‚

ä½¿ç”¨ Serializer ç¼–å†™å¸¸è§„çš„ Django è§†å›¾
-------------------------

ç°åœ¨æˆ‘ä»¬æ¥ä½¿ç”¨ Serializer ç±»æ¥ç¼–å†™ API è§†å›¾ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸ä½¿ç”¨ä»»ä½• REST framewrok çš„å…¶ä»–ç‰¹æ€§ï¼Œä»…ä½¿ç”¨ Django çš„å¸¸è§„æ–¹æ³•ç¼–å†™è§†å›¾ã€‚

é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª`HttpResponse`çš„å­ç±»æ¥è¿”å› json ç±»å‹æ•°æ®ã€‚

ç¼–è¾‘`snippets/views.py`ï¼š
```python
from django.http import HttpResponse
from django.views.decorators.csrf import csrf_exempt
from rest_framework.renderers import JSONRenderer
from rest_framework.parsers import JSONParser
from snippets.models import Snippet
from snippets.serializers import SnippetSerializer

class JSONResponse(HttpResponse):
    """
    ç”¨äºè¿”å›JSONæ•°æ®.
    """
    def __init__(self, data, **kwargs):
        content = JSONRenderer().render(data)
        kwargs['content_type'] = 'application/json'
        super(JSONResponse, self).__init__(content, **kwargs)
```

æˆ‘ä»¬ API çš„æ ¹ç›®å½•æ˜¯ä¸€ä¸ª list view, ç”¨äºå±•ç¤ºæ‰€æœ‰å­˜åœ¨çš„ snippet, æˆ–å»ºç«‹æ–°çš„ snippet:
```python
@csrf_exempt
def snippet_list(request):
    """
    å±•ç¤ºæ‰€ä»¥snippets,æˆ–åˆ›å»ºæ–°çš„snippet.
    """
    if request.method == 'GET':
        snippets = Snippet.objects.all()
        serializer = SnippetSerializer(snippets, many=True)
        return JSONResponse(serializer.data)

    elif request.method == 'POST':
        data = JSONParser().parse(request)
        serializer = SnippetSerializer(data=data)
        if serializer.is_valid():
            serializer.save()
            return JSONResponse(serializer.data, status=201)
        return JSONResponse(serializer.errors, status=400)
```

æ³¨æ„ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸ºäº†èƒ½ç®€å•çš„åœ¨å®¢æˆ·ç«¯è¿›è¡Œ POST æ“ä½œè€Œä½¿ç”¨äº†`csrf_exempt`ï¼Œæ­£å¸¸æƒ…å†µä¸‹ä½ ä¸åº”è¯¥è¿™ä¹ˆåšï¼ŒREST frameworkæä¾›äº†æ›´å®‰å…¨çš„åšæ³•ã€‚

æˆ‘ä»¬ä¹Ÿéœ€è¦ä¸€ä¸ªé¡µé¢ç”¨æ¥å±•ç¤ºã€ä¿®æ”¹æˆ–åˆ é™¤æŸä¸ªå…·ä½“çš„snippetï¼š
```plain
@csrf_exempt
def snippet_detail(request, pk):
    """
    ä¿®æ”¹æˆ–åˆ é™¤ä¸€ä¸ªsnippet.
    """
    try:
        snippet = Snippet.objects.get(pk=pk)
    except Snippet.DoesNotExist:
        return HttpResponse(status=404)

    if request.method == 'GET':
        serializer = SnippetSerializer(snippet)
        return JSONResponse(serializer.data)

    elif request.method == 'PUT':
        data = JSONParser().parse(request)
        serializer = SnippetSerializer(snippet, data=data)
        if serializer.is_valid():
            serializer.save()
            return JSONResponse(serializer.data)
        return JSONResponse(serializer.errors, status=400)

    elif request.method == 'DELETE':
        snippet.delete()
        return HttpResponse(status=204)
```

æ¥ä¸‹æ¥ä¿®æ”¹`snippets/urls.py`ï¼š
```plain
    from django.conf.urls import url
    from snippets import views
    
    urlpatterns = [
        url(r'^snippets/$', views.snippet_list),
        url(r'^snippets/(?P<pk>[0-9]+)/$', views.snippet_detail),
    ]
    
```
è¿™é‡Œæˆ‘ä»¬æœ‰è®¸å¤šç»†èŠ‚æ²¡æœ‰å¤„ç†ï¼Œæ¯”å¦‚ç•¸å½¢çš„ JSON æ•°æ®ã€ä¸æ”¯æŒçš„ HTTP è¯·æ±‚æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘ä»¬éƒ½æš‚æ—¶è¿”å› 500 é”™è¯¯ã€‚

æµ‹è¯•API
-----

ç°åœ¨æˆ‘ä»¬å¯ä»¥å¯åŠ¨æˆ‘ä»¬çš„æœåŠ¡å™¨äº†ã€‚

é¦–å…ˆä½¿ç”¨`quit()`é€€å‡º shell,ç„¶åå¯åŠ¨æœåŠ¡ï¼š
```plain
python manage.py runserver

Validating models...

0 errors found
Django version 1.8.3, using settings 'tutorial.settings'
Development server is running at http://127.0.0.1:8000/
Quit the server with CONTROL-C.
```

æ‰“å¼€å¦ä¸€ä¸ªç»ˆç«¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ curl æˆ– httpie æ¥è¿›è¡Œæµ‹è¯•ã€‚httpie æ˜¯ä¸€ä¸ªç”¨ python ç¼–å†™çš„æ˜“ç”¨çš„ http å®¢æˆ·ç«¯ï¼Œé¦–å…ˆæ¥å®‰è£… httpie:
```plain
    pip install httpie
    
```
æœ€ç»ˆï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ª snippets åˆ—è¡¨ï¼š
```plain
    http http://127.0.0.1:8000/snippets/
    
    HTTP/1.1 200 OK
    ...
    [
      {
        "id": 1,
        "title": "",
        "code": "foo = \"bar\"\n",
        "linenos": false,
        "language": "python",
        "style": "friendly"
      },
      {
        "id": 2,
        "title": "",
        "code": "print \"hello, world\"\n",
        "linenos": false,
        "language": "python",
        "style": "friendly"
      }
    ]
    ```

æˆ–è€…é€šè¿‡IDæ¥è·å–æŸä¸ªç‰¹å®šçš„snippetsï¼š
```
http http://127.0.0.1:8000/snippets/2/

HTTP/1.1 200 OK
...
{
    "id": 2,
    "title": "",
    "code": "print \"hello, world\"\n",
    "linenos": false,
    "language": "python",
    "style": "friendly"
}
```plain

åŒæ ·çš„ï¼Œä½ å¯ä»¥ä½¿ç”¨æµè§ˆå™¨è®¿é—®é‚£äº›URLã€‚
