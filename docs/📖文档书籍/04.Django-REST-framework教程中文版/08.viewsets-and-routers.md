---
title: æ•™ç¨‹ 6ï¼šViewSets å’Œ Routers
date: 2021-04-13 10:29:01
permalink: /drf-tutorial/viewsets-and-routers/
categories:
  - ğŸ“–æ–‡æ¡£ä¹¦ç±
  - Django-REST-framework æ•™ç¨‹ä¸­æ–‡ç‰ˆ
tags:
  - DRF
---

REST framework æä¾›äº†ä¸€ç§å«åš`ViewSets`çš„æŠ½è±¡è¡Œä¸ºï¼Œå®ƒå¯ä»¥ä½¿å¼€å‘äººå‘˜èšç„¦äº API çš„çŠ¶æ€å’Œå®ç°ï¼ŒåŸºäºå¸¸è§çš„çº¦å®šè€Œè‡ªåŠ¨è¿›è¡Œ URL é…ç½®ã€‚

`ViewSet`å’Œ`View`å¾ˆåƒï¼Œé™¤äº†å®ƒæä¾›çš„æ˜¯`read`ä»¥åŠ`update`æ“ä½œè€Œä¸æ˜¯ HTTP çš„`get`æˆ–è€…`post`ã€‚

`ViewSet`ä»…åœ¨è¢«è°ƒç”¨çš„æ—¶å€™æ‰ä¼šå’Œå¯¹åº”çš„æ–¹æ³•è¿›è¡Œç»‘å®šï¼Œå½“å®ƒè¢«å®ä¾‹åŒ–æ—¶â€”â€”é€šå¸¸æ˜¯åœ¨ä½¿ç”¨`Route`ç±»ç®¡ç† URL é…ç½®çš„æ—¶å€™ã€‚

ä½¿ç”¨ ViewSet é‡æ„ä»£ç 
-------------

é¦–å…ˆæˆ‘ä»¬ä½¿ç”¨ä½†ä¸€ä¸ª`UserViewSet`æ¥å–ä»£`UserList`å’Œ`UserDetail`ï¼Œæˆ‘ä»¬å…ˆç§»é™¤é‚£ä¸¤ä¸ªç±»ï¼Œå¹¶æ·»åŠ ï¼š

    from rest_framework import viewsetsplainplainplain
    
    class UserViewSet(viewsets.ReadOnlyModelViewSet):
        """
        This viewset automatically provides `list` and `detail` actions.
        """
        queryset = User.objects.all()
        serializer_class = UserSerializer
    

ç°åœ¨æˆ‘ä»¬ä½¿ç”¨`ReadOnlyModelViewSet`è‡ªåŠ¨æä¾›äº†â€œåªè¯»â€æ–¹æ³•ï¼Œå¹¶ä¸”ä¾ç„¶æƒ³ä½¿ç”¨å¸¸è§„è§†å›¾æ˜¯é‚£æ ·è®¾ç½®äº†`queryset`å’Œ`seriallizer_class`å±æ€§ï¼Œä½†æˆ‘ä»¬ä¸éœ€è¦å†™ 2 ä¸ªç±»äº†ã€‚

ä¸‹é¢æˆ‘ä»¬ä¿®æ”¹`SnippetList`ã€`SnippetDetail`å’Œ`SnippetHighlight`ç±»ï¼ŒåŒæ ·åˆ é™¤å®ƒä»¬å¹¶ä¿®æ”¹æˆä¸€ä¸ªç±»ï¼š

    from rest_framework.decorators import detail_routeplainplainplainplainplain
    
    class SnippetViewSet(viewsets.ModelViewSet):
        """
        This viewset automatically provides `list`, `create`, `retrieve`,
        `update` and `destroy` actions.
    
        Additionally we also provide an extra `highlight` action.
        """
        queryset = Snippet.objects.all()
        serializer_class = SnippetSerializer
        permission_classes = (permissions.IsAuthenticatedOrReadOnly,
                              IsOwnerOrReadOnly,)
    
        @detail_route(renderer_classes=[renderers.StaticHTMLRenderer])
        def highlight(self, request, *args, **kwargs):
            snippet = self.get_object()
            return Response(snippet.highlighted)
    
        def perform_create(self, serializer):
            serializer.save(owner=self.request.user)
    

è¿™æ¬¡æˆ‘ä»¬ä½¿ç”¨`ModelViewSet`æ¥è·å–å®Œæ•´çš„è¯»å’Œå†™æ“ä½œã€‚æ³¨æ„æˆ‘ä»¬ä½¿ç”¨`@detail_route`è£…é¥°å™¨æ¥åˆ›å»ºè‡ªå®šä¹‰åŠ¨ä½œï¼Œè¿™ä¸ªè£…é¥°å™¨å¯ä»¥ç”¨äºä»»ä½•ä¸ç¬¦åˆæ ‡å‡†`create/update/delete`çš„åŠ¨ä½œã€‚

ä½¿ç”¨`@detail_route`è£…é¥°çš„ç”¨æˆ·è‡ªå®šä¹‰åŠ¨ä½œé»˜è®¤ç›¸åº” GET è¯·æ±‚ï¼Œå¦‚æœéœ€è¦å“åº” POST æ“ä½œéœ€è¦æŒ‡å®š`methods`å‚æ•°ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼Œè‡ªå®šä¹‰åŠ¨ä½œå¯¹åº”çš„ URL å–å†³äºå®ƒä»¬çš„å‡½æ•°åï¼Œä¹Ÿå¯ä»¥é€šè¿‡ç»™è£…é¥°å™¨ä¼ é€’`url_path`å‚æ•°æ¥è¿›è¡Œä¿®æ”¹ã€‚

æ˜¾å¼ç»‘å®š URL å’Œ ViewSets
----------------

ä»…ä»…åœ¨æˆ‘ä»¬å®šä¹‰ URL é…ç½®æ—¶ HTTP æ–¹æ³•æ‰ä¼šå’Œæˆ‘ä»¬å®šä¹‰çš„è¡Œä¸ºè¿›è¡Œç»‘å®šã€‚ä¸ºäº†ç†è§£ç»†èŠ‚ï¼Œæˆ‘ä»¬å…ˆæ˜¾å¼çš„åœ¨`urls.py`ä¸­è¿›è¡Œæ“ä½œï¼š

    from snippets.views import SnippetViewSet, UserViewSet, api_rootplainplainplain
    from rest_framework import renderers
    
    snippet_list = SnippetViewSet.as_view({
        'get': 'list',
        'post': 'create'
    })
    snippet_detail = SnippetViewSet.as_view({
        'get': 'retrieve',
        'put': 'update',
        'patch': 'partial_update',
        'delete': 'destroy'
    })
    snippet_highlight = SnippetViewSet.as_view({
        'get': 'highlight'
    }, renderer_classes=[renderers.StaticHTMLRenderer])
    user_list = UserViewSet.as_view({
        'get': 'list'
    })
    user_detail = UserViewSet.as_view({
        'get': 'retrieve'
    })
    

æ³¨æ„æˆ‘ä»¬ä¸ºæ¯ä¸ª`ViewSet`éƒ½åˆ›å»ºäº†å¤šä¸ª Viewï¼Œå¹¶ä¸”ä¸ºæ¯ä¸ª View çš„è¡Œä¸ºå’Œ HTTP æ–¹æ³•è¿›è¡Œäº†ç»‘å®šã€‚

ç»‘å®šåï¼Œæˆ‘ä»¬å¯ä»¥åƒå¹³å¸¸é‚£æ ·å®šä¹‰ URLï¼š

    urlpatterns = format_suffix_patterns([plainplainplainplainplainplain
        url(r'^$', api_root),
        url(r'^snippets/$', snippet_list, name='snippet-list'),
        url(r'^snippets/(?P<pk>[0-9]+)/$', snippet_detail, name='snippet-detail'),
        url(r'^snippets/(?P<pk>[0-9]+)/highlight/$', snippet_highlight, name='snippet-highlight'),
        url(r'^users/$', user_list, name='user-list'),
        url(r'^users/(?P<pk>[0-9]+)/$', user_detail, name='user-detail')
    ])
    

ä½¿ç”¨ Routers
---------

å› ä¸ºæˆ‘ä»¬ä½¿ç”¨äº†`ViewSet`è€Œä¸æ˜¯`View`ï¼Œå®é™…ä¸Šæˆ‘ä»¬ä¸éœ€è¦è‡ªå·±å®šä¹‰ URLã€‚ä½¿ç”¨`Router`ç±»å¯ä»¥è‡ªåŠ¨çš„è¿›è¡Œä¸Šè¿°æ“ä½œï¼Œæˆ‘ä»¬éœ€è¦åšçš„ä»…ä»…æ˜¯æ­£ç¡®çš„æ³¨å†Œ View åˆ° Router ä¸­ï¼š

    from django.conf.urls import url, includeplainplainplain
    from snippets import views
    from rest_framework.routers import DefaultRouter
    
    # Create a router and register our viewsets with it.
    router = DefaultRouter()
    router.register(r'snippets', views.SnippetViewSet)
    router.register(r'users', views.UserViewSet)
    
    # The API URLs are now determined automatically by the router.
    # Additionally, we include the login URLs for the browsable API.
    urlpatterns = [
        url(r'^', include(router.urls)),
        url(r'^api-auth/', include('rest_framework.urls', namespace='rest_framework'))
    ]
    

ä½¿ç”¨ route ç”Ÿæˆäº†ç›¸åŒçš„ URL è·¯å¾„ï¼Œæˆ‘ä»¬åŒ…å«äº† 2 ä¸ªå‚æ•°â€”â€”URL å‰ç¼€ä»¥åŠ Viewset æœ¬èº«ã€‚

`DefaultRouter`ç±»è‡ªåŠ¨åˆ›å»ºäº†æ ¹ URLï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥åœ¨`views`ä¸­ç§»é™¤`api_root`äº†ã€‚

æƒè¡¡ Views å’Œ Viewsets
----------------

viewsets æ˜¯ä¸€ç§å¾ˆç”¨çš„æŠ½è±¡ï¼Œå®ƒå¸®åŠ©æˆ‘ä»¬ç¡®ä¿ URL ç¬¦åˆæƒ¯ä¾‹ï¼Œå‡å°‘ä»£ç ç¼–å†™é‡ï¼Œä½¿ä½ ä¸“æ³¨äº API äº¤äº’å’Œè®¾è®¡è€Œä¸æ˜¯ URL é…ç½®ä¸Šã€‚

ä½†è¿™å¹¶ä¸æ„å‘³è¿™æ€»æ˜¯ä¸€ç§å¥½çš„é€‰æ‹©ï¼Œå°±å¥½è±¡å‡½æ•°è§†å›¾å’Œç±»è§†å›¾ä¹‹é—´çš„æƒè¡¡ä¸€æ ·ï¼Œä½¿ç”¨ viewsets ç›¸æ¯”äºæ˜¾ç¤ºæ„å»º vewsï¼Œæœ‰äº›éšæ™¦ã€‚

æ€»ç»“
--

é€šè¿‡å°‘é‡çš„ä»£ç ï¼Œæˆ‘ä»¬æ„å»ºå‡ºä¸€ä¸ªå®Œå¤‡çš„ Web API,å®Œç¾æ”¯æŒæµè§ˆå™¨è®¿é—®ã€ç”¨æˆ·è®¤è¯ã€æƒé™ç®¡ç†ï¼Œå¹¶ä¸”æ”¯æŒå¤šç§è¿”å›æ ¼å¼ã€‚

æˆ‘ä»¬ç»å†äº†æ¯æ­¥è®¾è®¡çš„è¿‡ç¨‹ï¼Œå¹¶ä¸”çŸ¥é“äº†å¦‚æœæˆ‘ä»¬éœ€è¦è‡ªå®šä¹‰åŠŸèƒ½ï¼Œå¯ä»¥æ–¹ä¾¿çš„ä½¿ç”¨ Django åŸç”Ÿçš„ views.

ä½ å¯ä»¥åœ¨[github](https://github.com/tomchristie/rest-framework-tutorial)ä¸Šæ‰¾åˆ°æœ€ç»ˆçš„ä»£ç ï¼Œä»¥åŠ[æ¨¡æ‹Ÿç¨‹åº](http://restframework.herokuapp.com/)ã€‚

å±•æœ›
--

æ•´ä¸ªæ•™ç¨‹åˆ°è¿™å°±ç»“æŸäº†ï¼Œå¦‚æœä½ æƒ³å¾—åˆ°æ›´å¤šä¿¡æ¯ï¼Œè¿™é‡Œæœ‰å‡ ç‚¹å»ºè®®ï¼š

*   åœ¨[Github](https://github.com/tomchristie/django-rest-framework)æé—®å¹¶ä¸”æäº¤ pull requestsã€‚
*   åŠ å…¥[REST framework discussion ç»„](https://groups.google.com/forum/?fromgroups target=)å¹¶ä¸ºç¤¾åŒºåšè´¡çŒ®ã€‚
*   åœ¨ Twitter ä¸Šè·Ÿéš[ä½œè€…](https://twitter.com/_tomchristie)å¹¶ say hiã€‚