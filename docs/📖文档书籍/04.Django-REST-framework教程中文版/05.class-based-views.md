---
title: æ•™ç¨‹ 3ï¼šç±»è§†å›¾
date: 2021-04-13 10:27:22
permalink: /drf-tutorial/class-based-views/
categories:
  - ğŸ“–æ–‡æ¡£ä¹¦ç±
  - Django-REST-framework æ•™ç¨‹ä¸­æ–‡ç‰ˆ
tags:
  - DRF
---

æˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ç±»è§†å›¾æ¥ç¼–å†™ API çš„ viewï¼Œè€Œä¸æ˜¯å‡½æ•°è§†å›¾ã€‚æ­£å¦‚æˆ‘ä»¬äº†è§£çš„ï¼Œç±»è§†å›¾æ˜¯ä¸€ç§éå¸¸ç»™åŠ›çš„æ¨¡å¼è®©æˆ‘ä»¬é‡ç”¨ä»£ç ï¼Œä¿æŒ[DRY åŸåˆ™](http://en.wikipedia.org/wiki/Don't_repeat_yourself)ã€‚

ä½¿ç”¨ç±»è§†å›¾é‡å†™ API
----------

æˆ‘ä»¬æ¥ä½¿ç”¨ç±»è§†å›¾æ¥é‡å†™`views.py`:
```python
from snippets.models import Snippet
from snippets.serializers import SnippetSerializer
from django.http import Http404
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status


class SnippetList(APIView):
    """
    List all snippets, or create a new snippet.
    """
    def get(self, request, format=None):
        snippets = Snippet.objects.all()
        serializer = SnippetSerializer(snippets, many=True)
        return Response(serializer.data)

    def post(self, request, format=None):
        serializer = SnippetSerializer(data=request.data)
        if serializer.is_valid():
            serializer.save()
            return Response(serializer.data, status=status.HTTP_201_CREATED)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
    
```
ç›®å‰çœ‹èµ·æ¥è¿˜ä¸é”™ï¼Œå’Œä¹‹å‰çš„å†™æ³•ä¸€æ ·ï¼Œä½†æ›´æ¸…æ™°çš„åˆ†ç¦»äº† HTTP çš„è¯·æ±‚æ–¹æ³•ã€‚æˆ‘ä»¬ä¹Ÿéœ€è¦ä¿®æ”¹å•ä¸€çš„å®ä¾‹è§†å›¾ï¼š
```python
class SnippetDetail(APIView):
    """
    Retrieve, update or delete a snippet instance.
    """
    def get_object(self, pk):
        try:
            return Snippet.objects.get(pk=pk)
        except Snippet.DoesNotExist:
            raise Http404

    def get(self, request, pk, format=None):
        snippet = self.get_object(pk)
        serializer = SnippetSerializer(snippet)
        return Response(serializer.data)

    def put(self, request, pk, format=None):
        snippet = self.get_object(pk)
        serializer = SnippetSerializer(snippet, data=request.data)
        if serializer.is_valid():
            serializer.save()
            return Response(serializer.data)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)

    def delete(self, request, pk, format=None):
        snippet = self.get_object(pk)
        snippet.delete()
        return Response(status=status.HTTP_204_NO_CONTENT)
```

å¥½æäº†ï¼Œè¿™ä¹Ÿå’Œå‡½æ•°è§†å›¾éå¸¸ç›¸ä¼¼ã€‚

å› ä¸ºä½¿ç”¨äº†ç±»è§†å›¾ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦æ”¹å†™`urls.py`:
```python
from django.urls import path
from rest_framework.urlpatterns import format_suffix_patterns
from snippets import views

urlpatterns = [
    path('snippets/', views.SnippetList.as_view()),
    path('snippets/<int:pk>/', views.SnippetDetail.as_view()),
]

urlpatterns = format_suffix_patterns(urlpatterns)
```

ä½¿ç”¨ Mixins
--------

ä½¿ç”¨ç±»è§†å›¾çš„ä¸€å¤§ä¼˜ç‚¹å°±æ˜¯å¯ä»¥æ–¹ä¾¿çš„é‡ç”¨ä»£ç ï¼Œç›®å‰æˆ‘ä»¬ä½¿ç”¨äº†å¾ˆå¤šç›¸ä¼¼çš„ä»£ç æ¥è¿›è¡Œå¢åˆ æ”¹æŸ¥æ“ä½œï¼Œè¿™äº›å¸¸è§çš„æ“ä½œå·²ç»è¢«å°è£…åœ¨äº† REST framework çš„ mixins ç±»ä¸­ã€‚è®©æˆ‘ä»¬ä½¿ç”¨ mixins å†æ¬¡ä¿®æ”¹`views.py`:
```python
from snippets.models import Snippet
from snippets.serializers import SnippetSerializer
from rest_framework import mixins
from rest_framework import generics

from snippets.models import Snippet
from snippets.serializers import SnippetSerializer
from rest_framework import mixins
from rest_framework import generics

class SnippetList(mixins.ListModelMixin,
                  mixins.CreateModelMixin,
                  generics.GenericAPIView):
    queryset = Snippet.objects.all()
    serializer_class = SnippetSerializer

    def get(self, request, *args, **kwargs):
        return self.list(request, *args, **kwargs)

    def post(self, request, *args, **kwargs):
        return self.create(request, *args, **kwargs)
``` 

æˆ‘ä»¬èŠ±ç‚¹æ—¶é—´æ¥çœ‹çœ‹è¿™é‡Œå‘ç”Ÿäº†ä»€ä¹ˆï¼šæˆ‘ä»¬ä½¿ç”¨`GenericAPIView`ã€`ListModelMixin`ã€`CreateModelMixin`æ”¹å†™äº†ä»£ç ï¼ŒåŸºç±»æä¾›äº†æ ¸å¿ƒåŠŸèƒ½ï¼Œè€Œ mixin ç±»åˆ™æä¾›äº†`.list()`å’Œ`.ctreae()`çš„è¡Œä¸ºï¼Œè¿™é‡Œæˆ‘ä»¬æ˜¾å¼ç»‘å®š GET æ–¹æ³•å’Œ POST æ–¹æ³•å¯¹åº”çš„åŠŸèƒ½ï¼Œä¸€åˆ‡éƒ½å¾ˆç®€å•ï¼š
```python
class SnippetDetail(mixins.RetrieveModelMixin,
                    mixins.UpdateModelMixin,
                    mixins.DestroyModelMixin,
                    generics.GenericAPIView):
    queryset = Snippet.objects.all()
    serializer_class = SnippetSerializer

    def get(self, request, *args, **kwargs):
        return self.retrieve(request, *args, **kwargs)

    def put(self, request, *args, **kwargs):
        return self.update(request, *args, **kwargs)

    def delete(self, request, *args, **kwargs):
        return self.destroy(request, *args, **kwargs)
```

ç±»ä¼¼çš„ï¼Œæˆ‘ä»¬ä½¿ç”¨`GenericAPIView`æä¾›æ ¸å¿ƒåŠŸèƒ½è€Œ mixin æä¾›`.retrieve()`ã€`.update()`å’Œ`.destroy()`è¡Œä¸ºã€‚

ä½¿ç”¨é€šç”¨ç±»è§†å›¾
-------

ä½¿ç”¨ mixin ç±»é‡å†™ views è®©æˆ‘ä»¬çš„ä»£ç æ¯”ä¹‹å‰ç®€æ´äº†å¾ˆå¤šï¼Œä½†æˆ‘ä»¬å¯ä»¥æ›´è¿›ä¸€æ­¥ã€‚REST framework æä¾›äº†é€šç”¨ç±»è§†å›¾æ¥è®©ä»£ç æ›´åŠ ç²¾ç®€ï¼š
```python
from snippets.models import Snippet
from snippets.serializers import SnippetSerializer
from rest_framework import generics


class SnippetList(generics.ListCreateAPIView):
    queryset = Snippet.objects.all()
    serializer_class = SnippetSerializer


class SnippetDetail(generics.RetrieveUpdateDestroyAPIView):
    queryset = Snippet.objects.all()
    serializer_class = SnippetSerializer
```

WOW,çœŸçš„é…·æ¯™äº†ï¼æˆ‘ä»¬èŠ‚çœçš„å¤§é‡çš„æ—¶é—´ï¼Œä»£ç ä¹Ÿæ›´åŠ å¼ºå£®ã€ç®€æ´ã€ç¬¦åˆ Django é£æ ¼ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è½¬å‘æœ¬æ•™ç¨‹çš„ç¬¬ 4 éƒ¨åˆ†ï¼Œåœ¨ç¬¬ 4 éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†çœ‹çœ‹å¦‚ä½•å¤„ç† API çš„èº«ä»½éªŒè¯å’Œæƒé™ã€‚
