---
title: å¯¹è±¡å…³ç³»æ•™ç¨‹
date: 2021-02-20 23:28:47
permalink: /sqlalchemy/orm/tutorial/
categories:
  - ğŸ“–å¥½ä¹¦
  - SqlAlchemy ä¸­æ–‡æ–‡æ¡£
  - orm
tags:
---
å¯¹è±¡å…³ç³»æ•™ç¨‹[Â¶](#object-relational-tutorial "Permalink to this headline")
=========================================================================

SQLAlchemy
ORM æä¾›äº†å°†ç”¨æˆ·å®šä¹‰çš„ Python ç±»å’Œæ•°æ®åº“è¡¨ä»¥åŠè¿™äº›ç±»ï¼ˆå¯¹è±¡ï¼‰çš„å®ä¾‹ä¸å…¶å¯¹åº”è¡¨ä¸­çš„è¡Œç›¸å…³è”çš„æ–¹æ³•ã€‚å®ƒåŒ…æ‹¬ä¸€ä¸ªé€æ˜åœ°åŒæ­¥å¯¹è±¡åŠå…¶ç›¸å…³è¡Œä¹‹é—´çŠ¶æ€çš„æ‰€æœ‰æ›´æ”¹çš„ç³»ç»Ÿï¼Œç§°ä¸º[å·¥ä½œå•å…ƒ](glossary.html#term-unit-of-work)ï¼Œä»¥åŠç”¨äºæ ¹æ®ç”¨æˆ·å®šä¹‰çš„ç±»åŠå…¶å®šä¹‰çš„è¡¨è¾¾å¼è¡¨è¾¾æ•°æ®åº“æŸ¥è¯¢çš„ç³»ç»Ÿå½¼æ­¤ä¹‹é—´çš„å…³ç³»ã€‚

ORM ä¸æ„å»º ORM çš„ SQLAlchemy è¡¨è¾¾å¼è¯­è¨€å½¢æˆé²œæ˜å¯¹æ¯”ã€‚é‰´äºåœ¨[SQLè¡¨è¾¾å¼è¯­è¨€æ•™ç¨‹](core_tutorial.html)ä¸­å¼•å…¥çš„ SQL è¡¨è¾¾å¼è¯­è¨€æä¾›äº†ç›´æ¥è¡¨ç¤ºå…³ç³»æ•°æ®åº“çš„åŸå§‹ç»“æ„çš„ç³»ç»Ÿï¼Œè€Œæ²¡æœ‰æ„è§ï¼ŒORM å‘ˆç°é«˜çº§åˆ«å’ŒæŠ½è±¡çš„ä½¿ç”¨æ¨¡å¼ï¼Œæ˜¯è¡¨è¾¾å¼è¯­è¨€çš„åº”ç”¨ä½¿ç”¨çš„ç¤ºä¾‹ã€‚

è™½ç„¶ ORM å’Œè¡¨è¾¾å¼è¯­è¨€çš„ä½¿ç”¨æ¨¡å¼ä¹‹é—´å­˜åœ¨é‡å ï¼Œä½†å®ƒä»¬çš„ç›¸ä¼¼ä¹‹å¤„å´æ¯”æœ€åˆå‡ºç°æ—¶æ›´ä¸ºè‚¤æµ…ã€‚ä»ç”¨æˆ·å®šä¹‰çš„[åŸŸæ¨¡å‹](glossary.html#term-domain-model)çš„è§’åº¦æ¥çœ‹ï¼Œæ•°æ®çš„ç»“æ„å’Œå†…å®¹æ˜¯é€æ˜æŒä¹…åŒ–çš„ï¼Œå¹¶ä»å…¶åº•å±‚å­˜å‚¨æ¨¡å‹åˆ·æ–°ã€‚å¦ä¸€ç§æ–¹æ³•ä»æ–‡å­—æ¨¡å¼å’Œ SQL è¡¨è¾¾å¼è¡¨è¾¾å¼çš„è§’åº¦æ¥çœ‹ï¼Œå®ƒä»¬è¢«æ˜¾å¼åœ°ç»„åˆæˆæ•°æ®åº“å•ç‹¬æ¶ˆè´¹çš„æ¶ˆæ¯ã€‚

å¯ä»¥ä»…ä½¿ç”¨å¯¹è±¡å…³ç³»æ˜ å°„å™¨æ¥æ„å»ºæˆåŠŸçš„åº”ç”¨ã€‚åœ¨é«˜çº§æƒ…å†µä¸‹ï¼Œä½¿ç”¨ ORM æ„å»ºçš„åº”ç”¨ç¨‹åºå¯èƒ½ä¼šåœ¨éœ€è¦ç‰¹å®šæ•°æ®åº“äº¤äº’çš„æŸäº›åŒºåŸŸä¸­ç›´æ¥å¶å°”ä½¿ç”¨è¡¨è¾¾å¼è¯­è¨€ã€‚

The following tutorial is in doctest format, meaning each `>>>` line represents something you can type at a Python command prompt, and the following text represents the expected return value.

ç‰ˆæœ¬æ£€æŸ¥[Â¶](#version-check "Permalink to this headline")
--------------------------------------------------------

å¿«é€Ÿæ£€æŸ¥ä»¥ç¡®è®¤æˆ‘ä»¬è‡³å°‘å¤„äº SQLAlchemy çš„**ç‰ˆæœ¬ 1.1**ï¼š

    >>> import sqlalchemyplain
    >>> sqlalchemy.__version__ 
    1.1.0

è¿æ¥[Â¶ T0\>](#connecting "Permalink to this headline")
------------------------------------------------------

å¯¹äºæœ¬æ•™ç¨‹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªä»…å†…å­˜çš„ SQLite æ•°æ®åº“ã€‚è¦è¿æ¥ï¼Œè¯·ä½¿ç”¨[`create_engine()`](core_engines.html#sqlalchemy.create_engine "sqlalchemy.create_engine")ï¼š

    >>> from sqlalchemy import create_engineplainplain
    >>> engine = create_engine('sqlite:///:memory:', echo=True)

`echo`æ ‡å¿—æ˜¯è®¾ç½® SQLAlchemy æ—¥å¿—è®°å½•çš„å¿«æ·æ–¹å¼ï¼Œå®ƒæ˜¯é€šè¿‡ Python çš„æ ‡å‡†`æ—¥å¿—`æ¨¡å—å®Œæˆçš„ã€‚å¯ç”¨å®ƒï¼Œæˆ‘ä»¬å°†çœ‹åˆ°ç”Ÿæˆçš„æ‰€æœ‰ SQLã€‚å¦‚æœæ‚¨æ­£åœ¨å­¦ä¹ æœ¬æ•™ç¨‹å¹¶å¸Œæœ›äº§ç”Ÿæ›´å°‘çš„è¾“å‡ºï¼Œè¯·å°†å…¶è®¾ç½®ä¸º`False`ã€‚æœ¬æ•™ç¨‹å°†æŠŠ SQL æ ¼å¼åŒ–ä¸ºä¸€ä¸ªå¼¹å‡ºçª—å£ï¼Œæ‰€ä»¥å®ƒä¸ä¼šå¦¨ç¢æˆ‘ä»¬ï¼›åªéœ€ç‚¹å‡»â€œSQLâ€é“¾æ¥å³å¯æŸ¥çœ‹æ­£åœ¨ç”Ÿæˆçš„å†…å®¹ã€‚

[`create_engine()`](core_engines.html#sqlalchemy.create_engine "sqlalchemy.create_engine")çš„è¿”å›å€¼æ˜¯[`Engine`](core_connections.html#sqlalchemy.engine.Engine "sqlalchemy.engine.Engine")çš„ä¸€ä¸ªå®ä¾‹ï¼Œå®ƒè¡¨ç¤ºæ•°æ®åº“çš„æ ¸å¿ƒæ¥å£ï¼Œé€šè¿‡å¤„ç†æ–¹è¨€æ•°æ®åº“å’Œ[DBAPI](glossary.html#term-dbapi)çš„ä½¿ç”¨ç»†èŠ‚ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒSQLite æ–¹è¨€å°†å‘ Python å†…ç½®çš„`sqlite3`æ¨¡å—è§£é‡ŠæŒ‡ä»¤ã€‚

æ‡’æƒ°è¿æ¥

ç”±[`create_engine()`](core_engines.html#sqlalchemy.create_engine "sqlalchemy.create_engine")é¦–æ¬¡è¿”å›çš„[`Engine`](core_connections.html#sqlalchemy.engine.Engine "sqlalchemy.engine.Engine")å®é™…ä¸Šå¹¶æœªå°è¯•è¿æ¥åˆ°æ•°æ®åº“ï¼›åªæœ‰åœ¨ç¬¬ä¸€æ¬¡è¢«è¦æ±‚å¯¹æ•°æ®åº“æ‰§è¡Œä»»åŠ¡æ—¶ï¼Œæ‰è¿æ¥åˆ°æ•°æ®åº“ã€‚

ç¬¬ä¸€æ¬¡è°ƒç”¨[`Engine.execute()`](core_connections.html#sqlalchemy.engine.Engine.execute "sqlalchemy.engine.Engine.execute")æˆ–[`Engine.connect()`](core_connections.html#sqlalchemy.engine.Engine.connect "sqlalchemy.engine.Engine.connect")çš„æ–¹æ³•æ—¶ï¼Œ[`Engine`](core_connections.html#sqlalchemy.engine.Engine "sqlalchemy.engine.Engine")æ‰ä¼šå»ºç«‹ä¸€ä¸ªçœŸå®çš„[DBAPI](glossary.html#term-dbapi)è¿æ¥åˆ°æ•°æ®åº“ï¼Œç„¶åç”¨äºå‘å‡º SQLã€‚ä½¿ç”¨ ORM æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸ä¸ä¼šç›´æ¥ä½¿ç”¨[`Engine`](core_connections.html#sqlalchemy.engine.Engine "sqlalchemy.engine.Engine")ï¼›ç›¸åï¼Œå®ƒåœ¨åå°è¢« ORM ä½¿ç”¨ï¼Œæˆ‘ä»¬å°†å¾ˆå¿«çœ‹åˆ°ã€‚

ä¹Ÿå¯ä»¥çœ‹çœ‹

[æ•°æ®åº“ç½‘å€](core_engines.html#database-urls) -
åŒ…æ‹¬è¿æ¥åˆ°å¤šç§æ•°æ®åº“çš„[`create_engine()`](core_engines.html#sqlalchemy.create_engine "sqlalchemy.create_engine")ç¤ºä¾‹ï¼Œå…¶ä¸­åŒ…å«æŒ‡å‘æ›´å¤šä¿¡æ¯çš„é“¾æ¥ã€‚

å£°æ˜æ˜ å°„[Â¶](#declare-a-mapping "Permalink to this headline")
------------------------------------------------------------

å½“ä½¿ç”¨ ORM æ—¶ï¼Œé…ç½®è¿‡ç¨‹é¦–å…ˆæè¿°æˆ‘ä»¬å°†è¦å¤„ç†çš„æ•°æ®åº“è¡¨ï¼Œç„¶åå®šä¹‰æˆ‘ä»¬ç”¨æ¥æ˜ å°„åˆ°é‚£äº›è¡¨çš„ç±»ã€‚åœ¨ç°ä»£ SQLAlchemy ä¸­ï¼Œè¿™ä¸¤ä¸ªä»»åŠ¡é€šå¸¸ä½¿ç”¨ç§°ä¸º[Declarative](extensions_declarative_index.html)æ–¹æ³•ä¸€èµ·æ‰§è¡Œï¼Œè¿™å…è®¸æˆ‘ä»¬åˆ›å»ºåŒ…å«æŒ‡ä»¤çš„ç±»æ¥æè¿°å®ƒä»¬å°†è¢«æ˜ å°„åˆ°çš„å®é™…æ•°æ®åº“è¡¨ã€‚

ä½¿ç”¨ Declarative æ–¹æ³•å®šä¹‰çš„æ˜ å°„ç±»ä¾æ®ä¸€ä¸ªåŸºç±»ï¼Œè¿™ä¸ªåŸºç±»æ˜¯ç»´ç³»ç±»å’Œæ•°æ®è¡¨å…³ç³»çš„ç›®å½•
- æˆ‘ä»¬è¯´è¯´çš„**Declarative base
class**ã€‚åœ¨ä¸€ä¸ªæ™®é€šçš„æ¨¡å—å…¥å£ä¸­ï¼Œåº”ç”¨é€šå¸¸åªéœ€è¦æœ‰ä¸€ä¸ª base çš„å®ä¾‹ã€‚æˆ‘ä»¬ä½¿ç”¨[`declarative_base()`](extensions_declarative_api.html#sqlalchemy.ext.declarative.declarative_base "sqlalchemy.ext.declarative.declarative_base")å‡½æ•°åˆ›å»ºåŸºç±»ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

    >>> from sqlalchemy.ext.declarative import declarative_baseplainplain

    >>> Base = declarative_base()

ç°åœ¨æˆ‘ä»¬æœ‰ä¸€ä¸ªâ€œbaseâ€ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä»»ä½•æ•°é‡çš„æ˜ å°„ç±»ã€‚æˆ‘ä»¬å°†ä»ä¸€ä¸ªåä¸º`users`çš„è¡¨å¼€å§‹ï¼Œå®ƒå°†ä¸ºä½¿ç”¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºçš„æœ€ç»ˆç”¨æˆ·å­˜å‚¨è®°å½•ã€‚ä¸€ä¸ªåä¸º`User`çš„æ–°ç±»å°†æ˜¯æˆ‘ä»¬æ˜ å°„æ­¤è¡¨çš„ç±»ã€‚åœ¨ç±»ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†æˆ‘ä»¬è¦æ˜ å°„åˆ°çš„è¡¨çš„è¯¦ç»†ä¿¡æ¯ï¼Œä¸»è¦æ˜¯è¡¨åï¼Œåˆ—çš„åç§°å’Œæ•°æ®ç±»å‹ï¼š

    >>> from sqlalchemy import Column, Integer, Stringplain
    >>> class User(Base):
    ...     __tablename__ = 'users'
    ...
    ...     id = Column(Integer, primary_key=True)
    ...     name = Column(String)
    ...     fullname = Column(String)
    ...     password = Column(String)
    ...
    ...     def __repr__(self):
    ...        return "<User(name='%s', fullname='%s', password='%s')>" % (
    ...                             self.name, self.fullname, self.password)

å°è´¹

`User`ç±»å®šä¹‰äº†ä¸€ä¸ª`__ repr __()`æ–¹æ³•ï¼Œä½†æ³¨æ„æ˜¯**å¯é€‰**ï¼›æˆ‘ä»¬åªåœ¨æœ¬æ•™ç¨‹ä¸­å®ç°å®ƒï¼Œä»¥ä¾¿æˆ‘ä»¬çš„ç¤ºä¾‹æ˜¾ç¤ºæ ¼å¼å¾ˆå¥½çš„`ç”¨æˆ·`å¯¹è±¡ã€‚

ä½¿ç”¨ Declarative çš„ç±»è‡³å°‘éœ€è¦ä¸€ä¸ª`__ tablename __`å±æ€§å’Œè‡³å°‘ä¸€ä¸ª[`Column`](core_metadata.html#sqlalchemy.schema.Column "sqlalchemy.schema.Column")ï¼Œå®ƒæ˜¯ä¸»é”®[[1]](#id2)çš„ä¸€éƒ¨åˆ†ã€‚SQLAlchemy ä»ä¸å¯¹ç±»å¼•ç”¨çš„è¡¨æœ¬èº«åšä»»ä½•å‡è®¾ï¼ŒåŒ…æ‹¬å®ƒæ²¡æœ‰å†…ç½®çš„åç§°ï¼Œæ•°æ®ç±»å‹æˆ–çº¦æŸçš„çº¦å®šã€‚ä½†è¿™å¹¶ä¸æ„å‘³ç€éœ€è¦æ ·æ¿ï¼›è€Œæ˜¯é¼“åŠ±ä½¿ç”¨è¾…åŠ©å‡½æ•°å’Œ mixin ç±»åˆ›å»ºè‡ªå·±çš„è‡ªåŠ¨çº¦å®šï¼Œè¿™åœ¨[Mixin å’Œ Custom
Base
Classes](extensions_declarative_mixins.html#declarative-mixins)ä¸­æœ‰è¯¦ç»†æè¿°ã€‚

æ„é€ ç±»æ—¶ï¼ŒDeclarativeä¼šä½¿ç”¨ç§°ä¸º[æè¿°ç¬¦](glossary.html#term-descriptors)çš„ç‰¹æ®Š Python è®¿é—®å™¨æ›¿æ¢æ‰€æœ‰[`Column`](core_metadata.html#sqlalchemy.schema.Column "sqlalchemy.schema.Column")å¯¹è±¡ï¼›è¿™æ˜¯ä¸€ä¸ªç§°ä¸º[instrumentation](glossary.html#term-instrumentation)çš„è¿‡ç¨‹ã€‚â€œinstrumentedâ€æ˜ å°„ç±»å°†ä¸ºæˆ‘ä»¬æä¾›åœ¨ SQL ä¸Šä¸‹æ–‡ä¸­å¼•ç”¨æˆ‘ä»¬çš„è¡¨çš„æ–¹æ³•ï¼Œä»¥åŠä»æ•°æ®åº“ä¸­æŒä¹…åŒ–å’ŒåŠ è½½åˆ—çš„å€¼ã€‚

é™¤äº†æ˜ å°„è¿‡ç¨‹å¯¹æˆ‘ä»¬çš„ç±»åšçš„å¤–ï¼Œç±»å¦å¤–ä¸»è¦æ˜¯ä¸€ä¸ªæ™®é€šçš„ Python ç±»ï¼Œæˆ‘ä»¬å¯ä»¥å®šä¹‰ä»»ä½•æ•°é‡çš„æ™®é€šå±æ€§å’Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæ‰€éœ€çš„æ–¹æ³•ã€‚

  ------------------ --------------------------------------------------------------------------------------------------------------
  [[1] T0\>](#id1)   æœ‰å…³ä¸ºä»€ä¹ˆéœ€è¦ä¸»é”®çš„ä¿¡æ¯ï¼Œè¯·å‚é˜…[å¦‚ä½•æ˜ å°„æ²¡æœ‰ä¸»é”®çš„è¡¨ï¼Ÿ](faq_ormconfiguration.html#faq-mapper-primary-key)ã€‚
  ------------------ --------------------------------------------------------------------------------------------------------------

æ„é€ æ¨¡å¼[Â¶](#create-a-schema "Permalink to this headline")
----------------------------------------------------------

ä½¿ç”¨é€šè¿‡å£°æ˜å¼ç³»ç»Ÿæ„å»ºçš„`User`ç±»ï¼Œæˆ‘ä»¬å®šä¹‰äº†æœ‰å…³è¡¨çš„ä¿¡æ¯ï¼Œç§°ä¸ºè¡¨å…ƒæ•°æ®ã€‚SQLAlchemy ç”¨äºè¡¨ç¤ºç‰¹å®šè¡¨çš„æ­¤ä¿¡æ¯çš„å¯¹è±¡ç§°ä¸º[`è¡¨`](core_metadata.html#sqlalchemy.schema.Table "sqlalchemy.schema.Table")å¯¹è±¡ï¼Œè¿™é‡Œ Declarative å·²ç»ä¸ºæˆ‘ä»¬åšäº†ä¸€ä¸ªã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡æ£€æŸ¥`__table__`å±æ€§æ¥çœ‹åˆ°è¿™ä¸ªå¯¹è±¡ï¼š

    >>> User.__table__plainplainplain
    Table('users', MetaData(bind=None),
                Column('id', Integer(), table=<users>, primary_key=True, nullable=False),
                Column('name', String(), table=<users>),
                Column('fullname', String(), table=<users>),
                Column('password', String(), table=<users>), schema=None)

ç±»æ˜ å°„

å°½ç®¡å¼ºçƒˆå»ºè®®å£°æ˜æ€§ç³»ç»Ÿï¼Œä½†ä¸ºäº†ä½¿ç”¨ SQLAlchemy çš„ ORM å¹¶ä¸æ˜¯å¿…éœ€çš„ã€‚åœ¨ Declarative ä¹‹å¤–ï¼Œä»»ä½•æ™®é€šçš„ Python ç±»éƒ½å¯ä»¥ç›´æ¥ä½¿ç”¨[`mapper()`](mapping_api.html#sqlalchemy.orm.mapper "sqlalchemy.orm.mapper")å‡½æ•°æ˜ å°„åˆ°ä»»ä½•[`è¡¨`](core_metadata.html#sqlalchemy.schema.Table "sqlalchemy.schema.Table")ï¼›è¿™ä¸ªä¸å¤ªå¸¸è§çš„ç”¨æ³•åœ¨[Classical
Mappings](mapping_styles.html#classical-mapping)ä¸­æè¿°ã€‚

å½“æˆ‘ä»¬å£°æ˜æˆ‘ä»¬çš„ç±»æ—¶ï¼ŒDeclarative ä½¿ç”¨ Python å…ƒç±»æ¥å®Œæˆç±»å£°æ˜å®Œæˆåçš„é¢å¤–æ´»åŠ¨ï¼›åœ¨è¿™ä¸ªé˜¶æ®µï¼Œç„¶åæ ¹æ®æˆ‘ä»¬çš„è§„èŒƒåˆ›å»ºä¸€ä¸ª[`Table`](core_metadata.html#sqlalchemy.schema.Table "sqlalchemy.schema.Table")å¯¹è±¡ï¼Œå¹¶é€šè¿‡æ„é€ ä¸€ä¸ª[`Mapper`](mapping_api.html#sqlalchemy.orm.mapper.Mapper "sqlalchemy.orm.mapper.Mapper")å¯¹è±¡å°†å…¶ä¸ç±»å…³è”ã€‚è¿™ä¸ªå¯¹è±¡æ˜¯æˆ‘ä»¬é€šå¸¸ä¸éœ€è¦ç›´æ¥å¤„ç†çš„å¹•åå¯¹è±¡ï¼ˆè™½ç„¶å®ƒå¯ä»¥åœ¨æˆ‘ä»¬éœ€è¦æ—¶æä¾›å…³äºæˆ‘ä»¬æ˜ å°„çš„å¤§é‡ä¿¡æ¯ï¼‰ã€‚

[`Table`](core_metadata.html#sqlalchemy.schema.Table "sqlalchemy.schema.Table")å¯¹è±¡æ˜¯ä¸€ä¸ªæ›´å¤§é›†åˆçš„æˆå‘˜ï¼Œåä¸º[`MetaData`](core_metadata.html#sqlalchemy.schema.MetaData "sqlalchemy.schema.MetaData")ã€‚å½“ä½¿ç”¨ Declarative æ—¶ï¼Œè¿™ä¸ªå¯¹è±¡å¯ä»¥ä½¿ç”¨æˆ‘ä»¬çš„å£°æ˜åŸºç±»çš„`.metadata`å±æ€§ã€‚

The [`MetaData`](core_metadata.html#sqlalchemy.schema.MetaData "sqlalchemy.schema.MetaData")
is a registry which includes the ability to emit a limited set of schema
generation commands to the database.
ç”±äºæˆ‘ä»¬çš„ SQLite æ•°æ®åº“å®é™…ä¸Šå¹¶ä¸å­˜åœ¨`users`è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨[`MetaData`](core_metadata.html#sqlalchemy.schema.MetaData "sqlalchemy.schema.MetaData")å‘æ‰€æœ‰å°šæœªå­˜åœ¨çš„è¡¨å‘å‡º CREATE
TABLE è¯­å¥åˆ°æ•°æ®åº“ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬è°ƒç”¨[`MetaData.create_all()`](core_metadata.html#sqlalchemy.schema.MetaData.create_all "sqlalchemy.schema.MetaData.create_all")æ–¹æ³•ï¼Œä¼ å…¥æˆ‘ä»¬çš„[`Engine`](core_connections.html#sqlalchemy.engine.Engine "sqlalchemy.engine.Engine")ä½œä¸ºæ•°æ®åº“è¿æ¥çš„æ¥æºã€‚æˆ‘ä»¬å°†çœ‹åˆ°é¦–å…ˆå‘å‡ºç‰¹æ®Šå‘½ä»¤æ¥æ£€æŸ¥`users`è¡¨çš„å­˜åœ¨ï¼Œç„¶åæ˜¯å®é™…çš„`CREATE TABLE`å£°æ˜ï¼š

    >>> Base.metadata.create_all(engine)plainplain
    SELECT ...
    PRAGMA table_info("users")
    ()
    CREATE TABLE users (
        id INTEGER NOT NULL, name VARCHAR,
        fullname VARCHAR,
        password VARCHAR,
        PRIMARY KEY (id)
    )
    ()
    COMMIT

æœ€å°è¡¨æ ¼æè¿°ä¸å®Œæ•´æè¿°

ç†Ÿæ‚‰ CREATE
TABLE è¯­æ³•çš„ç”¨æˆ·å¯èƒ½æ³¨æ„åˆ° VARCHAR åˆ—çš„ç”Ÿæˆæ²¡æœ‰é•¿åº¦ï¼›åœ¨ SQLite å’Œ Postgresql ä¸Šï¼Œè¿™æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æ•°æ®ç±»å‹ï¼Œä½†æ˜¯åœ¨å…¶ä»–æƒ…å†µä¸‹ï¼Œå®ƒæ˜¯ä¸å…è®¸çš„ã€‚å› æ­¤ï¼Œå¦‚æœåœ¨å…¶ä¸­ä¸€ä¸ªæ•°æ®åº“ä¸Šè¿è¡Œæœ¬æ•™ç¨‹ï¼Œå¹¶ä¸”å¸Œæœ›ä½¿ç”¨ SQLAlchemy å‘å‡º CREATE
TABLEï¼Œåˆ™å¯ä»¥ä¸º[`String`](core_type_basics.html#sqlalchemy.types.String "sqlalchemy.types.String")ç±»å‹æä¾›â€œlengthâ€ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

    Column(String(50))plainplain

[`String`](core_type_basics.html#sqlalchemy.types.String "sqlalchemy.types.String")ä¸Šçš„é•¿åº¦å­—æ®µä»¥åŠ[`Integer`](core_type_basics.html#sqlalchemy.types.Integer "sqlalchemy.types.Integer")ï¼Œ[`Numeric`](core_type_basics.html#sqlalchemy.types.Numeric "sqlalchemy.types.Numeric")ç­‰å¯ç”¨çš„ç±»ä¼¼ç²¾åº¦/ç¼©æ”¾å­—æ®µã€‚é™¤äº†åˆ›å»ºè¡¨æ ¼æ—¶ï¼Œä¸ä¼šè¢« SQLAlchemy å¼•ç”¨ã€‚

æ­¤å¤–ï¼ŒFirebird å’Œ Oracle éœ€è¦åºåˆ—æ¥ç”Ÿæˆæ–°çš„ä¸»é”®æ ‡è¯†ç¬¦ï¼Œå¹¶ä¸” SQLAlchemy ä¸ä¼šåœ¨æœªç»æŒ‡ç¤ºçš„æƒ…å†µä¸‹ç”Ÿæˆæˆ–é‡‡ç”¨è¿™äº›æ ‡è¯†ç¬¦ã€‚ä¸ºæ­¤ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨[`Sequence`](core_defaults.html#sqlalchemy.schema.Sequence "sqlalchemy.schema.Sequence")ç»“æ„ï¼š

    from sqlalchemy import Sequenceplainplain
    Column(Integer, Sequence('user_id_seq'), primary_key=True)

å› æ­¤ï¼Œé€šè¿‡æˆ‘ä»¬çš„å£°æ˜æ€§æ˜ å°„ç”Ÿæˆçš„å®Œæ•´ï¼Œä¸‡æ— ä¸€å¤±çš„[`Table`](core_metadata.html#sqlalchemy.schema.Table "sqlalchemy.schema.Table")æ˜¯ï¼š

    class User(Base):plainplainplain
        __tablename__ = 'users'
        id = Column(Integer, Sequence('user_id_seq'), primary_key=True)
        name = Column(String(50))
        fullname = Column(String(50))
        password = Column(String(12))

        def __repr__(self):
            return "<User(name='%s', fullname='%s', password='%s')>" % (
                                    self.name, self.fullname, self.password)

æˆ‘ä»¬å•ç‹¬åŒ…å«è¿™ä¸ªæ›´è¯¦ç»†çš„è¡¨å®šä¹‰ï¼Œä»¥çªå‡ºæ˜¾ç¤ºä¸»è¦é’ˆå¯¹ Python å†…ä½¿ç”¨çš„æœ€å°æ„é€ ä¸å°†ç”¨äºåœ¨å…·æœ‰æ›´ä¸¥æ ¼è¦æ±‚çš„ç‰¹å®šåç«¯ç»„ä¸Šå‘å‡º CREATE
TABLE è¯­å¥çš„æ„é€ ä¹‹é—´çš„å·®å¼‚ã€‚

åˆ›å»ºæ˜ å°„ç±»çš„å®ä¾‹[Â¶](#create-an-instance-of-the-mapped-class "Permalink to this headline")
-----------------------------------------------------------------------------------------

å®Œæˆæ˜ å°„åï¼Œæˆ‘ä»¬ç°åœ¨åˆ›å»ºå¹¶æ£€æŸ¥`User`å¯¹è±¡ï¼š

    >>> ed_user = User(name='ed', fullname='Ed Jones', password='edspassword')plainplainplain
    >>> ed_user.name
    'ed'
    >>> ed_user.password
    'edspassword'
    >>> str(ed_user.id)
    'None'

`__ init __()`æ–¹æ³•

æˆ‘ä»¬ä½¿ç”¨ Declarative ç³»ç»Ÿå®šä¹‰çš„`User`ç±»å·²ç»æä¾›äº†ä¸€ä¸ªæ„é€ å‡½æ•°ï¼ˆä¾‹å¦‚`__init__()`æ–¹æ³•ï¼‰ï¼Œå®ƒè‡ªåŠ¨æ¥å—åŒ¹é…æˆ‘ä»¬åˆ—çš„å…³é”®å­—åç§°æ˜ å°„ã€‚æˆ‘ä»¬å¯ä»¥è‡ªç”±å®šä¹‰æˆ‘ä»¬å–œæ¬¢çš„ç±»çš„ä»»ä½•æ˜ç¡®çš„`__init__()`æ–¹æ³•ï¼Œå®ƒå°†è¦†ç›–ç”± Declarative æä¾›çš„é»˜è®¤æ–¹æ³•ã€‚

å°½ç®¡æˆ‘ä»¬æ²¡æœ‰åœ¨æ„é€ å‡½æ•°ä¸­æŒ‡å®šå®ƒï¼Œä½†å½“æˆ‘ä»¬è®¿é—®å®ƒæ—¶ï¼Œ`id`å±æ€§ä»ä¼šäº§ç”Ÿä¸€ä¸ª`None`å€¼ï¼ˆä¸ Python é€šå¸¸æå‡`AttributeError`ä¸ºæœªå®šä¹‰çš„å±æ€§ï¼‰ã€‚SQLAlchemy çš„[instrumentation](glossary.html#term-instrumentation)é€šå¸¸åœ¨é¦–æ¬¡è®¿é—®æ—¶ä¸ºåˆ—æ˜ å°„å±æ€§ç”Ÿæˆæ­¤é»˜è®¤å€¼ã€‚å¯¹äºé‚£äº›æˆ‘ä»¬å®é™…èµ‹äºˆå€¼çš„å±æ€§ï¼Œå·¥å…·ç³»ç»Ÿæ­£åœ¨è·Ÿè¸ªè¿™äº›èµ‹å€¼ï¼Œä»¥ä¾¿åœ¨æœ€ç»ˆçš„ INSERT è¯­å¥ä¸­ä½¿ç”¨ï¼Œä»¥ä¾¿å‘é€åˆ°æ•°æ®åº“ã€‚

åˆ›å»ºä¼šè¯[Â¶](#creating-a-session "Permalink to this headline")
-------------------------------------------------------------

æˆ‘ä»¬ç°åœ¨å‡†å¤‡å¼€å§‹ä¸æ•°æ®åº“ä¼šè¯äº†ã€‚ORM é€šè¿‡[`Session`](session_api.html#sqlalchemy.orm.session.Session "sqlalchemy.orm.session.Session")ä¸æ•°æ®åº“å»ºç«‹è¿æ¥çš„ã€‚å½“æˆ‘ä»¬é¦–æ¬¡å¯åŠ¨åº”ç”¨ç¨‹åºæ—¶ï¼Œä¸æˆ‘ä»¬çš„[`create_engine()`](core_engines.html#sqlalchemy.create_engine "sqlalchemy.create_engine")è¯­å¥ç›¸åŒï¼Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª[`Session`](session_api.html#sqlalchemy.orm.session.Session "sqlalchemy.orm.session.Session")ç±»ï¼Œä½œä¸ºæ–°çš„[`Session`](session_api.html#sqlalchemy.orm.session.Session "sqlalchemy.orm.session.Session")å¯¹è±¡ï¼š

    >>> from sqlalchemy.orm import sessionmaker
    >>> Session = sessionmaker(bind=engine)

åœ¨æ‚¨çš„åº”ç”¨ç¨‹åºåœ¨å®šä¹‰æ¨¡å—çº§å¯¹è±¡æ—¶å°šæœªå…·æœ‰[`Engine`](core_connections.html#sqlalchemy.engine.Engine "sqlalchemy.engine.Engine")çš„æƒ…å†µä¸‹ï¼Œåªéœ€æŒ‰å¦‚ä¸‹è®¾ç½®ï¼š

    >>> Session = sessionmaker()

ç¨åï¼Œå½“æ‚¨ä½¿ç”¨[`create_engine()`](core_engines.html#sqlalchemy.create_engine "sqlalchemy.create_engine")åˆ›å»ºå¼•æ“æ—¶ï¼Œè¯·ä½¿ç”¨[`configure()`](session_api.html#sqlalchemy.orm.session.sessionmaker.configure "sqlalchemy.orm.session.sessionmaker.configure")å°†å…¶è¿æ¥åˆ°[`Session`](session_api.html#sqlalchemy.orm.session.Session "sqlalchemy.orm.session.Session")

    >>> Session.configure(bind=engine)  # once engine is availableplain

ä¼šè¯ç”Ÿå‘½å‘¨æœŸæ¨¡å¼

ä½•æ—¶åˆ¶ä½œ[`Session`](session_api.html#sqlalchemy.orm.session.Session "sqlalchemy.orm.session.Session")çš„é—®é¢˜å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºæ­£åœ¨æ„å»ºçš„åº”ç”¨ç¨‹åºç±»å‹ã€‚è¯·è®°ä½ï¼Œ[`Session`](session_api.html#sqlalchemy.orm.session.Session "sqlalchemy.orm.session.Session")åªæ˜¯å¯¹è±¡çš„å·¥ä½œç©ºé—´ï¼Œå¯¹äºç‰¹å®šçš„æ•°æ®åº“è¿æ¥æ˜¯æœ¬åœ°çš„
-
å¦‚æœæ‚¨åœ¨åº”ç”¨ç¨‹åºçº¿ç¨‹ä¸­å°†å®´ä¼šæ´¾å¯¹ä¸Šçš„åº”ç”¨ç¨‹åºçº¿ç¨‹è§†ä¸º guestï¼Œ[`Session`](session_api.html#sqlalchemy.orm.session.Session "sqlalchemy.orm.session.Session")å…³äºæ­¤ä¸»é¢˜çš„æ›´å¤šä¿¡æ¯å¯åœ¨[When
do I construct a Session, when do I commit it, and when do I close
it?](session_basics.html#session-faq-whentocreate)ã€‚

æ­¤å®šåˆ¶çš„[`Session`](session_api.html#sqlalchemy.orm.session.Session "sqlalchemy.orm.session.Session")ç±»å°†åˆ›å»ºç»‘å®šåˆ°æˆ‘ä»¬çš„æ•°æ®åº“çš„æ–°[`Session`](session_api.html#sqlalchemy.orm.session.Session "sqlalchemy.orm.session.Session")å¯¹è±¡ã€‚è°ƒç”¨[`sessionmaker`](session_api.html#sqlalchemy.orm.session.sessionmaker "sqlalchemy.orm.session.sessionmaker")æ—¶ä¹Ÿå¯ä»¥å®šä¹‰å…¶ä»–äº‹åŠ¡ç‰¹å¾ï¼›è¿™äº›åœ¨åé¢çš„ç« èŠ‚ä¸­æè¿°ã€‚ç„¶åï¼Œæ¯å½“éœ€è¦ä¸æ•°æ®åº“è¿›è¡Œå¯¹è¯æ—¶ï¼Œåªéœ€è¦å®ä¾‹åŒ–ä¸€ä¸ª[`Session`](session_api.html#sqlalchemy.orm.session.Session "sqlalchemy.orm.session.Session")ï¼š

    >>> session = Session()

ä¸Šè¿°[`Session`](session_api.html#sqlalchemy.orm.session.Session "sqlalchemy.orm.session.Session")ä¸æˆ‘ä»¬å¯ç”¨ SQLite çš„[`Engine`](core_connections.html#sqlalchemy.engine.Engine "sqlalchemy.engine.Engine")ç›¸å…³è”ï¼Œä½†å°šæœªæ‰“å¼€ä»»ä½•è¿æ¥ã€‚å½“å®ƒç¬¬ä¸€æ¬¡ä½¿ç”¨æ—¶ï¼Œå®ƒä»ç”±[`Engine`](core_connections.html#sqlalchemy.engine.Engine "sqlalchemy.engine.Engine")ç»´æŠ¤çš„è¿æ¥æ± ä¸­æ£€ç´¢è¿æ¥ï¼Œå¹¶ä¿æŒåˆ°å®ƒï¼Œç›´åˆ°æˆ‘ä»¬æäº¤æ‰€æœ‰æ›´æ”¹å’Œ/æˆ–å…³é—­ä¼šè¯å¯¹è±¡ã€‚

æ·»åŠ å’Œæ›´æ–°å¯¹è±¡[Â¶](#adding-and-updating-objects "Permalink to this headline")
----------------------------------------------------------------------------

è¦ä¿ç•™æˆ‘ä»¬çš„`User`å¯¹è±¡ï¼Œæˆ‘ä»¬[`add()`](session_api.html#sqlalchemy.orm.session.Session.add "sqlalchemy.orm.session.Session.add")åˆ°æˆ‘ä»¬çš„[`Session`](session_api.html#sqlalchemy.orm.session.Session "sqlalchemy.orm.session.Session")

    >>> ed_user = User(name='ed', fullname='Ed Jones', password='edspassword')plainplainplainplain
    >>> session.add(ed_user)

æ­¤æ—¶ï¼Œæˆ‘ä»¬è¯´è¿™ä¸ªå®ä¾‹**æ­£åœ¨ç­‰å¾…**ï¼›å°šæœªå‘å‡º SQLï¼Œå¹¶ä¸”å¯¹è±¡å°šæœªç”±æ•°æ®åº“ä¸­çš„è¡Œè¡¨ç¤ºã€‚åªè¦éœ€è¦ï¼Œ[`Session`](session_api.html#sqlalchemy.orm.session.Session "sqlalchemy.orm.session.Session")å°†å‘å¸ƒ SQL æ¥åšæŒ`Ed  tt4> ç¼æ–¯` **å†²æ´— T6\>ã€‚**å¦‚æœæˆ‘ä»¬åœ¨æ•°æ®åº“ä¸­æŸ¥è¯¢`Ed Jones`ï¼Œæ‰€æœ‰å¾…å¤„ç†çš„ä¿¡æ¯å°†é¦–å…ˆè¢«åˆ·æ–°ï¼Œç„¶åç«‹å³å‘å‡ºæŸ¥è¯¢ã€‚

ä¾‹å¦‚ï¼Œä¸‹é¢æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„[`Query`](query.html#sqlalchemy.orm.query.Query "sqlalchemy.orm.query.Query")å¯¹è±¡ï¼Œå®ƒåŠ è½½`User`çš„å®ä¾‹ã€‚æˆ‘ä»¬â€œè¿‡æ»¤â€`ed`çš„`name`å±æ€§ï¼Œå¹¶æŒ‡ç¤ºæˆ‘ä»¬åªæƒ³è·å–å®Œæ•´åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªç»“æœã€‚è¿”å›ä¸€ä¸ªä¸æˆ‘ä»¬æ·»åŠ çš„ç›¸åŒçš„`User`å®ä¾‹ï¼š

    sql>>> our_user = session.query(User).filter_by(name='ed').first() # doctest:+NORMALIZE_WHITESPACEplain
    BEGIN (implicit)
    INSERT INTO users (name, fullname, password) VALUES (?, ?, ?)
    ('ed', 'Ed Jones', 'edspassword')
    SELECT users.id AS users_id,
            users.name AS users_name,
            users.fullname AS users_fullname,
            users.password AS users_password
    FROM users
    WHERE users.name = ?
     LIMIT ? OFFSET ?
    ('ed', 1, 0)
    >>> our_user
    <User(name='ed', fullname='Ed Jones', password='edspassword')>

äº‹å®ä¸Šï¼Œ[`Session`](session_api.html#sqlalchemy.orm.session.Session "sqlalchemy.orm.session.Session")å·²ç»è¯†åˆ«å‡ºè¿”å›çš„è¡Œæ˜¯ä¸å…¶å†…éƒ¨å¯¹è±¡æ˜ å°„ä¸­å·²ç»è¡¨ç¤ºçš„**ç›¸åŒçš„**è¡Œï¼Œå› æ­¤æˆ‘ä»¬å®é™…ä¸Šå¾—åˆ°äº†ä¸æˆ‘ä»¬åˆšæ‰æ·»åŠ çš„ç›¸åŒçš„å®ä¾‹ï¼š

    >>> ed_user is our_userplain
    True

è¿™é‡Œå·¥ä½œçš„ ORM æ¦‚å¿µè¢«ç§°ä¸º[èº«ä»½æ˜ å°„](glossary.html#term-identity-map)å¹¶ä¸”ç¡®ä¿åœ¨[`Session`](session_api.html#sqlalchemy.orm.session.Session "sqlalchemy.orm.session.Session")å†…çš„ç‰¹å®šè¡Œä¸Šçš„æ‰€æœ‰æ“ä½œå¯¹ç›¸åŒçš„æ•°æ®é›†è¿›è¡Œæ“ä½œã€‚ä¸€æ—¦å…·æœ‰ç‰¹å®šä¸»é”®çš„å¯¹è±¡å‡ºç°åœ¨[`Session`](session_api.html#sqlalchemy.orm.session.Session "sqlalchemy.orm.session.Session")ä¸­ï¼Œé‚£ä¹ˆ[`ä¼šè¯`](session_api.html#sqlalchemy.orm.session.Session "sqlalchemy.orm.session.Session")ä¸Šçš„æ‰€æœ‰ SQL æŸ¥è¯¢å°†å§‹ç»ˆä¸ºè¯¥ç‰¹å®šä¸»é”®è¿”å›ç›¸åŒçš„ Python å¯¹è±¡ï¼›å¦‚æœè¯•å›¾åœ¨ä¼šè¯ä¸­æ”¾ç½®å…·æœ‰ç›¸åŒä¸»é”®çš„ç¬¬äºŒä¸ªå·²ç»æŒä¹…åŒ–çš„å¯¹è±¡ï¼Œå®ƒä¹Ÿå°†å¼•å‘é”™è¯¯ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨[`add_all()`](session_api.html#sqlalchemy.orm.session.Session.add_all "sqlalchemy.orm.session.Session.add_all")ä¸€æ¬¡æ·»åŠ æ›´å¤š`User`å¯¹è±¡ï¼š

    >>> session.add_all([plain
    ...     User(name='wendy', fullname='Wendy Williams', password='foobar'),
    ...     User(name='mary', fullname='Mary Contrary', password='xxg527'),
    ...     User(name='fred', fullname='Fred Flinstone', password='blah')])

æ­¤å¤–ï¼Œæˆ‘ä»¬è®¤ä¸º Ed çš„å¯†ç ä¸æ˜¯å¤ªå®‰å…¨ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬æ”¹å˜å®ƒï¼š

    >>> ed_user.password = 'f8s7ccs'plainplain

[`Session`](session_api.html#sqlalchemy.orm.session.Session "sqlalchemy.orm.session.Session")æ­£åœ¨å…³æ³¨ã€‚ä¾‹å¦‚ï¼Œå®ƒçŸ¥é“`Ed Jones`å·²è¢«ä¿®æ”¹ï¼š

    >>> session.dirtyplain
    IdentitySet([<User(name='ed', fullname='Ed Jones', password='f8s7ccs')>])

å¹¶ä¸”ä¸‰ä¸ªæ–°çš„`User`å¯¹è±¡æ­£åœ¨ç­‰å¾…ï¼š

    >>> session.new  # doctest: +SKIP
    IdentitySet([<User(name='wendy', fullname='Wendy Williams', password='foobar')>,
    <User(name='mary', fullname='Mary Contrary', password='xxg527')>,
    <User(name='fred', fullname='Fred Flinstone', password='blah')>])

æˆ‘ä»¬å‘Šè¯‰[`session`](session_api.html#sqlalchemy.orm.session.Session "sqlalchemy.orm.session.Session")ï¼Œæˆ‘ä»¬è¦å‘å¸ƒå¯¹æ•°æ®åº“çš„æ‰€æœ‰å‰©ä½™æ›´æ”¹ï¼Œå¹¶æäº¤å·²ç»åœ¨è¿›è¡Œä¸­çš„äº‹åŠ¡ã€‚æˆ‘ä»¬é€šè¿‡[`commit()`](session_api.html#sqlalchemy.orm.session.Session.commit "sqlalchemy.orm.session.Session.commit")æ¥å®ç°ã€‚[`session`](session_api.html#sqlalchemy.orm.session.Session "sqlalchemy.orm.session.Session")å‘å‡ºç”¨äºâ€œedâ€ä¸Šçš„å¯†ç æ›´æ”¹çš„`UPDATE`è¯­å¥ï¼Œä»¥åŠä¸‰ä¸ªæ–°çš„`User`è¯­å¥`INSERT`æˆ‘ä»¬æ·»åŠ çš„å¯¹è±¡ï¼š

    sql>>> session.commit()plainplain
    UPDATE users SET password=? WHERE users.id = ?
    ('f8s7ccs', 1)
    INSERT INTO users (name, fullname, password) VALUES (?, ?, ?)
    ('wendy', 'Wendy Williams', 'foobar')
    INSERT INTO users (name, fullname, password) VALUES (?, ?, ?)
    ('mary', 'Mary Contrary', 'xxg527')
    INSERT INTO users (name, fullname, password) VALUES (?, ?, ?)
    ('fred', 'Fred Flinstone', 'blah')
    COMMIT

[`commit()`](session_api.html#sqlalchemy.orm.session.Session.commit "sqlalchemy.orm.session.Session.commit")åˆ·æ–°æ•°æ®åº“ä¸­å‰©ä½™çš„ä»»ä½•æ›´æ”¹ï¼Œå¹¶æäº¤äº‹åŠ¡ã€‚session å¼•ç”¨çš„è¿æ¥èµ„æºç°åœ¨è¿”å›åˆ°è¿æ¥æ± ã€‚æ­¤ä¼šè¯çš„åç»­æ“ä½œå°†å‘ç”Ÿåœ¨**æ–°**äº‹åŠ¡ä¸­ï¼Œè¿™å°†åœ¨ç¬¬ä¸€æ¬¡éœ€è¦æ—¶å†æ¬¡é‡æ–°è·å–è¿æ¥èµ„æºã€‚

å¦‚æœæˆ‘ä»¬çœ‹ä¸€ä¸‹ Ed çš„`id`å±æ€§ï¼Œå®ƒæ—©å…ˆæ˜¯`None`ï¼Œå®ƒç°åœ¨æœ‰ä¸€ä¸ªå€¼ï¼š

    sql>>> ed_user.id # doctest: +NORMALIZE_WHITESPACEplain
    BEGIN (implicit)
    SELECT users.id AS users_id,
            users.name AS users_name,
            users.fullname AS users_fullname,
            users.password AS users_password
    FROM users
    WHERE users.id = ?
    (1,)
    1

åœ¨[`ä¼šè¯`](session_api.html#sqlalchemy.orm.session.Session "sqlalchemy.orm.session.Session")åœ¨æ•°æ®åº“ä¸­æ’å…¥æ–°è¡Œåï¼Œæ‰€æœ‰æ–°ç”Ÿæˆçš„æ ‡è¯†ç¬¦å’Œæ•°æ®åº“ç”Ÿæˆçš„é»˜è®¤å€¼ç«‹å³æˆ–é€šè¿‡é¦–æ¬¡åŠ è½½è®¿é—®åœ¨å®ä¾‹ä¸Šå¯ç”¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ•´ä¸ªè¡Œåœ¨è®¿é—®æ—¶é‡æ–°åŠ è½½ï¼Œå› ä¸ºåœ¨æˆ‘ä»¬å‘å‡º[`commit()`](session_api.html#sqlalchemy.orm.session.Session.commit "sqlalchemy.orm.session.Session.commit")ä¹‹åå¼€å§‹ä¸€ä¸ªæ–°äº‹åŠ¡ã€‚SQLAlchemy é»˜è®¤æƒ…å†µä¸‹åˆ·æ–°ç¬¬ä¸€æ¬¡åœ¨æ–°äº‹åŠ¡ä¸­è®¿é—®ä¹‹å‰çš„äº‹åŠ¡çš„æ•°æ®ï¼Œä»¥ä¾¿æœ€è¿‘çš„çŠ¶æ€å¯ç”¨ã€‚é‡æ–°åŠ è½½çš„çº§åˆ«æ˜¯å¯ä»¥é…ç½®çš„ï¼Œå¦‚[*ä½¿ç”¨ session*](session.html)ä¸­æ‰€è¿°ã€‚

ä¼šè¯å¯¹è±¡çŠ¶æ€

ç”±äºæˆ‘ä»¬çš„`ç”¨æˆ·`å¯¹è±¡ä»[`ä¼šè¯`](session_api.html#sqlalchemy.orm.session.Session "sqlalchemy.orm.session.Session")ä¹‹å¤–ç§»åŠ¨åˆ°æ²¡æœ‰ä¸»é”®çš„[`ä¼šè¯`](session_api.html#sqlalchemy.orm.session.Session "sqlalchemy.orm.session.Session")å†…éƒ¨ï¼Œä¸ºäº†å®é™…æ’å…¥ï¼Œå®ƒåœ¨ä¸‰**æš‚åœ**ï¼Œ**ç­‰å¾…**å’Œ**æŒä¹…æ€§**ä¸­çš„å››ä¸ªå¯ç”¨çš„â€œå¯¹è±¡çŠ¶æ€â€ã€‚æ„è¯†åˆ°è¿™äº›çŠ¶æ€ï¼Œå®ƒä»¬çš„å«ä¹‰æ€»æ˜¯ä¸€ä¸ªå¥½ä¸»æ„
-
è¯·åŠ¡å¿…é˜…è¯»[Quickie ç®€ä»‹åˆ°å¯¹è±¡çŠ¶æ€](session_state_management.html#session-object-states)ä»¥ä¾¿å¿«é€Ÿäº†è§£ã€‚

å›æ»š[Â¶](#rolling-back "Permalink to this headline")
---------------------------------------------------

ç”±äº[`Session`](session_api.html#sqlalchemy.orm.session.Session "sqlalchemy.orm.session.Session")åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­å·¥ä½œï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å›æ»šæ›´æ”¹ã€‚è®©æˆ‘ä»¬åšå°†è¢«è¿˜åŸçš„ä¸¤ä¸ªæ›´æ”¹ï¼›
`ed_user`çš„ç”¨æˆ·åè®¾ç½®ä¸º`Edwardo`ï¼š

    >>> ed_user.name = 'Edwardo'

æˆ‘ä»¬æ·»åŠ å¦ä¸€ä¸ªé”™è¯¯çš„ç”¨æˆ·`fake_user`ï¼š

    >>> fake_user = User(name='fakeuser', fullname='Invalid', password='12345')plainplainplain
    >>> session.add(fake_user)

æŸ¥è¯¢ä¼šè¯ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®ƒä»¬è¢«åˆ·å…¥å½“å‰äº‹åŠ¡ï¼š

    sql>>> session.query(User).filter(User.name.in_(['Edwardo', 'fakeuser'])).all()plain
    UPDATE users SET name=? WHERE users.id = ?
    ('Edwardo', 1)
    INSERT INTO users (name, fullname, password) VALUES (?, ?, ?)
    ('fakeuser', 'Invalid', '12345')
    SELECT users.id AS users_id,
            users.name AS users_name,
            users.fullname AS users_fullname,
            users.password AS users_password
    FROM users
    WHERE users.name IN (?, ?)
    ('Edwardo', 'fakeuser')
    [<User(name='Edwardo', fullname='Ed Jones', password='f8s7ccs')>, <User(name='fakeuser', fullname='Invalid', password='12345')>]

å›æ»šï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°`ed_user`çš„åç§°å·²å›åˆ°`ed`ï¼Œè€Œä¸”`fake_user`å·²è¢«è¸¢å‡ºä¼šè¯ï¼š

    sql>>> session.rollback()plain
    ROLLBACK

    sql>>> ed_user.name
    BEGIN (implicit)
    SELECT users.id AS users_id,
            users.name AS users_name,
            users.fullname AS users_fullname,
            users.password AS users_password
    FROM users
    WHERE users.id = ?
    (1,)
    u'ed'
    >>> fake_user in session
    False

å‘å‡º SELECT è¯´æ˜å¯¹æ•°æ®åº“æ‰€åšçš„æ›´æ”¹ï¼š

    sql>>> session.query(User).filter(User.name.in_(['ed', 'fakeuser'])).all()plain
    SELECT users.id AS users_id,
            users.name AS users_name,
            users.fullname AS users_fullname,
            users.password AS users_password
    FROM users
    WHERE users.name IN (?, ?)
    ('ed', 'fakeuser')
    [<User(name='ed', fullname='Ed Jones', password='f8s7ccs')>]

æŸ¥è¯¢[Â¶](#querying "Permalink to this headline")
-----------------------------------------------

ä½¿ç”¨[`Session`](session_api.html#sqlalchemy.orm.session.Session "sqlalchemy.orm.session.Session")ä¸Šçš„[`query()`](session_api.html#sqlalchemy.orm.session.Session.query "sqlalchemy.orm.session.Session.query")æ–¹æ³•åˆ›å»º[`Query`](query.html#sqlalchemy.orm.query.Query "sqlalchemy.orm.query.Query")å¯¹è±¡ã€‚æ­¤å‡½æ•°é‡‡ç”¨å¯å˜æ•°é‡çš„å‚æ•°ï¼Œå‚æ•°å¯ä»¥æ˜¯ç±»æˆ–è€…ç±»çš„æè¿°çš„é›†åˆã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬æŒ‡ç¤ºåŠ è½½`User`å®ä¾‹çš„[`æŸ¥è¯¢`](query.html#sqlalchemy.orm.query.Query "sqlalchemy.orm.query.Query")ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªè¿­ä»£è¾“å‡º`User`ç±»çš„ä¾‹å­ï¼š

    sql>>> for instance in session.query(User).order_by(User.id):plain
    ...     print(instance.name, instance.fullname)
    SELECT users.id AS users_id,
            users.name AS users_name,
            users.fullname AS users_fullname,
            users.password AS users_password
    FROM users ORDER BY users.id
    ()
    ed Ed Jones
    wendy Wendy Williams
    mary Mary Contrary
    fred Fred Flinstone

[`Query`](query.html#sqlalchemy.orm.query.Query "sqlalchemy.orm.query.Query")ä¹Ÿæ¥å— ORM æè¿°ä½œä¸ºå‚æ•°ã€‚ä»»ä½•æ—¶å€™ï¼Œå¤šä¸ªç±»å®ä½“æˆ–åŸºäºåˆ—çš„å®ä½“è¡¨è¾¾éƒ½å¯ä»¥ä½œä¸º[`query()`](session_api.html#sqlalchemy.orm.session.Session.query "sqlalchemy.orm.session.Session.query")å‡½æ•°çš„å‚æ•°ï¼Œè¿”å›ç±»å‹ä¸ºå…ƒç»„ï¼š

    sql>>> for name, fullname in session.query(User.name, User.fullname):plainplain
    ...     print(name, fullname)
    SELECT users.name AS users_name,
            users.fullname AS users_fullname
    FROM users
    ()
    ed Ed Jones
    wendy Wendy Williams
    mary Mary Contrary
    fred Fred Flinstone

[`Query`](query.html#sqlalchemy.orm.query.Query "sqlalchemy.orm.query.Query")è¿”å›çš„å…ƒç»„æ˜¯*å‘½åä¸º*tuplesï¼Œç”±[`KeyedTuple`](query.html#sqlalchemy.util.KeyedTuple "sqlalchemy.util.KeyedTuple")ç±»æä¾›ï¼Œå¯ä»¥åƒæ™®é€š Python å¯¹è±¡ä¸€æ ·å¯¹å¾…ã€‚åç§°ä¸å±æ€§çš„å±æ€§åç§°ä»¥åŠç±»çš„ç±»åç›¸åŒï¼š

    sql>>> for row in session.query(User, User.name).all():
    ...    print(row.User, row.name)
    SELECT users.id AS users_id,
            users.name AS users_name,
            users.fullname AS users_fullname,
            users.password AS users_password
    FROM users
    ()
    <User(name='ed', fullname='Ed Jones', password='f8s7ccs')> ed
    <User(name='wendy', fullname='Wendy Williams', password='foobar')> wendy
    <User(name='mary', fullname='Mary Contrary', password='xxg527')> mary
    <User(name='fred', fullname='Fred Flinstone', password='blah')> fred

æ‚¨å¯ä»¥ä½¿ç”¨[`label()`](core_sqlelement.html#sqlalchemy.sql.expression.ColumnElement.label "sqlalchemy.sql.expression.ColumnElement.label")ç»“æ„æ§åˆ¶å•ä¸ªåˆ—è¡¨è¾¾å¼çš„åç§°ï¼Œè¯¥ç»“æ„å¯ä»ä»»ä½•[`ColumnElement`](core_sqlelement.html#sqlalchemy.sql.expression.ColumnElement "sqlalchemy.sql.expression.ColumnElement")
- æ¥æºå¯¹è±¡ï¼Œä»¥åŠä»»ä½•æ˜ å°„åˆ°å®ä½“è¡¨çš„åˆ—å…ƒç´ ï¼ˆä¾‹å¦‚`User.name`ï¼‰ï¼š

    sql>>> for row in session.query(User.name.label('name_label')).all():
    ...    print(row.name_label)
    SELECT users.name AS name_label
    FROM users
    ()ed
    wendy
    mary
    fred

å‡è®¾åœ¨å¯¹[`query()`](session_api.html#sqlalchemy.orm.session.Session.query "sqlalchemy.orm.session.Session.query")çš„è°ƒç”¨ä¸­å­˜åœ¨å¤šä¸ªå®ä½“ï¼Œå¯ä»¥ä½¿ç”¨[`aliased()`](query.html#sqlalchemy.orm.aliased "sqlalchemy.orm.aliased")æ¥æ§åˆ¶å®Œæ•´å®ä½“ä¾‹å¦‚`User`ï¼š

    >>> from sqlalchemy.orm import aliased
    >>> user_alias = aliased(User, name='user_alias')

    sql>>> for row in session.query(user_alias, user_alias.name).all():
    ...    print(row.user_alias)
    SELECT user_alias.id AS user_alias_id,
            user_alias.name AS user_alias_name,
            user_alias.fullname AS user_alias_fullname,
            user_alias.password AS user_alias_password
    FROM users AS user_alias
    ()<User(name='ed', fullname='Ed Jones', password='f8s7ccs')>
    <User(name='wendy', fullname='Wendy Williams', password='foobar')>
    <User(name='mary', fullname='Mary Contrary', password='xxg527')>
    <User(name='fred', fullname='Fred Flinstone', password='blah')>

ä½¿ç”¨[`Query`](query.html#sqlalchemy.orm.query.Query "sqlalchemy.orm.query.Query")çš„åŸºæœ¬æ“ä½œåŒ…æ‹¬å‘å‡º LIMIT å’Œ OFFSETï¼Œæœ€æ–¹ä¾¿åœ°ä½¿ç”¨ Python æ•°ç»„åˆ†ç‰‡ï¼Œé€šå¸¸ä¸ ORDER
BY ç»“åˆä½¿ç”¨ï¼š

    sql>>> for u in session.query(User).order_by(User.id)[1:3]:plain
    ...    print(u)
    SELECT users.id AS users_id,
            users.name AS users_name,
            users.fullname AS users_fullname,
            users.password AS users_password
    FROM users ORDER BY users.id
    LIMIT ? OFFSET ?
    (2, 1)<User(name='wendy', fullname='Wendy Williams', password='foobar')>
    <User(name='mary', fullname='Mary Contrary', password='xxg527')>

è¿‡æ»¤ç»“æœï¼Œå¯é€šè¿‡ä½¿ç”¨[`filter_by()`](query.html#sqlalchemy.orm.query.Query.filter_by "sqlalchemy.orm.query.Query.filter_by")ï¼ˆä½¿ç”¨å…³é”®å­—å‚æ•°ï¼‰å®Œæˆï¼š

    sql>>> for name, in session.query(User.name).\plain
    ...             filter_by(fullname='Ed Jones'):
    ...    print(name)
    SELECT users.name AS users_name FROM users
    WHERE users.fullname = ?
    ('Ed Jones',)
    ed

...æˆ–[`filter()`](query.html#sqlalchemy.orm.query.Query.filter "sqlalchemy.orm.query.Query.filter")ï¼Œå®ƒä½¿ç”¨æ›´çµæ´»çš„ SQL è¡¨è¾¾å¼è¯­è¨€ç»“æ„ã€‚è¿™äº›å…è®¸æ‚¨åœ¨æ˜ å°„ç±»ä¸Šä½¿ç”¨å¸¦æœ‰ç±»çº§å±æ€§çš„å¸¸è§„ Python è¿ç®—ç¬¦ï¼š

    sql>>> for name, in session.query(User.name).\plainplain
    ...             filter(User.fullname=='Ed Jones'):
    ...    print(name)
    SELECT users.name AS users_name FROM users
    WHERE users.fullname = ?
    ('Ed Jones',)
    ed

[`Query`](query.html#sqlalchemy.orm.query.Query "sqlalchemy.orm.query.Query")å¯¹è±¡å®Œå…¨**ç”Ÿæˆ**ï¼Œè¿™æ„å‘³ç€å¤§å¤šæ•°æ–¹æ³•è°ƒç”¨è¿”å›ä¸€ä¸ªæ–°çš„[`Query`](query.html#sqlalchemy.orm.query.Query "sqlalchemy.orm.query.Query")å¯¹è±¡ï¼Œå¯ä»¥åœ¨å…¶ä¸Šæ·»åŠ æ›´å¤šçš„æ ‡å‡†ã€‚ä¾‹å¦‚ï¼Œè¦æŸ¥è¯¢åä¸ºâ€œedâ€çš„ç”¨æˆ·åä¸ºâ€œEd
Jonesâ€çš„ç”¨æˆ·ï¼Œå¯ä»¥è°ƒç”¨[`filter()`](query.html#sqlalchemy.orm.query.Query.filter "sqlalchemy.orm.query.Query.filter")ä¸¤æ¬¡ï¼Œä½¿ç”¨`AND`è¿æ¥æ ‡å‡†ï¼š

    sql>>> for user in session.query(User).\plainplain
    ...          filter(User.name=='ed').\
    ...          filter(User.fullname=='Ed Jones'):
    ...    print(user)
    SELECT users.id AS users_id,
            users.name AS users_name,
            users.fullname AS users_fullname,
            users.password AS users_password
    FROM users
    WHERE users.name = ? AND users.fullname = ?
    ('ed', 'Ed Jones')
    <User(name='ed', fullname='Ed Jones', password='f8s7ccs')>

### å¸¸ç”¨è¿‡æ»¤å™¨æ“ä½œç¬¦[Â¶](#common-filter-operators "Permalink to this headline")

ä¸‹é¢æ˜¯[`filter()`](query.html#sqlalchemy.orm.query.Query.filter "sqlalchemy.orm.query.Query.filter")ä¸­ä½¿ç”¨çš„ä¸€äº›æœ€å¸¸è§çš„è¿ç®—ç¬¦ï¼š

-   [`equals`](core_sqlelement.html#sqlalchemy.sql.operators.ColumnOperators.__eq__ "sqlalchemy.sql.operators.ColumnOperators.__eq__")

        query.filter(User.name == 'ed')plainplainplain

-   [`not equals`](core_sqlelement.html#sqlalchemy.sql.operators.ColumnOperators.__ne__ "sqlalchemy.sql.operators.ColumnOperators.__ne__")ï¼š

        query.filter(User.name != 'ed')

-   [`LIKE`](core_sqlelement.html#sqlalchemy.sql.operators.ColumnOperators.like "sqlalchemy.sql.operators.ColumnOperators.like")

        query.filter(User.name.like('%ed%'))plainplainplain

-   [`IN`](core_sqlelement.html#sqlalchemy.sql.operators.ColumnOperators.in_ "sqlalchemy.sql.operators.ColumnOperators.in_")

        query.filter(User.name.in_(['ed', 'wendy', 'jack']))plainplain

        # works with query objects too:
        query.filter(User.name.in_(
                session.query(User.name).filter(User.name.like('%ed%'))
        ))

-   [`NOT IN`](core_sqlelement.html#sqlalchemy.sql.operators.ColumnOperators.notin_ "sqlalchemy.sql.operators.ColumnOperators.notin_")ï¼š

        query.filter(~User.name.in_(['ed', 'wendy', 'jack']))

-   [`IS NULL`](core_sqlelement.html#sqlalchemy.sql.operators.ColumnOperators.is_ "sqlalchemy.sql.operators.ColumnOperators.is_")ï¼š

        query.filter(User.name == None)plain

        # alternatively, if pep8/linters are a concern
        query.filter(User.name.is_(None))

-   [`IS NOT NULL`](core_sqlelement.html#sqlalchemy.sql.operators.ColumnOperators.isnot "sqlalchemy.sql.operators.ColumnOperators.isnot")ï¼š

        query.filter(User.name != None)

        # alternatively, if pep8/linters are a concern
        query.filter(User.name.isnot(None))

-   [`AND`](core_sqlelement.html#sqlalchemy.sql.expression.and_ "sqlalchemy.sql.expression.and_")

        # use and_()plainplain
        from sqlalchemy import and_
        query.filter(and_(User.name == 'ed', User.fullname == 'Ed Jones'))

        # or send multiple expressions to .filter()
        query.filter(User.name == 'ed', User.fullname == 'Ed Jones')

        # or chain multiple filter()/filter_by() calls
        query.filter(User.name == 'ed').filter(User.fullname == 'Ed Jones')

> æ³¨æ„
>
> ç¡®ä¿ä½¿ç”¨[`and_()`](core_sqlelement.html#sqlalchemy.sql.expression.and_ "sqlalchemy.sql.expression.and_")è€Œ**ä¸æ˜¯**
> Python `and`è¿ç®—ç¬¦ï¼

-   [`OR`](core_sqlelement.html#sqlalchemy.sql.expression.or_ "sqlalchemy.sql.expression.or_")

        from sqlalchemy import or_
        query.filter(or_(User.name == 'ed', User.name == 'wendy'))

> æ³¨æ„
>
> è¯·ç¡®ä¿ä½¿ç”¨[`or_()`](core_sqlelement.html#sqlalchemy.sql.expression.or_ "sqlalchemy.sql.expression.or_")è€Œ**ä¸æ˜¯**
> Python `or`è¿ç®—ç¬¦ï¼

-   [`MATCH`](core_sqlelement.html#sqlalchemy.sql.operators.ColumnOperators.match "sqlalchemy.sql.operators.ColumnOperators.match")

        query.filter(User.name.match('wendy'))plainplainplain

> æ³¨æ„
>
> [`match()`](core_sqlelement.html#sqlalchemy.sql.operators.ColumnOperators.match "sqlalchemy.sql.operators.ColumnOperators.match")ä½¿ç”¨æ•°æ®åº“ç‰¹å®šçš„`MATCH`æˆ–`CONTAINS`å‡½æ•°ï¼›å…¶è¡Œä¸ºå°†éšåç«¯è€Œå˜åŒ–ï¼Œå¹¶ä¸”åœ¨æŸäº›åç«¯ï¼ˆå¦‚ SQLiteï¼‰ä¸Šä¸å¯ç”¨ã€‚

### è¿”å›åˆ—è¡¨å’Œæ ‡é‡[Â¶](#returning-lists-and-scalars "Permalink to this headline")

[`Query`](query.html#sqlalchemy.orm.query.Query "sqlalchemy.orm.query.Query")ä¸Šçš„å¤šä¸ªæ–¹æ³•ä¼šç«‹å³å‘å‡º SQLï¼Œå¹¶è¿”å›åŒ…å«å·²åŠ è½½æ•°æ®åº“ç»“æœçš„å€¼ã€‚è¿™é‡Œæ˜¯ä¸€ä¸ªç®€çŸ­çš„ä»‹ç»ï¼š

-   [`all()`](query.html#sqlalchemy.orm.query.Query.all "sqlalchemy.orm.query.Query.all")è¿”å›ä¸€ä¸ªåˆ—è¡¨ï¼š

        >>> query = session.query(User).filter(User.name.like('%ed')).order_by(User.id)plain
        sql>>> query.all()
        SELECT users.id AS users_id,
                users.name AS users_name,
                users.fullname AS users_fullname,
                users.password AS users_password
        FROM users
        WHERE users.name LIKE ? ORDER BY users.id
        ('%ed',)
        [<User(name='ed', fullname='Ed Jones', password='f8s7ccs')>,
              <User(name='fred', fullname='Fred Flinstone', password='blah')>]

-   [`first()`](query.html#sqlalchemy.orm.query.Query.first "sqlalchemy.orm.query.Query.first")åº”ç”¨ä¸€ä¸ªé™åˆ¶ï¼Œå¹¶å°†ç¬¬ä¸€ä¸ªç»“æœä½œä¸ºæ ‡é‡è¿”å›ï¼š

        sql>>> query.first()
        SELECT users.id AS users_id,
                users.name AS users_name,
                users.fullname AS users_fullname,
                users.password AS users_password
        FROM users
        WHERE users.name LIKE ? ORDER BY users.id
         LIMIT ? OFFSET ?
        ('%ed', 1, 0)
        <User(name='ed', fullname='Ed Jones', password='f8s7ccs')>

-   [`one()`](query.html#sqlalchemy.orm.query.Query.one "sqlalchemy.orm.query.Query.one")å®Œå…¨è·å–æ‰€æœ‰è¡Œï¼Œå¦‚æœç»“æœä¸­ä¸å­˜åœ¨ä¸€ä¸ªå¯¹è±¡æ ‡è¯†æˆ–æ˜¯æœ‰å¤åˆè¡Œï¼Œåˆ™ä¼šå¼•å‘é”™è¯¯ã€‚æ‰¾åˆ°å¤šè¡Œï¼š

        >>> user = query.one()
        Traceback (most recent call last):
        ...
        MultipleResultsFound: Multiple rows were found for one()

    æ²¡æœ‰æ‰¾åˆ°è¡Œï¼š

        >>> user = query.filter(User.id == 99).one()
        Traceback (most recent call last):
        ...
        NoResultFound: No row was found for one()

    [`one()`](query.html#sqlalchemy.orm.query.Query.one "sqlalchemy.orm.query.Query.one")æ–¹æ³•éå¸¸é€‚ç”¨äºå¸Œæœ›å¤„ç†â€œæ²¡æœ‰æ‰¾åˆ°é¡¹ç›®â€å’Œâ€œæ‰¾åˆ°å¤šä¸ªé¡¹ç›®â€çš„ç³»ç»Ÿï¼›ä¾‹å¦‚ Web æœåŠ¡è¿”å›ï¼Œå½“æ²¡æœ‰æ‰¾åˆ°ç»“æœæ—¶ï¼Œå®ƒå¯èƒ½æƒ³è¦å¼•å‘â€œ404 æœªæ‰¾åˆ°â€ï¼Œä½†æ˜¯åœ¨æ‰¾åˆ°å¤šä¸ªç»“æœæ—¶å¼•å‘åº”ç”¨ç¨‹åºé”™è¯¯ã€‚

-   [`one_or_none()`](query.html#sqlalchemy.orm.query.Query.one_or_none "sqlalchemy.orm.query.Query.one_or_none")å°±åƒ[`one()`](query.html#sqlalchemy.orm.query.Query.one "sqlalchemy.orm.query.Query.one")ï¼Œé™¤äº†å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç»“æœï¼Œå®ƒä¸ä¼šå¼•å‘é”™è¯¯ï¼›å®ƒåªè¿”å›`None`ã€‚åƒ[`one()`](query.html#sqlalchemy.orm.query.Query.one "sqlalchemy.orm.query.Query.one")ï¼Œå¦‚æœæ‰¾åˆ°å¤šä¸ªç»“æœï¼Œå®ƒä¼šå¼•å‘é”™è¯¯ã€‚

-   [`scalar()`](query.html#sqlalchemy.orm.query.Query.scalar "sqlalchemy.orm.query.Query.scalar")è°ƒç”¨[`one()`](query.html#sqlalchemy.orm.query.Query.one "sqlalchemy.orm.query.Query.one")æ–¹æ³•ï¼Œåœ¨ one()æˆåŠŸçš„åŸºç¡€ä¸Šè¿”å›è¯¥è¡Œçš„ç¬¬ä¸€åˆ—ï¼š

        >>> query = session.query(User.id).filter(User.name == 'ed').\plain
        ...    order_by(User.id)
        sql>>> query.scalar()
        SELECT users.id AS users_id
        FROM users
        WHERE users.name = ? ORDER BY users.id
        ('ed',)
        1

### ä½¿ç”¨æ–‡æœ¬ SQL [Â¶](#using-textual-sql "Permalink to this headline")

æ–‡æœ¬å­—ç¬¦ä¸²å¯ä»¥é€šè¿‡[`Query`](query.html#sqlalchemy.orm.query.Query "sqlalchemy.orm.query.Query")çµæ´»ä½¿ç”¨ï¼Œé€šè¿‡[`text()`](core_sqlelement.html#sqlalchemy.sql.expression.text "sqlalchemy.sql.expression.text")æ„é€ æŒ‡å®šå­—ç¬¦ä¸²çš„ä½¿ç”¨ï¼Œè¿™ç§æ–¹æ³•å¯ä»¥ç”¨åœ¨å¾ˆå¤šæ–¹æ³•ä¸­ã€‚ä¾‹å¦‚ï¼Œ[`filter()`](query.html#sqlalchemy.orm.query.Query.filter "sqlalchemy.orm.query.Query.filter")å’Œ[`order_by()`](query.html#sqlalchemy.orm.query.Query.order_by "sqlalchemy.orm.query.Query.order_by")ï¼š

    >>> from sqlalchemy import text
    sql>>> for user in session.query(User).\
    ...             filter(text("id<224")).\
    ...             order_by(text("id")).all():
    ...     print(user.name)
    SELECT users.id AS users_id,
            users.name AS users_name,
            users.fullname AS users_fullname,
            users.password AS users_password
    FROM users
    WHERE id<224 ORDER BY id
    ()
    ed
    wendy
    mary
    fred

ç»‘å®šå‚æ•°å¯ä»¥ä½¿ç”¨åŸºäºå­—ç¬¦ä¸²çš„ SQL æŒ‡å®šï¼Œä½¿ç”¨å†’å·ã€‚ä½¿ç”¨[`params()`](query.html#sqlalchemy.orm.query.Query.params "sqlalchemy.orm.query.Query.params")æ–¹æ³•æŒ‡å®šæ•°å€¼ï¼š

    sql>>> session.query(User).filter(text("id<:value and name=:name")).\
    ...     params(value=224, name='fred').order_by(User.id).one()
    SELECT users.id AS users_id,
            users.name AS users_name,
            users.fullname AS users_fullname,
            users.password AS users_password
    FROM users
    WHERE id<? and name=? ORDER BY users.id
    (224, 'fred')
    <User(name='fred', fullname='Fred Flinstone', password='blah')>

è¦ä½¿ç”¨ä¸€ä¸ªå®Œæ•´çš„ SQL è¯­å¥ï¼Œå¯ä»¥å°†è¡¨ç¤ºå®Œæ•´è¯­å¥çš„[`text()`](core_sqlelement.html#sqlalchemy.sql.expression.text "sqlalchemy.sql.expression.text")ç»“æ„ä¼ é€’ç»™[`from_statement()`](query.html#sqlalchemy.orm.query.Query.from_statement "sqlalchemy.orm.query.Query.from_statement")ã€‚å¦‚æœæ²¡æœ‰å…¶ä»–è¯´æ˜ç¬¦ï¼Œå­—ç¬¦ä¸² SQL ä¸­çš„åˆ—å°†æ ¹æ®åç§°ä¸æ¨¡å‹åˆ—åŒ¹é…ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œæˆ‘ä»¬åªä½¿ç”¨æ˜Ÿå·æ¥è¡¨ç¤ºåŠ è½½æ‰€æœ‰åˆ—ï¼š

    sql>>> session.query(User).from_statement(plainplain
    ...                     text("SELECT * FROM users where name=:name")).\
    ...                     params(name='ed').all()
    SELECT * FROM users where name=?
    ('ed',)
    [<User(name='ed', fullname='Ed Jones', password='f8s7ccs')>]

åç§°åŒ¹é…åˆ—é€‚ç”¨äºç®€å•æƒ…å†µï¼Œä½†åœ¨å¤„ç†åŒ…å«é‡å¤åˆ—åçš„å¤æ‚è¯­å¥æ—¶æˆ–ä½¿ç”¨ä¸æ˜“ä¸ç‰¹å®šåç§°åŒ¹é…çš„åŒ¿å ORM æ„é€ æ—¶ï¼Œå¯èƒ½ä¼šå˜å¾—ä¸æ–¹ä¾¿ã€‚å¦å¤–ï¼Œåœ¨å¤„ç†ç»“æœè¡Œæ—¶ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå‘ç°æ˜ å°„åˆ—ä¸­å­˜åœ¨æ‰“å­—è¡Œä¸ºã€‚å¯¹äºè¿™äº›æƒ…å†µï¼Œ[`text()`](core_sqlelement.html#sqlalchemy.sql.expression.text "sqlalchemy.sql.expression.text")ç»“æ„å…è®¸æˆ‘ä»¬å°†å…¶æ–‡æœ¬ SQL é“¾æ¥åˆ° Core æˆ– ORM æ˜ å°„çš„åˆ—è¡¨è¾¾å¼ï¼›æˆ‘ä»¬å¯ä»¥é€šè¿‡å°†åˆ—è¡¨è¾¾å¼ä½œä¸ºä½ç½®å‚æ•°ä¼ é€’åˆ°[`TextClause.columns()`](core_sqlelement.html#sqlalchemy.sql.expression.TextClause.columns "sqlalchemy.sql.expression.TextClause.columns")æ–¹æ³•æ¥å®ç°ï¼š

    >>> stmt = text("SELECT name, id, fullname, password "
    ...             "FROM users where name=:name")
    >>> stmt = stmt.columns(User.name, User.id, User.fullname, User.password)
    sql>>> session.query(User).from_statement(stmt).params(name='ed').all()
    SELECT name, id, fullname, password FROM users where name=?
    ('ed',)
    [<User(name='ed', fullname='Ed Jones', password='f8s7ccs')>]

ç‰ˆæœ¬ 1.1 ä¸­çš„æ–°åŠŸèƒ½ï¼š [`TextClause.columns()`](core_sqlelement.html#sqlalchemy.sql.expression.TextClause.columns "sqlalchemy.sql.expression.TextClause.columns")æ–¹æ³•ç°åœ¨æ¥å—ä¸æ˜æ–‡ SQL ç»“æœé›†ä½ç½®åŒ¹é…çš„åˆ—è¡¨è¾¾å¼ï¼ŒåŒ¹é…æˆ–ç”šè‡³åœ¨ SQL è¯­å¥ä¸­æ˜¯å”¯ä¸€çš„ã€‚

When selecting from a [`text()`](core_sqlelement.html#sqlalchemy.sql.expression.text "sqlalchemy.sql.expression.text")
construct, the [`Query`](query.html#sqlalchemy.orm.query.Query "sqlalchemy.orm.query.Query")
may still specify what columns and entities are to be returned; instead
of `query(User)` we can also ask for the columns
individually, as in any other case:

    >>> stmt = text("SELECT name, id FROM users where name=:name")
    >>> stmt = stmt.columns(User.name, User.id)
    sql>>> session.query(User.id, User.name).\
    ...          from_statement(stmt).params(name='ed').all()
    SELECT name, id FROM users where name=?
    ('ed',)
    [(1, u'ed')]

ä¹Ÿå¯ä»¥çœ‹çœ‹

[Using Textual SQL](core_tutorial.html#sqlexpression-text) -
ä»çº¯æ ¸æŸ¥è¯¢çš„è§’åº¦è§£é‡Š[`text()`](core_sqlelement.html#sqlalchemy.sql.expression.text "sqlalchemy.sql.expression.text")ç»“æ„ã€‚

### è®¡æ•°[Â¶ T0\>](#counting "Permalink to this headline")

[`Query`](query.html#sqlalchemy.orm.query.Query "sqlalchemy.orm.query.Query")åŒ…å«ä¸€ä¸ªç”¨äºè®¡æ•°çš„ç®€ä¾¿æ–¹æ³•ï¼Œç§°ä¸º[`count()`](query.html#sqlalchemy.orm.query.Query.count "sqlalchemy.orm.query.Query.count")ï¼š

    sql>>> session.query(User).filter(User.name.like('%ed')).count()plain
    SELECT count(*) AS count_1
    FROM (SELECT users.id AS users_id,
                    users.name AS users_name,
                    users.fullname AS users_fullname,
                    users.password AS users_password
    FROM users
    WHERE users.name LIKE ?) AS anon_1
    ('%ed',)
    2

ä¾é `count()`è¿›è¡Œè®¡æ•°

[`Query.count()`](query.html#sqlalchemy.orm.query.Query.count "sqlalchemy.orm.query.Query.count")
used to be a very complicated method when it would try to guess whether
or not a subquery was needed around the existing query, and in some
exotic cases it wouldnâ€™t do the right thing.
ç°åœ¨å®ƒæ¯æ¬¡éƒ½ä½¿ç”¨ä¸€ä¸ªç®€å•çš„å­æŸ¥è¯¢ï¼Œå®ƒåªæœ‰ä¸¤è¡Œï¼Œæ€»æ˜¯è¿”å›æ­£ç¡®çš„ç­”æ¡ˆã€‚å¦‚æœæŸä¸ªç‰¹å®šè¯­å¥ç»å¯¹ä¸èƒ½å®¹å¿å­æŸ¥è¯¢å­˜åœ¨ï¼Œè¯·ä½¿ç”¨`func.count()`ã€‚

ä½¿ç”¨[`count()`](query.html#sqlalchemy.orm.query.Query.count "sqlalchemy.orm.query.Query.count")æ–¹æ³•æ¥ç¡®å®š SQL è¯­å¥å°†è¿”å›å¤šå°‘è¡Œã€‚æŸ¥çœ‹ä¸Šé¢ç”Ÿæˆçš„ SQLï¼ŒSQLAlchemy æ€»æ˜¯å°†æˆ‘ä»¬æ­£åœ¨æŸ¥è¯¢çš„ä»»ä½•ä¸œè¥¿æ”¾åˆ°å­æŸ¥è¯¢ä¸­ï¼Œç„¶åå¯¹å…¶è¿›è¡Œè®¡æ•°ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œè¿™å¯ä»¥ç®€åŒ–ä¸º`SELECT countï¼ˆ*ï¼‰ FROM è¡¨  t0>ï¼Œä½†ç°ä»£ç‰ˆæœ¬çš„SQLAlchemyä¸ä¼šå°è¯•çŒœæµ‹è¿™æ˜¯å¦åˆé€‚ï¼Œå› ä¸ºå¯ä»¥ä½¿ç”¨æ›´æ˜ç¡®çš„æ–¹æ³•å‘å‡ºç¡®åˆ‡çš„SQLã€‚`

For situations where the â€œthing to be countedâ€ needs to be indicated
specifically, we can specify the â€œcountâ€ function directly using the
expression `func.count()`, available from the
[`func`](core_sqlelement.html#sqlalchemy.sql.expression.func "sqlalchemy.sql.expression.func")
construct. ä¸‹é¢æˆ‘ä»¬ç”¨å®ƒæ¥è¿”å›æ¯ä¸ªä¸åŒç”¨æˆ·åçš„è®¡æ•°ï¼š

    >>> from sqlalchemy import funcplain
    sql>>> session.query(func.count(User.name), User.name).group_by(User.name).all()
    SELECT count(users.name) AS count_1, users.name AS users_name
    FROM users GROUP BY users.name
    ()
    [(1, u'ed'), (1, u'fred'), (1, u'mary'), (1, u'wendy')]

è¦å®ç°æˆ‘ä»¬ç®€å•çš„`SELECT countï¼ˆ*ï¼‰ FROM è¡¨`å®ƒä½œä¸ºï¼š

    sql>>> session.query(func.count('*')).select_from(User).scalar()plain
    SELECT count(?) AS count_1
    FROM users
    ('*',)
    4

å¦‚æœæˆ‘ä»¬ç›´æ¥ä½¿ç”¨`User`ä¸»é”®è¡¨ç¤ºè®¡æ•°ï¼Œåˆ™å¯ä»¥åˆ é™¤[`select_from()`](query.html#sqlalchemy.orm.query.Query.select_from "sqlalchemy.orm.query.Query.select_from")çš„ç”¨æ³•ï¼š

    sql>>> session.query(func.count(User.id)).scalar()plainplain
    SELECT count(users.id) AS count_1
    FROM users
    ()
    4

å»ºç«‹å…³ç³»[Â¶](#building-a-relationship "Permalink to this headline")
------------------------------------------------------------------

æˆ‘ä»¬è€ƒè™‘å¦‚ä½•æ˜ å°„å’ŒæŸ¥è¯¢ä¸`User`ç›¸å…³çš„ç¬¬äºŒå¼ è¡¨ã€‚ç³»ç»Ÿä¸­çš„ç”¨æˆ·å¯ä»¥å­˜å‚¨ä¸å…¶ç”¨æˆ·åç›¸å…³è”çš„ä»»æ„æ•°é‡çš„ç”µå­é‚®ä»¶åœ°å€ã€‚è¿™æ„å‘³ç€`ç”¨æˆ·`åˆ°å­˜å‚¨ç”µå­é‚®ä»¶åœ°å€çš„æ–°è¡¨(`addresses`)çš„ä¸€å¯¹å¤šçš„å…³è”ã€‚ä½¿ç”¨å£°æ˜å¼ï¼Œæˆ‘ä»¬å®šä¹‰äº†è¿™ä¸ªè¡¨åŠå…¶æ˜ å°„ç±»`Address`ï¼š

    >>> from sqlalchemy import ForeignKeyplainplain
    >>> from sqlalchemy.orm import relationship

    >>> class Address(Base):
    ...     __tablename__ = 'addresses'
    ...     id = Column(Integer, primary_key=True)
    ...     email_address = Column(String, nullable=False)
    ...     user_id = Column(Integer, ForeignKey('users.id'))
    ...
    ...     user = relationship("User", back_populates="addresses")
    ...
    ...     def __repr__(self):
    ...         return "<Address(email_address='%s')>" % self.email_address

    >>> User.addresses = relationship(
    ...     "Address", order_by=Address.id, back_populates="user")

ä¸Šé¢çš„ç±»ä»‹ç»äº†[`ForeignKey`](core_constraints.html#sqlalchemy.schema.ForeignKey "sqlalchemy.schema.ForeignKey")çš„æ„é€ ï¼Œå®ƒæ˜¯ä¸€ä¸ªåº”ç”¨äº[`Column`](core_metadata.html#sqlalchemy.schema.Column "sqlalchemy.schema.Column")çš„æŒ‡ä»¤ï¼Œè¡¨ç¤ºè¯¥åˆ—ä¸­çš„å€¼åº”è¯¥æ˜¯[å—åˆ¶äº](glossary.html#term-constrained)åœ¨ User è¡¨ä¸­çš„å€¼ã€‚è¿™æ˜¯å…³ç³»æ•°æ®åº“çš„ä¸€ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼Œå¹¶ä¸”æ˜¯ä¸€ç§â€œç²˜åˆå‰‚â€ï¼Œå®ƒå¯ä»¥è½¬æ¢ä¸€ç³»åˆ—æœªè¿æ¥çš„è¡¨ï¼Œä»¥è·å¾—ä¸°å¯Œçš„é‡å å…³ç³»ã€‚ä¸Šé¢çš„[`ForeignKey`](core_constraints.html#sqlalchemy.schema.ForeignKey "sqlalchemy.schema.ForeignKey")è¡¨ç¤º`addresses.user_id`åˆ—ä¸­çš„å€¼åº”è¯¥è¢«é™åˆ¶ä¸º`users.id`åˆ—ä¸­çš„å€¼ï¼Œå³å…¶ä¸»é”®ã€‚

ç¬¬äºŒä¸ªæŒ‡ä»¤ç§°ä¸º[`relationship()`](relationship_api.html#sqlalchemy.orm.relationship "sqlalchemy.orm.relationship")ï¼Œå‘Šè¯‰ORMï¼š`Address`ç±»æœ¬èº«åº”è¯¥é“¾æ¥åˆ°`User`ç±»ï¼Œä½¿ç”¨å±æ€§`Address.user`[`relationship()`](relationship_api.html#sqlalchemy.orm.relationship "sqlalchemy.orm.relationship")ä½¿ç”¨ä¸¤ä¸ªè¡¨ä¹‹é—´çš„å¤–é”®å…³ç³»æ¥ç¡®å®šè¿™ä¸ªé“¾æ¥çš„æ€§è´¨ï¼Œç¡®å®š`Address.user`å°†[many to
one](glossary.html#term-many-to-one)åœ¨å±æ€§`User.addresses`ä¸‹çš„`User`æ˜ å°„ç±»ä¸Šæ”¾ç½®äº†ä¸€ä¸ªé¢å¤–çš„[`relationship()`](relationship_api.html#sqlalchemy.orm.relationship "sqlalchemy.orm.relationship")æŒ‡ä»¤ã€‚In
both [`relationship()`](relationship_api.html#sqlalchemy.orm.relationship "sqlalchemy.orm.relationship")
directives, the parameter [`relationship.back_populates`(relationship_api.html#sqlalchemy.orm.relationship.params.back_populates "sqlalchemy.orm.relationship")
is assigned to refer to the complementary attribute names; by doing so,
each [`relationship()`](relationship_api.html#sqlalchemy.orm.relationship "sqlalchemy.orm.relationship")
can make intelligent decision about the same relationship as expressed
in reverse; on one side, `Address.user` refers to a
`User` instance, and on the other side,
`User.addresses` refers to a list of
`Address` instances.

æ³¨æ„

[`relationship.back_populates`](relationship_api.html#sqlalchemy.orm.relationship.params.back_populates "sqlalchemy.orm.relationship")å‚æ•°æ˜¯ç§°ä¸º[`relationship.backref`](relationship_api.html#sqlalchemy.orm.relationship.params.backref "sqlalchemy.orm.relationship")çš„éå¸¸å¸¸è§çš„ SQLAlchemy åŠŸèƒ½çš„æ›´æ–°ç‰ˆæœ¬ã€‚[`relationship.backref`](relationship_api.html#sqlalchemy.orm.relationship.params.backref "sqlalchemy.orm.relationship")å‚æ•°æ²¡æœ‰æ¶ˆå¤±ï¼Œå¹¶ä¸”å§‹ç»ˆä¿æŒå¯ç”¨ï¼[`relationship.back_populates`](relationship_api.html#sqlalchemy.orm.relationship.params.back_populates "sqlalchemy.orm.relationship")æ˜¯åŒæ ·çš„äº‹æƒ…ï¼Œé™¤äº†ç¨å¾®å†—é•¿ä¸€äº›å¹¶ä¸”æ›´å®¹æ˜“æ“ä½œã€‚æœ‰å…³æ•´ä¸ªä¸»é¢˜çš„æ¦‚è¿°ï¼Œè¯·å‚é˜…[Linking
Relationships with Backref](backref.html#relationships-backref)éƒ¨åˆ†ã€‚

å¤šå¯¹ä¸€å…³ç³»çš„åé¢æ€»æ˜¯[one to
many](glossary.html#term-one-to-many)ã€‚[`relationship()`](relationship_api.html#sqlalchemy.orm.relationship "sqlalchemy.orm.relationship")é…ç½®çš„å®Œæ•´ç›®å½•ä½äº[Basic
Relationship Patterns](basic_relationships.html#relationship-patterns)ã€‚

ä¸¤ä¸ªäº’è¡¥å…³ç³»`Address.user`å’Œ`User.addresses`è¢«ç§°ä¸º[bidirectional
relationship](glossary.html#term-bidirectional-relationship)ï¼Œå¹¶ä¸”æ˜¯ SQLAlchemy
ORM çš„ä¸€ä¸ªå…³é”®ç‰¹æ€§ã€‚[Linking Relationships with
Backref](backref.html#relationships-backref)éƒ¨åˆ†è¯¦ç»†è®¨è®ºäº†â€œbackrefâ€åŠŸèƒ½ã€‚

å‡è®¾ Declarative ç³»ç»Ÿæ­£åœ¨ä½¿ç”¨ï¼Œå¯ä»¥ä½¿ç”¨å­—ç¬¦ä¸²æŒ‡å®šæ¶‰åŠè¿œç¨‹ç±»çš„[`relationship()`](relationship_api.html#sqlalchemy.orm.relationship "sqlalchemy.orm.relationship")çš„å‚æ•°ã€‚ä¸€æ—¦æ‰€æœ‰æ˜ å°„å®Œæˆåï¼Œè¿™äº›å­—ç¬¦ä¸²å°†è¢«è¯„ä¼°ä¸ºPythonè¡¨è¾¾å¼ï¼Œä»¥ä¾¿äº§ç”Ÿå®é™…çš„å‚æ•°ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­æ˜¯`User`ç±»ã€‚åœ¨è¯„ä¼°è¿‡ç¨‹ä¸­å…è®¸çš„åç§°é™¤å…¶ä»–å¤–åŒ…æ‹¬æ‰€æœ‰å·²æ ¹æ®å£°æ˜çš„åŸºç¡€åˆ›å»ºçš„ç±»çš„åç§°ã€‚

æœ‰å…³å‚æ•°æ ·å¼çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…[`relationship()`](relationship_api.html#sqlalchemy.orm.relationship "sqlalchemy.orm.relationship")çš„æ–‡æ¡£å­—ç¬¦ä¸²ã€‚

ä½ çŸ¥é“å— ï¼Ÿ

-   å¤§å¤šæ•°ï¼ˆå°½ç®¡ä¸æ˜¯å…¨éƒ¨ï¼‰å…³ç³»æ•°æ®åº“ä¸­çš„ FOREIGN
    KEY çº¦æŸåªèƒ½é“¾æ¥åˆ°ä¸»é”®åˆ—æˆ–å…·æœ‰ UNIQUE çº¦æŸçš„åˆ—ã€‚
-   å¼•ç”¨å¤šåˆ—ä¸»é”®å¹¶ä¸”è‡ªèº«å…·æœ‰å¤šåˆ—çš„ FOREIGN
    KEY çº¦æŸè¢«ç§°ä¸ºâ€œç»„åˆå¤–é”®â€ã€‚å®ƒä¹Ÿå¯ä»¥å¼•ç”¨è¿™äº›åˆ—çš„ä¸€ä¸ªå­é›†ã€‚
-   FOREIGN
    KEY åˆ—å¯ä»¥è‡ªåŠ¨æ›´æ–°è‡ªå·±ï¼Œä»¥å“åº”å¼•ç”¨çš„åˆ—æˆ–è¡Œçš„æ›´æ”¹ã€‚è¿™è¢«ç§°ä¸º CASCADE
    *å¼•ç”¨æ“ä½œ*ï¼Œå¹¶ä¸”æ˜¯å…³ç³»æ•°æ®åº“çš„å†…ç½®å‡½æ•°ã€‚
-   FOREIGN KEYå¯ä»¥å¼•ç”¨å®ƒè‡ªå·±çš„è¡¨ã€‚è¿™è¢«ç§°ä¸ºâ€œè‡ªæˆ‘å‚ç…§â€å¤–é”®ã€‚
-   åœ¨[å¤–é”® -
    ç»´åŸºç™¾ç§‘](http://en.wikipedia.org/wiki/Foreign_key)ä¸­é˜…è¯»æœ‰å…³å¤–é”®çš„æ›´å¤šä¿¡æ¯ã€‚

æˆ‘ä»¬éœ€è¦åœ¨æ•°æ®åº“ä¸­åˆ›å»º`addresses`è¡¨ï¼Œå› æ­¤æˆ‘ä»¬å°†ä»æˆ‘ä»¬çš„å…ƒæ•°æ®ä¸­å‘å‡ºå¦ä¸€ä¸ª CREATEï¼Œè¿™å°†è·³è¿‡å·²ç»åˆ›å»ºçš„è¡¨ï¼š

    sql>>> Base.metadata.create_all(engine)plain
    PRAGMA...
    CREATE TABLE addresses (
        id INTEGER NOT NULL,
        email_address VARCHAR NOT NULL,
        user_id INTEGER,
        PRIMARY KEY (id),
         FOREIGN KEY(user_id) REFERENCES users (id)
    )
    ()
    COMMIT

ä½¿ç”¨ç›¸å…³å¯¹è±¡[Â¶](#working-with-related-objects "Permalink to this headline")
---------------------------------------------------------------------------

ç°åœ¨å½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª`User`æ—¶ï¼Œä¸€ä¸ªç©ºç™½çš„`addresses`é›†åˆå°†å‡ºç°ã€‚å„ç§é›†åˆç±»å‹ï¼ˆä¾‹å¦‚é›†åˆå’Œå­—å…¸ï¼‰éƒ½å¯ä»¥åœ¨æ­¤å¤„è·å¾—ï¼ˆè¯¦ç»†ä¿¡æ¯è¯·å‚é˜…[Customizing
Collection
Access](collections.html#custom-collections)ï¼‰ï¼Œä½†é»˜è®¤æƒ…å†µä¸‹ï¼Œé›†åˆæ˜¯Pythonåˆ—è¡¨ã€‚

    >>> jack = User(name='jack', fullname='Jack Bean', password='gjffdd')plain
    >>> jack.addresses
    []

æˆ‘ä»¬å¯ä»¥åœ¨`User`å¯¹è±¡ä¸Šè‡ªç”±æ·»åŠ `Address`å¯¹è±¡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç›´æ¥æŒ‡å®šä¸€ä¸ªå®Œæ•´åˆ—è¡¨ï¼š

    >>> jack.addresses = [
    ...                 Address(email_address='jack@google.com'),
    ...                 Address(email_address='j25@yahoo.com')]

å½“ä½¿ç”¨åŒå‘å…³ç³»æ—¶ï¼Œåœ¨ä¸€ä¸ªæ–¹å‘ä¸Šæ·»åŠ çš„å…ƒç´ ä¼šè‡ªåŠ¨åœ¨å¦ä¸€ä¸ªæ–¹å‘ä¸Šå¯è§ã€‚æ­¤è¡Œä¸ºåŸºäºå±æ€§ on-change äº‹ä»¶è€Œå‘ç”Ÿï¼Œå¹¶ä¸”åœ¨ Python ä¸­è¿›è¡Œè¯„ä¼°ï¼Œè€Œä¸ä½¿ç”¨ä»»ä½• SQLï¼š

    >>> jack.addresses[1]plain
    <Address(email_address='j25@yahoo.com')>

    >>> jack.addresses[1].user
    <User(name='jack', fullname='Jack Bean', password='gjffdd')>

è®©æˆ‘ä»¬å‘æ•°æ®åº“æ·»åŠ å¹¶æäº¤`Jack Bean`ã€‚`jack`ä»¥åŠç›¸åº”`addresses`é›†åˆä¸­çš„ä¸¤ä¸ª`Address`æˆå‘˜éƒ½ä¼šä½¿ç”¨åä¸º**çº§è”
T6\>ï¼š**

    >>> session.add(jack)plainplain
    sql>>> session.commit()
    INSERT INTO users (name, fullname, password) VALUES (?, ?, ?)
    ('jack', 'Jack Bean', 'gjffdd')
    INSERT INTO addresses (email_address, user_id) VALUES (?, ?)
    ('jack@google.com', 5)
    INSERT INTO addresses (email_address, user_id) VALUES (?, ?)
    ('j25@yahoo.com', 5)
    COMMIT

è¯¢é—®æ°å…‹ï¼Œæˆ‘ä»¬åªå¾—åˆ°æ°å…‹ã€‚å°šæœªé’ˆå¯¹ Jack çš„åœ°å€å‘å¸ƒ SQLï¼š

    sql>>> jack = session.query(User).\
    ... filter_by(name='jack').one()
    BEGIN (implicit)
    SELECT users.id AS users_id,
            users.name AS users_name,
            users.fullname AS users_fullname,
            users.password AS users_password
    FROM users
    WHERE users.name = ?
    ('jack',)

    >>> jack
    <User(name='jack', fullname='Jack Bean', password='gjffdd')>

æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹`addresses`é›†åˆã€‚è§‚çœ‹ SQLï¼š

    sql>>> jack.addressesplain
    SELECT addresses.id AS addresses_id,
            addresses.email_address AS
            addresses_email_address,
            addresses.user_id AS addresses_user_id
    FROM addresses
    WHERE ? = addresses.user_id ORDER BY addresses.id
    (5,)
    [<Address(email_address='jack@google.com')>, <Address(email_address='j25@yahoo.com')>]

å½“æˆ‘ä»¬è®¿é—®`addresses`é›†åˆæ—¶ï¼ŒSQL çªç„¶å‘å¸ƒã€‚è¿™æ˜¯[lazy
loading](glossary.html#term-lazy-loading)å…³ç³»çš„ä¸€ä¸ªä¾‹å­ã€‚`addresses`é›†åˆç°åœ¨å·²åŠ è½½ï¼Œå…¶è¡Œä¸ºä¸æ™®é€šåˆ—è¡¨ç±»ä¼¼ã€‚æˆ‘ä»¬å°†ä»‹ç»å¦‚ä½•ä¼˜åŒ–è¿™ä¸ªé›†åˆçš„åŠ è½½ã€‚

ç”¨è¿æ¥æŸ¥è¯¢[Â¶](#querying-with-joins "Permalink to this headline")
----------------------------------------------------------------

æ—¢ç„¶æˆ‘ä»¬æœ‰ä¸¤ä¸ªè¡¨ï¼Œæˆ‘ä»¬å¯ä»¥å±•ç¤º[`Query`](query.html#sqlalchemy.orm.query.Query "sqlalchemy.orm.query.Query")çš„æ›´å¤šç‰¹æ€§ï¼Œç‰¹åˆ«æ˜¯å¦‚ä½•åˆ›å»ºåŒæ—¶å¤„ç†ä¸¤ä¸ªè¡¨çš„æŸ¥è¯¢ã€‚SQL
JOIN ä¸Šçš„[ç»´åŸºç™¾ç§‘é¡µé¢æä¾›äº†ä¸€ä¸ªå¾ˆå¥½çš„ä»‹ç»è¿æ¥æŠ€æœ¯çš„æ–¹æ³•ï¼Œå…¶ä¸­å‡ ä¸ªæˆ‘ä»¬å°†åœ¨è¿™é‡Œè¿›è¡Œè¯´æ˜ã€‚](http://en.wikipedia.org/wiki/Join_%28SQL%29)

To construct a simple implicit join between `User`
and `Address`, we can use [`Query.filter()`](query.html#sqlalchemy.orm.query.Query.filter "sqlalchemy.orm.query.Query.filter")
to equate their related columns together.
ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªæ–¹æ³•ä¸€æ¬¡åŠ è½½`User`å’Œ`Address`å®ä½“ï¼š

    sql>>> for u, a in session.query(User, Address).\plainplain
    ...                     filter(User.id==Address.user_id).\
    ...                     filter(Address.email_address=='jack@google.com').\
    ...                     all():
    ...     print(u)
    ...     print(a)
    SELECT users.id AS users_id,
            users.name AS users_name,
            users.fullname AS users_fullname,
            users.password AS users_password,
            addresses.id AS addresses_id,
            addresses.email_address AS addresses_email_address,
            addresses.user_id AS addresses_user_id
    FROM users, addresses
    WHERE users.id = addresses.user_id
            AND addresses.email_address = ?
    ('jack@google.com',)
    <User(name='jack', fullname='Jack Bean', password='gjffdd')>
    <Address(email_address='jack@google.com')>

å¦ä¸€æ–¹é¢ï¼Œå®é™…çš„ SQL JOIN è¯­æ³•æœ€å®¹æ˜“ä½¿ç”¨[`Query.join()`](query.html#sqlalchemy.orm.query.Query.join "sqlalchemy.orm.query.Query.join")æ–¹æ³•å®ç°ï¼š

    sql>>> session.query(User).join(Address).\plain
    ...         filter(Address.email_address=='jack@google.com').\
    ...         all()
    SELECT users.id AS users_id,
            users.name AS users_name,
            users.fullname AS users_fullname,
            users.password AS users_password
    FROM users JOIN addresses ON users.id = addresses.user_id
    WHERE addresses.email_address = ?
    ('jack@google.com',)
    [<User(name='jack', fullname='Jack Bean', password='gjffdd')>]

[`Query.join()`](query.html#sqlalchemy.orm.query.Query.join "sqlalchemy.orm.query.Query.join")çŸ¥é“å¦‚ä½•åœ¨`User`å’Œ`Address`ä¹‹é—´è¿›è¡Œè¿æ¥ï¼Œå› ä¸ºå®ƒä»¬ä¹‹é—´åªæœ‰ä¸€ä¸ªå¤–é”®ã€‚å¦‚æœæ²¡æœ‰å¤–é”®æˆ–å¤šä¸ªå¤–é”®ï¼Œå½“ä½¿ç”¨ä¸‹åˆ—å½¢å¼ä¹‹ä¸€æ—¶ï¼Œ[`Query.join()`](query.html#sqlalchemy.orm.query.Query.join "sqlalchemy.orm.query.Query.join")æ•ˆæœæ›´å¥½ï¼š

    query.join(Address, User.id==Address.user_id)    # explicit conditionplainplain
    query.join(User.addresses)                       # specify relationship from left to right
    query.join(Address, User.addresses)              # same, with explicit target
    query.join('addresses')                          # same, using a string

æ­£å¦‚ä½ æ‰€æœŸæœ›çš„é‚£æ ·ï¼Œä½¿ç”¨[`outerjoin()`](query.html#sqlalchemy.orm.query.Query.outerjoin "sqlalchemy.orm.query.Query.outerjoin")å‡½æ•°å¯¹â€œå¤–éƒ¨â€è¿æ¥ä½¿ç”¨ç›¸åŒçš„æƒ³æ³•ï¼š

    query.outerjoin(User.addresses)   # LEFT OUTER JOINplain

[`join()`](query.html#sqlalchemy.orm.query.Query.join "sqlalchemy.orm.query.Query.join")çš„å‚è€ƒæ–‡æ¡£åŒ…å«æ­¤æ–¹æ³•æ¥å—çš„è°ƒç”¨æ ·å¼çš„è¯¦ç»†ä¿¡æ¯å’Œç¤ºä¾‹ï¼›
[`join()`](query.html#sqlalchemy.orm.query.Query.join "sqlalchemy.orm.query.Query.join")æ˜¯ä»»ä½• SQL æµåˆ©åº”ç”¨ç¨‹åºä½¿ç”¨ä¸­å¿ƒçš„é‡è¦æ–¹æ³•ã€‚

å¦‚æœæœ‰å¤šä¸ªå®ä½“ï¼Œ[`Query`](query.html#sqlalchemy.orm.query.Query "sqlalchemy.orm.query.Query")é€‰æ‹©ä»€ä¹ˆï¼Ÿ

The [`Query.join()`](query.html#sqlalchemy.orm.query.Query.join "sqlalchemy.orm.query.Query.join")
method will **typically join from the leftmost item** in the list of
entities, when the ON clause is omitted, or if the ON clause is a plain
SQL expression.
è¦æ§åˆ¶ JOIN åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªå®ä½“ï¼Œè¯·ä½¿ç”¨[`Query.select_from()`](query.html#sqlalchemy.orm.query.Query.select_from "sqlalchemy.orm.query.Query.select_from")æ–¹æ³•ï¼š

    query = Session.query(User, Address).select_from(Address).join(User)plain

### ä½¿ç”¨åˆ«å[Â¶](#using-aliases "Permalink to this headline")

When querying across multiple tables, if the same table needs to be
referenced more than once, SQL typically requires that the table be
*aliased* with another name, so that it can be distinguished against
other occurrences of that table. [`Query`](query.html#sqlalchemy.orm.query.Query "sqlalchemy.orm.query.Query")ä½¿ç”¨[`aliased`](query.html#sqlalchemy.orm.aliased "sqlalchemy.orm.aliased")ç»“æ„æœ€æ˜ç¡®åœ°æ”¯æŒè¿™ä¸€ç‚¹ã€‚ä¸‹é¢æˆ‘ä»¬åŠ å…¥`Address`å®ä½“ä¸¤æ¬¡ï¼Œä»¥æ‰¾åˆ°åŒæ—¶æ‹¥æœ‰ä¸¤ä¸ªä¸åŒç”µå­é‚®ä»¶åœ°å€çš„ç”¨æˆ·ï¼š

    >>> from sqlalchemy.orm import aliased
    >>> adalias1 = aliased(Address)
    >>> adalias2 = aliased(Address)
    sql>>> for username, email1, email2 in \
    ...     session.query(User.name, adalias1.email_address, adalias2.email_address).\
    ...     join(adalias1, User.addresses).\
    ...     join(adalias2, User.addresses).\
    ...     filter(adalias1.email_address=='jack@google.com').\
    ...     filter(adalias2.email_address=='j25@yahoo.com'):
    ...     print(username, email1, email2)
    SELECT users.name AS users_name,
            addresses_1.email_address AS addresses_1_email_address,
            addresses_2.email_address AS addresses_2_email_address
    FROM users JOIN addresses AS addresses_1
            ON users.id = addresses_1.user_id
    JOIN addresses AS addresses_2
            ON users.id = addresses_2.user_id
    WHERE addresses_1.email_address = ?
            AND addresses_2.email_address = ?
    ('jack@google.com', 'j25@yahoo.com')
    jack jack@google.com j25@yahoo.com

### ä½¿ç”¨å­æŸ¥è¯¢[Â¶](#using-subqueries "Permalink to this headline")

[`Query`](query.html#sqlalchemy.orm.query.Query "sqlalchemy.orm.query.Query")é€‚ç”¨äºç”Ÿæˆå¯ç”¨ä½œå­æŸ¥è¯¢çš„è¯­å¥ã€‚å‡è®¾æˆ‘ä»¬æƒ³è¦åŠ è½½`User`å¯¹è±¡ä»¥åŠæ¯ä¸ªç”¨æˆ·æ‹¥æœ‰å¤šå°‘ä¸ª`Address`è®°å½•çš„è®¡æ•°ã€‚åƒè¿™æ ·ç”Ÿæˆ SQL çš„æœ€ä½³æ–¹æ³•æ˜¯è·å–æŒ‰ç”¨æˆ·æ ‡è¯†åˆ†ç»„çš„åœ°å€æ•°ï¼Œå¹¶å°† JOIN æ·»åŠ åˆ°çˆ¶çº§ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨ LEFT
OUTER JOINï¼Œä»¥ä¾¿æˆ‘ä»¬è¿”å›é‚£äº›æ²¡æœ‰ä»»ä½•åœ°å€çš„ç”¨æˆ·çš„è¡Œï¼Œä¾‹å¦‚ï¼š

    SELECT users.*, adr_count.address_count FROM users LEFT OUTER JOINplain
        (SELECT user_id, count(*) AS address_count
            FROM addresses GROUP BY user_id) AS adr_count
        ON users.id=adr_count.user_id

ä½¿ç”¨[`Query`](query.html#sqlalchemy.orm.query.Query "sqlalchemy.orm.query.Query")ï¼Œæˆ‘ä»¬ä»å†…åˆ°å¤–æ„å»ºä¸€ä¸ªç±»ä¼¼äºæ­¤çš„è¯­å¥ã€‚`statement`è®¿é—®å™¨è¿”å›ä¸€ä¸ªè¡¨è¾¾ç”±ç‰¹å®š[`Query`](query.html#sqlalchemy.orm.query.Query "sqlalchemy.orm.query.Query")ç”Ÿæˆçš„è¯­å¥çš„ SQL è¡¨è¾¾å¼
- è¿™æ˜¯ä¸€ä¸ª[`select()`](core_selectable.html#sqlalchemy.sql.expression.select "sqlalchemy.sql.expression.select")æ„é€ çš„å®ä¾‹ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯æè¿°åœ¨[SQL
Expression Language Tutorial](core_tutorial.html)ä¸­ï¼š

    >>> from sqlalchemy.sql import funcplain
    >>> stmt = session.query(Address.user_id, func.count('*').\
    ...         label('address_count')).\
    ...         group_by(Address.user_id).subquery()

`func`å…³é”®å­—ç”Ÿæˆ SQL å‡½æ•°ï¼Œå¹¶ä¸”[`Query`](query.html#sqlalchemy.orm.query.Query "sqlalchemy.orm.query.Query")ä¸Šçš„`subquery()`æ–¹æ³•ç”Ÿæˆä¸€ä¸ª SQL è¡¨è¾¾å¼ç»“æ„ï¼Œè¡¨ç¤ºåµŒå…¥åˆ«åä¸­çš„ SELECT è¯­å¥å®ƒå®é™…ä¸Šæ˜¯`query.statement.alias()`çš„ç¼©å†™ï¼‰ã€‚

ä¸€æ—¦æˆ‘ä»¬æœ‰äº†æˆ‘ä»¬çš„å£°æ˜ï¼Œå®ƒå°±åƒä¸€ä¸ª[`Table`](core_metadata.html#sqlalchemy.schema.Table "sqlalchemy.schema.Table")ç»“æ„ï¼Œæ¯”å¦‚æˆ‘ä»¬åœ¨æœ¬æ•™ç¨‹å¼€å§‹æ—¶ä¸º`users`åˆ›å»ºçš„ç»“æ„ã€‚è¯­å¥ä¸­çš„åˆ—å¯ä»¥é€šè¿‡åä¸º`c`çš„å±æ€§è¿›è¡Œè®¿é—®ï¼š

    sql>>> for u, count in session.query(User, stmt.c.address_count).\plainplain
    ...     outerjoin(stmt, User.id==stmt.c.user_id).order_by(User.id):
    ...     print(u, count)
    SELECT users.id AS users_id,
            users.name AS users_name,
            users.fullname AS users_fullname,
            users.password AS users_password,
            anon_1.address_count AS anon_1_address_count
    FROM users LEFT OUTER JOIN
        (SELECT addresses.user_id AS user_id, count(?) AS address_count
        FROM addresses GROUP BY addresses.user_id) AS anon_1
        ON users.id = anon_1.user_id
    ORDER BY users.id
    ('*',)
    <User(name='ed', fullname='Ed Jones', password='f8s7ccs')> None
    <User(name='wendy', fullname='Wendy Williams', password='foobar')> None
    <User(name='mary', fullname='Mary Contrary', password='xxg527')> None
    <User(name='fred', fullname='Fred Flinstone', password='blah')> None
    <User(name='jack', fullname='Jack Bean', password='gjffdd')> 2

### ä»å­æŸ¥è¯¢ä¸­é€‰æ‹©å®ä½“[Â¶](#selecting-entities-from-subqueries "Permalink to this headline")

ä¸Šé¢ï¼Œæˆ‘ä»¬åˆšåˆšé€‰æ‹©äº†ä¸€ä¸ªåŒ…å«å­æŸ¥è¯¢åˆ—çš„ç»“æœã€‚å¦‚æœæˆ‘ä»¬å¸Œæœ›æˆ‘ä»¬çš„å­æŸ¥è¯¢æ˜ å°„åˆ°å®ä½“å‘¢ï¼Ÿä¸ºæ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨`aliased()`å°†æ˜ å°„ç±»çš„â€œåˆ«åâ€å…³è”åˆ°å­æŸ¥è¯¢ï¼š

    sql>>> stmt = session.query(Address).\plainplainplain
    ...                 filter(Address.email_address != 'j25@yahoo.com').\
    ...                 subquery()
    >>> adalias = aliased(Address, stmt)
    >>> for user, address in session.query(User, adalias).\
    ...         join(adalias, User.addresses):
    ...     print(user)
    ...     print(address)
    SELECT users.id AS users_id,
                users.name AS users_name,
                users.fullname AS users_fullname,
                users.password AS users_password,
                anon_1.id AS anon_1_id,
                anon_1.email_address AS anon_1_email_address,
                anon_1.user_id AS anon_1_user_id
    FROM users JOIN
        (SELECT addresses.id AS id,
                addresses.email_address AS email_address,
                addresses.user_id AS user_id
        FROM addresses
        WHERE addresses.email_address != ?) AS anon_1
        ON users.id = anon_1.user_id
    ('j25@yahoo.com',)
    <User(name='jack', fullname='Jack Bean', password='gjffdd')>
    <Address(email_address='jack@google.com')>

### ä½¿ç”¨ EXISTS [Â¶](#using-exists "Permalink to this headline")

SQL ä¸­çš„ EXISTS å…³é”®å­—æ˜¯ä¸€ä¸ªå¸ƒå°”è¿ç®—ç¬¦ï¼Œå¦‚æœç»™å®šè¡¨è¾¾å¼åŒ…å«ä»»ä½•è¡Œï¼Œåˆ™è¿”å› Trueã€‚å®ƒå¯ä»¥åœ¨è®¸å¤šåœºæ™¯ä¸­ç”¨äºä»£æ›¿è¿æ¥ï¼Œå¹¶ä¸”å¯¹äºæŸ¥æ‰¾åœ¨ç›¸å…³è¡¨ä¸­æ²¡æœ‰ç›¸åº”è¡Œçš„è¡Œä¹Ÿå¾ˆæœ‰ç”¨ã€‚

æœ‰ä¸€ä¸ªæ˜ç¡®çš„ EXISTS æ„é€ ï¼Œçœ‹èµ·æ¥åƒè¿™æ ·ï¼š

    >>> from sqlalchemy.sql import existsplainplainplain
    >>> stmt = exists().where(Address.user_id==User.id)
    sql>>> for name, in session.query(User.name).filter(stmt):
    ...     print(name)
    SELECT users.name AS users_name
    FROM users
    WHERE EXISTS (SELECT *
    FROM addresses
    WHERE addresses.user_id = users.id)
    ()
    jack

[`Query`](query.html#sqlalchemy.orm.query.Query "sqlalchemy.orm.query.Query")å…·æœ‰å‡ ä¸ªè‡ªåŠ¨ä½¿ç”¨ EXISTS çš„æ“ä½œç¬¦ã€‚ä»¥ä¸Šï¼Œè¯­å¥å¯ä»¥ä½¿ç”¨[`any()`](internals.html#sqlalchemy.orm.properties.RelationshipProperty.Comparator.any "sqlalchemy.orm.properties.RelationshipProperty.Comparator.any")æ²¿ç€`User.addresses`å…³ç³»è¡¨ç¤ºï¼š

    sql>>> for name, in session.query(User.name).\plain
    ...         filter(User.addresses.any()):
    ...     print(name)
    SELECT users.name AS users_name
    FROM users
    WHERE EXISTS (SELECT 1
    FROM addresses
    WHERE users.id = addresses.user_id)
    ()
    jack

[`any()`](internals.html#sqlalchemy.orm.properties.RelationshipProperty.Comparator.any "sqlalchemy.orm.properties.RelationshipProperty.Comparator.any")
takes criterion as well, to limit the rows matched:

    sql>>> for name, in session.query(User.name).\plainplain
    ...     filter(User.addresses.any(Address.email_address.like('%google%'))):
    ...     print(name)
    SELECT users.name AS users_name
    FROM users
    WHERE EXISTS (SELECT 1
    FROM addresses
    WHERE users.id = addresses.user_id AND addresses.email_address LIKE ?)
    ('%google%',)
    jack

[`has()`](internals.html#sqlalchemy.orm.properties.RelationshipProperty.Comparator.has "sqlalchemy.orm.properties.RelationshipProperty.Comparator.has")
is the same operator as [`any()`](internals.html#sqlalchemy.orm.properties.RelationshipProperty.Comparator.any "sqlalchemy.orm.properties.RelationshipProperty.Comparator.any")
for many-to-one relationships (note the `~` operator
here too, which means â€œNOTâ€):

    sql>>> session.query(Address).\plain
    ...         filter(~Address.user.has(User.name=='jack')).all()
    SELECT addresses.id AS addresses_id,
            addresses.email_address AS addresses_email_address,
            addresses.user_id AS addresses_user_id
    FROM addresses
    WHERE NOT (EXISTS (SELECT 1
    FROM users
    WHERE users.id = addresses.user_id AND users.name = ?))
    ('jack',)
    []

### å¸¸è§å…³ç³»è¿ç®—ç¬¦[Â¶](#common-relationship-operators "Permalink to this headline")

ä»¥ä¸‹æ˜¯æ‰€æœ‰åŸºäºå…³ç³»çš„è¿è¥å•† -
æ¯ä¸ªè¿è¥å•†éƒ½é“¾æ¥åˆ°å…¶ API æ–‡æ¡£ï¼Œå…¶ä¸­åŒ…å«ä½¿ç”¨å’Œè¡Œä¸ºçš„å…¨éƒ¨è¯¦ç»†ä¿¡æ¯ï¼š

-   [`__eq__()`](internals.html#sqlalchemy.orm.properties.RelationshipProperty.Comparator.__eq__ "sqlalchemy.orm.properties.RelationshipProperty.Comparator.__eq__")ï¼ˆå¤šå¯¹ä¸€â€œç­‰äºâ€æ¯”è¾ƒï¼‰ï¼š

        query.filter(Address.user == someuser)plain

-   [`__ne__()`](internals.html#sqlalchemy.orm.properties.RelationshipProperty.Comparator.__ne__ "sqlalchemy.orm.properties.RelationshipProperty.Comparator.__ne__")ï¼ˆå¤šå¯¹ä¸€â€œä¸ç­‰äºâ€æ¯”è¾ƒï¼‰ï¼š

        query.filter(Address.user != someuser)plainplain

-   IS NULLï¼ˆå¤šå¯¹ä¸€æ¯”è¾ƒï¼Œä¹Ÿä½¿ç”¨[`__eq__()`](internals.html#sqlalchemy.orm.properties.RelationshipProperty.Comparator.__eq__ "sqlalchemy.orm.properties.RelationshipProperty.Comparator.__eq__")ï¼‰ï¼š

        query.filter(Address.user == None)

-   [`contains()`](internals.html#sqlalchemy.orm.properties.RelationshipProperty.Comparator.contains "sqlalchemy.orm.properties.RelationshipProperty.Comparator.contains")ï¼ˆç”¨äºä¸€å¯¹å¤šé›†åˆï¼‰ï¼š

        query.filter(User.addresses.contains(someaddress))plainplain

-   [`any()`](internals.html#sqlalchemy.orm.properties.RelationshipProperty.Comparator.any "sqlalchemy.orm.properties.RelationshipProperty.Comparator.any")ï¼ˆç”¨äºé›†åˆï¼‰ï¼š

        query.filter(User.addresses.any(Address.email_address == 'bar'))

        # also takes keyword arguments:
        query.filter(User.addresses.any(email_address='bar'))

-   [`has()`](internals.html#sqlalchemy.orm.properties.RelationshipProperty.Comparator.has "sqlalchemy.orm.properties.RelationshipProperty.Comparator.has")ï¼ˆç”¨äºæ ‡é‡å¼•ç”¨ï¼‰ï¼š

        query.filter(Address.user.has(name='ed'))plainplain

-   [`Query.with_parent()`](query.html#sqlalchemy.orm.query.Query.with_parent "sqlalchemy.orm.query.Query.with_parent")
    (used for any relationship):

        session.query(Address).with_parent(someuser, 'addresses')plainplain

æ€¥äºåŠ è½½[Â¶](#eager-loading "Permalink to this headline")
--------------------------------------------------------

å›æƒ³ä¸€ä¸‹ï¼Œå½“æˆ‘ä»¬è®¿é—®`User`çš„`User.addresses`é›†åˆå¹¶å‘å°„äº† SQL æ—¶ï¼Œæˆ‘ä»¬æ¼”ç¤ºäº†ä¸€ä¸ª[lazy
loading](glossary.html#term-lazy-loading)æ“ä½œã€‚å¦‚æœä½ æƒ³å‡å°‘æŸ¥è¯¢çš„æ•°é‡ï¼ˆåœ¨å¾ˆå¤šæƒ…å†µä¸‹æ˜¯æ˜¾ç€çš„ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æŸ¥è¯¢æ“ä½œä¸­åº”ç”¨ä¸€ä¸ªé¢„å…ˆåŠ è½½ã€‚SQLAlchemy æä¾›äº†ä¸‰ç§çƒ­åˆ‡åŠ è½½ç±»å‹ï¼Œå…¶ä¸­ä¸¤ç§æ˜¯è‡ªåŠ¨åŠ è½½çš„ï¼Œå¦ä¸€ç§æ˜¯è‡ªå®šä¹‰æ ‡å‡†ã€‚é€šå¸¸é€šè¿‡ç§°ä¸ºæŸ¥è¯¢é€‰é¡¹çš„å‡½æ•°è°ƒç”¨æ‰€æœ‰è¿™ä¸‰ä¸ªå‡½æ•°ï¼Œè¿™äº›å‡½æ•°ä¸º[`Query`](query.html#sqlalchemy.orm.query.Query "sqlalchemy.orm.query.Query")æä¾›äº†æœ‰å…³å¦‚ä½•é€šè¿‡[`Query.options()`](query.html#sqlalchemy.orm.query.Query.options "sqlalchemy.orm.query.Query.options")æ–¹æ³•ã€‚

### å­æŸ¥è¯¢ Load [Â¶](#subquery-load "Permalink to this headline")

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›æŒ‡å‡º`User.addresses`åº”è¯¥æ€¥åˆ‡åŠ è½½ã€‚åŠ è½½ä¸€ç»„å¯¹è±¡åŠå…¶ç›¸å…³é›†åˆçš„å¥½é€‰æ‹©æ˜¯[`orm.subqueryload()`](loading_relationships.html#sqlalchemy.orm.subqueryload "sqlalchemy.orm.subqueryload")é€‰é¡¹ï¼Œè¯¥é€‰é¡¹å‘å‡ºç¬¬äºŒä¸ª SELECT è¯­å¥ï¼Œè¯¥è¯­å¥å®Œå…¨åŠ è½½ä¸åˆšåŠ è½½çš„ç»“æœç›¸å…³çš„é›†åˆã€‚åç§°â€œsubqueryâ€æºè‡ªç›´æ¥é€šè¿‡[`Query`](query.html#sqlalchemy.orm.query.Query "sqlalchemy.orm.query.Query")æ„é€ çš„ SELECT è¯­å¥è¢«é‡ç”¨ï¼Œå¹¶ä½œä¸ºå­æŸ¥è¯¢åµŒå…¥åˆ° SELECT ä¸­ä»¥å¯¹ç…§ç›¸å…³è¡¨ã€‚è¿™æœ‰ç‚¹å¤æ‚ä½†å¾ˆå®¹æ˜“ä½¿ç”¨ï¼š

    >>> from sqlalchemy.orm import subqueryload
    sql>>> jack = session.query(User).\
    ...                 options(subqueryload(User.addresses)).\
    ...                 filter_by(name='jack').one()
    SELECT users.id AS users_id,
            users.name AS users_name,
            users.fullname AS users_fullname,
            users.password AS users_password
    FROM users
    WHERE users.name = ?
    ('jack',)
    SELECT addresses.id AS addresses_id,
            addresses.email_address AS addresses_email_address,
            addresses.user_id AS addresses_user_id,
            anon_1.users_id AS anon_1_users_id
    FROM (SELECT users.id AS users_id
        FROM users WHERE users.name = ?) AS anon_1
    JOIN addresses ON anon_1.users_id = addresses.user_id
    ORDER BY anon_1.users_id, addresses.id
    ('jack',)
    >>> jack
    <User(name='jack', fullname='Jack Bean', password='gjffdd')>

    >>> jack.addresses
    [<Address(email_address='jack@google.com')>, <Address(email_address='j25@yahoo.com')>]

æ³¨æ„

[`subqueryload()`](loading_relationships.html#sqlalchemy.orm.subqueryload "sqlalchemy.orm.subqueryload")
when used in conjunction with limiting such as [`Query.first()`](query.html#sqlalchemy.orm.query.Query.first "sqlalchemy.orm.query.Query.first"),
[`Query.limit()`](query.html#sqlalchemy.orm.query.Query.limit "sqlalchemy.orm.query.Query.limit")
or [`Query.offset()`](query.html#sqlalchemy.orm.query.Query.offset "sqlalchemy.orm.query.Query.offset")
should also include [`Query.order_by()`](query.html#sqlalchemy.orm.query.Query.order_by "sqlalchemy.orm.query.Query.order_by")
on a unique column in order to ensure correct results. è¯·å‚é˜…[The
Importance of
Ordering](loading_relationships.html#subqueryload-ordering)ã€‚

### åŠ å…¥ Load [Â¶](#joined-load "Permalink to this headline")

å¦ä¸€ä¸ªè‡ªåŠ¨åŠ è½½åŠ è½½å‡½æ•°æ›´ä¸ºäººç†ŸçŸ¥ï¼Œç§°ä¸º[`orm.joinedload()`](loading_relationships.html#sqlalchemy.orm.joinedload "sqlalchemy.orm.joinedload")ã€‚è¿™ç§åŠ è½½æ–¹å¼ä¼šå‘å‡ºä¸€ä¸ª JOINï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯ä¸€ä¸ª LEFT
OUTER
JOINï¼Œè¿™æ ·å°±å¯ä»¥åœ¨ä¸€ä¸ªæ­¥éª¤ä¸­åŠ è½½å‰å¯¼å¯¹è±¡ä»¥åŠç›¸å…³çš„å¯¹è±¡æˆ–é›†åˆã€‚æˆ‘ä»¬ä¸¾ä¾‹è¯´æ˜ä»¥è¿™ç§æ–¹å¼åŠ è½½ç›¸åŒçš„`addresses`é›†åˆ - è¯·æ³¨æ„ï¼Œå³ä½¿`jack`ä¸Šçš„`User.addresses`é›†åˆç°åœ¨å®é™…ä¸Šå·²è¢«å¡«å……ï¼Œæ— è®ºå¦‚ä½•æŸ¥è¯¢éƒ½ä¼šå‘å‡ºé¢å¤–çš„è¿æ¥ï¼š

    >>> from sqlalchemy.orm import joinedload

    sql>>> jack = session.query(User).\
    ...                        options(joinedload(User.addresses)).\
    ...                        filter_by(name='jack').one()
    SELECT users.id AS users_id,
            users.name AS users_name,
            users.fullname AS users_fullname,
            users.password AS users_password,
            addresses_1.id AS addresses_1_id,
            addresses_1.email_address AS addresses_1_email_address,
            addresses_1.user_id AS addresses_1_user_id
    FROM users
        LEFT OUTER JOIN addresses AS addresses_1 ON users.id = addresses_1.user_id
    WHERE users.name = ? ORDER BY addresses_1.id
    ('jack',)

    >>> jack
    <User(name='jack', fullname='Jack Bean', password='gjffdd')>

    >>> jack.addresses
    [<Address(email_address='jack@google.com')>, <Address(email_address='j25@yahoo.com')>]

è¯·æ³¨æ„ï¼Œå³ä½¿ OUTER JOIN å¯¼è‡´äº†ä¸¤è¡Œï¼Œæˆ‘ä»¬ä»ç„¶åªè¿”å›ä¸€ä¸ª`User`çš„å®ä¾‹ã€‚è¿™æ˜¯å› ä¸º[`Query`](query.html#sqlalchemy.orm.query.Query "sqlalchemy.orm.query.Query")å°†åŸºäºå¯¹è±¡æ ‡è¯†çš„â€œuniquingâ€ç­–ç•¥åº”ç”¨äºè¿”å›çš„å®ä½“ã€‚è¿™ç‰¹åˆ«é€‚ç”¨äºå¯ä»¥åº”ç”¨åŠ å…¥çš„åŠ è½½åŠ è½½è€Œä¸å½±å“æŸ¥è¯¢ç»“æœã€‚

è™½ç„¶[`joinedload()`](loading_relationships.html#sqlalchemy.orm.joinedload "sqlalchemy.orm.joinedload")å·²ç»å­˜åœ¨äº†å¾ˆé•¿æ—¶é—´ï¼Œä½†æ˜¯[`subqueryload()`](loading_relationships.html#sqlalchemy.orm.subqueryload "sqlalchemy.orm.subqueryload")æ˜¯ä¸€ç§æ›´æ–°çš„æ¸´æœ›åŠ è½½å½¢å¼ã€‚[`subqueryload()`](loading_relationships.html#sqlalchemy.orm.subqueryload "sqlalchemy.orm.subqueryload")å€¾å‘äºæ›´åŠ é€‚åˆåŠ è½½ç›¸å…³é›†åˆï¼Œè€Œ[`joinedload()`](loading_relationships.html#sqlalchemy.orm.joinedload "sqlalchemy.orm.joinedload")å€¾å‘äºæ›´é€‚åˆäºå¤šå¯¹ä¸€å…³ç³»ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªå¯¹äºé¢†å¯¼å’Œç›¸å…³å¯¹è±¡éƒ½åŠ è½½è¡Œã€‚

`joinedload()`ä¸èƒ½ä»£æ›¿`join()`

ç”±[`joinedload()`](loading_relationships.html#sqlalchemy.orm.joinedload "sqlalchemy.orm.joinedload")åˆ›å»ºçš„è¿æ¥æ˜¯åŒ¿ååŒ–çš„ï¼Œå› æ­¤å®ƒ**ä¸ä¼šå½±å“æŸ¥è¯¢ç»“æœ**ã€‚[`Query.order_by()`](query.html#sqlalchemy.orm.query.Query.order_by "sqlalchemy.orm.query.Query.order_by")æˆ–[`Query.filter()`](query.html#sqlalchemy.orm.query.Query.filter "sqlalchemy.orm.query.Query.filter")è°ƒç”¨**ä¸èƒ½**å¼•ç”¨è¿™äº›åˆ«åè¡¨
- æ„å»ºæ‰€è°“çš„â€œç”¨æˆ·ç©ºé—´â€è”æ¥ä½¿ç”¨[`Query.join()`](query.html#sqlalchemy.orm.query.Query.join "sqlalchemy.orm.query.Query.join")ã€‚å…¶åŸºæœ¬åŸç†æ˜¯ï¼Œ[`joinedload()`](loading_relationships.html#sqlalchemy.orm.joinedload "sqlalchemy.orm.joinedload")ä»…é€‚ç”¨äºå½±å“ç›¸å…³å¯¹è±¡æˆ–é›†åˆä½œä¸ºä¼˜åŒ–ç»†èŠ‚åŠ è½½çš„æ–¹å¼
-
å¯ä»¥æ·»åŠ æˆ–åˆ é™¤å®ƒï¼Œè€Œä¸ä¼šå½±å“å®é™…ç»“æœã€‚æœ‰å…³å¦‚ä½•ä½¿ç”¨è¿™äº›å†…å®¹çš„è¯¦ç»†è¯´æ˜ï¼Œè¯·å‚é˜…[The
Zen of Eager
Loading](loading_relationships.html#zen-of-eager-loading)éƒ¨åˆ†ã€‚

### æ˜¾å¼åŠ å…¥+ Eagerload [Â¶](#explicit-join-eagerload "Permalink to this headline")

ç¬¬ä¸‰ç§æ€¥åˆ‡åŠ è½½æ–¹å¼æ˜¯å½“æˆ‘ä»¬ä¸ºäº†å®šä½ä¸»è¦è¡Œè€Œæ˜¾å¼æ„å»ºä¸€ä¸ª JOIN æ—¶ï¼Œå¹¶ä¸”æƒ³é¢å¤–å°†é¢å¤–è¡¨åº”ç”¨åˆ°ä¸»è¦å¯¹è±¡ä¸Šçš„ç›¸å…³å¯¹è±¡æˆ–é›†åˆã€‚æ­¤åŠŸèƒ½é€šè¿‡[`orm.contains_eager()`](loading_relationships.html#sqlalchemy.orm.contains_eager "sqlalchemy.orm.contains_eager")å‡½æ•°æä¾›ï¼Œé€šå¸¸ç”¨äºåœ¨éœ€è¦è¿‡æ»¤åŒä¸€å¯¹è±¡çš„æŸ¥è¯¢ä¸Šé¢„åŠ è½½å¤šå¯¹ä¸€å¯¹è±¡ã€‚ä¸‹é¢æˆ‘ä»¬å°†è¯´æ˜å¦‚ä½•åŠ è½½`Address`è¡Œä»¥åŠç›¸å…³çš„`User`å¯¹è±¡ï¼Œåœ¨åä¸ºâ€œjackâ€çš„`User`ä¸Šè¿›è¡Œè¿‡æ»¤å¹¶ä½¿ç”¨[`orm.contains_eager()`](loading_relationships.html#sqlalchemy.orm.contains_eager "sqlalchemy.orm.contains_eager")å°†â€œuserâ€åˆ—åº”ç”¨äº`Address.user`å±æ€§ï¼š

    >>> from sqlalchemy.orm import contains_eagerplain
    sql>>> jacks_addresses = session.query(Address).\
    ...                             join(Address.user).\
    ...                             filter(User.name=='jack').\
    ...                             options(contains_eager(Address.user)).\
    ...                             all()
    SELECT users.id AS users_id,
            users.name AS users_name,
            users.fullname AS users_fullname,
            users.password AS users_password,
            addresses.id AS addresses_id,
            addresses.email_address AS addresses_email_address,
            addresses.user_id AS addresses_user_id
    FROM addresses JOIN users ON users.id = addresses.user_id
    WHERE users.name = ?
    ('jack',)

    >>> jacks_addresses
    [<Address(email_address='jack@google.com')>, <Address(email_address='j25@yahoo.com')>]

    >>> jacks_addresses[0].user
    <User(name='jack', fullname='Jack Bean', password='gjffdd')>

æœ‰å…³é¢„åŠ è½½çš„æ›´å¤šä¿¡æ¯ï¼ŒåŒ…æ‹¬å¦‚ä½•é»˜è®¤é…ç½®å„ç§åŠ è½½å½¢å¼ï¼Œè¯·å‚é˜…[*Relationship
Loading Techniques*](loading_relationships.html)éƒ¨åˆ†ã€‚

åˆ é™¤[Â¶ T0\>](#deleting "Permalink to this headline")
----------------------------------------------------

è®©æˆ‘ä»¬è¯•ç€åˆ é™¤`jack`ï¼Œçœ‹çœ‹ç»“æœå¦‚ä½•ã€‚æˆ‘ä»¬å°†åœ¨ä¼šè¯ä¸­æ ‡è®°ä¸ºå·²åˆ é™¤ï¼Œç„¶åæˆ‘ä»¬å°†å‘å‡ºä¸€ä¸ª`count`æŸ¥è¯¢ä»¥æŸ¥çœ‹æ²¡æœ‰è¡Œä¿ç•™ï¼š

    >>> session.delete(jack)plain
    sql>>> session.query(User).filter_by(name='jack').count()
    UPDATE addresses SET user_id=? WHERE addresses.id = ?
    ((None, 1), (None, 2))
    DELETE FROM users WHERE users.id = ?
    (5,)
    SELECT count(*) AS count_1
    FROM (SELECT users.id AS users_id,
            users.name AS users_name,
            users.fullname AS users_fullname,
            users.password AS users_password
    FROM users
    WHERE users.name = ?) AS anon_1
    ('jack',)
    0

åˆ°ç°åœ¨ä¸ºæ­¢è¿˜æŒºå¥½ã€‚æ°å…‹çš„`Address`å¯¹è±¡æ€ä¹ˆæ ·ï¼Ÿ

    sql>>> session.query(Address).filter(plainplain
    ...     Address.email_address.in_(['jack@google.com', 'j25@yahoo.com'])
    ...  ).count()
    SELECT count(*) AS count_1
    FROM (SELECT addresses.id AS addresses_id,
                    addresses.email_address AS addresses_email_address,
                    addresses.user_id AS addresses_user_id
    FROM addresses
    WHERE addresses.email_address IN (?, ?)) AS anon_1
    ('jack@google.com', 'j25@yahoo.com')
    2

å‘ƒå“¦ï¼Œä»–ä»¬è¿˜åœ¨ï¼åˆ†æåˆ·æ–° SQLï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ¯ä¸ªåœ°å€çš„`user_id`åˆ—è®¾ç½®ä¸º NULLï¼Œä½†è¡Œæœªè¢«åˆ é™¤ã€‚SQLAlchemy ä¸ä¼šå‡è®¾åˆ é™¤çº§è”ï¼Œä½ å¿…é¡»å‘Šè¯‰å®ƒè¿™æ ·åšã€‚

### é…ç½®åˆ é™¤/åˆ é™¤ - å­¤ç«‹çº§è”[Â¶](#configuring-delete-delete-orphan-cascade "Permalink to this headline")

æˆ‘ä»¬å°†åœ¨`User.addresses`å…³ç³»ä¸Šé…ç½®**çº§è”**é€‰é¡¹æ¥æ›´æ”¹è¡Œä¸ºã€‚å°½ç®¡ SQLAlchemy å…è®¸æ‚¨åœ¨ä»»ä½•æ—¶é—´ç‚¹æ·»åŠ æ–°çš„å±æ€§å’Œå…³ç³»åˆ°æ˜ å°„ï¼Œä½†åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œéœ€è¦åˆ é™¤ç°æœ‰çš„å…³ç³»ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦å®Œå…¨æ‹†é™¤æ˜ å°„å¹¶é‡æ–°å¼€å§‹
- æˆ‘ä»¬å°†å…³é—­[`Session`](session_api.html#sqlalchemy.orm.session.Session "sqlalchemy.orm.session.Session")

    >>> session.close()
    ROLLBACK

å¹¶ä½¿ç”¨æ–°çš„[`declarative_base()`](extensions_declarative_api.html#sqlalchemy.ext.declarative.declarative_base "sqlalchemy.ext.declarative.declarative_base")ï¼š

    >>> Base = declarative_base()plain

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å£°æ˜`User`ç±»ï¼Œå¹¶åœ¨åŒ…å«çº§è”é…ç½®çš„`addresses`å…³ç³»ä¸­æ·»åŠ ï¼ˆæˆ‘ä»¬å°†ç¦»å¼€æ„é€ å‡½æ•°ï¼‰ï¼š

    >>> class User(Base):plainplainplain
    ...     __tablename__ = 'users'
    ...
    ...     id = Column(Integer, primary_key=True)
    ...     name = Column(String)
    ...     fullname = Column(String)
    ...     password = Column(String)
    ...
    ...     addresses = relationship("Address", back_populates='user',
    ...                     cascade="all, delete, delete-orphan")
    ...
    ...     def __repr__(self):
    ...        return "<User(name='%s', fullname='%s', password='%s')>" % (
    ...                                self.name, self.fullname, self.password)

ç„¶åæˆ‘ä»¬é‡æ–°åˆ›å»º`Address`ï¼Œæ³¨æ„åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å·²ç»é€šè¿‡`User`ç±»åˆ›å»ºäº†`Address.user`å…³ç³»ï¼š

    >>> class Address(Base):
    ...     __tablename__ = 'addresses'
    ...     id = Column(Integer, primary_key=True)
    ...     email_address = Column(String, nullable=False)
    ...     user_id = Column(Integer, ForeignKey('users.id'))
    ...     user = relationship("User", back_populates="addresses")
    ...
    ...     def __repr__(self):
    ...         return "<Address(email_address='%s')>" % self.email_address

ç°åœ¨å½“æˆ‘ä»¬åŠ è½½ç”¨æˆ·`jack`ï¼ˆä¸‹é¢ç”¨[`get()`](query.html#sqlalchemy.orm.query.Query.get "sqlalchemy.orm.query.Query.get")ï¼Œé€šè¿‡ä¸»é”®åŠ è½½ï¼‰ï¼Œä»ç›¸åº”çš„`addresses`é›†åˆä¸­åˆ é™¤ä¸€ä¸ªåœ°å€å°†å¯¼è‡´`Address`è¢«åˆ é™¤ï¼š

    # load Jack by primary keyplain
    sql>>> jack = session.query(User).get(5)
    BEGIN (implicit)
    SELECT users.id AS users_id,
            users.name AS users_name,
            users.fullname AS users_fullname,
            users.password AS users_password
    FROM users
    WHERE users.id = ?
    (5,)

    # remove one Address (lazy load fires off)
    sql>>> del jack.addresses[1]
    SELECT addresses.id AS addresses_id,
            addresses.email_address AS addresses_email_address,
            addresses.user_id AS addresses_user_id
    FROM addresses
    WHERE ? = addresses.user_id
    (5,)

    # only one address remains
    sql>>> session.query(Address).filter(
    ...     Address.email_address.in_(['jack@google.com', 'j25@yahoo.com'])
    ... ).count()
    DELETE FROM addresses WHERE addresses.id = ?
    (2,)
    SELECT count(*) AS count_1
    FROM (SELECT addresses.id AS addresses_id,
                    addresses.email_address AS addresses_email_address,
                    addresses.user_id AS addresses_user_id
    FROM addresses
    WHERE addresses.email_address IN (?, ?)) AS anon_1
    ('jack@google.com', 'j25@yahoo.com')
    1

åˆ é™¤ Jack å°†åˆ é™¤ Jack å’Œä¸ç”¨æˆ·å…³è”çš„å…¶ä½™`Address`ï¼š

    >>> session.delete(jack)plain

    sql>>> session.query(User).filter_by(name='jack').count()
    DELETE FROM addresses WHERE addresses.id = ?
    (1,)
    DELETE FROM users WHERE users.id = ?
    (5,)
    SELECT count(*) AS count_1
    FROM (SELECT users.id AS users_id,
                    users.name AS users_name,
                    users.fullname AS users_fullname,
                    users.password AS users_password
    FROM users
    WHERE users.name = ?) AS anon_1
    ('jack',)
    0

    sql>>> session.query(Address).filter(
    ...    Address.email_address.in_(['jack@google.com', 'j25@yahoo.com'])
    ... ).count()
    SELECT count(*) AS count_1
    FROM (SELECT addresses.id AS addresses_id,
                    addresses.email_address AS addresses_email_address,
                    addresses.user_id AS addresses_user_id
    FROM addresses
    WHERE addresses.email_address IN (?, ?)) AS anon_1
    ('jack@google.com', 'j25@yahoo.com')
    0

æ›´å¤šå…³äºç€‘å¸ƒ

æœ‰å…³çº§è”é…ç½®çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§[Cascades](cascades.html#unitofwork-cascades)ã€‚çº§è”åŠŸèƒ½è¿˜å¯ä»¥ä¸å…³ç³»æ•°æ®åº“çš„`ON DELETE CASCADE`åŠŸèƒ½é¡ºåˆ©é›†æˆã€‚æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§[Using Passive
Deletes](collections.html#passive-deletes)ã€‚

å»ºç«‹å¤šå¯¹å¤šçš„å…³ç³»[Â¶](#building-a-many-to-many-relationship "Permalink to this headline")
---------------------------------------------------------------------------------------

æˆ‘ä»¬æ­£åœ¨è¿›å…¥å¥–é‡‘è½®ï¼Œä½†è®©æˆ‘ä»¬å±•ç¤ºä¸€ä¸ªå¤šå¯¹å¤šçš„å…³ç³»ã€‚æˆ‘ä»¬ä¹Ÿä¼šæ½œå…¥ä¸€äº›å…¶ä»–åŠŸèƒ½ï¼Œåªæ˜¯ä¸ºäº†å‚è§‚ã€‚æˆ‘ä»¬å°†ä½¿æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºæˆä¸ºåšå®¢åº”ç”¨ç¨‹åºï¼Œç”¨æˆ·å¯ä»¥åœ¨å…¶ä¸­ç¼–å†™`BlogPost`é¡¹ç›®ï¼Œå…¶ä¸­åŒ…å«ä¸`Keyword`é¡¹ç›®ç›¸å…³è”çš„é¡¹ç›®ã€‚

å¯¹äºæ™®é€šçš„å¤šå¯¹å¤šï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæœªæ˜ å°„çš„[`Table`](core_metadata.html#sqlalchemy.schema.Table "sqlalchemy.schema.Table")ç»“æ„æ¥å……å½“å…³è”è¡¨ã€‚è¿™çœ‹èµ·æ¥åƒä¸‹é¢è¿™æ ·ï¼š

    >>> from sqlalchemy import Table, Textplainplain
    >>> # association table
    >>> post_keywords = Table('post_keywords', Base.metadata,
    ...     Column('post_id', ForeignKey('posts.id'), primary_key=True),
    ...     Column('keyword_id', ForeignKey('keywords.id'), primary_key=True)
    ... )

ä¸Šé¢ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç›´æ¥å£°æ˜ä¸€ä¸ª[`Table`](core_metadata.html#sqlalchemy.schema.Table "sqlalchemy.schema.Table")ä¸å£°æ˜ä¸€ä¸ªæ˜ å°„ç±»æœ‰ç‚¹ä¸åŒã€‚[`Table`](core_metadata.html#sqlalchemy.schema.Table "sqlalchemy.schema.Table")æ˜¯ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œæ‰€ä»¥æ¯ä¸ª[`Column`](core_metadata.html#sqlalchemy.schema.Column "sqlalchemy.schema.Column")å‚æ•°éƒ½ä»¥é€—å·åˆ†éš”ã€‚[`Column`](core_metadata.html#sqlalchemy.schema.Column "sqlalchemy.schema.Column")å¯¹è±¡ä¹Ÿæ˜¾å¼ç»™å‡ºå…¶åç§°ï¼Œè€Œä¸æ˜¯ä»å·²åˆ†é…çš„å±æ€§åç§°ä¸­è·å–ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨äº’è¡¥çš„[`relationship()`](relationship_api.html#sqlalchemy.orm.relationship "sqlalchemy.orm.relationship")ç»“æ„å®šä¹‰`BlogPost`å’Œ`Keyword`ï¼Œæ¯ä¸ªç»“æ„éƒ½å¼•ç”¨`post_keywords`è¡¨ä½œä¸ºå…³è”è¡¨ï¼š

    >>> class BlogPost(Base):
    ...     __tablename__ = 'posts'
    ...
    ...     id = Column(Integer, primary_key=True)
    ...     user_id = Column(Integer, ForeignKey('users.id'))
    ...     headline = Column(String(255), nullable=False)
    ...     body = Column(Text)
    ...
    ...     # many to many BlogPost<->Keyword
    ...     keywords = relationship('Keyword',
    ...                             secondary=post_keywords,
    ...                             back_populates='posts')
    ...
    ...     def __init__(self, headline, body, author):
    ...         self.author = author
    ...         self.headline = headline
    ...         self.body = body
    ...
    ...     def __repr__(self):
    ...         return "BlogPost(%r, %r, %r)" % (self.headline, self.body, self.author)


    >>> class Keyword(Base):
    ...     __tablename__ = 'keywords'
    ...
    ...     id = Column(Integer, primary_key=True)
    ...     keyword = Column(String(50), nullable=False, unique=True)
    ...     posts = relationship('BlogPost',
    ...                          secondary=post_keywords,
    ...                          back_populates='keywords')
    ...
    ...     def __init__(self, keyword):
    ...         self.keyword = keyword

æ³¨æ„

ä¸Šé¢çš„ç±»å£°æ˜è¯´æ˜äº†æ˜¾å¼çš„`__init__()`æ–¹æ³•ã€‚è¯·è®°ä½ï¼Œä½¿ç”¨å£°æ˜æ—¶ï¼Œå®ƒæ˜¯å¯é€‰çš„ï¼

Above, the many-to-many relationship is `BlogPost.keywords`. å¤šå¯¹å¤šå…³ç³»çš„å®šä¹‰ç‰¹å¾æ˜¯å¼•ç”¨ä»£è¡¨å…³è”è¡¨çš„[`Table`](core_metadata.html#sqlalchemy.schema.Table "sqlalchemy.schema.Table")å¯¹è±¡çš„`secondary`å…³é”®å­—å‚æ•°ã€‚This table only contains columns which reference
the two sides of the relationship; if it has *any* other columns, such
as its own primary key, or foreign keys to other tables, SQLAlchemy
requires a different usage pattern called the â€œassociation objectâ€,
described at [Association
Object](basic_relationships.html#association-pattern).

æˆ‘ä»¬è¿˜å¸Œæœ›æˆ‘ä»¬çš„`BlogPost`ç±»å…·æœ‰`author`å­—æ®µã€‚æˆ‘ä»¬ä¼šå°†æ­¤æ·»åŠ ä¸ºå¦ä¸€ç§åŒå‘å…³ç³»ï¼Œé™¤äº†æˆ‘ä»¬å°†è¦é¢å¯¹çš„ä¸€ä¸ªé—®é¢˜æ˜¯å•ä¸ªç”¨æˆ·å¯èƒ½æ‹¥æœ‰å¤§é‡åšå®¢å¸–å­ã€‚å½“æˆ‘ä»¬è®¿é—®`User.posts`æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿè¿›ä¸€æ­¥è¿‡æ»¤ç»“æœï¼Œä»¥å…åŠ è½½æ•´ä¸ªé›†åˆã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªåä¸º`lazy='dynamic'`çš„[`relationship()`](relationship_api.html#sqlalchemy.orm.relationship "sqlalchemy.orm.relationship")æ¥å—çš„è®¾ç½®ï¼Œè¯¥è®¾ç½®åœ¨å±æ€§ä¸Šé…ç½®äº†ä¸€ä¸ªå¤‡ç”¨**åŠ è½½å™¨ç­–ç•¥**

    >>> BlogPost.author = relationship(User, back_populates="posts")plain
    >>> User.posts = relationship(BlogPost, back_populates="author", lazy="dynamic")

åˆ›å»ºæ–°è¡¨æ ¼ï¼š

    sql>>> Base.metadata.create_all(engine)plain
    PRAGMA...
    CREATE TABLE keywords (
        id INTEGER NOT NULL,
        keyword VARCHAR(50) NOT NULL,
        PRIMARY KEY (id),
        UNIQUE (keyword)
    )
    ()
    COMMIT
    CREATE TABLE posts (
        id INTEGER NOT NULL,
        user_id INTEGER,
        headline VARCHAR(255) NOT NULL,
        body TEXT,
        PRIMARY KEY (id),
        FOREIGN KEY(user_id) REFERENCES users (id)
    )
    ()
    COMMIT
    CREATE TABLE post_keywords (
        post_id INTEGER NOT NULL,
        keyword_id INTEGER NOT NULL,
        PRIMARY KEY (post_id, keyword_id),
        FOREIGN KEY(post_id) REFERENCES posts (id),
        FOREIGN KEY(keyword_id) REFERENCES keywords (id)
    )
    ()
    COMMIT

ç”¨æ³•ä¸æˆ‘ä»¬æ‰€åšçš„å¹¶æ— å¤ªå¤§å·®åˆ«ã€‚è®©æˆ‘ä»¬ç»™æ¸©è’‚ä¸€äº›åšå®¢æ–‡ç« ï¼š

    sql>>> wendy = session.query(User).\
    ...                 filter_by(name='wendy').\
    ...                 one()
    SELECT users.id AS users_id,
            users.name AS users_name,
            users.fullname AS users_fullname,
            users.password AS users_password
    FROM users
    WHERE users.name = ?
    ('wendy',)
    >>> post = BlogPost("Wendy's Blog Post", "This is a test", wendy)
    >>> session.add(post)

æˆ‘ä»¬å°†å…³é”®å­—å”¯ä¸€åœ°å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œä½†æˆ‘ä»¬çŸ¥é“æˆ‘ä»¬è¿˜æ²¡æœ‰ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åˆ›å»ºå®ƒä»¬ï¼š

    >>> post.keywords.append(Keyword('wendy'))
    >>> post.keywords.append(Keyword('firstpost'))

ç°åœ¨æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å…³é”®å­—'firstpost'æŸ¥æ‰¾æ‰€æœ‰åšå®¢æ–‡ç« ã€‚æˆ‘ä»¬å°†ä½¿ç”¨`any`è¿ç®—ç¬¦æ¥å®šä½â€œä»»ä½•å…³é”®å­—å…·æœ‰å…³é”®å­—å­—ç¬¦ä¸²â€firstpostâ€œçš„åšå®¢å¸–å­ï¼š

    sql>>> session.query(BlogPost).\
    ...             filter(BlogPost.keywords.any(keyword='firstpost')).\
    ...             all()
    INSERT INTO keywords (keyword) VALUES (?)
    ('wendy',)
    INSERT INTO keywords (keyword) VALUES (?)
    ('firstpost',)
    INSERT INTO posts (user_id, headline, body) VALUES (?, ?, ?)
    (2, "Wendy's Blog Post", 'This is a test')
    INSERT INTO post_keywords (post_id, keyword_id) VALUES (?, ?)
    (...)
    SELECT posts.id AS posts_id,
            posts.user_id AS posts_user_id,
            posts.headline AS posts_headline,
            posts.body AS posts_body
    FROM posts
    WHERE EXISTS (SELECT 1
        FROM post_keywords, keywords
        WHERE posts.id = post_keywords.post_id
            AND keywords.id = post_keywords.keyword_id
            AND keywords.keyword = ?)
    ('firstpost',)
    [BlogPost("Wendy's Blog Post", 'This is a test', <User(name='wendy', fullname='Wendy Williams', password='foobar')>)]

å¦‚æœæˆ‘ä»¬æƒ³æŸ¥æ‰¾ç”±ç”¨æˆ·`wendy`æ‹¥æœ‰çš„å¸–å­ï¼Œæˆ‘ä»¬å¯ä»¥å‘Šè¯‰æŸ¥è¯¢å°†å…¶ç¼©å°ä¸º`User`å¯¹è±¡ä½œä¸ºçˆ¶çº§ï¼š

    sql>>> session.query(BlogPost).\
    ...             filter(BlogPost.author==wendy).\
    ...             filter(BlogPost.keywords.any(keyword='firstpost')).\
    ...             all()
    SELECT posts.id AS posts_id,
            posts.user_id AS posts_user_id,
            posts.headline AS posts_headline,
            posts.body AS posts_body
    FROM posts
    WHERE ? = posts.user_id AND (EXISTS (SELECT 1
        FROM post_keywords, keywords
        WHERE posts.id = post_keywords.post_id
            AND keywords.id = post_keywords.keyword_id
            AND keywords.keyword = ?))
    (2, 'firstpost')
    [BlogPost("Wendy's Blog Post", 'This is a test', <User(name='wendy', fullname='Wendy Williams', password='foobar')>)]

æˆ–è€…æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Wendy è‡ªå·±çš„`posts`å…³ç³»ï¼Œè¿™æ˜¯ä¸€ä¸ªâ€œåŠ¨æ€â€å…³ç³»ï¼Œä»è¿™é‡Œç›´æ¥æŸ¥è¯¢ï¼š

    sql>>> wendy.posts.\plainplain
    ...         filter(BlogPost.keywords.any(keyword='firstpost')).\
    ...         all()
    SELECT posts.id AS posts_id,
            posts.user_id AS posts_user_id,
            posts.headline AS posts_headline,
            posts.body AS posts_body
    FROM posts
    WHERE ? = posts.user_id AND (EXISTS (SELECT 1
        FROM post_keywords, keywords
        WHERE posts.id = post_keywords.post_id
            AND keywords.id = post_keywords.keyword_id
            AND keywords.keyword = ?))
    (2, 'firstpost')
    [BlogPost("Wendy's Blog Post", 'This is a test', <User(name='wendy', fullname='Wendy Williams', password='foobar')>)]

è¿›ä¸€æ­¥å‚è€ƒ[Â¶](#further-reference "Permalink to this headline")
--------------------------------------------------------------

æŸ¥è¯¢å‚è€ƒï¼šquery\_api\_toplevel

æ˜ å°„å™¨å‚è€ƒï¼š[Mapper Configuration](mapper_config.html)

å…³ç³»å‚è€ƒï¼š[Relationship Configuration](relationships.html)

ä¼šè¯å‚è€ƒï¼š[*Using the Session*](session.html)
