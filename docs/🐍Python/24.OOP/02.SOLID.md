---
title: æ·±å…¥ç†è§£ OOP çš„ SOLID åŸåˆ™
date: 2022-03-25 11:31:37
permalink: /oop/solid/
categories:
  - Python
  - OOP
tags:
  - OOP
  - SOLID
  - é¢å‘å¯¹è±¡
---

## SOLID åŸåˆ™æ¦‚è¿°

SOLID æ˜¯é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼ˆOOPï¼‰çš„äº”å¤§è®¾è®¡åŸåˆ™ï¼Œç”± Robert C. Martin æå‡ºï¼Œæ—¨åœ¨æé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§ã€æ‰©å±•æ€§å’Œå¤ç”¨æ€§ï¼š

1. **S**RPï¼šå•ä¸€èŒè´£åŸåˆ™  
    _ä¸€ä¸ªç±»åªåº”æœ‰ä¸€ä¸ªå¼•èµ·å˜åŒ–çš„åŸå› _

2. **O**CPï¼šå¼€é—­åŸåˆ™  
    _è½¯ä»¶å®ä½“åº”å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­_

3. **L**SPï¼šé‡Œæ°æ›¿æ¢åŸåˆ™  
    _å­ç±»å¿…é¡»èƒ½å¤Ÿæ›¿æ¢å…¶åŸºç±»_

4. **I**SPï¼šæ¥å£éš”ç¦»åŸåˆ™  
    _ä¸åº”å¼ºè¿«å®¢æˆ·ç«¯ä¾èµ–å®ƒä»¬ä¸ç”¨çš„æ¥å£_

    å®¢æˆ·ç«¯ç¨‹åºä¸åº”è¯¥ä¾èµ–å®ƒä¸éœ€è¦çš„æ¥å£æ–¹æ³•ï¼Œä¸€ä¸ªæ¥å£æ‰€æä¾›çš„æ–¹æ³•ï¼Œåº”è¯¥å°±æ˜¯è°ƒç”¨æ–¹æ‰€éœ€è¦çš„æ–¹æ³•

5. **D**IPï¼šä¾èµ–å€’ç½®åŸåˆ™  
    _é«˜å±‚æ¨¡å—ä¸åº”ä¾èµ–ä½å±‚æ¨¡å—ï¼ŒäºŒè€…éƒ½åº”ä¾èµ–æŠ½è±¡_

    é¢å‘è¿‡ç¨‹çš„å¼€å‘ï¼Œä¸Šå±‚è°ƒç”¨ä¸‹å±‚ï¼Œä¸Šå±‚ä¾èµ–äºä¸‹å±‚ï¼Œå½“ä¸‹å±‚å‰§çƒˆå˜åŠ¨æ—¶ä¸Šå±‚ä¹Ÿè¦è·Ÿç€å˜åŠ¨ï¼Œè¿™å°±ä¼šå¯¼è‡´æ¨¡å—çš„å¤ç”¨æ€§é™ä½è€Œä¸”å¤§å¤§æé«˜äº†å¼€å‘çš„æˆæœ¬ã€‚

    é¢å‘å¯¹è±¡çš„å¼€å‘å¾ˆå¥½çš„è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æŠ½è±¡çš„å˜åŒ–æ¦‚ç‡å¾ˆå°ï¼Œè®©ç”¨æˆ·ç¨‹åºä¾èµ–äºæŠ½è±¡ï¼Œå®ç°çš„ç»†èŠ‚ä¹Ÿä¾èµ–äºæŠ½è±¡ã€‚å³ä½¿å®ç°ç»†èŠ‚ä¸æ–­å˜åŠ¨ï¼Œåªè¦æŠ½è±¡ä¸å˜ï¼Œå®¢æˆ·ç¨‹åºå°±ä¸éœ€è¦å˜åŒ–ã€‚è¿™å¤§å¤§é™ä½äº†å®¢æˆ·ç¨‹åºä¸å®ç°ç»†èŠ‚çš„è€¦åˆåº¦ã€‚

## 1. SRPï¼šå•ä¸€èŒè´£åŸåˆ™

**è¯¯åŒº**ï¼šè®¤ä¸º"ä¸€ä¸ªç±»åªèƒ½æœ‰ä¸€ä¸ªæ–¹æ³•"  
**æ­£è§£**ï¼šå…³æ³¨èŒè´£çš„å•ä¸€æ€§ï¼ˆå˜åŒ–åŸå› çš„éš”ç¦»ï¼‰

```python
# è¿åSRPï¼šåŒæ—¶å¤„ç†è®¢å•é€»è¾‘å’Œæ•°æ®åº“æ“ä½œ
class Order:
    def calculate_total(self): ...  # ä¸šåŠ¡é€»è¾‘
    def save_to_db(self): ...       # æŒä¹…åŒ–èŒè´£
    
# éµå¾ªSRPï¼šæ‹†åˆ†èŒè´£
class Order:
    def calculate_total(self):
        pass

class OrderRepository:
    def save_to_db(self, order):
        pass
```

å•ä¸€èŒè´£çš„æ ¸å¿ƒåœ¨äº**å¯¹â€œèŒè´£â€çš„ç²’åº¦ç†è§£**ã€‚å•ä¸€èŒè´£åŸåˆ™ï¼ˆSRPï¼‰çš„ç²¾é«“ä¸æ˜¯â€œä¸€ä¸ªç±»åªèƒ½æœ‰ä¸€ä¸ªæ–¹æ³•â€ï¼Œè€Œæ˜¯ **â€œä¸€ä¸ªç±»åªåº”å¯¹ä¸€ç§ç±»å‹çš„å˜æ›´è´Ÿè´£â€**ã€‚è®©æˆ‘ä»¬é€šè¿‡å¯¹æ¯”åˆ†ææ¥å½»åº•è§£é‡Šè¿™ä¸ªçŸ›ç›¾ï¼š

### ä¸€ã€è¡¨é¢çŸ›ç›¾ vs æœ¬è´¨åŸåˆ™

| è¡¨é¢ç°è±¡                              | æœ¬è´¨åŸåˆ™                   | è§£æ                               |
|-----------------------------------|------------------------|----------------------------------|
| ä¸€ä¸ªç±»åŒ…å«å¤šä¸ªæ–¹æ³•                         | ä¸€ä¸ªç±»åªå“åº”ä¸€ç§ä¸šåŠ¡å˜åŒ–           | æ–¹æ³•æ•°é‡â‰ èŒè´£æ•°é‡ï¼Œå…³é”®åœ¨äºå˜æ›´åŸå› æ˜¯å¦ç›¸åŒ           |
| User ç±»æœ‰ login()ã€update_profile()ç­‰æ–¹æ³• | æ‰€æœ‰æ–¹æ³•éƒ½å›´ç»•ç”¨æˆ·å®ä½“çš„æ ¸å¿ƒè¡Œä¸º       | å½“â€œç”¨æˆ·ç®¡ç†è§„åˆ™â€å˜åŒ–æ—¶æ‰éœ€ä¿®æ”¹æ­¤ç±»               |
| è‹¥ç±»åŒ…å« send_email()+save_to_db()     | è¿å SRPï¼šéœ€å› é‚®ä»¶åè®®æˆ–æ•°æ®åº“å˜æ›´åˆ†åˆ«ä¿®æ”¹ | æ­¤æ—¶åº”æ‹†åˆ†ä¸º UserService + EmailService |

### äºŒã€åˆ¤æ–­æ˜¯å¦è¿å SRP çš„å…³é”®æµ‹è¯•

ç”¨è¿™ä¸¤ä¸ªé—®é¢˜æ£€éªŒç±»çš„è®¾è®¡ï¼š

1. **å˜æ›´è§¦å‘æµ‹è¯•**  
    â€œä¿®æ”¹ XXX åŠŸèƒ½æ—¶ï¼Œæ˜¯å¦**å¿…é¡»**ä¿®æ”¹è¿™ä¸ªç±»ï¼Ÿâ€  
    âœ… åˆæ³•ï¼šä¿®æ”¹ç”¨æˆ·å¯†ç ç­–ç•¥æ—¶åªéœ€æ”¹`User`ç±»  
    âŒ è¿è§„ï¼šä¿®æ”¹é‚®ä»¶æ¨¡æ¿æ—¶è¢«è¿«æ”¹`User`ç±»

2. **èŒè´£æè¿°æµ‹è¯•**  
    èƒ½å¦ç”¨**ä¸€ä¸ªä¸šåŠ¡åè¯**æè¿°ç±»çš„èŒè´£ï¼Ÿ  
    âœ… åˆæ³•ï¼š`Order`ï¼ˆè®¢å•å¤„ç†ï¼‰ã€`PaymentGateway`ï¼ˆæ”¯ä»˜å¯¹æ¥ï¼‰  
    âŒ è¿è§„ï¼š`OrderAndEmailUtil`ï¼ˆæ··åˆè®¢å•å’Œé‚®ä»¶ï¼‰

### ä¸‰ã€Python ä¸­çš„åˆè§„ç±»è®¾è®¡ç¤ºä¾‹

```python
# âœ… ç¬¦åˆSRPï¼šæ‰€æœ‰æ–¹æ³•åªå¤„ç†â€œç”¨æˆ·èº«ä»½è®¤è¯â€è¿™ä¸€ç§å˜åŒ–
class Authenticator:
    def login(self, username, password):
        # ä»…å¤„ç†è®¤è¯é€»è¾‘
        pass
    
    def logout(self):
        pass
    
    def refresh_token(self):
        pass

# âœ… ç¬¦åˆSRPï¼šä»…è´Ÿè´£ç”¨æˆ·æ•°æ®æŒä¹…åŒ–
class UserRepository:
    def save(self, user):
        # æ•°æ®åº“æ“ä½œ
        pass
    
    def find_by_id(self, user_id):
        pass

# âŒ è¿åSRPï¼šæ··åˆè®¤è¯ã€å­˜å‚¨ã€é€šçŸ¥ä¸‰ç§èŒè´£
class UserManager:
    def login(self): ...          # è®¤è¯èŒè´£
    def save_to_db(self): ...     # å­˜å‚¨èŒè´£
    def send_welcome_email(self): # é€šçŸ¥èŒè´£
```

### å››ã€å¸¸è§è¿è§„åœºæ™¯åŠè§£å†³æ–¹æ¡ˆ

#### åœºæ™¯ 1ï¼šä¸Šå¸ç±»ï¼ˆGod Classï¼‰

```python
# è¿åSRPï¼šä¸€ä¸ªç±»å¤„ç†æ‰€æœ‰è®¢å•ç›¸å…³é€»è¾‘
class OrderProcessor:
    def validate_order(self): ...   # æ ¡éªŒ
    def calculate_tax(self): ...    # è®¡ç®—
    def save_to_database(self): ... # å­˜å‚¨
    def print_receipt(self): ...    # æ‰“å°
    def notify_warehouse(self): ... # é€šçŸ¥
    
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

```python
class OrderValidator: ...          # æ ¡éªŒèŒè´£
class TaxCalculator: ...           # è®¡ç®—èŒè´£
class OrderRepository: ...         # å­˜å‚¨èŒè´£
class ReceiptPrinter: ...          # æ‰“å°èŒè´£

```

#### åœºæ™¯ 2ï¼šæ··åˆä¸šåŠ¡ä¸æŠ€æœ¯ç»†èŠ‚

```python

# è¿åSRPï¼šä¸šåŠ¡é€»è¾‘å’ŒæŠ€æœ¯å®ç°è€¦åˆ
class ReportGenerator:
    def fetch_data(self): 
        # ç›´æ¥è°ƒç”¨SQLæŸ¥è¯¢ âŒ
    
    def format_html(self): ...     # å±•ç¤ºé€»è¾‘
    
```

**ä¿®å¤æ–¹æ¡ˆ**ï¼š

```python

class ReportDataFetcher: ...       # æ•°æ®è·å–èŒè´£
class HtmlReportRenderer: ...      # æ¸²æŸ“èŒè´£

```

### äº”ã€SRP çš„é»„é‡‘å®è·µå‡†åˆ™

1. **ä¸šåŠ¡é€»è¾‘èšç„¦**  
    ç±»çš„æ‰€æœ‰æ–¹æ³•åº”æœåŠ¡äº**åŒä¸€ä¸ªä¸šåŠ¡ç›®æ ‡**ï¼ˆå¦‚â€œè®¢å•åˆ›å»ºâ€ã€â€œæ”¯ä»˜å¤„ç†â€ï¼‰

2. **æŠ€æœ¯éš”ç¦»**  
    æ•°æ®åº“æ“ä½œã€ç½‘ç»œè¯·æ±‚ã€æ—¥å¿—è®°å½•ç­‰æŠ€æœ¯ç»†èŠ‚åº”å°è£…åˆ°ç‹¬ç«‹ç±»

3. **å˜æ›´éš”ç¦»**  
    å½“ä»¥ä¸‹ä»»ä¸€å˜åŒ–å‘ç”Ÿæ—¶ï¼Œä¸åº”å½±å“åŒä¸€ä¸ªç±»ï¼š

    * ä¸šåŠ¡è§„åˆ™å˜åŒ– vs æŠ€æœ¯å®ç°å˜åŒ–

    * å‰ç«¯å±•ç¤ºå˜åŒ– vs åç«¯è®¡ç®—å˜åŒ–

    * æ•°æ®æ¥æºå˜åŒ– vs æ•°æ®å¤„ç†é€»è¾‘å˜åŒ–

4. **ä¾èµ–æ–¹å‘**  
    é«˜å±‚ä¸šåŠ¡ç±»ä¾èµ–æŠ½è±¡ï¼ˆæ¥å£ï¼‰ï¼Œè€Œéå…·ä½“æŠ€æœ¯å®ç°ç±»

### å…­ã€ä¸ºä»€ä¹ˆ Python å¼€å‘è€…æ›´å®¹æ˜“è¿å SRP

| ç‰¹æ€§          | é£é™©        | è§£å†³æ–¹æ¡ˆ              |
|-------------|-----------|-------------------|
| åŠ¨æ€ç±»å‹        | å®¹æ˜“åˆ›å»ºâ€œå…¨èƒ½ç±»â€ | æ˜ç¡®ç”¨æŠ½è±¡åŸºç±»ï¼ˆABCï¼‰å®šä¹‰æ¥å£  |
| Duck Typing | å¿½ç•¥æ˜ç¡®çš„èŒè´£è¾¹ç•Œ | éµå¾ªâ€œä¸€ä¸ªç±»åªåšä¸€ä»¶äº‹â€çš„å‘½åçº¦æŸ |
| è„šæœ¬æ€ç»´æƒ¯æ€§      | ä¹ æƒ¯å†™è¿‡ç¨‹å¼ä»£ç   | é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰è®­ç»ƒ     |

### ç»“è®ºï¼šæ–¹æ³•å¤šâ‰ è¿å SRP

âœ… **åˆè§„æƒ…å†µ**ï¼š  
å½“ç±»ä¸­çš„å¤šä¸ªæ–¹æ³•éƒ½æœåŠ¡äº**åŒä¸€ä¸ªä¸šåŠ¡èŒè´£**ï¼ˆä¾‹å¦‚`User`ç±»çš„æ‰€æœ‰æ–¹æ³•éƒ½ç®¡ç†ç”¨æˆ·æ ¸å¿ƒæ•°æ®ï¼‰ï¼Œå³ä½¿æœ‰ 20 ä¸ªæ–¹æ³•ä¹Ÿä¸è¿å SRPã€‚

âŒ **è¿è§„æ ‡å¿—**ï¼š  
å½“ä¿®æ”¹ç±»çš„åŸå› æ¥è‡ª**ä¸åŒä¸šåŠ¡ç»´åº¦**ï¼ˆä¾‹å¦‚ï¼šéœ€è¦å› é‚®ä»¶æœåŠ¡å•†æ›´æ¢ä¿®æ”¹`login()`æ–¹æ³•ï¼Œæˆ–å› æ•°æ®åº“è¿ç§»ä¿®æ”¹`get_profile()`æ–¹æ³•ï¼‰ï¼Œåˆ™å¿…é¡»æ‹†åˆ†ã€‚

**ç»ˆæåˆ¤æ–­æ ‡å‡†**ï¼š

> å½“ä¸šåŠ¡éœ€æ±‚å˜åŒ–æ—¶ï¼Œä½ çš„ä¿®æ”¹æ˜¯å¦**åªå±€é™äºæŸä¸ªç‰¹å®šç±»**ï¼Ÿ  
> å¦‚æœæ˜¯ï¼Œåˆ™ç¬¦åˆ SRPï¼›  
> å¦‚æœéœ€è¦è·¨å¤šä¸ªä¸ç›¸å…³ç±»ä¿®æ”¹ï¼Œè¯´æ˜èŒè´£è€¦åˆï¼›  
> å¦‚æœä¿®æ”¹ç‚¹é›†ä¸­åœ¨ä¸€ä¸ªç±»çš„ä¸åŒä½ç½®ï¼Œè¯´æ˜èŒè´£è¿‡é‡ã€‚

é€šè¿‡è¿™ç§è®¾è®¡ï¼Œä½ ä¼šå‘ç°ï¼š

* ä»£ç å˜æ›´æ›´å®‰å…¨ï¼ˆä¿®æ”¹ç‚¹å±€éƒ¨åŒ–ï¼‰

* æµ‹è¯•æ›´å®¹æ˜“ï¼ˆå•ä¸€èŒè´£ç±»çš„æµ‹è¯•ç”¨ä¾‹æ›´èšç„¦ï¼‰

* ç³»ç»Ÿæ›´çµæ´»ï¼ˆæ›¿æ¢æŠ€æœ¯å®ç°ä¸å½±å“ä¸šåŠ¡é€»è¾‘ï¼‰

## 2. OCPï¼šå¼€é—­åŸåˆ™

**è¯¯åŒº**ï¼šè®¤ä¸º"ç»å¯¹ç¦æ­¢ä¿®æ”¹å·²æœ‰ç±»"  
**æ­£è§£**ï¼šé€šè¿‡æ‰©å±•ï¼ˆç»§æ‰¿/ç»„åˆï¼‰æ·»åŠ æ–°åŠŸèƒ½ï¼Œè€Œéä¿®æ”¹

```python
# è¿åOCPï¼šæ–°å¢å½¢çŠ¶éœ€ä¿®æ”¹AreaCalculator
class AreaCalculator:
    def area(self, shape):
        if type(shape) == Circle:
            return math.pi * shape.radius ** 2
        elif type(shape) == Square:  # æ·»åŠ æ–°å½¢çŠ¶éœ€ä¿®æ”¹ä»£ç 
            return shape.side ** 2

# éµå¾ªOCPï¼šæŠ½è±¡Shapeç±»ï¼Œæ‰©å±•æ— éœ€ä¿®æ”¹è®¡ç®—å™¨
class Shape(ABC):
    @abstractmethod
    def area(self): ...

class Circle(Shape):
    def area(self): return math.pi * self.radius ** 2

class AreaCalculator:
    def area(self, shape: Shape):  # ä¾èµ–æŠ½è±¡
        return shape.area()  # æ–°å¢å½¢çŠ¶ä¸å½±å“æ­¤æ–¹æ³•
        
```

**å¼€é—­åŸåˆ™ï¼ˆOpen-Closed Principle, OCPï¼‰** è¡¨é¢ä¸Šçœ‹ä¼¼ä¹ä¸å¼€å‘å®è·µå†²çªï¼ˆæ ¹æ®éœ€æ±‚å˜æ›´é¢‘ç¹ä¿®æ”¹ä»£ç ï¼‰ï¼Œä½†å…¶æ ¸å¿ƒç†å¿µæ˜¯**é€šè¿‡æ¶æ„è®¾è®¡å‡å°‘æ ¸å¿ƒé€»è¾‘çš„ä¿®æ”¹**ã€‚ä¸‹é¢ç”¨å…·ä½“åœºæ™¯å’Œä»£ç ç¤ºä¾‹è§£é‡Šå¦‚ä½•ç†è§£â€œå…³é—­ä¿®æ”¹â€ä¸â€œå¼€æ”¾æ‰©å±•â€ï¼š

### ä¸€ã€åŸåˆ™æœ¬è´¨ï¼šç”¨æŠ½è±¡æŠµå¾¡å˜åŒ–

| å…³é”®æ¦‚å¿µ  | è§£é‡Š                              |
|-------|---------------------------------|
| å¯¹ä¿®æ”¹å…³é—­ | æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ä¸€æ—¦å®Œæˆï¼Œä¸åº”å› æ–°éœ€æ±‚è€Œé¢‘ç¹ä¿®æ”¹ï¼ˆé¿å…å¼•å…¥é£é™©ï¼‰  |
| å¯¹æ‰©å±•å¼€æ”¾ | é€šè¿‡**æŠ½è±¡å±‚**ï¼ˆæ¥å£/ç»§æ‰¿/ç»„åˆï¼‰çµæ´»æ·»åŠ æ–°åŠŸèƒ½ï¼Œæ— éœ€æ”¹åŠ¨å·²æœ‰ä»£ç  |
| æ ¸å¿ƒç›®æ ‡  | é™ä½ç³»ç»Ÿè€¦åˆåº¦ï¼Œè®©æ–°å¢éœ€æ±‚é€šè¿‡**æ–°å¢ä»£ç **å®ç°ï¼Œè€Œéä¿®æ”¹æ—§ä»£ç    |

### äºŒã€è¿å OCP çš„å…¸å‹åœºæ™¯

å‡è®¾æœ‰ä¸€ä¸ªæ”¯ä»˜å¤„ç†ç±»ï¼š

```python

class PaymentProcessor:
    def process(self, payment_type):
        if payment_type == "alipay":
            self._process_alipay()   # æ”¯ä»˜å®æ”¯ä»˜é€»è¾‘
        elif payment_type == "wechat":
            self._process_wechat()   # å¾®ä¿¡æ”¯ä»˜é€»è¾‘

# å½“éœ€è¦æ–°å¢é“¶è”æ”¯ä»˜æ—¶ï¼Œå¿…é¡»ä¿®æ”¹ç±»å†…éƒ¨ä»£ç 
processor = PaymentProcessor()
processor.process("unionpay")  # âŒ éœ€æ·»åŠ æ–°çš„ifåˆ†æ”¯

```

**é—®é¢˜**ï¼š  
æ¯æ¬¡æ–°å¢æ”¯ä»˜æ–¹å¼éƒ½è¦ä¿®æ”¹ `process()` æ–¹æ³•ï¼Œå¯èƒ½ç ´åå·²æœ‰é€»è¾‘ï¼ˆå¦‚å½±å“æ”¯ä»˜å®æµç¨‹ï¼‰ã€‚

### ä¸‰ã€ç¬¦åˆ OCP çš„è§£å†³æ–¹æ¡ˆ

#### æ­¥éª¤ 1ï¼šå®šä¹‰æŠ½è±¡æ¥å£

```python

from abc import ABC, abstractmethod

class PaymentStrategy(ABC):
    @abstractmethod
    def execute(self):
        pass
        
```

#### æ­¥éª¤ 2ï¼šå®ç°å…·ä½“æ”¯ä»˜ç­–ç•¥

```python

class AlipayStrategy(PaymentStrategy):
    def execute(self):
        print("æ”¯ä»˜å®æ”¯ä»˜é€»è¾‘")

class WechatPayStrategy(PaymentStrategy):
    def execute(self):
        print("å¾®ä¿¡æ”¯ä»˜é€»è¾‘")
```

#### æ­¥éª¤ 3ï¼šæ ¸å¿ƒå¤„ç†å™¨ä¾èµ–æŠ½è±¡

```python

class PaymentProcessor:
    def __init__(self, strategy: PaymentStrategy):  # ä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°
        self.strategy = strategy
    
    def process(self):
        self.strategy.execute()  # æ ¸å¿ƒé€»è¾‘æ°¸ä¸ä¿®æ”¹
        
```

#### æ­¥éª¤ 4ï¼šæ‰©å±•æ–°æ”¯ä»˜æ–¹å¼

```python

# âœ… æ–°å¢é“¶è”æ”¯ä»˜ï¼šæ— éœ€ä¿®æ”¹PaymentProcessor
class UnionPayStrategy(PaymentStrategy):
    def execute(self):
        print("é“¶è”æ”¯ä»˜é€»è¾‘")

# ä½¿ç”¨æ–°æ”¯ä»˜
processor = PaymentProcessor(UnionPayStrategy())
processor.process()  # å®‰å…¨æ‰©å±•

```

### å››ã€OCP çš„è½åœ°æŠ€å·§

#### 1. è¯†åˆ«å˜åŒ–ç‚¹

* å°†**æ˜“å˜éƒ¨åˆ†**ï¼ˆå¦‚æ”¯ä»˜æ–¹å¼ã€é€šçŸ¥æ¸ é“ï¼‰æŠ½è±¡ä¸ºæ¥å£

* **ç¨³å®šéƒ¨åˆ†**ï¼ˆå¦‚æ”¯ä»˜æµç¨‹æ§åˆ¶ï¼‰ä¿æŒå…³é—­

#### 2. æ‰©å±•æ–¹å¼å¯¹æ¯”

| æ–¹å¼    | æè¿°           | OCP åˆè§„æ€§           |
|-------|--------------|-------------------|
| ç»§æ‰¿    | å­ç±»é‡å†™çˆ¶ç±»æ–¹æ³•     | âš ï¸ æœ‰é™æ”¯æŒï¼ˆå¯èƒ½ç ´åçˆ¶ç±»é€»è¾‘ï¼‰ |
| ç»„åˆ+æ¥å£ | å°†è¡Œä¸ºæ³¨å…¥æ ¸å¿ƒç±»ï¼ˆæ¨èï¼‰ | âœ… å®Œå…¨æ”¯æŒ            |
| æ’ä»¶æœºåˆ¶  | åŠ¨æ€åŠ è½½æ‰©å±•æ¨¡å—     | âœ… æœ€ä½³å®è·µ            |

#### 3. ä½•æ—¶å…è®¸ä¿®æ”¹ä»£ç 

OCP ä¸æ˜¯ç¦æ­¢æ‰€æœ‰ä¿®æ”¹ï¼Œè€Œæ˜¯ç¦æ­¢ï¼š

* ä¿®æ”¹**æ ¸å¿ƒä¸šåŠ¡é€»è¾‘**ï¼ˆå¦‚è®¢å•çŠ¶æ€æœºï¼‰

* ä¿®æ”¹**å·²é€šè¿‡æµ‹è¯•çš„ç¨³å®šæ¨¡å—**

**å…è®¸ä¿®æ”¹çš„æƒ…å†µ**ï¼š

* ä¿®å¤ bug

* é‡æ„éæ ¸å¿ƒå·¥å…·ç±»

* è°ƒæ•´æ¥å£å®ç°ï¼ˆä¸æ”¹å˜æŠ½è±¡å¥‘çº¦ï¼‰

### äº”ã€Python ä¸­çš„çµæ´»å®ç°

#### æ–¹æ¡ˆ 1ï¼šåŸºäºåè®®çš„é¸­å­ç±»å‹ï¼ˆPythonic æ–¹å¼ï¼‰

```python

# å®šä¹‰éšå¼åè®®ï¼ˆæ— éœ€ç»§æ‰¿ï¼‰
class PaymentProcessor:
    def process(self, strategy):
        strategy.execute()  # åªè¦ä¼ å…¥å¯¹è±¡æœ‰execute()æ–¹æ³•å³å¯

# æ‰©å±•æ–°æ”¯ä»˜ï¼ˆæ— éœ€ç»§æ‰¿ç»Ÿä¸€æ¥å£ï¼‰
class CryptoPay:  
    def execute(self):      # ç¬¦åˆåè®®çš„æ–¹æ³•
        print("åŠ å¯†è´§å¸æ”¯ä»˜")

processor.process(CryptoPay())  # âœ… æ— ç¼æ‰©å±•

```

#### æ–¹æ¡ˆ 2ï¼šä½¿ç”¨å‡½æ•°æŠ½è±¡

```python

class PaymentProcessor:
    def process(self, payment_func):  # æ¥æ”¶å‡½æ•°ä½œä¸ºç­–ç•¥
        payment_func()

# æ‰©å±•åªéœ€å®šä¹‰æ–°å‡½æ•°
def apple_pay():
    print("Apple Payé€»è¾‘")

processor.process(apple_pay)  # âœ… å‡½æ•°å³ç­–ç•¥

```

### å…­ã€OCP çš„æ”¶ç›Šä¸ä»£ä»·

| æ”¶ç›Š              | ä»£ä»·          |
|-----------------|-------------|
| é™ä½å›å½’æµ‹è¯•æˆæœ¬        | å‰æœŸè®¾è®¡å¤æ‚åº¦å¢åŠ    |
| æå‡ç³»ç»Ÿç¨³å®šæ€§ï¼ˆæ ¸å¿ƒæ¨¡å—ä¸å˜ï¼‰ | è¿‡åº¦æŠ½è±¡ä¼šå¯¼è‡´ä»£ç å†—ä½™ |
| æ–°åŠŸèƒ½é€šè¿‡æ’ä»¶å¼å¼€å‘å¿«é€Ÿä¸Šçº¿  | ä¸é€‚ç”¨äºæå°‘å˜åŒ–çš„åœºæ™¯ |

**é»„é‡‘å‡†åˆ™**ï¼š

> åœ¨**ç¬¬ä¸‰æ¬¡é‡åˆ°ç›¸åŒç±»å‹çš„éœ€æ±‚å˜æ›´**æ—¶è¿›è¡ŒæŠ½è±¡  
> ï¼ˆå‚è€ƒï¼š_"Three Strikes and You Refactor"_ åŸåˆ™ï¼‰

* * *

### æ€»ç»“ï¼šå¦‚ä½•ç†è§£â€œä¿®æ”¹å…³é—­â€

| åœºæ™¯         | æ˜¯å¦è¿å OCP     | åŸå›                                   |
|------------|-------------|-------------------------------------|
| ä¿®æ”¹æ ¸å¿ƒç±»å†…éƒ¨é€»è¾‘  | âŒ è¿å        | å¯èƒ½å½±å“å·²æœ‰åŠŸèƒ½                            |
| æ–°å¢å®ç°ç±»æ‰©å±•åŠŸèƒ½  | âœ… ç¬¦åˆ        | é€šè¿‡æ·»åŠ ä»£ç å®ç°éœ€æ±‚ï¼Œæ ¸å¿ƒç±»å¦‚ PaymentProcessor æ— éœ€æ”¹åŠ¨ |
| ä¿®å¤åŸºç¡€å·¥å…·ç±» bug | âœ… å…è®¸        | ä¸å±äºä¸šåŠ¡é€»è¾‘æ‰©å±•                           |
| é‡å†™æŠ½è±¡æ¥å£     | âš ï¸ è°¨æ…ï¼ˆè¯­ä¹‰å…¼å®¹ï¼‰ | éœ€ä¿è¯æ‰€æœ‰å®ç°ç±»ä»æ»¡è¶³å¥‘çº¦                       |

**ç»ˆæç­”æ¡ˆ**ï¼š  
å¼€é—­åŸåˆ™ä¸æ˜¯ç¦æ­¢ä¿®æ”¹ä»£ç ï¼Œè€Œæ˜¯**é€šè¿‡æ¶æ„è®¾è®¡å°†ä¿®æ”¹éš”ç¦»åœ¨â€œå˜åŒ–å±‚â€**ï¼ˆå¦‚æ–°å¢`UnionPayStrategy`ï¼‰ï¼Œ  
ä»è€Œä¿æŠ¤â€œç¨³å®šå±‚â€ï¼ˆå¦‚`PaymentProcessor.process()`ï¼‰åƒ**åŸºç¡€è®¾æ–½**ä¸€æ ·åšå›ºå¯é ã€‚

è¿™å°±åƒå‡çº§æ‰‹æœº APPï¼š

* **æ‰©å±•å¼€æ”¾** â†’ å®‰è£…æ–° APP å¢åŠ åŠŸèƒ½ï¼ˆæ— éœ€æ‹†è§£æ‰‹æœºç¡¬ä»¶ï¼‰

* **ä¿®æ”¹å…³é—­** â†’ æ‰‹æœºç¡¬ä»¶æœ¬èº«ä¿æŒç¨³å®š

### ä¸ç­–ç•¥æ¨¡å¼çš„å…³è”

**å¼€é—­åŸåˆ™ï¼ˆOCPï¼‰å’Œç­–ç•¥æ¨¡å¼æœ¬è´¨ä¸Šæ˜¯ç†å¿µä¸å®ç°çš„å…³ç³»**â€”â€”ç­–ç•¥æ¨¡å¼æ˜¯å®è·µ OCP æœ€å…¸å‹çš„ä»£ç è®¾è®¡æ‰‹æ®µä¹‹ä¸€ã€‚ä¸‹é¢é€šè¿‡å¯¹æ¯”åˆ†ææ­ç¤ºå®ƒä»¬çš„å…³è”ï¼š

#### ä¸€ã€æ ¸å¿ƒå…³ç³»å›¾è§£

![](https://pic1.imgdb.cn/item/6840ff6558cb8da5c82d568b.png)

#### äºŒã€ç­–ç•¥æ¨¡å¼å¦‚ä½•å®ç° OCP

##### ç­–ç•¥æ¨¡å¼çš„ä¸‰è¦ç´ 

| ç»„ä»¶   | ä½œç”¨                          | OCP è´¡çŒ®ç‚¹        |
|------|-----------------------------|----------------|
| ç­–ç•¥æ¥å£ | å®šä¹‰è¡Œä¸ºæŠ½è±¡ï¼ˆå¦‚ PaymentStrategyï¼‰   | æ‰©å±•ç‚¹ï¼šæ–°ç­–ç•¥å®ç°æ­¤æ¥å£å³å¯ |
| å…·ä½“ç­–ç•¥ | å®ç°ä¸åŒç®—æ³•ï¼ˆå¦‚ AlipayStrategyï¼‰    | æ‰©å±•å•å…ƒï¼šæ–°å¢ç­–ç•¥=æ–°å¢ç±»  |
| ä¸Šä¸‹æ–‡ç±» | æŒæœ‰ç­–ç•¥å¹¶æ‰§è¡Œï¼ˆå¦‚ PaymentProcessorï¼‰ | ç¨³å®šæ ¸å¿ƒï¼šæ°¸ä¸ä¿®æ”¹ä¸šåŠ¡ä¸»é€»è¾‘ |

#### OCP è½åœ°æµç¨‹

1. **éš”ç¦»å˜åŒ–ç‚¹** â†’ å°†æ”¯ä»˜æ–¹å¼æŠ½è±¡ä¸ºæ¥å£

2. **å°è£…è¡Œä¸º** â†’ æ¯ç§æ”¯ä»˜ä½œä¸ºç‹¬ç«‹ç­–ç•¥ç±»

3. **å§”æ‰˜æ‰§è¡Œ** â†’ ä¸Šä¸‹æ–‡ç±»è°ƒç”¨ç­–ç•¥æ¥å£

4. **æ‰©å±•åŠŸèƒ½** â†’ **æ–°å¢ç­–ç•¥ç±»**è€Œéä¿®æ”¹ä¸Šä¸‹æ–‡

#### ä¸‰ã€å¯¹æ¯”ï¼šOCP æ˜¯ç›®æ ‡ï¼Œç­–ç•¥æ¨¡å¼æ˜¯å·¥å…·

| ç»´åº¦   | å¼€é—­åŸåˆ™ (OCP)         | ç­–ç•¥æ¨¡å¼ (Strategy Pattern) |
|------|--------------------|-------------------------|
| æ€§è´¨   | **è®¾è®¡åŸåˆ™**ï¼ˆæŠ½è±¡ç†å¿µï¼‰         | **è®¾è®¡æ¨¡å¼**ï¼ˆå…·ä½“å®ç°æ¨¡æ¿ï¼‰            |
| å…³æ³¨ç‚¹  | æ¶æ„çº§ï¼šæ¨¡å—å¦‚ä½•åº”å¯¹å¤–éƒ¨å˜åŒ–     | ä»£ç çº§ï¼šå¦‚ä½•ç»„ç»‡ç±»ä¸å¯¹è±¡äº¤äº’          |
| å®ç°æ–¹å¼ | å¯é€šè¿‡å¤šç§æ¨¡å¼å®ç°ï¼ˆç­–ç•¥/è§‚å¯Ÿè€…ç­‰ï¼‰ | é€šè¿‡æ¥å£+å¤šæ€å®ç°è¡Œä¸ºåŠ¨æ€æ›¿æ¢         |
| å…¸å‹åœºæ™¯ | æ”¯ä»˜æ‰©å±•/é€šçŸ¥æ¸ é“åˆ‡æ¢/ç®—æ³•æ›´æ–°   | éœ€è¦è¿è¡Œæ—¶åˆ‡æ¢ç®—æ³•çš„åœºæ™¯            |

#### å››ã€ç­–ç•¥æ¨¡å¼ä¹‹å¤–çš„ OCP å®ç°æ–¹å¼

OCP ä¸å±€é™äºç­–ç•¥æ¨¡å¼ï¼Œå…¶ä»–å¸¸è§å®ç°æ‰‹æ®µåŒ…æ‹¬ï¼š

##### 1. è§‚å¯Ÿè€…æ¨¡å¼

```python
# å¼€æ”¾æ‰©å±•ï¼šä»»æ„æ–°å¢è§‚å¯Ÿè€…
class Newsletter:
    def __init__(self):
        self._subscribers = []

    def add_subscriber(self, subscriber):  # æ‰©å±•ç‚¹
        self._subscribers.append(subscriber)

    def publish(self, msg):
        for sub in self._subscribers:
            sub.receive(msg)  # æ ¸å¿ƒé€»è¾‘ä¸ä¿®æ”¹

class EmailSubscriber:
    def receive(self, msg):
        print(f"é‚®ä»¶å‘é€: {msg}")

# æ‰©å±•æ–°è§‚å¯Ÿè€…æ— éœ€ä¿®æ”¹Newsletter
class SMSSubscriber:
    def receive(self, msg):
        print(f"çŸ­ä¿¡å‘é€: {msg}")
        
```

##### 2. è£…é¥°å™¨æ¨¡å¼

```python

class DataFetcher:
    def fetch(self):
        return "åŸå§‹æ•°æ®"

# æ‰©å±•åŠŸèƒ½é€šè¿‡è£…é¥°å™¨å åŠ 
class CacheDecorator:
    def __init__(self, fetcher):
        self._fetcher = fetcher
        self._cache = None

    def fetch(self):  # ä¸ä¿®æ”¹åŸç±»ä»£ç 
        if not self._cache:
            self._cache = self._fetcher.fetch()
        return f"[ç¼“å­˜] {self._cache}"

# ä½¿ç”¨
fetcher = CacheDecorator(DataFetcher())
print(fetcher.fetch())  # [ç¼“å­˜] åŸå§‹æ•°æ®

```

#### 3. æ’ä»¶æ¶æ„

```python
# æ ¸å¿ƒç³»ç»Ÿæ‰«æå¹¶åŠ è½½æ’ä»¶
class PluginSystem:
    def __init__(self):
        self.plugins = []

    def load_plugins(self):
        # åŠ¨æ€å‘ç°æ’ä»¶ï¼ˆæ— éœ€ä¿®æ”¹ä»£ç ï¼‰
        self.plugins = discover_plugins()  

    def run(self):
        for plugin in self.plugins:
            plugin.execute()  # æ ¸å¿ƒæ‰§è¡Œé€»è¾‘ç¨³å®š
```

#### äº”ã€å…³é”®ç»“è®ºï¼šOCP ä¸ç­–ç•¥æ¨¡å¼çš„å…³ç³»

1. **ç­–ç•¥æ¨¡å¼æ˜¯ OCP çš„â€œé‡‘ç‰Œå®è·µè€…â€**

    * å½“å˜åŒ–ç‚¹æ˜¯**ç®—æ³•æˆ–ç­–ç•¥**æ—¶ï¼ˆå¦‚æ”¯ä»˜/æ’åºæ–¹å¼ï¼‰ï¼Œä¼˜å…ˆé€‰æ‹©ç­–ç•¥æ¨¡å¼

2. **OCP çš„å®ç°ä¸å”¯ä¸€**

    * æ ¹æ®åœºæ™¯é€‰æ‹©åˆé€‚æ¨¡å¼ï¼š

        * è¡Œä¸ºæ‰©å±• â†’ **ç­–ç•¥æ¨¡å¼**

        * äº‹ä»¶å“åº” â†’ **è§‚å¯Ÿè€…æ¨¡å¼**

        * åŠŸèƒ½å åŠ  â†’ **è£…é¥°å™¨æ¨¡å¼**

        * ç³»ç»Ÿæ‰©å±• â†’ **æ’ä»¶æ¶æ„**

3. **è¿å OCP çš„ä¿¡å·**  
    å½“å‡ºç°ä»¥ä¸‹ä»£ç æ—¶ï¼Œæ„å‘³ç€å¯èƒ½éœ€å¼•å…¥ç­–ç•¥æ¨¡å¼ï¼š

    ```python
    if type == "A": do_A()
    elif type == "B": do_B()  # æ¯æ–°å¢ç±»å‹éƒ½éœ€ä¿®æ”¹æ­¤å¤„

    ```

#### å…­ã€ç»¼åˆç¤ºä¾‹ï¼šç”¨ç­–ç•¥æ¨¡å¼å®è·µ OCP

å‡è®¾éœ€è¦è®¡ç®—ä¸åŒå›½å®¶çš„ç¨è´¹ï¼š

```python
# ç­–ç•¥æ¥å£ï¼ˆå¼€æ”¾æ‰©å±•çš„åŸºçŸ³ï¼‰
class TaxStrategy(ABC):
    @abstractmethod
    def calculate(self, amount: float) -> float:
        pass

# å…·ä½“ç­–ç•¥ï¼ˆæ‰©å±•å•å…ƒï¼‰
class USATaxStrategy(TaxStrategy):
    def calculate(self, amount):
        return amount * 0.08  # ç¾å›½ç¨ç‡

class ChinaTaxStrategy(TaxStrategy):
    def calculate(self, amount):
        return amount * 0.06  # ä¸­å›½ç¨ç‡

# ä¸Šä¸‹æ–‡ç±»ï¼ˆå¯¹ä¿®æ”¹å…³é—­çš„æ ¸å¿ƒï¼‰
class OrderProcessor:
    def __init__(self, tax_strategy: TaxStrategy):
        self.tax_strategy = tax_strategy

    def process_order(self, amount):
        tax = self.tax_strategy.calculate(amount)  # ç¨³å®šä¸å˜
        print(f"ç¨é¢: {tax:.2f}")

# æ‰©å±•æ–°å›½å®¶ï¼ˆæ— éœ€ä¿®æ”¹OrderProcessorï¼‰
class JapanTaxStrategy(TaxStrategy):
    def calculate(self, amount):
        return amount * 0.1  # æ—¥æœ¬ç¨ç‡

# ä½¿ç”¨
processor = OrderProcessor(JapanTaxStrategy())
processor.process_order(100)  # ç¨é¢: 10.00

```

### æ€»ç»“ï¼šè®¾è®¡åŸåˆ™ä¸æ¨¡å¼çš„å…±ç”Ÿå…³ç³»

| è®¾è®¡åŸåˆ™ | å®ç°è¯¥åŸåˆ™çš„å…¸å‹æ¨¡å¼   | è§£å†³çš„æ ¸å¿ƒé—®é¢˜     |
|------|--------------|-------------|
| å¼€é—­åŸåˆ™ | ç­–ç•¥æ¨¡å¼/è§‚å¯Ÿè€…/è£…é¥°å™¨ | åŠŸèƒ½æ‰©å±•ä¸æ”¹åŠ¨æ ¸å¿ƒä»£ç  |
| ä¾èµ–å€’ç½® | ä¾èµ–æ³¨å…¥/é€‚é…å™¨æ¨¡å¼   | è§£è€¦é«˜å±‚æ¨¡å—ä¸åº•å±‚å®ç° |
| å•ä¸€èŒè´£ | å¤–è§‚æ¨¡å¼/ä»£ç†æ¨¡å¼    | æ‹†åˆ†è‡ƒè‚¿ç±»çš„èŒè´£    |

**æœ€ç»ˆå›ç­”**ï¼š  
ç­–ç•¥æ¨¡å¼æ˜¯**å®ç°å¼€é—­åŸåˆ™æœ€ç›´è§‚çš„å·¥å…·**ï¼Œå®ƒé€šè¿‡å°†å¯å˜è¡Œä¸ºæŠ½è±¡ä¸ºæ¥å£ï¼Œä½¿å¾—æ–°å¢åŠŸèƒ½åªéœ€æ‰©å±•æ–°ç±»è€Œéä¿®æ”¹å·²æœ‰ç±»ã€‚  
ä½† OCP ä½œä¸ºåŸåˆ™æ›´å…·æ™®é€‚æ€§â€”â€”æ‚¨å¯ä»¥ç”¨ä»»ä½•åˆç†æ¶æ„å®ç°â€œå¼€æ”¾æ‰©å±•ï¼Œå°é—­ä¿®æ”¹â€çš„ç›®æ ‡ï¼Œç­–ç•¥æ¨¡å¼åªæ˜¯å…¶ä¸­ä¸€ç§**ä¼˜é›…çš„ä»£ç ç»„ç»‡å½¢å¼**ã€‚

## 3. LSPï¼šé‡Œæ°æ›¿æ¢åŸåˆ™

**è¯¯åŒº**ï¼šè®¤ä¸º"åªè¦ç»§æ‰¿å°±æ˜¯ LSP"  
**æ­£è§£**ï¼šå­ç±»å¿…é¡»ä¿æŒçˆ¶ç±»è¡Œä¸ºçº¦å®š

```python
# è¿åLSPï¼šæ­£æ–¹å½¢é‡å†™setterç ´åçŸ©å½¢è¡Œä¸º
class Rectangle:
    def __init__(self, w, h):
        self.width = w
        self.height = h
    
    @property
    def area(self):
        return self.width * self.height

class Square(Rectangle):
    def __init__(self, side):
        super().__init__(side, side)
    
    @Rectangle.width.setter  # ç ´åçˆ¶ç±»å¥‘çº¦
    def width(self, value):
        self._width = self._height = value

# ä½¿ç”¨ç¤ºä¾‹ï¼ˆä¼šå‡ºé”™ï¼‰
rect = Square(5)
rect.width = 10  # é¢„æœŸé¢ç§¯=50ï¼Œå®é™…=100ï¼ˆè¡Œä¸ºä¸ä¸€è‡´ï¼‰
```

é‡Œæ°æ›¿æ¢åŸåˆ™ï¼ˆLSPï¼‰çš„æ ¸å¿ƒçŸ›ç›¾ç‚¹ï¼š**â€œå®Œå…¨æ›¿æ¢â€ä¸æ˜¯æŒ‡å­ç±»æ–¹æ³•å®ç°å¿…é¡»ä¸çˆ¶ç±»ç›¸åŒï¼Œè€Œæ˜¯å¼ºè°ƒå­ç±»å¿…é¡»éµå®ˆçˆ¶ç±»çš„è¡Œä¸ºå¥‘çº¦**ã€‚ä¸‹é¢é€šè¿‡ä»£ç ç¤ºä¾‹å’Œè®¾è®¡å“²å­¦å½»åº•è§£æè¿™ä¸ªåŸåˆ™ï¼š

### ä¸€ã€LSP æœ¬è´¨ï¼šè¡Œä¸ºå¥‘çº¦çš„ç»§æ‰¿

| å…³é”®æ¦‚å¿µ            | å«ä¹‰                                |
|-----------------|-----------------------------------|
| è¯­æ³•æ›¿æ¢            | å­ç±»æ‹¥æœ‰çˆ¶ç±»æ‰€æœ‰æ–¹æ³•ç­¾åï¼ˆå‚æ•°/è¿”å›å€¼ç±»å‹å…¼å®¹ï¼‰ â†’ ç¼–è¯‘å™¨ä¸æŠ¥é”™ |
| è¡Œä¸ºå¥‘çº¦æ›¿æ¢          | å­ç±»æ–¹æ³•éœ€æ»¡è¶³ï¼š  1. å‰ç½®æ¡ä»¶**ä¸å¼ºäº**çˆ¶ç±»<br>2. åç½®æ¡ä»¶**ä¸å¼±äº**çˆ¶ç±»<br>3. ä¸ä¿®æ”¹çˆ¶ç±»ç¦æ­¢ä¿®æ”¹çš„çŠ¶æ€                        |

### äºŒã€è¿å LSP çš„ç»å…¸åä¾‹

#### åœºæ™¯ï¼šæ­£æ–¹å½¢(Square)ç»§æ‰¿é•¿æ–¹å½¢(Rectangle)

```python

class Rectangle:
    def __init__(self, width, height):
        self._width = width
        self._height = height
    
    def set_width(self, w):  # å¥‘çº¦ï¼šå¯ç‹¬ç«‹ä¿®æ”¹å®½
        self._width = w
    
    def set_height(self, h): # å¥‘çº¦ï¼šå¯ç‹¬ç«‹ä¿®æ”¹é«˜
        self._height = h
    
    def area(self):
        return self._width * self._height

# æ­£æ–¹å½¢"æ˜¯"é•¿æ–¹å½¢ï¼Ÿ æ•°å­¦æˆç«‹ï¼Œç¼–ç¨‹è¿åLSPï¼
class Square(Rectangle):
    def set_width(self, w):
        super().set_width(w)
        super().set_height(w)  # å¼ºåˆ¶ä¿®æ”¹é«˜ â†’ ç ´åçˆ¶ç±»å¥‘çº¦ï¼
    
    def set_height(self, h):
        super().set_height(h)
        super().set_width(h)   # å¼ºåˆ¶ä¿®æ”¹å®½ â†’ ç ´åçˆ¶ç±»å¥‘çº¦ï¼

# æµ‹è¯•å‡½æ•°ï¼ˆé€‚ç”¨äºä»»ä½•Rectangleå­ç±»ï¼‰
def test_resize(rect: Rectangle):
    original_area = rect.area()
    rect.set_width(10)          # é¢„æœŸï¼šåªä¿®æ”¹å®½
    rect.set_height(20)         # é¢„æœŸï¼šåªä¿®æ”¹é«˜
    expected = original_area * 2 # é¢„æœŸé¢ç§¯å˜ä¸º2å€ï¼Ÿ âŒ
    assert rect.area() == expected

# é•¿æ–¹å½¢æµ‹è¯•é€šè¿‡
rect = Rectangle(5, 5)
test_resize(rect)  # âœ…

# æ­£æ–¹å½¢æµ‹è¯•å´©æºƒ
square = Square(5, 5)
test_resize(square)  # âŒ AssertionError: 200 != 50 

```

**LSP è¿è§„åˆ†æ**ï¼š

1. çˆ¶ç±»å¥‘çº¦ï¼š`set_width()` **åªä¿®æ”¹å®½åº¦**

2. å­ç±»è¡Œä¸ºï¼š`set_width()` **åŒæ—¶ä¿®æ”¹é«˜åº¦** â†’ è¿åå‰ç½®æ¡ä»¶

3. å¯¼è‡´ç»“æœï¼šé€šç”¨å‡½æ•°`test_resize()`å¯¹å­ç±»äº§ç”Ÿæ„å¤–è¡Œä¸º

### ä¸‰ã€LSP çš„ä¸‰å¤§æ ¸å¿ƒå¥‘çº¦

#### 1. å‰ç½®æ¡ä»¶ (Preconditions)

> å­ç±»æ–¹æ³•**ä¸èƒ½å¼ºåŒ–**è¾“å…¥æ¡ä»¶ï¼ˆå‚æ•°é™åˆ¶æ›´ä¸¥æ ¼ï¼‰

```python

# çˆ¶ç±»å¥‘çº¦ï¼šæ¥å—ä»»æ„æ­£æ•´æ•°
class PaymentService:
    def pay(self, amount: int):
        assert amount > 0, "é‡‘é¢éœ€>0"
        ...

# âœ… åˆæ³•å­ç±»ï¼šå‰ç½®æ¡ä»¶æ›´å®½æ¾ï¼ˆå®é™…ä»æ»¡è¶³çˆ¶ç±»æ¡ä»¶ï¼‰
class DiscountPayment(PaymentService):
    def pay(self, amount: int):  # ä¸æ£€æŸ¥amount>0 â†’ ä»æ»¡è¶³çˆ¶ç±»æ¡ä»¶
        ...

# âŒ éæ³•å­ç±»ï¼šå¼ºåŒ–å‰ç½®æ¡ä»¶
class StrictPayment(PaymentService):
    def pay(self, amount: int):
        assert amount > 100, "é‡‘é¢éœ€>100"  # å¼ºåŒ–æ¡ä»¶ â†’ è¿åLSP
        super().pay(amount)
        
```

#### 2. åç½®æ¡ä»¶ (Postconditions)

> å­ç±»æ–¹æ³•**ä¸èƒ½å¼±åŒ–**è¾“å‡ºä¿è¯ï¼ˆè¿”å›å€¼/çŠ¶æ€å˜æ›´ï¼‰

```python

class Database:
    def save(self, data) -> bool:
        # å¥‘çº¦ï¼šè¿”å›Trueè¡¨ç¤ºä¿å­˜æˆåŠŸ
        ...

# âœ… åˆæ³•å­ç±»ï¼šåç½®æ¡ä»¶æ›´å¼ºï¼ˆå¢åŠ æ—¥å¿—ä½†ä»è¿”å›boolï¼‰
class LoggingDatabase(Database):
    def save(self, data) -> bool:
        result = super().save(data)
        log_result(result)  # å¢å¼ºè¡Œä¸º
        return result       # ä»æ»¡è¶³è¿”å›bool

# âŒ éæ³•å­ç±»ï¼šå¼±åŒ–åç½®æ¡ä»¶
class UnreliableDatabase(Database):
    def save(self, data) -> bool:
        if random.random() > 0.5:
            return False   # éšæœºå¤±è´¥ â†’ ç ´å"ä¿å­˜æˆåŠŸ"çš„å¥‘çº¦
        return super().save(data)
        
```

#### 3. ä¸å˜é‡ (Invariants)

> å­ç±»**å¿…é¡»ä¿æŒ**çˆ¶ç±»å®šä¹‰çš„çº¦æŸæ¡ä»¶

```python

class BankAccount:
    def __init__(self):
        self.balance = 0  # ä¸å˜é‡ï¼šbalance >= 0
    
    def withdraw(self, amount):
        if self.balance - amount < 0:
            raise ValueError("ä½™é¢ä¸è¶³")
        self.balance -= amount

# âœ… åˆæ³•å­ç±»ï¼šç»´æŒä½™é¢>=0
class SavingsAccount(BankAccount):
    def withdraw(self, amount):
        if self.balance - amount < 100:  # å¢åŠ é™åˆ¶ä½†ä»æ»¡è¶³>=0
            raise ValueError("éœ€ä¿ç•™è‡³å°‘100å…ƒ")
        super().withdraw(amount)

# âŒ éæ³•å­ç±»ï¼šç ´åä¸å˜é‡
class OverdraftAccount(BankAccount):
    def withdraw(self, amount):
        self.balance -= amount  # å…è®¸è´Ÿä½™é¢ â†’ ç ´åbalance>=0!
        
```

### å››ã€æ­£ç¡®å®è·µï¼šé£è¡Œå™¨æ§åˆ¶ç¤ºä¾‹

```python

class Aircraft:
    def take_off(self):
        """å¥‘çº¦ï¼š1. å¯åŠ¨å¼•æ“ 2. é€Ÿåº¦>200km/h 3. è¿”å›çˆ¬å‡é«˜åº¦"""
        self._start_engines()
        self._accelerate_to(250)
        return self._climb()
    
    def _start_engines(self): ...
    def _accelerate_to(self, speed): ...
    def _climb(self) -> int: ...

# âœ… åˆæ³•å­ç±»ï¼šå¢å¼ºåŠŸèƒ½ä½†ä¸ç ´åå¥‘çº¦
class Jet(Aircraft):
    def _climb(self) -> int:
        # æ›´å¿«çˆ¬å‡ â†’ æ»¡è¶³è¿”å›é«˜åº¦çš„åç½®æ¡ä»¶
        return super()._climb() * 2  

# âœ… åˆæ³•å­ç±»ï¼šæ”¾å®½åŠ é€Ÿé™åˆ¶ï¼ˆå‰ç½®æ¡ä»¶æ›´å¼±ï¼‰
class Glider(Aircraft):
    def _accelerate_to(self, speed):
        # æ»‘ç¿”æœºåªéœ€150km/h â†’ ä»æ»¡è¶³çˆ¶ç±»é€Ÿåº¦>200çš„è¦æ±‚
        if speed > 150:  
            super()._accelerate_to(speed)

# âŒ éæ³•å­ç±»ç¤ºä¾‹ï¼ˆå‡è®¾å­˜åœ¨ï¼‰
class BrokenAircraft(Aircraft):
    def take_off(self):
        self._start_engines()
        # å¿˜è®°åŠ é€Ÿ â†’ è¿å"é€Ÿåº¦>200"çš„éšå«å¥‘çº¦
        return 0  # è¿”å›é«˜åº¦0 â†’ è¿åè¿”å›çˆ¬å‡é«˜åº¦çš„åç½®æ¡ä»¶
```

### äº”ã€LSP çš„ç»ˆæç†è§£ï¼šå¯æ›¿æ¢æ€§æ˜¯è¡Œä¸ºå¥‘çº¦

| æé—®              | ç­”æ¡ˆ                          |
|-----------------|-----------------------------|
| å­ç±» run()å¿…é¡»å’Œçˆ¶ç±»ç›¸åŒï¼Ÿ | å¦ï¼å­ç±»å¯ä¼˜åŒ–ç®—æ³•ï¼ˆå¦‚æ›´å¿«çš„æ’åºå®ç°ï¼‰         |
| ä½•æ—¶å…è®¸ä¿®æ”¹æ–¹æ³•é€»è¾‘ï¼Ÿ     | å½“æ»¡è¶³ï¼š1. æ¥å—æ›´å®½æ³›çš„è¾“å…¥<br>  2. è¿”å›æ›´ç²¾ç¡®çš„ç»“æœ <br>  3. ä¸ç ´åçˆ¶ç±»çº¦æŸ                     |
| å¦‚ä½•éªŒè¯ LSPï¼Ÿ        | ç¼–å†™é€‚ç”¨äºçˆ¶ç±»çš„å•å…ƒæµ‹è¯• â†’ æ‰€æœ‰å­ç±»å¿…é¡»èƒ½é€šè¿‡è¯¥æµ‹è¯• |

### å…­ã€LSP ä¸è®¾è®¡æ¨¡å¼çš„å…³è”

| **è®¾è®¡æ¨¡å¼** | **LSP åº”ç”¨åœºæ™¯**       | **æ”¶ç›Š**    |
|----------|--------------------|-----------|
| **æ¨¡æ¿æ–¹æ³•** | å­ç±»é‡å†™é’©å­æ–¹æ³•ä½†ä¸æ”¹å˜ç®—æ³•éª¨æ¶   | ä¿è¯æµç¨‹å¥‘çº¦ä¸€è‡´æ€§ |
| **ç­–ç•¥æ¨¡å¼** | ä¸åŒç­–ç•¥å®ç°åŒä¸€æ¥å£ â†’ äº’ä¸º LSP | å®‰å…¨æ›¿æ¢ç®—æ³•ç­–ç•¥  |
| **ç»„åˆæ¨¡å¼** | å¶å­èŠ‚ç‚¹ä¸å¤åˆèŠ‚ç‚¹å®ç°ç›¸åŒæ¥å£    | ç»Ÿä¸€å¤„ç†æ ‘å½¢ç»“æ„  |

### æ€»ç»“ï¼šLSP çš„å®è·µç²¾é«“

1. **â€œå¯æ›¿æ¢â€ â‰  â€œå®Œå…¨ä¸€è‡´â€**  
    å­ç±»å¯ä»¥ï¼š

    * ä¼˜åŒ–æ€§èƒ½ï¼ˆå¦‚æ›´å¿«çš„`run()`å®ç°ï¼‰

    * å¢åŠ åŠŸèƒ½ï¼ˆå¦‚æ·»åŠ æ—¥å¿—è®°å½•ï¼‰

    * æ”¾å®½è¾“å…¥é™åˆ¶ï¼ˆå¦‚æ¥å—æ›´å¤šæ•°æ®ç±»å‹ï¼‰

2. **ç¦æ­¢è¡Œä¸º**ï¼š

    * ä¿®æ”¹çˆ¶ç±»ç¦æ­¢çš„çŠ¶æ€ï¼ˆå¦‚é“¶è¡Œè´¦æˆ·è´Ÿä½™é¢ï¼‰

    * æŠ›å‡ºçˆ¶ç±»æœªå£°æ˜çš„å¼‚å¸¸ç±»å‹

    * è¿”å›ä¸ç¬¦åˆçˆ¶ç±»é¢„æœŸçš„ç»“æœç±»å‹

3. **é»„é‡‘å‡†åˆ™**ï¼š

    > å½“ä½ åœ¨å­ç±»ä¸­é‡å†™æ–¹æ³•æ—¶ï¼Œ**å‡è£…è‡ªå·±æ˜¯çˆ¶ç±»**  
    > â€”â€”ä½ çš„è¡Œä¸ºå¿…é¡»è®©è°ƒç”¨è€…æ— æ³•åˆ†è¾¨å®ƒé¢å¯¹çš„æ˜¯çˆ¶ç±»è¿˜æ˜¯å­ç±»

**è°ƒç”¨æ–¹åªéœ€ä¾èµ–çˆ¶ç±»å¥‘çº¦**ï¼Œä»»ä½•å­ç±»å®ä¾‹éƒ½åº”å¦‚çˆ¶ç±»èˆ¬å·¥ä½œã€‚è¿™æ‰æ˜¯â€œå®Œå…¨æ›¿æ¢â€çš„çœŸè°›ï¼

## 4. ISPï¼šæ¥å£éš”ç¦»åŸåˆ™

**è¯¯åŒº**ï¼šè®¤ä¸º"æ¥å£è¶Šå°è¶Šå¥½"  
**æ­£è§£**ï¼šæŒ‰å®¢æˆ·ç«¯éœ€æ±‚æ‹†åˆ†è‡ƒè‚¿æ¥å£

```python
# è¿åISPï¼šå¤šåŠŸèƒ½æ¥å£å¼ºè¿«å®ç°ä¸éœ€è¦çš„æ–¹æ³•
class Worker(ABC):
    @abstractmethod
    def work(self): ...
    @abstractmethod
    def eat(self): ...  # æœºå™¨äººä¸éœ€è¦æ­¤æ–¹æ³•

class HumanWorker(Worker):
    def work(self): ...
    def eat(self): ...

class RobotWorker(Worker):
    def work(self): ...
    def eat(self): ...  # è¢«è¿«å®ç°æ— ç”¨æ–¹æ³•

# éµå¾ªISPï¼šæ‹†åˆ†æ¥å£
class Workable(ABC):
    @abstractmethod
    def work(self): ...

class Eatable(ABC):
    @abstractmethod
    def eat(self): ...

class HumanWorker(Workable, Eatable): ...
class RobotWorker(Workable): ...  # æ— éœ€å®ç°eat

```

## 5. DIPï¼šä¾èµ–å€’ç½®åŸåˆ™

**è¯¯åŒº**ï¼šè®¤ä¸º"DIï¼ˆä¾èµ–æ³¨å…¥ï¼‰å°±æ˜¯ DIP"  
**æ­£è§£**ï¼šé«˜å±‚æ¨¡å—åº”ä¾èµ–æŠ½è±¡ï¼Œè€Œéå…·ä½“å®ç°

```python
# è¿åDIPï¼šé«˜å±‚æ¨¡å—ç›´æ¥ä¾èµ–ä½å±‚ç»†èŠ‚
class LightBulb:
    def turn_on(self): ...
    def turn_off(self): ...

class Switch:
    def __init__(self, bulb: LightBulb):  # ä¾èµ–å…·ä½“ç±»
        self.bulb = bulb
    def operate(self): ...

# éµå¾ªDIPï¼šé€šè¿‡æŠ½è±¡è§£è€¦
class Switchable(ABC):  # æŠ½è±¡æ¥å£
    @abstractmethod
    def turn_on(self): ...
    @abstractmethod
    def turn_off(self): ...

class LightBulb(Switchable): ...  # ä½å±‚å®ç°æŠ½è±¡
class Fan(Switchable): ...        # æ–°å¢è®¾å¤‡ä¸å½±å“Switch

class Switch:
    def __init__(self, device: Switchable):  # ä¾èµ–æŠ½è±¡
        self.device = device
    def operate(self): ...

```

### ä¸€ã€ä¼ ç»Ÿåˆ†å±‚æ¶æ„ï¼šé«˜å±‚ä¾èµ–ä½å±‚

![](https://pic1.imgdb.cn/item/68410cbb58cb8da5c82dcd08.png)

**ä»£ç å®ç°**ï¼š

```python

# ä½å±‚æ¨¡å—ï¼šå…·ä½“å®ç°
class MySQLDatabase:
    def save(self, data):
        print("ä¿å­˜åˆ°MySQLæ•°æ®åº“")

class FileLogger:
    def log(self, message):
        print("æ—¥å¿—å†™å…¥æ–‡ä»¶")

class SmtpEmailSender:
    def send(self, email):
        print("é€šè¿‡SMTPå‘é€é‚®ä»¶")

# é«˜å±‚æ¨¡å—ï¼šç›´æ¥ä¾èµ–å…·ä½“å®ç°
class OrderService:
    def __init__(self):
        self.db = MySQLDatabase()      # ç›´æ¥ä¾èµ–MySQL
        self.logger = FileLogger()     # ç›´æ¥ä¾èµ–æ–‡ä»¶æ—¥å¿—
        self.email = SmtpEmailSender() # ç›´æ¥ä¾èµ–SMTP
    
    def place_order(self, order):
        self.db.save(order)
        self.logger.log("è®¢å•åˆ›å»º")
        self.email.send(order.confirmation)
```

**é—®é¢˜åˆ†æ**ï¼š

1.  **æ•°æ®åº“æ›´æ¢ç¾éš¾**ï¼šæ”¹ç”¨ MongoDBï¼Ÿéœ€ä¿®æ”¹æ‰€æœ‰`OrderService`ä»£ç 
    
2.  **æ—¥å¿—ç³»ç»Ÿå‡çº§**ï¼šæ”¹ç”¨ ELKï¼Ÿéœ€ä¿®æ”¹ä¸šåŠ¡é€»è¾‘
    
3.  **é‚®ä»¶æœåŠ¡åˆ‡æ¢**ï¼šæ”¹ç”¨ SendGridï¼Ÿä¸šåŠ¡ç±»å¿…é¡»è°ƒæ•´
    
4.  **æµ‹è¯•å›°éš¾**ï¼šæ— æ³• Mock æ•°æ®åº“å’Œé‚®ä»¶æœåŠ¡
    

* * *

### äºŒã€ä¾èµ–å€’ç½®æ¶æ„ï¼šå…±åŒä¾èµ–æŠ½è±¡

![](https://pic1.imgdb.cn/item/68410d1258cb8da5c82dce88.png)

**ä»£ç é‡æ„**ï¼š

#### æ­¥éª¤ 1ï¼šå®šä¹‰æŠ½è±¡æ¥å£

```python

from abc import ABC, abstractmethod

# æŠ½è±¡å­˜å‚¨æ¥å£
class DataRepository(ABC):
    @abstractmethod
    def save(self, data): pass

# æŠ½è±¡æ—¥å¿—æ¥å£
class Logger(ABC):
    @abstractmethod
    def log(self, message): pass

# æŠ½è±¡é€šçŸ¥æ¥å£
class Notifier(ABC):
    @abstractmethod
    def send(self, message): pass
    
```

#### æ­¥éª¤ 2ï¼šå®ç°å…·ä½“ä½å±‚æ¨¡å—

```python

# æ•°æ®åº“å®ç°
class MySQLRepository(DataRepository):
    def save(self, data):
        print("ä¿å­˜åˆ°MySQLæ•°æ®åº“")

class MongoDBRepository(DataRepository):
    def save(self, data):
        print("ä¿å­˜åˆ°MongoDBæ•°æ®åº“")

# æ—¥å¿—å®ç°
class FileLogger(Logger):
    def log(self, message):
        print("æ–‡ä»¶æ—¥å¿—:", message)

class CloudLogger(Logger):
    def log(self, message):
        print("äº‘æ—¥å¿—:", message)

# é€šçŸ¥å®ç°
class SmtpNotifier(Notifier):
    def send(self, message):
        print("SMTPå‘é€:", message)

class ApiNotifier(Notifier):
    def send(self, message):
        print("APIå‘é€:", message)
        
```

#### æ­¥éª¤ 3ï¼šé«˜å±‚æ¨¡å—ä¾èµ–æŠ½è±¡

```python

class OrderService:
    # é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥æŠ½è±¡ä¾èµ–
    def __init__(self, 
                 repository: DataRepository, 
                 logger: Logger, 
                 notifier: Notifier):
        self.repository = repository
        self.logger = logger
        self.notifier = notifier
    
    def place_order(self, order):
        self.repository.save(order)    # ä¾èµ–æŠ½è±¡
        self.logger.log("è®¢å•åˆ›å»º")    # ä¾èµ–æŠ½è±¡
        self.notifier.send("ç¡®è®¤é‚®ä»¶") # ä¾èµ–æŠ½è±¡
```
### ä¸‰ã€ä¾èµ–å€’ç½®çš„å¨åŠ›å±•ç¤º

#### åœºæ™¯ 1ï¼šæ— ç¼åˆ‡æ¢æ•°æ®åº“

```python
# ä½¿ç”¨MySQL
mysql_service = OrderService(
    MySQLRepository(),
    FileLogger(),
    SmtpNotifier()
)

# åˆ‡æ¢ä¸ºMongoDBï¼ˆä¸šåŠ¡ä»£ç é›¶ä¿®æ”¹ï¼‰
mongo_service = OrderService(
    MongoDBRepository(),  # ä»…æ›´æ¢å®ç°
    FileLogger(),
    SmtpNotifier()
)
```
#### åœºæ™¯ 2ï¼šåŠ¨æ€ç»„åˆæœåŠ¡

```python

# ç”Ÿäº§ç¯å¢ƒï¼šMySQL + äº‘æ—¥å¿— + APIé‚®ä»¶
prod_service = OrderService(
    MySQLRepository(),
    CloudLogger(),
    ApiNotifier()
)

# æµ‹è¯•ç¯å¢ƒï¼šæ¨¡æ‹Ÿå­˜å‚¨ + æ§åˆ¶å°æ—¥å¿—
class MockRepository(DataRepository):
    def save(self, data): print("æµ‹è¯•å­˜å‚¨")

class ConsoleLogger(Logger):
    def log(self, msg): print("æ§åˆ¶å°:", msg)

test_service = OrderService(
    MockRepository(),
  
* * *  ConsoleLogger(),
    None  # æµ‹è¯•ä¸éœ€è¦é‚®ä»¶
)
```

#### åœºæ™¯ 3ï¼šæ‰©å±•æ–°åŠŸèƒ½

```python

# æ–°å¢Redisç¼“å­˜å®ç°
class RedisRepository(DataRepository):
    def save(self, data): 
        print("ä¿å­˜åˆ°Redis")

# ä¸šåŠ¡å±‚æ— éœ€ä»»ä½•ä¿®æ”¹
redis_service = OrderService(
    RedisRepository(),
    CloudLogger(),
    ApiNotifier()
)
```

### å››ã€DIP çš„ä¸‰å¤§å®ç°æœºåˆ¶

#### 1. ä¾èµ–æ³¨å…¥ (Dependency Injection)

```python
# é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥
service = OrderService(repo, logger, notifier)

# é€šè¿‡å±æ€§æ³¨å…¥
service.repository = MongoDBRepository()
```
#### 2. ä¾èµ–æŸ¥æ‰¾ (Dependency Lookup)

```python
class ServiceFactory:
    @staticmethod
    def create_repository():
        return MongoDBRepository() if config.use_mongo else MySQLRepository()

# é«˜å±‚æ¨¡å—è·å–ä¾èµ–
repo = ServiceFactory.create_repository()
```

#### 3. æœåŠ¡å®šä½å™¨ (Service Locator)

```python

class ServiceLocator:
    _services = {}
    
    @classmethod
    def register(cls, interface, impl):
        cls._services[interface] = impl
        
    @classmethod
    def resolve(cls, interface):
        return cls._services[interface]

# é…ç½®ä¾èµ–
ServiceLocator.register(DataRepository, MongoDBRepository)
ServiceLocator.register(Logger, CloudLogger)

# é«˜å±‚æ¨¡å—ä½¿ç”¨
class OrderService:
    def __init__(self):
        self.repo = ServiceLocator.resolve(DataRepository)
        self.logger = ServiceLocator.resolve(Logger)
```

### äº”ã€DIP çš„å®è·µæ”¶ç›Š

| **ä¼˜åŠ¿**    | **å…·ä½“è¡¨ç°**               |
|-----------|------------------------|
| **æŠ€æœ¯æ— å…³æ€§** | ä¸šåŠ¡é€»è¾‘ä¸ä¾èµ–å…·ä½“æŠ€æœ¯æ ˆï¼ˆå¯éšæ—¶æ›´æ¢æ•°æ®åº“ï¼‰ |
| **å¹¶è¡Œå¼€å‘**  | å›¢é˜Ÿå¯åŒæ—¶å¼€å‘é«˜å±‚æ¨¡å—å’Œä½å±‚å®ç°       |
| **æµ‹è¯•å‹å¥½**  | è½»æ¾æ³¨å…¥ Mock å¯¹è±¡è¿›è¡Œå•å…ƒæµ‹è¯•       |
| **ç³»ç»Ÿæ‰©å±•æ€§** | æ–°å¢åŠŸèƒ½åªéœ€æ‰©å±•æŠ½è±¡æ¥å£çš„å®ç°ç±»       |
| **éƒ¨ç½²çµæ´»æ€§** | ä¸åŒç¯å¢ƒä½¿ç”¨ä¸åŒå®ç°ï¼ˆå¼€å‘/æµ‹è¯•/ç”Ÿäº§ï¼‰   |

### å…­ã€ä¾èµ–å€’ç½® vs ä¾èµ–æ³¨å…¥

| **æ¦‚å¿µ**         | **æè¿°**          | **å…³ç³»** |
|----------------|-----------------|--------|
| **ä¾èµ–å€’ç½® (DIP)** | è®¾è®¡åŸåˆ™ï¼šé«˜å±‚/ä½å±‚éƒ½ä¾èµ–æŠ½è±¡ | ç›®æ ‡     |
| **ä¾èµ–æ³¨å…¥ (DI)**  | å®ç°æŠ€æœ¯ï¼šå°†ä¾èµ–é¡¹ä»å¤–éƒ¨ä¼ å…¥  | æ‰‹æ®µ     |
| **æ§åˆ¶åè½¬ (IoC)** | è®¾è®¡æ¨¡å¼ï¼šå°†æ§åˆ¶æƒäº¤ç»™å®¹å™¨ç®¡ç† | æ¡†æ¶æ”¯æŒ   |

![](https://pic1.imgdb.cn/item/684110ba58cb8da5c82dd58a.png)

### ä¸ƒã€Python ç‰¹æœ‰å®è·µæŠ€å·§

#### 1. é¸­å­ç±»å‹å®ç°æŠ½è±¡

```python

# ä¸æ˜¾å¼å®šä¹‰æ¥å£ï¼Œä¾é é¸­å­ç±»å‹
class OrderService:
    def __init__(self, repository, logger, notifier):
        self.repository = repository  # åªè¦å®ç°save()
        self.logger = logger          # åªè¦å®ç°log()
        self.notifier = notifier      # åªè¦å®ç°send()

# ä»»æ„å®ç°ç±»
class CustomStorage:
    def save(self, data): ...  # ä¸éœ€è¦ç»§æ‰¿ç‰¹å®šæ¥å£
    
```

#### 2. ä½¿ç”¨ Protocol å®šä¹‰éšå¼æ¥å£

```python
from typing import Protocol

class DataRepository(Protocol):
    def save(self, data) -> None: ...

# ç±»å‹æ£€æŸ¥ä¼šéªŒè¯å®ç°ç±»
def validate_repo(repo: DataRepository): ...
```

#### 3. ä¾èµ–æ³¨å…¥æ¡†æ¶ç¤ºä¾‹

```python
# ä½¿ç”¨injectoråº“
from injector import inject, Module, provider

class DatabaseModule(Module):
    @provider
    def provide_repository(self) -> DataRepository:
        return MongoDBRepository()

class OrderService:
    @inject
    def __init__(self, repo: DataRepository):
        self.repo = repo
```

### ç»ˆææ€»ç»“ï¼šä¾èµ–å€’ç½®çš„æœ¬è´¨

![](https://pic1.imgdb.cn/item/6841112b58cb8da5c82dd59c.png)

**å®è·µç®´è¨€**ï¼š

> å½“ä½ çš„ä¸šåŠ¡ç±»ä¸­å‡ºç° `import pymysql` æˆ– `from redis import Redis` æ—¶ï¼Œ  
> è¿™å°±æ˜¯è¿å DIP çš„çº¢è‰²è­¦æŠ¥ï¼  
> åº”è¯¥ä¾èµ– `from .interfaces import DataRepository` è¿™æ ·çš„æŠ½è±¡ã€‚

é€šè¿‡ä¾èµ–å€’ç½®ï¼Œæ‚¨çš„æ ¸å¿ƒä¸šåŠ¡ä»£ç å°†æˆä¸º**æ°¸æ’ä¸å˜çš„èµ„äº§**ï¼Œè€ŒæŠ€æœ¯å®ç°å±‚åˆ™æ˜¯**å¯éšæ—¶æ›´æ¢çš„æ’ä»¶**ã€‚

## é¢è¯•å¸¸è§é—®é¢˜

1. **SRP vs å†…èšæ€§**  
    SRP å¼ºè°ƒèŒè´£åˆ†ç¦»ï¼Œé«˜å†…èšå¼ºè°ƒç±»å†…å…ƒç´ ç›¸å…³æ€§

2. **OCP å®ç°æ–¹å¼**  
    ç­–ç•¥æ¨¡å¼/æ¨¡æ¿æ–¹æ³•/ä¾èµ–æ³¨å…¥

3. **LSP å…³é”®ç‚¹**  
    å­ç±»ä¸å¼ºåŒ–å‰ç½®æ¡ä»¶ã€ä¸å¼±åŒ–åç½®æ¡ä»¶ã€ä¿æŒä¸å˜é‡

4. **ISP ä¸èƒ–æ¥å£**  
    é¿å…"æ¥å£æ±¡æŸ“"ï¼Œå‡å°‘å®¢æˆ·ç«¯ä¾èµ–å†—ä½™

5. **DIP vs DI**  
    DI æ˜¯ DIP çš„å®ç°æ‰‹æ®µä¹‹ä¸€ï¼Œæ ¸å¿ƒæ˜¯æŠ½è±¡è§£è€¦

> ğŸ’¡ **é¢è¯•æŠ€å·§**ï¼šç»“åˆé¡¹ç›®ç»éªŒè¯´æ˜åŸåˆ™åº”ç”¨ï¼Œå¦‚ï¼š"åœ¨ XX é¡¹ç›®ä¸­ï¼Œé€šè¿‡ DIP+DI è§£è€¦äº†æ”¯ä»˜æ¨¡å—ï¼Œä½¿æ–°å¢æ”¯ä»˜æ–¹å¼æ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç "
