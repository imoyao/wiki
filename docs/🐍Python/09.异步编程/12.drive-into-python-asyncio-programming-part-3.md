---
title: æ·±å…¥ç†è§£ Python å¼‚æ­¥ç¼–ç¨‹ï¼ˆä¸‹ï¼‰
date: 2020-06-18 17:43:49
author: é˜¿é©¹
permalink: /python/drive-into-python-asyncio-programming-part-3/
categories:
  - ğŸPython
  - å¼‚æ­¥ç¼–ç¨‹
tags:
  - å¼‚æ­¥ç¼–ç¨‹
  - Python
  - asyncio
  - å¼‚æ­¥
  - å¹¶å‘
  - åç¨‹
---

## ä¸€ã€GIL å¯¹å¼‚æ­¥ç¼–ç¨‹çš„å½±å“

### 1.1 GIL æ˜¯ä»€ä¹ˆ

å…¨å±€è§£é‡Šå™¨é”ï¼ˆGlobal Interpreter Lockï¼ŒGILï¼‰æ˜¯ CPython è§£é‡Šå™¨çš„ä¸€ä¸ªæœºåˆ¶ï¼Œå®ƒç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡Œ Python å­—èŠ‚ç ã€‚è¿™æ„å‘³ç€åœ¨å¤šæ ¸ CPU ç¯å¢ƒä¸‹ï¼Œå¤šçº¿ç¨‹ç¨‹åºæ— æ³•çœŸæ­£åˆ©ç”¨å¤šæ ¸ä¼˜åŠ¿æ‰§è¡Œè®¡ç®—å¯†é›†å‹ä»»åŠ¡ã€‚

```python
import threading
import time

def cpu_intensive_task():
    count = 0
    for _ in range(10**8):
        count += 1
    return count

# å•çº¿ç¨‹æ‰§è¡Œ
start = time.time()
cpu_intensive_task()
cpu_intensive_task()
print(f"å•çº¿ç¨‹è€—æ—¶: {time.time() - start:.2f}ç§’")  # çº¦10ç§’

# å¤šçº¿ç¨‹æ‰§è¡Œ
start = time.time()
t1 = threading.Thread(target=cpu_intensive_task)
t2 = threading.Thread(target=cpu_intensive_task)
t1.start()
t2.start()
t1.join()
t2.join()
print(f"å¤šçº¿ç¨‹è€—æ—¶: {time.time() - start:.2f}ç§’")  # ä»çº¦10ç§’ï¼ŒGILå¯¼è‡´æ— æ³•å¹¶è¡Œ
```

### 1.2 å¼‚æ­¥ç¼–ç¨‹å¦‚ä½•è§„é¿ GIL é™åˆ¶

å¼‚æ­¥ç¼–ç¨‹é€šè¿‡äº‹ä»¶å¾ªç¯å’Œåç¨‹åœ¨å•çº¿ç¨‹ä¸­è°ƒåº¦ä»»åŠ¡ï¼Œé¿å…äº† GIL çš„å½±å“ï¼š

- **I/O å¯†é›†å‹ä»»åŠ¡**ï¼šåç¨‹åœ¨ I/O é˜»å¡æ—¶é‡Šæ”¾ CPUï¼Œè®©å…¶ä»–åç¨‹æ‰§è¡Œ
- **CPU å¯†é›†å‹ä»»åŠ¡**ï¼šéœ€é…åˆå¤šè¿›ç¨‹æˆ–çº¿ç¨‹æ± æ‰§è¡Œ

```python
import asyncio
import time
from concurrent.futures import ProcessPoolExecutor

# CPUå¯†é›†å‹ä»»åŠ¡æ”¾å…¥è¿›ç¨‹æ± 
async def cpu_task():
    loop = asyncio.get_running_loop()
    result = await loop.run_in_executor(
        ProcessPoolExecutor(), 
        cpu_intensive_task
    )
    return result

# å¼‚æ­¥æ‰§è¡Œä¸¤ä¸ªCPUä»»åŠ¡
start = time.time()
async def main():
    task1 = cpu_task()
    task2 = cpu_task()
    await asyncio.gather(task1, task2)

asyncio.run(main())
print(f"å¼‚æ­¥+è¿›ç¨‹æ± è€—æ—¶: {time.time() - start:.2f}ç§’")  # çº¦5ç§’ï¼Œåˆ©ç”¨å¤šæ ¸
```

## äºŒã€asyncio è¸©å‘ç»éªŒ

### 2.1 å›è°ƒåœ°ç‹±ä¸è§£å†³æ–¹æ¡ˆ

**é—®é¢˜**ï¼šå¤šå±‚å›è°ƒåµŒå¥—å¯¼è‡´ä»£ç å¯è¯»æ€§å·®

```python
# åä¾‹ï¼šå›è°ƒåµŒå¥—
def callback1():
    print("å›è°ƒ1")
    def callback2():
        print("å›è°ƒ2")
        def callback3():
            print("å›è°ƒ3")
        asyncio.get_event_loop().call_soon(callback3)
    asyncio.get_event_loop().call_soon(callback2)
asyncio.get_event_loop().call_soon(callback1)
```

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ async/await é‡æ„

```python
# æ­£ä¾‹ï¼šasync/awaité£æ ¼
async def chain_tasks():
    await asyncio.sleep(0.1)
    print("ä»»åŠ¡1")
    await asyncio.sleep(0.1)
    print("ä»»åŠ¡2")
    await asyncio.sleep(0.1)
    print("ä»»åŠ¡3")

asyncio.run(chain_tasks())
```

### 2.2 å¼‚å¸¸å¤„ç†é™·é˜±

**é—®é¢˜**ï¼šæœªæ•è·çš„å¼‚å¸¸ä¼šå¯¼è‡´äº‹ä»¶å¾ªç¯å´©æºƒ

```python
# åä¾‹ï¼šæœªå¤„ç†å¼‚å¸¸
async def faulty_task():
    raise ValueError("ä»»åŠ¡å‡ºé”™")

async def main():
    task = asyncio.create_task(faulty_task())
    await asyncio.sleep(0.1)  # æœªç­‰å¾…ä»»åŠ¡ï¼Œå¼‚å¸¸æœªæ•è·

# è¿è¡Œä¼šæŠ›å‡ºæœªå¤„ç†çš„å¼‚å¸¸
```

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ try/except æˆ– Task å¼‚å¸¸å¤„ç†

```python
# æ­£ä¾‹ï¼šå¼‚å¸¸å¤„ç†
async def safe_main():
    task = asyncio.create_task(faulty_task())
    try:
        await task
    except ValueError as e:
        print(f"æ•è·å¼‚å¸¸: {e}")

asyncio.run(safe_main())
```

### 2.3 ä»»åŠ¡å–æ¶ˆä¸å½“

**é—®é¢˜**ï¼šå–æ¶ˆä»»åŠ¡æ—¶æœªæ­£ç¡®å¤„ç†èµ„æºé‡Šæ”¾

```python
# åä¾‹ï¼šæœªå¤„ç†å–æ¶ˆ
async def task_with_resource():
    print("è·å–èµ„æº")
    try:
        await asyncio.sleep(10)
    finally:
        print("èµ„æºæœªé‡Šæ”¾")  # ä»»åŠ¡å–æ¶ˆæ—¶ä¸ä¼šæ‰§è¡Œ

async def main():
    task = asyncio.create_task(task_with_resource())
    await asyncio.sleep(0.1)
    task.cancel()
    await task  # ä¼šæŠ›å‡ºCancelledError

# è¿è¡Œä¼šè¾“å‡º"è·å–èµ„æº"ï¼Œä½†èµ„æºæœªé‡Šæ”¾
```

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ try/except æ•è·å–æ¶ˆå¼‚å¸¸

```python
# æ­£ä¾‹ï¼šæ­£ç¡®å¤„ç†å–æ¶ˆ
async def task_with_resource():
    print("è·å–èµ„æº")
    try:
        await asyncio.sleep(10)
    except asyncio.CancelledError:
        print("ä»»åŠ¡å–æ¶ˆï¼Œé‡Šæ”¾èµ„æº")
        raise  # é‡æ–°æŠ›å‡ºå–æ¶ˆå¼‚å¸¸

asyncio.run(main())
```

## ä¸‰ã€ç¼–ç¨‹æ¨¡å‹å¯¹æ¯”åˆ†æ

### 3.1 å›è°ƒã€åç¨‹ã€ç»¿ç¨‹ã€çº¿ç¨‹å¯¹æ¯”

| æ¨¡å‹       | è°ƒåº¦æ–¹å¼       | å¹¶å‘æ”¯æŒ   | ä¼˜ç‚¹                          | ç¼ºç‚¹                          |
|------------|----------------|------------|-------------------------------|-------------------------------|
| **å›è°ƒ**   | äº‹ä»¶é©±åŠ¨       | å•çº¿ç¨‹     | è½»é‡çº§ï¼Œåº•å±‚å®ç°ç®€å•          | ä»£ç å¯è¯»æ€§å·®ï¼Œå›è°ƒåœ°ç‹±        |
| **åç¨‹**   | åä½œå¼å¤šä»»åŠ¡   | å•çº¿ç¨‹     | ä»£ç æ¥è¿‘åŒæ­¥ï¼Œæ€§èƒ½é«˜æ•ˆ        | éœ€è¦è¯­è¨€å±‚é¢æ”¯æŒ              |
| **ç»¿ç¨‹**   | ç”¨æˆ·æ€çº¿ç¨‹     | å•çº¿ç¨‹     | è½»é‡çº§ï¼Œåˆ‡æ¢æˆæœ¬ä½            | éœ€æ¡†æ¶æ”¯æŒï¼Œè°ƒåº¦å¯æ§æ€§å·®      |
| **çº¿ç¨‹**   | æ“ä½œç³»ç»Ÿè°ƒåº¦   | å¤šçº¿ç¨‹     | åŸç”Ÿæ”¯æŒï¼Œé€‚åˆ I/O å’Œ CPU ä»»åŠ¡    | ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€å¤§ï¼ŒGIL é™åˆ¶     |

### 3.2 å¤šè¿›ç¨‹ã€å¤šçº¿ç¨‹ã€åç¨‹é€‚ç”¨åœºæ™¯

| æ¨¡å‹       | é€‚ç”¨åœºæ™¯                          | ç¤ºä¾‹åœºæ™¯                  |
|------------|-----------------------------------|---------------------------|
| **å¤šè¿›ç¨‹** | CPU å¯†é›†å‹ä»»åŠ¡ï¼Œéœ€åˆ©ç”¨å¤šæ ¸          | ç§‘å­¦è®¡ç®—ã€å›¾åƒå¤„ç†        |
| **å¤šçº¿ç¨‹** | I/O å¯†é›†å‹ä»»åŠ¡ï¼Œéœ€é˜»å¡æ“ä½œ          | ç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶è¯»å†™        |
| **åç¨‹**   | é«˜å¹¶å‘ I/O å¯†é›†å‹ä»»åŠ¡ï¼Œéœ€å•çº¿ç¨‹å¤„ç†  | çˆ¬è™«ã€Web æœåŠ¡å™¨ã€æ¶ˆæ¯é˜Ÿåˆ— |

## å››ã€æ¡†æ¶å¯¹æ¯”ä¸æŠ€æœ¯é€‰å‹

### 4.1 Gevent/libevã€uvloop/libuv ä¸ asyncio

| æ¡†æ¶       | åº•å±‚å®ç°       | ç‰¹ç‚¹                          | é€‚ç”¨åœºæ™¯                  |
|------------|----------------|-------------------------------|---------------------------|
| **asyncio**| Python åŸç”Ÿ     | æ ‡å‡†åº“ï¼ŒåŠŸèƒ½å…¨é¢ï¼Œè·¨å¹³å°      | é€šç”¨å¼‚æ­¥ç¼–ç¨‹              |
| **Gevent** | libev          | çŒ´å­è¡¥ä¸ï¼Œå…¼å®¹åŒæ­¥ä»£ç         | å¿«é€Ÿæ”¹é€ ç°æœ‰åŒæ­¥ä»£ç       |
| **uvloop** | libuv          | æ€§èƒ½ä¼˜åŒ–ï¼Œæ¯” asyncio å¿«æ•°å€     | é«˜æ€§èƒ½ç½‘ç»œæœåŠ¡            |

### 4.2 é€‰å‹å»ºè®®

1. **åˆå­¦è€…**ï¼šä» asyncio å¼€å§‹ï¼Œåˆ©ç”¨æ ‡å‡†åº“å­¦ä¹ å¼‚æ­¥ç¼–ç¨‹
2. **æ€§èƒ½ä¼˜å…ˆ**ï¼šuvloop+asyncio ç»„åˆï¼Œæå‡ç½‘ç»œ IO æ€§èƒ½
3. **ä»£ç å…¼å®¹æ€§**ï¼šGevent é€‚åˆæ”¹é€ ç°æœ‰åŒæ­¥ä»£ç ä¸ºå¼‚æ­¥
4. **è·¨å¹³å°éœ€æ±‚**ï¼šasyncio åŸç”Ÿæ”¯æŒ Windows å’Œ Unix

## äº”ã€Python å¼‚æ­¥ç¼–ç¨‹æŒ‡å¯¼ç»†åˆ™

### 5.1 ä»£ç ç»“æ„æœ€ä½³å®è·µ

1. **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªåç¨‹åªåšä¸€ä»¶äº‹
2. **å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨**ï¼šä½¿ç”¨`async with`ç®¡ç†èµ„æº
3. **é¿å…é˜»å¡**ï¼šæ‰€æœ‰ I/O æ“ä½œå¿…é¡»å¼‚æ­¥åŒ–

```python
# æ¨èå†™æ³•
async def fetch_url(url):
    async with aiohttp.ClientSession() as session:
        async with session.get(url) as response:
            return await response.text()
```

### 5.2 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

1. **è¿æ¥æ± å¤ç”¨**ï¼šé‡ç”¨ HTTP ä¼šè¯ã€æ•°æ®åº“è¿æ¥
2. **æ‰¹é‡æ“ä½œ**ï¼šåˆå¹¶å° I/O æ“ä½œå‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢
3. **åˆç†è®¾ç½®è¶…æ—¶**ï¼šä½¿ç”¨`asyncio.wait_for`é¿å…é•¿æ—¶é—´é˜»å¡

```python
# è¿æ¥æ± ç¤ºä¾‹
async def create_pool():
    pool = aiohttp.TCPConnector(limit=100)
    session = aiohttp.ClientSession(connector=pool)
    return session
```

### 5.3 é”™è¯¯å¤„ç†è§„èŒƒ

1. **å…¨å±€å¼‚å¸¸æ•è·**ï¼šä½¿ç”¨`loop.set_exception_handler`
2. **ä»»åŠ¡çº§å¼‚å¸¸å¤„ç†**ï¼šæ¯ä¸ªä»»åŠ¡åŒ…å« try/except
3. **è¶…æ—¶å¤„ç†**ï¼šæ‰€æœ‰å¼‚æ­¥æ“ä½œè®¾ç½®åˆç†è¶…æ—¶

```python
# å…¨å±€å¼‚å¸¸å¤„ç†
def handle_exception(loop, context):
    print(f"æ•è·å…¨å±€å¼‚å¸¸: {context['exception']}")

loop = asyncio.get_event_loop()
loop.set_exception_handler(handle_exception)
```

## å…­ã€ç»¼åˆæ¡ˆä¾‹ï¼šå¼‚æ­¥çˆ¬è™«ç³»ç»Ÿ

### 6.1 éœ€æ±‚èƒŒæ™¯

å¼€å‘ä¸€ä¸ªé«˜æ€§èƒ½å¼‚æ­¥çˆ¬è™«ï¼Œéœ€æ»¡è¶³ï¼š
- åŒæ—¶çˆ¬å– 1000+ç½‘é¡µ
- æ”¯æŒå¤±è´¥é‡è¯•
- æ§åˆ¶å¹¶å‘é‡é¿å…å°ç¦
- å¤„ç†ä¸åŒåŸŸåçš„è¯·æ±‚

### 6.2 å®ç°æ–¹æ¡ˆ

```python
import asyncio
import aiohttp
import random
from urllib.parse import urlparse

class AsyncCrawler:
    def __init__(self, concurrency=100, retries=3, timeout=10):
        self.concurrency = concurrency
        self.retries = retries
        self.timeout = timeout
        self.semaphore = asyncio.Semaphore(concurrency)
        self.session = None
        self.domain_limits = {}  # åŸŸåçº§å¹¶å‘æ§åˆ¶
    
    async def init_session(self):
        connector = aiohttp.TCPConnector(
            limit=self.concurrency,
            limit_per_host=10  # æ¯ä¸ªåŸŸåæœ€å¤š10ä¸ªè¿æ¥
        )
        self.session = aiohttp.ClientSession(connector=connector)
    
    async def fetch(self, url):
        domain = urlparse(url).netloc
        # åŸŸåçº§å¹¶å‘æ§åˆ¶
        if domain not in self.domain_limits:
            self.domain_limits[domain] = asyncio.Semaphore(10)
        sem = self.domain_limits[domain]
        
        async with self.semaphore, sem:
            for attempt in range(self.retries):
                try:
                    async with asyncio.timeout(self.timeout):
                        async with self.session.get(url) as response:
                            if response.status == 200:
                                return await response.text()
                            print(f"è¯·æ±‚å¤±è´¥: {url}, çŠ¶æ€ç : {response.status}")
                except (aiohttp.ClientError, asyncio.TimeoutError) as e:
                    print(f"å°è¯•{attempt+1}/{self.retries}å¤±è´¥: {url}, é”™è¯¯: {e}")
                    await asyncio.sleep(random.uniform(0.5, 2.0))  # é€€é¿é‡è¯•
            return None
    
    async def crawl_many(self, urls):
        await self.init_session()
        tasks = [self.fetch(url) for url in urls]
        results = await asyncio.gather(*tasks, return_exceptions=True)
        await self.session.close()
        return results

# ä½¿ç”¨ç¤ºä¾‹
async def main():
    urls = [f"https://example.com/page/{i}" for i in range(100)]
    crawler = AsyncCrawler(concurrency=200)
    results = await crawler.crawl_many(urls)
    print(f"æˆåŠŸçˆ¬å–{sum(1 for r in results if r is not None)}é¡µ")

asyncio.run(main())
```

### 6.3 å…³é”®æŠ€æœ¯ç‚¹

1. **åŒå±‚å¹¶å‘æ§åˆ¶**ï¼š
   - å…¨å±€å¹¶å‘é™åˆ¶`self.semaphore`
   - åŸŸåçº§å¹¶å‘é™åˆ¶`domain_limits`

2. **æ™ºèƒ½é‡è¯•æœºåˆ¶**ï¼š
   - å›ºå®šé‡è¯•æ¬¡æ•°`retries`
   - éšæœºé€€é¿ç­–ç•¥`random.uniform`

3. **èµ„æºç®¡ç†**ï¼š
   - å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ç®¡ç†ä¼šè¯å’Œè¿æ¥
   - è¶…æ—¶æ§åˆ¶é¿å…é•¿æ—¶é—´é˜»å¡

## ä¸ƒã€æ€»ç»“ä¸è¿›é˜¶æ–¹å‘

### 7.1 æ ¸å¿ƒçŸ¥è¯†å›é¡¾

1. **å¼‚æ­¥ç¼–ç¨‹ä¼˜åŠ¿**ï¼šé«˜å¹¶å‘ I/O å¤„ç†ï¼Œå•çº¿ç¨‹é«˜æ•ˆè°ƒåº¦
2. **GIL å½±å“**ï¼šå¼‚æ­¥ç¼–ç¨‹é€šè¿‡å•çº¿ç¨‹è§„é¿ GILï¼Œä½† CPU ä»»åŠ¡éœ€ç»“åˆå¤šè¿›ç¨‹
3. **æ¨¡å‹é€‰æ‹©**ï¼šæ ¹æ®ä»»åŠ¡ç±»å‹é€‰æ‹©åç¨‹ã€çº¿ç¨‹æˆ–è¿›ç¨‹
4. **æ¡†æ¶é€‰å‹**ï¼šasyncio ä½œä¸ºåŸºç¡€ï¼Œuvloop æå‡æ€§èƒ½

### 7.2 è¿›é˜¶å­¦ä¹ æ–¹å‘

1. **ç½‘ç»œç¼–ç¨‹**ï¼šæ·±å…¥å­¦ä¹  TCP/UDP å¼‚æ­¥ç¼–ç¨‹
2. **åˆ†å¸ƒå¼ç³»ç»Ÿ**ï¼šå¼‚æ­¥æ¡†æ¶ä¸åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦ç»“åˆ
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šä½¿ç”¨`cProfile`åˆ†æå¼‚æ­¥ç¨‹åºæ€§èƒ½
4. **å®æˆ˜é¡¹ç›®**ï¼šå¼€å‘å¼‚æ­¥ Web æ¡†æ¶ã€æ¶ˆæ¯é˜Ÿåˆ—æˆ–çˆ¬è™«ç³»ç»Ÿ

é€šè¿‡æŒæ¡ä¸Šè¿°å†…å®¹ï¼Œæ‚¨å°†èƒ½å¤Ÿåœ¨ Python ä¸­ç†Ÿç»ƒè¿ç”¨å¼‚æ­¥ç¼–ç¨‹è§£å†³é«˜å¹¶å‘é—®é¢˜ï¼Œæ„å»ºé«˜æ•ˆã€å¯æ‰©å±•çš„å¼‚æ­¥åº”ç”¨ç³»ç»Ÿã€‚