---
title: Python å¼‚æ­¥ç¼–ç¨‹å®æˆ˜å…¥é—¨:ä»æ¦‚å¿µåˆ°å®æˆ˜
date: 2022-12-01 23:47:33
author: wangshouh
tags: 
  - python
  - asyncio
  - å¼‚æ­¥ç¼–ç¨‹
permalink: /asyncio/tutorial/
categories: 
  - ğŸPython
  - å¼‚æ­¥ç¼–ç¨‹
---

## æ¦‚è¿°

åœ¨ Python ä¸­å­˜åœ¨`GIL`æœºåˆ¶ï¼Œè¯¥æœºåˆ¶ä¿è¯äº†åœ¨ Python ä¸­åŒæ—¶é—´å†…ä»…èƒ½è¿è¡Œä¸€è¡Œä»£ç ï¼Œè¿™å¯¼è‡´äº† Python æ— æ³•çœŸæ­£å®ç°å¤šçº¿ç¨‹ã€‚ä½† Python ä¸­å­˜åœ¨å¦ä¸€ç§ç¥å¥‡çš„æœºåˆ¶ï¼Œå³å¼‚æ­¥æœºåˆ¶ã€‚åœ¨è®¡ç®—æœºé¢†åŸŸï¼Œæˆ‘ä»¬ç»å¸¸æåˆ°å¼‚æ­¥ã€å¹¶è¡Œã€å¤šçº¿ç¨‹ç­‰åè¯ï¼Œä½†æœ¬æ–‡ä¸æƒ³è®¨è®ºè¿™äº›åè¯å…·ä½“çš„å«ä¹‰ï¼Œè¿™äº›å¯¹äºæ¦‚å¿µçš„è®¨è®ºåœ¨å¾ˆå¤šæƒ…å†µä¸‹æ˜¯æ— æ„ä¹‰çš„ã€‚æœ¬æ–‡å°†ä¸“æ³¨äºä»‹ç»å¼‚æ­¥æœºåˆ¶ï¼Œåœ¨æœ¬æ–‡çš„æœ€åï¼Œæˆ‘ä»¬ä¼šå¼•å…¥å¤šçº¿ç¨‹ç­‰å†…å®¹ä»¥è¿›ä¸€æ­¥æé«˜ Python æ€§èƒ½ã€‚

æœ¬æ–‡ä¸»è¦è®¨è®ºä»¥ä¸‹å†…å®¹:

1. å¼‚æ­¥çš„æ¦‚å¿µä¸`Hello World`
1. å¼‚æ­¥ç¼–ç¨‹çš„åŸºæœ¬æ¨¡å‹å’Œå…³é”®è¯
1. å¼‚æ­¥çš„å®ç°æœºåˆ¶
1. å®Œæ•´çš„å¼‚æ­¥çˆ¬è™«ç¤ºä¾‹
1. å¢åŠ å¤šçº¿ç¨‹æ”¯æŒçš„æ€§èƒ½æ›´å¼ºçš„å¼‚æ­¥çˆ¬è™«

ç”±äºå¼‚æ­¥å±äº Python ä¸­è¾ƒä¸ºå…ˆè¿›ä¸”ä¸æ–­å˜åŒ–çš„æœºåˆ¶ï¼Œç¬”è€…ä½¿ç”¨äº†`3.11`ä½œä¸ºåŸºå‡†ç‰ˆæœ¬ï¼Œæœ¬æ–‡ä¸­çš„å¤§éƒ¨åˆ†ä»£ç å¯èƒ½æ— æ³•åœ¨`3.11`ä»¥ä¸‹ç‰ˆæœ¬è¿è¡Œï¼Œç¬”è€…ä¼šå°½å¯èƒ½å°†ä½ç‰ˆæœ¬å…¼å®¹æ–¹æ¡ˆåˆ—å‡ºã€‚æœ¬æ–‡ä¹Ÿå°†ä½¿ç”¨ä»¥ä¸‹åº“:

- aiohttp
- aiofiles

è¯·è¯»è€…è‡ªè¡Œä½¿ç”¨`pip`è¿›è¡Œå®‰è£…ã€‚å¦‚æœæ‚¨é‡åˆ°`error: Microsoft Visual C++ 14.0 or greater is required. Get it with "Microsoft C++ Build Tools": https://visualstudio.microsoft.com/visual-cpp-build-tools/`æŠ¥é”™ï¼Œè¯·å‚è€ƒæˆ‘åœ¨ CSDN å†™çš„[å¦‚ä½•åœ¨ Python ä¸­ç®€å•åœ°è§£å†³ Microsoft Visual C++ 14.0 æŠ¥é”™](https://blog.csdn.net/WongSSH/article/details/127935695)ä¸€æ–‡ã€‚

## å¼‚æ­¥çš„æ¦‚å¿µä¸`Hello World`

å¼‚æ­¥æ˜¯æŒ‡åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸€äº›ç­‰å¾…æ“ä½œ(å¦‚`IO`æ“ä½œ)ä¸ä¼šé˜»å¡ä»£ç çš„è¿è¡Œã€‚è¯¥æ¦‚å¿µè¾ƒä¸ºæŠ½è±¡ï¼Œæˆ‘ä»¬ç»™å‡ºä¸€ä¸ªéå¼‚æ­¥çš„ä»£ç ç¤ºä¾‹:
```python
import time


def count():
    print("One")
    time.sleep(1)
    print("Two")


def main():
    for _ in range(3):
        count()


if __name__ == "__main__":
    s = time.perf_counter()
    main()
    elapsed = time.perf_counter() - s
    print(f"Code runtime: {elapsed:.2f}")
```
ä¸Šè¿°ä»£ç è¾ƒä¸ºç®€å•ï¼Œè¿è¡Œç»“æœå¦‚ä¸‹:
```plain
One
Two
One
Two
One
Two
Code runtime: 3.01
```

å½“ä¸»å‡½æ•°è¿è¡Œåˆ°`count()`æ—¶ï¼Œå‡½æ•°é¦–å…ˆè¾“å‡º`One`ï¼Œç„¶åå› ä¸º`time.sleep`ä¼šæš‚åœ 1 ç§’ï¼Œç„¶åç»§ç»­è¾“å‡º`Two`ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°`time.sleep`ä½¿æ•´ä¸ªä»£ç è¿›å…¥çš„åœé¡¿æƒ…å†µï¼Œåœ¨è¿™`sleep`çš„ 1 ç§’å†…ï¼Œæ‰€æœ‰çš„è¿è¡Œéƒ½è¢«åœæ­¢ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç»™å‡ºä¸€ä¸ªå¼‚æ­¥ç‰ˆæœ¬:
```python
import asyncio


async def count():
    print("One")
    await asyncio.sleep(1)
    print("Two")


async def main():
    await asyncio.gather(count(), count(), count())

if __name__ == "__main__":
    import time
    s = time.perf_counter()
    asyncio.run(main())
    elapsed = time.perf_counter() - s
    print(f"Code runtime: {elapsed:.2f}")
```
åœ¨æ­¤å¤„ï¼Œæˆ‘ä»¬å¼•å…¥äº†ä¸€äº›ä¸å¤ªå¸¸è§çš„å‡½æ•°:

1. `asyncio.sleep` å¼‚æ­¥è®¡æ—¶å™¨
1. `asyncio.gather` æ­¤å‡½æ•°ç”¨äºå¹¶å‘æ‰§è¡Œä¸€ç³»åˆ—å‡½æ•°ï¼Œè¿™é‡Œçš„å¹¶å‘å¹¶ä¸æ„å‘³ç€åç»­ä¸‰ä¸ª`count()`å‡½æ•°ä¸€èµ·è¿è¡Œï¼Œå…·ä½“åŸç†ä¼šåœ¨ä¸‹æ–‡è®¨è®º
1. `asyncio.run` æ­¤å‡½æ•°ç”¨äºå¯åŠ¨å¼‚æ­¥ä»»åŠ¡`main()`
1. `await` ç­‰å¾…è°ƒç”¨

> æ ¹æ®[æ–‡æ¡£ç›¸å…³è¡¨è¿°](https://docs.python.org/3/library/asyncio-task.html#asyncio.gather)ï¼Œä¸€ä¸ªæ›´åŠ ç°ä»£ä½†ä»…é€‚ç”¨`3.11`çš„ä»£ç å¦‚ä¸‹:
> ```python
> async def main():
>     async with asyncio.TaskGroup() as tg:
>         for i in range(3):
>             tg.create_task(count())
> ```

ä¸Šè¿°ä»£ç è¿è¡Œç»“æœå¦‚ä¸‹:
```plain
One
One
One
Two
Two
Two
Code runtime: 1.01
```

æ˜¾ç„¶ï¼Œæ­¤ä»£ç è¿è¡Œé€Ÿåº¦æ›´å¿«ï¼Œä¸”è¾“å‡ºç»“æœä¹Ÿä¸åŒæ­¥ç‰ˆæœ¬ä¸ç¬¦ï¼Œå…¶è¿è¡Œæµç¨‹å›¾å¦‚ä¸‹:

![Asynio Example](https://img.gopic.xyz/countAsynio.svg)

åœ¨`asynio.gather`å‡½æ•°è¿è¡Œåï¼Œç¬¬ä¸€ä¸ª`count()`å‡½æ•°å¯åŠ¨ï¼Œè¿è¡Œå¹¶è¾“å‡º`One`ï¼Œä½†å…¶è¿è¡Œåˆ°`await asyncio.sleep(1)`ä¼šè¿è¡Œ`asyncio.sleep`æš‚åœè¿è¡Œï¼Œå°†æ§åˆ¶æƒäº¤è¿˜ç»™ä¸»å‡½æ•°ï¼Œä¸»å‡½æ•°ç»§ç»­è¿è¡Œä¸‹ä¸€ä¸ª`count()`å‡½æ•°ï¼Œé‡å¤ä¸Šä¸€æµç¨‹ã€‚å½“ç¬¬ä¸€ä¸ª`count()`å‡½æ•°æš‚åœæ»¡ 1 ç§’åï¼Œå®ƒä¼šå–å¾—è¿è¡Œæƒé™ï¼Œå°†`Two`è¿›è¡Œè¾“å‡ºï¼Œå…¶ä»–`count()`å‡½æ•°ç±»ä¼¼ã€‚

æˆ‘ä»¬å¯ä»¥å‘ç°`await`äº‹å®ä¸Šçš„å«ä¹‰ä¸ºè¿è¡Œå‡½æ•°ç­‰å¾…è¿”å›ï¼Œå¹¶ç­‰å¾…è¿”å›æ•°æ®è¿‡ç¨‹ä¸­äº¤å‡ºæ§åˆ¶æƒä½¿å…¶ä»–å‡½æ•°è¿è¡Œã€‚

åœ¨ç°å®çš„ç¼–ç å®ä¾‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘`asyncio.sleep(1)`ä¸ºä¸€è€—æ—¶çš„ç³»ç»Ÿæ“ä½œï¼Œè¿™ä¸€æ“ä½œä¸éœ€è¦`Python`ä»£ç è¿è¡Œè€Œä»…éœ€è¦ Python ç­‰å¾…è¿è¡Œç»“æœè¿”å›ï¼Œæ¯”å¦‚ç½‘ç»œè¯·æ±‚ã€‚åœ¨ç½‘ç»œè¯·æ±‚è¿‡ç¨‹ä¸­ï¼Œå‘é€æ•°æ®åŒ…å’Œæ¥æ”¶æ•°æ®åŒ…éƒ½è¾ƒä¸ºå¿«é€Ÿï¼Œå¯¹äºçˆ¬è™«è€Œè¨€ï¼Œå¤§éƒ¨åˆ†æ—¶é—´æµªè´¹åœ¨ç­‰å¾…æ•°æ®è¿”å›çš„è¿‡ç¨‹ä¸­ï¼Œè¿™ä¸€ç­‰å¾…è¿‡ç¨‹ä¸­ Python ä¸éœ€è¦æ“ä½œã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¼•å…¥å¼‚æ­¥æœºåˆ¶è®© Python åœ¨æ­¤ç­‰å¾…æ—¶é—´å†…è¿›è¡Œå…¶ä»–å·¥ä½œã€‚å¦ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„æ¡ˆä¾‹å³è¯»å–æ–‡ä»¶ï¼Œè¯»å–æ–‡ä»¶çš„è¿‡ç¨‹å¹¶ä¸æ˜¯ Python å®Œæˆçš„ï¼ŒPython åªæ˜¯åœ¨è¯»å–æ–‡ä»¶æ—¶å‘æ“ä½œç³»ç»Ÿå‘å‡ºè¯·æ±‚ï¼Œç­‰å¾…æ“ä½œç³»ç»Ÿè¿”å›æ–‡ä»¶å†…å®¹ï¼Œè¿™ä¸€è¿‡ç¨‹ä¹Ÿæ˜¯æµªè´¹çš„æ—¶é—´ï¼Œå¯ä»¥é€šè¿‡å¼‚æ­¥æ–¹æ³•ä½¿ Python è¿›è¡Œå…¶ä»–å·¥ä½œã€‚

![IO waitting](https://acjgpfqbqr.cloudimg.io/_img1_/c9d4e2defdce72e4edaaae74b9cf1df2.png)

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒPython çš„åŸç”Ÿå®ç°ï¼ŒåŒ…æ‹¬`requests`ç­‰ç½‘ç»œè¯·æ±‚åº“å‡æ²¡æœ‰å®ç°ä¸Šè¿°å¼‚æ­¥ç‰¹æ€§ï¼Œä¸ºå®ç°å¼‚æ­¥ï¼Œæˆ‘ä»¬éœ€è¦å¼•å…¥[æ¦‚è¿°](#æ¦‚è¿°)ä¸­ç»™å‡ºçš„ä¸¤ä¸ªåº“ï¼Œå…¶ä¸­:

- `aiohttp` å®ç°ç½‘ç»œè¯·æ±‚å¼‚æ­¥
- `aiofiles` å®ç°æ–‡ä»¶è¯»å–å¼‚æ­¥

## åŸºæœ¬æ¨¡å‹

æœ¬èŠ‚ä¸»è¦ä»‹ç»ä¸€äº›åœ¨å¼‚æ­¥ç¼–ç¨‹ä¸­å¸¸ç”¨çš„ç¼–ç¨‹æ¨¡å‹ã€‚

ç¬¬ä¸€ç§å°±æ˜¯æœ€ç®€å•çš„é“¾å¼å¼‚æ­¥è°ƒç”¨ï¼Œæˆ‘ä»¬ä»¥ä¸€ä¸ªç®€å•çš„ä¾‹å­è¿›è¡Œä»‹ç»ã€‚ç›®å‰å­˜åœ¨ä¸€ä¸ªç®€å•çš„[API](https://mocki.io/v1/d4867d8b-b5d5-4a48-a4ab-79131b5809b8)è¿›è¡Œ`GET`è¯·æ±‚åä¼šè¿”å›ç”¨æˆ·ä¿¡æ¯åˆ—è¡¨ï¼Œæˆ‘ä»¬éœ€è¦è¯·æ±‚æ­¤ API å¹¶`print`ç»“æœã€‚é¦–å…ˆï¼Œæˆ‘ä»¬ç»™å‡ºåŸºäº`requests`çš„åŒæ­¥ç‰ˆæœ¬:
```python
import requests
import time
from requests import session

def get_api(s: session):
    url = "https://mocki.io/v1/d4867d8b-b5d5-4a48-a4ab-79131b5809b8"
    req = s.get(url).json()
    print(req)


def main():
    s = session()
    for i in range(3):
        get_api(s)


if __name__ == "__main__":
    s = time.perf_counter()
    main()
    elapsed = time.perf_counter() - s
    print(f"Code runtime: {elapsed}")
```
å¯¹äºè¯»è€…è€Œè¨€ï¼Œæ­¤ç±»å‹ä»£ç éƒ½æ˜¯å¯ä»¥å¿«é€Ÿå†™å‡ºçš„ï¼Œè¿è¡Œåå‘ç°è¿è¡Œæ—¶é•¿ä¸º 2.70 ç§’å·¦å³ã€‚

è€ƒè™‘ä½¿ç”¨æ»¡è¶³å¼‚æ­¥æ–¹æ³•çš„`aiohttp`ä¿®æ”¹æ­¤ç‰ˆæœ¬:
```python
import time
import asyncio
import aiohttp
from aiohttp import ClientSession

async def aio_get_api(s: ClientSession):
    url = "https://mocki.io/v1/d4867d8b-b5d5-4a48-a4ab-79131b5809b8"
    req = await s.get(url)
    
    print(await req.json())


async def aio_main():
    async with ClientSession() as session:
        task = [aio_get_api(session) for _ in range(3)]
        await asyncio.gather(*task)


if __name__ == "__main__":
    s = time.perf_counter()
    asyncio.run(aio_main())
    elapsed = time.perf_counter() - s
    print(f"Code runtime: {elapsed}")
```
ç›¸è¾ƒäºåŒæ­¥ç‰ˆæœ¬ï¼Œå¼‚æ­¥ç‰ˆæœ¬å¹¶æ²¡æœ‰æ›´åŠ å¤æ‚ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„å¼‚æ­¥å‡½æ•°(å³å‡½æ•°ä½“å†…åŒ…å«`await`çš„å‡½æ•°)å‡éœ€è¦ä½¿ç”¨`async def`è¿›è¡Œå®šä¹‰ã€‚å¯¹äº`aiohttp`è€Œè¨€ï¼Œ`get`å’Œ`json`ç­‰æ–¹æ³•éƒ½æ˜¯å¼‚æ­¥çš„ã€‚å¯¹äºæˆ‘ä»¬è€Œè¨€ï¼Œå¯ä»¥æ— è„‘çš„åœ¨æ‰€æœ‰å¼‚æ­¥æ“ä½œå‰å¢åŠ `await`å…³é”®è¯ã€‚æ­£å¦‚ä¸Šæ–‡æ‰€è¿°ï¼Œæ¯å½“ä»£ç è¿è¡Œåˆ°`await`åï¼Œå°±ä¼šè¿›è¡Œå‡½æ•°æ“ä½œåå°†æ§åˆ¶æƒäº¤æ¢ç»™ä¸»å‡½æ•°ã€‚è‡³äºä¸»å‡½æ•°å¦‚ä½•è°ƒåº¦è¿™äº›è¯·æ±‚ï¼Œæˆ‘ä»¬åœ¨æ­¤å¤„å¹¶ä¸éœ€è¦è¿›è¡Œç ”ç©¶ã€‚

æ­¤å¤„æˆ‘ä»¬ä½¿ç”¨äº†`ClientSession`ç±»å‹ï¼Œæ­¤ç±»å‹çš„é‡è¦ä½œç”¨æ˜¯ç»´æŠ¤è¯·æ±‚å‚æ•°ç­‰ï¼Œåœ¨`aiohttp`æ–‡æ¡£å†…ï¼Œå»ºè®®ä»…ç»´æŠ¤ä¸€ä¸ª`ClientSession`ä½œä¸ºæ‰€æœ‰è¯·æ±‚çš„å‘é€è€…ã€‚æ­¤å¤„ä¹Ÿéœ€è¦æ³¨æ„`ClientSession`ç±»ä¼¼æ–‡ä»¶ç±»å‹ï¼Œå…¶éœ€è¦åœ¨ä»£ç è¿è¡Œå®Œæˆåæ‰§è¡Œé€€å‡ºæ“ä½œã€‚æ­¤å¤„ï¼Œæˆ‘ä»¬ä¸ºäº†ç®€åŒ–æ­¤è¿‡ç¨‹ä½¿ç”¨äº†`with`å…³é”®è¯ã€‚å½“ç„¶ï¼Œç”±äº`with`å†…éƒ¨åŒ…å«`await`å…³é”®è¯ï¼Œæ‰€ä»¥`with`éœ€è¦ä½¿ç”¨`async with`æ›¿ä»£ã€‚å¦ä¸€ä¸ªéœ€è¦æ›¿ä»£çš„æ˜¯`async for`ï¼Œä½†åœ¨æ­¤å¤„æˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨ã€‚

ä¸Šè¿°å¼‚æ­¥ä»£ç çš„è¿è¡Œæ—¶é—´ä¸º 1.43 ç§’å·¦å³ï¼Œæ˜¾ç„¶å¿«äºåŒæ­¥ç‰ˆæœ¬ã€‚

ç¬¬äºŒç§æ¯”è¾ƒå¸¸ç”¨çš„ä½¿ç”¨å¼‚æ­¥+é˜Ÿåˆ—ã€‚

å‡è®¾æˆ‘ä»¬éœ€è¦ç¼–å†™ä¸€ä¸ªçˆ¬è™«ï¼Œæ­¤çˆ¬è™«ä»æˆ‘ä»¬ç»™å®šçš„ URL å¼€å§‹çˆ¬å–å†…å®¹ï¼Œå¹¶æå–è¯¥ URL ä¸­çš„é“¾æ¥ï¼Œç„¶åä¾æ¬¡çˆ¬å–é“¾æ¥ä¸­çš„é¡µé¢ï¼Œå†æå–é“¾æ¥ï¼Œé‡å¤ä¸Šè¿°æµç¨‹ã€‚åœ¨æ­¤æµç¨‹å†…ï¼Œä½¿ç”¨åˆ—è¡¨å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ï¼Œå½“æˆ‘ä»¬è¯»å–å®ŒæŸä¸ªé“¾æ¥åéœ€è¦åˆ é™¤ï¼Œä½†åˆ—è¡¨å¯¹æ­¤æ“ä½œå¹¶ä¸å‹å¥½ã€‚åœ¨æ­¤å¤„ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†ä¸€ä¸ªç‰¹æ®Šçš„æ•°æ®ç±»å‹é˜Ÿåˆ—(`queue`)ã€‚

æ­¤å¤„æˆ‘ä»¬é€šè¿‡ä»¥ä¸‹æ¡ˆä¾‹ä»‹ç»æ­¤æ¨¡å¼ï¼Œè®¿é—®è±†ç“£å›¾ä¹¦[è¯¦æƒ…é¡µ](https://book.douban.com/subject/35196328/)ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹å›¾ä¹¦æ¨èéƒ¨åˆ†:

![Douban Book Rec](https://acjgpfqbqr.cloudimg.io/_img1_/e57f5df2199b774f7e80fb5177b73403.png)

æŸ¥è¯¢æºä»£ç ï¼Œå¦‚ä¸‹å›¾:

![Douban Book html](https://acjgpfqbqr.cloudimg.io/_img1_/28c5e6da44c9259935d1610c0686f283.png)

æˆ‘ä»¬å¾ˆå®¹æ˜“å†™å‡ºæŠ½å–ç›¸å…³å†…å®¹çš„ä»£ç ï¼Œä½¿ç”¨`bs4`åº“è¿›è¡ŒæŠ½å–ï¼Œä»£ç å¦‚ä¸‹:
```python
soup = BeautifulSoup(raw_html, 'lxml')
rec_div = soup.find(id="db-rec-section")
for dt in rec_div.find_all("dt"):
    url = dt.find("a").get("href")
    print(url)
```
é€šè¿‡æ­¤æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æŠ½å–å›¾ä¹¦æ¨èæ å†…å…¶ä»–æ¨èå›¾ä¹¦çš„é“¾æ¥ã€‚æˆ‘ä»¬å¸Œæœ›æ„å»ºä¸€ä¸ªçˆ¬è™«ï¼Œè¯¥çˆ¬è™«å¯ä»¥è¿›ä¸€æ­¥æŠ“å–æ¯ä¸€ä¸ªæ¨èå›¾ä¹¦çš„æ¨èå›¾ä¹¦ï¼Œä¾æ¬¡é€’æ¨ã€‚

è¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦å‘çˆ¬è™«æä¾›ä¹‹å‰çˆ¬å–è¿‡çš„ç›¸å…³é“¾æ¥ã€‚æ˜¾ç„¶ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨é˜Ÿåˆ—ï¼Œç»´æŠ¤ä¸€ä¸ªç”±æ¨èå›¾ä¹¦ URL æ„æˆçš„é˜Ÿåˆ—ï¼Œçˆ¬è™«ä»æ­¤é˜Ÿåˆ—å†…è·å¾—çˆ¬å–çš„é“¾æ¥ï¼Œåœ¨çˆ¬å–ç»“æŸåï¼Œå°†çˆ¬å–çš„é“¾æ¥å†æ¨å…¥é˜Ÿåˆ—ã€‚æ­¤æµç¨‹å¯ä»¥å¾ˆå¥½çš„å®ç°æˆ‘ä»¬éœ€è¦çš„åŠŸèƒ½ã€‚

å…·ä½“ä»£ç å¦‚ä¸‹:
```python
import aiohttp
import asyncio
import time
from aiohttp import ClientSession
from bs4 import BeautifulSoup


async def exact_rec_book(raw_html: str, q: asyncio.Queue) -> str:
    soup = BeautifulSoup(raw_html, 'lxml')
    rec_div = soup.find(id="db-rec-section")
    for dt in rec_div.find_all("dt"):
        url = dt.find("a").get("href")
        print(url)
        if url:
            await q.put(url)
        else:
            pass


async def crawler(name: int, s: ClientSession, q: asyncio.Queue) -> None:
    url = await q.get()
    req = await s.get(url)
    html = await req.text()
    await exact_rec_book(html, q)


async def main():
    q = asyncio.Queue()
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:107.0) Gecko/20100101 Firefox/107.0',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8',
        'Accept-Language': 'en,en-US;q=0.8,zh-CN;q=0.7,zh;q=0.5,zh-TW;q=0.3,zh-HK;q=0.2',
    }
    await q.put("https://book.douban.com/subject/35196328/")
    async with ClientSession(headers=headers) as session:
        task = [crawler(name, session, q) for name in range(5)]
        await asyncio.gather(*task)


if __name__ == "__main__":
    s = time.perf_counter()
    asyncio.run(main())
    elapsed = time.perf_counter() - s
    print(f"Code runtime: {elapsed}")
```

å…¶ä¸­ï¼Œ`exact_rec_book`ç”¨äºæå–é“¾æ¥å¹¶å°†å…¶æ¨å…¥ URL é˜Ÿåˆ—ï¼Œ`crawler`æ˜¯çˆ¬è™«çš„ä¸»ä½“å‡½æ•°ï¼Œ`main`ç”¨äºå¯åŠ¨æ­¤å¼‚æ­¥çˆ¬è™«ã€‚

æ­¤å¤„éœ€è¦æ³¨æ„ï¼Œæˆ‘ä»¬åœ¨`task`ä¸­è®¾ç½®äº† 5 ä¸ªçˆ¬è™«å‡½æ•°ï¼ŒæŸ¥è¯¢ä¸Šè¿°è±†ç“£é¡µé¢ï¼Œæ¯ä¸ªé¡µé¢å†…åŒ…å« 10 ä¸ªé¡µé¢ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„çˆ¬è™«åº”è¯¥è¿”å› 50 ä¸ªé¡µé¢é“¾æ¥ã€‚

> å¦‚æœæ‚¨å¸Œæœ›æ¯ä¸ªå‡½æ•°å¤šè¿è¡Œå‡ æ¬¡ï¼Œå¯ä»¥åœ¨`crawler`è¿›è¡Œå¦‚ä¸‹ä¿®æ”¹:
```python
 async def crawler(name: int, s: ClientSession, q: asyncio.Queue) -> None:
     for _ in range(3):
         url = await q.get()
         req = await s.get(url)
         html = await req.text()
         await exact_rec_book(html, q)
```
> ä¸Šè¿°ä¿®æ”¹å¯ä»¥æ˜¯çˆ¬å–è¿‡ç¨‹é‡å¤ä¸‰æ¬¡ï¼Œå³æ„å‘³ç€çˆ¬å– 150 ä¸ªé“¾æ¥
> æˆ‘ä»¬ä¸å»ºè®®å¤§é‡è°ƒé«˜ä¸Šè¿°è®¾ç½®ï¼Œè¿™å¯èƒ½å¯¼è‡´æ‚¨è¢«è±†ç“£ç½‘ç«™æ‹‰é»‘

ç”±äºè±†ç“£ç½‘ç«™å¯¹`UA`è¿›è¡Œäº†é™åˆ¶ï¼Œæ­¤å¤„æˆ‘ä»¬ä½¿ç”¨äº†è‡ªå·±è®¾ç½®çš„`headers`ä»¥åº”å¯¹åçˆ¬ã€‚æ­¤å¤„æˆ‘ä»¬ä¹Ÿåœ¨ä¸»å‡½æ•°æœ€å¼€å§‹å‘é˜Ÿåˆ—æ¨å…¥äº†å¯åŠ¨å˜é‡ã€‚

ä¸Šè¿°ä»£ç è¿è¡Œç»“æœå¦‚ä¸‹:
```plain
https://book.douban.com/subject/27028517/
...
Code runtime: 7.696796900010668
```

ä¸Šè¿°åŸºæœ¬æ¶µç›–äº†å¼‚æ­¥è¿‡ç¨‹ä¸­çš„ä¸»è¦æ¨¡å‹ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ä»‹ç»ä¸€äº›ç¥å¥‡çš„å°ç»„ä»¶ä»¥å®ç°ä¸€äº›ç‰¹æ®ŠåŠŸèƒ½ã€‚

`Semaphore`ä¿¡å·é‡æœºåˆ¶ã€‚æ­¤æœºåˆ¶ç”¨äºæ§åˆ¶ä¸€æ¬¡å¯å¼‚æ­¥è¿è¡Œçš„å‡½æ•°æ•°é‡ã€‚

é¦–å…ˆç»™å‡ºæœªå—ä¿¡å·é‡æ§åˆ¶çš„ä»£ç ï¼Œå¦‚ä¸‹:
```python
import asyncio
import time


async def hello(name: int):
    await asyncio.sleep(1)
    print(f"{name} Finish...")

async def main():
    task = [hello(i) for i in range(6)]
    await asyncio.gather(*task)

s = time.perf_counter()
asyncio.run(main())
elapsed = time.perf_counter() - s
print(f"Code runtime: {elapsed}")
```

è¿è¡Œç»“æœæ˜¾è€Œæ˜“è§å¦‚ä¸‹:
```plain
0 Finish...
2 Finish...
5 Finish...
4 Finish...
1 Finish...
3 Finish...
Code runtime: 1.0051071000052616
```
ä¸Šè¿°è¾“å‡ºè¯´æ˜ 6 ä¸ªåç¨‹ä¸€åŒè¿è¡Œï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¿¡å·é‡è¿›è¡Œä¿®æ”¹ï¼Œè¦æ±‚æ¯æ¬¡æœ€å¤šå…è®¸è¿è¡Œ 2 ä¸ªåç¨‹ï¼Œä¿®æ”¹`hello()`å‡½æ•°ï¼Œå¦‚ä¸‹:
```python
limit = asyncio.Semaphore(2)

async def hello(name: int):
    async with limit:
        await asyncio.sleep(1)
    print(f"{name} Finish...")
```
å…¶ä»–ä»£ç ä¸ä¹‹å‰ç›¸åŒï¼Œè¿è¡Œè¾“å‡ºå¦‚ä¸‹:
```plain
0 Finish...
1 Finish...
2 Finish...
3 Finish...
4 Finish...
5 Finish...
Code runtime: 3.0241502999851946
```
æ­¤å¤„æˆ‘ä»¬å°†ä¿¡å·é‡ä½¿ç”¨`async with limit:`çš„å½¢å¼å°†éœ€è¦é™åˆ¶çš„ä»£ç åŒ…è£¹èµ·æ¥å°±å¯ä»¥å®ç°é™åˆ¶å…¶å¼‚æ­¥è¿è¡Œçš„æ•ˆæœã€‚å¦‚æœéœ€è¦é™åˆ¶ä¸Šæ–‡ç»™å‡ºçš„è±†ç“£çˆ¬è™«å‡½æ•°ï¼Œå¯ä»¥è¿›è¡Œå¦‚ä¸‹ä¿®æ”¹:
```python
async def crawler(name: int, s: ClientSession, q: asyncio.Queue) -> None:
    url = await q.get()
    async with limit:
        req = await s.get(url)
    html = await req.text()
    await exact_rec_book(html, q)
```
ä¿¡å·é‡æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼Œå½“åç¨‹éœ€è¦è¿è¡Œæ—¶åˆ™å‘è®¡æ•°å™¨å‘èµ·`acquire`è¯·æ±‚ï¼Œè®¡æ•°å™¨å‡å°‘ 1 2; å½“åç¨‹è¿è¡Œç»“æŸåï¼Œåˆ™å‘è®¡æ•°å™¨è¯·æ±‚`release`è¯·æ±‚ï¼Œè®¡æ•°å™¨å¢åŠ  1 ã€‚æœ¬è´¨ä¸Šæµç¨‹å¦‚ä¸‹:
```python
sem = asyncio.Semaphore(10)

# ... later
await sem.acquire()
try:
    # work with shared resource
finally:
    sem.release()
```
æˆ‘ä»¬å¯ä»¥ä½¿ç”¨`with`è¯­å¥ç®€åŒ–ï¼Œå¦‚ä¸‹:
```python
sem = asyncio.Semaphore(10)

# ... later
async with sem:
    # work with shared resource
```

## å¼‚æ­¥åŸç†

æœ¬èŠ‚ä¸»è¦ä»‹ç»å¼‚æ­¥åœ¨ Python ä¸­å®ç°çš„ä¸€äº›åŸºæœ¬åŸç†ï¼Œå¦‚æœæ‚¨å¯¹æ­¤ä¸æ„Ÿå…´è¶£ï¼Œå¯ä»¥è·³è¿‡ã€‚

åœ¨ä»‹ç»å¼‚æ­¥è¿è¡Œå‰ï¼Œæˆ‘ä»¬éœ€è¦é¦–å…ˆç»™å‡ºä¸€ä¸ªæ¦‚å¿µï¼Œå³ç”Ÿæˆå™¨(generator iterators)ï¼Œä»¥ä¸‹ä»£ç ç»™å‡ºäº†ä¸€ä¸ªç®€å•çš„ç”Ÿæˆå™¨:
```python
def easy_range(n):
    i = 0
    while i < n:
        t = yield i
        if t is None:
            pass
        else:
            i = t
        i += 1
```
æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹ä»£ç å¯¹å…¶è¿›è¡Œè°ƒç”¨:
```python
my_range = easy_range(10)
print(next(my_range))
print(next(my_range))
print(my_range.send(4))
```
å½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡è°ƒç”¨`next(my_range)`æ—¶ï¼Œä»£ç `Debug`å¦‚ä¸‹:

![Yield Init Debug](https://acjgpfqbqr.cloudimg.io/_img1_/395634cff51966b061d4330ed8ddf33a.gif)

å¯è§ç¬¬ä¸€æ¬¡è°ƒç”¨`next()`å‡½æ•°æ—¶ï¼Œå‡½æ•°è¿è¡Œåˆ°`yield`è¯­å¥å°±åœæ­¢äº†ã€‚è¿™ä¸æˆ‘ä»¬çš„å¼‚æ­¥ç¼–ç¨‹ä¸­çš„æš‚åœæœºåˆ¶æœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åˆ†æç¬¬äºŒä¸ª`next`ï¼Œå…¶`Debug`å¦‚ä¸‹:

![Yield Next Debug](https://acjgpfqbqr.cloudimg.io/_img1_/b80c8e60d95e2f4d92254178d51031cf.gif)

å…³æ³¨å·¦ä¾§çš„`VARIABLES`å˜é‡å±•ç¤ºæ ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ­¤å¤„çš„`Locals`å‡½æ•°æœ¬åœ°å˜é‡ä¿å­˜äº†æˆ‘ä»¬ä¸Šæ¬¡åˆå§‹åŒ–åçš„ç»“æœï¼Œä»£ç è¿è¡Œä»`yield`çš„ä¸‹ä¸€è¡Œå¼€å§‹è¿è¡Œåˆ°å‡½æ•°æœ€åï¼Œç„¶åè·³è½¬åˆ°ä»£ç å—æœ€å¼€å§‹è¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼Œç„¶åè¿›å…¥ä»£ç å—è¿è¡Œåˆ°`yield`ç»“æŸã€‚

æ­¤å¤„ï¼Œæˆ‘ä»¬å¯ä»¥æ€»ç»“`yield`çš„è¿è¡Œç‰¹æ€§:

1. ç¬¬ä¸€æ¬¡è°ƒç”¨`next`æ–¹æ³•ä¼šåœ¨ç”Ÿæˆå™¨å‡½æ•°(æ­¤å¤„ä¸º`easy_range`)çš„æœ€å¼€å§‹è¿è¡Œç›´åˆ°`yield`ç»“æŸ
1. ç”Ÿæˆå™¨å‡½æ•°ä¼šä¿å­˜å‡½æ•°å†…å˜é‡ç›´è‡³ä¸‹ä¸€æ¬¡è°ƒç”¨ä½¿ç”¨
1. ç¬¬äºŒæ¬¡è°ƒç”¨`next`æ–¹æ³•æ—¶ä¼šåœ¨`yield`ä¸‹ä¸€è¡Œå¼€å§‹è¿è¡Œä»£ç ï¼Œè¿è¡Œè‡³ä»£ç å—æœ€åï¼Œç„¶åè·³è½¬åˆ°ä»£ç å—å¼€å§‹åˆ¤æ–­æ¡ä»¶ï¼Œä¹‹åç»§ç»­è¿è¡Œåˆ°`yield`è¯­å¥æˆ–æŠ›å‡º`StopIteration`å¼‚å¸¸

æ­¤å¤„ï¼Œæˆ‘ä»¬å¯ä»¥å‘ç°`yield`æš‚åœä»£ç è¿è¡Œçš„æ–¹æ³•ä¸`await`ç±»ä¼¼ï¼Œä½†æ­¤å¤„ä»å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œ`await`ä¸€æ–¹é¢ä¼šäº¤å‡ºå‡½æ•°æ§åˆ¶æƒï¼Œè¿™å¯ä»¥é€šè¿‡`yield`æš‚åœå‡½æ•°è¿è¡Œçš„åŠŸèƒ½å®ç°ï¼Œå¦ä¸€æ–¹é¢ï¼Œ`await`å¯ä»¥å°†å…¶åè·Ÿéšçš„å‡½æ•°è¿”å›å€¼æ³¨å…¥å›åŸå‡½æ•°ä½¿åŸå‡½æ•°ç»§ç»­è¿è¡Œ(å¦‚`req = await s.get(url)`ï¼Œ`s.get(url)`è¿è¡Œç»“æŸåä¼šå°†è¿”å›å€¼æ³¨å…¥ç»™`req`)ï¼Œæ­¤åŠŸèƒ½æ— æ³•ä»…é€šè¿‡`yield`å®ç°ã€‚

æˆ‘ä»¬é¦–å…ˆè§£å†³æ³¨å…¥é—®é¢˜ï¼Œæ­¤å¤„ä½¿ç”¨äº†ä¸å¸¸è§çš„å…³é”®è¯`send`ï¼Œå…¶è¿è¡Œé€»è¾‘å¦‚ä¸‹:

![Yield Send Debug](https://acjgpfqbqr.cloudimg.io/_img1_/52049ca715acf56ff1e9803cc4cd67a5.gif)

è§‚å¯Ÿ`VARIABLES`å±•ç¤ºæ ï¼Œæˆ‘ä»¬å‘ç°æ­¤æ¬¡å°†`send`ä¸­çš„æ•°å€¼`4`ç›´æ¥èµ‹å€¼ç»™äº†`t`ï¼Œç„¶åç»§ç»­è¿è¡Œç›¸å…³ä»£ç ï¼Œè¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼Œè¿è¡Œè‡³`yield`è¾“å‡º`i`ç»“æŸã€‚å¯è§`send`å¯ä»¥å®ç°ç®€å•çš„å˜é‡æ³¨å…¥ã€‚

æœ€åï¼Œæˆ‘ä»¬ä»‹ç»ä¸€ä¸ªç®€å•ä½†åŠŸèƒ½å¼ºå¤§çš„å…³é”®è¯`yield from`ï¼Œä»£ç ä¾‹å­å¦‚ä¸‹:
```python
def add_hello():
    while True:
        x = (yield)
        return ("Hello " + x)

def writer_wrapper():
    i = yield from add_hello()
    i += " Hello"
    return i

w = writer_wrapper()
next(w)
try:
    print(w.send("World"))
except StopIteration as e:
    print(e.value)
```
æ­¤å¤„ä½¿ç”¨äº†ä¸€ä¸ªç¥å¥‡çš„å…³é”®è¯`yield from`ï¼Œæ­¤å…³é”®è¯å¯ä»¥å®ç°é“¾å¼è°ƒç”¨ã€‚æˆ‘ä»¬å¯ä»¥å°†`yield from`å°†è§†ä¸ºä¸€ä¸ªé€šé“ï¼Œå¯ä»¥å°†`send`çš„å†…å®¹ä¼ é€’ç»™`add_hello()`ï¼Œç„¶åå°†è¿”å›å€¼èµ‹å€¼ä¼ é€’ç»™`writer_wrapper`ä¸­çš„`i`ï¼Œç„¶åç»§ç»­è¿›è¡Œå¤„ç†ã€‚

æˆ‘ä»¬éœ€è¦æ³¨æ„åœ¨`send`è°ƒç”¨å‰`next`åˆå§‹åŒ–ã€‚è¯¥å‡½æ•°çš„è¾“å‡ºä¸º:
```plain
Hello World Hello
```

è¯¥å‡½æ•°çš„`Debug`è¿è¡Œå¦‚ä¸‹:

![yieldFrom](https://acjgpfqbqr.cloudimg.io/_img1_/328241e02ee8cb94708aea9580d9885b.gif)

`yield from`å…³é”®è¯çœŸæ­£å®ç°å®ç°äº†`await`çš„åŠŸèƒ½ã€‚äº‹å®ä¸Šï¼Œåœ¨æ—©æœŸçš„ Python ç‰ˆæœ¬ä¸­ï¼Œå°±æ˜¯ä½¿ç”¨çš„`yield from`ä½œä¸º`await`ä½¿ç”¨ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç»™å‡ºæˆ‘ä»¬æ‰€ä»‹ç»çš„ç¬¬ä¸€ä¸ªå¼‚æ­¥ç¼–ç¨‹çš„`yield`ç‰ˆæœ¬ï¼Œå¦‚ä¸‹:
```python
def async_sleep():
    return (yield)

def async_print():
    print("One")
    while True:
        yield from async_sleep()
        print("Two")

task = [async_print() for _ in range(2)]

for i in task:
    next(i)

time.sleep(1)

for i in task:
    next(i)
```
æˆ‘ä»¬åœ¨æ­¤å¤„æ‰‹åŠ¨å¯¹`async_print`è¿›è¡Œè°ƒåº¦ï¼Œç¬¬ä¸€ä¸ª`for`å¾ªç¯ç”¨äºåˆå§‹åŒ–`async_print`å‡½æ•°ï¼Œè€Œç¬¬äºŒä¸ª`for`å¾ªç¯ç”¨äºå¯åŠ¨å‰©ä½™éƒ¨åˆ†å‡½æ•°ã€‚è€Œåœ¨`asynio`åº“ä¸­ï¼Œå…¶æä¾›äº†ä¸€ä¸ªè¾ƒä¸ºç‰¹æ®Šçš„éƒ¨åˆ†`event_loop`äº‹ä»¶å¾ªç¯ï¼Œæ­¤å¾ªç¯å°†ä¼šè·Ÿè¸ªç›®å‰æ–‡ä»¶å†…æ‰€æœ‰å¼‚æ­¥å‡½æ•°ï¼Œå¹¶æ ¹æ®è¿™äº›å‡½æ•°ä¸åŒçš„çŠ¶æ€è¿›è¡Œ`next`æˆ–`send`è°ƒç”¨ã€‚æˆ‘ä»¬ä¹‹é—´ä½¿ç”¨`asyncio.gather`å°†å‡½æ•°æ³¨å…¥`event_loop`ï¼Œä¹‹åä½¿ç”¨`asyncio.run`ç”¨äºå¯åŠ¨`event_loop`å¾ªç¯ã€‚

åœ¨æ­¤å¤„ï¼Œæˆ‘ä»¬å¯ä»¥ä»‹ç»ä¸ºä»€ä¹ˆéœ€è¦`async/await`å…³é”®è¯ï¼Ÿæ­£å¦‚ä¸Šæ–‡æ‰€è¨€ï¼Œå¼‚æ­¥å‡½æ•°äº‹å®ä¸Šå°±æ˜¯ç”Ÿæˆå™¨å‡½æ•°ï¼Œä½†åœ¨ç¼–ç è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šç¼–å†™ä¸€äº›æ­£å¸¸çš„ç”Ÿæˆå™¨å‡½æ•°ï¼Œä¸ºäº†è¾¨åˆ«ç”Ÿæˆå™¨å‡½æ•°ä¸å¼‚æ­¥å‡½æ•°çš„ä¸åŒï¼Œæ‰€ä»¥ä½¿ç”¨`async/await`ç”¨æ¥æ ‡è¯†å¼‚æ­¥å‡½æ•°ã€‚

> è¯»è€…å¯èƒ½å‘ç°`loop_event`è°ƒåº¦ä¹Ÿä¼šå½±å“å¼‚æ­¥å‡½æ•°è¿è¡Œçš„é€Ÿåº¦ï¼Œåœ¨è¿™ä¸€æ–¹é¢ï¼Œæœ‰éƒ¨åˆ†å¼€å‘è€…å¼€å‘äº†ä¸€äº›æ›´åŠ é«˜æ•ˆçš„ç‰ˆæœ¬ï¼Œæ¯”å¦‚[uvloop](https://github.com/MagicStack/uvloop)ç­‰ã€‚ä½†éšç€ Python ç‰ˆæœ¬çš„æå‡ï¼Œè°ƒåº¦å™¨çš„é€Ÿåº¦ä¹Ÿåœ¨ä¸Šå‡ï¼Œå¦‚æœè¯»è€…è¿½æ±‚æè‡´é€Ÿåº¦ï¼Œå¯ä»¥è€ƒè™‘æå‡ Python ç‰ˆæœ¬ã€‚ä¸‹å›¾å±•ç¤ºäº†`uvloop`çš„æ€§èƒ½å¯¹æ¯”
> ![performance.png](https://img.gopic.xyz/performance.png)

## å¤šçº¿ç¨‹ä¸å¼‚æ­¥

å¯¹å¼‚æ­¥å‡½æ•°è¿›è¡Œè°ƒåº¦çš„`loop_event`ä¸€èˆ¬ä¼šå°†æ‰€æœ‰å¼‚æ­¥å‡½æ•°è¿è¡Œåœ¨å•ä¸ªæ ¸å¿ƒä¸Šï¼Œå¦‚æœæˆ‘ä»¬ä¸€æ¬¡æ€§å¯åŠ¨å¤ªå¤šå¼‚æ­¥å‡½æ•°å¯èƒ½å¯¼è‡´å‡ºç°â€œä¸€æ ¸æœ‰éš¾ï¼Œå…«æ ¸å›´è§‚â€çš„æ»‘ç¨½ç°è±¡ã€‚åœ¨ Python ä¸­ï¼Œå¤šè¿›ç¨‹ä¸€èˆ¬ä¼šå°†æ¯ä¸ªè¿›ç¨‹è¿è¡Œåœ¨å•ä¸€çš„æ ¸å¿ƒä¸Šï¼Œå¦‚æœè¯»è€…å¼€å¯ 4 è¿›ç¨‹ï¼Œåˆ™æ„å‘³ç€æ¯ä¸ªè¿›ç¨‹è¿è¡Œåœ¨ä¸€ä¸ªæ ¸å¿ƒä¸Šï¼Œå³ä½¿ç”¨äº† 4 ä¸ªæ ¸å¿ƒ(å‰ææ˜¯æ‚¨çš„ CPU å…·æœ‰ 4 ä¸ªæ ¸å¿ƒ)ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å°†å¼‚æ­¥åµŒå…¥åœ¨å¤šçº¿ç¨‹ä¸­å®ç°æ›´é«˜æ•ˆçš„å¼‚æ­¥è¿è¡Œã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ Python çš„å¤šè¿›ç¨‹ä¸å— GIL é™åˆ¶ï¼Œè¿™æ„å‘³å¤šè¿›ç¨‹å¯¹äºè®¡ç®—å¯†é›†å‹ä»»åŠ¡ä»å¯æå‡æ•ˆç‡ã€‚

ç”±äº Python å¤šè¿›ç¨‹ä¹Ÿæ˜¯ä¸€ä¸ªå¤æ‚çš„è¯é¢˜ï¼Œæˆ‘ä»¬ä»…åœ¨æ­¤å¤„ç»™å‡ºä¸€ä¸ªç®€å•çš„ç¤ºä¾‹å’Œä»£ç è§£é‡Šï¼Œå¦‚æœè¯»è€…å¯¹å¤šçº¿ç¨‹è¿™ä¸€è¯é¢˜æ„Ÿå…´è¶£ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æœªæ¥å‘å¸ƒä¸€ç¯‡å…³äºæ­¤çš„æ–‡ç« ã€‚å¦‚æœè¯»è€…ç°åœ¨å°±æƒ³è·å¾—è¿™æ–¹é¢çš„å†…å®¹ï¼Œæˆ‘ä»¬å»ºè®®è¯»è€…é˜…è¯»ä»¥ä¸‹æ–‡æ¡£:

1. [multiprocessing åŸºäºè¿›ç¨‹çš„å¹¶è¡Œ](https://docs.python.org/zh-cn/3/library/multiprocessing.html)
1. [concurrent.futures å¯åŠ¨å¹¶è¡Œä»»åŠ¡](https://docs.python.org/zh-cn/3/library/concurrent.futures.html)

å½“ç„¶ï¼ŒPython æ–‡æ¡£ç»™å‡ºçš„ç›¸å…³ä»£ç ç¤ºä¾‹å’Œè§£é‡Šå¹¶ä¸è¶³å¤Ÿåˆå­¦è€…å­¦ä¹ ï¼Œè¯»è€…å¯å‚è€ƒ[æ­¤ç½‘ç«™](https://superfastpython.com/python-concurrency-guides/)å†…ç»™å‡ºçš„è¯¦ç»†å†…å®¹ã€‚

ç¬”è€…ç¼–å†™äº†ä¸€ä¸ªé€‚ç”¨äºä¸€èˆ¬çˆ¬è™«çš„å¤šè¿›ç¨‹å¼‚æ­¥ä»£ç ï¼Œå¦‚ä¸‹:

```python
import asyncio
import multiprocessing
import re
import time
from concurrent.futures import ProcessPoolExecutor, wait
from multiprocessing import Queue

import aiohttp
from aiohttp import ClientSession


def exact_link(html: str, pattern: re.Pattern):
    return re.search(pattern, html).group(1)


def consumer(rx: Queue, pattern: re.Pattern):
    while True:
        html = rx.get()

        if html is None:
            break

        title = exact_link(html, pattern)
        print(title)



async def run_loop(tx: Queue, rx: Queue):
    headers = {
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:107.0) Gecko/20100101 Firefox/107.0',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8',
        'Accept-Language': 'en,en-US;q=0.8,zh-CN;q=0.7,zh;q=0.5,zh-TW;q=0.3,zh-HK;q=0.2',
    }
    async with ClientSession(headers=headers) as session:
        while True:
            task = tx.get_nowait()
            fn, args = task
            future_task = asyncio.create_task(fn(*args, session))
            res = await future_task
            rx.put_nowait(res)


def bootstrap(tx: Queue, rx: Queue):
    asyncio.run(run_loop(tx, rx))


def consumer(rx: Queue, pattern: re.Pattern):
    while True:
        html = rx.get()
        title = exact_link(html, pattern)
        print(title)


def main():
    pattern = re.compile(r"<title>(.*)</title>")
    with open(r"test_data\url_list", "r", encoding="utf-8") as f:
        url_list = f.readlines()

    with multiprocessing.Manager() as manager:
        tx, rx = manager.Queue(), manager.Queue()

        for url in url_list:
            task = fetch_url, (url,)
            tx.put_nowait(task)

        with ProcessPoolExecutor(max_workers=4) as executor:
            producers = [executor.submit(bootstrap, tx, rx) for _ in range(2)]
            consumers = [executor.submit(consumer, rx, pattern)]
            wait(producers)
            rx.put(None)


if __name__ == "__main__":
    s = time.perf_counter()
    main()
    elapsed = time.perf_counter() - s
    print(f"Code runtime: {elapsed}")
```

æ­¤ä»£ç å±äºå¤šç”Ÿäº§è€…å•æ¶ˆè´¹è€…çš„ç±»å‹ï¼Œæˆ‘ä»¬å¯åŠ¨äº†ä¸¤ä¸ªçˆ¬è™«è¿›ç¨‹å’Œä¸€ä¸ªæ•°æ®æå–è¿›ç¨‹ã€‚æœ¬ç¨‹åºè®¾è®¡å—åˆ°äº†[PyCon 2018](https://youtu.be/0kXaLh8Fz3k?t=10m30s)ä¸Šçš„ä¸€æ¬¡æŠ¥å‘Šçš„å½±å“ï¼Œä½†å°†å¤§éƒ¨åˆ†ä»£ç ä½¿ç”¨äº†è¾ƒæ–°çš„ç‰¹æ€§è¿›è¡Œæ›´æ­£ã€‚æ­¤ä»£ç ä½¿ç”¨äº†`tx`ä½œä¸ºä»»åŠ¡é˜Ÿåˆ—ï¼Œæˆ‘ä»¬å°†éœ€è¦å¼‚æ­¥æ‰§è¡Œçš„å‡½æ•°æ¨å…¥æ­¤é˜Ÿåˆ—ï¼Œè¿›å…¥ä»»ä¸€è¿›ç¨‹`run_loop`äº‹ä»¶å¾ªç¯å†…è¿›è¡Œå¼‚æ­¥è¿è¡Œè°ƒåº¦ã€‚æˆ‘ä»¬åœ¨ä»£ç æœ€åå°†è¿è¡Œç»“æœæ¨é€ç»™äº†`rx`é˜Ÿåˆ—ï¼Œæ­¤é˜Ÿåˆ—ç”±`consumer`å‡½æ•°æ¶ˆè´¹ã€‚

> æ³¨æ„ï¼Œåœ¨å¤šè¿›ç¨‹ä»£ç ä¸­è¯·å°½å¯èƒ½ä¸è¦ä½¿ç”¨`bs4`åº“ï¼Œå› ä¸º`bs4`è§£æå‡ºçš„ç»“æ„ä½“æ˜¯è¿‡äºåºå¤§çš„éš¾ä»¥åºåˆ—åŒ–çš„ï¼Œå®¹æ˜“å¯¼è‡´å‡ºç°æ ˆæº¢å‡ºæŠ¥é”™ã€‚

æ­¤ä»£ç è¯»å–äº†`url_list`ä¸­çš„æ•°æ®ä½œä¸ºçˆ¬è™«çš„æ•°æ®æ¥æºã€‚è¯»è€…å¯è‡ªè¡Œåœ¨æ­¤æ–‡ä»¶å†…å¡«å…¥ä¸€äº›ç½‘é¡µçš„é“¾æ¥ï¼Œæ­¤ä»£ç ä¼šåœ¨æŒ‡å®šé“¾æ¥å†…çˆ¬å– html æ ‡é¢˜å†…å®¹ã€‚

æ­¤å¤„æˆ‘ä»¬éœ€è¦å‘`rx`ä¸­æ¨å…¥æ¶ˆè´¹è€…è¿›ç¨‹æ•°é‡çš„`None`ä»¥å…³é—­æ¶ˆè´¹è€…è¿›ç¨‹ï¼Œå¦‚æ­¤å¤„æˆ‘ä»¬ä»…å¼€å¯äº†ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œæ‰€ä»¥ä»…éœ€è¦æ¨å…¥ä¸€ä¸ª`None`å³å¯ã€‚æ­¤å¤„çš„`None`ä½œä¸ºä¿¡å·é€šçŸ¥`consumer`å‡½æ•°ä¸­æ­¢è¿è¡Œã€‚æ›´å¤šå…³äºå¤šè¿›ç¨‹çš„å†…å®¹ï¼Œè¯»è€…å¯è‡ªè¡Œå‚è€ƒä¸Šæ–‡ç»™å‡ºçš„é“¾æ¥ï¼Œæˆ–ç­‰å¾…ç¬”è€…ç¼–å†™ç›¸å…³å†…å®¹ã€‚

> ä¸Šè¿°ä»£ç åœ¨ç¬”è€…ä½¿ç”¨çš„ Python 3.11 å†…å¯æ­£å¸¸è¿è¡Œï¼Œæš‚æ—¶æœªå®éªŒå…¶ä»–ç‰ˆæœ¬ï¼Œå¦‚æœè¯»è€…å‘ç°é—®é¢˜ï¼Œå¯é€šè¿‡é‚®ä»¶ç­‰æ–¹å¼ä¸æˆ‘è”ç³»

ç¬”è€…ç®€å•æµ‹è¯•äº† 5 ä¸ªé‡å¤çš„ Python.org é“¾æ¥ï¼Œè¾“å‡ºå¦‚ä¸‹:
```plain
Welcome to Python.org
Welcome to Python.org
Welcome to Python.org
Welcome to Python.org
Welcome to Python.org
Code runtime: 1.1050703999353573
```
å¯è§ï¼Œé€šè¿‡å¤šè¿›ç¨‹ä¸å¼‚æ­¥çš„è”åˆä½¿ç”¨å¤§å¹…æé«˜äº†è¿è¡Œæ•ˆç‡ã€‚

> ç¬”è€…ä¸å»ºè®®è¯»è€…æ·±å…¥ç ”ç©¶ Python å¤šè¿›ç¨‹æœºåˆ¶ç­‰å†…å®¹ï¼Œè¿™äº›å†…å®¹åœ¨ Python è¯­è¨€ä¸­ä»å±äºå‰æ²¿ï¼Œä¸”å—åˆ¶äº Python è‡ªèº«æ€§èƒ½é—®é¢˜ï¼Œæ— æ³•è¾¾åˆ°æè‡´çš„é€Ÿåº¦ï¼Œä½¿ç”¨å¤šè¿›ç¨‹ API çš„ä½“éªŒå¹¶ä¸å¥½ã€‚è¯»è€…è€ƒè™‘ä½¿ç”¨ go è¯­è¨€æ¥ç¼–å†™é«˜æ€§èƒ½çˆ¬è™«ï¼Œå…¥é—¨ go çˆ¬è™« å¯é˜…è¯»ç¬”è€…ç¼–å†™çš„[Python2Goï¼šå°† Python è±†ç“£çˆ¬è™«ä½¿ç”¨ Go é‡æ„]({{<ref "douban-python-crawler-to-go" >}})ã€‚å½“ç„¶ï¼Œæ­¤æ–‡ç« æ²¡æœ‰æ¶‰åŠ go çš„å¹¶å‘éƒ¨åˆ†ã€‚

## æ€»ç»“

æœ¬æ–‡ä¸»è¦ä»‹ç»äº† Python å¼‚æ­¥ç¼–ç¨‹çš„ç›¸å…³å†…å®¹ï¼Œå…·ä½“åŒ…æ‹¬:

1. å¼‚æ­¥çš„åŸºæœ¬ä½¿ç”¨å’Œç›¸å…³æ¨¡å‹
1. å¼‚æ­¥çš„åŸç†åŠå®ç°
1. å¤šçº¿ç¨‹ä¸å¼‚æ­¥çš„ç»“åˆ

å¸Œæœ›å¯¹è¯»è€…ç¼–å†™ IO å¯†é›†å‹ Python åº”ç”¨å¸¦æ¥ä¸€å®šçš„å¯å‘ã€‚æœ¬æ–‡å¯¹åº”ä»£ç å¯åœ¨æ­¤[Github ä»“åº“](https://github.com/wangshouh/asynio_blog)æ‰¾åˆ°ã€‚
