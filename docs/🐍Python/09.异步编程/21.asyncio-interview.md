---
title: asyncio åç¨‹é¢è¯•é¢˜
tags: 
  - å¼‚æ­¥
  - asyncio
  - åç¨‹
  - é¢è¯•
categories: 
  - ğŸ’»å·¥ä½œ
  - ğŸPython
  - å¼‚æ­¥ç¼–ç¨‹
date: 2020-11-01 11:16:53
permalink: /python/async-interview/
---

## **1. ä»€ä¹ˆæ˜¯å¼‚æ­¥ç¼–ç¨‹ï¼Ÿasyncio ä¸å¤šçº¿ç¨‹ã€å¤šè¿›ç¨‹çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ**

**å›ç­”ï¼š**  
å¼‚æ­¥ç¼–ç¨‹æ˜¯ä¸€ç§éé˜»å¡çš„ç¼–ç¨‹æ¨¡å¼ï¼Œé€šè¿‡äº‹ä»¶å¾ªç¯è°ƒåº¦ä»»åŠ¡ï¼Œå…è®¸ç¨‹åºåœ¨ç­‰å¾… IO æ“ä½œï¼ˆå¦‚ç½‘ç»œè¯·æ±‚ã€æ–‡ä»¶è¯»å†™ï¼‰æ—¶ç»§ç»­æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œé¿å…çº¿ç¨‹é˜»å¡ã€‚  

- **asyncio ä¸å¤šçº¿ç¨‹çš„åŒºåˆ«ï¼š**  
  - **çº¿ç¨‹æ¨¡å‹**ï¼šå¤šçº¿ç¨‹é€šè¿‡æ“ä½œç³»ç»Ÿå†…æ ¸è°ƒåº¦ï¼Œæ¯ä¸ªçº¿ç¨‹æœ‰ç‹¬ç«‹æ ˆç©ºé—´ï¼Œé€‚åˆ IO å¯†é›†å‹å’Œ CPU å¯†é›†å‹ä»»åŠ¡ï¼Œä½†å­˜åœ¨çº¿ç¨‹åˆ‡æ¢å¼€é”€å’Œé”ç«äº‰é—®é¢˜ã€‚  
  - **asyncio æ¨¡å‹**ï¼šå•çº¿ç¨‹äº‹ä»¶å¾ªç¯ï¼Œé€šè¿‡åç¨‹ï¼ˆcoroutineï¼‰å®ç°ä»»åŠ¡åˆ‡æ¢ï¼Œåˆ‡æ¢å¼€é”€æä½ï¼Œé€‚åˆé«˜å¹¶å‘ IO åœºæ™¯ï¼Œä½† CPU å¯†é›†å‹ä»»åŠ¡ä¼šé˜»å¡äº‹ä»¶å¾ªç¯ã€‚  

- **asyncio ä¸å¤šè¿›ç¨‹çš„åŒºåˆ«ï¼š**  
  - å¤šè¿›ç¨‹åˆ©ç”¨å¤šæ ¸ CPUï¼Œé€‚åˆ CPU å¯†é›†å‹ä»»åŠ¡ï¼Œä½†è¿›ç¨‹é—´é€šä¿¡å¤æ‚ï¼Œå†…å­˜å ç”¨é«˜ã€‚  
  - asyncio å•çº¿ç¨‹æ¨¡å‹æ— æ³•åˆ©ç”¨å¤šæ ¸ï¼Œä½†å¯é€šè¿‡`loop.run_in_executor()`ç»“åˆçº¿ç¨‹æ± /è¿›ç¨‹æ± å¤„ç† CPU ä»»åŠ¡ã€‚  

## **2. è§£é‡Š async/await çš„å·¥ä½œåŸç†ï¼Œä¸ç”Ÿæˆå™¨æœ‰ä»€ä¹ˆå…³ç³»**

**å›ç­”ï¼š**  

- `async def`å®šä¹‰çš„æ˜¯åŸç”Ÿåç¨‹ï¼ˆcoroutineï¼‰ï¼Œ`await`ç”¨äºæŒ‚èµ·åç¨‹å¹¶ç­‰å¾…å¦ä¸€ä¸ªåç¨‹çš„ç»“æœï¼Œæœ¬è´¨æ˜¯é€šè¿‡äº‹ä»¶å¾ªç¯è°ƒåº¦åç¨‹çš„æ‰§è¡Œã€‚  
- åœ¨ Python 3.4 ä¸­ï¼Œasyncio æœ€åˆåŸºäºç”Ÿæˆå™¨ï¼ˆgeneratorï¼‰å®ç°åç¨‹ï¼ˆå¦‚`@asyncio.coroutine`å’Œ`yield from`ï¼‰ï¼Œè€Œ Python 3.5+å¼•å…¥çš„`async/await`æ˜¯åŸç”Ÿåç¨‹è¯­æ³•ï¼Œæ›´ç®€æ´ä¸”æ€§èƒ½æ›´å¥½ã€‚  
- åŸç”Ÿåç¨‹ä¸ç”Ÿæˆå™¨çš„åŒºåˆ«ï¼š  
  - ç”Ÿæˆå™¨é€šè¿‡`yield`äº§å‡ºå€¼ï¼Œé€šè¿‡`send()`ä¼ å…¥å€¼ï¼›  
  - åŸç”Ÿåç¨‹é€šè¿‡`await`ç­‰å¾…ç»“æœï¼Œåªèƒ½åœ¨`async def`å‡½æ•°ä¸­ä½¿ç”¨ï¼Œä¸”ä¸å…¼å®¹ç”Ÿæˆå™¨çš„`send()`æ–¹æ³•ã€‚  

## **3. äº‹ä»¶å¾ªç¯ï¼ˆEvent Loopï¼‰çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•åœ¨ asyncio ä¸­è·å–äº‹ä»¶å¾ªç¯**

**å›ç­”ï¼š**  
äº‹ä»¶å¾ªç¯æ˜¯ asyncio çš„æ ¸å¿ƒï¼Œè´Ÿè´£è°ƒåº¦åç¨‹çš„æ‰§è¡Œï¼Œç›‘å¬ IO äº‹ä»¶å¹¶åœ¨äº‹ä»¶å°±ç»ªæ—¶æ¢å¤åç¨‹ã€‚  

- **è·å–äº‹ä»¶å¾ªç¯çš„æ–¹å¼ï¼š**  

  ```python
  # Python 3.7+æ¨èæ–¹å¼
  import asyncio
  
  # è·å–å½“å‰çº¿ç¨‹çš„äº‹ä»¶å¾ªç¯
  loop = asyncio.get_event_loop()
  
  # åˆ›å»ºæ–°çš„äº‹ä»¶å¾ªç¯ï¼ˆä¸æ¨èåœ¨ç”Ÿäº§ç¯å¢ƒç›´æ¥ä½¿ç”¨ï¼‰
  loop = asyncio.new_event_loop()
  
  # è¿è¡Œäº‹ä»¶å¾ªç¯ç›´åˆ°åç¨‹å®Œæˆ
  result = loop.run_until_complete(coroutine())
  
  # å…³é—­äº‹ä»¶å¾ªç¯ï¼ˆç¨‹åºç»“æŸå‰è°ƒç”¨ï¼‰
  loop.close()
  ```  

- **æ³¨æ„ï¼š** åœ¨ Windows ç³»ç»Ÿä¸­ï¼Œé»˜è®¤äº‹ä»¶å¾ªç¯ä¸º`ProactorEventLoop`ï¼Œè€Œ Unix ç³»ç»Ÿä¸º`SelectorEventLoop`ï¼ŒæŸäº› API å¯èƒ½å­˜åœ¨å…¼å®¹æ€§å·®å¼‚ã€‚  

## **4. Task å’Œ Future çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•åˆ›å»º Task**

**å›ç­”ï¼š**  

- **Future**ï¼šè¡¨ç¤ºä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„æœ€ç»ˆç»“æœï¼Œæ˜¯ä¸€ä¸ªå¯ç­‰å¾…å¯¹è±¡ï¼ˆawaitableï¼‰ï¼Œé€šå¸¸ç”±åº•å±‚æ“ä½œè‡ªåŠ¨åˆ›å»ºã€‚  
- **Task**ï¼šæ˜¯ Future çš„å­ç±»ï¼Œç”¨äºåŒ…è£…åç¨‹å¹¶å°†å…¶åŠ å…¥äº‹ä»¶å¾ªç¯è°ƒåº¦ï¼Œå¯ç†è§£ä¸ºâ€œæ­£åœ¨è¿è¡Œçš„åç¨‹â€ã€‚  

- **åˆ›å»º Task çš„æ–¹å¼ï¼š**  

  ```python
  import asyncio
  
  async def my_coroutine():
      await asyncio.sleep(1)
      return "Done"
  
  # æ–¹å¼1ï¼šä½¿ç”¨loop.create_task()
  loop = asyncio.get_event_loop()
  task = loop.create_task(my_coroutine())
  
  # æ–¹å¼2ï¼šä½¿ç”¨asyncio.create_task()ï¼ˆPython 3.7+ï¼‰
  task = asyncio.create_task(my_coroutine())
  
  # ç­‰å¾…Taskå®Œæˆ
  loop.run_until_complete(task)
  print(task.result())  # è¾“å‡º "Done"
  ```  

## **5. å¦‚ä½•å¤„ç†å¼‚æ­¥ä»»åŠ¡ä¸­çš„å¼‚å¸¸ï¼Ÿæœªå¤„ç†çš„å¼‚å¸¸ä¼šå¯¼è‡´ä»€ä¹ˆé—®é¢˜**

**å›ç­”ï¼š**  

- **å¼‚å¸¸å¤„ç†æ–¹å¼ï¼š**  
  1. ä½¿ç”¨`try/except`æ•è·åç¨‹å†…çš„å¼‚å¸¸ï¼š  

     ```python
     async def task_with_exception():
         try:
             await asyncio.sleep(1)
             raise ValueError("å¼‚å¸¸ç¤ºä¾‹")
         except Exception as e:
             print(f"æ•è·å¼‚å¸¸: {e}")
     ```  

  2. å¯¹ Task ä½¿ç”¨`add_done_callback()`å¤„ç†å¼‚å¸¸ï¼š  

     ```python
     def handle_exception(task):
         if task.exception():
             print(f"Taskå¼‚å¸¸: {task.exception()}")
             
     task = asyncio.create_task(task_with_exception())
     task.add_done_callback(handle_exception)
     ```  

  3. ä½¿ç”¨`asyncio.gather()`çš„`return_exceptions`å‚æ•°ï¼š  

     ```python
     async def main():
         tasks = [task_with_exception(), another_task()]
         results = await asyncio.gather(*tasks, return_exceptions=True)
         for result in results:
             if isinstance(result, Exception):
                 print(f"å¤„ç†ç»“æœä¸­çš„å¼‚å¸¸: {result}")
     ```  

- **æœªå¤„ç†å¼‚å¸¸çš„å½±å“ï¼š** è‹¥åç¨‹æŠ›å‡ºå¼‚å¸¸ä¸”æœªè¢«æ•è·ï¼Œäº‹ä»¶å¾ªç¯ä¼šæŠ›å‡º`RuntimeError`å¹¶å¯èƒ½å¯¼è‡´ç¨‹åºå´©æºƒï¼Œå› æ­¤å¿…é¡»ç¡®ä¿å¼‚å¸¸è¢«æ­£ç¡®å¤„ç†ã€‚  

## **6. asyncio ä¸­å¦‚ä½•å®ç°å¹¶å‘æ§åˆ¶ï¼Ÿæ¯”å¦‚é™åˆ¶åŒæ—¶è¿è¡Œçš„ä»»åŠ¡æ•°**

**å›ç­”ï¼š**  

- **ä½¿ç”¨ä¿¡å·é‡ï¼ˆSemaphoreï¼‰ï¼š**  
  ä¿¡å·é‡å¯æ§åˆ¶å¹¶å‘ä»»åŠ¡çš„æ•°é‡ï¼Œé€‚åˆé™åˆ¶å¯¹å¤–éƒ¨èµ„æºï¼ˆå¦‚ API æ¥å£ã€æ•°æ®åº“è¿æ¥ï¼‰çš„è®¿é—®é¢‘ç‡ã€‚  

  ```python
  import asyncio
  
  async def task_with_semaphore(semaphore, id):
      async with semaphore:
          print(f"ä»»åŠ¡ {id} å¼€å§‹æ‰§è¡Œ")
          await asyncio.sleep(1)
          print(f"ä»»åŠ¡ {id} æ‰§è¡Œå®Œæˆ")
  
  async def main():
      # é™åˆ¶æœ€å¤š3ä¸ªä»»åŠ¡å¹¶å‘
      semaphore = asyncio.Semaphore(3)
      tasks = [task_with_semaphore(semaphore, i) for i in range(5)]
      await asyncio.gather(*tasks)
  
  asyncio.run(main())
  ```  

- **å…¶ä»–æ–¹å¼ï¼š**  
  - ä½¿ç”¨`asyncio.Semaphore`é…åˆ`asyncio.wait()`æ‰‹åŠ¨ç®¡ç†ä»»åŠ¡é˜Ÿåˆ—ï¼›  
  - å¯¹è€—æ—¶ä»»åŠ¡ä½¿ç”¨`loop.run_in_executor()`æäº¤åˆ°çº¿ç¨‹æ± /è¿›ç¨‹æ± ï¼Œé¿å…é˜»å¡äº‹ä»¶å¾ªç¯ã€‚  

## **7. å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆAsync Context Managerï¼‰å’Œå¼‚æ­¥è¿­ä»£å™¨ï¼ˆAsync Iteratorï¼‰çš„ä½œç”¨æ˜¯ä»€ä¹ˆ**

**å›ç­”ï¼š**  

- **å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨**ï¼š  
  é€šè¿‡`async with`è¯­å¥ä½¿ç”¨ï¼Œç”¨äºç®¡ç†å¼‚æ­¥èµ„æºçš„ç”Ÿå‘½å‘¨æœŸï¼ˆå¦‚è¿æ¥æ± ã€æ–‡ä»¶å¥æŸ„ï¼‰ï¼Œéœ€å®ç°`__aenter__()`å’Œ`__aexit__()`å¼‚æ­¥æ–¹æ³•ã€‚  

  ```python
  import asyncio
  
  class AsyncDatabase:
      async def __aenter__(self):
          print("è¿æ¥æ•°æ®åº“")
          return self
          
      async def __aexit__(self, exc_type, exc_val, exc_tb):
          print("å…³é—­æ•°æ®åº“è¿æ¥")
          
      async def query(self):
          await asyncio.sleep(0.1)
          return "æŸ¥è¯¢ç»“æœ"
  
  async def main():
      async with AsyncDatabase() as db:
          result = await db.query()
          print(result)
  
  asyncio.run(main())
  ```  

- **å¼‚æ­¥è¿­ä»£å™¨**ï¼š  
  é€šè¿‡`async for`è¯­å¥è¿­ä»£å¼‚æ­¥ç”Ÿæˆå™¨ï¼Œéœ€å®ç°`__aiter__()`å’Œ`__anext__()`æ–¹æ³•ï¼Œé€‚ç”¨äºæµå¼å¤„ç†å¼‚æ­¥æ•°æ®ï¼ˆå¦‚ç½‘ç»œæ•°æ®æµï¼‰ã€‚  

  ```python
  async def async_generator():
      for i in range(3):
          await asyncio.sleep(0.1)
          yield i
  
  async def main():
      async for item in async_generator():
          print(item)
  
  asyncio.run(main())
  ```  

## **8. asyncio.sleep()æ˜¯å¦‚ä½•å®ç°éé˜»å¡çš„ï¼Ÿä¸ time.sleep()çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ**

**å›ç­”ï¼š**  

- `asyncio.sleep(delay)`æ˜¯ä¸€ä¸ªåç¨‹ï¼Œé€šè¿‡äº‹ä»¶å¾ªç¯æ³¨å†Œä¸€ä¸ªå®šæ—¶å™¨äº‹ä»¶ï¼Œåœ¨æŒ‡å®šå»¶è¿Ÿåæ¢å¤åç¨‹æ‰§è¡Œï¼Œä¸ä¼šé˜»å¡äº‹ä»¶å¾ªç¯ã€‚  
- `time.sleep(delay)`æ˜¯é˜»å¡å‡½æ•°ï¼Œä¼šæš‚åœå½“å‰çº¿ç¨‹ï¼Œå¯¼è‡´äº‹ä»¶å¾ªç¯æ— æ³•è°ƒåº¦å…¶ä»–åç¨‹ï¼Œåœ¨ asyncio ä¸­ä½¿ç”¨ä¼šé€ æˆæ•´ä¸ªç¨‹åºé˜»å¡ã€‚  
- **ç¤ºä¾‹å¯¹æ¯”ï¼š**  

  ```python
  import asyncio
  import time
  
  async def async_sleep():
      print(f"å¼€å§‹å¼‚æ­¥ç¡çœ : {time.strftime('%X')}")
      await asyncio.sleep(1)  # éé˜»å¡
      print(f"ç»“æŸå¼‚æ­¥ç¡çœ : {time.strftime('%X')}")
  
  def sync_sleep():
      print(f"å¼€å§‹åŒæ­¥ç¡çœ : {time.strftime('%X')}")
      time.sleep(1)  # é˜»å¡çº¿ç¨‹
      print(f"ç»“æŸåŒæ­¥ç¡çœ : {time.strftime('%X')}")
  
  async def main():
      # å¼‚æ­¥ç¡çœ ä¸é˜»å¡å…¶ä»–ä»»åŠ¡
      await asyncio.gather(async_sleep(), async_sleep())
      
      # åŒæ­¥ç¡çœ ä¼šé˜»å¡äº‹ä»¶å¾ªç¯
      loop = asyncio.get_event_loop()
      await loop.run_in_executor(None, sync_sleep)  # éœ€æ”¾å…¥çº¿ç¨‹æ± æ‰§è¡Œ
  
  asyncio.run(main())
  ```  

## **9. å¼‚æ­¥ç¼–ç¨‹çš„ä¼˜åŠ¿å’Œé€‚ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿæœ‰å“ªäº›å±€é™æ€§**

**å›ç­”ï¼š**  

- **ä¼˜åŠ¿ï¼š**  
  - é«˜å¹¶å‘å¤„ç† IO å¯†é›†å‹ä»»åŠ¡ï¼Œå¦‚ç½‘ç»œè¯·æ±‚ã€æ•°æ®åº“æ“ä½œã€æ–‡ä»¶è¯»å†™ï¼›  
  - å•çº¿ç¨‹æ¨¡å‹å‡å°‘çº¿ç¨‹åˆ‡æ¢å¼€é”€ï¼Œå†…å­˜å ç”¨ä½ï¼›  
  - ä»£ç ç»“æ„æ›´ç®€æ´ï¼Œé¿å…å›è°ƒåœ°ç‹±ï¼ˆCallback Hellï¼‰ã€‚  

- **é€‚ç”¨åœºæ™¯ï¼š**  
  - ç½‘ç»œæœåŠ¡ï¼ˆWeb æœåŠ¡å™¨ã€API å®¢æˆ·ç«¯ï¼‰ï¼›  
  - å®æ—¶æ•°æ®å¤„ç†ï¼ˆæ—¥å¿—æ”¶é›†ã€æ¶ˆæ¯é˜Ÿåˆ—ï¼‰ï¼›  
  - åˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å¼‚æ­¥é€šä¿¡ã€‚  

- **å±€é™æ€§ï¼š**  
  - ä¸é€‚åˆ CPU å¯†é›†å‹ä»»åŠ¡ï¼ˆéœ€é…åˆçº¿ç¨‹æ± /è¿›ç¨‹æ± ï¼‰ï¼›  
  - è°ƒè¯•éš¾åº¦è¾ƒé«˜ï¼Œå¼‚å¸¸å †æ ˆå¯èƒ½ä¸å®Œæ•´ï¼›  
  - ä¸åŒæ­¥ä»£ç é›†æˆæ—¶éœ€å°å¿ƒå¤„ç†çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚  

## **10. è¯·å¯¹æ¯” asyncio.gather()å’Œ asyncio.wait()çš„ç”¨æ³•å’ŒåŒºåˆ«**

**å›ç­”ï¼š**  

| ç‰¹æ€§                | `asyncio.gather()`                          | `asyncio.wait()`                            |
|---------------------|-------------------------------------------|-------------------------------------------|
| **ä»»åŠ¡ç»„ç»‡æ–¹å¼**     | æ¥å—å¤šä¸ªåç¨‹/ä»»åŠ¡ä½œä¸ºå‚æ•°ï¼Œç»Ÿä¸€ç®¡ç†       | æ¥å—ä»»åŠ¡åˆ—è¡¨ï¼Œé€šè¿‡`return_when`æ§åˆ¶è¿”å›æ—¶æœº |
| **ç»“æœå¤„ç†**         | æŒ‰å‚æ•°é¡ºåºè¿”å›ç»“æœï¼Œå¼‚å¸¸ä¼šç›´æ¥æŠ›å‡º        | è¿”å›å®Œæˆçš„ä»»åŠ¡é›†åˆï¼Œéœ€æ‰‹åŠ¨å¤„ç†ç»“æœé¡ºåº     |
| **å¼‚å¸¸å¤„ç†**         | å¯é€šè¿‡`return_exceptions=True`æ•è·å¼‚å¸¸     | éœ€æ‰‹åŠ¨æ£€æŸ¥æ¯ä¸ªä»»åŠ¡çš„å¼‚å¸¸çŠ¶æ€               |
| **å–æ¶ˆä»»åŠ¡**         | è°ƒç”¨`gather.cancel()`å–æ¶ˆæ‰€æœ‰ä»»åŠ¡          | éœ€æ‰‹åŠ¨å–æ¶ˆæœªå®Œæˆçš„ä»»åŠ¡                     |
| **é€‚ç”¨åœºæ™¯**         | ç®€å•åœºæ™¯ä¸‹å¹¶è¡Œæ‰§è¡Œä»»åŠ¡å¹¶è·å–æœ‰åºç»“æœ       | å¤æ‚åœºæ™¯ä¸‹éœ€è¦ç²¾ç»†æ§åˆ¶ä»»åŠ¡çŠ¶æ€å’Œé¡ºåº       |

**ç¤ºä¾‹å¯¹æ¯”ï¼š**  

```python
import asyncio

async def task(i):
    await asyncio.sleep(0.1)
    return i

# ä½¿ç”¨gather
async def use_gather():
    tasks = [task(i) for i in range(3)]
    results = await asyncio.gather(*tasks)
    print("Gatherç»“æœ:", results)  # è¾“å‡º [0, 1, 2]

# ä½¿ç”¨wait
async def use_wait():
    tasks = [task(i) for i in range(3)]
    done, pending = await asyncio.wait(tasks, return_when=asyncio.ALL_COMPLETED)
    results = [task.result() for task in done]
    print("Waitç»“æœ:", results)  # è¾“å‡º [0, 1, 2]ï¼ˆé¡ºåºå¯èƒ½ä¸åŒï¼‰

asyncio.run(asyncio.gather(use_gather(), use_wait()))
```  

## **11. å¦‚ä½•åœ¨ asyncio ä¸­å¤„ç†è¶…æ—¶ï¼Ÿè¯·ä¸¾ä¾‹è¯´æ˜**

**å›ç­”ï¼š**  
ä½¿ç”¨`asyncio.wait_for()`å‡½æ•°ä¸ºåç¨‹è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œè¶…æ—¶ä¼šæŠ›å‡º`asyncio.TimeoutError`ã€‚  

```python
import asyncio

async def slow_operation():
    await asyncio.sleep(2)  # æ¨¡æ‹Ÿè€—æ—¶æ“ä½œ
    return "å®Œæˆ"

async def main():
    try:
        # è®¾ç½®1ç§’è¶…æ—¶
        result = await asyncio.wait_for(slow_operation(), timeout=1)
        print(result)
    except asyncio.TimeoutError:
        print("æ“ä½œè¶…æ—¶")

asyncio.run(main())  # è¾“å‡º "æ“ä½œè¶…æ—¶"
```  

## **12. ç®€è¿° asyncio çš„åº•å±‚å®ç°åŸç†ï¼ˆäº‹ä»¶å¾ªç¯ã€IO å¤šè·¯å¤ç”¨ç­‰ï¼‰**

**å›ç­”ï¼š**  

- **äº‹ä»¶å¾ªç¯æ ¸å¿ƒæœºåˆ¶ï¼š**  
  äº‹ä»¶å¾ªç¯åŸºäº IO å¤šè·¯å¤ç”¨ï¼ˆå¦‚ Unix çš„`select/poll/epoll`ï¼ŒWindows çš„`IOCP`ï¼‰ï¼Œé€šè¿‡æ³¨å†Œæ–‡ä»¶æè¿°ç¬¦ï¼ˆsocketã€pipe ç­‰ï¼‰çš„è¯»å†™äº‹ä»¶ï¼Œå½“äº‹ä»¶å°±ç»ªæ—¶è§¦å‘å›è°ƒå‡½æ•°æˆ–æ¢å¤åç¨‹ã€‚  
- **åç¨‹è°ƒåº¦æµç¨‹ï¼š**  
  1. åç¨‹é€šè¿‡`await`æŒ‚èµ·ï¼Œå°†æ§åˆ¶æƒäº¤è¿˜ç»™äº‹ä»¶å¾ªç¯ï¼›  
  2. äº‹ä»¶å¾ªç¯ç»§ç»­å¤„ç†å…¶ä»–å°±ç»ªçš„ IO äº‹ä»¶æˆ–å®šæ—¶ä»»åŠ¡ï¼›  
  3. å½“`await`çš„ç›®æ ‡å®Œæˆæ—¶ï¼Œäº‹ä»¶å¾ªç¯å°†åç¨‹åŠ å…¥å°±ç»ªé˜Ÿåˆ—ï¼Œç­‰å¾…è°ƒåº¦æ‰§è¡Œã€‚  
- **ä¸å…¶ä»–å¼‚æ­¥æ¡†æ¶çš„å¯¹æ¯”ï¼š**  
  - Node.js ä½¿ç”¨å•çº¿ç¨‹äº‹ä»¶å¾ªç¯+å›è°ƒå‡½æ•°ï¼Œasyncio ä½¿ç”¨åŸç”Ÿåç¨‹+`await`è¯­æ³•æ›´ç¬¦åˆåŒæ­¥ç¼–ç¨‹æ€ç»´ï¼›  
  - Tornado åŸºäºå›è°ƒå‡½æ•°ï¼Œasyncio çš„åŸç”Ÿåç¨‹æ›´æ˜“ç»´æŠ¤ã€‚  

## **13. å¦‚ä½•åœ¨ asyncio ä¸­é›†æˆåŒæ­¥ä»£ç ï¼Ÿæœ‰å“ªäº›æ³¨æ„äº‹é¡¹**

**å›ç­”ï¼š**  
é€šè¿‡`loop.run_in_executor()`å°†åŒæ­¥å‡½æ•°æäº¤åˆ°çº¿ç¨‹æ± æˆ–è¿›ç¨‹æ± æ‰§è¡Œï¼Œé¿å…é˜»å¡äº‹ä»¶å¾ªç¯ã€‚  

```python
import asyncio
import time

def sync_function():
    time.sleep(1)  # åŒæ­¥é˜»å¡å‡½æ•°
    return "åŒæ­¥ç»“æœ"

async def main():
    loop = asyncio.get_event_loop()
    
    # æäº¤åˆ°é»˜è®¤çº¿ç¨‹æ± ï¼ˆThreadPoolExecutorï¼‰
    result1 = await loop.run_in_executor(None, sync_function)
    
    # æäº¤åˆ°è‡ªå®šä¹‰è¿›ç¨‹æ± ï¼ˆé€‚åˆCPUå¯†é›†å‹ä»»åŠ¡ï¼‰
    from concurrent.futures import ProcessPoolExecutor
    with ProcessPoolExecutor() as executor:
        result2 = await loop.run_in_executor(executor, sync_function)
    
    print(result1, result2)

asyncio.run(main())
```  

**æ³¨æ„äº‹é¡¹ï¼š**  

- çº¿ç¨‹æ± é€‚ç”¨äº IO å¯†é›†å‹åŒæ­¥ä»»åŠ¡ï¼Œè¿›ç¨‹æ± é€‚ç”¨äº CPU å¯†é›†å‹ä»»åŠ¡ï¼›  
- è·¨çº¿ç¨‹/è¿›ç¨‹ä¼ é€’æ•°æ®éœ€æ³¨æ„åºåˆ—åŒ–é—®é¢˜ï¼ˆå¦‚ä½¿ç”¨ pickleï¼‰ï¼›  
- é¿å…é¢‘ç¹åˆ›å»ºçº¿ç¨‹æ± /è¿›ç¨‹æ± ï¼Œå»ºè®®å¤ç”¨å®ä¾‹ã€‚  

### æ€»ç»“

asyncio åç¨‹é¢è¯•é¢˜æ ¸å¿ƒå›´ç»•**äº‹ä»¶å¾ªç¯æœºåˆ¶ã€åç¨‹ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€å¹¶å‘æ§åˆ¶ã€å¼‚å¸¸å¤„ç†**åŠ**ä¸å…¶ä»–ç¼–ç¨‹æ¨¡å‹çš„å¯¹æ¯”**ã€‚ç†è§£è¿™äº›æ¦‚å¿µä¸ä»…èƒ½åº”å¯¹é¢è¯•ï¼Œæ›´èƒ½åœ¨å®é™…å¼€å‘ä¸­é«˜æ•ˆè¿ç”¨å¼‚æ­¥ç¼–ç¨‹ä¼˜åŒ– IO å¯†é›†å‹åœºæ™¯çš„æ€§èƒ½ã€‚
