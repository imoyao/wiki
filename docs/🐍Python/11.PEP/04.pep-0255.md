---
title: '[è¯‘] PEP 255--ç®€å•çš„ç”Ÿæˆå™¨'
categories: 
  - ðŸ’» å·¥ä½œ
  - ðŸPython
  - PEP
date: 2019-11-27 23:34:31
permalink: /peps/39d227/
tags: 
---

**PEP åŽŸæ–‡**ï¼šhttps://www.python.org/dev/peps/pep-0255

**åˆ›å»ºæ—¥æœŸ**ï¼š2001-05-18

**åˆå…¥ç‰ˆæœ¬**ï¼š2.2

**è¯‘è€…** ï¼š[è±Œè±†èŠ±ä¸‹çŒ«](https://zhuanlan.zhihu.com/pythonCat)ï¼ˆ**Python çŒ«** å…¬ä¼—å·ä½œè€…ï¼‰



## æ‘˜è¦

è¿™ä¸ª PEP æƒ³åœ¨ Python ä¸­å¼•å…¥ç”Ÿæˆå™¨çš„æ¦‚å¿µï¼Œä»¥åŠä¸€ä¸ªæ–°çš„è¡¨è¾¾å¼ï¼Œå³ yield è¡¨è¾¾å¼ã€‚

## åŠ¨æœº

å½“ä¸€ä¸ªç”Ÿäº§è€…å‡½æ•°åœ¨å¤„ç†æŸäº›è‰°éš¾çš„ä»»åŠ¡æ—¶ï¼Œå®ƒå¯èƒ½éœ€è¦ç»´æŒä½ç”Ÿäº§å®ŒæŸä¸ªå€¼æ—¶çš„çŠ¶æ€ï¼Œå¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€éƒ½æä¾›ä¸äº†æ—¢èˆ’æœåˆé«˜æ•ˆçš„æ–¹æ¡ˆï¼Œé™¤äº†å¾€å‚æ•°åˆ—è¡¨ä¸­æ·»åŠ å›žè°ƒå‡½æ•°ï¼Œç„¶åŽæ¯ç”Ÿäº§ä¸€ä¸ªå€¼æ—¶å°±åŽ»è°ƒç”¨ä¸€ä¸‹ã€‚

ä¾‹å¦‚ï¼Œæ ‡å‡†åº“ä¸­çš„`tokenize.py`é‡‡ç”¨è¿™ç§æ–¹æ³•ï¼šè°ƒç”¨è€…å¿…é¡»ä¼ ä¸€ä¸ª tokeneater å‡½æ•°ç»™ tokenize() ï¼Œå½“ tokenize() æ‰¾åˆ°ä¸‹ä¸€ä¸ª token æ—¶å†è°ƒç”¨ã€‚è¿™ä½¿å¾— tokenize èƒ½ä»¥è‡ªç„¶çš„æ–¹å¼ç¼–ç ï¼Œä½†ç¨‹åºè°ƒç”¨ tokenize ä¼šå˜å¾—æžå…¶å¤æ‚ï¼Œå› ä¸ºå®ƒéœ€è¦è®°ä½æ¯æ¬¡å›žè°ƒå‰æœ€åŽå‡ºçŽ°çš„æ˜¯å“ªä¸ª token(s)ã€‚`tabnanny.py`ä¸­çš„ tokeneater å‡½æ•°æ˜¯å¤„ç†å¾—æ¯”è¾ƒå¥½çš„ä¾‹å­ï¼Œå®ƒåœ¨å…¨å±€å˜é‡ä¸­ç»´æŠ¤äº†ä¸€ä¸ªçŠ¶æ€æœºï¼Œç”¨äºŽè®°å½•å·²å‡ºçŽ°çš„ token å’Œé¢„æœŸä¼šå‡ºçŽ°çš„ token ã€‚è¿™å¾ˆéš¾æ­£ç¡®åœ°å·¥ä½œï¼Œè€Œä¸”ä¹ŸæŒºéš¾è®©äººç†è§£ã€‚ä¸å¹¸çš„æ˜¯ï¼Œå®ƒå·²ç»æ˜¯æœ€æ ‡å‡†çš„è§£å†³æ–¹æ³•äº†ã€‚

æœ‰ä¸€ä¸ªæ›¿ä»£æ–¹æ¡ˆæ˜¯ä¸€æ¬¡æ€§ç”Ÿæˆ Python ç¨‹åºçš„å…¨éƒ¨è§£æžï¼Œå¹¶å­˜å…¥è¶…å¤§åˆ—è¡¨ä¸­ã€‚è¿™æ · tokenize å®¢æˆ·ç«¯å¯ä»¥ç”¨è‡ªç„¶çš„æ–¹å¼ï¼Œå³ä½¿ç”¨å±€éƒ¨å˜é‡å’Œå±€éƒ¨æŽ§åˆ¶æµï¼ˆä¾‹å¦‚å¾ªçŽ¯å’ŒåµŒå¥—çš„ if è¯­å¥ï¼‰ï¼Œæ¥è·Ÿè¸ªå…¶çŠ¶æ€ã€‚ç„¶è€Œè¿™å¹¶ä¸å®žç”¨ï¼šç¨‹åºä¼šå˜å¾—è‡ƒè‚¿ï¼Œå› æ­¤ä¸èƒ½åœ¨å®žçŽ°æ•´ä¸ªè§£æžæ‰€éœ€çš„å†…å­˜ä¸Šæ”¾ç½®å…ˆéªŒé™åˆ¶ï¼›è€Œæœ‰äº› tokenize å®¢æˆ·ç«¯ä»…ä»…æƒ³è¦æŸ¥çœ‹æŸä¸ªç‰¹å®šçš„ä¸œè¥¿æ˜¯å¦æ›¾å‡ºçŽ°ï¼ˆä¾‹å¦‚ï¼Œfuture å£°æ˜Žï¼Œæˆ–è€…åƒ IDLE åšçš„é‚£æ ·ï¼Œåªæ˜¯é¦–ä¸ªç¼©è¿›çš„å£°æ˜Žï¼‰ï¼Œå› æ­¤è§£æžæ•´ä¸ªç¨‹åºå°±æ˜¯ä¸¥é‡åœ°æµªè´¹æ—¶é—´ã€‚

å¦ä¸€ä¸ªæ›¿ä»£æ–¹æ¡ˆæ˜¯æŠŠ tokenize å˜ä¸ºä¸€ä¸ªè¿­ä»£å™¨ã€æ³¨é‡Š 1ã€‘ï¼Œæ¯æ¬¡è°ƒç”¨å®ƒçš„ next() æ–¹æ³•æ—¶å†ä¼ é€’ä¸‹ä¸€ä¸ª tokenã€‚è¿™å¯¹è°ƒç”¨è€…æ¥è¯´å¾ˆä¾¿åˆ©ï¼Œå°±åƒå‰ä¸€æ–¹æ¡ˆæŠŠç»“æžœå­˜å…¥å¤§åˆ—è¡¨ä¸€æ ·ï¼ŒåŒæ—¶æ²¡æœ‰å†…å­˜ä¸Žâ€œæƒ³è¦æ—©ç‚¹é€€å‡ºæ€Žä¹ˆåŠžâ€çš„ç¼ºç‚¹ã€‚ç„¶è€Œï¼Œè¿™ä¸ªæ–¹æ¡ˆä¹ŸæŠŠ tokenize çš„è´Ÿæ‹…è½¬åŒ–æˆè®°ä½ next() çš„è°ƒç”¨çŠ¶æ€ï¼Œè¯»è€…åªè¦çž„ä¸€çœ¼ tokenize.tokenize_loop() ï¼Œå°±ä¼šæ„è¯†åˆ°è¿™æ˜¯ä¸€ä»¶å¤šä¹ˆå¯æ€•çš„è‹¦å·®äº‹ã€‚æˆ–è€…æƒ³è±¡ä¸€ä¸‹ï¼Œç”¨é€’å½’ç®—æ³•æ¥ç”Ÿæˆæ™®é€šæ ‘ç»“æž„çš„èŠ‚ç‚¹ï¼šè‹¥æŠŠå®ƒæŠ•å°„æˆä¸€ä¸ªè¿­ä»£å™¨æ¡†æž¶å®žçŽ°ï¼Œå°±éœ€è¦æ‰‹åŠ¨åœ°ç§»é™¤é€’å½’çŠ¶æ€å¹¶ç»´æŠ¤éåŽ†çš„çŠ¶æ€ã€‚

ç¬¬å››ç§é€‰æ‹©æ˜¯åœ¨ä¸åŒçš„çº¿ç¨‹ä¸­è¿è¡Œç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ã€‚è¿™å…è®¸ä¸¤è€…ä»¥è‡ªç„¶çš„æ–¹å¼ç»´æŠ¤å…¶çŠ¶æ€ï¼Œæ‰€ä»¥éƒ½ä¼šå¾ˆèˆ’æœã€‚å®žé™…ä¸Šï¼ŒPython æºä»£ç å‘è¡Œç‰ˆä¸­çš„ Demo/threads/Generator.py å°±æä¾›äº†ä¸€ä¸ªå¯ç”¨çš„åŒæ­¥é€šä¿¡ï¼ˆsynchronized-communicationï¼‰ç±»ï¼Œæ¥å®Œæˆä¸€èˆ¬çš„ä»»åŠ¡ã€‚ä½†æ˜¯ï¼Œè¿™åœ¨æ²¡æœ‰çº¿ç¨‹çš„å¹³å°ä¸Šæ— æ³•è¿ç”¨ï¼Œè€Œä¸”å°±ç®—å¯ç”¨ä¹Ÿä¼šå¾ˆæ…¢ï¼ˆä¸Žä¸ç”¨çº¿ç¨‹å¯å–å¾—çš„æˆå°±ç›¸æ¯”ï¼‰ã€‚

æœ€åŽä¸€ä¸ªé€‰æ‹©æ˜¯ä½¿ç”¨ Python çš„å˜ç§ Stackless ã€æ³¨é‡Š 2-3ã€‘æ¥å®žçŽ°ï¼Œå®ƒæ”¯æŒè½»é‡çº§çš„åç¨‹ã€‚å®ƒä¸Žå‰è¿°çš„çº¿ç¨‹æ–¹æ¡ˆæœ‰ç›¸åŒçš„ç¼–ç¨‹ä¼˜åŠ¿ï¼Œæ•ˆçŽ‡è¿˜æ›´é«˜ã€‚ç„¶è€Œï¼ŒStackless åœ¨ Python æ ¸å¿ƒå±‚å­˜åœ¨äº‰è®®ï¼ŒJython ä¹Ÿå¯èƒ½ä¸ä¼šå®žçŽ°ç›¸åŒçš„è¯­ä¹‰ã€‚è¿™ä¸ª PEP ä¸æ˜¯è®¨è®ºè¿™äº›é—®é¢˜çš„åœ°æ–¹ï¼Œä½†å®Œå…¨å¯ä»¥è¯´ç”Ÿæˆå™¨æ˜¯ Stackless ç›¸å…³åŠŸèƒ½çš„å­é›†åœ¨å½“å‰ CPython ä¸­çš„ä¸€ç§ç®€å•å®žçŽ°ï¼Œè€Œä¸”å¯ä»¥è¯´ï¼Œå…¶å®ƒ Python å®žçŽ°èµ·æ¥ä¹Ÿç›¸å¯¹ç®€å•ã€‚

ä»¥ä¸Šåˆ†æžå®Œäº†å·²æœ‰çš„æ–¹æ¡ˆã€‚å…¶å®ƒä¸€äº›é«˜çº§è¯­è¨€ä¹Ÿæä¾›äº†ä¸é”™çš„è§£å†³æ–¹æ¡ˆï¼Œç‰¹åˆ«æ˜¯ Sather çš„è¿­ä»£å™¨ï¼Œå®ƒå—åˆ° CLU çš„è¿­ä»£å™¨å¯å‘ã€æ³¨é‡Š 4ã€‘ï¼›Icon çš„ç”Ÿæˆå™¨ï¼Œä¸€ç§æ–°é¢–çš„è¯­è¨€ï¼Œå…¶ä¸­æ¯ä¸ªè¡¨è¾¾å¼éƒ½æ˜¯ç”Ÿæˆå™¨ã€æ³¨é‡Š 5ã€‘ã€‚å®ƒä»¬è™½æœ‰å·®å¼‚ï¼Œä½†åŸºæœ¬çš„æ€è·¯æ˜¯ä¸€è‡´çš„ï¼šæä¾›ä¸€ç§å‡½æ•°ï¼Œå®ƒå¯ä»¥è¿”å›žä¸­é—´ç»“æžœï¼ˆâ€œä¸‹ä¸€ä¸ªå€¼â€ï¼‰ç»™å®ƒçš„è°ƒç”¨è€…ï¼ŒåŒæ—¶è¿˜ä¿å­˜äº†å‡½æ•°çš„å±€éƒ¨çŠ¶æ€ï¼Œä»¥ä¾¿åœ¨åœæ­¢çš„ä½ç½®æ¢å¤ï¼ˆè¯‘æ³¨ï¼šresumï¼Œä¸‹æ–‡ä¹Ÿè¯‘ä½œæ¿€æ´»ï¼‰è°ƒç”¨ã€‚ä¸€ä¸ªéžå¸¸ç®€å•çš„ä¾‹å­ï¼š

```plain
def fib():
    a, b = 0, 1
    while 1:
       yield b
       a, b = b, a+b
```

å½“ fib() é¦–æ¬¡è¢«è°ƒç”¨æ—¶ï¼Œå®ƒå°† a è®¾ä¸º 0ï¼Œå°† b è®¾ä¸º 1ï¼Œç„¶åŽç”Ÿæˆ b ç»™å…¶è°ƒç”¨è€…ã€‚è°ƒç”¨è€…å¾—åˆ° 1ã€‚å½“ fib æ¢å¤æ—¶ï¼Œä»Žå®ƒçš„è§’åº¦æ¥çœ‹ï¼Œyield è¯­å¥å®žé™…ä¸Šè·Ÿ print è¯­å¥ç›¸åŒï¼šfib ç»§ç»­æ‰§è¡Œï¼Œä¸”æ‰€æœ‰å±€éƒ¨çŠ¶æ€å®Œå¥½æ— æŸã€‚ç„¶åŽï¼Œa å’Œ b çš„å€¼å˜ä¸º 1ï¼Œå¹¶ä¸” fib å†æ¬¡å¾ªçŽ¯åˆ° yieldï¼Œç”Ÿæˆ 1 ç»™å®ƒçš„è°ƒç”¨è€…ã€‚ä»¥æ­¤ç±»æŽ¨ã€‚ ä»Ž fib çš„è§’åº¦æ¥çœ‹ï¼Œå®ƒåªæ˜¯æä¾›ä¸€ç³»åˆ—ç»“æžœï¼Œå°±åƒç”¨äº†å›žè°ƒä¸€æ ·ã€‚ä½†æ˜¯ä»Žè°ƒç”¨è€…çš„è§’åº¦æ¥çœ‹ï¼Œfib çš„è°ƒç”¨å°±æ˜¯ä¸€ä¸ªå¯éšæ—¶æ¢å¤çš„å¯è¿­ä»£å¯¹è±¡ã€‚è·Ÿçº¿ç¨‹ä¸€æ ·ï¼Œè¿™å…è®¸ä¸¤è¾¹ä»¥æœ€è‡ªç„¶çš„æ–¹å¼è¿›è¡Œç¼–ç ï¼›ä½†ä¸Žçº¿ç¨‹æ–¹æ³•ä¸åŒï¼Œè¿™å¯ä»¥åœ¨æ‰€æœ‰å¹³å°ä¸Šé«˜æ•ˆå®Œæˆã€‚äº‹å®žä¸Šï¼Œæ¢å¤ç”Ÿæˆå™¨åº”è¯¥ä¸æ¯”å‡½æ•°è°ƒç”¨æ˜‚è´µã€‚

åŒæ ·çš„æ–¹æ³•é€‚ç”¨äºŽè®¸å¤šç”Ÿäº§è€…/æ¶ˆè´¹è€…å‡½æ•°ã€‚ä¾‹å¦‚ï¼Œtokenize.py å¯ä»¥ç”Ÿæˆä¸‹ä¸€ä¸ª token è€Œä¸æ˜¯ç”¨å®ƒä½œä¸ºå‚æ•°è°ƒç”¨å›žè°ƒå‡½æ•°ï¼Œè€Œä¸” tokenize å®¢æˆ·ç«¯å¯ä»¥ä»¥è‡ªç„¶çš„æ–¹å¼è¿­ä»£ tokensï¼šPython ç”Ÿæˆå™¨æ˜¯ä¸€ç§è¿­ä»£å™¨ï¼Œä½†æ˜¯ç‰¹åˆ«å¼ºå¤§ã€‚

## è®¾è®¡è§„æ ¼ï¼šyield

å¼•å…¥äº†ä¸€ç§æ–°çš„è¡¨è¾¾å¼ï¼š

> yield_stmtï¼šâ€œyieldâ€expression_list

yield æ˜¯ä¸€ä¸ªæ–°çš„å…³é”®å­—ï¼Œå› æ­¤éœ€è¦ä¸€ä¸ª `future` å£°æ˜Žã€æ³¨é‡Š 8ã€‘æ¥è¿›è¡Œå¼•å…¥ï¼šåœ¨æ—©æœŸç‰ˆæœ¬ä¸­ï¼Œè‹¥æƒ³ä½¿ç”¨ç”Ÿæˆå™¨çš„æ¨¡å—ï¼Œå¿…é¡»åœ¨æŽ¥è¿‘å¤´éƒ¨å¤„åŒ…å«ä»¥ä¸‹è¡Œï¼ˆè¯¦è§ PEP 236ï¼‰ï¼š

```plain
from __future__ import generators
```

æ²¡æœ‰å¼•å…¥ future æ¨¡å—å°±ä½¿ç”¨ yield å…³é”®å­—ï¼Œå°†ä¼šå‘Šè­¦ã€‚ åœ¨åŽç»­çš„ç‰ˆæœ¬ä¸­ï¼Œyield å°†æ˜¯ä¸€ä¸ªè¯­è¨€å…³é”®å­—ï¼Œä¸å†éœ€è¦ future è¯­å¥ã€‚

yield è¯­å¥åªèƒ½åœ¨å‡½æ•°å†…éƒ¨ä½¿ç”¨ã€‚åŒ…å« yield è¯­å¥çš„å‡½æ•°è¢«ç§°ä¸ºç”Ÿæˆå™¨å‡½æ•°ã€‚ä»Žå„æ–¹é¢æ¥çœ‹ï¼Œç”Ÿæˆå™¨å‡½æ•°éƒ½åªæ˜¯ä¸ªæ™®é€šå‡½æ•°ï¼Œä½†åœ¨å®ƒçš„ä»£ç å¯¹è±¡çš„ co_flags ä¸­è®¾ç½®äº†æ–°çš„â€œCO_GENERATORâ€æ ‡å¿—ã€‚

å½“è°ƒç”¨ç”Ÿæˆå™¨å‡½æ•°æ—¶ï¼Œå®žé™…å‚æ•°è¿˜æ˜¯ç»‘å®šåˆ°å‡½æ•°çš„å±€éƒ¨å˜é‡ç©ºé—´ï¼Œä½†ä¸ä¼šæ‰§è¡Œä»£ç ã€‚å¾—åˆ°çš„æ˜¯ä¸€ä¸ª generator-iterator å¯¹è±¡ï¼›è¿™ç¬¦åˆè¿­ä»£å™¨åè®®ã€æ³¨é‡Š 6ã€‘ï¼Œå› æ­¤å¯ç”¨äºŽ for å¾ªçŽ¯ã€‚æ³¨æ„ï¼Œåœ¨ä¸Šä¸‹æ–‡æ— æ­§ä¹‰çš„æƒ…å†µä¸‹ï¼Œéžé™å®šåç§° â€œgeneratorâ€ æ—¢å¯ä»¥æŒ‡ç”Ÿæˆå™¨å‡½æ•°ï¼Œåˆå¯ä»¥æŒ‡ç”Ÿæˆå™¨-è¿­ä»£å™¨ï¼ˆgenerator-iteratorï¼‰ã€‚

æ¯æ¬¡è°ƒç”¨ generator-iterator çš„ next() æ–¹æ³•æ—¶ï¼Œæ‰ä¼šæ‰§è¡Œ generator-function ä½“ä¸­çš„ä»£ç ï¼Œç›´è‡³é‡åˆ° yield æˆ– return è¯­å¥ï¼ˆè§ä¸‹æ–‡ï¼‰ï¼Œæˆ–è€…ç›´æŽ¥è¿­ä»£åˆ°å°½å¤´ã€‚

å¦‚æžœæ‰§è¡Œåˆ° yield è¯­å¥ï¼Œåˆ™å‡½æ•°çš„çŠ¶æ€ä¼šè¢«å†»ç»“ï¼Œå¹¶å°† expression_list çš„å€¼è¿”å›žç»™ next() çš„è°ƒç”¨è€…ã€‚â€œå†»ç»“â€æ˜¯æŒ‡æŒ‚èµ·æ‰€æœ‰æœ¬åœ°çŠ¶æ€ï¼ŒåŒ…æ‹¬å±€éƒ¨å˜é‡ã€æŒ‡ä»¤æŒ‡é’ˆå’Œå†…éƒ¨å †æ ˆï¼šä¿å­˜è¶³å¤Ÿçš„ä¿¡æ¯ï¼Œä»¥ä¾¿åœ¨ä¸‹æ¬¡è°ƒç”¨ next() æ—¶ï¼Œå‡½æ•°å¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œä»¿ä½› yield è¯­å¥åªæ˜¯ä¸€æ¬¡æ™®é€šçš„å¤–éƒ¨è°ƒç”¨ã€‚

é™åˆ¶ï¼šyield è¯­å¥ä¸èƒ½ç”¨äºŽ try-finally ç»“æž„çš„ try å­å¥ä¸­ã€‚å›°éš¾çš„æ˜¯ä¸èƒ½ä¿è¯ç”Ÿæˆå™¨ä¼šè¢«å†æ¬¡æ¿€æ´»ï¼ˆresumï¼‰ï¼Œå› æ­¤æ— æ³•ä¿è¯ finally è¯­å¥å—ä¼šè¢«æ‰§è¡Œï¼›è¿™å°±å¤ªè¿èƒŒ finally çš„ç”¨å¤„äº†ã€‚

é™åˆ¶ï¼šç”Ÿæˆå™¨åœ¨æ´»è·ƒçŠ¶æ€æ—¶æ— æ³•è¢«å†æ¬¡æ¿€æ´»ï¼š

```plain
>>> def g():
...     i = me.next()
...     yield i
>>> me = g()
>>> me.next()
Traceback (most recent call last):
 ...
 File "<string>", line 2, in g
ValueError: generator already executing
```

## è®¾è®¡è§„æ ¼ï¼šreturn

ç”Ÿæˆå™¨å‡½æ•°è¿˜å¯ä»¥åŒ…å«ä»¥ä¸‹å½¢å¼çš„ return è¯­å¥ï¼š

```plain
return
```

æ³¨æ„ï¼Œç”Ÿæˆå™¨ä¸»ä½“ä¸­çš„ return è¯­å¥ä¸å…è®¸ä½¿ç”¨ expression_list ï¼ˆç„¶è€Œå½“ç„¶ï¼Œå®ƒä»¬å¯ä»¥åµŒå¥—åœ°ä½¿ç”¨åœ¨ç”Ÿæˆå™¨é‡Œçš„éžç”Ÿæˆå™¨å‡½æ•°ä¸­ï¼‰ã€‚

å½“æ‰§è¡Œåˆ° return è¯­å¥æ—¶ï¼Œç¨‹åºä¼šæ­£å¸¸ returnï¼Œç»§ç»­æ‰§è¡Œæ°å½“çš„ finally å­å¥ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰ã€‚ç„¶åŽå¼•å‘ä¸€ä¸ª StopIteration å¼‚å¸¸ï¼Œè¡¨æ˜Žè¿­ä»£å™¨å·²ç»è€—å°½ã€‚å¦‚æžœç¨‹åºæ²¡æœ‰æ˜¾å¼ return è€Œæ‰§è¡Œåˆ°ç”Ÿæˆå™¨çš„æœ«å°¾ï¼Œä¹Ÿä¼šå¼•å‘ StopIteration å¼‚å¸¸ã€‚

è¯·æ³¨æ„ï¼Œå¯¹äºŽç”Ÿæˆå™¨å‡½æ•°å’Œéžç”Ÿæˆå™¨å‡½æ•°ï¼Œreturn æ„å‘³ç€â€œæˆ‘å·²ç»å®Œæˆï¼Œå¹¶ä¸”æ²¡æœ‰ä»»ä½•æœ‰è¶£çš„ä¸œè¥¿å¯ä»¥è¿”å›žâ€ã€‚

æ³¨æ„ï¼Œreturn å¹¶ä¸ä¸€å®šä¼šå¼•å‘ StopIteration ï¼šå…³é”®åœ¨äºŽå¦‚ä½•å¤„ç†å°é—­çš„ try-except ç»“æž„ã€‚ ä¾‹å¦‚ï¼š

```plain
>>> def f1():
...     try:
...         return
...     except:
...        yield 1
>>> print list(f1())
[]
```

å› ä¸ºï¼Œå°±åƒåœ¨ä»»ä½•å‡½æ•°ä¸­ä¸€æ ·ï¼Œreturn åªæ˜¯é€€å‡ºï¼Œä½†æ˜¯ï¼š

```plain
>>> def f2():
...     try:
...         raise StopIteration
...     except:
...         yield 42
>>> print list(f2())
[42]
```

å› ä¸º StopIteration è¢«ä¸€ä¸ªç®€å•çš„ except æ•èŽ·ï¼Œå°±åƒä»»æ„å¼‚å¸¸ä¸€æ ·ã€‚

## è®¾è®¡è§„æ ¼ï¼šç”Ÿæˆå™¨å’Œå¼‚å¸¸ä¼ æ’­

å¦‚æžœä¸€ä¸ªæœªæ•èŽ·çš„å¼‚å¸¸â€”â€”åŒ…æ‹¬ä½†ä¸é™äºŽ StopIterationâ€”â€”ç”±ç”Ÿæˆå™¨å‡½æ•°å¼•å‘æˆ–ä¼ é€’ï¼Œåˆ™å¼‚å¸¸ä¼šä»¥é€šå¸¸çš„æ–¹å¼ä¼ é€’ç»™è°ƒç”¨è€…ï¼Œè‹¥è¯•å›¾é‡æ–°æ¿€æ´»ç”Ÿæˆå™¨å‡½æ•°çš„è¯ï¼Œåˆ™ä¼šå¼•å‘ StopIteration ã€‚ æ¢å¥è¯è¯´ï¼Œæœªæ•èŽ·çš„å¼‚å¸¸ç»ˆç»“äº†ç”Ÿæˆå™¨çš„ä½¿ç”¨å¯¿å‘½ã€‚

ç¤ºä¾‹ï¼ˆä¸åˆè¯­è¨€ä¹ æƒ¯ï¼Œä»…ä½œä¸¾ä¾‹ï¼‰ï¼š

```plain
>>> def f():
...     return 1/0
>>> def g():
...     yield f()  # the zero division exception propagates
...     yield 42   # and we'll never get here
>>> k = g()
>>> k.next()
Traceback (most recent call last):
  File "<stdin>", line 1, in ?
  File "<stdin>", line 2, in g
  File "<stdin>", line 2, in f
ZeroDivisionError: integer division or modulo by zero
>>> k.next()  # and the generator cannot be resumed
Traceback (most recent call last):
  File "<stdin>", line 1, in ?
StopIteration
>>>
```

## è®¾è®¡è§„æ ¼ï¼šTry/Exception/Finally

å‰é¢æè¿‡ï¼Œyield è¯­å¥ä¸èƒ½ç”¨äºŽ try-finally ç»“æž„çš„ try å­å¥ä¸­ã€‚è¿™å¸¦æ¥çš„ç»“æžœæ˜¯ç”Ÿæˆå™¨è¦éžå¸¸è°¨æ…Žåœ°åˆ†é…å…³é”®çš„èµ„æºã€‚ä½†æ˜¯åœ¨å…¶å®ƒåœ°æ–¹ï¼Œyield è¯­å¥å¹¶æ— é™åˆ¶ï¼Œä¾‹å¦‚ finally å­å¥ã€except å­å¥ã€æˆ–è€… try-except ç»“æž„çš„ try å­å¥ï¼š

```plain
>>> def f():
...     try:
...         yield 1
...         try:
...             yield 2
...             1/0
...             yield 3  # never get here
...         except ZeroDivisionError:
...             yield 4
...             yield 5
...             raise
...         except:
...             yield 6
...         yield 7     # the "raise" above stops this
...     except:
...         yield 8
...     yield 9
...     try:
...         x = 12
...     finally:
...        yield 10
...     yield 11
>>> print list(f())
[1, 2, 4, 5, 8, 9, 10, 11]
>>>
```

## ç¤ºä¾‹

```plain
# äºŒå‰æ ‘ç±»
class Tree:

    def __init__(self, label, left=None, right=None):
        self.label = label
        self.left = left
        self.right = right

    def __repr__(self, level=0, indent="    "):
        s = level*indent + `self.label`
        if self.left:
            s = s + "\n" + self.left.__repr__(level+1, indent)
        if self.right:
            s = s + "\n" + self.right.__repr__(level+1, indent)
        return s

    def __iter__(self):
        return inorder(self)

# ä»Žåˆ—è¡¨ä¸­åˆ›å»º Tree
def tree(list):
    n = len(list)
    if n == 0:
        return []
    i = n / 2
    return Tree(list[i], tree(list[:i]), tree(list[i+1:]))

# é€’å½’ç”Ÿæˆå™¨ï¼ŒæŒ‰é¡ºåºç”Ÿæˆæ ‘æ ‡ç­¾
def inorder(t):
    if t:
        for x in inorder(t.left):
            yield x
        yield t.label
        for x in inorder(t.right):
            yield x

# å±•ç¤ºï¼šåˆ›å»ºä¸€æ£µæ ‘
t = tree("ABCDEFGHIJKLMNOPQRSTUVWXYZ")
# æŒ‰é¡ºåºæ‰“å°æ ‘çš„èŠ‚ç‚¹
for x in t:
    print x,
print

# éžé€’å½’ç”Ÿæˆå™¨
def inorder(node):
    stack = []
    while node:
        while node.left:
            stack.append(node)
            node = node.left
        yield node.label
        while not node.right:
            try:
                node = stack.pop()
            except IndexError:
                return
            yield node.label
        node = node.right

# ç»ƒä¹ éžé€’å½’ç”Ÿæˆå™¨
for x in t:
    print x,
print
Both output blocks display:

A B C D E F G H I J K L M N O P Q R S T U V W X Y Z
```

## é—®ç­”

### ä¸ºä»€ä¹ˆé‡ç”¨ def è€Œä¸ç”¨æ–°çš„å…³é”®å­—

è¯·å‚é˜…ä¸‹é¢çš„ BDFL å£°æ˜Žéƒ¨åˆ†ã€‚

### ä¸ºä»€ä¹ˆç”¨æ–°çš„å…³é”®å­— yield è€Œéžå†…ç½®å‡½æ•°

Python ä¸­é€šè¿‡å…³é”®å­—èƒ½æ›´å¥½åœ°è¡¨è¾¾æŽ§åˆ¶æµï¼Œå³ yield æ˜¯ä¸€ä¸ªæŽ§åˆ¶ç»“æž„ã€‚è€Œä¸”ä¸ºäº† Jython çš„é«˜æ•ˆå®žçŽ°ï¼Œç¼–è¯‘å™¨éœ€è¦åœ¨ç¼–è¯‘æ—¶å°±ç¡®å®šæ½œåœ¨çš„æŒ‚èµ·ç‚¹ï¼Œæ–°çš„å…³é”®å­—ä¼šä½¿è¿™ä¸€ç‚¹å˜å¾—ç®€å•ã€‚CPython çš„å®žçŽ°ä¹Ÿå¤§é‡åˆ©ç”¨å®ƒæ¥æ£€æµ‹å“ªäº›å‡½æ•°æ˜¯ç”Ÿæˆå™¨å‡½æ•°ï¼ˆå°½ç®¡ä¸€ä¸ªæ–°çš„å…³é”®å­—æ›¿ä»£ def å°±èƒ½è§£å†³ CPython çš„é—®é¢˜ï¼Œä½†äººä»¬é—®â€œä¸ºä»€ä¹ˆè¦æ–°çš„å…³é”®å­—â€é—®é¢˜æ—¶ï¼Œå¹¶ä¸æƒ³è¦æ–°çš„å…³é”®å­—ï¼‰ã€‚

### ä¸ºä»€ä¹ˆä¸æ˜¯å…¶å®ƒä¸å¸¦æ–°å…³é”®å­—çš„ç‰¹æ®Šè¯­æ³•

ä¾‹å¦‚ï¼Œä¸ºä½•ä¸ç”¨ä¸‹é¢ç”¨æ³•è€Œç”¨ yield 3ï¼š

```plain
return 3 and continue
return and continue 3
return generating 3
continue return 3
return >> , 3
from generator return 3
return >> 3
return << 3
>> 3
<< 3
* 3
```

æˆ‘æ²¡æœ‰é”™è¿‡ä¸€ä¸ªâ€œçœ¼è‰²â€å§ï¼Ÿåœ¨æ•°ç™¾æ¡æ¶ˆæ¯ä¸­ï¼Œæˆ‘ç®—äº†æ¯ç§æ›¿ä»£æ–¹æ¡ˆæœ‰ä¸‰æ¡å»ºè®®ï¼Œç„¶åŽæ€»ç»“å‡ºä¸Šé¢è¿™äº›ã€‚ä¸éœ€è¦ç”¨æ–°çš„å…³é”®å­—ä¼šå¾ˆå¥½ï¼Œä½†ä½¿ç”¨ yield ä¼šæ›´å¥½â€”â€”æˆ‘ä¸ªäººè®¤ä¸ºï¼Œåœ¨ä¸€å †æ— æ„ä¹‰çš„å…³é”®å­—æˆ–è¿ç®—ç¬¦åºåˆ—ä¸­ï¼Œyield æ›´å…·è¡¨çŽ°åŠ›ã€‚å°½ç®¡å¦‚æ­¤ï¼Œå¦‚æžœè¿™å¼•èµ·è¶³å¤Ÿçš„å…´è¶£ï¼Œæ”¯æŒè€…åº”è¯¥å‘èµ·ä¸€ä¸ªææ¡ˆï¼Œäº¤ç»™ Guido è£æ–­ã€‚

### ä¸ºä»€ä¹ˆå…è®¸ç”¨ returnï¼Œè€Œä¸å¼ºåˆ¶ç”¨ StopIteration

â€œStopIterationâ€çš„æœºåˆ¶æ˜¯åº•å±‚ç»†èŠ‚ï¼Œå°±åƒ Python 2.1 ä¸­çš„â€œIndexErrorâ€çš„æœºåˆ¶ä¸€æ ·ï¼šå®žçŽ°æ—¶éœ€è¦åšä¸€äº›é¢„å…ˆå®šä¹‰å¥½çš„ä¸œè¥¿ï¼Œè€Œ Python ä¸ºé«˜çº§ç”¨æˆ·å¼€æ”¾äº†è¿™äº›æœºåˆ¶ã€‚å°½ç®¡ä¸å¼ºåˆ¶è¦æ±‚æ¯ä¸ªäººéƒ½åœ¨è¿™ä¸ªå±‚çº§å·¥ä½œã€‚ â€œreturnâ€åœ¨ä»»ä½•ä¸€ç§å‡½æ•°ä¸­éƒ½æ„å‘³ç€â€œæˆ‘å·²ç»å®Œæˆâ€ï¼Œè¿™å¾ˆå®¹æ˜“è§£è¯»å’Œä½¿ç”¨ã€‚æ³¨æ„ï¼Œ`return` å¹¶ä¸æ€»æ˜¯ç­‰åŒäºŽ try-except ç»“æž„ä¸­çš„ `raise StopIteration`ï¼ˆå‚è§â€œè®¾è®¡è§„æ ¼ï¼šReturnâ€éƒ¨åˆ†ï¼‰ã€‚

### é‚£ä¸ºä»€ä¹ˆä¸å…è®¸ return ä¸€ä¸ªè¡¨è¾¾å¼

ä¹Ÿè®¸æœ‰ä¸€å¤©ä¼šå…è®¸ã€‚ åœ¨ Icon ä¸­ï¼Œ`return expr` æ„å‘³ç€â€œæˆ‘å·²ç»å®Œæˆâ€å’Œâ€œä½†æˆ‘è¿˜æœ‰æœ€åŽä¸€ä¸ªæœ‰ç”¨çš„å€¼å¯ä»¥è¿”å›žï¼Œè¿™å°±æ˜¯å®ƒâ€ã€‚ åœ¨åˆå§‹é˜¶æ®µï¼Œä¸å¼ºåˆ¶ä½¿ç”¨`return expr`çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ yield ä»…ä»…ä¼ é€’å€¼ï¼Œè¿™å¾ˆç®€å•æ˜Žäº†ã€‚

## BDFL å£°æ˜Ž

### Issue

å¼•å…¥å¦ä¸€ä¸ªæ–°çš„å…³é”®å­—ï¼ˆæ¯”å¦‚ï¼Œgen æˆ– generator ï¼‰æ¥ä»£æ›¿ def ï¼Œæˆ–ä»¥å…¶å®ƒæ–¹å¼æ”¹å˜è¯­æ³•ï¼Œä»¥åŒºåˆ†ç”Ÿæˆå™¨å‡½æ•°å’Œéžç”Ÿæˆå™¨å‡½æ•°ã€‚

### Con

å®žé™…ä¸Šï¼ˆä½ å¦‚ä½•çœ‹å¾…å®ƒä»¬ï¼‰ï¼Œç”Ÿæˆå™¨*æ˜¯*å‡½æ•°ï¼Œä½†å®ƒä»¬å…·æœ‰å¯æ¢å¤æ€§ã€‚ä½¿å®ƒä»¬å»ºç«‹èµ·æ¥çš„æœºåˆ¶æ˜¯ä¸€ä¸ªç›¸å¯¹è¾ƒå°çš„æŠ€æœ¯é—®é¢˜ï¼Œå¼•å…¥æ–°çš„å…³é”®å­—æ— åŠ©äºŽå¼ºè°ƒç”Ÿæˆå™¨æ˜¯å¦‚ä½•å¯åŠ¨çš„æœºåˆ¶ï¼ˆç”Ÿæˆå™¨ç”Ÿå‘½ä¸­è‡³å…³é‡è¦å´å¾ˆå°çš„éƒ¨åˆ†ï¼‰ã€‚

### Pro

å®žé™…ä¸Šï¼ˆä½ å¦‚ä½•çœ‹å¾…å®ƒä»¬ï¼‰ï¼Œç”Ÿæˆå™¨å‡½æ•°å®žé™…ä¸Šæ˜¯å·¥åŽ‚å‡½æ•°ï¼Œå®ƒä»¬å°±åƒæ–½äº†é­”æ³•ä¸€æ ·åœ°ç”Ÿäº§ç”Ÿæˆå™¨-è¿­ä»£å™¨ã€‚ åœ¨è¿™æ–¹é¢ï¼Œå®ƒä»¬ä¸Žéžç”Ÿæˆå™¨å‡½æ•°å®Œå…¨ä¸åŒï¼Œæ›´åƒæ˜¯æž„é€ å‡½æ•°è€Œä¸æ˜¯å‡½æ•°ï¼Œå› æ­¤é‡ç”¨ def æ— ç–‘æ˜¯ä»¤äººå›°æƒ‘çš„ã€‚è—åœ¨å†…éƒ¨çš„ yield è¯­å¥ä¸è¶³ä»¥è­¦ç¤ºå®ƒä»¬çš„è¯­ä¹‰æ˜¯å¦‚æ­¤ä¸åŒã€‚

### BDFL

def ç•™äº†ä¸‹æ¥ã€‚ä»»ä½•ä¸€æ–¹éƒ½æ²¡æœ‰ä»»ä½•äº‰è®ºæ˜¯å®Œå…¨ä»¤äººä¿¡æœçš„ï¼Œæ‰€ä»¥æˆ‘å’¨è¯¢äº†æˆ‘çš„è¯­è¨€è®¾è®¡å¸ˆçš„ç›´è§‰ã€‚å®ƒå‘Šè¯‰æˆ‘ PEP ä¸­æå‡ºçš„è¯­æ³•æ˜¯å®Œå…¨æ­£ç¡®çš„â€”â€”ä¸æ˜¯å¤ªçƒ­ï¼Œä¹Ÿä¸æ˜¯å¤ªå†·ã€‚ä½†æ˜¯ï¼Œå°±åƒå¸Œè…Šç¥žè¯ä¸­çš„ Delphiï¼ˆè¯‘æ³¨ï¼šç‰¹å°”æ–ï¼Œå¸Œè…Šå¤éƒ½ï¼‰ çš„ç”²éª¨æ–‡ä¸€æ ·ï¼Œå®ƒå¹¶æ²¡æœ‰å‘Šè¯‰æˆ‘åŽŸå› ï¼Œæ‰€ä»¥æˆ‘æ²¡æœ‰å¯¹åå¯¹æ­¤ PEP è¯­æ³•çš„è®ºç‚¹è¿›è¡Œåé©³ã€‚ æˆ‘èƒ½æƒ³å‡ºçš„æœ€å¥½çš„ï¼ˆé™¤äº†å·²ç»åŒæ„åšå‡ºçš„åé©³ï¼‰æ˜¯â€œFUDâ€ï¼ˆè¯‘æ³¨ï¼šç¼©å†™è‡ª fearã€uncertainty å’Œ doubtï¼‰ã€‚ å¦‚æžœè¿™ä»Žç¬¬ä¸€å¤©å¼€å§‹å°±æ˜¯è¯­è¨€çš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘éžå¸¸æ€€ç–‘è¿™æ—©å·²è®©å®‰å¾·é²Â·åº“å¥‡æž—ï¼ˆAndrew Kuchlingï¼‰çš„â€œPython Wartsâ€é¡µé¢æˆä¸ºå¯èƒ½ã€‚ï¼ˆè¯‘æ³¨ï¼šwart æ˜¯ç–£ï¼Œä¸€ç§éš¾çœ‹çš„çš®è‚¤ç—…ã€‚è¿™æ˜¯ä¸€ä¸ª wiki é¡µé¢ï¼Œåˆ—ä¸¾äº†å¯¹ Python å¹æ¯›æ±‚ç–µçš„å»ºè®®ï¼‰ã€‚

## å‚è€ƒå®žçŽ°

å½“å‰çš„å®žçŽ°ï¼ˆè¯‘æ³¨ï¼š2001 å¹´ï¼‰ï¼Œå¤„äºŽåˆæ­¥çŠ¶æ€ï¼ˆæ²¡æœ‰æ–‡æ¡£ï¼Œä½†ç»è¿‡å……åˆ†æµ‹è¯•ï¼Œå¯é ï¼‰ï¼Œæ˜¯ Python çš„ CVS å¼€å‘æ ‘ã€æ³¨é‡Š 9ã€‘çš„ä¸€éƒ¨åˆ†ã€‚ ä½¿ç”¨å®ƒéœ€è¦æ‚¨ä»Žæºä»£ç ä¸­æž„å»º Pythonã€‚

è¿™æ˜¯è¡ç”Ÿè‡ª Neil Schemenauerã€æ³¨é‡Š 7ã€‘çš„æ—©æœŸè¡¥ä¸ã€‚

## è„šæ³¨å’Œå‚è€ƒæ–‡çŒ®

[1] PEP-234, Iterators, Yee, Van Rossum

http://www.python.org/dev/peps/pep-0234/

[2] http://www.stackless.com/

[3] PEP-219, Stackless Python, McMillan

http://www.python.org/dev/peps/pep-0219/

[4] "Iteration Abstraction in Sather" Murer, Omohundro, Stoutamire and Szyperski 

http://www.icsi.berkeley.edu/~sather/Publications/toplas.html

[5] http://www.cs.arizona.edu/icon/

[6] The concept of iterators is described in PEP 234. See [1] above.

[7] http://python.ca/nas/python/generator.diff

[8] PEP 236, Back to the __future__, Peters

http://www.python.org/dev/peps/pep-0236/

[9] To experiment with this implementation, check out Python from CVS according to the instructions at http://sf.net/cvs/?group_id=5470 ï¼ŒNote that the std test Lib/test/test_generators.py contains many examples, including all those in this PEP.

## ç‰ˆæƒä¿¡æ¯

æœ¬æ–‡æ¡£å·²ç»æ”¾ç½®åœ¨å…¬å…±é¢†åŸŸã€‚æºæ–‡æ¡£ï¼š[https://github.com/python/peps/blob/master/pep-0255.txt](https://github.com/python/peps/blob/master/pep-0255.txt)

ï¼ˆè¯‘æ–‡å®Œï¼‰
