---
title: Python å·¥åŒ ï¼šä½¿ç”¨è£…é¥°å™¨çš„æŠ€å·§


tags: 
  - ç¼–ç¨‹
  - Python
  - è£…é¥°å™¨
categories: 
  - ğŸ’» å·¥ä½œ
  - ğŸPython
  - Python å·¥åŒ ç³»åˆ—
date: 2020-08-13 18:28:46
permalink: /pythonista/ee3d01/
---
## å‰è¨€

> è¿™æ˜¯ â€œPython å·¥åŒ â€ç³»åˆ—çš„ç¬¬ 8 ç¯‡æ–‡ç« ã€‚[[æŸ¥çœ‹ç³»åˆ—æ‰€æœ‰æ–‡ç« ]](https://github.com/piglei/one-python-craftsman)

<div style="text-align: center; color: #999; margin: 14px 0 14px;font-size: 12px;">
<img src="https://www.zlovezl.cn/static/uploaded/2019/05/clem-onojeghuo-142120-unsplash_w1280.jpg" width="100%" />
</div>

è£…é¥°å™¨*ï¼ˆDecoratorï¼‰* æ˜¯ Python é‡Œçš„ä¸€ç§ç‰¹æ®Šå·¥å…·ï¼Œå®ƒä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§åœ¨å‡½æ•°å¤–éƒ¨ä¿®æ”¹å‡½æ•°çš„çµæ´»èƒ½åŠ›ã€‚å®ƒæœ‰ç‚¹åƒä¸€é¡¶ç”»ç€ç‹¬ä¸€æ— äºŒ `@` ç¬¦å·çš„ç¥å¥‡å¸½å­ï¼Œåªè¦å°†å®ƒæˆ´åœ¨å‡½æ•°å¤´é¡¶ä¸Šï¼Œå°±èƒ½æ‚„æ— å£°æ¯çš„æ”¹å˜å‡½æ•°æœ¬èº«çš„è¡Œä¸ºã€‚

ä½ å¯èƒ½å·²ç»å’Œè£…é¥°å™¨æ‰“è¿‡ä¸å°‘äº¤é“äº†ã€‚åœ¨åšé¢å‘å¯¹è±¡ç¼–ç¨‹æ—¶ï¼Œæˆ‘ä»¬å°±ç»å¸¸ä¼šç”¨åˆ° `@staticmethod` å’Œ `@classmethod` ä¸¤ä¸ªå†…ç½®è£…é¥°å™¨ã€‚æ­¤å¤–ï¼Œå¦‚æœä½ æ¥è§¦è¿‡ [click](https://click.palletsprojects.com/en/7.x/) æ¨¡å—ï¼Œå°±æ›´ä¸ä¼šå¯¹è£…é¥°å™¨æ„Ÿåˆ°é™Œç”Ÿã€‚click æœ€ä¸ºäººæ‰€ç§°é“çš„å‚æ•°å®šä¹‰æ¥å£ `@click.option(...)` å°±æ˜¯åˆ©ç”¨è£…é¥°å™¨å®ç°çš„ã€‚

é™¤äº†ç”¨è£…é¥°å™¨ï¼Œæˆ‘ä»¬ä¹Ÿç»å¸¸éœ€è¦è‡ªå·±å†™ä¸€äº›è£…é¥°å™¨ã€‚åœ¨è¿™ç¯‡æ–‡ç« é‡Œï¼Œæˆ‘å°†ä» `æœ€ä½³å®è·µ` å’Œ `å¸¸è§é”™è¯¯` ä¸¤ä¸ªæ–¹é¢ï¼Œæ¥ä¸ä½ åˆ†äº«æœ‰å…³è£…é¥°å™¨çš„ä¸€äº›å°çŸ¥è¯†ã€‚

## æœ€ä½³å®è·µ

### 1. å°è¯•ç”¨ç±»æ¥å®ç°è£…é¥°å™¨

ç»å¤§å¤šæ•°è£…é¥°å™¨éƒ½æ˜¯åŸºäºå‡½æ•°å’Œ [é—­åŒ…](https://en.wikipedia.org/wiki/Closure_(computer_programming)) å®ç°çš„ï¼Œä½†è¿™å¹¶éåˆ¶é€ è£…é¥°å™¨çš„å”¯ä¸€æ–¹å¼ã€‚äº‹å®ä¸Šï¼ŒPython å¯¹æŸä¸ªå¯¹è±¡æ˜¯å¦èƒ½é€šè¿‡è£…é¥°å™¨ï¼ˆ`@decorator`ï¼‰å½¢å¼ä½¿ç”¨åªæœ‰ä¸€ä¸ªè¦æ±‚ï¼š**decorator å¿…é¡»æ˜¯ä¸€ä¸ªâ€œå¯è¢«è°ƒç”¨ï¼ˆcallableï¼‰çš„å¯¹è±¡**ã€‚

```python
# ä½¿ç”¨ callable å¯ä»¥æ£€æµ‹æŸä¸ªå¯¹è±¡æ˜¯å¦â€œå¯è¢«è°ƒç”¨â€
>>> def foo(): pass
...
>>> type(foo)
<class 'function'>
>>> callable(foo)
True
```

å‡½æ•°è‡ªç„¶æ˜¯â€œå¯è¢«è°ƒç”¨â€çš„å¯¹è±¡ã€‚ä½†é™¤äº†å‡½æ•°å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è®©ä»»ä½•ä¸€ä¸ªç±»ï¼ˆclassï¼‰å˜å¾—â€œå¯è¢«è°ƒç”¨â€ï¼ˆcallableï¼‰ã€‚åŠæ³•å¾ˆç®€å•ï¼Œåªè¦è‡ªå®šä¹‰ç±»çš„ `__call__` é­”æ³•æ–¹æ³•å³å¯ã€‚

```plain
class Foo:
    def __call__(self):
        print("Hello, __call___")

foo = Foo()

# OUTPUT: True
print(callable(foo))
# è°ƒç”¨ foo å®ä¾‹
# OUTPUT: Hello, __call__
foo()
```

åŸºäºè¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„ä½¿ç”¨ç±»æ¥å®ç°è£…é¥°å™¨ã€‚

ä¸‹é¢è¿™æ®µä»£ç ï¼Œä¼šå®šä¹‰ä¸€ä¸ªåä¸º `@delay(duration)` çš„è£…é¥°å™¨ï¼Œä½¿ç”¨å®ƒè£…é¥°è¿‡çš„å‡½æ•°åœ¨æ¯æ¬¡æ‰§è¡Œå‰ï¼Œéƒ½ä¼šç­‰å¾…é¢å¤–çš„ `duration` ç§’ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬ä¹Ÿå¸Œæœ›ä¸ºç”¨æˆ·æä¾›æ— éœ€ç­‰å¾…é©¬ä¸Šæ‰§è¡Œçš„ `eager_call` æ¥å£ã€‚

```python
import time
import functools


class DelayFunc:
    def __init__(self,  duration, func):
        self.duration = duration
        self.func = func

    def __call__(self, *args, **kwargs):
        print(f'Wait for {self.duration} seconds...')
        time.sleep(self.duration)
        return self.func(*args, **kwargs)

    def eager_call(self, *args, **kwargs):
        print('Call without delay')
        return self.func(*args, **kwargs)


def delay(duration):
    """è£…é¥°å™¨ï¼šæ¨è¿ŸæŸä¸ªå‡½æ•°çš„æ‰§è¡Œã€‚åŒæ—¶æä¾› .eager_call æ–¹æ³•ç«‹å³æ‰§è¡Œ
    """
    # æ­¤å¤„ä¸ºäº†é¿å…å®šä¹‰é¢å¤–å‡½æ•°ï¼Œç›´æ¥ä½¿ç”¨ functools.partial å¸®åŠ©æ„é€ 
    # DelayFunc å®ä¾‹
    return functools.partial(DelayFunc, duration)
```

å¦‚ä½•ä½¿ç”¨è£…é¥°å™¨çš„æ ·ä¾‹ä»£ç ï¼š

```plain
@delay(duration=2)
def add(a, b):
    return a + b


# è¿™æ¬¡è°ƒç”¨å°†ä¼šå»¶è¿Ÿ 2 ç§’
add(1, 2)
# è¿™æ¬¡è°ƒç”¨å°†ä¼šç«‹å³æ‰§è¡Œ
add.eager_call(1, 2)
```

`@delay(duration)` å°±æ˜¯ä¸€ä¸ªåŸºäºç±»æ¥å®ç°çš„è£…é¥°å™¨ã€‚å½“ç„¶ï¼Œå¦‚æœä½ éå¸¸ç†Ÿæ‚‰ Python é‡Œçš„å‡½æ•°å’Œé—­åŒ…ï¼Œä¸Šé¢çš„ `delay` è£…é¥°å™¨å…¶å®ä¹Ÿå®Œå…¨å¯ä»¥åªç”¨å‡½æ•°æ¥å®ç°ã€‚æ‰€ä»¥ï¼Œä¸ºä»€ä¹ˆæˆ‘ä»¬è¦ç”¨ç±»æ¥åšè¿™ä»¶äº‹å‘¢ï¼Ÿ

ä¸çº¯å‡½æ•°ç›¸æ¯”ï¼Œæˆ‘è§‰å¾—ä½¿ç”¨ç±»å®ç°çš„è£…é¥°å™¨åœ¨**ç‰¹å®šåœºæ™¯**ä¸‹æœ‰å‡ ä¸ªä¼˜åŠ¿ï¼š

- å®ç°æœ‰çŠ¶æ€çš„è£…é¥°å™¨æ—¶ï¼Œæ“ä½œç±»å±æ€§æ¯”æ“ä½œé—­åŒ…å†…å˜é‡æ›´ç¬¦åˆç›´è§‰ã€ä¸æ˜“å‡ºé”™
- å®ç°ä¸ºå‡½æ•°æ‰©å……æ¥å£çš„è£…é¥°å™¨æ—¶ï¼Œä½¿ç”¨ç±»åŒ…è£…å‡½æ•°ï¼Œæ¯”ç›´æ¥ä¸ºå‡½æ•°å¯¹è±¡è¿½åŠ å±æ€§æ›´æ˜“äºç»´æŠ¤
- æ›´å®¹æ˜“å®ç°ä¸€ä¸ªåŒæ—¶å…¼å®¹è£…é¥°å™¨ä¸ä¸Šä¸‹æ–‡ç®¡ç†å™¨åè®®çš„å¯¹è±¡ï¼ˆå‚è€ƒ [unitest.mock.patch](https://docs.python.org/3/library/unittest.mock.html#unittest.mock.patch)ï¼‰

### 2. ä½¿ç”¨ wrapt æ¨¡å—ç¼–å†™æ›´æ‰å¹³çš„è£…é¥°å™¨

åœ¨å†™è£…é¥°å™¨çš„è¿‡ç¨‹ä¸­ï¼Œä½ æœ‰æ²¡æœ‰ç¢°åˆ°è¿‡ä»€ä¹ˆä¸çˆ½çš„äº‹æƒ…ï¼Ÿä¸ç®¡ä½ æœ‰æ²¡æœ‰ï¼Œåæ­£æˆ‘æœ‰ã€‚æˆ‘ç»å¸¸åœ¨å†™ä»£ç çš„æ—¶å€™ï¼Œè¢«ä¸‹é¢ä¸¤ä»¶äº‹æƒ…æå¾—ç‰¹åˆ«éš¾å—ï¼š

1. å®ç°å¸¦å‚æ•°çš„è£…é¥°å™¨æ—¶ï¼Œå±‚å±‚åµŒå¥—çš„å‡½æ•°ä»£ç ç‰¹åˆ«éš¾å†™ã€éš¾è¯»
2. å› ä¸ºå‡½æ•°å’Œç±»æ–¹æ³•çš„ä¸åŒï¼Œä¸ºå‰è€…å†™çš„è£…é¥°å™¨ç»å¸¸æ²¡æ³•ç›´æ¥å¥—ç”¨åœ¨åè€…ä¸Š

æ¯”å¦‚ï¼Œåœ¨ä¸‹é¢çš„ä¾‹å­é‡Œï¼Œæˆ‘å®ç°äº†ä¸€ä¸ªç”Ÿæˆéšæœºæ•°å¹¶æ³¨å…¥ä¸ºå‡½æ•°å‚æ•°çš„è£…é¥°å™¨ã€‚

```python
import random


def provide_number(min_num, max_num):
    """è£…é¥°å™¨ï¼šéšæœºç”Ÿæˆä¸€ä¸ªåœ¨ [min_num, max_num] èŒƒå›´çš„æ•´æ•°ï¼Œè¿½åŠ ä¸ºå‡½æ•°çš„ç¬¬ä¸€ä¸ªä½ç½®å‚æ•°
    """
    def wrapper(func):
        def decorated(*args, **kwargs):
            num = random.randint(min_num, max_num)
            # å°† num ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°è¿½åŠ åè°ƒç”¨å‡½æ•°
            return func(num, *args, **kwargs)
        return decorated
    return wrapper
    


@provide_number(1, 100)
def print_random_number(num):
    print(num)

# è¾“å‡º 1-100 çš„éšæœºæ•´æ•°
# OUTPUT: 72
print_random_number()
```

`@provide_number` è£…é¥°å™¨åŠŸèƒ½çœ‹ä¸Šå»å¾ˆä¸é”™ï¼Œä½†å®ƒæœ‰ç€æˆ‘åœ¨å‰é¢æåˆ°çš„ä¸¤ä¸ªé—®é¢˜ï¼š**åµŒå¥—å±‚çº§æ·±ã€æ— æ³•åœ¨ç±»æ–¹æ³•ä¸Šä½¿ç”¨ã€‚**å¦‚æœç›´æ¥ç”¨å®ƒå»è£…é¥°ç±»æ–¹æ³•ï¼Œä¼šå‡ºç°ä¸‹é¢çš„æƒ…å†µï¼š

```plain
class Foo:
    @provide_number(1, 100)
    def print_random_number(self, num):
        print(num)

# OUTPUT: <__main__.Foo object at 0x104047278>
Foo().print_random_number()
```

`Foo` ç±»å®ä¾‹ä¸­çš„ `print_random_number` æ–¹æ³•å°†ä¼šè¾“å‡ºç±»å®ä¾‹ `self` ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„éšæœºæ•° `num`ã€‚

ä¹‹æ‰€ä»¥ä¼šå‡ºç°è¿™ä¸ªç»“æœï¼Œæ˜¯å› ä¸ºç±»æ–¹æ³•*ï¼ˆmethodï¼‰*å’Œå‡½æ•°*ï¼ˆfunctionï¼‰*äºŒè€…åœ¨å·¥ä½œæœºåˆ¶ä¸Šæœ‰ç€ç»†å¾®ä¸åŒã€‚å¦‚æœè¦ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œ`provider_number` è£…é¥°å™¨åœ¨ä¿®æ”¹ç±»æ–¹æ³•çš„ä½ç½®å‚æ•°æ—¶ï¼Œå¿…é¡»èªæ˜çš„è·³è¿‡è—åœ¨ `*args` é‡Œé¢çš„ç±»å®ä¾‹ `self` å˜é‡ï¼Œæ‰èƒ½æ­£ç¡®çš„å°† `num` ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°æ³¨å…¥ã€‚

è¿™æ—¶ï¼Œå°±åº”è¯¥æ˜¯ [wrapt](https://pypi.org/project/wrapt/) æ¨¡å—é—ªäº®ç™»åœºçš„æ—¶å€™äº†ã€‚`wrapt` æ¨¡å—æ˜¯ä¸€ä¸ªä¸“é—¨å¸®åŠ©ä½ ç¼–å†™è£…é¥°å™¨çš„å·¥å…·åº“ã€‚åˆ©ç”¨å®ƒï¼Œæˆ‘ä»¬å¯ä»¥éå¸¸æ–¹ä¾¿çš„æ”¹é€  `provide_number` è£…é¥°å™¨ï¼Œå®Œç¾è§£å†³*â€œåµŒå¥—å±‚çº§æ·±â€*å’Œ*â€œæ— æ³•é€šç”¨â€*ä¸¤ä¸ªé—®é¢˜ï¼Œ

```python
import wrapt

def provide_number(min_num, max_num):
    @wrapt.decorator
    def wrapper(wrapped, instance, args, kwargs):
        # å‚æ•°å«ä¹‰ï¼š
        #
        # - wrappedï¼šè¢«è£…é¥°çš„å‡½æ•°æˆ–ç±»æ–¹æ³•
        # - instanceï¼š
        #   - å¦‚æœè¢«è£…é¥°è€…ä¸ºæ™®é€šç±»æ–¹æ³•ï¼Œè¯¥å€¼ä¸ºç±»å®ä¾‹
        #   - å¦‚æœè¢«è£…é¥°è€…ä¸º classmethod ç±»æ–¹æ³•ï¼Œè¯¥å€¼ä¸ºç±»
        #   - å¦‚æœè¢«è£…é¥°è€…ä¸ºç±»/å‡½æ•°/é™æ€æ–¹æ³•ï¼Œè¯¥å€¼ä¸º None
        #
        # - argsï¼šè°ƒç”¨æ—¶çš„ä½ç½®å‚æ•°ï¼ˆæ³¨æ„æ²¡æœ‰ * ç¬¦å·ï¼‰
        # - kwargsï¼šè°ƒç”¨æ—¶çš„å…³é”®å­—å‚æ•°ï¼ˆæ³¨æ„æ²¡æœ‰ ** ç¬¦å·ï¼‰
        #
        num = random.randint(min_num, max_num)
        # æ— éœ€å…³æ³¨ wrapped æ˜¯ç±»æ–¹æ³•æˆ–æ™®é€šå‡½æ•°ï¼Œç›´æ¥åœ¨å¤´éƒ¨è¿½åŠ å‚æ•°
        args = (num,) + args
        return wrapped(*args, **kwargs)
    return wrapper
    
<... åº”ç”¨è£…é¥°å™¨éƒ¨åˆ†ä»£ç çœç•¥ ...>
    
# OUTPUT: 48
Foo().print_random_number()
```

ä½¿ç”¨ `wrapt` æ¨¡å—ç¼–å†™çš„è£…é¥°å™¨ï¼Œç›¸æ¯”åŸæ¥æ‹¥æœ‰ä¸‹é¢è¿™äº›ä¼˜åŠ¿ï¼š

- åµŒå¥—å±‚çº§å°‘ï¼šä½¿ç”¨ `@wrapt.decorator` å¯ä»¥å°†ä¸¤å±‚åµŒå¥—å‡å°‘ä¸ºä¸€å±‚
- æ›´ç®€å•ï¼šå¤„ç†ä½ç½®ä¸å…³é”®å­—å‚æ•°æ—¶ï¼Œå¯ä»¥å¿½ç•¥ç±»å®ä¾‹ç­‰ç‰¹æ®Šæƒ…å†µ
- æ›´çµæ´»ï¼šé’ˆå¯¹ `instance` å€¼è¿›è¡Œæ¡ä»¶åˆ¤æ–­åï¼Œæ›´å®¹æ˜“è®©è£…é¥°å™¨å˜å¾—é€šç”¨

## å¸¸è§é”™è¯¯

### 1. â€œè£…é¥°å™¨â€å¹¶ä¸æ˜¯â€œè£…é¥°å™¨æ¨¡å¼â€

[â€œè®¾è®¡æ¨¡å¼â€](https://en.wikipedia.org/wiki/Software_design_pattern)æ˜¯ä¸€ä¸ªåœ¨è®¡ç®—æœºä¸–ç•Œé‡Œé¼é¼å¤§åçš„è¯ã€‚å‡å¦‚ä½ æ˜¯ä¸€å Java ç¨‹åºå‘˜ï¼Œè€Œä½ ä¸€ç‚¹è®¾è®¡æ¨¡å¼éƒ½ä¸æ‡‚ï¼Œé‚£ä¹ˆæˆ‘æ‰“èµŒä½ æ‰¾å·¥ä½œçš„é¢è¯•è¿‡ç¨‹ä¸€å®šä¼šåº¦è¿‡çš„ç›¸å½“è‰°éš¾ã€‚

ä½†å†™ Python æ—¶ï¼Œæˆ‘ä»¬æå°‘è°ˆèµ·â€œè®¾è®¡æ¨¡å¼â€ã€‚è™½ç„¶ Python ä¹Ÿæ˜¯ä¸€é—¨æ”¯æŒé¢å‘å¯¹è±¡çš„ç¼–ç¨‹è¯­è¨€ï¼Œä½†å®ƒçš„ [é¸­å­ç±»å‹](https://en.wikipedia.org/wiki/Duck_typing) è®¾è®¡ä»¥åŠå‡ºè‰²çš„åŠ¨æ€ç‰¹æ€§å†³å®šäº†ï¼Œå¤§éƒ¨åˆ†è®¾è®¡æ¨¡å¼å¯¹æˆ‘ä»¬æ¥è¯´å¹¶ä¸æ˜¯å¿…éœ€å“ã€‚æ‰€ä»¥ï¼Œå¾ˆå¤š Python ç¨‹åºå‘˜åœ¨å·¥ä½œå¾ˆé•¿ä¸€æ®µæ—¶é—´åï¼Œå¯èƒ½å¹¶æ²¡æœ‰çœŸæ­£åº”ç”¨è¿‡å‡ ç§è®¾è®¡æ¨¡å¼ã€‚

ä¸è¿‡ [*â€œè£…é¥°å™¨æ¨¡å¼ï¼ˆDecorator Patternï¼‰â€*](https://en.wikipedia.org/wiki/Decorator_pattern) æ˜¯ä¸ªä¾‹å¤–ã€‚å› ä¸º Python çš„â€œè£…é¥°å™¨â€å’Œâ€œè£…é¥°å™¨æ¨¡å¼â€æœ‰ç€ä¸€æ¨¡ä¸€æ ·çš„åå­—ï¼Œæˆ‘ä¸æ­¢ä¸€æ¬¡å¬åˆ°æœ‰äººæŠŠå®ƒä»¬ä¿©å½“æˆä¸€å›äº‹ï¼Œè®¤ä¸ºä½¿ç”¨â€œè£…é¥°å™¨â€å°±æ˜¯åœ¨å®è·µâ€œè£…é¥°å™¨æ¨¡å¼â€ã€‚ä½†äº‹å®ä¸Šï¼Œ**å®ƒä»¬æ˜¯ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„ä¸œè¥¿ã€‚**

â€œè£…é¥°å™¨æ¨¡å¼â€æ˜¯ä¸€ä¸ªå®Œå…¨åŸºäºâ€œé¢å‘å¯¹è±¡â€è¡ç”Ÿå‡ºçš„ç¼–ç¨‹æ‰‹æ³•ã€‚å®ƒæ‹¥æœ‰å‡ ä¸ªå…³é”®ç»„æˆï¼š**ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£å®šä¹‰**ã€**è‹¥å¹²ä¸ªéµå¾ªè¯¥æ¥å£çš„ç±»**ã€**ç±»ä¸ç±»ä¹‹é—´ä¸€å±‚ä¸€å±‚çš„åŒ…è£…**ã€‚æœ€ç»ˆç”±å®ƒä»¬å…±åŒå½¢æˆä¸€ç§*â€œè£…é¥°â€*çš„æ•ˆæœã€‚

è€Œ Python é‡Œçš„â€œè£…é¥°å™¨â€å’Œâ€œé¢å‘å¯¹è±¡â€æ²¡æœ‰ä»»ä½•ç›´æ¥è”ç³»ï¼Œ**å®ƒå®Œå…¨å¯ä»¥åªæ˜¯å‘ç”Ÿåœ¨å‡½æ•°å’Œå‡½æ•°é—´çš„æŠŠæˆã€‚**äº‹å®ä¸Šï¼Œâ€œè£…é¥°å™¨â€å¹¶æ²¡æœ‰æä¾›æŸç§æ— æ³•æ›¿ä»£çš„åŠŸèƒ½ï¼Œå®ƒä»…ä»…å°±æ˜¯ä¸€é¢—[â€œè¯­æ³•ç³–â€](https://en.wikipedia.org/wiki/Syntactic_sugar)è€Œå·²ã€‚ä¸‹é¢è¿™æ®µä½¿ç”¨äº†è£…é¥°å™¨çš„ä»£ç ï¼š

```python
@log_time
@cache_result
def foo(): pass
```

åŸºæœ¬å®Œå…¨ç­‰åŒäºä¸‹é¢è¿™æ ·ï¼š

```plain
def foo(): pass

foo = log_time(cache_result(foo))
```

**è£…é¥°å™¨æœ€å¤§çš„åŠŸåŠ³ï¼Œåœ¨äºè®©æˆ‘ä»¬åœ¨æŸäº›ç‰¹å®šåœºæ™¯æ—¶ï¼Œå¯ä»¥å†™å‡ºæ›´ç¬¦åˆç›´è§‰ã€æ˜“äºé˜…è¯»çš„ä»£ç **ã€‚å®ƒåªæ˜¯ä¸€é¢—â€œç³–â€ï¼Œå¹¶ä¸æ˜¯æŸä¸ªé¢å‘å¯¹è±¡é¢†åŸŸçš„å¤æ‚ç¼–ç¨‹æ¨¡å¼ã€‚

> Hint: åœ¨ Python å®˜ç½‘ä¸Šæœ‰ä¸€ä¸ª [å®ç°äº†è£…é¥°å™¨æ¨¡å¼çš„ä¾‹å­](https://wiki.python.org/moin/DecoratorPattern)ï¼Œä½ å¯ä»¥è¯»è¯»è¿™ä¸ªä¾‹å­æ¥æ›´å¥½çš„äº†è§£å®ƒã€‚

### 2. è®°å¾—ç”¨ functools.wraps() è£…é¥°å†…å±‚å‡½æ•°

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„è£…é¥°å™¨ï¼Œä¸“é—¨ç”¨æ¥æ‰“å°å‡½æ•°è°ƒç”¨è€—æ—¶ï¼š

```python
import time


def timer(wrapped):
    """è£…é¥°å™¨ï¼šè®°å½•å¹¶æ‰“å°å‡½æ•°è€—æ—¶"""
    def decorated(*args, **kwargs):
        st = time.time()
        ret = wrapped(*args, **kwargs)
        print('execution take: {} seconds'.format(time.time() - st))
        return ret
    return decorated


@timer
def random_sleep():
    """éšæœºç¡çœ ä¸€å°ä¼š"""
    time.sleep(random.random())
```

`timer` è£…é¥°å™¨è™½ç„¶æ²¡æœ‰é”™è¯¯ï¼Œä½†æ˜¯ä½¿ç”¨å®ƒè£…é¥°å‡½æ•°åï¼Œå‡½æ•°çš„åŸå§‹ç­¾åå°±ä¼šè¢«ç ´åã€‚ä¹Ÿå°±æ˜¯è¯´ä½ å†ä¹Ÿæ²¡åŠæ³•æ­£ç¡®æ‹¿åˆ° `random_sleep` å‡½æ•°çš„åç§°ã€æ–‡æ¡£å†…å®¹äº†ï¼Œæ‰€æœ‰ç­¾åéƒ½ä¼šå˜æˆå†…å±‚å‡½æ•° `decorated` çš„å€¼ï¼š

```python
print(random_sleep.__name__)
# è¾“å‡º 'decorated'
print(random_sleep.__doc__)
# è¾“å‡º None
```

è¿™è™½ç„¶åªæ˜¯ä¸ªå°é—®é¢˜ï¼Œä½†åœ¨æŸäº›æ—¶å€™ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´éš¾ä»¥å¯Ÿè§‰çš„ bugã€‚å¹¸è¿çš„æ˜¯ï¼Œæ ‡å‡†åº“ `functools` ä¸ºå®ƒæä¾›äº†è§£å†³æ–¹æ¡ˆï¼Œä½ åªéœ€è¦åœ¨å®šä¹‰è£…é¥°å™¨æ—¶ï¼Œç”¨å¦å¤–ä¸€ä¸ªè£…é¥°å™¨å†è£…é¥°ä¸€ä¸‹å†…å±‚ `decorated` å‡½æ•°å°±è¡Œã€‚

å¬ä¸Šå»æœ‰ç‚¹ç»•ï¼Œä½†å…¶å®å°±æ˜¯æ–°å¢ä¸€è¡Œä»£ç è€Œå·²ï¼š

```python
def timer(wrapped):
    # å°† wrapper å‡½æ•°çš„çœŸå®ç­¾åèµ‹å€¼åˆ° decorated ä¸Š
    @functools.wraps(wrapped)
    def decorated(*args, **kwargs):
        # <...> å·²çœç•¥
    return decorated
```

è¿™æ ·å¤„ç†åï¼Œ`timer` è£…é¥°å™¨å°±ä¸ä¼šå½±å“å®ƒæ‰€è£…é¥°çš„å‡½æ•°äº†ã€‚

```python
print(random_sleep.__name__)
# è¾“å‡º 'random_sleep'
print(random_sleep.__doc__)
# è¾“å‡º 'éšæœºç¡çœ ä¸€å°ä¼š'
```

### 3. ä¿®æ”¹å¤–å±‚å˜é‡æ—¶è®°å¾—ä½¿ç”¨ nonlocal

è£…é¥°å™¨æ˜¯å¯¹å‡½æ•°å¯¹è±¡çš„ä¸€ä¸ªé«˜çº§åº”ç”¨ã€‚åœ¨ç¼–å†™è£…é¥°å™¨çš„è¿‡ç¨‹ä¸­ï¼Œä½ ä¼šç»å¸¸ç¢°åˆ°å†…å±‚å‡½æ•°éœ€è¦ä¿®æ”¹å¤–å±‚å‡½æ•°å˜é‡çš„æƒ…å†µã€‚å°±åƒä¸‹é¢è¿™ä¸ªè£…é¥°å™¨ä¸€æ ·ï¼š

```python
import functools

def counter(func):
    """è£…é¥°å™¨ï¼šè®°å½•å¹¶æ‰“å°è°ƒç”¨æ¬¡æ•°"""
    count = 0
    @functools.wraps(func)
    def decorated(*args, **kwargs):
        # æ¬¡æ•°ç´¯åŠ 
        count += 1
        print(f"Count: {count}")
        return func(*args, **kwargs)
    return decorated

@counter
def foo():
    pass

foo()
```

ä¸ºäº†ç»Ÿè®¡å‡½æ•°è°ƒç”¨æ¬¡æ•°ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ `decorated` å‡½æ•°å†…éƒ¨ä¿®æ”¹å¤–å±‚å‡½æ•°å®šä¹‰çš„ `count` å˜é‡çš„å€¼ã€‚ä½†æ˜¯ï¼Œä¸Šé¢è¿™æ®µä»£ç æ˜¯æœ‰é—®é¢˜çš„ï¼Œåœ¨æ‰§è¡Œå®ƒæ—¶è§£é‡Šå™¨ä¼šæŠ¥é”™:

```bash
Traceback (most recent call last):
  File "counter.py", line 22, in <module>
    foo()
  File "counter.py", line 11, in decorated
    count += 1
UnboundLocalError: local variable 'count' referenced before assignment
```

è¿™ä¸ªé”™è¯¯æ˜¯ç”± `counter` ä¸ `decorated` å‡½æ•°äº’ç›¸åµŒå¥—çš„ä½œç”¨åŸŸå¼•èµ·çš„ã€‚

å½“è§£é‡Šå™¨æ‰§è¡Œåˆ° `count += 1` æ—¶ï¼Œå¹¶ä¸çŸ¥é“ `count` æ˜¯ä¸€ä¸ªåœ¨å¤–å±‚ä½œç”¨åŸŸå®šä¹‰çš„å˜é‡ï¼Œå®ƒæŠŠ `count` å½“åšä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œå¹¶åœ¨å½“å‰ä½œç”¨åŸŸå†…æŸ¥æ‰¾ã€‚æœ€ç»ˆå´æ²¡æœ‰æ‰¾åˆ°æœ‰å…³ `count` å˜é‡çš„ä»»ä½•å®šä¹‰ï¼Œç„¶åæŠ›å‡ºé”™è¯¯ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡ `nonlocal` å…³é”®å­—å‘Šè¯‰è§£é‡Šå™¨ï¼š**â€œcount å˜é‡å¹¶ä¸å±äºå½“å‰çš„ local ä½œç”¨åŸŸï¼Œå»å¤–é¢æ‰¾æ‰¾å§â€**ï¼Œä¹‹å‰çš„é”™è¯¯å°±å¯ä»¥å¾—åˆ°è§£å†³ã€‚

```python
def decorated(*args, **kwargs):
    nonlocal count
    count += 1
    # <... å·²çœç•¥ ...>
```

> Hintï¼šå¦‚æœè¦äº†è§£æ›´å¤šæœ‰å…³ nonlocal å…³é”®å­—çš„å†å²ï¼Œå¯ä»¥æŸ¥é˜… [PEP-3104](https://www.python.org/dev/peps/pep-3104/)

## æ€»ç»“

åœ¨è¿™ç¯‡æ–‡ç« é‡Œï¼Œæˆ‘ä¸ä½ åˆ†äº«äº†æœ‰å…³è£…é¥°å™¨çš„ä¸€äº›æŠ€å·§ä¸å°çŸ¥è¯†ã€‚

ä¸€äº›è¦ç‚¹æ€»ç»“ï¼š

- ä¸€åˆ‡ callable çš„å¯¹è±¡éƒ½å¯ä»¥è¢«ç”¨æ¥å®ç°è£…é¥°å™¨
- æ··åˆä½¿ç”¨å‡½æ•°ä¸ç±»ï¼Œå¯ä»¥æ›´å¥½çš„å®ç°è£…é¥°å™¨
- wrapt æ¨¡å—å¾ˆæœ‰ç”¨ï¼Œç”¨å®ƒå¯ä»¥å¸®åŠ©æˆ‘ä»¬ç”¨æ›´ç®€å•çš„ä»£ç å†™å‡ºå¤æ‚è£…é¥°å™¨
- â€œè£…é¥°å™¨â€åªæ˜¯è¯­æ³•ç³–ï¼Œå®ƒä¸æ˜¯â€œè£…é¥°å™¨æ¨¡å¼â€
- è£…é¥°å™¨ä¼šæ”¹å˜å‡½æ•°çš„åŸå§‹ç­¾åï¼Œä½ éœ€è¦ `functools.wraps`
- åœ¨å†…å±‚å‡½æ•°ä¿®æ”¹å¤–å±‚å‡½æ•°çš„å˜é‡æ—¶ï¼Œéœ€è¦ä½¿ç”¨ `nonlocal` å…³é”®å­—

çœ‹å®Œæ–‡ç« çš„ä½ ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆæƒ³åæ§½çš„ï¼Ÿè¯·ç•™è¨€æˆ–è€…åœ¨ [é¡¹ç›® Github Issues](https://github.com/piglei/one-python-craftsman) å‘Šè¯‰æˆ‘å§ã€‚

[>>>ä¸‹ä¸€ç¯‡ã€9.ä¸€ä¸ªå…³äºæ¨¡å—çš„å°æ•…äº‹ã€‘](./9-a-story-on-cyclic-imports)

[<<<ä¸Šä¸€ç¯‡ã€7.ç¼–å†™åœ°é“å¾ªç¯çš„ä¸¤ä¸ªå»ºè®®ã€‘](./7-two-tips-on-loop-writing)


## é™„å½•

- é¢˜å›¾æ¥æº: Photo by Clem Onojeghuo on Unsplash
- æ›´å¤šç³»åˆ—æ–‡ç« åœ°å€ï¼šhttps://github.com/piglei/one-python-craftsman

ç³»åˆ—å…¶ä»–æ–‡ç« ï¼š

- [æ‰€æœ‰æ–‡ç« ç´¢å¼• [Github]](https://github.com/piglei/one-python-craftsman)
- [Python å·¥åŒ ï¼šç¼–å†™æ¡ä»¶åˆ†æ”¯ä»£ç çš„æŠ€å·§](https://www.zlovezl.cn/articles/python-else-block-secrets/)
- [Python å·¥åŒ ï¼šå¼‚å¸¸å¤„ç†çš„ä¸‰ä¸ªå¥½ä¹ æƒ¯](https://www.zlovezl.cn/articles/three-rituals-of-exceptions-handling/)
- [Python å·¥åŒ ï¼šç¼–å†™åœ°é“å¾ªç¯çš„ä¸¤ä¸ªå»ºè®®](https://www.zlovezl.cn/articles/two-tips-on-loop-writing/)


