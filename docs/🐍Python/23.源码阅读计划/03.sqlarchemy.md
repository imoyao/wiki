---
title: requests æºç é˜…è¯»
tags: 
  - requests
  - æºç é˜…è¯»
categories: 
  - ğŸ’» å·¥ä½œ
  - ğŸPython
  - å…¨æ ˆä¹‹è·¯
  - è®¾è®¡æ¨¡å¼
date: 2021-06-08 21:41:49
permalink: /rs/sqlarlchemy/
---

SQLAlchemy æ˜¯ Python SQL å·¥å…·ç®±å’Œ ORM æ¡†æ¶ï¼Œå®ƒä¸ºåº”ç”¨ç¨‹åºå¼€å‘äººå‘˜æä¾›äº†å…¨é¢è€Œçµæ´»çš„ SQL åŠŸèƒ½ã€‚å®ƒæä¾›äº†ä¸€æ•´å¥—ä¼ä¸šçº§æŒä¹…åŒ–æ–¹æ¡ˆï¼Œæ—¨åœ¨é«˜æ•ˆï¼Œé«˜æ€§èƒ½åœ°è®¿é—®æ•°æ®åº“ï¼Œå¹¶ç¬¦åˆç®€å•çš„ Pythonic å“²å­¦ã€‚é¡¹ç›®ä»£ç é‡æ¯”è¾ƒå¤§ï¼Œæ¥è¿‘ 200 ä¸ªæ–‡ä»¶ï¼Œ7 ä¸‡è¡Œä»£ç ï¼Œ æˆ‘ä»¬ä¸€èµ·æ¥æŒ‘æˆ˜ä¸€ä¸‹ã€‚ç”±äºç¯‡å¹…åŸå› ï¼Œåˆ†æˆä¸Šä¸‹ä¸¤ç¯‡ï¼Œä¸Šç¯‡åŒ…æ‹¬å¦‚ä¸‹å†…å®¹:



SQLAlchemy é¡¹ç›®ç»“æ„
--------------

æºç ä½¿ç”¨çš„ç‰ˆæœ¬æ˜¯ `1.3.0`, å¯¹åº”çš„ commitID æ˜¯ `740bb50c2`ï¼Œå’Œå‚è€ƒé“¾æ¥ä¸­å®˜æ–¹æ–‡æ¡£ 1.3 ç‰ˆæœ¬ä¸€è‡´ã€‚é¡¹ç›®ç›®å½•å¤§æ¦‚åŒ…æ‹¬:

| ç›®å½•         | æè¿°    |
|------------|-------|
| connectors | è¿æ¥    |
| dialects   | æ–¹è¨€    |
| engine     | å¼•æ“    |
| event      | äº‹ä»¶    |
| ext        | æ‰©å±•åŠŸèƒ½  |
| orm        | orm   |
| pool       | è¿æ¥æ±    |
| sql        | sql å¤„ç† |
| util       | å·¥å…·ç±»   |


SQLAlchemy çš„æ¶æ„å›¾å¦‚ä¸‹:

![](http://aosabook.org/images/sqlalchemy/layers.png)

æ•´ä½“åˆ†æˆ 3 å±‚ï¼Œä»ä¸Šåˆ°ä¸‹åˆ†åˆ«æ˜¯ ORMï¼Œcore å’Œ DBAPIï¼Œå…¶ä¸­ coreï¼Œåˆåˆ†æˆå·¦å³ä¸¤ä¸ªåŒºåŸŸã€‚æˆ‘ä»¬å…ˆå­¦ä¹ å…¶ä¸­çš„å¼•æ“ï¼Œè¿æ¥æ± ï¼Œdialects(ä»… sqlite)å’Œ DBAPI éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯æ¶æ„å›¾çš„å³åŠä¾§ã€‚å…¶ä¸­ DBAPI(sqlite ç›¸å…³)æ˜¯åœ¨ python-core-library ä¸­æä¾›ã€‚

ç”¨ SQLAlchemy æ“ä½œ sqlite æ•°æ®åº“
----------------------

å…ˆä»ä½¿ç”¨ DBAPI æ“ä½œ sqlite çš„ API å¼€å§‹:

```python
import sqlite3
con = sqlite3.connect('example.db')
cur = con.cursor()

# Create table
cur.execute('''CREATE TABLE stocks
               (date text, trans text, symbol text, qty real, price real)''')

# Insert a row of data
cur.execute("INSERT INTO stocks VALUES ('2006-01-05','BUY','RHAT',100,35.14)")

# Save (commit) the changes
con.commit()

# Do this instead
t = ('RHAT',)
cur.execute('SELECT * FROM stocks WHERE symbol=?', t)
print(cur.fetchone())


# We can also close the connection if we are done with it.
# Just be sure any chang
con.close()
```

æ“ä½œ sqlite æ•°æ®åº“ä¸»è¦åŒ…æ‹¬äº†ä¸‹é¢å‡ ä¸ªæ­¥éª¤:

*   connect æ•°æ®åº“è·å¾—è¿æ¥ con
    
*   ä»è¿æ¥ä¸­è·å–æ“ä½œæ¸¸æ ‡ cur
    
*   ä½¿ç”¨ cur æ‰§è¡Œ sql è¯­å¥(statement)
    
*   å‘è¿æ¥ con æäº¤ commit äº‹åŠ¡
    
*   ä½¿ç”¨ cur çš„ fetchone/fecthmany/fetchall æ–¹æ³•è·å–æ•°æ®
    
*   å®Œæˆæ•°æ®è·å–åä½¿ç”¨ close æ–¹æ³•å…³é—­è¿æ¥ con
    

å¯¹æ¯”ä¸€ä¸‹ä½¿ç”¨ sqlalchemy è¿›è¡Œ sqlite æ“ä½œ:

```python
fromÂ sqlalchemyÂ importÂ create_engine  
engÂ =Â create_engine("sqlite:///:memory:",Â echo=True)  
connÂ =Â eng.connect()  
conn.execute("createÂ tableÂ xÂ (aÂ integer,Â bÂ integer)")  
conn.execute("insertÂ intoÂ xÂ (a,Â b)Â valuesÂ (1,Â 1)")  
conn.execute("insertÂ intoÂ xÂ (a,Â b)Â valuesÂ (2,Â 2)")  
resultÂ =Â conn.execute("selectÂ x.a,Â x.bÂ fromÂ x")  
assertÂ result.keys()Â ==Â ["a",Â "b"]  
resultÂ =Â conn.execute('''  
Â Â Â Â selectÂ x.a,Â x.bÂ fromÂ xÂ whereÂ a=1  
Â Â Â Â union  
Â Â Â Â selectÂ x.a,Â x.bÂ fromÂ xÂ whereÂ a=2  
''')  
assertÂ result.keys()Â ==Â ["a",Â "b"]
```

å¯ä»¥çœ‹åˆ°ä½¿ç”¨ sqlalchemy åæ“ä½œå˜çš„ç®€å•ï¼ŒæŠŠ cursorï¼Œcommitï¼Œfetch å’Œ close ç­‰æ“ä½œéšè—åˆ° engine å†…éƒ¨ï¼Œç®€åŒ–æˆ 3 æ­¥:

*   ä½¿ç”¨ create_engine å‡½æ•°åˆ›å»ºå¼•æ“ eng
    
*   ä½¿ç”¨å¼•æ“çš„ connect æ–¹æ³•åˆ›å»ºè¿æ¥ conn
    
*   ä½¿ç”¨ conn æ‰§è¡Œ SQL è¯­å¥å¹¶è·å–è¿”å›çš„æ‰§è¡Œç»“æœ
    

Engine ä»£ç åˆ†æ
----------

è·Ÿéš create_engine çš„ APIï¼Œå¯ä»¥çœ‹åˆ°è¿™é‡Œä½¿ç”¨ç­–ç•¥æ¨¡å¼å»åˆ›å»ºä¸åŒçš„ engine å®ç°:

```python
# engine/__init__.py

from . import strategies

default_strategy = "python"  # é»˜è®¤

def create_engine(*args, **kwargs):
    strategy = kwargs.pop("strategy", default_strategy)
    strategy = strategies.strategies[strategy]
    return strategy.create(*args, **kwargs)
```

é»˜è®¤çš„ engine ç­–ç•¥:

```python
# engine/strategies.py

strategies = {}

class EngineStrategy(object):

    def __init__(self):
        strategies[self.name] = self

class DefaultEngineStrategy(EngineStrategy):
    
    def create(self, name_or_url, **kwargs):
        ...

class PlainEngineStrategy(DefaultEngineStrategy):
    name = "python"
    engine_cls = base.Engine  # å¼•æ“ç±»


PlainEngineStrategy()
```

é‡ç‚¹å°±åœ¨ç­–ç•¥çš„ create æ–¹æ³•äº†, å»æ‰æ•°æ®å‡†å¤‡å’Œå¼‚å¸¸å¤„ç†åæ ¸å¿ƒä»£ç å¦‚ä¸‹:

```python
def create(self, name_or_url, **kwargs):
    ...
    # get dialect class
    u = url.make_url(name_or_url)
    entrypoint = u._get_entrypoint()
    dialect_cls = entrypoint.get_dialect_cls(u)
    
    # create dialect
    dialect = dialect_cls(**dialect_args)
    
    # pool
    poolclass = dialect_cls.get_pool_class(u)
    pool = poolclass(creator, **pool_args)
    
    # engine
    engineclass = self.engine_cls
    engine = engineclass(pool, dialect, u, **engine_args)
    ...
    return engine
```

create å‡½æ•°å¯ä»¥ç†è§£ä¸º engine çš„åˆ›å»ºæ¨¡ç‰ˆï¼Œä¸»è¦æ˜¯ä¸‹é¢ 3 ä¸ªæ­¥éª¤:

*   æ ¹æ® url è·å–åˆ°æ•°æ®åº“æ–¹è¨€ï¼Œé€‚é…ä¸åŒæ•°æ®åº“ sqlite/mysql/postgresql...
    
*   è·å–ä¸åŒæ–¹è¨€çš„è¿æ¥æ± å®ç°
    
*   åˆ›å»º engineï¼ŒæŒæœ‰ dialect å’Œ pool
    

Engine çš„æ„é€ å‡½æ•°å’Œ connect æ–¹æ³•å¦‚ä¸‹:

```python
class Engine(Connectable, log.Identified):
    _connection_cls = Connection
    
    def __init__(
        self,
        pool,
        dialect,
        url,
        logging_name=None,
        echo=None,
        proxy=None,
        execution_options=None,
    ):
        self.pool = pool
        self.url = url
        self.dialect = dialect
        self.engine = self
        ...
    
    def connect(self, **kwargs):
        return self._connection_cls(self, **kwargs)
```

engine ä¸»è¦åŠŸèƒ½å°±æ˜¯ç®¡ç†å’ŒæŒæœ‰ connectionï¼Œpool å’Œ dialectï¼Œå¯¹å¤–æä¾› APIã€‚

SQLiteDialect ä»£ç åˆ†æ
-----------------

dialect æ˜¯æ ¹æ® url è‡ªåŠ¨è¯†åˆ«ï¼Œä½¿ç”¨ PluginLoader è¿›è¡ŒåŠ¨æ€åŠ è½½:

```python
class PluginLoader(object):
    def __init__(self, group, auto_fn=None):
        self.group = group
        self.impls = {}
        self.auto_fn = auto_fn

    def load(self, name):
        # importä¸€æ¬¡ 
        if name in self.impls:
            return self.impls[name]()

        if self.auto_fn:
            loader = self.auto_fn(name)
            if loader:
                self.impls[name] = loader
                return loader()
        ...
```

sqlite-dialect ä½¿ç”¨ä¸‹é¢çš„ `__import__` åŠ¨æ€åŠ è½½æ¨¡å—:

```python
def _auto_fn(name):
    if "." in name:
        dialect, driver = name.split(".")
    else:
        dialect = name
        driver = "base"

    if dialect in _translates:
        translated = _translates[dialect]
        dialect = translated
    try:
        # åŠ¨æ€åŠ è½½æ¨¡å—
        module = __import__("sqlalchemy.dialects.%s" % (dialect,)).dialects
    except ImportError:
        return None

    module = getattr(module, dialect)
    if hasattr(module, driver):
        module = getattr(module, driver)
        return lambda: module.dialect
    else:
        return None

registry = util.PluginLoader("sqlalchemy.dialects", auto_fn=_auto_fn)
```

ä¸åŒæ–¹è¨€å®ç°éœ€è¦æä¾›ä¸€ä¸ª dialect å¯¹è±¡ï¼Œåœ¨ sqlite ä¸­æ˜¯è¿™æ ·çš„:

```python
## sqlalchemy/dialects/sqlite/__init__.py

base.dialect = dialect = pysqlite.dialect


## sqlalchemy/dialects/sqlite/pysqlite.py

class SQLiteDialect_pysqlite(SQLiteDialect):
    pass
    
dialect = SQLiteDialect_pysqlite
```

SQLiteDialect åŠŸèƒ½ç›¸ç®€å•ï¼Œä¸€æ˜¯å†³å®š POOL_CLASS çš„ç±»å‹: memory å®ç°ä½¿ç”¨çš„æ˜¯ SingletonThreadPoolï¼›db æ–‡ä»¶ä½¿ç”¨ NullPoolï¼Œä¸‹é¢åˆ†æ Pool æ—¶å€™ä¼šç”¨åˆ°ã€‚

```python

class SQLiteDialect_pysqlite(SQLiteDialect):

    @classmethod
    def get_pool_class(cls, url):
        if url.database and url.database != ":memory:":
            return pool.NullPool
        else:
            return pool.SingletonThreadPool
```

äºŒæ˜¯æä¾›åŒ…è£… DBAPI å¾—åˆ°çš„ connect:

```python
class DefaultDialect(interfaces.Dialect):
    ...
    def connect(self, *cargs, **cparams):
        return self.dbapi.connect(*cargs, **cparams)

class SQLiteDialect_pysqlite(SQLiteDialect):
    ...
    @classmethod
    def dbapi(cls):
        try:
            from pysqlite2 import dbapi2 as sqlite
        except ImportError:
            try:
                from sqlite3 import dbapi2 as sqlite  # try 2.5+ stdlib name.
            except ImportError as e:
                raise e
        return sqlite
        
    def connect(self, *cargs, **cparams):
        passphrase = cparams.pop("passphrase", "")

        pragmas = dict((key, cparams.pop(key, None)) for key in self.pragmas)

        conn = super(SQLiteDialect_pysqlcipher, self).connect(
            *cargs, **cparams
        )
        conn.execute('pragma key="%s"' % passphrase)
        for prag, value in pragmas.items():
            if value is not None:
                conn.execute('pragma %s="%s"' % (prag, value))

        return conn
```

connect åœ¨ SQLiteDialect_pysqlite ç±»å’Œçˆ¶ç±» DefaultDialect ä¹‹é—´åå¤æ¨ªè·³ï¼Œæ ¸å¿ƒåŠŸèƒ½å°±æ˜¯ä¸‹é¢ 2 å¥ä»£ç :

```python
from sqlite3 import dbapi2 as sqlite
sqlite.connect(*cargs, **cparams)
```

Connect å’Œ Pool ä»£ç åˆ†æ
----------------

Connection æ„é€ å‡½æ•°å¦‚ä¸‹:

```python
classÂ Connection(Connectable):  
Â Â Â Â   
Â Â Â Â defÂ __init__(  
Â Â Â Â Â Â Â Â self,  
Â Â Â Â Â Â Â Â engine,  
Â Â Â Â Â Â Â Â connection=None,  
Â Â Â Â Â Â Â Â close_with_result=False,  
Â Â Â Â Â Â Â Â _branch_from=None,  
Â Â Â Â Â Â Â Â _execution_options=None,  
Â Â Â Â Â Â Â Â _dispatch=None,  
Â Â Â Â Â Â Â Â _has_events=None,  
Â Â Â Â ):  
Â Â Â Â Â Â Â Â self.engineÂ =Â engine  
Â Â Â Â Â Â Â Â self.dialectÂ =Â engine.dialect  
Â Â Â Â Â Â Â Â self.__connectionÂ =Â Â engine.raw_connection()  
Â Â Â Â Â Â Â Â ...
```

connection ä¸»è¦ä½¿ç”¨ engine.raw_connection åˆ›å»ºäº†ä¸€ä¸ª DBAPI è¿æ¥

```python
classÂ Engine(Connectable,Â log.Identified):  
Â Â Â Â   
Â Â Â Â defÂ raw_connection(self,Â _connection=None):  
Â Â Â Â Â Â Â Â returnÂ self._wrap_pool_connect(  
Â Â Â Â Â Â Â Â Â Â Â Â self.pool.unique_connection,Â _connection  
Â Â Â Â Â Â Â Â )  
  
  
Â Â Â Â defÂ _wrap_pool_connect(self,Â fn,Â connection):  
Â Â Â Â Â Â Â Â dialectÂ =Â self.dialect  
Â Â Â Â Â Â Â Â try:  
Â Â Â Â Â Â Â Â Â Â Â Â returnÂ fn()  
Â Â Â Â Â Â Â Â exceptÂ dialect.dbapi.ErrorÂ asÂ e:  
Â Â Â Â Â Â Â Â Â Â Â Â ...
```
pool.unique_connection è´Ÿè´£åˆ›å»ºæ•°æ®åº“è¿æ¥ï¼Œè¿™é‡Œçš„å®ç°è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œä¸ªäººè§‰å¾—ä¹ŸæŒºç»•çš„ï¼Œæ¶‰åŠ Poolï¼ŒConnectionFairy å’Œ ConnectionRecord ä¸‰ä¸ªç±»ã€‚æˆ‘ä»¬ä¸€ç‚¹ä¸€ç‚¹çš„è·Ÿè¸ª:

```python
classÂ SingletonThreadPool(Pool):  
Â Â Â Â   
Â Â Â Â defÂ __init__(self,Â creator,Â pool_size=5,Â **kw):  
Â Â Â Â Â Â Â Â Pool.__init__(self,Â creator,Â **kw)  
Â Â Â Â Â Â Â Â self._connÂ =Â threading.local()  
Â Â Â Â Â Â Â Â self._all_connsÂ =Â set()  
Â Â Â Â Â Â Â Â self.sizeÂ =Â pool_size  
Â Â Â Â Â Â Â Â   
Â Â Â Â defÂ unique_connection(self):  
Â Â Â Â Â Â Â Â returnÂ _ConnectionFairy._checkout(self)  
Â Â Â Â   
Â Â Â Â defÂ _do_get(self):  
Â Â Â Â Â Â Â Â cÂ =Â _ConnectionRecord(self)  
Â Â Â Â Â Â Â Â self._conn.currentÂ =Â weakref.ref(c)  
Â Â Â Â Â Â Â Â ifÂ len(self._all_conns)Â >=Â self.size:  
Â Â Â Â Â Â Â Â Â Â Â Â self._cleanup()  
Â Â Â Â Â Â Â Â self._all_conns.add(c)  
Â Â Â Â Â Â Â Â returnÂ c
```

SingletonThreadPool ä¸»è¦åœ¨_do_get çš„å®ç°ï¼Œåˆ›å»ºä¸€ä¸ª ConnectionRecor å¯¹è±¡ï¼Œç„¶åå°†å…¶åŠ å…¥åˆ°è‡ªå·±ç®¡ç†çš„é›†åˆä¸­åå†è¿”å›ï¼Œæ ‡å‡†çš„æ± æ“ä½œäº†ã€‚å¦‚ä½•é€šè¿‡ unique_connection æ–¹æ³•å»è§¦å‘_do_get æ–¹æ³•å¹¶å¾—åˆ°å®é™…çš„ db-connect

```python
classÂ _ConnectionFairy(object):  
Â Â Â Â   
Â Â Â Â defÂ __init__(self,Â dbapi_connection,Â connection_record,Â echo):  
Â Â Â Â Â Â Â Â self.connectionÂ =Â dbapi_connection  
Â Â Â Â Â Â Â Â self._connection_recordÂ =Â connection_record  
Â Â Â Â Â Â Â Â   
Â Â Â Â @classmethod  
Â Â Â Â defÂ _checkout(cls,Â pool,Â threadconns=None,Â fairy=None):  
Â Â Â Â Â Â Â Â ifÂ notÂ fairy:  
Â Â Â Â Â Â Â Â Â Â Â Â fairyÂ =Â _ConnectionRecord.checkout(pool)  
  
Â Â Â Â Â Â Â Â Â Â Â Â fairy._poolÂ =Â pool  
Â Â Â Â Â Â Â Â Â Â Â Â fairy._counterÂ =Â 0  
Â Â Â Â Â Â Â Â returnÂ fairy  
...  
  
classÂ _ConnectionRecord(object):  
Â Â Â Â   
Â Â Â Â defÂ __init__(self,Â pool,Â connect=True):  
Â Â Â Â Â Â Â Â self.__poolÂ =Â pool  
  
Â Â Â Â @classmethod  
Â Â Â Â defÂ checkout(cls,Â pool):  
Â Â Â Â Â Â Â Â recÂ =Â pool._do_get()  
Â Â Â Â Â Â Â Â try:  
Â Â Â Â Â Â Â Â Â Â Â Â dbapi_connectionÂ =Â rec.get_connection()  
Â Â Â Â Â Â Â Â exceptÂ ExceptionÂ asÂ err:  
Â Â Â Â Â Â Â Â Â Â Â Â ...  
Â Â Â Â Â Â Â Â   
Â Â Â Â Â Â Â Â fairyÂ =Â _ConnectionFairy(dbapi_connection,Â rec,Â echo)  
Â Â Â Â Â Â Â Â rec.fairy_refÂ =Â weakref.ref(  
Â Â Â Â Â Â Â Â Â Â Â Â fairy,  
Â Â Â Â Â Â Â Â Â Â Â Â lambdaÂ ref:Â _finalize_fairy  
Â Â Â Â Â Â Â Â Â Â Â Â andÂ _finalize_fairy(None,Â rec,Â pool,Â ref,Â echo),  
Â Â Â Â Â Â Â Â )  
Â Â Â Â Â Â Â Â ...  
Â Â Â Â Â Â Â Â returnÂ fairy  
Â Â Â Â   
Â Â Â Â defÂ get_connection(self):  
Â Â Â Â Â Â Â Â poolÂ =Â self.__pool  
Â Â Â Â Â Â Â Â connectionÂ =Â pool.creator(self)  
Â Â Â Â Â Â Â Â self.connectionÂ =Â connection  
Â Â Â Â Â Â Â Â returnÂ connection  
  
...  
classÂ DefaultEngineStrategy(EngineStrategy):  
Â Â Â Â defÂ create(self,Â name_or_url,Â **kwargs):  
Â Â Â Â Â Â Â Â defÂ connect(connection_record=None):  
Â Â Â Â Â Â Â Â Â Â Â Â #Â dbapai-connection  
Â Â Â Â Â Â Â Â Â Â Â Â returnÂ dialect.connect(*cargs,Â **cparams)  
Â Â Â Â Â Â Â Â creatorÂ =Â pop_kwarg("creator",Â connect)  
Â Â Â Â Â Â Â Â Â Â Â Â   
Â Â Â Â Â Â Â Â poolÂ =Â poolclass(creator,Â **pool_args)  
Â Â Â Â Â Â Â Â ...
```

æ•´ä¸ªè¿‡ç¨‹å¤§æ¦‚æ˜¯è¿™æ ·çš„:

1.  ConnectionFairy.checkout è°ƒç”¨ ConnectionRecord.checkout æ–¹æ³•
    
2.  ConnectionRecord å†å›è°ƒ SingletonThreadPool çš„_do_get æ–¹æ³•åˆ›å»º rec å¯¹è±¡
    
3.  rec å¯¹è±¡ç»§ç»­è°ƒç”¨ SingletonThreadPool çš„ creator æ–¹æ³•
    
4.  creator æ–¹æ³•ä½¿ç”¨ dialect.connect è·å–æ•°æ®åº“è¿æ¥ dbapi_connection
    
5.  ä½¿ç”¨ rec å’Œ dbapi_connection å†åˆ›å»º fairy å¯¹è±¡
    
6.  è¿”å› fairy å¯¹è±¡
    

é™¤äº†æ‰§è¡Œè¿‡ç¨‹åœ¨æ¥å›ç©¿æ’å¤–ï¼Œè¿˜å› ä¸º ConnectionFairy å’Œ ConnectionRecord æ˜¯å¾ªç¯ä¾èµ–çš„:

```python
classÂ _ConnectionRecord(object):  
Â Â Â Â fairy_refÂ =Â None  
  
...  
  
classÂ _ConnectionFairy(object):  
Â Â Â Â defÂ __init__(self,Â dbapi_connection,Â connection_record,Â echo):  
Â Â Â Â Â Â Â Â self._connection_recordÂ =Â connection_record
```

> å¾ªç¯ä¾èµ–çš„å®‰å…¨å»ºç«‹ä¸»è¦ä½¿ç”¨ weakref,æƒ³å­¦ä¹ çš„å¯ä»¥ç¿»çœ‹ä¹‹å‰çš„åšæ–‡

execute-SQL è¯­å¥
-------------

çŸ¥é“ connection å¦‚ä½•åˆ›å»ºåï¼Œç»§ç»­çœ‹ connection ä½¿ç”¨ execute æ–¹æ³•æ‰§è¡Œ sql è¯­å¥:

```python
defÂ execute(self,Â object_,Â *multiparams,Â **params):  
Â Â Â Â ifÂ isinstance(object_,Â util.string_types[0]):  
Â Â Â Â Â Â Â Â returnÂ self._execute_text(object_,Â multiparams,Â params)  
Â Â Â Â ...  
  
defÂ _execute_text(self,Â statement,Â multiparams,Â params):  
Â Â Â Â Â Â Â Â """ExecuteÂ aÂ stringÂ SQLÂ statement."""  
  
Â Â Â Â Â Â Â Â dialectÂ =Â self.dialect  
Â Â Â Â Â Â Â Â parametersÂ =Â _distill_params(multiparams,Â params)  
Â Â Â Â Â Â Â Â retÂ =Â self._execute_context(  
Â Â Â Â Â Â Â Â Â Â Â Â dialect,  
Â Â Â Â Â Â Â Â Â Â Â Â dialect.execution_ctx_cls._init_statement,  
Â Â Â Â Â Â Â Â Â Â Â Â statement,  
Â Â Â Â Â Â Â Â Â Â Â Â parameters,  
Â Â Â Â Â Â Â Â Â Â Â Â statement,  
Â Â Â Â Â Â Â Â Â Â Â Â parameters,  
Â Â Â Â Â Â Â Â )  
Â Â Â Â Â Â Â Â returnÂ ret  
  
defÂ _execute_context(  
Â Â Â Â Â Â Â Â self,Â dialect,Â constructor,Â statement,Â parameters,Â *args  
Â Â Â Â ):  
Â Â Â Â connÂ =Â self.__connection  
Â Â Â Â ...  
Â Â Â Â contextÂ =Â constructor(dialect,Â self,Â conn,Â *args)  
Â Â Â Â ...  
Â Â Â Â cursor,Â statement,Â parametersÂ =Â (  
Â Â Â Â Â Â Â Â Â Â Â Â context.cursor,  
Â Â Â Â Â Â Â Â Â Â Â Â context.statement,  
Â Â Â Â Â Â Â Â Â Â Â Â context.parameters,  
Â Â Â Â Â Â Â Â )  
Â Â Â Â ...  
Â Â Â Â self.dialect.do_execute(  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â cursor,Â statement,Â parameters,Â context  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â )  
Â Â Â Â ...  
Â Â Â Â resultÂ =Â context._setup_crud_result_proxy()  
Â Â Â Â returnÂ result
```

> execute è¿˜æœ‰ä¸€äº›å…¶å®ƒåˆ†æ”¯ï¼Œå¯ä»¥é€‚ç”¨ ORM ç­‰åœºæ™¯ï¼Œæœ¬ç¯‡åªä»‹ç»çº¯æ–‡æœ¬çš„ sql

å‡½æ•°å±‚å±‚ç©¿é€åï¼Œä¸»è¦åŒ…æ‹¬ä¸‹é¢ä¸‰æ®µä»£ç :

*   åˆ©ç”¨ dialect åˆ›å»º context ä¸Šä¸‹æ–‡
    
*   ä½¿ç”¨ dialect æ‰§è¡Œ sql è¯­å¥(æ–‡æœ¬)
    
*   ä½¿ç”¨ context è·å–æ‰§è¡Œçš„ç»“æœå¹¶è¿”å›
    

dialect æ¶‰åŠçš„ä¸Šä¸‹æ–‡ context åˆ›å»ºå’Œ sql æ‰§è¡Œ:

```python
classÂ DefaultDialect(interfaces.Dialect):  
  
Â Â Â Â defÂ do_execute(self,Â cursor,Â statement,Â parameters,Â context=None):  
Â Â Â Â Â Â Â Â cursor.execute(statement,Â parameters)  
  
DefaultDialect.execution_ctx_clsÂ =Â DefaultExecutionContext
```

å¯ä»¥çœ‹åˆ°æ‰§è¡Œè¯­å¥å°±æ˜¯ä½¿ç”¨ cursor å¯¹è±¡ï¼Œå’Œå‰é¢ç›´æ¥æ“ä½œ sqlite ä¸€è‡´ã€‚æ¯æ¡ sql æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ context æ˜¯ä¸‹é¢æ–¹å¼æ„å»ºçš„:

```python
classÂ DefaultExecutionContext(interfaces.ExecutionContext):  
Â Â Â Â @classmethod  
Â Â Â Â defÂ _init_statement(  
Â Â Â Â Â Â Â Â cls,Â dialect,Â connection,Â dbapi_connection,Â statement,Â parameters  
Â Â Â Â ):  
Â Â Â Â Â Â Â Â selfÂ =Â cls.__new__(cls)  
Â Â Â Â Â Â Â Â self.root_connectionÂ =Â connection  
Â Â Â Â Â Â Â Â self._dbapi_connectionÂ =Â dbapi_connection  
Â Â Â Â Â Â Â Â self.dialectÂ =Â connection.dialect  
Â Â Â Â Â Â Â Â ...  
Â Â Â Â Â Â Â Â self.parametersÂ =Â [{}]  
Â Â Â Â Â Â Â Â ...  
Â Â Â Â Â Â Â Â self.statementÂ =Â self.unicode_statementÂ =Â statement  
  
Â Â Â Â Â Â Â Â self.cursorÂ =Â self.create_cursor()  
Â Â Â Â Â Â Â Â returnÂ self  
Â Â Â Â   
Â Â Â Â defÂ create_cursor(self):  
Â Â Â Â Â Â Â Â returnÂ self._dbapi_connection.cursor()
```

Result åˆ†æ
--------

sql æ‰§è¡Œçš„ç»“æœï¼Œåœ¨`context._setup_crud_result_proxy`ä¸­è¿”å› ResultProxy å¯¹è±¡ã€‚ResultProxy æ˜¯ä¸€ä¸ªå¯ä»¥è¿­ä»£çš„å¯¹è±¡,å¯ä»¥ä½¿ç”¨ fetchone è·å–å•æ¡è®°å½•:

```python
classÂ ResultProxy(object):  
Â Â Â Â   
Â Â Â Â defÂ __iter__(self):  
Â Â Â Â Â Â Â Â whileÂ True:  
Â Â Â Â Â Â Â Â Â Â Â Â rowÂ =Â self.fetchone()  
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ rowÂ isÂ None:  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â return  
Â Â Â Â Â Â Â Â Â Â Â Â else:  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â yieldÂ row  
Â Â Â Â   
Â Â Â Â defÂ __next__(self):  
Â Â Â Â Â Â Â Â rowÂ =Â self.fetchone()  
Â Â Â Â Â Â Â Â ifÂ rowÂ isÂ None:  
Â Â Â Â Â Â Â Â Â Â Â Â raiseÂ StopIteration()  
Â Â Â Â Â Â Â Â else:  
Â Â Â Â Â Â Â Â Â Â Â Â returnÂ row  
Â Â Â Â   
Â Â Â Â defÂ fetchone(self):  
Â Â Â Â Â Â Â Â try:  
Â Â Â Â Â Â Â Â Â Â Â Â rowÂ =Â self._fetchone_impl()  
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ rowÂ isÂ notÂ None:  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ self.process_rows([row])[0]  
  
Â Â Â Â defÂ _fetchone_impl(self):  
Â Â Â Â Â Â Â Â try:  
Â Â Â Â Â Â Â Â Â Â Â Â returnÂ self.cursor.fetchone()  
Â Â Â Â Â Â Â Â exceptÂ AttributeError:  
Â Â Â Â Â Â Â Â Â Â Â Â returnÂ self._non_result(None)
```

å¯¹è·å–çš„è®°å½•è¿˜å¯ä»¥ä½¿ç”¨ process_rows è¿›è¡Œæ•°æ®å°è£…ï¼Œè¿™ä¸ªä»¥åå†ä»‹ç»ã€‚

å°ç»“
--

æˆ‘ä»¬å®Œæ•´çš„è¿½é€äº†ä½¿ç”¨ sqlalchemy æ‰§è¡Œ sql è¯­å¥çš„è¿‡ç¨‹ï¼Œå¯ä»¥ç®€å•å°ç»“å¦‚ä¸‹:

*   ä½¿ç”¨ url è¯­æ³•æŸ¥æ‰¾å¹¶åŠ¨æ€åŠ è½½æ•°æ®åº“æ–¹è¨€
    
*   åˆ›å»ºå¼•æ“å¯¹è±¡ï¼Œç®¡ç†æ–¹è¨€ï¼Œæ–¹è¨€çš„è¿æ¥æ± ï¼Œæä¾› SQL çš„ API
    
*   ä½¿ç”¨å¼•æ“å¯¹è±¡è·å–åˆ°æ•°æ®åº“é“¾æ¥ connectï¼Œè·å–åçš„é“¾æ¥ä½¿ç”¨ pool ç®¡ç†
    
*   æ‰§è¡Œ SQL è¯­å¥å¹¶è·å–æ‰§è¡Œç»“æœ
    

ä¸‹é¢çš„ç±»å›¾ä»‹ç»çš„æ›´è¯¦ç»†, å®Œæ•´å±•ç¤ºäº† engine/pool/connection/dialect çš„å…³ç³»:

![](https://static01.imgkr.com/temp/be689d3c66c347859a2e0e0b62d91289.png)

å°æŠ€å·§
---

deprecated æ˜¯ä¸€ä¸ªåºŸå¼ƒ API è£…é¥°å™¨, ä¸»è¦ç»™ä¸€äº›ä¸å†æ”¯æŒ/æ¨èçš„ API åŠ ä¸Šä½¿ç”¨è­¦å‘Šå’Œæ›´æ›¿çš„æ–¹æ³•:

```python
defÂ deprecated(version,Â message=None,Â add_deprecation_to_docstring=True):  
  
Â Â Â Â ifÂ add_deprecation_to_docstring:  
Â Â Â Â Â Â Â Â headerÂ =Â "..Â deprecated::Â %sÂ %s"Â %Â (version,Â (messageÂ orÂ ""))  
Â Â Â Â else:  
Â Â Â Â Â Â Â Â headerÂ =Â None  
  
Â Â Â Â ifÂ messageÂ isÂ None:  
Â Â Â Â Â Â Â Â messageÂ =Â "CallÂ toÂ deprecatedÂ functionÂ %(func)s"  
  
Â Â Â Â defÂ decorate(fn):  
Â Â Â Â Â Â Â Â returnÂ _decorate_with_warning(  
Â Â Â Â Â Â Â Â Â Â Â Â fn,  
Â Â Â Â Â Â Â Â Â Â Â Â exc.SADeprecationWarning,  
Â Â Â Â Â Â Â Â Â Â Â Â messageÂ %Â dict(func=fn.__name__),  
Â Â Â Â Â Â Â Â Â Â Â Â header,  
Â Â Â Â Â Â Â Â )  
  
Â Â Â Â returnÂ decorate
```

æ¯”å¦‚ Connectable.contextual_connect çš„ API è¿™æ ·ä½¿ç”¨:

```python
classÂ Connectable(object):  
  
Â Â Â Â @util.deprecated(  
Â Â Â Â Â Â Â Â "1.3",  
Â Â Â Â Â Â Â Â "TheÂ :meth:`.Engine.contextual_connect`Â andÂ "  
Â Â Â Â Â Â Â Â ":meth:`.Connection.contextual_connect`Â methodsÂ areÂ deprecated.Â Â ThisÂ "  
Â Â Â Â Â Â Â Â "methodÂ isÂ anÂ artifactÂ ofÂ theÂ threadlocalÂ engineÂ strategyÂ whichÂ isÂ "  
Â Â Â Â Â Â Â Â "alsoÂ toÂ beÂ deprecated.Â Â Â ForÂ explicitÂ connectionsÂ fromÂ anÂ "  
Â Â Â Â Â Â Â Â ":class:`.Engine`,Â useÂ theÂ :meth:`.Engine.connect`Â method.",  
Â Â Â Â )  
Â Â Â Â defÂ contextual_connect(self,Â *arg,Â **kw):  
Â Â Â Â Â Â Â Â ...
```

è¿™å¯¹åº“/æ¡†æ¶çš„å¼€å‘è€…éå¸¸æœ‰ç”¨ï¼ŒAPI çš„å˜åŠ¨å¯ä»¥è¿™ç§æ–¹å¼é€šçŸ¥ä½¿ç”¨è€…ï¼Œè¿›è¡Œå¹³æ»‘çš„å‡çº§æ›¿æ¢ã€‚

---

SQLAlchemy æ˜¯ Python SQL å·¥å…·ç®±å’Œ ORM æ¡†æ¶ï¼Œå®ƒä¸ºåº”ç”¨ç¨‹åºå¼€å‘äººå‘˜æä¾›äº†å…¨é¢è€Œçµæ´»çš„ SQL åŠŸèƒ½ã€‚å®ƒæä¾›äº†ä¸€æ•´å¥—ä¼ä¸šçº§æŒä¹…åŒ–æ–¹æ¡ˆï¼Œæ—¨åœ¨é«˜æ•ˆï¼Œé«˜æ€§èƒ½åœ°è®¿é—®æ•°æ®åº“ï¼Œå¹¶ç¬¦åˆ Pythonic ä¹‹ç¦…ã€‚é¡¹ç›®ä»£ç é‡æ¯”è¾ƒå¤§ï¼Œæ¥è¿‘ 200 ä¸ªæ–‡ä»¶ï¼Œ7 ä¸‡è¡Œä»£ç ï¼Œ æˆ‘ä»¬ä¸€èµ·æ¥æŒ‘æˆ˜ä¸€ä¸‹ã€‚ç”±äºç¯‡å¹…åŸå› ï¼Œåˆ†æˆä¸Šä¸‹ä¸¤ç¯‡ï¼Œä¸Šç¯‡æˆ‘ä»¬å­¦ä¹ äº† core éƒ¨åˆ†çš„ engineï¼Œdialectï¼Œconnection å’Œ pool ç­‰éƒ¨åˆ†ï¼Œä¸‹ç¯‡ä¸»è¦å­¦ä¹  core éƒ¨åˆ†å‰©ä½™çš„ sql è¡¨è¾¾å¼å’Œ orm éƒ¨åˆ†ï¼ŒåŒ…æ‹¬å¦‚ä¸‹å†…å®¹:


SQL-schema ä½¿ç”¨ç¤ºä¾‹
--------------

ä¸Šç¯‡ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„ sql éƒ½æ˜¯æ‰‹å·¥ç¼–å†™çš„è¯­å¥ï¼Œä¸‹é¢è¿™æ ·ï¼š

```python
create table x (a integer, b integer)
insert into x (a, b) values (1, 1)
```

åœ¨ sqlalchemy ä¸­å¯ä»¥é€šè¿‡å®šä¹‰ schema çš„æ–¹å¼è¿›è¡Œæ•°æ®æ“ä½œï¼Œå®Œæ•´çš„ç¤ºä¾‹å¦‚ä¸‹:

```python
fromÂ sqlalchemyÂ importÂ create_engine  
fromÂ sqlalchemyÂ importÂ MetaData  
fromÂ sqlalchemyÂ importÂ Table  
fromÂ sqlalchemyÂ importÂ Column  
fromÂ sqlalchemyÂ importÂ Integer  
fromÂ sqlalchemyÂ importÂ String  
fromÂ sqlalchemy.sqlÂ importÂ select  
  
engineÂ =Â create_engine('sqlite:///:memory:',Â echo=True)  
  
metadataÂ =Â MetaData()  
usersÂ =Â Table('users',Â metadata,  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Column('id',Â Integer,Â primary_key=True),  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Column('name',Â String),  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Column('fullname',Â String),  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â )  
metadata.create_all(engine)  
  
insÂ =Â users.insert().values(name='jack',Â fullname='JackÂ Jones')  
print(ins)  
resultÂ =Â engine.execute(ins)  
print(result,Â result.inserted_primary_key)  
sÂ =Â select([users])  
resultÂ =Â conn.execute(s)  
forÂ rowÂ inÂ result:  
Â Â Â Â print(row)  
  
resultÂ =Â engine.execute("selectÂ *Â fromÂ users")  
forÂ rowÂ inÂ result:  
Â Â Â Â print(row)
```

ç¤ºä¾‹ç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹:

*   åˆ›å»º engineï¼Œç”¨äºæ•°æ®åº“è¿æ¥
    
*   åˆ›å»º metadataï¼Œç”¨äºç®¡ç† schema
    
*   åˆ›å»º users è¡¨çš„ Tableï¼Œç»‘å®šåˆ° metadataï¼›åŒæ—¶åŒ…æ‹¬ idï¼Œname å’Œ fullname ä¸‰ä¸ª column
    
*   å°† metadata æäº¤åˆ° engine(åˆ›å»ºè¡¨)
    
*   ä½¿ç”¨ users æ’å…¥æ•°æ®
    
*   æŸ¥è¯¢ users çš„æ•°æ®
    
*   ä½¿ç”¨æ™®é€š sql çš„æ–¹å¼éªŒè¯æ•°æ®
    

ä¸‹é¢æ˜¯ç¤ºä¾‹çš„æ‰§è¡Œæ—¥å¿—,æ¸…æ™°å±•ç¤ºäº†ä¸Šé¢è¿‡ç¨‹:

```python
...  
2021-04-19Â 10:02:09,166Â INFOÂ sqlalchemy.engine.base.EngineÂ   
CREATEÂ TABLEÂ usersÂ (  
Â idÂ INTEGERÂ NOTÂ NULL,Â   
Â nameÂ VARCHAR,Â   
Â fullnameÂ VARCHAR,Â   
Â PRIMARYÂ KEYÂ (id)  
)  
2021-04-19Â 10:02:09,166Â INFOÂ sqlalchemy.engine.base.EngineÂ ()  
2021-04-19Â 10:02:09,167Â INFOÂ sqlalchemy.engine.base.EngineÂ COMMIT  
INSERTÂ INTOÂ usersÂ (name,Â fullname)Â VALUESÂ (:name,Â :fullname)  
2021-04-19Â 10:02:09,167Â INFOÂ sqlalchemy.engine.base.EngineÂ INSERTÂ INTOÂ usersÂ (name,Â fullname)Â VALUESÂ (?,Â ?)  
2021-04-19Â 10:02:09,168Â INFOÂ sqlalchemy.engine.base.EngineÂ ('jack',Â 'JackÂ Jones')  
2021-04-19Â 10:02:09,168Â INFOÂ sqlalchemy.engine.base.EngineÂ COMMIT  
<sqlalchemy.engine.result.ResultProxyÂ objectÂ atÂ 0x7ffca0607070>Â [1]  
2021-04-27Â 11:38:19,134Â INFOÂ sqlalchemy.engine.base.EngineÂ SELECTÂ users.id,Â users.name,Â users.fullnameÂ   
FROMÂ users  
2021-04-27Â 11:38:19,134Â INFOÂ sqlalchemy.engine.base.EngineÂ ()  
(1,Â 'jack',Â 'JackÂ Jones')  
2021-04-19Â 10:02:09,168Â INFOÂ sqlalchemy.engine.base.EngineÂ selectÂ *Â fromÂ users  
2021-04-19Â 10:02:09,168Â INFOÂ sqlalchemy.engine.base.EngineÂ ()  
(1,Â 'jack',Â 'JackÂ Jones')
```

åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ç®€å•äº†è§£ä¸€ä¸‹ SQL è¯­å¥çš„åˆ†ç±»:

![](https://static.javatpoint.com/dbms/images/dbms-sql-command.png)

[Type of SQL Statements](https://way2tutorial.com/sql/type-of-sql-statements.php)

åœ¨æˆ‘ä»¬çš„ schema ä½¿ç”¨ç¤ºä¾‹ä¸­ï¼Œå°±åŒ…æ‹¬äº† DDLï¼ŒDML å’Œ DQL ä¸‰ç§ç±»å‹çš„è¯­å¥ï¼Œä¸‹é¢æˆ‘ä»¬æŒ‰ç…§è¿™ 3 ç§ç±»å‹ï¼Œè¯¦ç»†äº†è§£ä¸€ä¸‹ sqlalchemy çš„ sql è¡¨è¾¾å¼éƒ¨åˆ†ã€‚sql è¡¨è¾¾å¼ä¸»è¦åœ¨ sql åŒ…ä¸­ï¼Œéƒ¨åˆ†æ–‡ä»¶çš„åŠŸèƒ½å¦‚ä¸‹:

| æ¨¡å—                       | æè¿°        |
|--------------------------|-----------|
| base.py                  | åŸºç¡€ç±»       |
| compiler.py              | sql ç¼–è¯‘     |
| crud.py                  | crud çš„å‚æ•°å¤„ç† |
| ddl.py                   | DDL è¯­å¥     |
| default_comparator.py    | æ¯”è¾ƒ        |
| dml.py                   | DML è¯­å¥     |
| elements.py              | åŸºæœ¬ç±»å‹      |
| operators.py             | sql æ“ä½œç¬¦    |
| schema.py                | schema å®šä¹‰  |
| selectable.py            | DQL       |
| sqltypes.py&&type_api.py | sql æ•°æ®ç±»å‹   |
| vistitors.py             | é€’å½’ç®—æ³•      |


DDL(Data Definition Language)åˆ›å»º table
------------------------------------

é¦–å…ˆäº†è§£ä¸€ä¸‹ schema çš„åŸºç¡€å®ç° visitable:

```python
classÂ VisitableType(type):  
  
Â Â Â Â defÂ __init__(cls,Â clsname,Â bases,Â clsdict):  
Â Â Â Â Â Â Â Â ifÂ clsnameÂ !=Â "Visitable"Â andÂ hasattr(cls,Â "__visit_name__"):  
Â Â Â Â Â Â Â Â Â Â Â Â _generate_dispatch(cls)  
Â Â Â Â Â Â Â Â super(VisitableType,Â cls).__init__(clsname,Â bases,Â clsdict)  
  
defÂ _generate_dispatch(cls):  
Â Â Â Â ifÂ "__visit_name__"Â inÂ cls.__dict__:  
Â Â Â Â Â Â Â Â visit_nameÂ =Â cls.__visit_name__  
Â Â Â Â Â Â Â Â ifÂ isinstance(visit_name,Â str):  
Â Â Â Â Â Â Â Â Â Â Â Â getterÂ =Â operator.attrgetter("visit_%s"Â %Â visit_name)  
  
Â Â Â Â Â Â Â Â Â Â Â Â defÂ _compiler_dispatch(self,Â visitor,Â **kw):  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â try:  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â methÂ =Â getter(visitor)  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â exceptÂ AttributeError:  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â raiseÂ exc.UnsupportedCompilationError(visitor,Â cls)  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â else:  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ meth(self,Â **kw)  
Â Â Â Â Â Â Â Â   
Â Â Â Â Â Â Â Â cls._compiler_dispatchÂ =Â _compiler_dispatch  
  
classÂ Visitable(util.with_metaclass(VisitableType,Â object)):  
Â Â Â Â pass
```

Visitable çº¦å®šå­ç±»å¿…é¡»æä¾› **visit_name** çš„ç±»å±æ€§ï¼Œç”¨æ¥ç»‘å®šç¼–è¯‘æ–¹æ³•ã€‚å‚ä¸ sql çš„ç±»éƒ½ç»§æ‰¿è‡ª Visitable:

```python
classÂ SchemaItem(SchemaEventTarget,Â visitors.Visitable):  
Â Â Â Â __visit_name__Â =Â "schema_item"  
Â Â Â Â   
classÂ MetaData(SchemaItem):  
Â Â Â Â __visit_name__Â =Â "metadata"  
Â Â Â Â   
classÂ Table(DialectKWArgs,Â SchemaItem,Â TableClause):  
Â Â Â Â __visit_name__Â =Â "table"  
  
classÂ Column(DialectKWArgs,Â SchemaItem,Â ColumnClause):  
Â Â Â Â __visit_name__Â =Â "column"  
  
classÂ TypeEngine(Visitable):  
Â Â Â Â ...  
  
classÂ Integer(_LookupExpressionAdapter,Â TypeEngine):  
Â Â Â Â __visit_name__Â =Â "integer"
```

MetaData æ˜¯ schema çš„é›†åˆï¼Œè®°å½•äº†æ‰€æœ‰çš„ Table å®šä¹‰, é€šè¿‡ `_add_table` å‡½æ•°ç”¨æ¥æ·»åŠ è¡¨:

```python
classÂ MetaData(SchemaItem):  
Â Â Â Â defÂ __init__(  
Â Â Â Â Â Â Â Â self,  
Â Â Â Â Â Â Â Â bind=None,  
Â Â Â Â Â Â Â Â reflect=False,  
Â Â Â Â Â Â Â Â schema=None,  
Â Â Â Â Â Â Â Â quote_schema=None,  
Â Â Â Â Â Â Â Â naming_convention=None,  
Â Â Â Â Â Â Â Â info=None,  
Â Â Â Â ):  
Â Â Â Â Â Â Â Â #Â tableé›†åˆ  
Â Â Â Â Â Â Â Â self.tablesÂ =Â util.immutabledict()  
Â Â Â Â Â Â Â Â   
Â Â Â Â Â Â Â Â self.schemaÂ =Â quoted_name(schema,Â quote_schema)  
Â Â Â Â Â Â Â Â self._schemasÂ =Â set()  
Â Â Â Â   
Â Â Â Â defÂ _add_table(self,Â name,Â schema,Â table):  
Â Â Â Â Â Â Â Â keyÂ =Â _get_table_key(name,Â schema)  
Â Â Â Â Â Â Â Â dict.__setitem__(self.tables,Â key,Â table)  
Â Â Â Â Â Â Â Â ifÂ schema:  
Â Â Â Â Â Â Â Â Â Â Â Â self._schemas.add(schema)
```

Table æ˜¯ column çš„é›†åˆï¼Œåœ¨åˆ›å»º table å¯¹è±¡çš„æ—¶å€™ï¼ŒæŠŠè‡ªå·±æ·»åŠ åˆ° metadata ä¸­:

```python
classÂ Table(DialectKWArgs,Â SchemaItem,Â TableClause):  
Â Â Â Â   
Â Â Â Â defÂ __new__(cls,Â *args,Â **kw):  
Â Â Â Â Â Â Â Â name,Â metadata,Â argsÂ =Â args[0],Â args[1],Â args[2:]  
Â Â Â Â Â Â Â Â schemaÂ =Â metadata.schema  
Â Â Â Â Â Â Â Â tableÂ =Â object.__new__(cls)  
Â Â Â Â Â Â Â Â #Â æ·»åŠ åˆ°metadata  
Â Â Â Â Â Â Â Â metadata._add_table(name,Â schema,Â table)  
Â Â Â Â Â Â Â Â table._init(name,Â metadata,Â *args,Â **kw)  
Â Â Â Â Â Â Â Â returnÂ table  
Â Â Â Â   
Â Â Â Â defÂ _init(self,Â name,Â metadata,Â *args,Â **kwargs):  
Â Â Â Â Â Â Â Â super(Table,Â self).__init__(  
Â Â Â Â Â Â Â Â Â Â Â Â quoted_name(name,Â kwargs.pop("quote",Â None))  
Â Â Â Â Â Â Â Â )  
Â Â Â Â Â Â Â Â self.metadataÂ =Â metadata  
Â Â Â Â Â Â Â Â self.schemaÂ =Â metadata.schema  
Â Â Â Â Â Â Â Â #Â columné›†åˆ  
Â Â Â Â Â Â Â Â self._columnsÂ =Â ColumnCollection()  
Â Â Â Â Â Â Â Â self._init_items(*args)  
Â Â Â Â   
Â Â Â Â defÂ _init_items(self,Â *args):  
Â Â Â Â Â Â Â Â #Â columnÂ   
Â Â Â Â Â Â Â Â forÂ itemÂ inÂ args:  
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ itemÂ isÂ notÂ None:  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â item._set_parent_with_dispatch(self)
```

Column æ˜¯é€šè¿‡ä¸‹é¢çš„æ–¹æ³•å°† column æ·»åŠ åˆ° table çš„ colummns ä¸­:

```python
classÂ Column(DialectKWArgs,Â SchemaItem,Â ColumnClause):  
Â Â Â Â   
Â Â Â Â defÂ __init__(self,Â *args,Â **kwargs):  
Â Â Â Â Â Â Â Â pass  
Â Â Â Â Â Â Â Â   
Â Â Â Â defÂ _set_parent(self,Â table):  
Â Â Â Â Â Â Â Â table._columns.replace(self)  
  
classÂ ColumnCollection(util.OrderedProperties):  
Â Â Â Â defÂ replace(self,Â column):  
Â Â Â Â Â Â Â Â ...  
Â Â Â Â Â Â Â Â self._data[column.key]Â =Â column  
Â Â Â Â Â Â Â Â ...
```

ç°é˜¶æ®µï¼Œæˆ‘ä»¬å¤§æ¦‚å˜æ¸…äº† metadataï¼Œtable å’Œ column çš„æ•°æ®ç»“æ„ï¼šmetadata æŒæœ‰ table é›†åˆï¼Œtable æŒæœ‰ column é›†åˆã€‚æ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªæ•°æ®ç»“æ„å¦‚ä½•è½¬æ¢æˆ sql è¯­å¥ï¼ŒAPI æ˜¯é€šè¿‡ `MetaData.create_all` å‡½æ•°å®ç°:

```python
classÂ MetaData(SchemaItem):  
Â Â Â Â defÂ create_all(self,Â bind=None,Â tables=None,Â checkfirst=True):  
Â Â Â Â Â Â Â Â bind._run_visitor(  
Â Â Â Â Â Â Â Â Â Â Â Â ddl.SchemaGenerator,Â self,Â checkfirst=checkfirst,Â tables=tables  
Â Â Â Â Â Â Â Â )  
  
classÂ Engine(Connectable,Â log.Identified):  
Â Â Â Â defÂ _run_visitor(  
Â Â Â Â Â Â Â Â self,Â visitorcallable,Â element,Â connection=None,Â **kwargs  
Â Â Â Â ):  
Â Â Â Â Â Â Â Â withÂ self._optional_conn_ctx_manager(connection)Â asÂ conn:  
Â Â Â Â Â Â Â Â Â Â Â Â conn._run_visitor(visitorcallable,Â element,Â **kwargs)  
Â Â Â Â Â Â Â Â Â Â Â Â   
classÂ Connection(Connectable):  
Â Â Â Â defÂ _run_visitor(self,Â visitorcallable,Â element,Â **kwargs):  
Â Â Â Â Â Â Â Â visitorcallable(self.dialect,Â self,Â **kwargs).traverse_single(element)
```

create-table çš„ sql ç¼–è¯‘ä¸»è¦ç”± ddl ä¸­çš„ SchemaGenerator å®ç°, ä¸‹é¢æ˜¯ SchemaGenerator çš„ç»§æ‰¿å…³ç³»å’Œæ ¸å¿ƒçš„ traverse_single å‡½æ•°:

```python
classÂ ClauseVisitor(object):  
  
Â Â Â Â defÂ traverse_single(self,Â obj,Â **kw):  
Â Â Â Â Â Â Â Â #Â éå†æ‰€æœ‰çš„visitå®ç°Â   
Â Â Â Â Â Â Â Â forÂ vÂ inÂ self.visitor_iterator:  
Â Â Â Â Â Â Â Â Â Â Â Â methÂ =Â getattr(v,Â "visit_%s"Â %Â obj.__visit_name__,Â None)  
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ meth:  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â returnÂ meth(obj,Â **kw)  
Â Â Â Â   
Â Â Â Â @property  
Â Â Â Â defÂ visitor_iterator(self):  
Â Â Â Â Â Â Â Â vÂ =Â self  
Â Â Â Â Â Â Â Â whileÂ v:  
Â Â Â Â Â Â Â Â Â Â Â Â yieldÂ v  
Â Â Â Â Â Â Â Â Â Â Â Â vÂ =Â getattr(v,Â "_next",Â None)  
Â Â Â Â Â Â Â Â Â Â Â Â   
classÂ SchemaVisitor(ClauseVisitor):  
Â Â Â Â ...  
Â Â Â Â   
classÂ DDLBase(SchemaVisitor):  
Â Â Â Â ...  
  
classÂ SchemaGenerator(DDLBase):  
Â Â Â Â ...
```

åˆ›å»º metaï¼Œtable å’Œ columun çš„è¿‡ç¨‹:

```python
classÂ SchemaGenerator(DDLBase):  
Â Â Â Â defÂ visit_metadata(self,Â metadata):  
Â Â Â Â Â Â Â Â tablesÂ =Â list(metadata.tables.values())  
Â Â Â Â Â Â Â Â collectionÂ =Â sort_tables_and_constraints(  
Â Â Â Â Â Â Â Â Â Â Â Â [tÂ forÂ tÂ inÂ tablesÂ ifÂ self._can_create_table(t)]  
Â Â Â Â Â Â Â Â )  
Â Â Â Â Â Â Â Â forÂ table,Â fkcsÂ inÂ collection:  
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ tableÂ isÂ notÂ None:  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â åˆ›å»ºè¡¨Â   
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â self.traverse_single(  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â table,  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â create_ok=True,  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â include_foreign_key_constraints=fkcs,  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â _is_metadata_operation=True,  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â )  
Â Â Â Â Â Â Â Â Â Â Â Â   
Â Â Â Â defÂ visit_table(  
Â Â Â Â Â Â Â Â self,  
Â Â Â Â Â Â Â Â table,  
Â Â Â Â Â Â Â Â create_ok=False,  
Â Â Â Â Â Â Â Â include_foreign_key_constraints=None,  
Â Â Â Â Â Â Â Â _is_metadata_operation=False,  
Â Â Â Â ):  
Â Â Â Â Â Â Â Â forÂ columnÂ inÂ table.columns:  
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ column.defaultÂ isÂ notÂ None:  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â #Â åˆ›å»ºcolumn-DDLElement  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â self.traverse_single(column.default)  
Â Â Â Â   
Â Â Â Â Â Â Â Â self.connection.execute(  
Â Â Â Â Â Â Â Â Â Â Â Â #Â fmt:Â off  
Â Â Â Â Â Â Â Â Â Â Â Â #Â åˆ›å»ºcreate-table-DDLElement  
Â Â Â Â Â Â Â Â Â Â Â Â CreateTable(  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â table,  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â include_foreign_key_constraints=Â Â #Â noqa  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â include_foreign_key_constraints,  
Â Â Â Â Â Â Â Â Â Â Â Â )  
Â Â Â Â Â Â Â Â Â Â Â Â #Â fmt:Â on  
Â Â Â Â Â Â Â Â )
```

CreateTableDDLElement å’Œ CreateColumnDDLElement çš„ç»§æ‰¿å…³ç³»:

```python
classÂ _DDLCompiles(ClauseElement):  
Â Â Â Â defÂ _compiler(self,Â dialect,Â **kw):  
Â Â Â Â Â Â Â Â returnÂ dialect.ddl_compiler(dialect,Â self,Â **kw)  
Â Â Â Â Â Â Â Â   
classÂ DDLElement(Executable,Â _DDLCompiles):  
Â Â Â Â ...  
  
classÂ _CreateDropBase(DDLElement):  
Â Â Â Â ...  
Â Â Â Â   
classÂ CreateTable(_CreateDropBase):  
  
Â Â Â Â __visit_name__Â =Â "create_table"  
Â Â Â Â   
Â Â Â Â defÂ __init__(  
Â Â Â Â Â Â Â Â self,Â element,Â on=None,Â bind=None,Â include_foreign_key_constraints=None  
Â Â Â Â ):  
Â Â Â Â Â Â Â Â super(CreateTable,Â self).__init__(element,Â on=on,Â bind=bind)  
Â Â Â Â Â Â Â Â self.columnsÂ =Â [CreateColumn(column)Â forÂ columnÂ inÂ element.columns]  
  
classÂ CreateColumn(_DDLCompiles):  
Â Â Â Â __visit_name__Â =Â "create_column"  
  
Â Â Â Â defÂ __init__(self,Â element):  
Â Â Â Â Â Â Â Â self.elementÂ =Â element
```

æœ€ç»ˆè¿™äº› DDLElement åœ¨ compiler ä¸­è¢« DDLCompiler ç¼–è¯‘æˆ sql è¯­å¥, `CREATE TABLE`æ˜¯è¿™æ ·è¢«ç¼–è¯‘çš„:

```python
defÂ visit_create_table(self,Â create):  
Â Â Â Â tableÂ =Â create.element  
Â Â Â Â preparerÂ =Â self.preparer  
  
Â Â Â Â textÂ =Â "nCREATEÂ "  
Â Â Â Â ifÂ table._prefixes:  
Â Â Â Â Â Â Â Â textÂ +=Â "Â ".join(table._prefixes)Â +Â "Â "  
Â Â Â Â textÂ +=Â "TABLEÂ "Â +Â preparer.format_table(table)Â +Â "Â "  
  
Â Â Â Â create_table_suffixÂ =Â self.create_table_suffix(table)  
Â Â Â Â ifÂ create_table_suffix:  
Â Â Â Â Â Â Â Â textÂ +=Â create_table_suffixÂ +Â "Â "  
  
Â Â Â Â textÂ +=Â "("  
  
Â Â Â Â separatorÂ =Â "n"  
  
Â Â Â Â #Â ifÂ onlyÂ oneÂ primaryÂ key,Â specifyÂ itÂ alongÂ withÂ theÂ column  
Â Â Â Â first_pkÂ =Â False  
Â Â Â Â forÂ create_columnÂ inÂ create.columns:  
Â Â Â Â Â Â Â Â columnÂ =Â create_column.element  
Â Â Â Â Â Â Â Â try:  
Â Â Â Â Â Â Â Â Â Â Â Â processedÂ =Â self.process(  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â create_column,Â first_pk=column.primary_keyÂ andÂ notÂ first_pk  
Â Â Â Â Â Â Â Â Â Â Â Â )  
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ processedÂ isÂ notÂ None:  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â textÂ +=Â separator  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â separatorÂ =Â ",Â n"  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â textÂ +=Â "t"Â +Â processed  
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ column.primary_key:  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â first_pkÂ =Â True  
Â Â Â Â Â Â Â Â exceptÂ exc.CompileErrorÂ asÂ ce:  
Â Â Â Â Â Â Â Â Â Â Â Â ...  
  
Â Â Â Â constÂ =Â self.create_table_constraints(  
Â Â Â Â Â Â Â Â table,  
Â Â Â Â Â Â Â Â _include_foreign_key_constraints=create.include_foreign_key_constraints,Â Â #Â noqa  
Â Â Â Â )  
Â Â Â Â ifÂ const:  
Â Â Â Â Â Â Â Â textÂ +=Â separatorÂ +Â "t"Â +Â const  
  
Â Â Â Â textÂ +=Â "n)%snn"Â %Â self.post_create_table(table)  
Â Â Â Â returnÂ text  
  
defÂ visit_create_column(self,Â create,Â first_pk=False):  
Â Â Â Â columnÂ =Â create.element  
  
Â Â Â Â textÂ =Â self.get_column_specification(column,Â first_pk=first_pk)  
Â Â Â Â constÂ =Â "Â ".join(  
Â Â Â Â Â Â Â Â self.process(constraint)Â forÂ constraintÂ inÂ column.constraints  
Â Â Â Â )  
Â Â Â Â ifÂ const:  
Â Â Â Â Â Â Â Â textÂ +=Â "Â "Â +Â const  
  
Â Â Â Â returnÂ text
```

åœ¨å‰é¢ column ä»‹ç»ä¸­ï¼Œæˆ‘ä»¬ç•¥è¿‡äº†æ•°æ®ç±»å‹ã€‚å¤§å®¶éƒ½çŸ¥é“ sql çš„æ•°æ®ç±»å‹å’Œ python æ•°æ®ç±»å‹æœ‰å·®å¼‚, ä¸‹é¢æ˜¯ä¸€äº›å¸¸è§çš„ SQL æ•°æ®ç±»å‹:

```python
classÂ TypeEngine(Visitable):  
Â Â Â Â ...  
Â Â Â Â   
classÂ Integer(_LookupExpressionAdapter,Â TypeEngine):  
Â Â Â Â __visit_name__Â =Â "integer"  
Â Â Â Â ...  
  
classÂ String(Concatenable,Â TypeEngine):  
Â Â Â Â __visit_name__Â =Â "string"  
Â Â Â Â ...  
  
classÂ CHAR(String):  
Â Â Â Â __visit_name__Â =Â "CHAR"  
Â Â Â Â ...  
  
classÂ VARCHAR(String):  
Â Â Â Â __visit_name__Â =Â "VARCHAR"  
Â Â Â Â ...
```

æ•°æ®ç±»å‹ç”± GenericTypeCompiler è¿›è¡Œç¼–è¯‘:

```python
classÂ TypeCompiler(util.with_metaclass(util.EnsureKWArgType,Â object)):  
Â Â Â Â   
Â Â Â Â defÂ process(self,Â type_,Â **kw):  
Â Â Â Â Â Â Â Â returnÂ type_._compiler_dispatch(self,Â **kw)  
Â Â Â Â   
classÂ GenericTypeCompiler(TypeCompiler):  
Â Â Â Â   
Â Â Â Â defÂ visit_INTEGER(self,Â type_,Â **kw):  
Â Â Â Â Â Â Â Â returnÂ "INTEGER"  
Â Â Â Â Â Â Â Â   
Â Â Â Â defÂ visit_string(self,Â type_,Â **kw):  
Â Â Â Â Â Â Â Â returnÂ self.visit_VARCHAR(type_,Â **kw)  
Â Â Â Â   
Â Â Â Â defÂ visit_VARCHAR(self,Â type_,Â **kw):  
Â Â Â Â Â Â Â Â returnÂ self._render_string_type(type_,Â "VARCHAR")  
Â Â Â Â   
Â Â Â Â defÂ _render_string_type(self,Â type_,Â name):  
Â Â Â Â Â Â Â Â textÂ =Â name  
Â Â Â Â Â Â Â Â ifÂ type_.length:  
Â Â Â Â Â Â Â Â Â Â Â Â textÂ +=Â "(%d)"Â %Â type_.length  
Â Â Â Â Â Â Â Â ifÂ type_.collation:  
Â Â Â Â Â Â Â Â Â Â Â Â textÂ +=Â 'Â COLLATEÂ "%s"'Â %Â type_.collation  
Â Â Â Â Â Â Â Â returnÂ text
```

DML(Data Manipulation Language)ä½¿ç”¨ insert æ’å…¥æ•°æ®
-------------------------------------------

æ•°æ®æ’å…¥çš„ API ç”± TableClause æä¾›çš„ insert å‡½æ•°:

```python
classÂ TableClause(Immutable,Â FromClause):  
Â Â Â Â   
Â Â Â Â @util.dependencies("sqlalchemy.sql.dml")  
Â Â Â Â defÂ insert(self,Â dml,Â values=None,Â inline=False,Â **kwargs):  
Â Â Â Â Â Â Â Â returnÂ dml.Insert(self,Â values=values,Â inline=inline,Â **kwargs)
```

dml ä¸­æä¾›äº† Insert ç±»çš„å®ç°:

```python
classÂ UpdateBase(  
Â Â Â Â HasCTE,Â DialectKWArgs,Â HasPrefixes,Â Executable,Â ClauseElement  
):  
Â Â Â Â ...  
Â Â Â Â   
classÂ ValuesBase(UpdateBase):  
Â Â Â Â ...  
Â Â Â Â   
classÂ Insert(ValuesBase):  
Â Â Â Â __visit_name__Â =Â "insert"  
Â Â Â Â ...
```

æŒ‰ç…§ ddl çš„ç»éªŒï¼Œæˆ‘ä»¬æŸ¥æ‰¾ insert è¯­å¥çš„ç¼–è¯‘æ–¹æ³•ï¼Œåœ¨ SQLCompiler ä¸­:

```python
classÂ SQLCompiler(Compiled):  
Â Â Â Â   
Â Â Â Â defÂ visit_insert(self,Â insert_stmt,Â asfrom=False,Â **kw):  
  
Â Â Â Â Â Â Â Â crud_paramsÂ =Â crud._setup_crud_params(  
Â Â Â Â Â Â Â Â Â Â Â Â self,Â insert_stmt,Â crud.ISINSERT,Â **kw  
Â Â Â Â Â Â Â Â )  
  
Â Â Â Â Â Â Â Â ifÂ insert_stmt._has_multi_parameters:  
Â Â Â Â Â Â Â Â Â Â Â Â crud_params_singleÂ =Â crud_params[0]  
Â Â Â Â Â Â Â Â else:  
Â Â Â Â Â Â Â Â Â Â Â Â crud_params_singleÂ =Â crud_params  
  
Â Â Â Â Â Â Â Â preparerÂ =Â self.preparer  
Â Â Â Â Â Â Â Â supports_default_valuesÂ =Â self.dialect.supports_default_values  
  
Â Â Â Â Â Â Â Â textÂ =Â "INSERTÂ "  
  
Â Â Â Â Â Â Â Â textÂ +=Â "INTOÂ "  
Â Â Â Â Â Â Â Â table_textÂ =Â preparer.format_table(insert_stmt.table)  
  
Â Â Â Â Â Â Â Â ifÂ crud_params_singleÂ orÂ notÂ supports_default_values:  
Â Â Â Â Â Â Â Â Â Â Â Â textÂ +=Â "Â (%s)"Â %Â ",Â ".join(  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â [preparer.format_column(c[0])Â forÂ cÂ inÂ crud_params_single]  
Â Â Â Â Â Â Â Â Â Â Â Â )  
Â Â Â Â Â Â Â Â ...  
Â Â Â Â Â Â Â Â ifÂ insert_stmt.selectÂ isÂ notÂ None:  
Â Â Â Â Â Â Â Â Â Â Â Â select_textÂ =Â self.process(self._insert_from_select,Â **kw)  
  
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ self.ctesÂ andÂ toplevelÂ andÂ self.dialect.cte_follows_insert:  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â textÂ +=Â "Â %s%s"Â %Â (self._render_cte_clause(),Â select_text)  
Â Â Â Â Â Â Â Â Â Â Â Â else:  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â textÂ +=Â "Â %s"Â %Â select_text  
Â Â Â Â Â Â Â Â elifÂ notÂ crud_paramsÂ andÂ supports_default_values:  
Â Â Â Â Â Â Â Â Â Â Â Â textÂ +=Â "Â DEFAULTÂ VALUES"  
Â Â Â Â Â Â Â Â elifÂ insert_stmt._has_multi_parameters:  
Â Â Â Â Â Â Â Â Â Â Â Â textÂ +=Â "Â VALUESÂ %s"Â %Â (  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ",Â ".join(  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â "(%s)"Â %Â (",Â ".join(c[1]Â forÂ cÂ inÂ crud_param_set))  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â forÂ crud_param_setÂ inÂ crud_params  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â )  
Â Â Â Â Â Â Â Â Â Â Â Â )  
Â Â Â Â Â Â Â Â else:  
Â Â Â Â Â Â Â Â Â Â Â Â textÂ +=Â "Â VALUESÂ (%s)"Â %Â ",Â ".join([c[1]Â forÂ cÂ inÂ crud_params])  
  
Â Â Â Â Â Â Â Â returnÂ text
```

å¯ä»¥çœ‹åˆ° insert è¯­å¥å°±æ˜¯å¯¹ Insert å¯¹è±¡ï¼Œé€šè¿‡å­—ç¬¦ä¸²æ¨¡ç‰ˆæ‹¼æ¥è€Œæ¥ã€‚

DQL(Data Query Language)ä½¿ç”¨ select æŸ¥è¯¢æ•°æ®
------------------------------------

æ•°æ®æŸ¥è¯¢ select è¯­å¥ä¹Ÿéƒ½æœ‰ç‰¹å®šçš„æ•°æ®ç»“æ„ Selectï¼Œç»§æ‰¿å…³ç³»å¦‚ä¸‹:

```python
classÂ SelectBase(HasCTE,Â Executable,Â FromClause):  
Â Â Â Â ...  
Â Â Â Â   
classÂ GenerativeSelect(SelectBase):  
Â Â Â Â ...  
Â Â Â Â   
classÂ Select(HasPrefixes,Â HasSuffixes,Â GenerativeSelect):  
Â Â Â Â __visit_name__Â =Â "select"  
Â Â Â Â   
Â Â Â Â defÂ __init__(  
Â Â Â Â Â Â Â Â self,  
Â Â Â Â Â Â Â Â columns=None,  
Â Â Â Â Â Â Â Â whereclause=None,  
Â Â Â Â Â Â Â Â from_obj=None,  
Â Â Â Â Â Â Â Â distinct=False,  
Â Â Â Â Â Â Â Â having=None,  
Â Â Â Â Â Â Â Â correlate=True,  
Â Â Â Â Â Â Â Â prefixes=None,  
Â Â Â Â Â Â Â Â suffixes=None,  
Â Â Â Â Â Â Â Â **kwargs  
Â Â Â Â ):  
Â Â Â Â Â Â Â Â GenerativeSelect.__init__(self,Â **kwargs)  
Â Â Â Â Â Â Â Â ...
```

select çš„ç¼–è¯‘è¯­å¥ä¹Ÿåœ¨ SQLCompiler ä¸­:

```python
classÂ SQLCompiler(Compiled):  
Â Â Â Â   
Â Â Â Â defÂ visit_select(  
Â Â Â Â Â Â Â Â self,  
Â Â Â Â Â Â Â Â select,  
Â Â Â Â Â Â Â Â asfrom=False,  
Â Â Â Â Â Â Â Â parens=True,  
Â Â Â Â Â Â Â Â fromhints=None,  
Â Â Â Â Â Â Â Â compound_index=0,  
Â Â Â Â Â Â Â Â nested_join_translation=False,  
Â Â Â Â Â Â Â Â select_wraps_for=None,  
Â Â Â Â Â Â Â Â lateral=False,  
Â Â Â Â Â Â Â Â **kwargs  
Â Â Â Â ):  
Â Â Â Â Â Â Â Â ...  
Â Â Â Â Â Â Â Â   
Â Â Â Â Â Â Â Â fromsÂ =Â self._setup_select_stack(select,Â entry,Â asfrom,Â lateral)  
  
Â Â Â Â Â Â Â Â column_clause_argsÂ =Â kwargs.copy()  
Â Â Â Â Â Â Â Â column_clause_args.update(  
Â Â Â Â Â Â Â Â Â Â Â Â {"within_label_clause":Â False,Â "within_columns_clause":Â False}  
Â Â Â Â Â Â Â Â )  
  
Â Â Â Â Â Â Â Â textÂ =Â "SELECTÂ "Â Â #Â we'reÂ offÂ toÂ aÂ goodÂ startÂ !  
  
Â Â Â Â Â Â Â Â textÂ +=Â self.get_select_precolumns(select,Â **kwargs)  
Â Â Â Â Â Â Â Â #Â theÂ actualÂ listÂ ofÂ columnsÂ toÂ printÂ inÂ theÂ SELECTÂ columnÂ list.  
Â Â Â Â Â Â Â Â inner_columnsÂ =Â [  
Â Â Â Â Â Â Â Â Â Â Â Â c  
Â Â Â Â Â Â Â Â Â Â Â Â forÂ cÂ inÂ [  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â self._label_select_column(  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â select,  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â column,  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â populate_result_map,  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â asfrom,  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â column_clause_args,  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â name=name,  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â )  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â forÂ name,Â columnÂ inÂ select._columns_plus_names  
Â Â Â Â Â Â Â Â Â Â Â Â ]  
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ cÂ isÂ notÂ None  
Â Â Â Â Â Â Â Â ]  
Â Â Â Â Â Â Â Â   
Â Â Â Â Â Â Â Â ...  
Â Â Â Â Â Â Â Â   
Â Â Â Â Â Â Â Â textÂ =Â self._compose_select_body(  
Â Â Â Â Â Â Â Â Â Â Â Â text,Â select,Â inner_columns,Â froms,Â byfrom,Â kwargs  
Â Â Â Â Â Â Â Â )  
  
Â Â Â Â Â Â Â Â ifÂ select._statement_hints:  
Â Â Â Â Â Â Â Â Â Â Â Â per_dialectÂ =Â [  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ht  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â forÂ (dialect_name,Â ht)Â inÂ select._statement_hints  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ dialect_nameÂ inÂ ("*",Â self.dialect.name)  
Â Â Â Â Â Â Â Â Â Â Â Â ]  
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ per_dialect:  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â textÂ +=Â "Â "Â +Â self.get_statement_hint_text(per_dialect)  
  
Â Â Â Â Â Â Â Â ifÂ self.ctesÂ andÂ toplevel:  
Â Â Â Â Â Â Â Â Â Â Â Â textÂ =Â self._render_cte_clause()Â +Â text  
  
Â Â Â Â Â Â Â Â ifÂ select._suffixes:  
Â Â Â Â Â Â Â Â Â Â Â Â textÂ +=Â "Â "Â +Â self._generate_prefixes(  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â select,Â select._suffixes,Â **kwargs  
Â Â Â Â Â Â Â Â Â Â Â Â )  
  
Â Â Â Â Â Â Â Â self.stack.pop(-1)  
  
Â Â Â Â Â Â Â Â ifÂ (asfromÂ orÂ lateral)Â andÂ parens:  
Â Â Â Â Â Â Â Â Â Â Â Â returnÂ "("Â +Â textÂ +Â ")"  
Â Â Â Â Â Â Â Â else:  
Â Â Â Â Â Â Â Â Â Â Â Â returnÂ text
```

select è¯­å¥ä¸€æ ·æ˜¯é‡‡ç”¨å­—ç¬¦ä¸²æ‹¼æ¥å¾—åˆ°ã€‚

ORM ç¤ºä¾‹
------

orm çš„ä½¿ç”¨å’Œ schema ä½¿ç”¨æ–¹å¼ç•¥æœ‰ä¸åŒ, ä¸‹é¢æ˜¯ orm çš„ç¤ºä¾‹:

```python
fromÂ sqlalchemyÂ importÂ create_engine  
fromÂ sqlalchemy.ext.declarativeÂ importÂ declarative_base  
fromÂ sqlalchemyÂ importÂ Column,Â Integer,Â String  
fromÂ sqlalchemy.ormÂ importÂ sessionmaker  
  
engineÂ =Â create_engine('sqlite:///:memory:',Â echo=True)  
ModelÂ =Â declarative_base()  
  
classÂ User(Model):  
Â Â Â Â __tablename__Â =Â 'users'  
  
Â Â Â Â idÂ =Â Column(Integer,Â primary_key=True)  
Â Â Â Â nameÂ =Â Column(String)  
Â Â Â Â fullnameÂ =Â Column(String)  
Â Â Â Â nicknameÂ =Â Column(String)  
  
Â Â Â Â defÂ __repr__(self):  
Â Â Â Â Â Â Â Â returnÂ "<User(name='%s',Â fullname='%s',Â nickname='%s')>"Â %Â (  
Â Â Â Â Â Â Â Â Â Â Â Â self.name,Â self.fullname,Â self.nickname)  
  
Model.metadata.create_all(engine)  
print("="*10)  
SessionÂ =Â sessionmaker(bind=engine)  
sessionÂ =Â Session()  
  
ed_userÂ =Â User(name='ed',Â fullname='EdÂ Jones',Â nickname='edsnickname')  
session.add(ed_user)  
session.commit()  
print(ed_user.id)  
resultÂ =Â engine.execute("selectÂ *Â fromÂ users")  
forÂ rowÂ inÂ result:  
Â Â Â Â print(row)
```

å¯¹æ¯” schema å’Œ orm çš„å·®å¼‚ï¼Œå¯ä»¥å¾—åˆ°ä¸‹è¡¨:

schema æ–¹å¼|orm æ–¹å¼ åˆ›å»º engineï¼Œç”¨äºæ•°æ®åº“è¿æ¥|- åˆ›å»º metadataï¼Œç”¨äºç®¡ç† schema|åˆ›å»º Model åˆ›å»º users è¡¨çš„ Table|åˆ›å»º User æ¨¡å‹ å°† metadata æäº¤åˆ° engine(åˆ›å»ºè¡¨)|- -|åˆ›å»º session ä½¿ç”¨ users æ’å…¥æ•°æ®|ä½¿ç”¨ session æ’å…¥æ•°æ®

æ€»ç»“ä¸€ä¸‹ä¸»è¦å°± 2 ç‚¹å·®å¼‚ï¼š

1.  orm æ—¶å€™ä¸ç”¨æ˜¾ç¤ºçš„åˆ›å»ºè¡¨çš„ schema
    
2.  orm çš„æ•°æ®å¤„ç†éƒ½ä½¿ç”¨ session æ¥æ“ä½œï¼Œè€Œä¸æ˜¯ä½¿ç”¨ connection
    

model æ ¸å¿ƒåŠŸèƒ½
---------

Model ç±»ä½¿ç”¨ declarative_base åŠ¨æ€åˆ›å»º:

```python
classÂ DeclarativeMeta(type):  
Â Â Â Â defÂ __init__(cls,Â classname,Â bases,Â dict_):  
Â Â Â Â Â Â Â Â ifÂ "_decl_class_registry"Â notÂ inÂ cls.__dict__:  
Â Â Â Â Â Â Â Â Â Â Â Â _as_declarative(cls,Â classname,Â cls.__dict__)  
Â Â Â Â Â Â Â Â type.__init__(cls,Â classname,Â bases,Â dict_)  
  
Â Â Â Â defÂ __setattr__(cls,Â key,Â value):  
Â Â Â Â Â Â Â Â _add_attribute(cls,Â key,Â value)  
  
Â Â Â Â defÂ __delattr__(cls,Â key):  
Â Â Â Â Â Â Â Â _del_attribute(cls,Â key)  
  
defÂ declarative_base(  
Â Â Â Â bind=None,  
Â Â Â Â metadata=None,  
Â Â Â Â mapper=None,  
Â Â Â Â cls=object,  
Â Â Â Â name="Base",  
Â Â Â Â constructor=_declarative_constructor,  
Â Â Â Â class_registry=None,  
Â Â Â Â metaclass=DeclarativeMeta,  
):  
Â Â Â Â #Â åˆ›å»ºmetadata  
Â Â Â Â lcl_metadataÂ =Â metadataÂ orÂ MetaData()  
  
Â Â Â Â ifÂ class_registryÂ isÂ None:  
Â Â Â Â Â Â Â Â class_registryÂ =Â weakref.WeakValueDictionary()  
  
Â Â Â Â basesÂ =Â notÂ isinstance(cls,Â tuple)Â andÂ (cls,)Â orÂ cls  
Â Â Â Â class_dictÂ =Â dict(  
Â Â Â Â Â Â Â Â _decl_class_registry=class_registry,Â metadata=lcl_metadata  
Â Â Â Â )  
  
Â Â Â Â #Â æ„é€ å‡½æ•°  
Â Â Â Â ifÂ constructor:  
Â Â Â Â Â Â Â Â class_dict["__init__"]Â =Â constructor  
Â Â Â Â ifÂ mapper:  
Â Â Â Â Â Â Â Â class_dict["__mapper_cls__"]Â =Â mapper  
Â Â Â Â   
Â Â Â Â #Â class-meta  
Â Â Â Â returnÂ metaclass(name,Â bases,Â class_dict)
```

å…³äºå¦‚ä½•åŠ¨æ€åˆ›å»ºç±»ï¼Œåœ¨å°æŠ€å·§ä¸­è¿›è¡Œä»‹ç»ã€‚declarative_base ä¸»è¦å®šä¹‰äº† Model ç±»çš„å‡ ä¸ªç‰¹æ€§ï¼š

*   Model ç±»çš„æ„é€ å‡½æ•°`__init__`ä½¿ç”¨_declarative_constructor
    
*   Model ç±»çš„å­ç±»åœ¨æ„é€ çš„æ—¶å€™ä¼šè°ƒç”¨_as_declarative
    
*   model å¯¹è±¡ä¼šä½¿ç”¨_add_attribute è¿›è¡Œèµ‹å€¼
    

å…ˆä»æ„é€ å‡½æ•°_declarative_constructor å¼€å§‹:

```python
defÂ _declarative_constructor(self,Â **kwargs):  
Â Â Â Â cls_Â =Â type(self)  
Â Â Â Â forÂ kÂ inÂ kwargs:  
Â Â Â Â Â Â Â Â ifÂ notÂ hasattr(cls_,Â k):  
Â Â Â Â Â Â Â Â Â Â Â Â raiseÂ TypeError(  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â "%rÂ isÂ anÂ invalidÂ keywordÂ argumentÂ forÂ %s"Â %Â (k,Â cls_.__name__)  
Â Â Â Â Â Â Â Â Â Â Â Â )  
Â Â Â Â Â Â Â Â setattr(self,Â k,Â kwargs[k])  
  
  
_declarative_constructor.__name__Â =Â "__init__"
```

çœ‹èµ·æ¥éå¸¸ç®€å•ï¼Œä½†æ˜¯è¿™é‡Œåšäº†ä¸€ä¸ªç±»å’Œå¯¹è±¡å®ä¾‹ä¹‹é—´çš„æ ¡éªŒè½¬æ¢ã€‚æˆ‘ä»¬å…ˆçœ‹ä¸€æ®µæ¼”ç¤ºä»£ç :

```python
classÂ DummyModel(object):  
Â Â Â Â nameÂ =Â ["dummy_model"]Â Â #Â å¼•ç”¨ç±»å‹  
  
aÂ =Â DummyModel()  
bÂ =Â DummyModel()  
assertÂ id(a.name)Â ==Â id(b.name)Â ==Â id(DummyModel.name)  
a.name.append("a")  
assertÂ id(a.name)Â ==Â id(b.name)Â ==Â id(DummyModel.name)
```

DummyModel çš„ç±»å±æ€§ name å’Œ a å¯¹è±¡çš„ name å±æ€§éƒ½æ˜¯åŒä¸€ä¸ªå¼•ç”¨ã€‚å¦‚æœä½¿ç”¨ Model ç±»:

```python
ModelÂ =Â declarative_base()  
  
classÂ UserModel(Model):  
Â Â Â Â __tablename__Â =Â 'user'Â Â #Â å¿…é¡»å­—æ®µ  
Â Â Â Â idÂ =Â Column(Integer,Â primary_key=True)Â Â #Â å¿…é¡»å­—æ®µ  
Â Â Â Â nameÂ =Â Column(String)  
  
cÂ =Â UserModel()  
c.nameÂ =Â "c"  
dÂ =Â UserModel()  
d.nameÂ =Â "d"  
#Â æ³¨æ„å¹¶ä¸æ˜¯Column  
assertÂ isinstance(UserModel.name,Â InstrumentedAttribute)  
assertÂ isinstance(c.name,Â str)  
assertÂ d.nameÂ ==Â "d"  
assertÂ id(c.name)Â !=Â id(d.name)Â !=Â id(UserModel.name)
```

å¯ä»¥å‘ç° UserModel çš„ç±»å±æ€§ name å’Œ d å¯¹è±¡çš„ name å±æ€§å®Œå…¨ä¸ä¸€æ ·ï¼Œç±»å®šä¹‰çš„æ˜¯ Cloumn(InstrumentedAttribute)ï¼Œå¯¹è±¡å˜æˆäº† strã€‚è¿™ä¸ªå°±æ˜¯ orm æ¨¡å‹çš„ç‰¹æ€§ä¹‹ä¸€ï¼ŒModel æ˜¯å®šä¹‰æ ¼å¼æ¨¡ç‰ˆï¼Œå¯¹è±¡å®ä¾‹åŒ–åè½¬åŒ–ä¸ºæ™®é€šæ•°æ®ã€‚

Model çš„å¦å¤–ä¸€ä¸ªåŠŸèƒ½æ˜¯éšå¼åˆ›å»º Table å¯¹è±¡ï¼Œåœ¨_as_declarative å‡½æ•°ä¸­é€šè¿‡_MapperConfig å®ç°

```python
classÂ _MapperConfig(object):  
Â Â Â Â defÂ setup_mapping(cls,Â cls_,Â classname,Â dict_):  
Â Â Â Â Â Â Â Â cfg_clsÂ =Â _MapperConfig  
Â Â Â Â Â Â Â Â cfg_cls(cls_,Â classname,Â dict_)  
Â Â Â Â   
Â Â Â Â defÂ __init__(self,Â cls_,Â classname,Â dict_):  
Â Â Â Â Â Â Â Â ...  
Â Â Â Â Â Â Â Â self._setup_table()  
Â Â Â Â Â Â Â Â ...  
Â Â Â Â   
Â Â Â Â defÂ _setup_table(self):  
Â Â Â Â Â Â Â Â ...  
Â Â Â Â Â Â Â Â table_clsÂ =Â Table  
Â Â Â Â Â Â Â Â args,Â table_kwÂ =Â (),Â {}  
Â Â Â Â Â Â Â Â ifÂ table_args:  
Â Â Â Â Â Â Â Â Â Â Â Â ifÂ isinstance(table_args,Â dict):  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â table_kwÂ =Â table_args  
Â Â Â Â Â Â Â Â Â Â Â Â elifÂ isinstance(table_args,Â tuple):  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ifÂ isinstance(table_args[-1],Â dict):  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â args,Â table_kwÂ =Â table_args[0:-1],Â table_args[-1]  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â else:  
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â argsÂ =Â table_args  
  
Â Â Â Â Â Â Â Â autoloadÂ =Â dict_.get("__autoload__")  
Â Â Â Â Â Â Â Â ifÂ autoload:  
Â Â Â Â Â Â Â Â Â Â Â Â table_kw["autoload"]Â =Â True  
  
Â Â Â Â Â Â Â Â cls.__table__Â =Â tableÂ =Â table_cls(  
Â Â Â Â Â Â Â Â Â Â Â Â tablename,  
Â Â Â Â Â Â Â Â Â Â Â Â cls.metadata,  
Â Â Â Â Â Â Â Â Â Â Â Â *(tuple(declared_columns)Â +Â tuple(args)),  
Â Â Â Â Â Â Â Â Â Â Â Â **table_kw  
Â Â Â Â Â Â Â Â )  
Â Â Â Â Â Â Â Â ...
```

è€Œ Column æ˜¯é€šè¿‡ä¸‹é¢çš„å‡½æ•°å®ç°:

```python
defÂ _add_attribute(cls,Â key,Â value):  
  
Â Â Â Â ifÂ "__mapper__"Â inÂ cls.__dict__:  
Â Â Â Â Â Â Â Â ifÂ isinstance(value,Â Column):  
Â Â Â Â Â Â Â Â Â Â Â Â _undefer_column_name(key,Â value)  
Â Â Â Â Â Â Â Â Â Â Â Â cls.__table__.append_column(value)  
Â Â Â Â Â Â Â Â Â Â Â Â cls.__mapper__.add_property(key,Â value)  
Â Â Â Â Â Â Â Â ...  
Â Â Â Â else:  
Â Â Â Â Â Â Â Â type.__setattr__(cls,Â key,Â value)
```

Model é€šè¿‡ä¸Šé¢çš„æ–¹å¼ï¼Œéšå¼åˆ›å»ºäº† Schema(Table)ï¼Œå®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­åªéœ€è¦ä½¿ç”¨ Model ç±»ï¼Œä¸ç”¨å…³æ³¨ Schema çš„å®šä¹‰ã€‚

> session çš„æºç ç”±äºç¯‡å¹…å’Œæ—¶é—´æœ‰é™ï¼Œç•™å¾…ä»¥åå†è¡Œåˆ†æ

å°ç»“
--

sqlalchemy å¯ä»¥åœ¨ä½å±‚æ¬¡ä¸Šæä¾›äº† sql è¯­å¥çš„æ–¹å¼ä½¿ç”¨ï¼›åœ¨æ¬¡å±‚æ¬¡ä¸Šæä¾›å®šä¹‰ schema æ–¹å¼ä½¿ç”¨ï¼›åœ¨é«˜å±‚æ¬¡ä¸Šæä¾› orm çš„å®ç°ï¼Œè®©åº”ç”¨å¯ä»¥æ ¹æ®é¡¹ç›®çš„ç‰¹ç‚¹è‡ªä¸»é€‰æ‹©ä¸åŒå±‚çº§çš„ APIã€‚

ä½¿ç”¨ schema æ—¶å€™ï¼Œä¸»è¦ä½¿ç”¨ Metadataï¼ŒTable å’Œ Column ç­‰å®šä¹‰ Schema æ•°æ®ç»“æ„ï¼Œä½¿ç”¨ç¼–è¯‘å™¨è‡ªåŠ¨å°† schema è½¬æ¢æˆåˆæ³•çš„ sql è¯­å¥ã€‚

ä½¿ç”¨ orm çš„æ—¶å€™ï¼Œåˆ™æ˜¯åˆ›å»ºç‰¹å®šçš„æ•°æ®æ¨¡å‹ï¼Œæ¨¡å‹å¯¹è±¡ä¼šéšå¼åˆ›å»º schemaï¼Œé€šè¿‡ session æ–¹å¼è¿›è¡Œæ•°æ®è®¿é—®ã€‚

æœ€åå†å›é¡¾ä¸€ä¸‹ sqlalchemy çš„æ¶æ„å›¾:

![](http://aosabook.org/images/sqlalchemy/layers.png)

å°æŠ€å·§
---

sqlalchemy ä¸­æä¾›äº†ä¸€ä¸ªåŠ¨æ€åˆ›å»ºç±»çš„æ–¹å¼ï¼Œä¸»è¦åœ¨ declarative_base å’Œ DeclarativeMeta ä¸­å®ç°ã€‚æˆ‘å‚è€ƒè¿™ä¸ªå®ç°æ–¹å¼åšäº†ä¸€ä¸ªç±»å·¥å‚:

```python
classÂ DeclarativeMeta(type):  
Â Â Â Â defÂ __init__(cls,Â klass_name,Â bases,Â dict_):  
Â Â Â Â Â Â Â Â print("class_init",Â klass_name,Â bases,Â dict_)  
Â Â Â Â Â Â Â Â type.__init__(cls,Â klass_name,Â bases,Â dict_)  
  
defÂ get_attr(self,Â key):  
Â Â Â Â print("getattr",Â self,Â key)  
Â Â Â Â returnÂ self.__dict__[key]  
  
defÂ constructor(self,Â *args,Â **kwargs):  
Â Â Â Â print("constructor",Â self,Â args,Â kwargs)  
Â Â Â Â forÂ k,Â vÂ inÂ kwargs.items():  
Â Â Â Â Â Â Â Â setattr(self,Â k,Â v)  
  
defÂ dynamic_class(name):  
Â Â Â Â class_dictÂ =Â {  
Â Â Â Â Â Â Â Â "__init__":Â constructor,  
Â Â Â Â Â Â Â Â "__getattr__":Â get_attr  
Â Â Â Â }  
  
Â Â Â Â returnÂ DeclarativeMeta(name,Â (object,),Â class_dict)  
  
DummyModelÂ =Â dynamic_class("Dummy")  
dummyÂ =Â DummyModel(1,Â name="hello",Â age=18)  
print(dummy,Â type(dummy),Â dummy.name,Â dummy.age)  
  
  
#Â class_initÂ DummyÂ (<classÂ 'object'>,)Â {'__init__':Â <functionÂ test_dynamic_class.<locals>.constructorÂ atÂ 0x7f898827ef70>,Â '__getattr__':Â <functionÂ test_dynamic_class.<locals>.get_attrÂ atÂ 0x7f89882105e0>}  
#Â constructorÂ <sample.DummyÂ objectÂ atÂ 0x7f89882a5820>Â (1,)Â {'name':Â 'hello',Â 'age':Â 18}  
#Â <sample.DummyÂ objectÂ atÂ 0x7f89882a5820>Â <classÂ 'sample.Dummy'>Â helloÂ 18
```

ç¤ºä¾‹ä¸­æˆ‘åŠ¨æ€åˆ›å»ºäº†ä¸€ä¸ª DummyModel ç±»ï¼Œ`type(dummy)`å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªç±»åæ˜¯ **Dummy**ã€‚è¿™ä¸ªç±»å¯ä»¥çš„æ„é€ å‡½æ•°å¯ä»¥æ¥å— name å’Œ age ä¸¤ä¸ªå±æ€§ã€‚è¿™ç§åˆ›å»ºæ–¹å¼å’Œ collections.namedtuple æœ‰ç‚¹ç±»ä¼¼ã€‚

ä¸€ç‚¹æ„Ÿæ‚Ÿ
----

sqlalchemy çš„æºç éå¸¸å¤æ‚ï¼Œå‰å‰ååä¸€å…±å‡†å¤‡äº†ä¸€ä¸ªæœˆï¼Œå½¢æˆçš„ 2 ç¯‡æ–‡æ¡£ä»…ä»…æ¶‰åŠæ ¸å¿ƒæµç¨‹å’Œç”¨æ³•ï¼Œç»†èŠ‚éƒ¨åˆ†ç¼ºå¤±è¾ƒå¤šï¼Œä»¥åæœ‰æœºä¼šè¿˜éœ€è¦ç»§ç»­é˜…è¯»ã€‚åœ¨è¿™ä¸€ä¸ªæœˆä¸­ï¼Œå…‹æœäº†å·¥ä½œè¾ƒå¿™ï¼Œæ²¡æœ‰æ—¶é—´å†™ç¨¿çš„çƒ¦èºï¼›å…‹æœäº†é˜…è¯»è¿›å…¥å›°å¢ƒï¼Œä¸€åº¦æƒ³æ”¾å¼ƒçš„å¿ƒç†éšœç¢ï¼›å…‹æœäº† deadline ä¸´è¿‘ï¼Œæ–‡ç¨¿è¿˜åªæ˜¯ä¸€ä¸ªé›å½¢ï¼Œä½¿ç”¨å­˜ç¨¿é¡¶æ›¿çš„ç¾æ„§ï¼›å…‹æœäº†ç¬”è®°è½¯ä»¶æ•…éšœï¼Œå†™å®Œçš„æ–‡ç¨¿ä¸¢å¤±ï¼Œå®Œå…¨é‡å†™çš„æ‡Šæ¼ã€‚æˆ˜èƒœè¿™äº›å›°éš¾ï¼Œæœ€ç»ˆè¿˜æ˜¯å¾—ä»¥å®Œæˆï¼Œå¿ƒç†ä¸Šæœ‰å¤§æ»¡è¶³ã€‚å½“ç„¶æœ€å¤§çš„æ”¶è·è¿˜æ˜¯å¯¹ ORM ä¸­é—´ä»¶æœ‰äº†åˆæ­¥çš„äº†è§£ï¼Œä¹Ÿå¸Œæœ›æ¢³ç†çš„ ORM æµç¨‹å¯¹å¤§å®¶æœ‰ä¸€å®šçš„å¸®åŠ©ï¼Œå¦‚æœè·å¾—å¤§å®¶çš„æ”¯æŒä¼šæ›´åŠ æ»¡æ„â™¥ï¸ã€‚

å‚è€ƒé“¾æ¥
----

*   https://docs.sqlalchemy.org/en/13/index.html
    
*   http://aosabook.org/en/sqlalchemy.html
    
*   https://nettee.github.io/posts/2016/SQLAlchemy-Architecture-Note/