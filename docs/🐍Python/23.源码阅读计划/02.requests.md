---
title: requests æºç é˜…è¯»
tags: 
  - requests
  - æºç é˜…è¯»
categories: 
  - ğŸ’» å·¥ä½œ
  - ğŸPython
  - å…¨æ ˆä¹‹è·¯
  - è®¾è®¡æ¨¡å¼
date: 2021-06-08 21:41:49
permalink: /rs/requests/
---
requests æ˜¯ä¸€ä¸ªç®€æ´æ˜“ç”¨çš„ http-client åº“ï¼Œæ—©æœŸåœ¨ github çš„ python é¡¹ç›®å—æ¬¢è¿ç¨‹åº¦å¯ä»¥æ’å TOP10ã€‚ä»‹ç»è¿™ä¸ªé¡¹ç›®ï¼Œæˆ‘ä¸ªäººè§‰å¾—è¿˜æ˜¯å®˜æ–¹çš„åœ°é“ï¼šRequests is an elegant and simple HTTP library for Python,built for human beings. å¤¸å¼ åˆ°æ˜¯äººç±»å°±ä¼šä½¿ç”¨ requests :)ã€‚æˆ‘ä»¬ä¸€èµ·é˜…è¯»ä¸€ä¸‹å…¶æºç ï¼Œå­¦ä¹ å®ƒæ˜¯å¦‚ä½•å®ç°çš„ã€‚

## é¡¹ç›®ç»“æ„
----

æœ¬æ¬¡é˜…è¯»ä»£ç ç‰ˆæœ¬æ˜¯ 2.24.0, ä» github ä¸Š clone é¡¹ç›®åï¼Œä½¿ç”¨ log å‘½ä»¤æŸ¥çœ‹å†å²ä¿¡æ¯ï¼Œæ‰¾åˆ° tag=2.24.0 çš„æ ‡ç­¾ï¼Œåˆ‡æ¢ç‰ˆæœ¬:
```shell
1.  git checkout 0797c61fd541f92f66e409dbf9515ca287af28d2
``` 

    

å¤§æ¦‚æµè§ˆä¸€ä¸‹é¡¹ç›®ç»“æ„å’Œä»£ç ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“æ¯ä¸ªæ¨¡å—çš„åŠŸèƒ½ï¼š

| åç§°           | æè¿°                        |
|--------------|---------------------------|
| adapters.py  | è´Ÿè´£ http è¿æ¥çš„å¤„ç†ï¼Œä¸»è¦é€‚é…è‡ª urllib3 åº“ |
| api          | api æ¥å£                     |
| auth         | http è®¤è¯                    |
| certs        | https è¯ä¹¦å¤„ç†                 |
| compat       | python ç‰ˆæœ¬é€‚é…åŒ…               |
| cookies      | cookie å¤„ç†                  |
| help         | å¸®åŠ©                        |
| hook         | é’©å­ç³»ç»Ÿ                      |
| models       | æ•°æ®æ¨¡å‹                      |
| packages     | å…¼å®¹åŒ…ç›¸å…³                     |
| sessions     | session å¤„ç†                 |
| status_codes | http çŠ¶æ€ç                    |
| structures   | æ•°æ®ç»“æ„                      |
| utils        | å·¥å…·                        |


4000 å¤šè¡Œä»£ç ï¼Œ10 å¤šä¸ªæ¨¡å—ï¼Œè¦å…¨éƒ¨æ¢³ç†å·¥ä½œé‡ä¸å°ï¼Œéš¾åº¦ä¹Ÿå¤§ã€‚æœ¬ç¯‡æ–‡ç« æˆ‘ä»¬è¿˜æ˜¯åªå…³æ³¨ä¸»çº¿ï¼Œå¯¹äºæ”¯çº¿å’Œç»†ææœ«èŠ‚å¯ä»¥ **ä¸æ±‚ç”šè§£** ã€‚

api æ¨¡å—
------

é¦–å…ˆè¿˜æ˜¯ä» requests çš„ä½¿ç”¨ç¤ºä¾‹å‡ºå‘ï¼š
shell
>>> r = requests.get('https://api.github.com/user', auth=('user', 'pass'))
    
>>> r.status_code
    
200
    
>>> r.headers['content-type']
    
'application/json; charset=utf8'
    
>>> r.encoding
    
'utf-8'
    
>>> r.text
    
'{"type":"User"...'
    
>>> r.json()
    
{'private_gists': 419, 'total_private_repos': 77, ...}
    

ä¸Šé¢çš„ä½¿ç”¨æ–¹æ³•ç”± api æä¾›:
```python
1.  # api.py
    
2.    
    
3.  def request(method, url, **kwargs)
    
4.      with sessions.Session() as session:
    
5.          return session.request(method=method, url=url, **kwargs)
    
6.    
    
7.  def get(url, params=None, **kwargs):
    
8.      kwargs.setdefault('allow_redirects', True)
    
9.      return request('get', url, params=params, **kwargs)
    
10.    
    
11.      ...
    
```
è¿™ç§ get-request çš„ api çš„å°è£…æ–¹å¼ï¼Œå’Œæˆ‘ä»¬ä¹‹å‰è¯»è¿‡çš„ redis æºç ç±»ä¼¼ï¼Œå¯ä»¥è®©ä½¿ç”¨è€…æ›´å®‰å…¨æ–¹ä¾¿ã€‚request å…·ä½“å®ç°ä»£ç æ˜¯ä» session ä¸Šä¸‹æ–‡è·å–ä¸€ä¸ª sessionï¼Œç„¶ååˆ©ç”¨ **session.request** å‘é€è¯·æ±‚ã€‚

åŒæ—¶ api ä¸­è¿˜åŒ…è£…äº† http çš„ OPTIONS, HEAD, POST, PUT, PATCH å’Œ DELETE æ–¹æ³•ã€‚

sessions
--------

sessions.py å¯¹è±¡çš„åˆ›å»ºå’Œä¸Šä¸‹æ–‡ï¼š
```python
1.  # sessions.py
    
2.    
    
3.  class Session(SessionRedirectMixin):
    
4.    
    
5.      def __init__(self):
    
6.          self.headers = default_headers()
    
7.          self.cookies = cookiejar_from_dict({})
    
8.    
    
9.          # Default connection adapters.
    
10.          self.adapters = OrderedDict()
    
11.          ...
    
12.          self.mount('https://', HTTPAdapter())
    
13.    
    
14.      def mount(self, prefix, adapter):
    
15.          self.adapters[prefix] = adapter
    
16.    
    
17.      def __enter__(self):
    
18.          return self
    
19.    
    
20.      def __exit__(self, *args):
    
21.          for v in self.adapters.values():
    
22.              v.close()
    
```
session åˆå§‹åŒ–æ—¶å€™ï¼Œä¼šåˆ›å»ºé»˜è®¤çš„ http-headerï¼Œhttp-cookie ä¿¡æ¯ï¼Œå»ºç«‹ HTTPAdpater å¯¹è±¡ã€‚`__enter__`å’Œ `__exit__`,æ˜¯ä¸Šä¸‹æ–‡è£…é¥°å™¨å‡½æ•°ï¼Œå¯ä»¥ç”¨æ¥ç¡®ä¿è¿›è¡Œ adapter çš„ closeã€‚

ä½¿ç”¨ request æ–¹æ³•å‘é€è¯·æ±‚:
```python
1.  def request(self, method, url,
    
2.          params=None, data=None, headers=None, cookies=None, files=None,
    
3.          auth=None, timeout=None, allow_redirects=True, proxies=None,
    
4.          hooks=None, stream=None, verify=None, cert=None, json=None):
    
5.      req = Request(
    
6.          method=method.upper(),
    
7.          url=url,
    
8.          headers=headers,
    
9.          files=files,
    
10.          data=data or {},
    
11.          json=json,
    
12.          params=params or {},
    
13.          auth=auth,
    
14.          cookies=cookies,
    
15.          hooks=hooks,
    
16.      )
    
17.      ...
    
18.      prep = PreparedRequest()
    
19.      prep.prepare(
    
20.          method=request.method.upper(),
    
21.          url=request.url,
    
22.          files=request.files,
    
23.          data=request.data,
    
24.          json=request.json,
    
25.          headers=merge_setting(request.headers, self.headers, dict_class=CaseInsensitiveDict),
    
26.          params=merge_setting(request.params, self.params),
    
27.          auth=merge_setting(auth, self.auth),
    
28.          cookies=merged_cookies,
    
29.          hooks=merge_hooks(request.hooks, self.hooks),
    
30.      )
    
31.      ...
    
32.      adapter = self.get_adapter(url=request.url)
    
33.      ...
    
34.      resp = adapter.send(prep, **send_kwargs)
    
35.      return resp
    
```
request å‡½æ•°çš„å¤„ç†æµç¨‹ï¼Œä¸»è¦åˆ†æˆå››æ­¥ï¼š

1.  ä½¿ç”¨è¯·æ±‚å‚æ•°å°è£… Request å¯¹è±¡
    
2.  ç”Ÿæˆ PreparedRequest å¯¹è±¡ï¼Œå¹¶å¯¹ request å¯¹è±¡è¿›è¡Œé¢„å…ˆå¤„ç†
    
3.  è·å–å¯¹åº”çš„ http/https åè®®é€‚é…å™¨ï¼Œå¹¶ç”¨å…¶ send æ–¹æ³•å‘é€è¯·æ±‚
    
4.  å°†è·å–çš„ Response å¯¹è±¡è¿”å›
    

models
------

åœ¨è¿›è¡Œè¯·æ±‚è¿‡ç¨‹ä¸­åˆ›å»ºäº† Requestï¼ŒPreparedRequest å¯¹è±¡ï¼ŒåŒæ—¶ä» adpater ä¸­è¿”å›äº† Response å¯¹è±¡,è¿™ 3 ä¸ªå¯¹è±¡çš„å…·ä½“å®ç°éƒ½åœ¨ models.py æ¨¡å—ã€‚
```python
1.  class Request(RequestHooksMixin):
    
2.    
    
3.      def __init__(self,
    
4.              method=None, url=None, headers=None, files=None, data=None,
    
5.              params=None, auth=None, cookies=None, hooks=None, json=None):
    
6.    
    
7.          ...
    
8.          self.hooks = default_hooks()
    
9.          for (k, v) in list(hooks.items()):
    
10.              self.register_hook(event=k, hook=v)
    
11.    
    
12.          self.method = method
    
13.          self.url = url
    
14.          self.headers = headers
    
15.          self.files = files
    
16.          self.data = data
    
17.          self.json = json
    
18.          self.params = params
    
19.          self.auth = auth
    
20.          self.cookies = cookies
    
21.          ...
    
```
Request å¯¹è±¡åˆ›å»ºæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯åšäº†ä¸€äº›å±æ€§çš„èµ‹å€¼ï¼Œç„¶åå¯¹å¤–éƒ¨æ³¨å…¥çš„ hook è¿›è¡Œäº†ä¸€ä¸‹æ ¡éªŒï¼Œç¡®ä¿æ˜¯å¯ä»¥æ‰§è¡Œçš„å‡½æ•°å’Œå‡½æ•°é›†åˆã€‚
```python
1.  def register_hook(self, event, hook):
    
2.      """Properly register a hook."""
    
3.    
    
4.      if event not in self.hooks:
    
5.          raise ValueError('Unsupported event specified, with event name "%s"' % (event))
    
6.    
    
7.      if isinstance(hook, Callable):  ## hook æ˜¯ä¸€ä¸ªå‡½æ•°
    
8.          self.hooks[event].append(hook)
    
9.      elif hasattr(hook, '__iter__'):  # hook ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªè¿­ä»£å™¨
    
10.          self.hooks[event].extend(h for h in hook if isinstance(h, Callable))
    
```
PreparedRequest å¯¹è±¡åˆ™å¯¹å¤–éƒ¨çš„å‚æ•°è¿›è¡Œæ›´å¤šçš„éªŒè¯å’Œå‡†å¤‡:
```python
1.  class PreparedRequest(RequestEncodingMixin, RequestHooksMixin):
    
2.    
    
3.      ...
    
4.    
    
5.      def prepare(self,
    
6.          method=None, url=None, headers=None, files=None, data=None,
    
7.          params=None, auth=None, cookies=None, hooks=None, json=None):
    
8.      """Prepares the entire request with the given parameters."""
    
9.    
    
10.          self.prepare_method(method)
    
11.          self.prepare_url(url, params)
    
12.          self.prepare_headers(headers)
    
13.          self.prepare_cookies(cookies)
    
14.          self.prepare_body(data, files, json)
    
15.          self.prepare_auth(auth, url)
    
16.    
    
17.          ...
    
18.          hooks = hooks or []
    
19.          for event in hooks:
    
20.              self.register_hook(event, hooks[event])
    
```
å¯ä»¥çœ‹åˆ° PreparedRequest å¯¹è±¡ç»è¿‡äº†ï¼š

*   å‡†å¤‡ http æ–¹æ³•
    
*   å‡†å¤‡ url
    
*   å‡†å¤‡ header
    
*   å‡†å¤‡ cookie
    
*   å‡†å¤‡ http-body
    
*   å‡†å¤‡è®¤è¯
    
*   æ¥å— Request å¯¹è±¡ä¸Šå¸¦æ¥çš„ hook
    

hook æˆ‘ä»¬æœ€åå†è¿›è¡Œè¯¦ç»†ä»‹ç»ï¼Œè¿™é‡Œä»¥ prepare\_headers ä¸ºä¾‹çœ‹çœ‹éªŒè¯è¿‡ç¨‹ä¸­éƒ½åšäº†ä»€ä¹ˆ:
```python
1.  def prepare_headers(self, headers):
    
2.      """Prepares the given HTTP headers."""
    
3.    
    
4.      self.headers = CaseInsensitiveDict()  # åˆ›å»ºå­—å…¸
    
5.      if headers:
    
6.          for header in headers.items():
    
7.              # Raise exception on invalid header value.
    
8.              check_header_validity(header) # éªŒè¯ä¿¡æ¯
    
9.              name, value = header
    
10.              self.headers[to_native_string(name)] = value  # èµ‹å€¼
    
```
Response å¯¹è±¡ï¼Œä¸»è¦æ¨¡æ‹Ÿæ–‡ä»¶æ“ä½œï¼Œraw ä¿ç•™äº†äºŒè¿›åˆ¶æ•°æ®æµï¼Œcontent å±æ€§æ˜¯è·å¾—æ‰€æœ‰äºŒè¿›åˆ¶æ•°æ®ï¼Œtext å±æ€§å°†äºŒè¿›åˆ¶æ•°æ®ç¼–ç æˆæ–‡æœ¬ï¼Œjson æ–¹æ³•åˆ™æ˜¯å°†æ–‡æœ¬åºåˆ—åŒ–æ–¹æ³•ã€‚
```python
1.  CONTENT_CHUNK_SIZE = 10 * 1024 # 10kæ•°æ®
    
2.    
    
3.  class Response(object):
    
4.    
    
5.      def __init__(self):
    
6.          #: File-like object representation of response (for advanced usage).
    
7.          #: Use of raw requires that stream=True be set on the request.
    
8.          #: This requirement does not apply for use internally to Requests.
    
9.          self.raw = None
    
10.    
    
11.      @property
    
12.      def content(self):
    
13.          """Content of the response, in bytes."""
    
14.          ...
    
15.          self._content = b''.join(self.iter_content(CONTENT_CHUNK_SIZE)) or b''
    
16.          ...
    
17.          return self._content
    
18.    
    
19.      @property
    
20.      def text(self):
    
21.          content = str(self.content, encoding, errors='replace')
    
22.          return content
    
23.    
    
24.      def json(self, **kwargs):
    
25.          ...
    
26.          return complexjson.loads(self.text, **kwargs) 
    
```
> requests ä¼˜å…ˆä½¿ç”¨ simplejson è¿›è¡Œ json çš„åºåˆ—åŒ–

iter_content å‡½æ•°ä¸­ä½¿ç”¨ä¸€ä¸ªç”Ÿæˆå™¨æ¥è¿­ä»£çš„ä»æµä¸­è·å–æ•°æ®ã€‚è‡³äºæµå¦‚ä½•å¾—åˆ°ï¼Œç¨åçœ‹ adapter çš„å®ç°ã€‚
```python
1.  def iter_content(self, chunk_size=1, decode_unicode=False):
    
2.      def generate():
    
3.              # Special case for urllib3.
    
4.              if hasattr(self.raw, 'stream'):
    
5.                  try:
    
6.                      for chunk in self.raw.stream(chunk_size, decode_content=True):
    
7.                          yield chunk
    
8.      stream_chunks = generate()
    
9.      return stream_chunks
    
```
adapters æ¨¡å—
-----------

å…·ä½“çš„ http è¯·æ±‚å¦‚ä½•å‘é€çš„å‘¢ï¼Ÿä¸»è¦å°±åœ¨ HTTPAdapter ä¸­äº†:
```python
1.  class HTTPAdapter(BaseAdapter):
    
2.      def __init__(self, pool_connections=DEFAULT_POOLSIZE,
    
3.                   pool_maxsize=DEFAULT_POOLSIZE, max_retries=DEFAULT_RETRIES,
    
4.                   pool_block=DEFAULT_POOLBLOCK):
    
5.          ...
    
6.          # åˆå§‹åŒ–è¿æ¥æ± 
    
7.          self.poolmanager = PoolManager(num_pools=connections, maxsize=maxsize,
    
8.                                         block=block, strict=True, **pool_kwargs)
    
9.    
    
10.      def send(self, request, stream=False, timeout=None, verify=True, cert=None, proxies=None):
    
11.          conn = self.poolmanager.connection_from_url(url) # è·å–è¿æ¥
    
12.    
    
13.          url = self.request_url(request, proxies)
    
14.          self.add_headers(request, stream=stream, timeout=timeout, verify=verify, cert=cert, proxies=proxies)
    
15.    
    
16.          # å‘é€è¯·æ±‚
    
17.          resp = conn.urlopen(
    
18.                      method=request.method,
    
19.                      url=url,
    
20.                      body=request.body,
    
21.                      headers=request.headers,
    
22.                      redirect=False,
    
23.                      assert_same_host=False,
    
24.                      preload_content=False,
    
25.                      decode_content=False,
    
26.                      retries=self.max_retries,
    
27.                      timeout=timeout
    
28.                  )
    
29.    
    
30.          return self.build_response(request, resp)
    
31.    
    
32.      def close(self):
    
33.          self.poolmanager.clear()  # è¿æ¥æ± å…³é—­
    
```
è¿™é‡Œä¸»è¦ç”¨äº†`urllib3`åº“æä¾›çš„ PoolManager å’Œ urlopenï¼Œæœ¬ç¯‡æ–‡ç« æˆ‘ä»¬å°±ä¸æ·±å…¥é‡Œé¢çš„å®ç°äº†ï¼Œé‡ç‚¹çœ‹çœ‹å¦‚ä½•ç”Ÿæˆ Response å¯¹è±¡:
```python
1.  def build_response(self, req, resp):
    
2.      response = Response()
    
3.    
    
4.      # Fallback to None if there's no status_code, for whatever reason.
    
5.      response.status_code = getattr(resp, 'status', None)
    
6.    
    
7.      # Make headers case-insensitive.
    
8.      response.headers = CaseInsensitiveDict(getattr(resp, 'headers', {}))
    
9.    
    
10.      # Set encoding.
    
11.      response.encoding = get_encoding_from_headers(response.headers)
    
12.      response.raw = resp  # äºŒè¿›åˆ¶æµ
    
13.      response.reason = response.raw.reason
    
14.    
    
15.      if isinstance(req.url, bytes):
    
16.          response.url = req.url.decode('utf-8')
    
17.      else:
    
18.          response.url = req.url
    
19.    
    
20.      # Add new cookies from the server.
    
21.      extract_cookies_to_jar(response.cookies, req, resp)
    
22.    
    
23.      # Give the Response some context.
    
24.      response.request = req
    
25.      response.connection = self
    
26.    
    
27.      return response
```

*   resp æ˜¯ urllib3 çš„ HTTPResponse å®ç°
    
*   cookie æ˜¯åˆå¹¶äº† Request å’Œ Response
    
*   Response è¿˜å¼•ç”¨äº† PreparedRequest å¯¹è±¡ï¼Œå¯ä»¥è®© response çš„ä½¿ç”¨æ›´æ–¹ä¾¿
    

ä½¿ç”¨ requests è¿›è¡Œ http è¯·æ±‚çš„è¿‡ç¨‹ï¼Œä¸»è¦é›†ä¸­åœ¨ä¸Šé¢å››ä¸ªæ¨¡å—ï¼Œç°åœ¨å¯¹å…¶æ ¸å¿ƒè¿‡ç¨‹éƒ½æœ‰äº†ä¸€å®šçš„äº†è§£ã€‚https åˆ™æ˜¯åœ¨ http åŸºç¡€ä¸Šï¼Œåšäº†æ›´å¤šçš„éªŒè¯ç­‰å·¥ä½œã€‚å¯ä»¥ç®€å•å›é¡¾ä¸€ä¸‹è¯·æ±‚æ‰§è¡Œæµç¨‹ï¼š

1.  api ä¸­å°è£…æ˜“ç”¨çš„ API
    
2.  Session ä¸­è¿›è¡Œæµç¨‹çš„å¤„ç†
    
3.  Request å’Œ PreparedRequest å¯¹è¯·æ±‚è¿›è¡Œé¢„å¤„ç†
    
4.  Response å¯¹å“åº”è¿›è¡Œå°è£…ï¼Œæä¾›æ›´æ˜“ç”¨çš„æ–¹æ³•(json)å’Œæ•°æ®(ok)
    
å°æŠ€å·§
---

requests åº“ä¸­è¿˜æœ‰ä¸€äº›ä»£ç ï¼Œä¹Ÿè®©ä½¿ç”¨æ›´ç®€å•ï¼Œå¯ä»¥å€Ÿé‰´ã€‚

### json ç¼©è¿›è¾“å‡º

json è¾“å‡ºçš„æ—¶å€™å®šä¹‰ indent å‚æ•°å¯ä»¥è¿›è¡Œç¼©è¿›ï¼Œ`sort_keys`å¯ä»¥è¿›è¡Œæ’åºã€‚
```python
1.  # help.py
    
2.    
    
3.  """Pretty-print the bug information as JSON."""
    
4.  print(json.dumps(info(), sort_keys=True, indent=2))
```

ä¸‹é¢æ˜¯ç¤ºä¾‹å’Œå±•ç¤º:
```python
1.  a = {
    
2.          "name": "game404",
    
3.          "age": 2
    
4.      }
    
5.  print(json.dumps(a)) 
    
6.  print(json.dumps(a, sort_keys=True, indent=2))  # å®šä¹‰indentå‚æ•°
    
7.  # è¾“å‡º
    
8.  {"name": "game404", "age": 2}
    
9.  {
    
10.    "age": 2,
    
11.    "name": "game404"
    
12.  }
```
    

### structures

structures æ¨¡å—ä¸­å®šä¹‰äº† 2 ä¸ªæ•°æ®ç»“æ„ã€‚æ™®é€šçš„ python å­—å…¸ä¸å¯ä»¥ä½¿ç”¨ . å–å€¼, å¦‚æœéœ€è¦ä½¿ç”¨ . éœ€è¦å®šä¹‰å¯¹è±¡:
```python
1.  # structures.py
    
2.    
    
3.  a = {
    
4.      "name":"game404"
    
5.  }
    
6.  # print(a.name)  # AttributeError
    
7.  print(a["name"])
    
8.    
    
9.  # å®šä¹‰ä¸€ä¸ªæ•°æ®ç»“æ„å¯¹è±¡
    
10.  class Person(object):
    
11.    
    
12.      def __init__(self, name):
    
13.          self.name = name
```

LookupDict å¯ä»¥ä¸ç”¨å®šä¹‰å¯¹è±¡å±æ€§åˆä½¿ç”¨ . å–å€¼ï¼Œè¿™åœ¨ä¸€äº›é…ç½®ç±»ä¸Šä¼šå¾ˆæ–¹ä¾¿:
```python
1.  class LookupDict(dict):
    
2.      """Dictionary lookup object."""
    
3.    
    
4.      def __init__(self, name=None):
    
5.          self.name = name
    
6.          super(LookupDict, self).__init__()
    
7.    
    
8.      def __repr__(self):
    
9.          return '<lookup \'%s\'>' % (self.name)
    
10.    
    
11.      def __getitem__(self, key):
    
12.          # We allow fall-through here, so values default to None
    
13.          # å¯ä»¥ä½¿ç”¨. å–å€¼çš„é­”æ³•å‡½æ•°
    
14.          return self.__dict__.get(key, None)
    
15.    
    
16.      def get(self, key, default=None):
    
17.          return self.__dict__.get(key, default
    
18.    
    
19.  a = LookupDict(name="game404")
    
20.  a["motto"] = "Life is short, you need Python"
    
21.  a.age = 2
    
22.  print(a["motto"], a.age, a["age"])  # none, 2, 2
```

CaseInsensitiveDict å®šä¹‰äº†å¤§å°å†™ä¸æ•æ„Ÿçš„å­—å…¸ï¼Œç”¨æ¥å¤„ç† http-headerï¼š
```python
1.  class CaseInsensitiveDict(MutableMapping):
    
2.    
    
3.      def __init__(self, data=None, **kwargs):
    
4.          self._store = OrderedDict()  # ä½¿ç”¨é¢å¤–çš„_storeå­˜å‚¨æ•°æ®
    
5.          if data is None:
    
6.              data = {}
    
7.          self.update(data, **kwargs)
    
8.    
    
9.      def __setitem__(self, key, value):
    
10.          # Use the lowercased key for lookups, but store the actual
    
11.          # key alongside the value.
    
12.          self._store[key.lower()] = (key, value)  # å­—å…¸çš„keyéƒ½è½¬æ¢ä¸ºå°å†™
    
13.    
    
14.      def __delitem__(self, key):
    
15.          del self._store[key.lower()]
    
16.    
    
17.  cid = CaseInsensitiveDict()
    
18.  cid['Accept'] = 'application/json'
    
19.  print(cid['aCCEPT'] == 'application/json')  # True
    
```
å¯ä»¥çœ‹åˆ° CaseInsensitiveDict å¯¹è±¡çš„**dict**å®é™…ä¸Šä½¿ç”¨\_store åŒ…è£…äº†ä¸€å±‚:

1.  print(cid.__dict__)  # {'_store': OrderedDict([('accept', ('Accept', 'application/json'))])}
    
2.  print(cid._store)  # OrderedDict([('accept', ('Accept', 'application/json'))])
    

### status\_codes

status\_codes ä¸­å®šä¹‰äº† http çŠ¶æ€ç çš„è¯­ä¹‰åŒ–åç§°ï¼Œæ¯”å¦‚ OK æ˜¯ 200 çš„è¯­ä¹‰åŒ–è¡¨è¾¾ï¼Œä¸æ‡‚ http çš„äººä¹Ÿå¯ä»¥çœ‹åˆ° ok çŠ¶æ€ã€‚
```python
1.  print(requests.codes["ok"], requests.codes.OK, requests.codes.ok, requests.codes.OKAY)  #200 200 200 200
    
2.  print(requests.codes.CREATED)  # 201
    
3.  print(requests.codes.found)  # 302
    
```
å…¶å®ç°æ–¹æ³•ä¸»è¦æ˜¯:
```python
1.  # statuc_codes.py
    
2.    
    
3.  codes = LookupDict(name='status_codes')
    
4.  for code, titles in _codes.items():
    
5.          for title in titles:
    
6.              setattr(codes, title, code)  # é»˜è®¤key
    
7.              if not title.startswith(('\\', '/')):
    
8.                  setattr(codes, title.upper(), code)  # å¤§å†™key
```

### hook

hooks æä¾›äº†ä¸€ä¸ªç®€å•çš„é’©å­ç³»ç»Ÿï¼Œå¯ä»¥å¯¹ä¸€ä¸ªäº‹ä»¶åç§°æ³¨å†Œå¤šä¸ªå¤„ç†å‡½æ•°ï¼ˆå‰é¢çš„ register\_hookï¼‰ï¼Œç„¶ååœ¨åˆé€‚çš„æ—¶å€™è§¦å‘å°±å¯ä»¥è·å–å¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼Œ æ•°æ®å¤„ç†è¿‡ç¨‹ç±»ä¼¼ linux çš„ç®¡é“ç¬¦å· | :
```python
1.  # hooks.py
    
2.    
    
3.  HOOKS = ['response']
    
4.    
    
5.    
    
6.  def default_hooks():  # åˆå§‹åŒ–é»˜è®¤çš„äº‹ä»¶
    
7.      return {event: [] for event in HOOKS}
    
8.    
    
9.  def dispatch_hook(key, hooks, hook_data, **kwargs):
    
10.      """Dispatches a hook dictionary on a given piece of data."""
    
11.      hooks = hooks or {}
    
12.      hooks = hooks.get(key)
    
13.      if hooks:
    
14.          if hasattr(hooks, '__call__'):  # åˆ¤æ–­æ˜¯å‡½æ•°è¿˜æ˜¯å‡½æ•°é›†åˆ
    
15.              hooks = [hooks]
    
16.          for hook in hooks:
    
17.              _hook_data = hook(hook_data, **kwargs)  # æ³¨æ„hookä¼šè¿”å›æ•°æ®ï¼Œç”±ä¸‹ä¸€ä¸ªå‡½æ•°ç»§ç»­å¤„ç†
    
18.              if _hook_data is not None:
    
19.                  hook_data = _hook_data
    
20.      return hook_data
```

ä½¿ç”¨æ–¹æ³•åœ¨:
```python
1.  class Session(SessionRedirectMixin):
    
2.    
    
3.      def send(self, request, **kwargs):
    
4.          ...
    
5.          r = adapter.send(request, **kwargs)
    
6.          # Response manipulation hooks
    
7.          r = dispatch_hook('response', hooks, r, **kwargs)
``` 

session åœ¨è·å–åˆ°è¯·æ±‚åï¼Œè§¦å‘é¢„å…ˆå®šä¹‰çš„é’©å­ï¼Œå¯¹ response è¿›è¡Œè¿›ä¸€æ­¥çš„å¤„ç†ã€‚

å‚è€ƒé“¾æ¥
----

*   https://requests.readthedocs.io/zh\_CN/latest/
    
*   https://urllib3.readthedocs.io/en/latest/
    
*   https://gist.github.com/kennethreitz42/973705