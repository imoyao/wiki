---
title: å…³äº Python é—­åŒ…ç†è§£

tags: 
  - Python
  - é—­åŒ…
categories: 
  - ğŸ’»å·¥ä½œ
  - ğŸPython
  - é«˜é˜¶çŸ¥è¯†ç‚¹
date: 2020-08-06 12:27:56
permalink: /python/closure/
---
## å‰è¨€

é—­åŒ…è¿™ä¸ªæ¦‚å¿µåœ¨ JavaScript ä¸­è®¨è®ºå’Œä½¿ç”¨å¾—æ¯”è¾ƒå¤šï¼Œä¸è¿‡åœ¨ Python ä¸­å´ä¸æ˜¯é‚£ä¹ˆæ˜¾è€Œæ˜“è§ï¼Œä¹‹æ‰€ä»¥è¯´â€œä¸æ˜¯é‚£ä¹ˆâ€ï¼Œæ˜¯å› ä¸ºå³ä½¿ç”¨åˆ°äº†ï¼Œä¹Ÿæ²¡æœ‰æ³¨æ„åˆ°è€Œå·²ï¼Œæ¯”å¦‚å®šä¹‰ä¸€ä¸ª Decorator æ—¶ï¼Œå°±å·²ç»ç”¨åˆ°é—­åŒ…äº†ã€‚ç½‘ä¸Šå¯¹é—­åŒ…çš„å„ç§è§£é‡Šï¼Œæ„Ÿè§‰éå¸¸æ™¦æ¶©ï¼Œåœ¨è¿™é‡Œè°ˆè°ˆæˆ‘çš„æµ…æ˜¾è®¤è¯†ï¼šè¦å½¢æˆé—­åŒ…ï¼Œé¦–å…ˆå¾—æœ‰ä¸€ä¸ªåµŒå¥—çš„å‡½æ•°ï¼Œå³å‡½æ•°å†…éƒ¨å®šä¹‰äº†å¦ä¸€ä¸ªå‡½æ•°ï¼Œé—­åŒ…åˆ™æ˜¯ä¸€ä¸ªé›†åˆï¼Œå®ƒåŒ…æ‹¬äº†å¤–éƒ¨å‡½æ•°çš„å±€éƒ¨å˜é‡ï¼Œè¿™äº›å±€éƒ¨å˜é‡åœ¨å¤–éƒ¨å‡½æ•°è¿”å›åä¹Ÿç»§ç»­å­˜åœ¨ï¼Œå¹¶èƒ½è¢«å†…éƒ¨å‡½æ•°å¼•ç”¨ã€‚

## ä»£ç ç¤ºä¾‹

è¿™æ˜¯ä¸ªç»å¸¸ä½¿ç”¨åˆ°çš„ä¾‹å­ï¼Œå®šä¹‰ä¸€ä¸ªå‡½æ•° `generate_power_func`ï¼Œå®ƒè¿”å›å¦ä¸€ä¸ªå‡½æ•°ï¼Œç°åœ¨é—­åŒ…å½¢æˆçš„æ¡ä»¶å·²ç»è¾¾åˆ°ã€‚

```python
def generate_power_func(n):
    print("id(n): %X" % id(n))
    def nth_power(x):
        return x**n
    print("id(nth_power): %X" % id(nth_power))
    return nth_power
```

å¯¹äºå†…éƒ¨å‡½æ•° `nth_power`ï¼Œå³ä½¿ `generate_power_func` å·²ç»è¿”å›ï¼Œå®ƒè¿˜æ˜¯èƒ½å¼•ç”¨åˆ°å¤–éƒ¨å‡½æ•°çš„å±€éƒ¨å˜é‡ `n`ï¼Œè¿™ç§ç°è±¡å°±ç§°ä¸ºé—­åŒ…ã€‚å…·ä½“è¿è¡Œä¸€ä¸‹ï¼š

```python
>>> raised_to_4 = generate_power_func(4)
id(n): 246F770
id(nth_power): 2C090C8
>>> repr(raised_to_4)
'<function nth_power at 0x2c090c8>'
```

ä»ç»“æœå¯ä»¥çœ‹å‡ºï¼Œå½“ `generate_power_func(4)` æ‰§è¡Œå, åˆ›å»ºå¹¶è¿”å›äº† `nth_power` è¿™ä¸ªå‡½æ•°å¯¹è±¡ï¼Œå†…å­˜åœ°å€æ˜¯ 0x2C090C8,å¹¶ä¸”å‘ç° `raised_to_4` å’Œå®ƒçš„å†…å­˜åœ°å€ç›¸åŒï¼Œå³ `raised_to_4` åªæ˜¯è¿™ä¸ªå‡½æ•°å¯¹è±¡çš„ä¸€ä¸ªå¼•ç”¨ã€‚å…ˆåœ¨å…¨å±€å‘½åç©ºé—´ä¸­åˆ é™¤ `generate_power_func`ï¼Œå†è¯•è¯•ä¼šå‡ºç°ä»€ä¹ˆç»“æœã€‚

```plain
>>> del generate_power_func
>>> raised_to_4(2)
16
```

å•Šå“ˆï¼Œå±…ç„¶æ²¡å‡ºç°é”™è¯¯ï¼Œ `nth_power` æ˜¯æ€ä¹ˆçŸ¥é“ `n` çš„å€¼æ˜¯ 4ï¼Œè€Œä¸”ç°åœ¨ `generate_power_func` ç”šè‡³éƒ½ä¸åœ¨è¿™ä¸ªå‘½åç©ºé—´äº†ã€‚å¯¹ï¼Œè¿™å°±æ˜¯é—­åŒ…çš„ä½œç”¨ï¼šå¤–éƒ¨å‡½æ•°çš„å±€éƒ¨å˜é‡å¯ä»¥è¢«å†…éƒ¨å‡½æ•°å¼•ç”¨ï¼Œå³ä½¿å¤–éƒ¨å‡½æ•°å·²ç»è¿”å›äº†ã€‚

## å®šä¹‰

:::tip INFO
åµŒå¥—å®šä¹‰åœ¨éå…¨å±€ä½œç”¨åŸŸä¸­çš„å‡½æ•°ï¼Œå½“å®ƒçš„å¤–éƒ¨å‡½æ•°è¢«è°ƒç”¨å°±ä¼šç”Ÿæˆä¸€ä¸ªé—­åŒ…ã€‚é—­åŒ…ä¸­åŒ…å«äº†è¿™ä¸ªå­å‡½æ•°æœ¬èº«çš„ä»£ç ä¸å…¶ä¾èµ–çš„å¤–éƒ¨å˜é‡çš„å¼•ç”¨ã€‚
:::

## `__closure__` å±æ€§å’Œ cell å¯¹è±¡

ç°åœ¨çŸ¥é“é—­åŒ…æ˜¯æ€ä¹ˆä¸€å›äº‹äº†ï¼Œé‚£å°±åˆ°çœ‹çœ‹é—­åŒ…åˆ°åº•æ˜¯æ€ä¹ˆå›äº‹çš„æ—¶å€™äº†ã€‚Python ä¸­å‡½æ•°ä¹Ÿæ˜¯å¯¹è±¡ï¼Œæ‰€ä»¥å‡½æ•°ä¹Ÿæœ‰å¾ˆå¤šå±æ€§ï¼Œå’Œé—­åŒ…ç›¸å…³çš„å°±æ˜¯ `__closure__` å±æ€§ã€‚`__closure__` å±æ€§å®šä¹‰çš„æ˜¯ä¸€ä¸ªåŒ…å« cell å¯¹è±¡çš„å…ƒç»„ï¼Œå…¶ä¸­å…ƒç»„ä¸­çš„æ¯ä¸€ä¸ª cell å¯¹è±¡ç”¨æ¥ä¿å­˜ä½œç”¨åŸŸä¸­å˜é‡çš„å€¼ã€‚

```python
>>> raised_to_4.__closure__
(<cell at 0x2bf4ec0: int object at 0x246f770>,)
>>> type(raised_to_4.__closure__[0])
<type 'cell'>
>>> raised_to_4.__closure__[0].cell_contents
4
```

å°±å¦‚åˆšæ‰æ‰€è¯´ï¼Œåœ¨ `raised_to_4` çš„ `__closure__` å±æ€§ä¸­æœ‰å¤–éƒ¨å‡½æ•°å˜é‡ `n` çš„å¼•ç”¨ï¼Œé€šè¿‡å†…å­˜åœ°å€å¯ä»¥å‘ç°ï¼Œå¼•ç”¨çš„éƒ½æ˜¯åŒä¸€ä¸ª `n`ã€‚å¦‚æœæ²¡æœ‰å½¢æˆé—­åŒ…ï¼Œåˆ™ `__closure__` å±æ€§ä¸º `None`ã€‚å¯¹äº Python å…·ä½“æ˜¯å¦‚ä½•å®ç°é—­åŒ…çš„ï¼Œå¯ä»¥æŸ¥çœ‹ [Python é—­åŒ…è¯¦è§£](http://www.cnblogs.com/ChrisChen3121/p/3208119.html)ï¼Œå®ƒé€šè¿‡åˆ†æ Python å­—èŠ‚ç æ¥è®²è¿°é—­åŒ…çš„å®ç°ã€‚

## æ€»ç»“

[é¢è¯•é¢˜ï¼šä¸ºä»€ä¹ˆè¦ç”¨é—­åŒ…ï¼Ÿ - SegmentFault æ€å¦](https://segmentfault.com/q/1010000007578832)

æ–¹ä¾¿ç”¨æˆ·è°ƒç”¨å‡½æ•°ã€‚ä¸å¿…ä¸ºäº†ç»´æŠ¤ç¹æ‚çš„å¤–éƒ¨çŠ¶æ€è€Œçƒ¦æ¼ã€‚

ä¾‹å¦‚ pythonï¼Œå°±æŠŠé—­åŒ…ç©å‡ºäº†å¾ˆå¤šèŠ±æ ·ï¼š

- é™æ€ç§æœ‰å˜é‡
- åå‡½æ•°
- å•å‚åŒ–
- è£…é¥°å™¨

é—­åŒ…ç‰¹æ€§æœ‰ç€éå¸¸å¤šçš„ä½œç”¨ï¼Œä¸è¿‡éƒ½æ˜¯éœ€è¦æ—¶æ‰ä¼šä¸ç»æ„çš„ç”¨ä¸Šï¼Œä¸è¦åƒä½¿ç”¨è®¾è®¡æ¨¡å¼ä¸€æ ·å»ç¡¬å¥—è¿™äº›æ³•åˆ™ã€‚è¿™ç¯‡æ–‡ç« æŒ‰ç…§è‡ªå·±çš„ç†è§£ç¿»è¯‘è‡ª [Python Closures Explained](http://www.shutupandship.com/2012/01/python-closures-explained.html)ï¼Œå¯èƒ½å’ŒåŸæ–‡æœ‰äº›ä¸åŒä¹‹å¤„ï¼Œå¦‚æœ‰ç–‘æƒ‘ï¼Œè¯·æŸ¥çœ‹åŸæ–‡ã€‚

é™„ä¸Šä¸€äº›å‚è€ƒèµ„æ–™ã€‚

## å‚è€ƒé“¾æ¥

- [æµ…æ˜¾ç†è§£ Python é—­åŒ… - I'm SErHo](https://serholiu.com/python-closures)
- [é—­åŒ…çš„æ¦‚å¿µã€å½¢å¼ä¸åº”ç”¨](http://www.ibm.com/developerworks/cn/linux/l-cn-closure/): å¯ä»¥ä»å…¶ä¸­äº†è§£é—­åŒ…çš„åº”ç”¨
- [Python é—­åŒ…è¯¦è§£](http://www.cnblogs.com/ChrisChen3121/p/3208119.html)ï¼šä»å­—èŠ‚ç å‡ºå‘äº†è§£ Python é—­åŒ…çš„å®ç°æœºåˆ¶
- [ç†è§£ Python é—­åŒ…æ¦‚å¿µ - alpha_panda - åšå®¢å›­](https://www.cnblogs.com/yssjun/p/9887239.html)
- [ç†è§£ Javascript çš„é—­åŒ…](http://coolshell.cn/articles/6731.html): ä» Javascript çš„é—­åŒ…ä¸­äº†è§£ä¸€äº›é—­åŒ…ç‰¹æ€§ï¼Œå¯ä»¥å’Œ Python ä½œä¸‹å¯¹æ¯”
- [Why aren't python nested functions called closures? - StackOverflow](https://stackoverflow.com/questions/4020419/why-arent-python-nested-functions-called-closures)

## åŸæ–‡é“¾æ¥

[æµ…æ˜¾ç†è§£ Python é—­åŒ… - I'm SErHo](https://serholiu.com/python-closures)
