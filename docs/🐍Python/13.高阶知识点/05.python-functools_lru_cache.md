---
title: Python ç¼“å­˜æœºåˆ¶ä¸ functools.lru_cache
tags: 
  - ç¼“å­˜
  - Python
  - functools.lru_cache
categories: 
  - ğŸ’» å·¥ä½œ
  - ğŸPython
  - é«˜é˜¶çŸ¥è¯†ç‚¹
date: 2020-08-29 12:27:56
permalink: /python/lru_cache/
---

ç¼“å­˜æ˜¯ä¸€ç§å°†å®šé‡æ•°æ®åŠ ä»¥ä¿å­˜ä»¥å¤‡è¿åˆåç»­è·å–éœ€æ±‚çš„å¤„ç†æ–¹å¼ï¼Œæ—¨åœ¨åŠ å¿«æ•°æ®è·å–çš„é€Ÿåº¦ã€‚æ•°æ®çš„ç”Ÿæˆè¿‡ç¨‹å¯èƒ½éœ€è¦ç»è¿‡è®¡ç®—ï¼Œè§„æ•´ï¼Œè¿œç¨‹è·å–ç­‰æ“ä½œï¼Œå¦‚æœæ˜¯åŒä¸€ä»½æ•°æ®éœ€è¦å¤šæ¬¡ä½¿ç”¨ï¼Œæ¯æ¬¡éƒ½é‡æ–°ç”Ÿæˆä¼šå¤§å¤§æµªè´¹æ—¶é—´ã€‚æ‰€ä»¥ï¼Œå¦‚æœå°†è®¡ç®—æˆ–è€…è¿œç¨‹è¯·æ±‚ç­‰æ“ä½œè·å¾—çš„æ•°æ®ç¼“å­˜ä¸‹æ¥ï¼Œä¼šåŠ å¿«åç»­çš„æ•°æ®è·å–éœ€æ±‚ã€‚

å…ˆæ¥ä¸€ä¸ªç®€å•çš„ä¾‹å­ä»¥äº†è§£ç¼“å­˜æœºåˆ¶çš„æ¦‚å¿µï¼š
```python
    # -*- coding: utf-8 -*-
    
    import random
    import datetime
    
    
    class MyCache:
        """ç¼“å­˜ç±»"""
    
        def __init__(self):
            # ç”¨å­—å…¸ç»“æ„ä»¥ kv çš„å½¢å¼ç¼“å­˜æ•°æ®
            self.cache = {}
            # é™åˆ¶ç¼“å­˜çš„å¤§å°ï¼Œå› ä¸ºç¼“å­˜çš„ç©ºé—´æœ‰é™
            # æ‰€ä»¥å½“ç¼“å­˜å¤ªå¤§æ—¶ï¼Œéœ€è¦å°†æ—§çš„ç¼“å­˜èˆå¼ƒæ‰
            self.max_cache_size = 10
    
        def __contains__(self, key):
            """æ ¹æ®è¯¥é”®æ˜¯å¦å­˜åœ¨äºç¼“å­˜å½“ä¸­è¿”å› True æˆ–è€… False
            ä½¿ç”¨ï¼š >>> key in obj
                  >>> True / False
            å‚è§ï¼š[python - What does __contains__ do, what can call __contains__ function - Stack Overflow](https://stackoverflow.com/questions/1964934/what-does-contains-do-what-can-call-contains-function)
            """
            return key in self.cache
    
        def get(self, key):
            """ä»ç¼“å­˜ä¸­è·å–æ•°æ®"""
            data = self.cache[key]
            data["date_accessed"] = datetime.datetime.now()
            return data["value"]
    
        def add(self, key, value):
            """æ›´æ–°è¯¥ç¼“å­˜å­—å…¸ï¼Œå¦‚æœç¼“å­˜å¤ªå¤§åˆ™å…ˆåˆ é™¤æœ€æ—©æ¡ç›®"""
            if key not in self.cache and len(self.cache) >= self.max_cache_size:
                self.remove_oldest() 
            self.cache[key] = {
                'date_accessed': datetime.datetime.now(),
                'value': value
            }
    
        def remove_oldest(self):
            """åˆ é™¤å…·å¤‡æœ€æ—©è®¿é—®æ—¥æœŸçš„è¾“å…¥æ•°æ®"""
            oldest_entry = None
    
            for key in self.cache:
                if oldest_entry is None:
                    oldest_entry = key
                    continue
                # è·å–æ—¥æœŸ
                curr_entry_date = self.cache[key]['date_accessed']
                oldest_entry_date = self.cache[oldest_entry]['date_accessed']
                # æ‰¾åˆ°æ—¥æœŸæœ€å°å€¼ï¼ˆæœ€æ—©ï¼‰
                if curr_entry_date < oldest_entry_date:
                    oldest_entry = key
            # ç§»é™¤
            self.cache.pop(oldest_entry)
    
        @property
        def size(self):
            """è¿”å›ç¼“å­˜å®¹é‡å¤§å°"""
            return len(self.cache)
    
    
    if __name__ == '__main__':
        # æµ‹è¯•ç¼“å­˜åŠŸèƒ½
        cache = MyCache()
        cache.add("test", sum(range(100000)))
        assert cache.get("test") == cache.get("test")
    
        keys = [
            'red', 'fox', 'fence', 'junk', 'other', 'alpha', 'bravo', 'cal',
            'devo', 'ele'
        ]
        s = 'abcdefghijklmnop'
        for i, key in enumerate(keys):
            if key in cache:
                continue
            else:
                value = ''.join([random.choice(s) for i in range(20)])
                cache.add(key, value)
    
        assert "test" not in cache
        print(cache.cache)
    
```
ä»¥ä¸Šç¤ºä¾‹ä»…ç®€å•çš„å±•ç¤ºäº†ç¼“å­˜æœºåˆ¶çš„åŸç†ï¼Œé€šè¿‡ç”¨é”®å€¼å¯¹çš„æ–¹å¼å°†æ•°æ®æ”¾åˆ°å­—å…¸ä¸­ï¼Œå¦‚æœä¸‹æ¬¡éœ€è¦å–å€¼æ—¶å¯ä»¥ç›´æ¥åˆ°å­—å…¸ä¸­è·å–ã€‚è¯¥ç¤ºä¾‹åœ¨åˆ é™¤æ—§æ•°æ®æ—¶çš„å®ç°å¹¶ä¸é«˜æ•ˆï¼Œå®é™…åº”ç”¨ä¸­å¯ä»¥ç”¨åˆ«çš„æ–¹å¼å®ç°ã€‚

åœ¨ Python çš„ 3.2 ç‰ˆæœ¬ä¸­ï¼Œå¼•å…¥äº†ä¸€ä¸ªéå¸¸ä¼˜é›…çš„ç¼“å­˜æœºåˆ¶ï¼Œå³ `functool` æ¨¡å—ä¸­çš„ `lru_cache` è£…é¥°å™¨ï¼Œå¯ä»¥ç›´æ¥å°†å‡½æ•°æˆ–ç±»æ–¹æ³•çš„ç»“æœç¼“å­˜ä½ï¼Œåç»­è°ƒç”¨åˆ™ç›´æ¥è¿”å›ç¼“å­˜çš„ç»“æœã€‚`lru_cache` åŸå‹å¦‚ä¸‹ï¼š
```python
> @functools.lru\_cache(maxsize=None, typed=False)
```
ä½¿ç”¨ functools æ¨¡å—çš„ lur\_cache è£…é¥°å™¨ï¼Œå¯ä»¥ç¼“å­˜æœ€å¤š maxsize ä¸ªæ­¤å‡½æ•°çš„è°ƒç”¨ç»“æœï¼Œä»è€Œæé«˜ç¨‹åºæ‰§è¡Œçš„æ•ˆç‡ï¼Œç‰¹åˆ«é€‚åˆäºè€—æ—¶çš„å‡½æ•°ã€‚å‚æ•° `maxsize` ä¸ºæœ€å¤šç¼“å­˜çš„æ¬¡æ•°ï¼Œå¦‚æœä¸º Noneï¼Œåˆ™æ— é™åˆ¶ï¼Œè®¾ç½®ä¸º 2 çš„å¹‚ æ—¶ï¼Œæ€§èƒ½æœ€ä½³ï¼›å¦‚æœ `typed=True`ï¼ˆæ³¨æ„ï¼Œåœ¨ functools32 ä¸­æ²¡æœ‰æ­¤å‚æ•°ï¼‰ï¼Œåˆ™ä¸åŒå‚æ•°ç±»å‹çš„è°ƒç”¨å°†åˆ†åˆ«ç¼“å­˜ï¼Œä¾‹å¦‚ f(3) å’Œ f(3.0)ã€‚

**LRU (Least Recently Usedï¼Œæœ€è¿‘æœ€å°‘ä½¿ç”¨)** ç®—æ³•æ˜¯ä¸€ç§ç¼“å­˜æ·˜æ±°ç­–ç•¥ã€‚å…¶æ ¹æ®æ•°æ®çš„å†å²è®¿é—®è®°å½•æ¥è¿›è¡Œæ·˜æ±°ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œâ€œå¦‚æœæ•°æ®æœ€è¿‘è¢«è®¿é—®è¿‡ï¼Œé‚£ä¹ˆå°†æ¥è¢«è®¿é—®çš„å‡ ç‡ä¹Ÿæ›´é«˜â€ã€‚è¯¥ç®—æ³•æœ€åˆä¸ºæ“ä½œç³»ç»Ÿä¸­ä¸€ç§å†…å­˜ç®¡ç†çš„é¡µé¢ç½®æ¢ç®—æ³•ï¼Œä¸»è¦ç”¨äºæ‰¾å‡ºå†…å­˜ä¸­è¾ƒä¹…æ—¶é—´æ²¡æœ‰ä½¿ç”¨çš„å†…å­˜å—ï¼Œå°†å…¶ç§»å‡ºå†…å­˜ä»è€Œä¸ºæ–°æ•°æ®æä¾›ç©ºé—´ã€‚å…¶åŸç†å°±å¦‚ä»¥ä¸Šçš„ç®€å•ç¤ºä¾‹ã€‚

è¢« `lru_cache` è£…é¥°çš„å‡½æ•°ä¼šæœ‰ `cache_clear` å’Œ `cache_info` ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«ç”¨äºæ¸…é™¤ç¼“å­˜å’ŒæŸ¥çœ‹ç¼“å­˜ä¿¡æ¯ã€‚ä»¥ä¸‹ä¸ºä¸€ä¸ªç®€å•çš„ lru\_cache çš„ä½¿ç”¨æ•ˆæœï¼š
```python
    from functools import lru_cache
    
    @lru_cache(None)
    def add(x, y):
        print("calculating: %s + %s" % (x, y))
        return x + y
    
    print(add(1, 2))
    print(add(1, 2))
    print(add(2, 3))
    
```
è¾“å‡ºç»“æœï¼š
```plain
calculating: 1 + 2
3
3
calculating: 2 + 3
5
```

ä»ç»“æœå¯ä»¥çœ‹å‡ºï¼Œå½“ç¬¬äºŒæ¬¡è°ƒç”¨ add(1, 2) æ—¶ï¼Œå¹¶æ²¡æœ‰çœŸæ­£æ‰§è¡Œå‡½æ•°ä½“ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›ç¼“å­˜çš„ç»“æœã€‚

å¦‚æœè¦åœ¨ Python 2 ä¸­ä½¿ç”¨ lru\_cahce éœ€è¦å®‰è£…ç¬¬ä¸‰æ–¹æ¨¡å— `functools32`ã€‚è¿˜æœ‰ä¸€ä¸ªç”¨ C è¯­è¨€å®ç°çš„ï¼Œæ›´å¿«çš„ï¼ŒåŒæ—¶å…¼å®¹ Python2 å’Œ Python3 çš„ç¬¬ä¸‰æ–¹æ¨¡å— [fastcache](https://github.com/pbrady/fastcache) èƒ½å¤Ÿå®ç°åŒæ ·çš„åŠŸèƒ½ï¼Œä¸”å…¶èƒ½æ”¯æŒ TTLã€‚

`lru_cahce` æ˜¯å°†æ•°æ®ç¼“å­˜åˆ°å†…å­˜ä¸­çš„ï¼Œå…¶å®ä¹Ÿå¯ä»¥å°†æ•°æ®ç¼“å­˜åˆ°ç£ç›˜ä¸Šã€‚ä»¥ä¸‹ç¤ºä¾‹å°è¯•å®ç°äº†ä¸€ä¸ªåŸºäºç£ç›˜çš„ç¼“å­˜è£…é¥°å™¨ï¼š
```python
    import os
    import uuid
    import pickle
    import shutil
    import tempfile
    from functools import wraps as func_wraps
    
    
    class DiskCache(object):
        """ç¼“å­˜æ•°æ®åˆ°ç£ç›˜
    
        å®ä¾‹åŒ–å‚æ•°:
        -----
            cache_path: ç¼“å­˜æ–‡ä»¶çš„è·¯å¾„
        """
    
        _NAMESPACE = uuid.UUID("c875fb30-a8a8-402d-a796-225a6b065cad")
    
        def __init__(self, cache_path=None):
            if cache_path:
                self.cache_path = os.path.abspath(cache_path)
            else:
                self.cache_path = os.path.join(tempfile.gettempdir(), ".diskcache")
    
        def __call__(self, func):
            """è¿”å›ä¸€ä¸ªåŒ…è£…åçš„å‡½æ•°
    
            å¦‚æœç£ç›˜ä¸­æ²¡æœ‰ç¼“å­˜ï¼Œåˆ™è°ƒç”¨å‡½æ•°è·å¾—ç»“æœå¹¶ç¼“å­˜åå†è¿”å›
            å¦‚æœç£ç›˜ä¸­æœ‰ç¼“å­˜ï¼Œåˆ™ç›´æ¥è¿”å›ç¼“å­˜çš„ç»“æœ
            """
            @func_wraps(func)
            def wrapper(*args, **kw):
                params_uuid = uuid.uuid5(self._NAMESPACE, "-".join(map(str, (args, kw))))
                key = '{}-{}.cache'.format(func.__name__, str(params_uuid))
                cache_file = os.path.join(self.cache_path, key)
    
                if not os.path.exists(self.cache_path):
                    os.makedirs(self.cache_path)
    
                try:
                    with open(cache_file, 'rb') as f:
                        val = pickle.load(f)
                except Exception:
                    val = func(*args, **kw)
                    try:
                        with open(cache_file, 'wb') as f:
                            pickle.dump(val, f)
                    except Exception:
                        pass
                return val
            return wrapper
    
        def clear(self, func_name):
            """æ¸…ç†æŒ‡å®šå‡½æ•°è°ƒç”¨çš„ç¼“å­˜"""
            for cache_file in os.listdir(self.cache_path):
                if cache_file.startswith(func_name + "-"):
                    os.remove(os.path.join(self.cache_path, cache_file))
    
        def clear_all(self):
            """æ¸…ç†æ‰€æœ‰ç¼“å­˜"""
            if os.path.exists(self.cache_path):
                shutil.rmtree(self.cache_path)
    
    
    cache_in_disk = DiskCache()
    
    
    @cache_in_disk
    def add(x, y):
        return x + y
```

æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–çš„ç¼“å­˜æ¨¡å—ï¼Œå¦‚ [cachelib](https://github.com/pallets/cachelib), [cacheout](https://github.com/dgilland/cacheout) ç­‰ç­‰ï¼Œå®é™…ä½¿ç”¨éœ€è¦æ—¶å¯ä»¥æŒ‰éœ€æ±‚å»é€‰æ‹©åˆé€‚çš„ç¼“å­˜å®ç°ã€‚

## ç¼“å­˜æœºåˆ¶
[Python3 çš„ç¼“å­˜æœºåˆ¶ - æ€æ±Ÿ - åšå®¢å›­](https://www.cnblogs.com/liunaixu/p/12364655.html)
[ä» Python è®¡ç®— Fibonacci æ•°åˆ—è¯´èµ· - I'm SErHo](https://serholiu.com/talk-python-fibonacci)
[Python ç¼“å­˜æœºåˆ¶ä¸ functools.lru_cache | Huoty's Blog](https://blog.konghy.cn/2016/04/20/python-cache/)
[Python ç¼“å­˜ç¥å¥‡åº“ cacheout å…¨è§£ - ç®€ä¹¦](https://www.jianshu.com/p/f03640646c9c)
[python ç¼“å­˜ - æ˜é‡‘](https://juejin.im/post/6844903930476888071)
[[python]@cached_property ç¼“å­˜è£…é¥°å™¨ - faithfu - åšå®¢å›­](https://www.cnblogs.com/faithfu/p/10365868.html)
è£…é¥°å™¨æ¨¡å¼ä¹Ÿå¯ä»¥å®ç°ç¼“å­˜
[Python è®¾è®¡æ¨¡å¼: è£…é¥°å™¨æ¨¡å¼(decorator pattern) - Huang Huang çš„åšå®¢](https://mozillazg.com/2016/08/python-decorator-pattern.html)