---
title: FastAPI ä¾èµ–æ³¨å…¥ï¼šä»å…¥é—¨åˆ°å®è·µ
date: 2025-07-04 16:07:22
permalink: /fastapi/depends/
categories:
  - ğŸPython
  - FastAPI
tags:
  - FastAPI
  - ä¾èµ–æ³¨å…¥
---

## ä¸€ã€ä¸ºä»€ä¹ˆä½ éœ€è¦ç†è§£ä¾èµ–æ³¨å…¥

* **ä»£ç å¤ç”¨**ï¼šé¿å…åœ¨å¤šä¸ªè·¯ç”±ä¸­é‡å¤ç¼–å†™ç›¸åŒçš„é€»è¾‘ï¼ˆå¦‚è®¤è¯ã€æ•°æ®åº“è¿æ¥ï¼‰ã€‚
* **å…³æ³¨ç‚¹åˆ†ç¦»**ï¼šå°†é€šç”¨é€»è¾‘ï¼ˆå¦‚æƒé™æ£€æŸ¥ï¼‰ä¸ä¸šåŠ¡é€»è¾‘åˆ†ç¦»ã€‚
* **å¯æµ‹è¯•æ€§**ï¼šæ›´å®¹æ˜“ä¸ºæµ‹è¯•æä¾›æ¨¡æ‹Ÿä¾èµ–ã€‚
* **è‡ªåŠ¨æ–‡æ¡£**ï¼šä¾èµ–é¡¹çš„å‚æ•°ä¼šè‡ªåŠ¨åŒ…å«åœ¨ API æ–‡æ¡£ä¸­ã€‚

å¦‚æœä½ æ›¾åœ¨å†™ API æ—¶é‡å¤ç²˜è´´æ•°æ®åº“è¿æ¥ä»£ç ï¼Œæˆ–æ˜¯ä¸ºå¤„ç†ç”¨æˆ·è®¤è¯å¤´ç—›ï¼Œé‚£ FastAPI çš„ä¾èµ–æ³¨å…¥ç³»ç»Ÿå°±æ˜¯ä½ çš„æ•‘æ˜Ÿã€‚å®ƒåƒä¸€ä¸ªâ€œæ™ºèƒ½ç»„è£…æœºâ€ï¼Œè®©ä½ åªéœ€å£°æ˜éœ€è¦ä»€ä¹ˆï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨å¸®ä½ å‡†å¤‡å¥½ä¸€åˆ‡â€”â€”ä»æ•°æ®åº“ä¼šè¯åˆ°ç”¨æˆ·æƒé™éªŒè¯ï¼Œç”šè‡³è‡ªåŠ¨æ¸…ç†èµ„æºã€‚

## äºŒã€ä¾èµ–æ³¨å…¥ï¼šå‘Šåˆ«é‡å¤ä»£ç çš„é­”æ³•

æƒ³è±¡ä½ è¦ç»™ 100 ä¸ªæˆ¿é—´è£…ç¯ï¼š  

* **ä¼ ç»Ÿæ–¹å¼**ï¼šæ¯ä¸ªæˆ¿é—´å•ç‹¬æ‹‰çº¿æ¥ç¯æ³¡ï¼ˆé‡å¤å†™æ•°æ®åº“è¿æ¥ã€è®¤è¯é€»è¾‘ï¼‰ã€‚  
* **ä¾èµ–æ³¨å…¥**ï¼šç»Ÿä¸€è®¾è®¡ç”µè·¯ç³»ç»Ÿï¼Œæ¯ä¸ªæˆ¿é—´åªéœ€â€œå£°æ˜éœ€è¦ç¯â€ï¼Œç”µä¼šè‡ªåŠ¨æ¥é€šï¼ˆä¸€æ¬¡å®šä¹‰ä¾èµ–ï¼Œåˆ°å¤„å¤ç”¨ï¼‰ã€‚

### æ ¸å¿ƒæ¦‚å¿µï¼šä»€ä¹ˆæ˜¯ä¾èµ–æ³¨å…¥

> ä¾èµ–æ³¨å…¥æ˜¯ä¸€ç§ç”¨äºè§£è€¦ç»„ä»¶å¹¶å®ç°ä»£ç å¤ç”¨çš„æœºåˆ¶ã€‚

ä¾èµ–æ³¨å…¥ï¼ˆDependency Injection, DIï¼‰æ˜¯ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œå…¶ä¸­å¯¹è±¡æˆ–å‡½æ•°æ¥æ”¶å…¶ä¾èµ–é¡¹ï¼ˆå¦‚æœåŠ¡<æ•°æ®åº“è¿æ¥>ã€å·¥å…·æˆ–èµ„æº<ç”¨æˆ·å¯¹è±¡>ï¼‰ä½œä¸ºå‚æ•°ï¼Œè€Œä¸æ˜¯è‡ªå·±åˆ›å»ºå®ƒä»¬ã€‚åœ¨ FastAPI ä¸­ï¼Œä¾èµ–é¡¹æ˜¯é€šè¿‡ **ä¾èµ–å‡½æ•°ï¼ˆDependency Functionsï¼‰** å®šä¹‰çš„ï¼Œè¿™äº›å‡½æ•°å¯ä»¥è¢«è·¯å¾„æ“ä½œå‡½æ•°ï¼ˆå¦‚ `@app.get`ï¼‰æˆ–å…¶ä»–ä¾èµ–é¡¹å¼•ç”¨ã€‚

åœ¨ FastAPI ä¸­ï¼Œä½ é€šè¿‡`Depends()`å£°æ˜ä¾èµ–ï¼Œæ¡†æ¶ä¼šå¸®ä½ ï¼š  

1. è§£æä¾èµ–å…³ç³»ï¼ˆæ¯”å¦‚ A ä¾èµ– Bï¼ŒB ä¾èµ– Cï¼Œæ¡†æ¶è‡ªåŠ¨æŒ‰é¡ºåºå‡†å¤‡ï¼‰ã€‚  
2. ç®¡ç†èµ„æºç”Ÿå‘½å‘¨æœŸï¼ˆå¦‚ç”¨`yield`è‡ªåŠ¨å…³é—­æ•°æ®åº“è¿æ¥ï¼‰ã€‚  
3. ç»‘å®šè¯·æ±‚æ•°æ®ï¼ˆå¦‚ä» Header è·å– Tokenï¼Œä» Query è·å–å‚æ•°ï¼‰ã€‚

## **ä¸‰ã€ä»â€œæ‰‹åŠ¨è°ƒç”¨â€åˆ°â€œå£°æ˜å¼ä¾èµ–â€**

### **åœºæ™¯ï¼šè®°å½•è¯·æ±‚æ—¥å¿—å¹¶è®¡ç®—è€—æ—¶**  

#### **ä¼ ç»Ÿæ–¹å¼ï¼ˆé‡å¤ä»£ç å™©æ¢¦ï¼‰**  

```python
def log_request():
    start_time = time.time()
    print(f"è¯·æ±‚å¼€å§‹: {start_time}")
    return start_time

@app.get("/items/")
async def read_items():
    start_time = log_request()  # æ‰‹åŠ¨è°ƒç”¨å¼€å§‹æ—¥å¿—
    try:
        return {"items": ["item1", "item2"]}
    finally:
        end_time = time.time()
        print(f"è¯·æ±‚ç»“æŸ: {end_time}, è€—æ—¶: {end_time - start_time}s")
```

#### **ä¾èµ–æ³¨å…¥æ–¹å¼ï¼ˆä¸€æ¬¡å®šä¹‰ï¼Œå¤„å¤„å¤ç”¨ï¼‰**  

```python
def log_request():
    start_time = time.time()
    print(f"è¯·æ±‚å¼€å§‹: {start_time}")
    try:
        yield  # å…³é”®ç‚¹ï¼šç”¨ yield åˆ†å‰²è¯·æ±‚å‰å
    finally:
        end_time = time.time()
        print(f"è¯·æ±‚ç»“æŸ: {end_time}, è€—æ—¶: {end_time - start_time}s")

@app.get("/items/")
async def read_items(_=Depends(log_request)):  # å£°æ˜ä¾èµ–
    return {"items": ["item1", "item2"]}
```

**å…³é”®åŒºåˆ«**ï¼š  

* **`yield`çš„é­”æ³•**ï¼šæŠŠä»£ç åˆ†æˆâ€œè¯·æ±‚å‰â€å’Œâ€œè¯·æ±‚åâ€ï¼Œæ¡†æ¶è‡ªåŠ¨åœ¨ä¸­é—´æ’å…¥ä½ çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ— éœ€æ‰‹åŠ¨å†™`try-finally`ã€‚  

* **ç»´æŠ¤æˆæœ¬**ï¼šä¾èµ–æ³¨å…¥åªéœ€ä¿®æ”¹ log_request å‡½æ•°ï¼Œæ‰€æœ‰è·¯ç”±è‡ªåŠ¨ç”Ÿæ•ˆ
  
### åœºæ™¯æ¼”åŒ– 2ï¼šå¢åŠ ç”¨æˆ·ä¿¡æ¯

éœ€æ±‚å˜æ›´ï¼šéœ€è¦åœ¨æ—¥å¿—ä¸­åŒ…å«ç”¨æˆ· IDï¼ˆä» Token ä¸­è§£æï¼‰ã€‚

#### ç›´æ¥è°ƒç”¨

```python
def log_request(user_id: Optional[str] = None):
    start_time = time.time()
    print(f"è¯·æ±‚å¼€å§‹: {start_time}, ç”¨æˆ·: {user_id}")
    return start_time

@app.get("/items/")
async def read_items(x_token: str = Header(...)):
    user_id = decode_token(x_token)  # æ‰‹åŠ¨è§£æ Token
    start_time = log_request(user_id)  # ä¼ é€’ç”¨æˆ·ä¿¡æ¯
    try:
        return {"items": ["item1", "item2"]}
    finally:
        end_time = time.time()
        print(f"è¯·æ±‚ç»“æŸ: {end_time}, è€—æ—¶: {end_time - start_time}s")
```

#### ä¾èµ–æ³¨å…¥

```python
def get_user_id(x_token: str = Header(...)):
    return decode_token(x_token)  # è§£æç”¨æˆ· ID

def log_request(user_id: str = Depends(get_user_id)):
    start_time = time.time()
    print(f"è¯·æ±‚å¼€å§‹: {start_time}, ç”¨æˆ·: {user_id}")
    try:
        yield
    finally:
        end_time = time.time()
        print(f"è¯·æ±‚ç»“æŸ: {end_time}, è€—æ—¶: {end_time - start_time}s")

@app.get("/items/")
async def read_items(_=Depends(log_request)):  # å£°æ˜ä¾èµ–
    return {"items": ["item1", "item2"]}
```

æ­¤æ—¶çš„åŒºåˆ«ï¼š

* ä»£ç å¤ç”¨ï¼šä¾èµ–æ³¨å…¥æ–¹æ¡ˆä¸­ï¼Œ`get_user_id` å¯ä»¥è¢«å…¶ä»–ä¾èµ–å¤ç”¨
* å‚æ•°ä¼ é€’ï¼šç›´æ¥è°ƒç”¨éœ€è¦æ‰‹åŠ¨å°† `user_id` ä»è·¯ç”±ä¼ é€’åˆ°æ—¥å¿—å‡½æ•°
* å…³æ³¨ç‚¹åˆ†ç¦»ï¼šä¾èµ–æ³¨å…¥è®©è·¯ç”±å‡½æ•°å®Œå…¨ä¸éœ€è¦å…³å¿ƒæ—¥å¿—å’Œç”¨æˆ·è§£æé€»è¾‘

### åœºæ™¯æ¼”åŒ– 3ï¼šåº”ç”¨åˆ° 100 ä¸ªè·¯ç”±

å‡è®¾é¡¹ç›®æ‰©å±•åˆ° 100 ä¸ªè·¯ç”±ï¼Œå…¶ä¸­ 50 ä¸ªéœ€è¦æ—¥å¿—è®°å½•ã€‚

#### ç›´æ¥è°ƒç”¨æ–¹æ¡ˆ

* éœ€è¦åœ¨ 50 ä¸ªè·¯ç”±å‡½æ•°ä¸­å¤åˆ¶ç²˜è´´æ—¥å¿—ä»£ç 
* å¦‚æœæ—¥å¿—æ ¼å¼å˜æ›´ï¼ˆå¦‚å¢åŠ è¯·æ±‚è·¯å¾„ï¼‰ï¼Œéœ€è¦ä¿®æ”¹ 50 ä¸ªåœ°æ–¹
* å¦‚æœå¿˜è®°åœ¨æŸä¸ªè·¯ç”±ä¸­æ·»åŠ æ—¥å¿—ï¼Œæ’æŸ¥å›°éš¾
  
#### ä¾èµ–æ³¨å…¥

```python
# å®šä¹‰ä¸€æ¬¡ï¼Œå…¨å±€ç”Ÿæ•ˆ
app = FastAPI(dependencies=[Depends(log_request)])  # æ‰€æœ‰è·¯ç”±è‡ªåŠ¨è®°å½•æ—¥å¿—

# æˆ–é€‰æ‹©æ€§åº”ç”¨
@app.get("/items/", dependencies=[Depends(log_request)])
async def read_items():
    return {"items": ["item1", "item2"]}
```

æ­¤æ—¶çš„åŒºåˆ«ï¼š

* ä»£ç è¡Œæ•°ï¼šä¾èµ–æ³¨å…¥æ–¹æ¡ˆå‡å°‘çº¦ 1000 è¡Œ é‡å¤ä»£ç 
* ç»´æŠ¤æˆæœ¬ï¼šä¿®æ”¹åªéœ€ 1 å¤„ï¼Œç”Ÿæ•ˆäºæ‰€æœ‰è·¯ç”±
* æ‰©å±•æ€§ï¼šæœªæ¥å¯ä»¥è½»æ¾æ·»åŠ æ–°çš„ä¾èµ–ï¼ˆå¦‚æ€§èƒ½ç›‘æ§ï¼‰ï¼Œæ— éœ€ä¿®æ”¹åŸæœ‰è·¯ç”±

| **ç»´åº¦**     | **ç›´æ¥è°ƒç”¨**     | **ä¾èµ–æ³¨å…¥**       |
|------------|--------------|----------------|
| **ä»£ç å¤ç”¨**   | ä½ï¼ˆéœ€å¤åˆ¶ç²˜è´´ï¼‰     | é«˜ï¼ˆä¸€æ¬¡å®šä¹‰ï¼Œåˆ°å¤„ä½¿ç”¨ï¼‰   |
| **ç”Ÿå‘½å‘¨æœŸç®¡ç†** | æ‰‹åŠ¨ç®¡ç†ï¼ˆå¤æ‚ï¼‰     | è‡ªåŠ¨ç®¡ç†ï¼ˆé€šè¿‡ yieldï¼‰ |
| **ä¾èµ–ä¼ é€’**   | æ‰‹åŠ¨ä¼ é€’ï¼ˆå±‚çº§æ·±æ—¶å¤æ‚ï¼‰ | è‡ªåŠ¨è§£æï¼ˆæ¡†æ¶å¤„ç†ä¾èµ–æ ‘ï¼‰  |
| **æµ‹è¯•éš”ç¦»**   | éš¾ï¼ˆéœ€ä¿®æ”¹è°ƒç”¨é€»è¾‘ï¼‰   | æ˜“ï¼ˆç›´æ¥æ›¿æ¢ä¾èµ–å®ç°ï¼‰    |
| **å…³æ³¨ç‚¹åˆ†ç¦»**  | å·®ï¼ˆä¸šåŠ¡é€»è¾‘ä¸æ—¥å¿—æ··åˆï¼‰ | å¥½ï¼ˆè·¯ç”±åªéœ€å…³æ³¨ä¸šåŠ¡ï¼‰    |
| **é”™è¯¯é£é™©**   | é«˜ï¼ˆå®¹æ˜“æ¼å†™æ¸…ç†é€»è¾‘ï¼‰  | ä½ï¼ˆæ¡†æ¶ä¿è¯æ‰§è¡Œï¼‰      |

* ä»€ä¹ˆæ—¶å€™åº”è¯¥ç›´æ¥è°ƒç”¨ï¼Ÿ
å½“æ»¡è¶³ä»¥ä¸‹æ‰€æœ‰æ¡ä»¶æ—¶ï¼Œå¯ä»¥è€ƒè™‘ç›´æ¥è°ƒç”¨ï¼š

* é€»è¾‘åªä¼šåœ¨ä¸€ä¸ªåœ°æ–¹ä½¿ç”¨ï¼ˆæ— å¤ç”¨éœ€æ±‚ï¼‰
* æ— éœ€ç®¡ç†èµ„æºç”Ÿå‘½å‘¨æœŸï¼ˆå¦‚æ‰“å¼€ / å…³é—­è¿æ¥ï¼‰
* ä¸ä¾èµ–å…¶ä»–ç»„ä»¶ï¼ˆå¦‚ç”¨æˆ·è®¤è¯ã€é…ç½®ï¼‰
* æœªæ¥ä¿®æ”¹å¯èƒ½æ€§æä½

ä½†åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œè¿™äº›æ¡ä»¶å¾ˆå°‘åŒæ—¶æ»¡è¶³ã€‚ç‰¹åˆ«æ˜¯åœ¨ FastAPI è¿™ç§å¼ºè°ƒé«˜æ€§èƒ½ã€å¯ç»´æŠ¤æ€§çš„æ¡†æ¶ä¸­ï¼Œä¾èµ–æ³¨å…¥å‡ ä¹æ€»æ˜¯æ›´å¥½çš„é€‰æ‹©ã€‚

**æ€ç»´è½¬æ¢ï¼šä»ã€Œæ‰§è¡ŒåŠ¨ä½œã€åˆ°ã€Œå£°æ˜éœ€æ±‚ã€**

ä¾èµ–æ³¨å…¥çš„æ ¸å¿ƒæ˜¯ **å£°æ˜å¼ç¼–ç¨‹**ï¼š

* ç›´æ¥è°ƒç”¨ï¼šæˆ‘éœ€è¦è®°å½•æ—¥å¿—ï¼Œæ‰€ä»¥æˆ‘è°ƒç”¨ log_request()
* ä¾èµ–æ³¨å…¥ï¼šæˆ‘éœ€è¦è¿™ä¸ªè·¯ç”±è¢«æ—¥å¿—è®°å½•ï¼Œæ¡†æ¶å¸®æˆ‘å¤„ç†å…·ä½“å®ç°

å¯ä»¥ç”¨ä¸€ä¸ªå½¢è±¡çš„æ¯”å–»æ¥è§£é‡Šï¼š**ä¾èµ–æ³¨å…¥ä¸­çš„ `yield` å°±åƒæ˜¯ç”µè·¯ä¸­çš„ã€Œæ–­ç‚¹ã€ï¼Œæ¡†æ¶è´Ÿè´£åœ¨è¿™ä¸ªæ–­ç‚¹å¤„æ’å…¥é€»è¾‘ï¼Œå½¢æˆå®Œæ•´çš„ç”µè·¯**ã€‚

è®©æˆ‘ç”¨ä»£ç å¯¹æ¯”å’Œå¯è§†åŒ–è¿›ä¸€æ­¥è¯´æ˜ï¼š

### ä¸€ã€æ–­ç‚¹æ’å…¥

#### **ä¼ ç»Ÿæ–¹å¼ï¼ˆæ‰‹åŠ¨æ‹†åˆ†ï¼‰**

```python
# ä¼ ç»Ÿæ–¹å¼ï¼šæ¯æ¬¡è°ƒç”¨éƒ½è¦æ‰‹åŠ¨æ‹†åˆ†é€»è¾‘
@app.get("/items/")
async def read_items():
    # ä¸ŠåŠéƒ¨åˆ†ï¼šå¼€å§‹æ—¥å¿—
    start_time = time.time()
    print(f"è¯·æ±‚å¼€å§‹: {start_time}")
    
    # ä¸­é—´ï¼šä¸šåŠ¡é€»è¾‘
    result = {"items": ["item1", "item2"]}
    
    # ä¸‹åŠéƒ¨åˆ†ï¼šç»“æŸæ—¥å¿—
    end_time = time.time()
    print(f"è¯·æ±‚ç»“æŸ: {end_time}, è€—æ—¶: {end_time - start_time}s")
    
    return result
```

#### **ä¾èµ–æ³¨å…¥ï¼ˆæ¡†æ¶ç»„è£…ï¼‰**

```python
# ä¾èµ–å‡½æ•°ï¼šå®šä¹‰å®Œæ•´ç”Ÿå‘½å‘¨æœŸ
def log_request():
    start_time = time.time()
    print(f"è¯·æ±‚å¼€å§‹: {start_time}")
    try:
        yield  # æ–­ç‚¹ï¼šä¸šåŠ¡é€»è¾‘å°†åœ¨è¿™é‡Œæ’å…¥
    finally:
        end_time = time.time()
        print(f"è¯·æ±‚ç»“æŸ: {end_time}, è€—æ—¶: {end_time - start_time}s")

# è·¯ç”±ï¼šåªéœ€å£°æ˜ä¾èµ–ï¼Œæ— éœ€å…³å¿ƒæ‹†åˆ†
@app.get("/items/")
async def read_items(_=Depends(log_request)):
    return {"items": ["item1", "item2"]}  # ä¸šåŠ¡é€»è¾‘è‡ªåŠ¨æ’å…¥åˆ° yield ä½ç½®
```

### **äºŒã€å¯è§†åŒ–å¯¹æ¯”**

#### **ä¼ ç»Ÿæ–¹å¼ï¼šä»£ç ç¢ç‰‡åŒ–**

```plain
è·¯ç”±å‡½æ•°1:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ—¥å¿—å¼€å§‹é€»è¾‘  â”‚  ä¸šåŠ¡é€»è¾‘A  â”‚  æ—¥å¿—ç»“æŸé€»è¾‘          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è·¯ç”±å‡½æ•°2:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ—¥å¿—å¼€å§‹é€»è¾‘  â”‚  ä¸šåŠ¡é€»è¾‘B  â”‚  æ—¥å¿—ç»“æŸé€»è¾‘          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### **ä¾èµ–æ³¨å…¥ï¼šé€»è¾‘å®Œæ•´å°è£…**

```plain
ä¾èµ–å‡½æ•°:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ—¥å¿—å¼€å§‹é€»è¾‘  â”‚     yieldï¼ˆä¸šåŠ¡é€»è¾‘æ’å…¥ç‚¹ï¼‰     â”‚  æ—¥å¿—ç»“æŸé€»è¾‘  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è·¯ç”±å‡½æ•°1:               è·¯ç”±å‡½æ•°2:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å£°æ˜ä¾èµ–       â”‚     â”‚  å£°æ˜ä¾èµ–       â”‚
â”‚  ä¸šåŠ¡é€»è¾‘A      â”‚     â”‚  ä¸šåŠ¡é€»è¾‘B      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **ä¸‰ã€è¿›é˜¶ç†è§£ï¼š`yield` çš„æœ¬è´¨**

åœ¨ä¾èµ–æ³¨å…¥ä¸­ï¼Œ`yield` å®ç°äº†ä¸€ç§ **æ§åˆ¶åè½¬ï¼ˆIoCï¼‰**ï¼š

1. **ä¾èµ–å‡½æ•°** å®šä¹‰äº†å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸï¼ˆå¼€å§‹â†’ä¸šåŠ¡â†’ç»“æŸï¼‰
2. **æ¡†æ¶** è´Ÿè´£åœ¨ `yield` å¤„æ’å…¥è·¯ç”±å‡½æ•°çš„ä¸šåŠ¡é€»è¾‘
3. **è·¯ç”±å‡½æ•°** åªéœ€å…³æ³¨æ ¸å¿ƒä¸šåŠ¡ï¼Œæ— éœ€å…³å¿ƒç”Ÿå‘½å‘¨æœŸç®¡ç†

è¿™å°±åƒç”µå½±æ‹æ‘„ï¼š

* **ä¾èµ–å‡½æ•°** æ˜¯å‰§æœ¬æ¡†æ¶ï¼ˆåŒ…æ‹¬å¼€åœºå’Œç»“å°¾ï¼‰
* **è·¯ç”±å‡½æ•°** æ˜¯ä¸»è§’å°è¯
* **æ¡†æ¶** æ˜¯å¯¼æ¼”ï¼Œè´Ÿè´£æŠŠä¸»è§’å°è¯æ’å…¥åˆ°å‰§æœ¬çš„åˆé€‚ä½ç½®

### **å››ã€ä¸ºä»€ä¹ˆè¿™ç§è®¾è®¡å¾ˆé‡è¦**

#### **åœºæ™¯ 1ï¼šä¿®æ”¹æ—¥å¿—æ ¼å¼**

* ä¼ ç»Ÿæ–¹å¼ï¼šéœ€è¦ä¿®æ”¹æ‰€æœ‰è·¯ç”±ä¸­çš„æ—¥å¿—ä»£ç 

* ä¾èµ–æ³¨å…¥ï¼šåªéœ€ä¿®æ”¹ `log_request` å‡½æ•°

#### **åœºæ™¯ 2ï¼šæ·»åŠ æ–°åŠŸèƒ½**

å‡è®¾éœ€è¦åœ¨æ—¥å¿—ä¸­æ·»åŠ è¯·æ±‚ IDï¼š

```python
def log_request():
    request_id = uuid.uuid4()  # ç”Ÿæˆå”¯ä¸€è¯·æ±‚ ID
    print(f"è¯·æ±‚å¼€å§‹: {request_id}")
    try:
        yield {"request_id": request_id}  # å°† ID ä¼ é€’ç»™ä¸šåŠ¡é€»è¾‘
    finally:
        print(f"è¯·æ±‚ç»“æŸ: {request_id}")
```

è·¯ç”±å‡½æ•°å¯ä»¥é€šè¿‡ä¾èµ–è·å– `request_id`ï¼š

```python
@app.get("/items/")
async def read_items(request_info=Depends(log_request)):
    # request_info åŒ…å« request_id
    return {"items": ["item1", "item2"], "request_id": request_info["request_id"]}
```

#### **åœºæ™¯ 3ï¼šå¤ç”¨æ—¥å¿—é€»è¾‘åˆ°å…¶ä»–ç³»ç»Ÿ**

ä¾èµ–å‡½æ•°å¯ä»¥è½»æ¾å¤ç”¨ï¼š

```python
# åœ¨WebSocketè¿æ¥ä¸­å¤ç”¨ç›¸åŒçš„æ—¥å¿—é€»è¾‘
@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket, _=Depends(log_request)):
    await websocket.accept()
    await websocket.send_json({"message": "Hello"})
    await websocket.close()
```

### **äº”ã€æ€»ç»“ï¼šä¾èµ–æ³¨å…¥çš„ã€Œç»„è£…æ€ç»´ã€**

ä¾èµ–æ³¨å…¥çš„æ ¸å¿ƒæ˜¯ **ã€Œç»„è£…ã€è€Œéã€Œç¼–å†™ã€**ï¼š

* ä¼ ç»Ÿç¼–ç¨‹ï¼šåƒæ‰‹å·¥æ‰“é€ ä¸€æŠŠæ¤…å­ï¼Œæ¯ä¸ªæ­¥éª¤éƒ½è¦é‡å¤æ“ä½œ
* ä¾èµ–æ³¨å…¥ï¼šåƒä¹é«˜ç§¯æœ¨ï¼Œå®šä¹‰å¥½æ ‡å‡†æ¨¡å—ï¼ŒæŒ‰éœ€ç»„è£…

å½“ä½ ä¹ æƒ¯è¿™ç§æ€ç»´åï¼Œä¼šå‘ç°ä»£ç å˜å¾—æ›´åŠ ï¼š

1. **æ¨¡å—åŒ–**ï¼šæ¯ä¸ªä¾èµ–ä¸“æ³¨è§£å†³å•ä¸€é—®é¢˜
2. **å¯æµ‹è¯•**ï¼šå¯ä»¥ç‹¬ç«‹æµ‹è¯•ä¾èµ–å‡½æ•°
3. **å¯æ‰©å±•**ï¼šæ–°å¢åŠŸèƒ½åªéœ€æ·»åŠ æ–°ä¾èµ–ï¼Œæ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 
4. **å£°æ˜å¼**ï¼šç”¨æ›´å°‘çš„ä»£ç è¡¨è¾¾æ›´å¤šæ„å›¾

å»ºè®®åœ¨å°é¡¹ç›®ä¸­åˆ»æ„ç»ƒä¹ è¿™ç§æ€ç»´ï¼Œä½ ä¼šé€æ¸ä½“ä¼šåˆ°å…¶ä¼˜é›…ä¹‹å¤„ã€‚

## ä¸ºä»€ä¹ˆæ¨èä¾èµ–æ³¨å…¥è€Œä¸èƒ½æ˜¯è£…é¥°å™¨

FastAPI å½“ç„¶å¯ä»¥ä½¿ç”¨è£…é¥°å™¨ï¼ä¸è¿‡å®ƒçš„ä¾èµ–æ³¨å…¥ç³»ç»Ÿæä¾›äº†æ¯”ä¼ ç»Ÿè£…é¥°å™¨æ›´å¼ºå¤§ã€æ›´çµæ´»çš„è§£å†³æ–¹æ¡ˆã€‚è®©æˆ‘æ¥è¯¦ç»†è§£é‡Šä¸¤è€…çš„åŒºåˆ«å’Œé€‚ç”¨åœºæ™¯ï¼š

### **ä¸€ã€FastAPI ä¸­ä½¿ç”¨ä¼ ç»Ÿè£…é¥°å™¨**

#### **1. åŸºæœ¬ç¤ºä¾‹ï¼šè®°å½•è¯·æ±‚æ—¶é—´**

```python
from fastapi import FastAPI
import time

app = FastAPI()

# å®šä¹‰è£…é¥°å™¨
def log_time(func):
    def wrapper(*args, **kwargs):
        start_time = time.time()
        result = func(*args, **kwargs)
        end_time = time.time()
        print(f"å‡½æ•° {func.__name__} æ‰§è¡Œè€—æ—¶: {end_time - start_time}s")
        return result
    return wrapper

# åœ¨è·¯ç”±ä¸­ä½¿ç”¨è£…é¥°å™¨
@app.get("/items/")
@log_time  # æ³¨æ„ï¼šè£…é¥°å™¨è¦æ”¾åœ¨ @app.get ä¸‹é¢
async def read_items():
    return {"items": ["item1", "item2"]}
```

#### **2. è£…é¥°å™¨ä¸ä¾èµ–æ³¨å…¥çš„åŒºåˆ«**

| ç‰¹æ€§               | è£…é¥°å™¨                     | ä¾èµ–æ³¨å…¥                  |
|--------------------|---------------------------|--------------------------|
| **å‚æ•°è®¿é—®**        | éœ€é€šè¿‡ `request` å¯¹è±¡é—´æ¥è·å– | ç›´æ¥ä½œä¸ºå‡½æ•°å‚æ•°æ³¨å…¥       |
| **è¿”å›å€¼å¤„ç†**      | éœ€è¦åœ¨è£…é¥°å™¨ä¸­æ˜¾å¼è¿”å›      | è‡ªåŠ¨å¤„ç†ï¼Œæ— éœ€é¢å¤–ä»£ç      |
| **å¼‚å¸¸å¤„ç†**        | éœ€è¦æ‰‹åŠ¨æ•è·å’Œå¤„ç†         | æ¡†æ¶è‡ªåŠ¨å¤„ç†å¹¶ç”Ÿæˆæ–‡æ¡£     |
| **å¼‚æ­¥æ”¯æŒ**        | éœ€è¦ç¼–å†™å¼‚æ­¥è£…é¥°å™¨          | åŸç”Ÿæ”¯æŒåŒæ­¥/å¼‚æ­¥æ··åˆ      |
| **ä¾èµ–ä¼ é€’**        | éš¾ä»¥ä¼ é€’å¤æ‚ä¾èµ–            | è‡ªåŠ¨è§£æä¾èµ–é“¾            |
| **ä¸æ¡†æ¶é›†æˆ**      | æ— æ³•åˆ©ç”¨ FastAPI çš„è‡ªåŠ¨æ–‡æ¡£   | å‚æ•°è‡ªåŠ¨åŒ…å«åœ¨ OpenAPI ä¸­  |

### **äºŒã€è£…é¥°å™¨æ— æ³•è§£å†³çš„é—®é¢˜**

#### **1. èµ„æºæ¸…ç†ï¼ˆå¦‚æ•°æ®åº“ä¼šè¯ï¼‰**

è£…é¥°å™¨å®ç°æ–¹å¼ï¼š

```python
def db_session(func):
    async def wrapper(*args, **kwargs):
        db = SessionLocal()
        try:
            result = await func(db=db, *args, **kwargs)  # å¿…é¡»æ˜¾å¼ä¼ é€’ db
            db.commit()
        except Exception as e:
            db.rollback()
            raise e
        finally:
            db.close()
        return result
    return wrapper

@app.get("/items/")
@db_session
async def read_items(db):  # å¿…é¡»æ¥å— db å‚æ•°
    return db.query(Item).all()
```

ä¾èµ–æ³¨å…¥å®ç°æ–¹å¼ï¼š

```python
def get_db():
    db = SessionLocal()
    try:
        yield db
    finally:
        db.close()

@app.get("/items/")
async def read_items(db: Session = Depends(get_db)):  # è‡ªåŠ¨æ³¨å…¥ db
    return db.query(Item).all()
```

#### **2. å¤æ‚ä¾èµ–é“¾**

å‡è®¾éœ€è¦ï¼šToken éªŒè¯ â†’ ç”¨æˆ·è§£æ â†’ æƒé™æ£€æŸ¥

è£…é¥°å™¨å®ç°ï¼š

```python
@app.get("/admin/")
@verify_token
@parse_user
@check_admin
async def admin_route(user):
    return {"message": "ç®¡ç†å‘˜é¡µé¢"}
```

ä¾èµ–æ³¨å…¥å®ç°ï¼š

```python
def verify_token(x_token: str = Header(...)): ...
def get_current_user(token = Depends(verify_token)): ...
def check_admin(user = Depends(get_current_user)): ...

@app.get("/admin/", dependencies=[Depends(check_admin)])
async def admin_route():
    return {"message": "ç®¡ç†å‘˜é¡µé¢"}
```

:::note  Depends å’Œ dependencies çš„å·®å¼‚å¯¹æ¯”

`Depends` å’Œ `dependencies` è™½ç„¶éƒ½ç”¨äºç®¡ç†ä¾èµ–ï¼Œä½†å®ƒä»¬çš„å®šä½å’Œä½¿ç”¨åœºæ™¯æœ‰æ˜ç¡®åŒºåˆ«ï¼š

### **ä¸€ã€æ ¸å¿ƒåŒºåˆ«ï¼šä½œç”¨å¯¹è±¡ä¸åŒ**

| ç‰¹æ€§               | `Depends(func)`                          | `dependencies=[Depends(...)]`          |
|--------------------|-----------------------------------------|---------------------------------------|
| **ä½œç”¨ç›®æ ‡**        | æ³¨å…¥åˆ° **è·¯ç”±å‡½æ•°å‚æ•°**                  | åº”ç”¨äº **æ•´ä¸ªè·¯ç”±æˆ– APIRouter**         |
| **è¿”å›å€¼å¤„ç†**      | ä¾èµ–å‡½æ•°çš„è¿”å›å€¼ä¼šä½œä¸ºå‚æ•°ä¼ é€’ç»™è·¯ç”±å‡½æ•°  | è¿”å›å€¼è¢«å¿½ç•¥ï¼Œä»…æ‰§è¡Œä¾èµ–é€»è¾‘            |
| **ä½¿ç”¨åœºæ™¯**        | éœ€è¦ä¾èµ–çš„è¿”å›å€¼ï¼ˆå¦‚è·å–æ•°æ®åº“ä¼šè¯ã€ç”¨æˆ·å¯¹è±¡ï¼‰ | ä¸éœ€è¦è¿”å›å€¼ï¼ˆå¦‚æƒé™éªŒè¯ã€æ—¥å¿—è®°å½•ï¼‰    |
| **é“¾å¼è°ƒç”¨æ”¯æŒ**    | æ”¯æŒï¼ˆä¾èµ–å‡½æ•°å¯åµŒå¥—ä¾èµ–å…¶ä»–å‡½æ•°ï¼‰        | æ”¯æŒï¼ˆåˆ—è¡¨ä¸­å¤šä¸ªä¾èµ–æŒ‰é¡ºåºæ‰§è¡Œï¼‰        |

### **äºŒã€`Depends`ï¼šæ³¨å…¥è¿”å›å€¼åˆ°è·¯ç”±å‚æ•°**

#### **åœºæ™¯ï¼šè·å–æ•°æ®åº“ä¼šè¯å¹¶ä½¿ç”¨è¿”å›å€¼**

```python
def get_db():
    db = SessionLocal()
    try:
        yield db  # è¿”å›æ•°æ®åº“ä¼šè¯
    finally:
        db.close()

@app.get("/items/")
async def read_items(db: Session = Depends(get_db)):  # æ³¨å…¥è¿”å›å€¼åˆ° db å‚æ•°
    return db.query(Items).all()  # ç›´æ¥ä½¿ç”¨ db
```

#### **å…³é”®ç‚¹**

1. ä¾èµ–å‡½æ•° `get_db` çš„è¿”å›å€¼ï¼ˆ`db`ï¼‰è¢«æ³¨å…¥åˆ°è·¯ç”±å‡½æ•°çš„ `db` å‚æ•°
2. è·¯ç”±å‡½æ•°å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªè¿”å›å€¼è¿›è¡Œä¸šåŠ¡æ“ä½œ
3. æ”¯æŒå¤šå±‚åµŒå¥—ä¾èµ–ï¼ˆå¦‚ `get_current_user` ä¾èµ– `get_db`ï¼‰

### **ä¸‰ã€`dependencies`ï¼šåº”ç”¨ä¾èµ–åˆ°æ•´ä¸ªè·¯ç”±**

#### **åœºæ™¯ï¼šæƒé™éªŒè¯ï¼ˆä¸éœ€è¦è¿”å›å€¼ï¼‰**

```python
def verify_admin(user: User = Depends(get_current_user)):
    if user.role != "admin":
        raise HTTPException(403, detail="éœ€è¦ç®¡ç†å‘˜æƒé™")

@app.get("/admin/", dependencies=[Depends(verify_admin)])  # åº”ç”¨ä¾èµ–åˆ°è·¯ç”±
async def admin_route():
    return {"message": "ç®¡ç†å‘˜é¡µé¢"}  # ä¸ä½¿ç”¨ä¾èµ–çš„è¿”å›å€¼
```

#### **å…³é”®ç‚¹**

1. `dependencies` åˆ—è¡¨ä¸­çš„ä¾èµ–ä¼šåœ¨è·¯ç”±å‡½æ•°æ‰§è¡Œå‰è¢«è°ƒç”¨
2. ä¾èµ–çš„è¿”å›å€¼è¢«å¿½ç•¥ï¼Œä»…å…³æ³¨ä¾èµ–çš„å‰¯ä½œç”¨ï¼ˆå¦‚æƒé™éªŒè¯ã€æ—¥å¿—è®°å½•ï¼‰
3. é€‚åˆç”¨äºæ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆå¦‚è®¤è¯ã€é™æµã€è¯·æ±‚è®°å½•ï¼‰

### **å››ã€é“¾å¼è°ƒç”¨ï¼šä¸¤è€…éƒ½æ”¯æŒï¼Œä½†æ–¹å¼ä¸åŒ**

#### **1. `Depends` çš„é“¾å¼è°ƒç”¨ï¼ˆåµŒå¥—ä¾èµ–ï¼‰**

ä¾èµ–å‡½æ•°å¯ä»¥åµŒå¥—ä¾èµ–å…¶ä»–å‡½æ•°ï¼Œå½¢æˆä¾èµ–é“¾ï¼š

```python
def verify_token(x_token: str = Header(...)):
    return decode_token(x_token)  # éªŒè¯å¹¶è¿”å›ç”¨æˆ·ID

def get_current_user(user_id: int = Depends(verify_token)):
    return db.query(User).get(user_id)  # æ ¹æ®IDæŸ¥è¯¢ç”¨æˆ·

@app.get("/profile/")
async def read_profile(user: User = Depends(get_current_user)):  # æœ€ç»ˆä¾èµ–
    return user.profile  # ä½¿ç”¨æœ€å†…å±‚ä¾èµ–çš„è¿”å›å€¼
```

#### **2. `dependencies` çš„é“¾å¼è°ƒç”¨ï¼ˆåˆ—è¡¨é¡ºåºæ‰§è¡Œï¼‰**

```python
def log_request():
    print("è¯·æ±‚å¼€å§‹")
    try:
        yield
    finally:
        print("è¯·æ±‚ç»“æŸ")

def validate_ip(request: Request):
    if request.client.host not in ALLOWED_IPS:
        raise HTTPException(403)

@app.get("/sensitive/", dependencies=[Depends(log_request), Depends(validate_ip)])
async def sensitive_route():
    return {"data": "æ•æ„Ÿä¿¡æ¯"}
```

### **äº”ã€ç»„åˆä½¿ç”¨ï¼šåŒæ—¶å‘æŒ¥ä¸¤è€…ä¼˜åŠ¿**

```python
# ä¾èµ–1ï¼šè·å–æ•°æ®åº“ä¼šè¯ï¼ˆéœ€è¦è¿”å›å€¼ï¼‰
def get_db(): ...

# ä¾èµ–2ï¼šéªŒè¯ç”¨æˆ·æƒé™ï¼ˆä¸éœ€è¦è¿”å›å€¼ï¼‰
def verify_permission(user: User = Depends(get_current_user)):
    if "read:items" not in user.permissions:
        raise HTTPException(403)

# è·¯ç”±ï¼šåŒæ—¶ä½¿ç”¨ Depends å’Œ dependencies
@app.get("/items/", dependencies=[Depends(verify_permission)])  # æƒé™éªŒè¯
async def read_items(db: Session = Depends(get_db)):  # è·å–æ•°æ®åº“ä¼šè¯
    return db.query(Items).all()
```

### **å…­ã€ä½•æ—¶è¯¥ç”¨å“ªä¸ªï¼Ÿå†³ç­–æŒ‡å—**

1. **éœ€è¦ä¾èµ–çš„è¿”å›å€¼** â†’ ä½¿ç”¨ `Depends` ä½œä¸ºè·¯ç”±å‚æ•°
   * ä¾‹å¦‚ï¼šè·å–æ•°æ®åº“ä¼šè¯ã€å½“å‰ç”¨æˆ·å¯¹è±¡

2. **ä¸éœ€è¦è¿”å›å€¼ï¼Œåªå…³å¿ƒå‰¯ä½œç”¨** â†’ ä½¿ç”¨ `dependencies`
   * ä¾‹å¦‚ï¼šæƒé™éªŒè¯ã€è¯·æ±‚æ—¥å¿—ã€é™æµ

3. **å…¨å±€åº”ç”¨ä¾èµ–** â†’ ä½¿ç”¨ `FastAPI(dependencies=[])` æˆ– `APIRouter(dependencies=[])`

   ```python
   # æ‰€æœ‰è·¯ç”±éƒ½åº”ç”¨çš„ä¾èµ–
   app = FastAPI(dependencies=[Depends(log_request)])

   # ç‰¹å®šè·¯ç”±ç»„åº”ç”¨çš„ä¾èµ–
   router = APIRouter(dependencies=[Depends(verify_token)])
   ```

4. **éœ€è¦åœ¨è·¯å¾„æ“ä½œè£…é¥°å™¨ä¸­å¤ç”¨ä¾èµ–** â†’ ä½¿ç”¨ `dependencies`

   ```python
   common_deps = [Depends(verify_token), Depends(validate_ip)]

   @app.get("/route1/", dependencies=common_deps)
   @app.post("/route2/", dependencies=common_deps)
   async def route(): ...
   ```

### **æ€»ç»“ï¼šç®€åŒ–è€Œä¸ç®€å•çš„ä¾èµ–ç®¡ç†**

FastAPI é€šè¿‡ `Depends` å’Œ `dependencies` æä¾›äº†çµæ´»çš„ä¾èµ–ç®¡ç†æ–¹æ¡ˆï¼š
* `Depends` æ˜¯â€œç²¾ç»†æ§åˆ¶â€ï¼Œé€‚åˆéœ€è¦è¿”å›å€¼å¹¶ç›´æ¥å‚ä¸ä¸šåŠ¡é€»è¾‘çš„åœºæ™¯
* `dependencies` æ˜¯â€œæ‰¹é‡åº”ç”¨â€ï¼Œé€‚åˆæ— è¿”å›å€¼çš„æ¨ªåˆ‡å…³æ³¨ç‚¹

ä¸¤è€…éƒ½æ”¯æŒé“¾å¼è°ƒç”¨ï¼Œä½†è®¾è®¡ç›®çš„ä¸åŒã€‚ç†è§£è¿™ç§å·®å¼‚åï¼Œä½ å¯ä»¥æ›´ä¼˜é›…åœ°ç»„ç»‡ä»£ç ï¼Œè®©ä¾èµ–æ³¨å…¥ç³»ç»Ÿå‘æŒ¥æœ€å¤§å¨åŠ›ã€‚
:::

### **ä¸‰ã€FastAPI æ¨èçš„ã€Œè£…é¥°å™¨æ›¿ä»£æ–¹æ¡ˆã€**

#### **1. ä½¿ç”¨ä¾èµ–æ³¨å…¥æ›¿ä»£ç®€å•è£…é¥°å™¨**

```python
# è£…é¥°å™¨æ–¹å¼
def validate_token(func):
    def wrapper(*args, **kwargs):
        token = kwargs.get("token")
        if not validate(token):
            raise HTTPException(401)
        return func(*args, **kwargs)
    return wrapper

# ä¾èµ–æ³¨å…¥æ–¹å¼
def validate_token(token: str = Query(...)):
    if not validate(token):
        raise HTTPException(401)
    return token

@app.get("/secure/")
async def secure_route(token = Depends(validate_token)):
    return {"message": "å®‰å…¨è®¿é—®"}
```

#### **2. ä½¿ç”¨ `dependencies` å‚æ•°æ›¿ä»£è·¯ç”±è£…é¥°å™¨**

```python
# è£…é¥°å™¨æ–¹å¼
@app.get("/items/")
@log_request
@validate_user
async def read_items():
    pass

# ä¾èµ–æ³¨å…¥æ–¹å¼
@app.get("/items/", dependencies=[Depends(log_request), Depends(validate_user)])
async def read_items():
    pass
```

### **å››ã€ä½•æ—¶åº”è¯¥ä½¿ç”¨è£…é¥°å™¨**

å½“æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨è£…é¥°å™¨ï¼š

1. **ä¸æ¶‰åŠèµ„æºç®¡ç†**ï¼ˆå¦‚æ— éœ€ `try-finally`ï¼‰
2. **ä¸éœ€è¦è®¿é—®è¯·æ±‚/å“åº”å¯¹è±¡**
3. **é€»è¾‘ç®€å•**ä¸”ä¸éœ€è¦ä¸ FastAPI çš„å…¶ä»–ç»„ä»¶ï¼ˆå¦‚ä¾èµ–ã€ä¸­é—´ä»¶ï¼‰é›†æˆ
4. **éœ€è¦å…¼å®¹ä¼ ç»Ÿ Flask/Django ä»£ç **

**ç¤ºä¾‹ï¼šå‡½æ•°ç»“æœç¼“å­˜**

```python
def cache_result(func):
    cache = {}
    async def wrapper(*args, **kwargs):
        key = str(args) + str(kwargs)
        if key in cache:
            return cache[key]
        result = await func(*args, **kwargs)
        cache[key] = result
        return result
    return wrapper

@app.get("/data/")
@cache_result
async def get_data():
    return expensive_computation()
```

### **äº”ã€ä¾èµ–æ³¨å…¥ä¸è£…é¥°å™¨çš„ç»“åˆä½¿ç”¨**

å®é™…ä¸Šï¼ŒFastAPI çš„ `Depends` æœ¬èº«å°±æ˜¯ä¸€ç§ç‰¹æ®Šçš„è£…é¥°å™¨æ¨¡å¼ï¼ä½ å¯ä»¥ç»“åˆä¸¤è€…ï¼š

```python
# å®šä¹‰ä¸€ä¸ªå¯ä»¥ä½œä¸ºä¾èµ–çš„è£…é¥°å™¨
class ValidatePermission:
    def __init__(self, permission: str):
        self.permission = permission
    
    def __call__(self, user: User = Depends(get_current_user)):
        if self.permission not in user.permissions:
            raise HTTPException(403)
        return user

# åœ¨è·¯ç”±ä¸­ä½¿ç”¨
@app.get("/admin/")
async def admin_route(user: User = Depends(ValidatePermission("admin"))):
    return {"message": f"æ¬¢è¿ {user.name}"}
```

### **æ€»ç»“ï¼šä¸ºä»€ä¹ˆ FastAPI æ›´æ¨èä¾èµ–æ³¨å…¥**

ä¾èµ–æ³¨å…¥ç›¸æ¯”ä¼ ç»Ÿè£…é¥°å™¨æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

1. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼šé€šè¿‡ `yield` è‡ªåŠ¨å¤„ç†èµ„æºé‡Šæ”¾
2. **å‚æ•°æ³¨å…¥**ï¼šç›´æ¥ä½œä¸ºå‡½æ•°å‚æ•°ï¼Œæ— éœ€ä» request ä¸­æ‰‹åŠ¨æå–
3. **ä¾èµ–é“¾è§£æ**ï¼šè‡ªåŠ¨å¤„ç†åµŒå¥—ä¾èµ–ï¼Œé¿å…å¤šå±‚è£…é¥°å™¨åµŒå¥—
4. **æµ‹è¯•å‹å¥½**ï¼šå¯ä»¥è½»æ¾æ›¿æ¢ä¾èµ–å®ç°ï¼Œæ— éœ€æ¨¡æ‹Ÿå‡½æ•°è°ƒç”¨
5. **æ–‡æ¡£é›†æˆ**ï¼šå‚æ•°è‡ªåŠ¨åŒ…å«åœ¨ OpenAPI æ–‡æ¡£ä¸­

å¦‚æœä½ æ¥è‡ª Flask/Django èƒŒæ™¯ï¼Œåˆšå¼€å§‹å¯èƒ½æ›´ä¹ æƒ¯ç”¨è£…é¥°å™¨ï¼Œä½†å°è¯•ä¾èµ–æ³¨å…¥åï¼Œä½ å¯èƒ½ä¼šå‘ç°å®ƒæ›´ç¬¦åˆ FastAPI çš„è®¾è®¡å“²å­¦ï¼Œä»£ç ä¹Ÿä¼šæ›´åŠ ç®€æ´å’Œå¯ç»´æŠ¤ã€‚

ä»¥ä¸‹æ˜¯ä¸€äº›åº”ç”¨ç¤ºä¾‹ã€‚

## **å››ã€ä¾èµ–æ³¨å…¥çš„ä¸‰å¤§â€œè¶…èƒ½åŠ›â€**

### **1. å¤æ‚ä¾èµ–é“¾è‡ªåŠ¨è§£æ**  

æ¯”å¦‚è®¤è¯æµç¨‹ï¼šéªŒè¯ Token â†’ è·å–ç”¨æˆ· â†’ æ£€æŸ¥æƒé™ã€‚  

```python
def verify_token(x_token: str = Header(...)):  # ä»Headerè·å–Token
    if x_token != "valid": raise HTTPException(401)
    return x_token

def get_user(token: str = Depends(verify_token)):  # ä¾èµ–TokenéªŒè¯
    return db.query(User).filter_by(token=token).first()

def check_admin(user: User = Depends(get_user)):  # ä¾èµ–ç”¨æˆ·å¯¹è±¡
    if user.role != "admin": raise HTTPException(403)

@app.get("/admin/")
async def admin_route(_=Depends(check_admin)):  # åªéœ€å£°æ˜æœ€ç»ˆä¾èµ–
    return {"message": "ç®¡ç†å‘˜ä¸“å±"}
```  

æ¡†æ¶ä¼šè‡ªåŠ¨æŒ‰é¡ºåºæ‰§è¡Œ`verify_token â†’ get_user â†’ check_admin`ï¼Œæ— éœ€æ‰‹åŠ¨ä¼ é€’å‚æ•°ã€‚

### **2. å¼‚æ­¥ä¸åŒæ­¥æ— ç¼æ··åˆ**  

FastAPI æ”¯æŒåŒæ­¥/å¼‚æ­¥ä¾èµ–è‡ªç”±æ··åˆï¼Œæ¯”å¦‚åŒæ—¶ä½¿ç”¨åŒæ­¥æ•°æ®åº“å’Œå¼‚æ­¥ Redisï¼š  

```python
async def get_redis():  # å¼‚æ­¥ä¾èµ–ï¼ˆRedisè¿æ¥ï¼‰
    redis = await aioredis.connect()
    try: yield redis
    finally: await redis.close()

def get_db():  # åŒæ­¥ä¾èµ–ï¼ˆæ•°æ®åº“ä¼šè¯ï¼‰
    db = SessionLocal()
    try: yield db
    finally: db.close()

@app.get("/data/")
async def get_data(
    redis=Depends(get_redis),  # å¼‚æ­¥ä¾èµ–
    db=Depends(get_db)        # åŒæ­¥ä¾èµ–
):
    return {"redis_data": await redis.get("key"), "db_data": db.query(Item).first()}
```

### **3. æµ‹è¯•éš”ç¦»ï¼šä¸€é”®æ›¿æ¢çœŸå®ä¾èµ–**  

æµ‹è¯•æ—¶ç”¨æ¨¡æ‹Ÿå¯¹è±¡ä»£æ›¿çœŸå®æ•°æ®åº“ APIï¼š  

```python
def mock_db():  # æ¨¡æ‹Ÿæ•°æ®åº“
    return Mock()

app.dependency_overrides[get_db] = mock_db  # æ›¿æ¢ä¾èµ–
```  

æ— éœ€ä¿®æ”¹è·¯ç”±ä»£ç ï¼Œæµ‹è¯•æ›´ç®€å•é«˜æ•ˆã€‚

## **äº”ã€å¯¹æ¯” Flask/Djangoï¼šä¸ºä»€ä¹ˆ FastAPI çš„ä¾èµ–æ³¨å…¥æ›´ç®€å•**

å¦‚æœä½ ç†Ÿæ‚‰ Flask/Djangoï¼Œå¯èƒ½ä¼šè§‰å¾—ä¾èµ–æ³¨å…¥åƒå®ƒä»¬çš„â€œä¸­é—´ä»¶â€æˆ–â€œè¯·æ±‚é’©å­â€ï¼Œä½† FastAPI åšäº†ä¸‰å¤§å‡çº§ï¼š  

1. **å±€éƒ¨åŒ–æ§åˆ¶**ï¼šå¯ä»¥ç»™å•ä¸ªè·¯ç”±æˆ–è·¯ç”±ç»„å•ç‹¬æ·»åŠ ä¾èµ–ï¼Œæ— éœ€å…¨å±€ç”Ÿæ•ˆã€‚  
2. **å‚æ•°ç›´æ¥æ³¨å…¥**ï¼šä¾èµ–çš„è¿”å›å€¼ç›´æ¥ä½œä¸ºå‡½æ•°å‚æ•°ï¼Œæ— éœ€é€šè¿‡å…¨å±€å˜é‡ï¼ˆå¦‚ Flask çš„`g`å¯¹è±¡ï¼‰ä¼ é€’ã€‚  
3. **ç”Ÿå‘½å‘¨æœŸç®¡ç†**ï¼š`yield`è‡ªåŠ¨å¤„ç†èµ„æºé‡Šæ”¾ï¼Œå‘Šåˆ«æ‰‹åŠ¨å…³é—­è¿æ¥çš„çƒ¦æ¼ã€‚

### **Flask/Django vs FastAPIï¼šå¯¹æ¯”**  

| **åœºæ™¯**         | Flaskï¼ˆè¯·æ±‚é’©å­ï¼‰              | FastAPIï¼ˆä¾èµ–æ³¨å…¥ï¼‰            |  
|------------------|-----------------------------|-----------------------------|  
| è®°å½•è¯·æ±‚è€—æ—¶       | éœ€åœ¨`before_request`å’Œ`after_request`åˆ†å¼€å†™ | ä¸€ä¸ªä¾èµ–å‡½æ•°ç”¨`yield`ç»Ÿä¸€å¤„ç† |  
| ä¼ é€’ç”¨æˆ·ä¿¡æ¯       | é€šè¿‡å…¨å±€`g`å¯¹è±¡              | ä¾èµ–å‡½æ•°ç›´æ¥è¿”å›ç”¨æˆ·å¯¹è±¡å¹¶æ³¨å…¥ |  
| æŒ‰éœ€åº”ç”¨ï¼ˆä»…éƒ¨åˆ†è·¯ç”±ï¼‰ | éœ€åœ¨è“å›¾æˆ–è·¯ç”±ä¸­å•ç‹¬æ·»åŠ é’©å­       | ç”¨`dependencies`å‚æ•°å•ç‹¬å£°æ˜    |  

#### å°†ä¸­é—´ä»¶è½¬æ¢ä¸ºä¾èµ–

```python
# Django ä¸­é—´ä»¶
class AuthMiddleware:
    def __call__(self, request):
        user = authenticate(request)
        request.user = user
        return self.get_response(request)

# FastAPI ä¾èµ–
def get_current_user(request: Request):
    user = authenticate(request)
    return user
```

#### å°†å…¨å±€é’©å­è½¬æ¢ä¸ºä¾èµ–

```python
# Flask é’©å­
@app.before_request
def check_auth():
    if not is_authenticated(request):
        abort(401)

# FastAPI ä¾èµ–
def verify_auth(request: Request):
    if not is_authenticated(request):
        raise HTTPException(401)
```

#### åˆ©ç”¨ä¾èµ–æ³¨å…¥ç®€åŒ–ä»£ç 

```python
#Flask ä»£ç 
@app.route("/items/")
def get_items():
    db = get_db()  # æ‰‹åŠ¨è·å–æ•°æ®åº“è¿æ¥
    user = get_current_user()  # æ‰‹åŠ¨è·å–ç”¨æˆ·
    items = db.query(Items).filter(owner=user.id).all()
    return jsonify([item.to_dict() for item in items])


#FastAPI ä»£ç 
@app.get("/items/")
async def get_items(db: Session = Depends(get_db), 
                  user: User = Depends(get_current_user)):
    items = db.query(Items).filter(owner=user.id).all()
    return items
```

## **å…­ã€åˆå­¦è€…å¦‚ä½•ä¸Šæ‰‹ï¼Ÿä»ä¸‰ä¸ªå°ç»ƒä¹ å¼€å§‹**

1. **ç»ƒä¹  1ï¼šæœ€ç®€å•çš„ä¾èµ–â€”â€”è®°å½•è¯·æ±‚è·¯å¾„**  

   ```python
   from fastapi import Depends, FastAPI

   app = FastAPI()

   def log_path():
       print(f"è®¿é—®è·¯å¾„ï¼š{request.url.path}")  # æ³¨æ„ï¼šéœ€ä»å‡½æ•°å‚æ•°è·å–request

   @app.get("/hello/")
   async def hello(request: Request, _=Depends(log_path)):  # æ˜¾å¼ä¼ å…¥request
       return {"message": "Hello"}
   ```

2. **ç»ƒä¹  2ï¼šç®¡ç†æ•°æ®åº“ä¼šè¯â€”â€”ç”¨`yield`è‡ªåŠ¨å…³é—­è¿æ¥**  

   ```python
   from sqlalchemy import create_engine
   from sqlalchemy.orm import sessionmaker

   engine = create_engine("sqlite:///test.db")
   SessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine)

   def get_db():
       db = SessionLocal()
       try: yield db
       finally: db.close()

   @app.get("/items/")
   async def read_items(db=Depends(get_db)):
       return db.query(Item).all()
   ```

3. **ç»ƒä¹  3ï¼šå¼‚æ­¥ä¾èµ–â€”â€”è·å– Redis æ•°æ®**  

   ```python
   import aioredis

   async def get_redis():
       redis = await aioredis.from_url("redis://localhost")
       try: yield redis
       finally: await redis.close()

   @app.get("/cache/")
   async def get_cache(redis=Depends(get_redis)):
       return await redis.get("key")
   ```

## **ä¸ƒã€æ€»ç»“ï¼šä¾èµ–æ³¨å…¥è®©å¼€å‘æ›´â€œæ‡’â€å´æ›´é«˜æ•ˆ**

FastAPI çš„ä¾èµ–æ³¨å…¥ä¸æ˜¯è®©ä½ å†™æ›´å¤šä»£ç ï¼Œè€Œæ˜¯è®©ä½ â€œå°‘å†™é‡å¤ä»£ç â€ï¼š  

* **å£°æ˜å¼ç¼–ç¨‹**ï¼šåªéœ€è¯´â€œæˆ‘éœ€è¦æ•°æ®åº“ä¼šè¯â€ï¼Œä¸ç”¨å…³å¿ƒæ€ä¹ˆåˆ›å»ºå’Œå…³é—­ã€‚  
* **æ™ºèƒ½ç»„è£…**ï¼šæ¡†æ¶è‡ªåŠ¨å¤„ç†ä¾èµ–é“¾ï¼Œåƒæ‹¼ä¹é«˜ä¸€æ ·ç»„åˆåŠŸèƒ½ã€‚  
* **å¼€ç®±å³ç”¨**ï¼šå…¼å®¹å¼‚æ­¥/åŒæ­¥ï¼Œæ— ç¼é›†æˆå‚æ•°æ ¡éªŒã€æ–‡æ¡£ç”Ÿæˆå’Œæµ‹è¯•ã€‚

å¦‚æœä½ æ›¾ä¸ºé‡å¤ä»£ç å¤´ç–¼ï¼Œæˆ–æ˜¯æƒ³è®© API æ›´å¥å£®æ˜“ç»´æŠ¤ï¼Œä¾èµ–æ³¨å…¥å°±æ˜¯ FastAPI é€ç»™ä½ çš„â€œä»£ç ç®€åŒ–ç¥å™¨â€ã€‚ä»ç°åœ¨å¼€å§‹ï¼Œè¯•è¯•ç”¨`Depends()`ä»£æ›¿æ‰‹åŠ¨è°ƒç”¨ï¼Œè®©æ¡†æ¶å¸®ä½ å¤„ç†é‚£äº›â€œéº»çƒ¦äº‹â€å§ï¼
