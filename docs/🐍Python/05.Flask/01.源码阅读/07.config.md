---
title: Flask æºç è§£æï¼šConfig

tags: 
  - Flask
  - web å¼€å‘
  - Python
categories: 
  - ğŸ’» å·¥ä½œ
  - ğŸPython
  - Flask
  - æºç é˜…è¯»
date: 2019-08-26 12:27:56
permalink: /pages/16eed0/
---

Flask é…ç½®å¯¼å…¥å¯¹äºå…¶ä»–é¡¹ç›®çš„é…ç½®å¯¼å…¥æœ‰å¾ˆå¥½çš„å€Ÿé‰´æ„ä¹‰ï¼Œæ‰€ä»¥æˆ‘è¿™é‡Œè¿˜æ˜¯ä½œä¸ºä¸€ä¸ªå•ç‹¬çš„ç« èŠ‚è¿›è¡Œæºç å­¦ä¹ ã€‚Flask å¸¸ç”¨çš„å››ç§æ–¹å¼è¿›è¡Œé¡¹ç›®å‚æ•°çš„é…ç½®ï¼Œå¦‚ä¾‹æ‰€ç¤º:

1. ç›´æ¥é…ç½®å‚æ•°
```python
app.config['SECRET_KEY'] = 'YOUCANNOTGUESSME'
```
2. ä»ç¯å¢ƒå˜é‡ä¸­è·å¾—é…ç½®æ–‡ä»¶åå¹¶å¯¼å…¥é…ç½®å‚æ•°
```bash
export MyAppConfig=/path/to/settings.cfg #linux
set MyAppConfig=d:\settings.cfg#ä¸èƒ½ç«‹å³ç”Ÿæ•ˆï¼Œä¸å»ºè®®windowsä¸‹é€šè¿‡è¿™ç§æ–¹å¼è·å¾—ç¯å¢ƒå˜é‡ã€‚
app.config.from_envvar('MyAppConfig')
```
3. ä»å¯¹è±¡ä¸­è·å¾—é…ç½®
```python
class Config(object):
    DEBUG = False
    TESTING = False
    DATABASE_URI = 'sqlite://:memory:'
class ProductionConfig(Config):
    DATABASE_URI = 'mysql://user@localhost/foo'
app.config.from_object(ProductionConfig)
print app.config.get('DATABASE_URI')
```
4. ä»æ–‡ä»¶ä¸­è·å¾—é…ç½®å‚æ•°
```plain
# default_config.py
HOST = 'localhost'
PORT = 5000
DEBUG = True

# flaskä¸­ä½¿ç”¨
app.config.from_pyfile('default_config.py')
```
Flask å·²ç»é»˜è®¤è‡ªå¸¦çš„é…ç½®åŒ…æ‹¬ï¼š
```plain
['JSON_AS_ASCII', 'USE_X_SENDFILE', 'SESSION_COOKIE_PATH', 'SESSION_COOKIE_DOMAIN', 'SESSION_COOKIE_NAME', 'SESSION_REFRESH_EACH_REQUEST', 'LOGGER_HANDLER_POLICY', 'LOGGER_NAME', 'DEBUG', 'SECRET_KEY', 'EXPLAIN_TEMPLATE_LOADING', 'MAX_CONTENT_LENGTH', 'APPLICATION_ROOT', 'SERVER_NAME', 'PREFERRED_URL_SCHEME', 'JSONIFY_PRETTYPRINT_REGULAR', 'TESTING', 'PERMANENT_SESSION_LIFETIME', 'PROPAGATE_EXCEPTIONS', 'TEMPLATES_AUTO_RELOAD', 'TRAP_BAD_REQUEST_ERRORS', 'JSON_SORT_KEYS', 'JSONIFY_MIMETYPE', 'SESSION_COOKIE_HTTPONLY', 'SEND_FILE_MAX_AGE_DEFAULT', 'PRESERVE_CONTEXT_ON_EXCEPTION', 'SESSION_COOKIE_SECURE', 'TRAP_HTTP_EXCEPTIONS']
```
å…¶ä¸­å…³äº debug è¿™ä¸ªå‚æ•°è¦ç‰¹åˆ«çš„è¿›è¡Œè¯´æ˜ï¼Œå½“æˆ‘ä»¬è®¾ç½®ä¸º app.config["DEBUG"]=True æ—¶å€™ï¼Œflask æœåŠ¡å¯åŠ¨åè¿›å…¥è°ƒè¯•æ¨¡å¼ï¼Œåœ¨è°ƒè¯•æ¨¡å¼ä¸‹æœåŠ¡å™¨çš„å†…éƒ¨é”™è¯¯ä¼šå±•ç¤ºåˆ° web å‰å°ï¼Œä¸¾ä¾‹è¯´æ˜:

```python
app.config["DEBUG"]=True

@app.route('/')
def hello_world():
    a=3/0
    return 'Hello World!'
```
æ‰“å¼€é¡µé¢æˆ‘ä»¬ä¼šçœ‹åˆ°
![flaské”™è¯¯ä¿¡æ¯](https://cdn.jsdelivr.net/gh/masantu/statics/images/849997-20171011132245934-888527208.png)
é™¤äº†æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ä»¥å¤–ï¼ŒFlask è¿˜æ”¯æŒä» web ä¸­æä¾› console è¿›è¡Œè°ƒè¯•ï¼ˆéœ€è¦è¾“å…¥ pin ç ï¼‰ï¼Œç ´è§£ pin ç å¾ˆç®€å•ï¼Œè¿™æ„å‘³ç€ç”¨æˆ·å¯ä»¥å¯¹éƒ¨ç½²æœåŠ¡å™¨æ‰§è¡Œä»»æ„çš„ä»£ç ï¼Œæ‰€ä»¥å¦‚æœ Flask å‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒï¼Œå¿…é¡»ç¡®ä¿ DEBUG=Falseã€‚
å—¯ï¼Œæœ‰ç©ºå†å†™ä¸€ç¯‡å…³äº Flask çš„å®‰å…¨ç¯‡ã€‚å¦å¤–ï¼Œå…³äºå¦‚ä½•é…ç½® Flask å‚æ•°è®©ç½‘ç«™æ›´åŠ å®‰å…¨ï¼Œå¯ä»¥å‚è€ƒ[è¿™ç¯‡åšæ–‡](http://www.cnblogs.com/m0m0/p/5624315.html)ï¼Œå†™çš„å¾ˆå¥½ã€‚
æ¥ä¸‹æ¥ç»§ç»­ç ”ç©¶ Flask æºç ä¸­å…³äºé…ç½®çš„éƒ¨åˆ†ã€‚å¯ä»¥å‘ç° config æ˜¯ app çš„ä¸€ä¸ªå±æ€§ï¼Œè€Œ app æ˜¯ Flask ç±»çš„ä¸€ä¸ªç¤ºä¾‹ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡ app.config["DEBUG"]=True æ¥è®¾ç½®å±æ€§ï¼Œå¯ä»¥å¤§èƒ†çŒœæµ‹ config åº”è¯¥æ˜¯ä¸€ä¸ªå­—å…¸ç±»å‹çš„ç±»å±æ€§å˜é‡ï¼Œè¿™ä¸€ç‚¹åœ¨æºç ä¸­éªŒè¯äº†ï¼š
```python
#: The configuration dictionary as :class:`Config`.  This behaves
#: exactly like a regular dictionary but supports additional methods
#: to load a config from files.
self.config = self.make_config(instance_relative_config)
```
æˆ‘ä»¬è¿›ä¸€æ­¥çœ‹çœ‹ make_config å‡½æ•°çš„å®šä¹‰:

```python
def make_config(self, instance_relative=False):
    """Used to create the config attribute by the Flask constructor.
    The `instance_relative` parameter is passed in from the constructor
    of Flask (there named `instance_relative_config`) and indicates if
    the config should be relative to the instance path or the root path
    of the application.

    .. versionadded:: 0.8
    """
    root_path = self.root_path
    if instance_relative:
        root_path = self.instance_path
    return self.config_class(root_path, self.default_config)

config_class = Config
```
å…¶ä¸­æœ‰ä¸¤ä¸ªè·¯å¾„è¦é€‰æ‹©å…¶ä¸­ä¸€ä¸ªä½œä¸ºé…ç½®å¯¼å…¥çš„é»˜è®¤è·¯å¾„ï¼Œè¿™ä¸ªç”¨æ³•åœ¨ä¸Šé¢æ¨èçš„åšæ–‡ä¸­ç”¨åˆ°è¿‡ï¼Œæ„Ÿå…´è¶£çš„çœ‹çœ‹ï¼Œmake_config çœŸæ­£åŠŸèƒ½æ˜¯è¿”å› config_class çš„å‡½æ•°ï¼Œè€Œè¿™ä¸ªå‡½æ•°ç›´æ¥æŒ‡å‘ Config ç±»ï¼Œä¹Ÿå°±æ˜¯è¯´ make_config è¿”å›çš„æ˜¯ Config ç±»çš„å®ä¾‹ã€‚ä¼¼ä¹è¿™é‡Œé¢æœ‰ä¸€äº›è®¾è®¡æ¨¡å¼åœ¨é‡Œé¢ï¼Œåç»­å†ç ”ç©¶ä¸€ä¸‹ã€‚æ¥ä¸‹æ¥æ˜¯ Config ç±»çš„å®šä¹‰ï¼š
```python
class Config(dict):
      def __init__(self, root_path, defaults=None):
        dict.__init__(self, defaults or {})
        self.root_path = root_path
```
root_path ä»£è¡¨çš„æ˜¯é¡¹ç›®é…ç½®æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ã€‚defaults æ˜¯ Flask é»˜è®¤çš„å‚æ•°ï¼Œç”¨çš„æ˜¯ immutabledict æ•°æ®ç»“æ„ï¼Œæ˜¯ dict çš„å­ç±»ï¼Œå…¶ä¸­ default ä¸­å®šä¹‰ä¸ºï¼š

```plain
#: Default configuration parameters.
    default_config = ImmutableDict({
        'DEBUG':                                get_debug_flag(default=False),
        'TESTING':                              False,
        'PROPAGATE_EXCEPTIONS':                None,
        'PRESERVE_CONTEXT_ON_EXCEPTION':        None,
        'SECRET_KEY':                          None,
        'PERMANENT_SESSION_LIFETIME':          timedelta(days=31),
        'USE_X_SENDFILE':                      False,
        'LOGGER_NAME':                          None,
        'LOGGER_HANDLER_POLICY':              'always',
        'SERVER_NAME':                          None,
        'APPLICATION_ROOT':                    None,
        'SESSION_COOKIE_NAME':                  'session',
        'SESSION_COOKIE_DOMAIN':                None,
        'SESSION_COOKIE_PATH':                  None,
        'SESSION_COOKIE_HTTPONLY':              True,
        'SESSION_COOKIE_SECURE':                False,
        'SESSION_REFRESH_EACH_REQUEST':        True,
        'MAX_CONTENT_LENGTH':                  None,
        'SEND_FILE_MAX_AGE_DEFAULT':            timedelta(hours=12),
        'TRAP_BAD_REQUEST_ERRORS':              False,
        'TRAP_HTTP_EXCEPTIONS':                False,
        'EXPLAIN_TEMPLATE_LOADING':            False,
        'PREFERRED_URL_SCHEME':                'http',
        'JSON_AS_ASCII':                        True,
        'JSON_SORT_KEYS':                      True,
        'JSONIFY_PRETTYPRINT_REGULAR':          True,
        'JSONIFY_MIMETYPE':                    'application/json',
        'TEMPLATES_AUTO_RELOAD':                None,
    })

```
æˆ‘ä»¬å†çœ‹çœ‹ Config çš„ä¸‰ä¸ªå¯¼å…¥å‡½æ•° from_envvar,from_pyfile, from_objectã€‚from_envvar ç›¸å½“äºåœ¨ from_pyfile å¤–é¢åŒ…äº†ä¸€å±‚å£³å­ï¼Œä»ç¯å¢ƒå˜é‡ä¸­è·å¾—ï¼Œå…¶å‡½æ•°æ³¨é‡Šä¸­ä¹Ÿæåˆ°äº†è¿™ä¸€ç‚¹ã€‚è€Œ from_pyfile æœ€ç»ˆä¹Ÿæ˜¯è°ƒç”¨ from_objectã€‚æ‰€ä»¥æˆ‘ä»¬çš„é‡ç‚¹æ˜¯çœ‹ from_object è¿™ä¸ªå‡½æ•°çš„ç»†èŠ‚ã€‚
from_pyfile æºç ä¸­æœ‰ä¸€å¥ç‰¹åˆ«éš¾æ‡‚ï¼Œå¦‚ä¸‹ã€‚config_file æ˜¯è¯»å–çš„æ–‡ä»¶å¤´ï¼Œfile_name æ˜¯æ–‡ä»¶åç§°ã€‚
```python
exec(compile(config_file.read(), filename, 'exec'), d.__dict__)
```
`__dict__`æ˜¯ python çš„å†…ç½®å±æ€§ï¼ŒåŒ…å«äº†è¯¥å¯¹è±¡ï¼ˆpython ä¸‡äº‹ä¸‡ç‰©éƒ½æ˜¯å¯¹è±¡ï¼‰çš„å±æ€§å˜é‡ã€‚ç±»çš„å®ä¾‹å¯¹è±¡çš„__dict__åªåŒ…æ‹¬ç±»å®ä¾‹åçš„å˜é‡ï¼Œè€Œç±»å¯¹è±¡æœ¬èº«çš„__dict__è¿˜åŒ…æ‹¬åŒ…æ‹¬ä¸€äº›ç±»å†…ç½®å±æ€§å’Œç±»å˜é‡ clsvar ä»¥åŠæ„é€ æ–¹æ³•__initã€‚
å†ç†è§£ exec å‡½æ•°ï¼Œexec è¯­å¥ç”¨æ¥æ‰§è¡Œå­˜å‚¨åœ¨ä»£ç å¯¹è±¡ã€å­—ç¬¦ä¸²ã€æ–‡ä»¶ä¸­çš„ Python è¯­å¥ï¼Œeval è¯­å¥ç”¨æ¥è®¡ç®—å­˜å‚¨åœ¨ä»£ç å¯¹è±¡æˆ–å­—ç¬¦ä¸²ä¸­çš„æœ‰æ•ˆçš„ Python è¡¨è¾¾å¼ï¼Œè€Œ compile è¯­å¥åˆ™æä¾›äº†å­—èŠ‚ç¼–ç çš„é¢„ç¼–è¯‘ã€‚ï¼š
```python
exec(object[, globals[, locals]]) #å†…ç½®å‡½æ•°
```
å…¶ä¸­å‚æ•° obejctobj å¯¹è±¡å¯ä»¥æ˜¯å­—ç¬¦ä¸²ï¼ˆå¦‚å•ä¸€è¯­å¥ã€è¯­å¥å—ï¼‰ï¼Œæ–‡ä»¶å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥æ˜¯å·²ç»ç”± compile é¢„ç¼–è¯‘è¿‡çš„ä»£ç å¯¹è±¡ï¼Œæœ¬æ–‡å°±æ˜¯æœ€åä¸€ç§ã€‚å‚æ•° globals æ˜¯å…¨å±€å‘½åç©ºé—´ï¼Œç”¨æ¥æŒ‡å®šæ‰§è¡Œè¯­å¥æ—¶å¯ä»¥è®¿é—®çš„å…¨å±€å‘½åç©ºé—´ï¼›å‚æ•° locals æ˜¯å±€éƒ¨å‘½åç©ºé—´ï¼Œç”¨æ¥æŒ‡å®šæ‰§è¡Œè¯­å¥æ—¶å¯ä»¥è®¿é—®çš„å±€éƒ¨ä½œç”¨åŸŸçš„å‘½åç©ºé—´ã€‚æŒ‰ç…§è¿™ä¸ªè§£é‡Šï¼Œä¸Šè¿°çš„è¯­å¥å…¶å®æ˜¯è½¬åŒ–æˆäº†è¿™ä¸ªè¯­æ³•ï¼š
```python
import types
var2=types.ModuleType("test")
exec("A='bb'",var2.__dict__)
```
æŠŠé…ç½®æ–‡ä»¶ä¸­å®šä¹‰çš„å‚æ•°å†™å…¥åˆ°äº†å®šä¹‰ä¸º config Module ç±»å‹çš„å˜é‡ d çš„å†…ç½®å±æ€§__dict__ä¸­ã€‚
å†çœ‹çœ‹ complie å‡½æ•° compile( str, file, type )ï¼Œ
compile è¯­å¥æ˜¯ä» type ç±»å‹ï¼ˆåŒ…æ‹¬â€™evalâ€™: é…åˆ eval ä½¿ç”¨ï¼Œâ€™singleâ€™: é…åˆå•ä¸€è¯­å¥çš„ exec ä½¿ç”¨ï¼Œâ€™execâ€™: é…åˆå¤šè¯­å¥çš„ exec ä½¿ç”¨ï¼‰ä¸­å°† str é‡Œé¢çš„è¯­å¥åˆ›å»ºæˆä»£ç å¯¹è±¡ã€‚file æ˜¯ä»£ç å­˜æ”¾çš„åœ°æ–¹ï¼Œé€šå¸¸ä¸ºâ€ã€‚compile è¯­å¥çš„ç›®çš„æ˜¯æä¾›ä¸€æ¬¡æ€§çš„å­—èŠ‚ç ç¼–è¯‘ï¼Œå°±ä¸ç”¨åœ¨ä»¥åçš„æ¯æ¬¡è°ƒç”¨ä¸­é‡æ–°è¿›è¡Œç¼–è¯‘äº†ã€‚

from_object æºç ä¸­å°†è¾“å…¥çš„å‚æ•°è¿›è¡Œç±»å‹åˆ¤æ–­ï¼Œå¦‚æœæ˜¯ object ç±»å‹çš„ï¼Œåˆ™è¯´æ˜æ˜¯é€šè¿‡ from_pyfile ä¸­ä¼ è¿‡æ¥çš„ï¼Œåªè¦éå† from_pyfile ä¼ è¾“è¿‡æ¥çš„ d æ¯”å˜é‡çš„å†…ç½®å±æ€§__dict__å³å¯ã€‚å¦‚æœè¾“å…¥çš„ string ç±»å‹ï¼Œæ„å‘³ç€è¿™ä¸ªæ˜¯è¦ä»é»˜è®¤çš„ config.py æ–‡ä»¶ä¸­å¯¼å…¥ï¼Œç”¨æˆ·éœ€è¦è¾“å…¥ app.config.from_object("config")è¿›è¡Œæ˜ç¡®ï¼Œè¿™æ—¶å€™æ ¹æ® config ç›´æ¥å¯¼å…¥ config.py é…ç½®ã€‚

å…·ä½“çš„æºç ç»†èŠ‚å¦‚ä¸‹ï¼š

```python
def from_envvar(self, variable_name, silent=False):
    rv = os.environ.get(variable_name)
    if not rv:
        if silent:
            return False
        raise RuntimeError('The environment variable %r is not set '
                          'and as such configuration could not be '
                          'loaded.  Set this variable and make it '
                          'point to a configuration file' %
                          variable_name)
    return self.from_pyfile(rv, silent=silent)


def from_pyfile(self, filename, silent=False):
    filename = os.path.join(self.root_path, filename)
    d = types.ModuleType('config')
    d.__file__ = filename
    try:
        with open(filename) as config_file:
            exec (compile(config_file.read(), filename, 'exec'), d.__dict__)
    except IOError as e:
        if silent and e.errno in (errno.ENOENT, errno.EISDIR):
            return False
        e.strerror = 'Unable to load configuration file (%s)' % e.strerror
        raise
    self.from_object(d)
    return True


def from_object(self, obj):
    """Updates the values from the given object.  An object can be of one
    of the following two types:

    -  a string: in this case the object with that name will be imported
    -  an actual object reference: that object is used directly

    Objects are usually either modules or classes. :meth:`from_object`
    loads only the uppercase attributes of the module/class. A ``dict``
    object will not work with :meth:`from_object` because the keys of a
    ``dict`` are not attributes of the ``dict`` class.

    Example of module-based configuration::

        app.config.from_object('yourapplication.default_config')
        from yourapplication import default_config
        app.config.from_object(default_config)

    You should not use this function to load the actual configuration but
    rather configuration defaults.  The actual config should be loaded
    with :meth:`from_pyfile` and ideally from a location not within the
    package because the package might be installed system wide.

    See :ref:`config-dev-prod` for an example of class-based configuration
    using :meth:`from_object`.

    :param obj: an import name or object
    """
    if isinstance(obj, string_types):
        obj = import_string(obj)
    for key in dir(obj):
        if key.isupper():
            self[key] = getattr(obj, key)
```
æ ¹æ®æºç åˆ†æï¼Œfrom_envvar å’Œ from_pyfile ä¸¤ä¸ªå‡½æ•°çš„è¾“å…¥é…ç½®æ–‡ä»¶å¿…é¡»æ˜¯å¯ä»¥æ‰§è¡Œçš„ py æ–‡ä»¶ï¼Œpy æ–‡ä»¶ä¸­å˜é‡åå¿…é¡»æ˜¯å¤§å†™ï¼Œåªæœ‰è¿™æ ·é…ç½®å˜é‡å‚æ•°æ‰èƒ½é¡ºåˆ©çš„å¯¼å…¥åˆ° Flask ä¸­ã€‚

## å‚è€ƒé“¾æ¥
[Python flask ä¸­çš„é…ç½® - Python åˆå­¦è€… - åšå®¢å›­](https://www.cnblogs.com/m0m0/p/5624315.html)
