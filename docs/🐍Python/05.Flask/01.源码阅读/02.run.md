---
title: Flask æºç è§£æï¼šåº”ç”¨å¯åŠ¨æµç¨‹
tags: 
  - Flask
  - web å¼€å‘
  - Python
categories: 
  - ğŸ’»å·¥ä½œ
  - ğŸPython
  - Flask
  - æºç é˜…è¯»
date: 2019-08-21 12:27:56
permalink: /flask-insight-start-process/
---
è¿™æ˜¯ Flask æºç è§£æç³»åˆ—æ–‡ç« çš„å…¶ä¸­ä¸€ç¯‡ï¼Œæœ¬ç³»åˆ—æ‰€æœ‰æ–‡ç« åˆ—è¡¨ï¼š

*   [Flask æºç è§£æï¼šç®€ä»‹](/flask-insight-introduction)
*   [Flask æºç è§£æï¼šåº”ç”¨å¯åŠ¨æµç¨‹](/flask-insight-start-process)
*   [Flask æºç è§£æï¼šè·¯ç”±](/flask-insight-routing)
*   [Flask æºç è§£æï¼šä¸Šä¸‹æ–‡](/flask-insight-context)
*   [Flask æºç è§£æï¼šè¯·æ±‚](/flask-insight-request)
*   [Flask æºç è§£æï¼šå“åº”](/flask-insight-response)
*   [Flask æºç è§£æï¼šé…ç½®](/flask-insight-config)
*   [Flask æºç è§£æï¼šsession](/flask-insight-session)

## WSGI

æ‰€æœ‰çš„ python web æ¡†æ¶éƒ½è¦éµå¾ª WSGI åè®®ï¼Œå¦‚æœå¯¹ WSGI ä¸æ¸…æ¥šï¼Œå¯ä»¥æŸ¥çœ‹æˆ‘[ä¹‹å‰çš„ä»‹ç»æ–‡ç« ](https://cizixs.com/2014/11/08/understand-wsgi)ã€‚

åœ¨è¿™é‡Œè¿˜æ˜¯è¦ç®€å•å›é¡¾ä¸€ä¸‹ WSGI çš„æ ¸å¿ƒæ¦‚å¿µã€‚

WSGI ä¸­æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼šæ¯ä¸ª python web åº”ç”¨éƒ½æ˜¯ä¸€ä¸ªå¯è°ƒç”¨ï¼ˆcallableï¼‰çš„å¯¹è±¡ã€‚åœ¨ flask ä¸­ï¼Œè¿™ä¸ªå¯¹è±¡å°±æ˜¯ `app = Flask(__name__)` åˆ›å»ºå‡ºæ¥çš„ `app`ï¼Œå°±æ˜¯ä¸‹å›¾ä¸­çš„ç»¿è‰² Application éƒ¨åˆ†ã€‚è¦è¿è¡Œ web åº”ç”¨ï¼Œå¿…é¡»æœ‰ web serverï¼Œæ¯”å¦‚æˆ‘ä»¬ç†Ÿæ‚‰çš„ apacheã€nginx ï¼Œæˆ–è€… python ä¸­çš„ [gunicorn](http://gunicorn.org/) ï¼Œæˆ‘ä»¬ä¸‹é¢è¦è®²åˆ°çš„ `werkzeug` æä¾›çš„ `WSGIServer`ï¼Œå®ƒä»¬æ˜¯ä¸‹å›¾çš„é»„è‰² Server éƒ¨åˆ†ã€‚

![WSGI](https://assets.toptal.io/uploads/blog/image/91961/toptal-blog-image-1452784558794-7851992813e17ce0d5ca9802cf7ac719.jpg)

NOTE: [å›¾ç‰‡æ¥æº](https://www.toptal.com/python/pythons-wsgi-server-application-interface)ã€‚

![WSGI](https://cdn.jsdelivr.net/gh/masantu/statics/images/flask-wsgi.jpg)
é€šè¿‡è¿™å¼ å›¾ï¼Œè¯»è€…å¯¹ web æ¡†æ¶æ‰€å¤„çš„ä½ç½®å’Œ WSGI åè®®èƒ½å¤Ÿæœ‰ä¸€ä¸ªæ„Ÿæ€§çš„è®¤è¯†ã€‚

Server å’Œ Application ä¹‹é—´æ€ä¹ˆé€šä¿¡ï¼Œå°±æ˜¯ WSGI çš„åŠŸèƒ½ã€‚å®ƒè§„å®šäº† `app(environ, start_response)` çš„æ¥å£ï¼Œserver ä¼šè°ƒç”¨ applicationï¼Œå¹¶ä¼ ç»™å®ƒä¸¤ä¸ªå‚æ•°ï¼š`environ` åŒ…å«äº†è¯·æ±‚çš„æ‰€æœ‰ä¿¡æ¯ï¼Œ`start_response` æ˜¯ application å¤„ç†å®Œä¹‹åéœ€è¦è°ƒç”¨çš„å‡½æ•°ï¼Œå‚æ•°æ˜¯çŠ¶æ€ç ã€å“åº”å¤´éƒ¨è¿˜æœ‰é”™è¯¯ä¿¡æ¯ã€‚

WSGI application éå¸¸é‡è¦çš„ç‰¹ç‚¹æ˜¯ï¼š**å®ƒæ˜¯å¯ä»¥åµŒå¥—çš„ã€‚** æ¢å¥è¯è¯´ï¼Œæˆ‘å¯ä»¥å†™ä¸ª applicationï¼Œå®ƒåšçš„äº‹æƒ…å°±æ˜¯è°ƒç”¨å¦å¤–ä¸€ä¸ª applicationï¼Œç„¶åå†è¿”å›ï¼ˆç±»ä¼¼ä¸€ä¸ª proxyï¼‰ã€‚ä¸€èˆ¬æ¥è¯´ï¼ŒåµŒå¥—çš„æœ€åä¸€å±‚æ˜¯ä¸šåŠ¡åº”ç”¨ï¼Œä¸­é—´å°±æ˜¯ middlewareã€‚è¿™æ ·çš„å¥½å¤„æ˜¯ï¼Œå¯ä»¥è§£è€¦ä¸šåŠ¡é€»è¾‘å’Œå…¶ä»–åŠŸèƒ½ï¼Œæ¯”å¦‚é™æµã€è®¤è¯ã€åºåˆ—åŒ–ç­‰éƒ½å®ç°æˆä¸åŒçš„ä¸­é—´å±‚ï¼Œä¸åŒçš„ä¸­é—´å±‚å’Œä¸šåŠ¡é€»è¾‘æ˜¯ä¸ç›¸å…³çš„ï¼Œå¯ä»¥ç‹¬ç«‹ç»´æŠ¤ï¼›è€Œä¸”ç”¨æˆ·ä¹Ÿå¯ä»¥åŠ¨æ€åœ°ç»„åˆä¸åŒçš„ä¸­é—´å±‚æ¥æ»¡è¶³ä¸åŒçš„éœ€æ±‚ã€‚

WSGI æ˜¯ä¸€ç§åè®®ï¼Œè¿™é‡Œï¼Œéœ€è¦æ³¨æ„ä¸¤ä¸ªç›¸è¿‘çš„æ¦‚å¿µï¼š

- uwsgi åŒ WSGI ä¸€æ ·æ˜¯ä¸€ç§åè®®
- è€Œ uWSGI æ˜¯å®ç°äº† uwsgi å’Œ WSGI ä¸¤ç§åè®®çš„ web æœåŠ¡å™¨

WSGI çš„å†…å®¹å°±è®²è¿™ä¹ˆå¤šï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ flask çš„ hello world åº”ç”¨ï¼š
```python
    from flask import Flask
    app = Flask(__name__)

    @app.route('/')
    def hello_world():
        return 'Hello, World!'

    if __name__ == '__main__':
        app.run()
```

è¿™é‡Œçš„ `app = Flask(__name__)` å°±æ˜¯ä¸Šé¢æåˆ°çš„ Application éƒ¨åˆ†ï¼Œä½†æ˜¯æˆ‘ä»¬å¹¶æ²¡æœ‰çœ‹åˆ° Server çš„éƒ¨åˆ†ï¼Œé‚£ä¹ˆå®ƒä¸€å®šæ˜¯éšè—åˆ° `app.run()` å†…éƒ¨æŸä¸ªåœ°æ–¹äº†ã€‚

## å¯åŠ¨æµç¨‹

åº”ç”¨å¯åŠ¨çš„ä»£ç æ˜¯ `app.run()` ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä»£ç å¦‚ä¸‹ï¼š
```python
    def run(self, host=None, port=None, debug=None, **options):
        """Runs the application on a local development server."""
        from werkzeug.serving import run_simple

        # å¦‚æœhost å’Œ port æ²¡æœ‰æŒ‡å®šï¼Œè®¾ç½® host å’Œ port çš„é»˜è®¤å€¼ 127.0.0.1 å’Œ 5000
        if host is None:
            host = '127.0.0.1'
        if port is None:
            server_name = self.config['SERVER_NAME']
            if server_name and ':' in server_name:
                port = int(server_name.rsplit(':', 1)[1])
            else:
                port = 5000

        # è°ƒç”¨ werkzeug.serving æ¨¡å—çš„ run_simple å‡½æ•°ï¼Œä¼ å…¥æ”¶åˆ°çš„å‚æ•°
        # æ³¨æ„ç¬¬ä¸‰ä¸ªå‚æ•°ä¼ è¿›å»çš„æ˜¯ selfï¼Œä¹Ÿå°±æ˜¯è¦æ‰§è¡Œçš„ web application
        try:
            run_simple(host, port, self, **options)
        finally:
            self._got_first_request = False

```
**NOTE**ï¼šä¸ºäº†é˜…è¯»æ–¹ä¾¿ï¼Œæˆ‘åˆ é™¤äº†æ³¨é‡Šå’Œä¸ç›¸å¹²çš„éƒ¨åˆ†ï¼Œä¸‹é¢æ‰€æœ‰çš„ä»£ç éƒ½ä¼šåšç±»ä¼¼çš„å¤„ç†ï¼Œä¸å†èµ˜è¿°ã€‚

è¿™ä¸ªæ–¹æ³•çš„å†…å®¹éå¸¸ç®€å•ï¼šå¤„ç†ä¸€ä¸‹å‚æ•°ï¼Œç„¶åè°ƒç”¨ `werkzeug` çš„ `run_simple`ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼š`run_simple` çš„ç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯ `self`ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åˆ›å»ºçš„ `Flask()` applicationã€‚å› ä¸º WSGI server ä¸æ˜¯æ–‡ç« çš„é‡ç‚¹ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ä¸æ·±å…¥è®²è§£äº†ã€‚ç°åœ¨åªéœ€è¦çŸ¥é“å®ƒçš„åŠŸèƒ½å°±è¡Œï¼šç›‘å¬åœ¨æŒ‡å®šçš„ç«¯å£ï¼Œæ”¶åˆ° HTTP è¯·æ±‚çš„æ—¶å€™è§£æä¸º WSGI æ ¼å¼ï¼Œç„¶åè°ƒç”¨ `app` å»æ‰§è¡Œå¤„ç†çš„é€»è¾‘ã€‚å¯¹åº”çš„æ‰§è¡Œé€»è¾‘åœ¨ `werkzeug.serving:WSGIRequestHandler` çš„ `run_wsgi` ä¸­æœ‰è¿™ä¹ˆä¸€æ®µä»£ç ï¼š
```python
    def execute(app):
        application_iter = app(environ, start_response)
        try:
            for data in application_iter:
                write(data)
            if not headers_sent:
                write(b'')
        finally:
            if hasattr(application_iter, 'close'):
                application_iter.close()
                application_iter = None
```

å¯ä»¥çœ‹åˆ° `application_iter = app(environ, start_response)` å°±æ˜¯è°ƒç”¨ä»£ç è·å–ç»“æœçš„åœ°æ–¹ã€‚

è¦è°ƒç”¨ `app` å®ä¾‹ï¼Œé‚£ä¹ˆå®ƒå°±éœ€è¦å®šä¹‰äº† `__call__` æ–¹æ³•ï¼Œæˆ‘ä»¬æ‰¾åˆ° `flask.appï¼šFlask` å¯¹åº”çš„å†…å®¹ï¼š
```python
    def __call__(self, environ, start_response):
        """Shortcut for :attr:`wsgi_app`."""
        return self.wsgi_app(environ, start_response)

    def wsgi_app(self, environ, start_response):
        """The actual WSGI application.
        """
        # åˆ›å»ºè¯·æ±‚ä¸Šä¸‹æ–‡ï¼Œå¹¶æŠŠå®ƒå‹æ ˆã€‚è¿™ä¸ªåœ¨åé¢ä¼šè¯¦ç»†è§£é‡Š
        ctx = self.request_context(environ)
        ctx.push()
        error = None

        try:
            try:
                # æ­£ç¡®çš„è¯·æ±‚å¤„ç†è·¯å¾„ï¼Œä¼šé€šè¿‡è·¯ç”±æ‰¾åˆ°å¯¹åº”çš„å¤„ç†å‡½æ•°
                response = self.full_dispatch_request()
            except Exception as e:
                # é”™è¯¯å¤„ç†ï¼Œé»˜è®¤æ˜¯ InternalServerError é”™è¯¯å¤„ç†å‡½æ•°ï¼Œå®¢æˆ·ç«¯ä¼šçœ‹åˆ°æœåŠ¡å™¨ 500 å¼‚å¸¸
                error = e
                response = self.handle_exception(e)
            return response(environ, start_response)
        finally:
            if self.should_ignore_error(error):
                error = None
            # ä¸ç®¡å¤„ç†æ˜¯å¦å‘ç”Ÿå¼‚å¸¸ï¼Œéƒ½éœ€è¦æŠŠæ ˆä¸­çš„è¯·æ±‚ pop å‡ºæ¥
            ctx.auto_pop(error)
```

ä¸Šé¢è¿™æ®µä»£ç åªæœ‰ä¸€ä¸ªç›®çš„ï¼šæ‰¾åˆ°é¢„å¤„ç†å‡½æ•°ï¼Œç„¶åè°ƒç”¨å®ƒåˆ†å‘è¯·æ±‚ï¼Œå†è°ƒç”¨æ‰€æœ‰åå¤„ç†å‡½æ•°ï¼Œæœ€åè¿”å› responseã€‚é™¤äº†å¼‚å¸¸å¤„ç†ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜çœ‹åˆ°äº† `context` ç›¸å…³çš„å†…å®¹ï¼ˆå¼€å§‹æœ‰ `ctx.push()`ï¼Œæœ€åæœ‰ `ctx.auto_pop()`çš„é€»è¾‘ï¼‰ï¼Œå®ƒå¹¶ä¸å½±å“æˆ‘ä»¬çš„ç†è§£ï¼Œç°åœ¨å¯ä»¥å…ˆä¸ç”¨ç®¡ï¼Œåé¢ä¼šæœ‰ä¸€ç¯‡æ–‡ç« ä¸“é—¨ä»‹ç»ã€‚

ç»§ç»­å¾€åçœ‹ï¼Œ`full_dsipatch_request` çš„ä»£ç å¦‚ä¸‹ï¼š
```python
    def full_dispatch_request(self):
        """Dispatches the request and on top of that performs request
        pre and postprocessing as well as HTTP exception catching and
        error handling.
        """
        self.try_trigger_before_first_request_functions()
        try:
            request_started.send(self)
            rv = self.preprocess_request()
            if rv is None:
                rv = self.dispatch_request()
        except Exception as e:
            rv = self.handle_user_exception(e)
        return self.finalize_request(rv)
```

è¿™æ®µä»£ç æœ€æ ¸å¿ƒçš„å†…å®¹æ˜¯ `dispatch_request`ï¼ŒåŠ ä¸Š[è¯·æ±‚çš„ hooks å¤„ç†](http://flask.pocoo.org/docs/0.12/reqcontext/)å’Œé”™è¯¯å¤„ç†çš„å†…å®¹ã€‚

NOTEï¼š`self.dispatch_request()` è¿”å›çš„æ˜¯å¤„ç†å‡½æ•°çš„è¿”å›ç»“æœï¼ˆæ¯”å¦‚ hello world ä¾‹å­ä¸­è¿”å›çš„å­—ç¬¦ä¸²ï¼‰ï¼Œ`finalize_request` ä¼šæŠŠå®ƒè½¬æ¢æˆ `Response` å¯¹è±¡ã€‚

åœ¨ `dispatch_request` ä¹‹å‰æˆ‘ä»¬çœ‹åˆ° `preprocess_request`ï¼Œä¹‹åçœ‹åˆ° `finalize_request`ï¼Œå®ƒä»¬é‡Œé¢åŒ…æ‹¬äº†è¯·æ±‚å¤„ç†ä¹‹å‰å’Œå¤„ç†ä¹‹åçš„å¾ˆå¤š hooks ã€‚è¿™äº› hooks åŒ…æ‹¬ï¼š

*   ç¬¬ä¸€æ¬¡è¯·æ±‚å¤„ç†ä¹‹å‰çš„ hook å‡½æ•°ï¼Œé€šè¿‡ `before_first_request` å®šä¹‰
*   æ¯ä¸ªè¯·æ±‚å¤„ç†ä¹‹å‰çš„ hook å‡½æ•°ï¼Œé€šè¿‡ `before_request` å®šä¹‰
*   æ¯ä¸ªè¯·æ±‚æ­£å¸¸å¤„ç†ä¹‹åçš„ hook å‡½æ•°ï¼Œé€šè¿‡ `after_request` å®šä¹‰
*   ä¸ç®¡è¯·æ±‚æ˜¯å¦å¼‚å¸¸éƒ½è¦æ‰§è¡Œçš„ `teardown_request` hook å‡½æ•°

`dispatch_request` è¦åšçš„å°±æ˜¯æ‰¾åˆ°æˆ‘ä»¬çš„å¤„ç†å‡½æ•°ï¼Œå¹¶è¿”å›è°ƒç”¨çš„ç»“æœï¼Œä¹Ÿå°±æ˜¯**è·¯ç”±çš„è¿‡ç¨‹**ã€‚æˆ‘ä»¬ä¸‹ä¸€ç¯‡æ–‡ç« æ¥è®²ï¼