---
title: Flask æºç è§£æï¼šä¸Šä¸‹æ–‡

tags: 
  - Flask
  - web å¼€å‘
  - Python
categories: 
  - ğŸ’» å·¥ä½œ
  - ğŸPython
  - Flask
  - æºç é˜…è¯»
date: 2019-08-23 12:27:56
permalink: /flask-insight-context/
---
è¿™æ˜¯ flask æºç è§£æç³»åˆ—æ–‡ç« çš„å…¶ä¸­ä¸€ç¯‡ï¼Œæœ¬ç³»åˆ—æ‰€æœ‰æ–‡ç« åˆ—è¡¨ï¼š

*   [Flask æºç è§£æï¼šç®€ä»‹](/flask-insight-introduction)
*   [Flask æºç è§£æï¼šåº”ç”¨å¯åŠ¨æµç¨‹](/flask-insight-start-process)
*   [Flask æºç è§£æï¼šè·¯ç”±](/flask-insight-routing)
*   [Flask æºç è§£æï¼šä¸Šä¸‹æ–‡](/flask-insight-context)
*   [Flask æºç è§£æï¼šè¯·æ±‚](/flask-insight-request)
*   [Flask æºç è§£æï¼šå“åº”](/flask-insight-response)
*   [Flask æºç è§£æï¼šé…ç½®](/flask-insight-config)
*   [Flask æºç è§£æï¼šsession](/flask-insight-session)

## ä¸Šä¸‹æ–‡ï¼ˆapplication context å’Œ request contextï¼‰

ä¸Šä¸‹æ–‡ä¸€ç›´æ˜¯è®¡ç®—æœºä¸­éš¾ç†è§£çš„æ¦‚å¿µï¼Œåœ¨[çŸ¥ä¹çš„ä¸€ä¸ªé—®é¢˜](https://www.zhihu.com/question/26387327)ä¸‹é¢æœ‰ä¸ªå¾ˆé€šä¿—æ˜“æ‡‚çš„å›ç­”ï¼š

> æ¯ä¸€æ®µç¨‹åºéƒ½æœ‰å¾ˆå¤šå¤–éƒ¨å˜é‡ã€‚åªæœ‰åƒ`add`è¿™ç§ç®€å•çš„å‡½æ•°æ‰æ˜¯æ²¡æœ‰å¤–éƒ¨å˜é‡çš„ã€‚ä¸€æ—¦ä½ çš„ä¸€æ®µç¨‹åºæœ‰äº†å¤–éƒ¨å˜é‡ï¼Œè¿™æ®µç¨‹åºå°±ä¸å®Œæ•´ï¼Œä¸èƒ½ç‹¬ç«‹è¿è¡Œã€‚ä½ ä¸ºäº†ä½¿ä»–ä»¬è¿è¡Œï¼Œå°±è¦ç»™æ‰€æœ‰çš„å¤–éƒ¨å˜é‡ä¸€ä¸ªä¸€ä¸ªå†™ä¸€äº›å€¼è¿›å»ã€‚è¿™äº›å€¼çš„é›†åˆå°±å«ä¸Šä¸‹æ–‡ã€‚  
> â€“ vzch

æ¯”å¦‚ï¼Œåœ¨ flask ä¸­ï¼Œè§†å›¾å‡½æ•°éœ€è¦çŸ¥é“å®ƒæ‰§è¡Œæƒ…å†µçš„è¯·æ±‚ä¿¡æ¯ï¼ˆè¯·æ±‚çš„ urlï¼Œå‚æ•°ï¼Œæ–¹æ³•ç­‰ï¼‰ä»¥åŠåº”ç”¨ä¿¡æ¯ï¼ˆåº”ç”¨ä¸­åˆå§‹åŒ–çš„æ•°æ®åº“ç­‰ï¼‰ï¼Œæ‰èƒ½å¤Ÿæ­£ç¡®è¿è¡Œã€‚

æœ€ç›´è§‚åœ°åšæ³•æ˜¯æŠŠè¿™äº›ä¿¡æ¯å°è£…æˆä¸€ä¸ªå¯¹è±¡ï¼Œä½œä¸ºå‚æ•°ä¼ é€’ç»™è§†å›¾å‡½æ•°ã€‚ä½†æ˜¯è¿™æ ·çš„è¯ï¼Œæ‰€æœ‰çš„è§†å›¾å‡½æ•°éƒ½éœ€è¦æ·»åŠ å¯¹åº”çš„å‚æ•°ï¼Œå³ä½¿è¯¥å‡½æ•°å†…éƒ¨å¹¶æ²¡æœ‰ä½¿ç”¨åˆ°å®ƒã€‚

flask çš„åšæ³•æ˜¯æŠŠè¿™äº›ä¿¡æ¯ä½œä¸º**ç±»ä¼¼å…¨å±€å˜é‡çš„ä¸œè¥¿**ï¼Œè§†å›¾å‡½æ•°éœ€è¦çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨ `from flask import request` è·å–ã€‚ä½†æ˜¯è¿™äº›å¯¹è±¡å’Œå…¨å±€å˜é‡ä¸åŒçš„æ˜¯â€”â€”å®ƒä»¬å¿…é¡»æ˜¯åŠ¨æ€çš„ï¼Œå› ä¸ºåœ¨å¤šçº¿ç¨‹æˆ–è€…å¤šåç¨‹çš„æƒ…å†µä¸‹ï¼Œæ¯ä¸ªçº¿ç¨‹æˆ–è€…åç¨‹è·å–çš„éƒ½æ˜¯è‡ªå·±ç‹¬ç‰¹çš„å¯¹è±¡ï¼Œä¸ä¼šäº’ç›¸å¹²æ‰°ã€‚

é‚£ä¹ˆå¦‚ä½•å®ç°è¿™ç§æ•ˆæœå‘¢ï¼Ÿå¦‚æœå¯¹ python å¤šçº¿ç¨‹æ¯”è¾ƒç†Ÿæ‚‰çš„è¯ï¼Œåº”è¯¥çŸ¥é“å¤šçº¿ç¨‹ä¸­æœ‰ä¸ªéå¸¸ç±»ä¼¼çš„æ¦‚å¿µ [`threading.local`](https://stackoverflow.com/questions/104983/what-is-thread-local-storage-in-python-and-why-do-i-need-it)ï¼Œå¯ä»¥å®ç°å¤šçº¿ç¨‹è®¿é—®æŸä¸ªå˜é‡çš„æ—¶å€™åªçœ‹åˆ°è‡ªå·±çš„æ•°æ®ã€‚å†…éƒ¨çš„åŸç†è¯´èµ·æ¥ä¹Ÿå¾ˆç®€å•ï¼Œè¿™ä¸ªå¯¹è±¡æœ‰ä¸€ä¸ªå­—å…¸ï¼Œä¿å­˜äº†çº¿ç¨‹ id å¯¹åº”çš„æ•°æ®ï¼Œè¯»å–è¯¥å¯¹è±¡çš„æ—¶å€™ï¼Œå®ƒåŠ¨æ€åœ°æŸ¥è¯¢å½“å‰çº¿ç¨‹ id å¯¹åº”çš„æ•°æ®ã€‚flaskpython ä¸Šä¸‹æ–‡çš„å®ç°ä¹Ÿç±»ä¼¼ï¼Œåé¢ä¼šè¯¦ç»†è§£é‡Šã€‚

flask ä¸­æœ‰ä¸¤ç§ä¸Šä¸‹æ–‡ï¼š`application context` å’Œ `request context`ã€‚ä¸Šä¸‹æ–‡æœ‰å…³çš„å†…å®¹å®šä¹‰åœ¨ `globals.py` æ–‡ä»¶ï¼Œæ–‡ä»¶çš„å†…å®¹ä¹Ÿéå¸¸çŸ­ï¼š
```python
def _lookup_req_object(name):
    top = _request_ctx_stack.top
    if top is None:
        raise RuntimeError(_request_ctx_err_msg)
    return getattr(top, name)


def _lookup_app_object(name):
    top = _app_ctx_stack.top
    if top is None:
        raise RuntimeError(_app_ctx_err_msg)
    return getattr(top, name)


def _find_app():
    top = _app_ctx_stack.top
    if top is None:
        raise RuntimeError(_app_ctx_err_msg)
    return top.app


# context locals
_request_ctx_stack = LocalStack()
_app_ctx_stack = LocalStack()
current_app = LocalProxy(_find_app)
request = LocalProxy(partial(_lookup_req_object, 'request'))
session = LocalProxy(partial(_lookup_req_object, 'session'))
g = LocalProxy(partial(_lookup_app_object, 'g'))
```

`flask` æä¾›ä¸¤ç§ä¸Šä¸‹æ–‡ï¼š`application context` å’Œ `request context` ã€‚`app lication context` åˆæ¼”åŒ–å‡ºæ¥ä¸¤ä¸ªå˜é‡ `current_app` å’Œ `g`ï¼Œè€Œ `request context` åˆ™æ¼”åŒ–å‡ºæ¥ `request` å’Œ `session`ã€‚

è¿™é‡Œçš„å®ç°ç”¨åˆ°äº†ä¸¤ä¸ªä¸œè¥¿ï¼š`LocalStack` å’Œ `LocalProxy`ã€‚å®ƒä»¬ä¸¤ä¸ªçš„ç»“æœå°±æ˜¯æˆ‘ä»¬å¯ä»¥åŠ¨æ€åœ°è·å–ä¸¤ä¸ªä¸Šä¸‹æ–‡çš„å†…å®¹ï¼Œåœ¨å¹¶å‘ç¨‹åºä¸­æ¯ä¸ªè§†å›¾å‡½æ•°éƒ½ä¼šçœ‹åˆ°å±äºè‡ªå·±çš„ä¸Šä¸‹æ–‡ï¼Œè€Œä¸ä¼šå‡ºç°æ··ä¹±ã€‚

`LocalStack` å’Œ `LocalProxy` éƒ½æ˜¯ `werkzeug` æä¾›çš„ï¼Œå®šä¹‰åœ¨ `local.py` æ–‡ä»¶ä¸­ã€‚åœ¨åˆ†æè¿™ä¸¤ä¸ªç±»ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆä»‹ç»è¿™ä¸ªæ–‡ä»¶å¦å¤–ä¸€ä¸ªåŸºç¡€çš„ç±» `Local`ã€‚`Local` å°±æ˜¯å®ç°äº†ç±»ä¼¼ `threading.local` çš„æ•ˆæœâ€”â€”å¤šçº¿ç¨‹æˆ–è€…å¤šåç¨‹æƒ…å†µä¸‹å…¨å±€å˜é‡çš„éš”ç¦»æ•ˆæœã€‚ä¸‹é¢æ˜¯å®ƒçš„ä»£ç ï¼š
```python
    # since each thread has its own greenlet we can just use those as identifiers
    # for the context.  If greenlets are not available we fall back to the
    # current thread ident depending on where it is.
    try:
        from greenlet import getcurrent as get_ident
    except ImportError:
        try:
            from thread import get_ident
        except ImportError:
            from _thread import get_ident
    
    class Local(object):
        __slots__ = ('__storage__', '__ident_func__')
    
        def __init__(self):
            # æ•°æ®ä¿å­˜åœ¨ __storage__ ä¸­ï¼Œåç»­è®¿é—®éƒ½æ˜¯å¯¹è¯¥å±æ€§çš„æ“ä½œ
            object.__setattr__(self, '__storage__', {})
            object.__setattr__(self, '__ident_func__', get_ident)
    
        def __call__(self, proxy):
            """Create a proxy for a name."""
            return LocalProxy(self, proxy)
    
        # æ¸…ç©ºå½“å‰çº¿ç¨‹/åç¨‹ä¿å­˜çš„æ‰€æœ‰æ•°æ®
        def __release_local__(self):
            self.__storage__.pop(self.__ident_func__(), None)
    
        # ä¸‹é¢ä¸‰ä¸ªæ–¹æ³•å®ç°äº†å±æ€§çš„è®¿é—®ã€è®¾ç½®å’Œåˆ é™¤ã€‚
        # æ³¨æ„åˆ°ï¼Œå†…éƒ¨éƒ½è°ƒç”¨ `self.__ident_func__` è·å–å½“å‰çº¿ç¨‹æˆ–è€…åç¨‹çš„ idï¼Œç„¶åå†è®¿é—®å¯¹åº”çš„å†…éƒ¨å­—å…¸ã€‚
        # å¦‚æœè®¿é—®æˆ–è€…åˆ é™¤çš„å±æ€§ä¸å­˜åœ¨ï¼Œä¼šæŠ›å‡º AttributeErrorã€‚
        # è¿™æ ·ï¼Œå¤–éƒ¨ç”¨æˆ·çœ‹åˆ°çš„å°±æ˜¯å®ƒåœ¨è®¿é—®å®ä¾‹çš„å±æ€§ï¼Œå®Œå…¨ä¸çŸ¥é“å­—å…¸æˆ–è€…å¤šçº¿ç¨‹/åç¨‹åˆ‡æ¢çš„å®ç°
        def __getattr__(self, name):
            try:
                return self.__storage__[self.__ident_func__()][name]
            except KeyError:
                raise AttributeError(name)
    
        def __setattr__(self, name, value):
            ident = self.__ident_func__()
            storage = self.__storage__
            try:
                storage[ident][name] = value
            except KeyError:
                storage[ident] = {name: value}
    
        def __delattr__(self, name):
            try:
                del self.__storage__[self.__ident_func__()][name]
            except KeyError:
                raise AttributeError(name)
    
```
å¯ä»¥çœ‹åˆ°ï¼Œ`Local` å¯¹è±¡å†…éƒ¨çš„æ•°æ®éƒ½æ˜¯ä¿å­˜åœ¨ `__storage__` å±æ€§çš„ï¼Œè¿™ä¸ªå±æ€§å˜é‡æ˜¯ä¸ªåµŒå¥—çš„å­—å…¸ï¼š`map[ident]map[key]value`ã€‚æœ€å¤–é¢å­—å…¸ key æ˜¯çº¿ç¨‹æˆ–è€…åç¨‹çš„ identityï¼Œvalue æ˜¯å¦å¤–ä¸€ä¸ªå­—å…¸ï¼Œè¿™ä¸ªå†…éƒ¨å­—å…¸å°±æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„ key-value é”®å€¼å¯¹ã€‚ç”¨æˆ·è®¿é—®å®ä¾‹çš„å±æ€§ï¼Œå°±å˜æˆäº†è®¿é—®å†…éƒ¨çš„å­—å…¸ï¼Œå¤–é¢å­—å…¸çš„ key æ˜¯è‡ªåŠ¨å…³è”çš„ã€‚`__ident_func` æ˜¯ åç¨‹çš„ `get_current` æˆ–è€…çº¿ç¨‹çš„ `get_ident`ï¼Œä»è€Œè·å–å½“å‰ä»£ç æ‰€åœ¨çº¿ç¨‹æˆ–è€…åç¨‹çš„ idã€‚

é™¤äº†è¿™äº›åŸºæœ¬æ“ä½œä¹‹å¤–ï¼Œ`Local` è¿˜å®ç°äº† `__release_local__` ï¼Œç”¨æ¥æ¸…ç©ºï¼ˆææ„ï¼‰å½“å‰çº¿ç¨‹æˆ–è€…åç¨‹çš„æ•°æ®ï¼ˆçŠ¶æ€ï¼‰ã€‚`__call__` æ“ä½œæ¥åˆ›å»ºä¸€ä¸ª `LocalProxy` å¯¹è±¡ï¼Œ`LocalProxy` ä¼šåœ¨ä¸‹é¢è®²åˆ°ã€‚

ç†è§£äº† `Local`ï¼Œæˆ‘ä»¬ç»§ç»­å›æ¥çœ‹å¦å¤–ä¸¤ä¸ªç±»ã€‚

`LocalStack` æ˜¯åŸºäº `Local` å®ç°çš„æ ˆç»“æ„ã€‚å¦‚æœè¯´ `Local` æä¾›äº†å¤šçº¿ç¨‹æˆ–è€…å¤šåç¨‹éš”ç¦»çš„å±æ€§è®¿é—®ï¼Œé‚£ä¹ˆ `LocalStack` å°±æä¾›äº†éš”ç¦»çš„æ ˆè®¿é—®ã€‚ä¸‹é¢æ˜¯å®ƒçš„å®ç°ä»£ç ï¼Œå¯ä»¥çœ‹åˆ°å®ƒæä¾›äº† `push`ã€`pop` å’Œ `top` æ–¹æ³•ã€‚

`__release_local__` å¯ä»¥ç”¨æ¥æ¸…ç©ºå½“å‰çº¿ç¨‹æˆ–è€…åç¨‹çš„æ ˆæ•°æ®ï¼Œ`__call__` æ–¹æ³•è¿”å›å½“å‰çº¿ç¨‹æˆ–è€…åç¨‹æ ˆé¡¶å…ƒç´ çš„ä»£ç†å¯¹è±¡ã€‚
```python
class LocalStack(object):
    """This class works similar to a :class:`Local` but keeps a stack
    of objects instead. """

    def __init__(self):
        self._local = Local()

    def __release_local__(self):
        self._local.__release_local__()

    def __call__(self):
        def _lookup():
            rv = self.top
            if rv is None:
                raise RuntimeError('object unbound')
            return rv
        return LocalProxy(_lookup)

    # pushã€pop å’Œ top ä¸‰ä¸ªæ–¹æ³•å®ç°äº†æ ˆçš„æ“ä½œï¼Œ
    # å¯ä»¥çœ‹åˆ°æ ˆçš„æ•°æ®æ˜¯ä¿å­˜åœ¨ self._local.stack å±æ€§ä¸­çš„
    def push(self, obj):
        """Pushes a new item to the stack"""
        rv = getattr(self._local, 'stack', None)
        if rv is None:
            self._local.stack = rv = []
        rv.append(obj)
        return rv

    def pop(self):
        """Removes the topmost item from the stack, will return the
        old value or `None` if the stack was already empty.
        """
        stack = getattr(self._local, 'stack', None)
        if stack is None:
            return None
        elif len(stack) == 1:
            release_local(self._local)
            return stack[-1]
        else:
            return stack.pop()

    @property
    def top(self):
        """The topmost item on the stack.  If the stack is empty,
        `None` is returned.
        """
        try:
            return self._local.stack[-1]
        except (AttributeError, IndexError):
            return None
```

æˆ‘ä»¬åœ¨ä¹‹å‰çœ‹åˆ°äº† `request context` çš„å®šä¹‰ï¼Œå®ƒå°±æ˜¯ä¸€ä¸ª `LocalStack` çš„å®ä¾‹ï¼š
```python
    _request_ctx_stack = LocalStack()
    
```
å®ƒä¼šå½“å‰çº¿ç¨‹æˆ–è€…åç¨‹çš„è¯·æ±‚éƒ½ä¿å­˜åœ¨æ ˆé‡Œï¼Œç­‰ä½¿ç”¨çš„æ—¶å€™å†ä»é‡Œé¢è¯»å–ã€‚è‡³äºä¸ºä»€ä¹ˆè¦ç”¨åˆ°æ ˆç»“æ„ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ `Local`ï¼Œæˆ‘ä»¬ä¼šåœ¨åé¢æ­æ™“ç­”æ¡ˆï¼Œä½ å¯ä»¥å…ˆæ€è€ƒä¸€ä¸‹ã€‚

`LocalProxy` æ˜¯ä¸€ä¸ª `Local` å¯¹è±¡çš„ä»£ç†ï¼Œè´Ÿè´£æŠŠæ‰€æœ‰å¯¹è‡ªå·±çš„æ“ä½œè½¬å‘ç»™å†…éƒ¨çš„ `Local` å¯¹è±¡ã€‚`LocalProxy` çš„æ„é€ å‡½æ•°ä»‹ç»ä¸€ä¸ª callable çš„å‚æ•°ï¼Œè¿™ä¸ª callable è°ƒç”¨ä¹‹åéœ€è¦è¿”å›ä¸€ä¸ª `Local` å®ä¾‹ï¼Œåç»­æ‰€æœ‰çš„å±æ€§æ“ä½œéƒ½ä¼šè½¬å‘ç»™ callable è¿”å›çš„å¯¹è±¡ã€‚
```python
    class LocalProxy(object):
        """Acts as a proxy for a werkzeug local.
        Forwards all operations to a proxied object. """
        __slots__ = ('__local', '__dict__', '__name__')
    
        def __init__(self, local, name=None):
            object.__setattr__(self, '_LocalProxy__local', local)
            object.__setattr__(self, '__name__', name)
    
        def _get_current_object(self):
            """Return the current object."""
            if not hasattr(self.__local, '__release_local__'):
                return self.__local()
            try:
                return getattr(self.__local, self.__name__)
            except AttributeError:
                raise RuntimeError('no object bound to %s' % self.__name__)
    
        @property
        def __dict__(self):
            try:
                return self._get_current_object().__dict__
            except RuntimeError:
                raise AttributeError('__dict__')
    
        def __getattr__(self, name):
            if name == '__members__':
                return dir(self._get_current_object())
            return getattr(self._get_current_object(), name)
    
        def __setitem__(self, key, value):
            self._get_current_object()[key] = value
    
```
è¿™é‡Œå®ç°çš„å…³é”®æ˜¯æŠŠé€šè¿‡å‚æ•°ä¼ é€’è¿›æ¥çš„ `Local` å®ä¾‹ä¿å­˜åœ¨ `__local` å±æ€§ä¸­ï¼Œå¹¶å®šä¹‰äº† `_get_current_object()` æ–¹æ³•è·å–å½“å‰çº¿ç¨‹æˆ–è€…åç¨‹å¯¹åº”çš„å¯¹è±¡ã€‚

**NOTE**ï¼šå‰é¢åŒä¸‹åˆ’çº¿çš„å±æ€§ï¼Œä¼šä¿å­˜åˆ° `_ClassName__variable` ä¸­ã€‚æ‰€ä»¥è¿™é‡Œé€šè¿‡ `â€œ_LocalProxy__localâ€` è®¾ç½®çš„å€¼ï¼Œåé¢å¯ä»¥é€šè¿‡ `self.__local` æ¥è·å–ã€‚å…³äºè¿™ä¸ªçŸ¥è¯†ç‚¹ï¼Œå¯ä»¥æŸ¥çœ‹ [stackoverflow çš„è¿™ä¸ªé—®é¢˜](https://stackoverflow.com/questions/1301346/the-meaning-of-a-single-and-a-double-underscore-before-an-object-name-in-python)ã€‚

ç„¶å `LocalProxy` é‡å†™äº†æ‰€æœ‰çš„é­”æœ¯æ–¹æ³•ï¼ˆåå­—å‰åæœ‰ä¸¤ä¸ªä¸‹åˆ’çº¿çš„æ–¹æ³•ï¼‰ï¼Œå…·ä½“æ“ä½œéƒ½æ˜¯è½¬å‘ç»™ä»£ç†å¯¹è±¡çš„ã€‚è¿™é‡Œåªç»™å‡ºäº†å‡ ä¸ªé­”æœ¯æ–¹æ³•ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥æŸ¥çœ‹æºç ä¸­æ‰€æœ‰çš„é­”æœ¯æ–¹æ³•ã€‚

ç»§ç»­å›åˆ° `request context` çš„å®ç°ï¼š
```python
    _request_ctx_stack = LocalStack()
    request = LocalProxy(partial(_lookup_req_object, 'request'))
    session = LocalProxy(partial(_lookup_req_object, 'session'))
    
```
å†æ¬¡çœ‹è¿™æ®µä»£ç å¸Œæœ›èƒ½çœ‹æ˜ç™½ï¼Œ`_request_ctx_stack` æ˜¯å¤šçº¿ç¨‹æˆ–è€…åç¨‹éš”ç¦»çš„æ ˆç»“æ„ï¼Œ`request` æ¯æ¬¡éƒ½ä¼šè°ƒç”¨ `_lookup_req_object` æ ˆå¤´éƒ¨çš„æ•°æ®æ¥è·å–ä¿å­˜åœ¨é‡Œé¢çš„ `requst context`ã€‚

é‚£ä¹ˆè¯·æ±‚ä¸Šä¸‹æ–‡ä¿¡æ¯æ˜¯ä»€ä¹ˆè¢«æ”¾åœ¨ stack ä¸­å‘¢ï¼Ÿè¿˜è®°å¾—ä¹‹å‰ä»‹ç»çš„ `wsgi_app()` æ–¹æ³•æœ‰ä¸‹é¢ä¸¤è¡Œä»£ç å—ï¼Ÿ
```python
ctx = self.request_context(environ)
ctx.push()
```

æ¯æ¬¡åœ¨è°ƒç”¨ `app.__call__` çš„æ—¶å€™ï¼Œéƒ½ä¼šæŠŠå¯¹åº”çš„è¯·æ±‚ä¿¡æ¯å‹æ ˆï¼Œæœ€åæ‰§è¡Œå®Œè¯·æ±‚çš„å¤„ç†ä¹‹åæŠŠå®ƒå‡ºæ ˆã€‚

æˆ‘ä»¬æ¥çœ‹çœ‹`request_context`ï¼Œ è¿™ä¸ª æ–¹æ³•åªæœ‰ä¸€è¡Œä»£ç ï¼š
```python
def request_context(self, environ):
    return RequestContext(self, environ)
```

å®ƒè°ƒç”¨äº† `RequestContext`ï¼Œå¹¶æŠŠ `self` å’Œè¯·æ±‚ä¿¡æ¯çš„å­—å…¸ `environ` å½“åšå‚æ•°ä¼ é€’è¿›å»ã€‚è¿½è¸ªåˆ° `RequestContext` å®šä¹‰çš„åœ°æ–¹ï¼Œå®ƒå‡ºç°åœ¨ `ctx.py` æ–‡ä»¶ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š
```python
    class RequestContext(object):
        """The request context contains all request relevant information.  It is
        created at the beginning of the request and pushed to the
        `_request_ctx_stack` and removed at the end of it.  It will create the
        URL adapter and request object for the WSGI environment provided.
        """
    
        def __init__(self, app, environ, request=None):
            self.app = app
            if request is None:
                request = app.request_class(environ)
            self.request = request
            self.url_adapter = app.create_url_adapter(self.request)
            self.match_request()
    
        def match_request(self):
            """Can be overridden by a subclass to hook into the matching
            of the request.
            """
            try:
                url_rule, self.request.view_args = \
                    self.url_adapter.match(return_rule=True)
                self.request.url_rule = url_rule
            except HTTPException as e:
                self.request.routing_exception = e
    
        def push(self):
            """Binds the request context to the current context."""
            # Before we push the request context we have to ensure that there
            # is an application context.
            app_ctx = _app_ctx_stack.top
            if app_ctx is None or app_ctx.app != self.app:
                app_ctx = self.app.app_context()
                app_ctx.push()
                self._implicit_app_ctx_stack.append(app_ctx)
            else:
                self._implicit_app_ctx_stack.append(None)
    
            _request_ctx_stack.push(self)
    
            self.session = self.app.open_session(self.request)
            if self.session is None:
                self.session = self.app.make_null_session()
    
        def pop(self, exc=_sentinel):
            """Pops the request context and unbinds it by doing that.  This will
            also trigger the execution of functions registered by the
            :meth:`~flask.Flask.teardown_request` decorator.
            """
            app_ctx = self._implicit_app_ctx_stack.pop()
    
            try:
                clear_request = False
                if not self._implicit_app_ctx_stack:
                    self.app.do_teardown_request(exc)
    
                    request_close = getattr(self.request, 'close', None)
                    if request_close is not None:
                        request_close()
                    clear_request = True
            finally:
                rv = _request_ctx_stack.pop()
    
                # get rid of circular dependencies at the end of the request
                # so that we don't require the GC to be active.
                if clear_request:
                    rv.request.environ['werkzeug.request'] = None
    
                # Get rid of the app as well if necessary.
                if app_ctx is not None:
                    app_ctx.pop(exc)
    
        def auto_pop(self, exc):
            if self.request.environ.get('flask._preserve_context') or \
               (exc is not None and self.app.preserve_context_on_exception):
                self.preserved = True
                self._preserved_exc = exc
            else:
                self.pop(exc)
    
        def __enter__(self):
            self.push()
            return self
    
        def __exit__(self, exc_type, exc_value, tb):
            self.auto_pop(exc_value)
    
```
æ¯ä¸ª request context éƒ½ä¿å­˜äº†å½“å‰è¯·æ±‚çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ request å¯¹è±¡å’Œ app å¯¹è±¡ã€‚åœ¨åˆå§‹åŒ–çš„æœ€åï¼Œè¿˜è°ƒç”¨äº† `match_request` å®ç°äº†[è·¯ç”±çš„åŒ¹é…é€»è¾‘](https://cizixs.com/2017/01/12/flask-insight-routing)ã€‚

`push` æ“ä½œå°±æ˜¯æŠŠè¯¥è¯·æ±‚çš„ `ApplicationContext`ï¼ˆå¦‚æœ `_app_ctx_stack` æ ˆé¡¶ä¸æ˜¯å½“å‰è¯·æ±‚æ‰€åœ¨ app ï¼Œéœ€è¦åˆ›å»ºæ–°çš„ app contextï¼‰ å’Œ `RequestContext` æœ‰å…³çš„ä¿¡æ¯ä¿å­˜åˆ°å¯¹åº”çš„æ ˆä¸Šï¼Œå‹æ ˆåè¿˜ä¼šä¿å­˜ session çš„ä¿¡æ¯ï¼› `pop` åˆ™ç›¸åï¼ŒæŠŠ request context å’Œ application context å‡ºæ ˆï¼Œåšä¸€äº›æ¸…ç†æ€§çš„å·¥ä½œã€‚

åˆ°è¿™é‡Œï¼Œä¸Šä¸‹æ–‡çš„å®ç°å°±æ¯”è¾ƒæ¸…æ™°äº†ï¼šæ¯æ¬¡æœ‰è¯·æ±‚è¿‡æ¥çš„æ—¶å€™ï¼Œflask ä¼šå…ˆåˆ›å»ºå½“å‰çº¿ç¨‹æˆ–è€…è¿›ç¨‹éœ€è¦å¤„ç†çš„ä¸¤ä¸ªé‡è¦ä¸Šä¸‹æ–‡å¯¹è±¡ï¼ŒæŠŠå®ƒä»¬ä¿å­˜åˆ°éš”ç¦»çš„æ ˆé‡Œé¢ï¼Œè¿™æ ·è§†å›¾å‡½æ•°è¿›è¡Œå¤„ç†çš„æ—¶å€™å°±èƒ½ç›´æ¥ä»æ ˆä¸Šè·å–è¿™äº›ä¿¡æ¯ã€‚

NOTEï¼šå› ä¸º app å®ä¾‹åªæœ‰ä¸€ä¸ªï¼Œå› æ­¤å¤šä¸ª `request` å…±äº«äº† `application context`ã€‚

åˆ°è¿™é‡Œï¼Œå…³äº context çš„å®ç°å’ŒåŠŸèƒ½å·²ç»è®²è§£å¾—å·®ä¸å¤šäº†ã€‚è¿˜æœ‰ä¸¤ä¸ªç–‘æƒ‘æ²¡æœ‰è§£ç­”ã€‚

1.  ä¸ºä»€ä¹ˆè¦æŠŠ request context å’Œ application context åˆ†å¼€ï¼Ÿæ¯ä¸ªè¯·æ±‚ä¸æ˜¯éƒ½åŒæ—¶æ‹¥æœ‰è¿™ä¸¤ä¸ªä¸Šä¸‹æ–‡ä¿¡æ¯å—ï¼Ÿ
2.  ä¸ºä»€ä¹ˆ request context å’Œ application context éƒ½æœ‰å®ç°æˆæ ˆçš„ç»“æ„ï¼Ÿæ¯ä¸ªè¯·æ±‚éš¾é“ä¼šå‡ºç°å¤šä¸ª request context æˆ–è€… application context å—ï¼Ÿ

ç¬¬ä¸€ä¸ªç­”æ¡ˆæ˜¯â€œçµæ´»åº¦â€ï¼Œç¬¬äºŒä¸ªç­”æ¡ˆæ˜¯â€œ[å¤š application](https://stackoverflow.com/a/20041823/1925083)â€ã€‚è™½ç„¶åœ¨å®é™…è¿è¡Œä¸­ï¼Œæ¯ä¸ªè¯·æ±‚å¯¹åº”ä¸€ä¸ª request context å’Œä¸€ä¸ª application contextï¼Œä½†æ˜¯åœ¨æµ‹è¯•æˆ–è€… python shell ä¸­è¿è¡Œçš„æ—¶å€™ï¼Œç”¨æˆ·å¯ä»¥å•ç‹¬åˆ›å»º request context æˆ–è€… application contextï¼Œè¿™ç§çµæ´»åº¦æ–¹ä¾¿ç”¨æˆ·çš„ä¸åŒçš„ä½¿ç”¨åœºæ™¯ï¼›è€Œä¸”æ ˆå¯ä»¥è®© redirect æ›´å®¹æ˜“å®ç°ï¼Œä¸€ä¸ªå¤„ç†å‡½æ•°å¯ä»¥ä»æ ˆä¸­è·å–é‡å®šå‘è·¯å¾„çš„å¤šä¸ªè¯·æ±‚ä¿¡æ¯ã€‚application è®¾è®¡æˆæ ˆä¹Ÿæ˜¯ç±»ä¼¼ï¼Œæµ‹è¯•çš„æ—¶å€™å¯ä»¥æ·»åŠ å¤šä¸ªä¸Šä¸‹æ–‡ï¼Œå¦å¤–ä¸€ä¸ªåŸå› æ˜¯ flask å¯ä»¥[å¤šä¸ª application åŒæ—¶è¿è¡Œ](http://flask.pocoo.org/docs/0.12/patterns/appdispatch/):
```python
from werkzeug.wsgi import DispatcherMiddleware
from frontend_app import application as frontend
from backend_app import application as backend

application = DispatcherMiddleware(frontend, {
    '/backend':     backend
})
```

è¿™ä¸ªä¾‹å­å°±æ˜¯ä½¿ç”¨ `werkzeug` çš„ `DispatcherMiddleware` å®ç°å¤šä¸ª app çš„åˆ†å‘ï¼Œè¿™ç§æƒ…å†µä¸‹ `_app_ctx_stack` æ ˆé‡Œä¼šå‡ºç°ä¸¤ä¸ª application contextã€‚

## Updateï¼š ä¸ºä»€ä¹ˆè¦ç”¨ LocalProxy


å†™å®Œè¿™ç¯‡æ–‡ç« ä¹‹åï¼Œæ”¶åˆ°æœ‰ä½è¯»è€…çš„ç–‘é—®ï¼šä¸ºä»€ä¹ˆè¦ä½¿ç”¨ `LocalProxy`ï¼Ÿä¸ä½¿ç”¨ `LocalProxy` ç›´æ¥è®¿é—® `LocalStack` çš„å¯¹è±¡ä¼šæœ‰ä»€ä¹ˆé—®é¢˜å—ï¼Ÿ

è¿™æ˜¯ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼Œä¸Šé¢ä¹Ÿç¡®å®æ²¡æœ‰å¾ˆæ˜ç¡®åœ°ç»™å‡ºè¿™ä¸ªç­”æ¡ˆã€‚è¿™é‡Œè§£é‡Šä¸€ä¸‹ï¼

é¦–å…ˆæ˜ç¡®ä¸€ç‚¹ï¼Œ`Local` å’Œ `LocalStack` å®ç°äº†ä¸åŒçº¿ç¨‹/åç¨‹ä¹‹é—´çš„æ•°æ®éš”ç¦»ã€‚åœ¨ä¸ºä»€ä¹ˆç”¨ `LocalStack` è€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ `Local` çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¯´è¿‡è¿™æ˜¯å› ä¸º flask å¸Œæœ›åœ¨æµ‹è¯•æˆ–è€…å¼€å‘çš„æ—¶å€™ï¼Œå…è®¸å¤š app ã€å¤š request çš„æƒ…å†µã€‚è€Œ `LocalProxy` ä¹Ÿæ˜¯å› ä¸ºè¿™ä¸ªæ‰å¼•å…¥è¿›æ¥çš„ï¼

æˆ‘ä»¬æ‹¿ `current_app = LocalProxy(_find_app)` æ¥ä¸¾ä¾‹å­ã€‚æ¯æ¬¡ä½¿ç”¨ `current_app` çš„æ—¶å€™ï¼Œä»–éƒ½ä¼šè°ƒç”¨ `_find_app` å‡½æ•°ï¼Œç„¶åå¯¹å¾—åˆ°çš„å˜é‡è¿›è¡Œæ“ä½œã€‚

å¦‚æœç›´æ¥ä½¿ç”¨ `current_app = _find_app()` æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼ŸåŒºåˆ«å°±åœ¨äºï¼Œæˆ‘ä»¬å¯¼å…¥è¿›æ¥ä¹‹åï¼Œ`current_app` å°±ä¸ä¼šå†å˜åŒ–äº†ã€‚å¦‚æœæœ‰å¤š app çš„æƒ…å†µï¼Œå°±ä¼šå‡ºç°é”™è¯¯ï¼Œæ¯”å¦‚ï¼š
```python
from flask import current_app

app = create_app()
admin_app = create_admin_app()

def do_something():
    with app.app_context():
        work_on(current_app)
        with admin_app.app_context():
            work_on(current_app)
```

è¿™é‡Œæˆ‘ä»¬å‡ºç°äº†åµŒå¥—çš„ appï¼Œæ¯ä¸ª with ä¸Šä¸‹æ–‡éƒ½éœ€è¦æ“ä½œå…¶å¯¹åº”çš„ `app`ï¼Œå¦‚æœä¸é€‚ç”¨ `LocalProxy` æ˜¯åšä¸åˆ°çš„ã€‚

å¯¹äº `request` ä¹Ÿæ˜¯ç±»ä¼¼ï¼ä½†æ˜¯è¿™ç§æƒ…å†µçœŸçš„å¾ˆå°‘å‘ç”Ÿï¼Œæœ‰å¿…è¦è´¹è¿™ä¹ˆå¤§çš„åŠŸå¤«å¢åŠ è¿™ä¹ˆå¤šå¤æ‚åº¦å—ï¼Ÿ

å…¶å®è¿˜æœ‰ä¸€ä¸ªæ›´å¤§çš„é—®é¢˜ï¼Œè¿™ä¸ªä¾‹å­ä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ã€‚æ¯”å¦‚æˆ‘ä»¬çŸ¥é“ `current_app` æ˜¯åŠ¨æ€çš„ï¼Œå› ä¸ºå®ƒèƒŒåå¯¹åº”çš„æ ˆä¼š push å’Œ pop å…ƒç´ è¿›å»ã€‚é‚£åˆšå¼€å§‹çš„æ—¶å€™ï¼Œæ ˆä¸€å®šæ˜¯ç©ºçš„ï¼Œåªæœ‰åœ¨ `with app.app_context()` è¿™å¥çš„æ—¶å€™ï¼Œæ‰æŠŠæ ˆæ•°æ® push è¿›å»ã€‚è€Œå¦‚æœä¸é‡‡ç”¨ `LocalProxy` è¿›è¡Œè½¬å‘ï¼Œé‚£ä¹ˆåœ¨æœ€ä¸Šé¢å¯¼å…¥ `from flask import current_app` çš„æ—¶å€™ï¼Œ`current_app` å°±æ˜¯ç©ºçš„ï¼Œå› ä¸ºè¿™ä¸ªæ—¶å€™è¿˜æ²¡æœ‰æŠŠæ•°æ® push è¿›å»ï¼Œåé¢è°ƒç”¨çš„æ—¶å€™æ ¹æœ¬æ— æ³•ä½¿ç”¨ã€‚

æ‰€ä»¥ä¸ºä»€ä¹ˆéœ€è¦ `LocalProxy` å‘¢ï¼Ÿç®€å•æ€»ç»“ä¸€å¥è¯ï¼šå› ä¸ºä¸Šä¸‹æ–‡ä¿å­˜çš„æ•°æ®æ˜¯ä¿å­˜åœ¨æ ˆé‡Œçš„ï¼Œå¹¶ä¸”ä¼šåŠ¨æ€å‘ç”Ÿå˜åŒ–ã€‚å¦‚æœä¸æ˜¯åŠ¨æ€åœ°å»è®¿é—®ï¼Œä¼šé€ æˆæ•°æ®è®¿é—®å¼‚å¸¸ã€‚

## å‚è€ƒèµ„æ–™

*   [advanced flask patterns by Armin Ronacher](https://speakerdeck.com/mitsuhiko/advanced-flask-patterns)
*   [Flask doc: The application context](http://flask.pocoo.org/docs/0.12/appcontext/)
*   [Flask çš„ Context æœºåˆ¶](https://blog.tonyseek.com/post/the-context-mechanism-of-flask/)