---
title: Python ä¸­ OOMï¼ˆå†…å­˜æ³„æ¼ï¼‰é—®é¢˜çš„å®šä½ä¸åˆ†æ
date: 2025-05-30 10:16:57
permalink: /python/oom/
categories:
  - ğŸPython
  - é¢è¯•
tags:
  - OOM
---

åœ¨ Python åç«¯é¡¹ç›®ä¸­ï¼Œå‡ºç°**å†…å­˜æº¢å‡ºï¼ˆOut of Memory, OOMï¼‰** æ—¶ï¼Œé€šå¸¸æ˜¯ç”±äºå†…å­˜æ³„æ¼æˆ–èµ„æºæœªæ­£ç¡®é‡Šæ”¾å¯¼è‡´ã€‚ä»¥ä¸‹æ˜¯ç³»ç»ŸåŒ–çš„åŸå› åˆ†æä¸å®šä½æ–¹æ³•ï¼š

## ç†è®ºåŸºç¡€

### **ä¸€ã€åˆæ­¥ç¡®è®¤å†…å­˜é—®é¢˜**

1. **è§‚å¯Ÿç°è±¡**ï¼š
   - è¿›ç¨‹å ç”¨å†…å­˜æŒç»­å¢é•¿ï¼Œç›´è‡³è¢«ç³»ç»Ÿæ€æ­»ï¼ˆå¦‚`Killed`æ—¥å¿—ï¼‰ã€‚
   - å‡ºç°`MemoryError`å¼‚å¸¸æˆ–æœåŠ¡æ€§èƒ½ä¸¥é‡ä¸‹é™ã€‚
2. **ç›‘æ§å·¥å…·**ï¼š
   - **ç³»ç»Ÿçº§ç›‘æ§**ï¼š`top`ã€`htop`ã€`ps`ï¼ˆæŸ¥çœ‹è¿›ç¨‹å†…å­˜å ç”¨`RES`æˆ–`%MEM`ï¼‰ã€‚
   - **Python å†…ç½®æ¨¡å—**ï¼š`tracemalloc`ï¼ˆè·Ÿè¸ªå†…å­˜åˆ†é…ï¼‰ã€`resource`ï¼ˆç›‘æ§èµ„æºé™åˆ¶ï¼‰ã€‚
    1. `tracemalloc` ç¤ºä¾‹å¦‚ä¸‹ï¼š

        ```python
        import tracemalloc
        tracemalloc.start()
        # ...è¿è¡Œä»£ç ...
        snapshot = tracemalloc.take_snapshot()
        top_stats = snapshot.statistics('lineno')
        for stat in top_stats[:10]:
            print(stat)
        ```

    2. ä½¿ç”¨`sys.settrace`å‡½æ•°è®¾ç½®ä¸€ä¸ªè·Ÿè¸ªå‡½æ•°ï¼Œä»¥ä¾¿åœ¨ç¨‹åºè¿è¡ŒæœŸé—´è·Ÿè¸ªå†…å­˜ä½¿ç”¨æƒ…å†µã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š

    ```python
    import sys

    def trace_memory(frame, event, arg):
        # åœ¨è¿™é‡Œè®°å½•å†…å­˜ä½¿ç”¨æƒ…å†µ
        print(event, sys.getsizeof(arg))

    sys.settrace(trace_memory)

    # è¿è¡Œä½ çš„ä»£ç 
    ```

### **äºŒã€å®šä½å†…å­˜æ³„æ¼çš„æ ¸å¿ƒæ­¥éª¤**

#### **1. ä½¿ç”¨å†…å­˜åˆ†æå·¥å…·**

- **å·¥å…·é€‰æ‹©**ï¼š
  - **`objgraph`**ï¼šå¯è§†åŒ–å¯¹è±¡å¼•ç”¨å…³ç³»ï¼Œæ£€æµ‹å¾ªç¯å¼•ç”¨ã€‚
  - **`memory_profiler`**ï¼šé€è¡Œåˆ†æå†…å­˜å¢é•¿ã€‚
  - **`pympler`**ï¼šç»Ÿè®¡å¯¹è±¡å†…å­˜å ç”¨ã€‚
  - **`guppy3`**ï¼ˆæˆ–`heapy`ï¼‰ï¼šåˆ†æå †å†…å­˜å¯¹è±¡ã€‚

- **ç¤ºä¾‹ï¼ˆ`memory_profiler`ï¼‰**ï¼š

  ```python
  # å®‰è£…ï¼špip install memory_profiler
  from memory_profiler import profile

  @profile
  def my_func():
      a = [1] * 100000
      b = [2] * 200000
      return a + b

  if __name__ == "__main__":
      my_func()
  ```

  è¾“å‡ºç»“æœï¼š

  ```plain
  Line #    Mem usage    Increment  Occurrences  Line Contents
  ===========================================================
  4     38.5 MiB     38.5 MiB           1   @profile
  5                                         def my_func():
  6     39.3 MiB      0.8 MiB           1       a = [1] * 100000
  7     40.9 MiB      1.6 MiB           1       b = [2] * 200000
  8     43.3 MiB      2.4 MiB           1       return a + b
  ```

- `guppy`åº“ä¸­çš„`hpy`æ¨¡å—ç¤ºä¾‹å¦‚ä¸‹ï¼š

   ```python
   from guppy import hpy

   h = hpy()

   # åœ¨éœ€è¦æ£€æŸ¥å†…å­˜ä½¿ç”¨æƒ…å†µçš„åœ°æ–¹è°ƒç”¨h.heap()æ–¹æ³•
   print(h.heap())
   ```

- ä½¿ç”¨`resource`æ¨¡å—æ¥è®¾ç½®è¿›ç¨‹çš„èµ„æºé™åˆ¶ï¼Œä¾‹å¦‚è®¾ç½®è™šæ‹Ÿå†…å­˜é™åˆ¶ã€å †æ ˆå¤§å°ç­‰ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š

   ```python
   import resource

   # è®¾ç½®è™šæ‹Ÿå†…å­˜é™åˆ¶ä¸º1GB
   resource.setrlimit(resource.RLIMIT_AS, (1e9, -1))
   ```

- åœ¨è¿è¡Œç¨‹åºæ—¶ä½¿ç”¨`pympler.muppy`å’Œ`pympler.summary`æ¥è·å–å†…å­˜å¿«ç…§å’Œå¯¹è±¡æ‘˜è¦ä¿¡æ¯ã€‚ç¤ºä¾‹å¦‚ä¸‹ï¼š

   ```python
   from pympler import muppy, summary

   all_objects = muppy.get_objects()
   sum1 = summary.summarize(all_objects)
   summary.print_(sum1)
   ```

   ä»¥ä¸Šæ–¹æ³•å¯ä»¥å¸®åŠ©ä½ æ‰¾åˆ° Python ç¨‹åºå†…å­˜ä¸è¶³çš„é—®é¢˜æ‰€åœ¨ï¼Œå¹¶è¿›è¡Œç›¸åº”çš„è°ƒè¯•å’Œä¼˜åŒ–ã€‚

#### **2. æ£€æµ‹å¾ªç¯å¼•ç”¨**

Python çš„åƒåœ¾å›æ”¶ï¼ˆGCï¼‰èƒ½å¤„ç†å¤§éƒ¨åˆ†å¾ªç¯å¼•ç”¨ï¼Œä½†æŸäº›æƒ…å†µï¼ˆå¦‚å«`__del__`æ–¹æ³•çš„å¯¹è±¡ï¼‰ä»éœ€æ‰‹åŠ¨å¹²é¢„ã€‚

- **ä½¿ç”¨`objgraph`æŸ¥æ‰¾å¾ªç¯å¼•ç”¨**ï¼š

  ```python
  import objgraph

  # ç”Ÿæˆå¼•ç”¨å…³ç³»å›¾ï¼ˆéœ€å®‰è£…graphvizï¼‰
  objgraph.show_backrefs(objgraph.by_type('MyClass'), filename='refs.png')

  # ç»Ÿè®¡å‰Nä¸ªæœ€å¤šå®ä¾‹çš„ç±»å‹
  objgraph.show_most_common_types(limit=10)

  # å¯è§†åŒ–å¯¹è±¡å¼•ç”¨å…³ç³»ï¼Œæ‰¾å‡ºå†…å­˜å ç”¨å¤§æˆ·
  objgraph.show_growth()  # æŸ¥çœ‹å¢é•¿æœ€å¿«çš„å¯¹è±¡ç±»å‹
  ```

#### **3. åˆ†æå¤§å¯¹è±¡æˆ–ç¼“å­˜**

- **æ£€æŸ¥å…¨å±€å˜é‡æˆ–ç¼“å­˜**ï¼š
  - å…¨å±€å­—å…¸ã€åˆ—è¡¨å¯èƒ½æ„å¤–æŒæœ‰å¤§å¯¹è±¡ã€‚å°è¯•å‡å°‘ç¨‹åºæ‰€éœ€çš„å†…å­˜ä½¿ç”¨é‡ï¼Œä¾‹å¦‚ä½¿ç”¨ç”Ÿæˆå™¨è€Œä¸æ˜¯åˆ—è¡¨æ¥è¿­ä»£å¤§é‡æ•°æ®ã€ä½¿ç”¨é€‚å½“çš„æ•°æ®ç»“æ„ç­‰ã€‚
  - **åˆ†å—å¤„ç†**ï¼šå¯¹å¤§æ–‡ä»¶æˆ–æ•°æ®é›†è¿›è¡Œåˆ†æ‰¹å¤„ç†ï¼Œä¾‹å¦‚ï¼š
    ```python
    with open('large_file.txt') as f:
        for chunk in iter(lambda: f.read(1024), ''):
            process(chunk)
    ```
  - ç¼“å­˜æœªè®¾ç½®è¿‡æœŸç­–ç•¥ï¼ˆå¦‚ä½¿ç”¨`functools.lru_cache`æœªé™åˆ¶`maxsize`ï¼‰ã€‚

  ```python
  # é”™è¯¯çš„ç¼“å­˜ä½¿ç”¨ï¼šæœªé™åˆ¶å¤§å°
  @lru_cache(maxsize=None)
  def heavy_calculation(x):
      return x ** x
  ```

#### **4. æ£€æŸ¥ç¬¬ä¸‰æ–¹åº“æˆ– C æ‰©å±•**

- **C æ‰©å±•æ¨¡å—**ï¼šå¦‚`numpy`ã€`pandas`å¤„ç†å¤§æ•°æ®æ—¶æœªé‡Šæ”¾å†…å­˜ã€‚
  - æ˜¾å¼è°ƒç”¨`.close()`æˆ–`del`é‡Šæ”¾èµ„æºã€‚
- **æ•°æ®åº“è¿æ¥æ± æœªå›æ”¶**ï¼šå¦‚ SQLAlchemy è¿æ¥æœªæ­£ç¡®å…³é—­ã€‚

### **ä¸‰ã€å¸¸è§å†…å­˜æ³„æ¼åœºæ™¯**

#### **1. æœªé‡Šæ”¾æ–‡ä»¶/ç½‘ç»œèµ„æº**

```python
# é”™è¯¯ï¼šæœªå…³é—­æ–‡ä»¶å¥æŸ„
def read_large_file():
    f = open('huge.log', 'r')
    return f.read()

# æ­£ç¡®ï¼šä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨
def read_large_file():
    with open('huge.log', 'r') as f:
        return f.read()
```

#### **2. å¾ªç¯å¼•ç”¨ + æ— æ³•è¢« GC å›æ”¶**

```python
class Node:
    def __init__(self):
        self.parent = None

# åˆ›å»ºå¾ªç¯å¼•ç”¨
a = Node()
b = Node()
a.parent = b
b.parent = a

# å³ä½¿delåï¼Œè‹¥å¯¹è±¡æœ‰__del__æ–¹æ³•ï¼ŒGCå¯èƒ½æ— æ³•å›æ”¶
del a, b
```

#### **3. çº¿ç¨‹æˆ–å¼‚æ­¥ä»»åŠ¡æœªç»ˆæ­¢**

- åå°çº¿ç¨‹æˆ–åç¨‹æŒç»­è¿è¡Œï¼ŒæŒæœ‰å¯¹è±¡å¼•ç”¨ã€‚

### **å››ã€é«˜çº§è¯Šæ–­æ–¹æ³•**

#### **1. ä½¿ç”¨`gc`æ¨¡å—è°ƒè¯•**

```python
import gc

# æ‰‹åŠ¨è§¦å‘åƒåœ¾å›æ”¶
gc.collect()

# æŸ¥çœ‹æ— æ³•å›æ”¶çš„å¯¹è±¡
gc.garbage  # åˆ—è¡¨æ˜¾ç¤ºæ— æ³•å›æ”¶çš„å¯¹è±¡
```

#### **2. ç”Ÿæˆå†…å­˜å¿«ç…§å¯¹æ¯”**

é€šè¿‡å¤šæ¬¡å¿«ç…§å¯¹æ¯”ï¼Œæ‰¾å‡ºå†…å­˜å¢é•¿ç‚¹ï¼š

```python
import tracemalloc

tracemalloc.start()
snapshot1 = tracemalloc.take_snapshot()

# æ‰§è¡Œæ€€ç–‘æœ‰æ³„æ¼çš„ä»£ç 
run_suspected_code()

snapshot2 = tracemalloc.take_snapshot()
top_stats = snapshot2.compare_to(snapshot1, 'lineno')

for stat in top_stats[:10]:
    print(stat)
```

#### **3. ä½¿ç”¨ Valgrindï¼ˆLinuxï¼‰**

é’ˆå¯¹ Python çš„ C æ‰©å±•å†…å­˜æ³„æ¼ï¼š

```bash
valgrind --tool=memcheck --suppressions=python.supp python3 my_script.py
```

### **äº”ã€ä¿®å¤ä¸é¢„é˜²**

1. **ä¿®å¤ä»£ç **ï¼š
   - ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆ`with`è¯­å¥ï¼‰ç®¡ç†èµ„æºã€‚
   - é¿å…å…¨å±€å˜é‡é•¿æœŸæŒæœ‰å¤§å¯¹è±¡ã€‚
   - å¯¹ç¼“å­˜è®¾ç½®å¤§å°é™åˆ¶å’Œè¿‡æœŸæ—¶é—´ã€‚
2. **ä¼˜åŒ–æ•°æ®ç»“æ„**ï¼š
   - ä½¿ç”¨ç”Ÿæˆå™¨ï¼ˆ`yield`ï¼‰æ›¿ä»£åˆ—è¡¨å¤„ç†å¤§æ•°æ®ã€‚
   - ä½¿ç”¨`numpy`/`pandas`æ—¶åŠæ—¶é‡Šæ”¾å†…å­˜ã€‚
3. **ç›‘æ§ä¸æŠ¥è­¦**ï¼š
   - é›†æˆ Prometheus + Grafana ç›‘æ§è¿›ç¨‹å†…å­˜ã€‚
   - ä½¿ç”¨`psutil`å®šæ—¶ä¸ŠæŠ¥å†…å­˜ä½¿ç”¨ï¼š

     ```python
     import psutil
     process = psutil.Process()
     print(process.memory_info().rss)  # è·å–ç‰©ç†å†…å­˜å ç”¨
     ```

### **å…­ã€å·¥å…·é“¾æ€»ç»“**

| **å·¥å…·**          | **ç”¨é€”**                               |
|--------------------|---------------------------------------|
| `tracemalloc`      | å®šä½å†…å­˜åˆ†é…ä½ç½®                      |
| `memory_profiler`  | é€è¡Œåˆ†æå†…å­˜å¢é•¿                      |
| `objgraph`         | å¯è§†åŒ–å¯¹è±¡å¼•ç”¨å…³ç³»                    |
| `gc`               | æ‰‹åŠ¨è§¦å‘åƒåœ¾å›æ”¶å¹¶æ£€æŸ¥ä¸å¯å›æ”¶å¯¹è±¡    |
| `pympler`          | ç»Ÿè®¡å¯¹è±¡å†…å­˜å ç”¨                      |

### **ä¸ƒã€æ¡ˆä¾‹å®æˆ˜**

**åœºæ™¯**ï¼šä¸€ä¸ª FastAPI æœåŠ¡å¤„ç†å¤§æ–‡ä»¶ä¸Šä¼ åå†…å­˜ä¸é‡Šæ”¾ã€‚

1. **åˆ†ææ­¥éª¤**ï¼š
   - ä½¿ç”¨`memory_profiler`å‘ç°ä¸Šä¼ æ¥å£å†…å­˜æ¿€å¢ã€‚
   - å‘ç°ä»£ç ä¸­å°†æ–‡ä»¶å†…å®¹å­˜å…¥å…¨å±€åˆ—è¡¨ï¼š

     ```python
     uploaded_files = []

     @app.post("/upload")
     async def upload(file: UploadFile):
         content = await file.read()
         uploaded_files.append(content)  # å†…å­˜æ³„æ¼ï¼
     ```

2. **ä¿®å¤æ–¹æ¡ˆ**ï¼š
   - ç§»é™¤å…¨å±€åˆ—è¡¨ï¼Œæ”¹ä¸ºå¤„ç†å®Œç«‹å³é‡Šæ”¾ã€‚
   - ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶æˆ–æµå¼å¤„ç†ã€‚

### **æ€»ç»“**

- **æ ¸å¿ƒæ€è·¯**ï¼šç›‘æ§ â†’ å®šä½ â†’ åˆ†æ â†’ ä¿®å¤ â†’ é¢„é˜²ã€‚
- **å…³é”®ç‚¹**ï¼šä¼˜å…ˆæ£€æŸ¥å…¨å±€å˜é‡ã€ç¼“å­˜ã€èµ„æºé‡Šæ”¾ï¼Œç»“åˆå·¥å…·å¿«é€Ÿç¼©å°èŒƒå›´ã€‚
- **Python ç‰¹æ€§**ï¼šè™½ç„¶è‡ªåŠ¨å†…å­˜ç®¡ç†ï¼Œä½†å¼€å‘è€…ä»éœ€æ³¨æ„å¯¹è±¡ç”Ÿå‘½å‘¨æœŸå’Œå¤–éƒ¨èµ„æºç®¡ç†ã€‚

## æ›´å¤šå®æˆ˜æ¡ˆä¾‹

### ç›‘æµ‹æ–°æ—§ç‰ˆæœ¬å†…å­˜å˜åŒ–å·®å¼‚

ç›®å‰`python`å¸¸ç”¨çš„å†…å­˜æ£€æµ‹å·¥å…·æœ‰`pympler`ã€`objgraph`ã€`tracemalloc`Â ç­‰ã€‚

é¦–å…ˆï¼Œé€šè¿‡`objgraph`å·¥å…·ï¼Œå¯¹æ–°æ—§æœåŠ¡ä¸­çš„ TOP50 å˜é‡ç±»å‹è¿›è¡Œäº†è§‚å¯Ÿç»Ÿè®¡

`objraph`å¸¸ç”¨å‘½ä»¤å¦‚ä¸‹ï¼š

```python
# å…¨å±€ç±»å‹æ•°é‡
objgraph.show_most_common_types(limit=50)

# å¢é‡å˜åŒ–
objgraph.show_growth(limit=30)
```

è¿™é‡Œä¸ºäº†æ›´å¥½çš„è§‚æµ‹å˜åŒ–æ›²çº¿ï¼Œæˆ‘ç®€å•åšäº†ä¸ªå°è£…ï¼Œä½¿æ•°æ®ç›´æ¥è¾“å‡ºåˆ°äº† csv æ–‡ä»¶ä»¥ä¾¿è§‚å¯Ÿã€‚

```python
stats = objgraph.most_common_types(limit=50)
stats_path = "./types_stats.csv"
tmp_dict = dict(stats)
req_time = time.strftime("%Y-%m-%d %H:%M:%S", time.localtime())
tmp_dict['req_time'] = req_time
df = pd.DataFrame.from_dict(tmp_dict, orient='index').T

if os.path.exists(stats_path):
    df.to_csv(stats_path, mode='a', header=True, index=False)
else:
    df.to_csv(stats_path, index=False)
```

å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œç”¨ä¸€æ‰¹å›¾ç‰‡åœ¨æ–°æ—§ä¸¤ä¸ªç‰ˆæœ¬ä¸Šè·‘äº† 1 ä¸ªå°æ—¶ï¼Œä¸€åˆ‡ç¨³å¦‚è€ç‹—ï¼Œå„ç±»å‹çš„æ•°é‡æ²¡æœ‰ä¸€ä¸æ³¢æ¾œã€‚

![](https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/029/274/683/0080086000029274683.20211123103146.33489894230151474441534849176816:50001231000000:2800:5CFDB6490C6CDF552B930122C214612E18679F943143173D313E00F5769B311D.png)

æ­¤æ—¶ï¼Œæƒ³åˆ°è‡ªå·±ä¸€èˆ¬åœ¨è½¬æµ‹æˆ–ä¸Šçº¿å‰éƒ½ä¼šå°†ä¸€æ‰¹å¼‚å¸¸æ ¼å¼çš„å›¾ç‰‡æ‹¿æ¥åšä¸ªè¾¹ç•ŒéªŒè¯ã€‚

è™½ç„¶è¿™äº›å¼‚å¸¸ï¼Œæµ‹è¯•åŒå­¦ä¸Šçº¿å‰è‚¯å®šéƒ½å·²ç»éªŒè¯è¿‡äº†ï¼Œä½†æ­»é©¬å½“æˆæ´»é©¬åŒ»å°±é¡ºæ‰‹æ‹¿æ¥æµ‹äº†ä¸€ä¸‹ã€‚

å¹³é™æ•°æ®å°±æ­¤è¢«æ‰“ç ´äº†ï¼Œå¦‚ä¸‹å›¾çº¢æ¡†æ‰€ç¤ºï¼šdictã€functionã€methodã€tupleã€traceback ç­‰é‡è¦ç±»å‹çš„æ•°é‡å¼€å§‹ä¸æ–­æ”€å‡ã€‚

![](https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/029/274/683/0080086000029274683.20211123103146.13074858538065114599818057323700:50001231000000:2800:2585BA170377330326AA8085F04EB3151D2EB65BA4219C6A1141CCF39A6801AC.png)

è€Œæ­¤æ—¶é•œåƒå†…å­˜äº¦ä¸æ–­å¢åŠ ä¸”æ¯«æ— æ”¶æ•›è¿¹è±¡ã€‚

![](https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/029/274/683/0080086000029274683.20211123103146.01313233318543513486583888169638:50001231000000:2800:EF83B321CE4F28EA4D66E20B9EA660A62BA49828545570056AF8F00BE1AD02C3.png)

ç”±æ­¤ï¼Œè™½æ— æ³•ç¡®è®¤æ˜¯å¦ä¸ºçº¿ä¸Šé—®é¢˜ï¼Œä½†è‡³å°‘å®šä½å‡ºäº†ä¸€ä¸ª bugã€‚è€Œæ­¤æ—¶å›å¤´æ£€æŸ¥æ—¥å¿—ï¼Œå‘ç°äº†ä¸€ä¸ªå¥‡æ€ªçš„ç°è±¡ï¼š

æ­£å¸¸æƒ…å†µä¸‹ç‰¹æ®Šå›¾ç‰‡å¯¼è‡´çš„å¼‚å¸¸ï¼Œæ—¥å¿—åº”è¯¥è¾“å‡ºå¦‚ä¸‹ä¿¡æ¯ï¼Œå³ check\_image\_type æ–¹æ³•åœ¨å¼‚å¸¸æ ˆä¸­åªä¼šæ‰“å°ä¸€æ¬¡ã€‚

![](https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/029/274/683/0080086000029274683.20211123103146.61596142676508310224086911170886:50001231000000:2800:ABD5A7DC04080DD6BB6C8245645882163B7A04994D3BB6D5AF63CEA35C941431.png)

ä½†ç°çŠ¶æ˜¯ check\_image\_type æ–¹æ³•å¾ªç¯é‡å¤æ‰“å°äº†å¤šæ¬¡ï¼Œä¸”é‡å¤æ¬¡æ•°éšç€æµ‹è¯•æ¬¡æ•°åœ¨ä¸€èµ·å˜å¤šã€‚

![](https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/029/274/683/0080086000029274683.20211123103146.01578016075748654762806495888394:50001231000000:2800:CAA60A60E37930D62DDEE656B3E61AAE264260B402DD2F9F6635DD4ABE441BF7.png)

é‡æ–°ç ”ç©¶äº†è¿™å—å„¿çš„å¼‚å¸¸å¤„ç†ä»£ç ã€‚

å¼‚å¸¸å£°æ˜å¦‚ä¸‹ï¼š

![](https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/029/274/683/0080086000029274683.20211123103146.36657576268386480005679869898135:50001231000000:2800:4136B06E28CA0C7992BFE6D2F4261A50D039BC7607015E5794474BE6F7322B0B.png)

æŠ›å¼‚å¸¸ä»£ç å¦‚ä¸‹ï¼š

![](https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/029/274/683/0080086000029274683.20211123103146.20969856006702535784655952307329:50001231000000:2800:BD64E46BA904D976F9686C5EF41ACB0B4B7BF247AE59F225747AC984417097A9.png)

#### é—®é¢˜æ‰€åœ¨

æ€è€ƒåå¤§æ¦‚æƒ³æ¸…æ¥šäº†é—®é¢˜æ ¹æºï¼š

è¿™é‡Œæ¯ä¸ªå¼‚å¸¸å®ä¾‹ç›¸å½“äºè¢«å®šä¹‰æˆäº†ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œè€Œåœ¨æŠ›å¼‚å¸¸çš„æ—¶å€™ï¼ŒæŠ›å‡ºçš„ä¹Ÿæ­£æ˜¯è¿™ä¸ªå…¨å±€å˜é‡ã€‚å½“æ­¤å…¨å±€å˜é‡è¢«å‹å…¥å¼‚å¸¸æ ˆå¤„ç†å®Œæˆä¹‹åï¼Œä¹Ÿå¹¶ä¸ä¼šè¢«å›æ”¶ã€‚

å› æ­¤éšç€é”™è¯¯æ ¼å¼å›¾ç‰‡è°ƒç”¨çš„ä¸æ–­å¢å¤šï¼Œå¼‚å¸¸æ ˆä¸­çš„ä¿¡æ¯ä¹Ÿä¼šä¸æ–­å¢å¤šã€‚è€Œä¸”ç”±äºå¼‚å¸¸ä¸­è¿˜åŒ…å«ç€è¯·æ±‚å›¾ç‰‡ä¿¡æ¯ï¼Œå› æ­¤å†…å­˜ä¼šå‘ˆ MB çº§åˆ«çš„å¢åŠ ã€‚

ä½†è¿™éƒ¨åˆ†ä»£ç ä¸Šçº¿å·²ä¹…ï¼Œçº¿ä¸Šå¦‚æœçœŸçš„ä¹Ÿæ˜¯è¿™é‡Œå¯¼è‡´çš„é—®é¢˜ï¼Œä¸ºä½•ä¹‹å‰æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œè€Œä¸”ä¸ºä½•åœ¨ A èŠ¯ç‰‡ä¸Šä¹Ÿæ²¡æœ‰å‡ºç°ä»»ä½•é—®é¢˜ï¼Ÿ

å¸¦ç€ä»¥ä¸Šä¸¤ä¸ªç–‘é—®ï¼Œæˆ‘ä»¬åšäº†ä¸¤ä¸ªéªŒè¯ï¼š

é¦–å…ˆï¼Œç¡®è®¤äº†ä¹‹å‰çš„ç‰ˆæœ¬ä»¥åŠ A èŠ¯ç‰‡ä¸ŠåŒæ ·ä¼šå‡ºç°æ­¤é—®é¢˜ã€‚

å…¶æ¬¡ï¼Œæˆ‘ä»¬æŸ¥çœ‹äº†çº¿ä¸Šçš„è°ƒç”¨è®°å½•ï¼Œå‘ç°æœ€è¿‘åˆšå¥½æ–°æ¥å…¥äº†ä¸€ä¸ªå®¢æˆ·ï¼Œè€Œä¸”å‡ºç°äº†å¤§é‡ä½¿ç”¨ç±»ä¼¼é—®é¢˜çš„å›¾ç‰‡è°ƒç”¨æŸå±€ç‚¹ï¼ˆè¯¥å±€ç‚¹å¤§éƒ¨åˆ†ä¸º B èŠ¯ç‰‡ï¼‰æœåŠ¡çš„ç°è±¡ã€‚æˆ‘ä»¬æ‰¾äº†äº›çº¿ä¸Šå®ä¾‹ï¼Œä»æ—¥å¿—ä¸­ä¹Ÿè§‚æµ‹åˆ°äº†åŒæ ·çš„ç°è±¡ã€‚

ç”±æ­¤ï¼Œä»¥ä¸Šç–‘é—®åŸºæœ¬å¾—åˆ°äº†è§£é‡Šï¼Œä¿®å¤æ­¤ bug åï¼Œå†…å­˜æº¢å‡ºé—®é¢˜ä¸å†å‡ºç°ã€‚

### è¿›é˜¶æ€è·¯

è®²é“ç†ï¼Œé—®é¢˜è§£å†³åˆ°è¿™ä¸ªåœ°æ­¥ä¼¼ä¹å¯ä»¥æ”¶å·¥äº†ã€‚ä½†æˆ‘é—®äº†è‡ªå·±ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœå½“åˆæ²¡æœ‰æ‰“å°è¿™ä¸€è¡Œæ—¥å¿—ï¼Œæˆ–è€…å¼€å‘äººå‘˜å·æ‡’æ²¡æœ‰æŠŠå¼‚å¸¸æ ˆå…¨éƒ¨æ‰“å‡ºæ¥ï¼Œé‚£åº”è¯¥å¦‚ä½•å»å®šä½ï¼Ÿ

å¸¦ç€è¿™æ ·çš„é—®é¢˜æˆ‘ç»§ç»­ç ”ç©¶äº†ä¸‹ objgraphã€pymplerÂ å·¥å…·ã€‚

å‰æ–‡å·²ç»å®šä½åˆ°äº†åœ¨å¼‚å¸¸å›¾ç‰‡æƒ…å†µä¸‹ä¼šå‡ºç°å†…å­˜æ³„æ¼ï¼Œå› æ­¤é‡ç‚¹æ¥çœ‹ä¸‹æ­¤æ—¶æœ‰å“ªäº›å¼‚æ ·æƒ…å†µï¼š

é€šè¿‡å¦‚ä¸‹å‘½ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°æ¯æ¬¡å¼‚å¸¸å‡ºç°æ—¶ï¼Œå†…å­˜ä¸­éƒ½å¢åŠ äº†å“ªäº›å˜é‡ä»¥åŠå¢åŠ çš„å†…å­˜æƒ…å†µã€‚

1. ä½¿ç”¨`objgraph`å·¥å…·

    ```python
    objgraph.show_growth(limit=20)
    ```

    ![](https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/029/274/683/0080086000029274683.20211123103146.90681267256879397347844961960706:50001231000000:2800:60E52723B0443E101AF101792689C57E6194E5E8EFD694CD28117EDB265859EC.png)

2. ä½¿ç”¨`pympler`å·¥å…·

```python
from pympler import tracker
tr = tracker.SummaryTracker()tr.print_diff()
```

![](https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/029/274/683/0080086000029274683.20211123103146.47277874892323173409808212213357:50001231000000:2800:3A4585D27F6E2AB2176CF04BD4D9251A3A80DF4894F757AF303F5CB25F5CF6AE.png)

é€šè¿‡å¦‚ä¸‹ä»£ç ï¼Œå¯ä»¥æ‰“å°å‡ºè¿™äº›æ–°å¢å˜é‡æ¥è‡ªå“ªäº›å¼•ç”¨ï¼Œä»¥ä¾¿è¿›ä¸€æ­¥åˆ†æã€‚
  
```python
gth = objgraph.growth(limit=20)
for gt in gth:
    logger.info("growth type:%s, count:%s, growth:%s" % (gt[0], gt[1], gt[2]))
    if gt[2] > 100 or gt[1] > 300:
        continue
    objgraph.show_backrefs(objgraph.by_type(gt[0])[0], max_depth=10, too_many=5,
                           filename="./dots/%s_backrefs.dot" % gt[0])
    objgraph.show_refs(objgraph.by_type(gt[0])[0], max_depth=10, too_many=5,
                       filename="./dots/%s_refs.dot" % gt[0])
    objgraph.show_chain(
        objgraph.find_backref_chain(objgraph.by_type(gt[0])[0], objgraph.is_proper_module),
        filename="./dots/%s_chain.dot" % gt[0]
    )
```

é€šè¿‡`graphviz`çš„ dot å·¥å…·,å¯¹ä¸Šé¢ç”Ÿäº§çš„ graph æ ¼å¼æ•°æ®è½¬æ¢æˆå¦‚ä¸‹å›¾ç‰‡ï¼š

```dot -Tpng xxx.dot -o xxx.png```

è¿™é‡Œï¼Œç”±äº`dictã€listã€frameã€tupleã€method`ç­‰åŸºæœ¬ç±»å‹æ•°é‡å¤ªå¤šï¼Œè§‚æµ‹è¾ƒéš¾ï¼Œå› æ­¤è¿™é‡Œå…ˆåšäº†è¿‡æ»¤ã€‚

å†…å­˜æ–°å¢çš„`ImageReqWrapper`çš„è°ƒç”¨é“¾

![](https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/029/274/683/0080086000029274683.20211123103146.60661199741446662308793040033037:50001231000000:2800:89118B751471838303B979A187266A14A457AEB1FCC1265E0733D4CAC25837F7.png)

å†…å­˜æ–°å¢çš„ traceback çš„è°ƒç”¨é“¾ï¼š

![](https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/029/274/683/0080086000029274683.20211123103146.55968736408130250776256640771750:50001231000000:2800:102D1BCA4EB34886E445D0221BF40A2F6AE56D1D2FCAED2C16AB5DD32AD2C5B5.png)

è™½ç„¶å¸¦ç€å‰é¢çš„å…ˆéªŒçŸ¥è¯†ï¼Œä½¿æˆ‘ä»¬å¾ˆè‡ªç„¶çš„å°±å…³æ³¨åˆ°äº†`traceback`å’Œå…¶å¯¹åº”çš„`IMAGE_FORMAT_EXCEPTION`å¼‚å¸¸ã€‚

ä½†é€šè¿‡æ€è€ƒä¸ºä½•ä¸Šé¢è¿™äº›æœ¬åº”åœ¨æœåŠ¡è°ƒç”¨ç»“æŸåå°±è¢«å›æ”¶çš„å˜é‡å´æ²¡æœ‰è¢«å›æ”¶ï¼Œå°¤å…¶æ˜¯æ‰€æœ‰çš„`traceback`å˜é‡åœ¨è¢«`IMAGE_FORMAT_EXCEPTION`å¼‚å¸¸è°ƒç”¨åå°±æ— æ³•å›æ”¶ç­‰è¿™äº›ç°è±¡ï¼›åŒæ—¶å†åšä¸€äº›å°å®éªŒï¼Œç›¸ä¿¡å¾ˆå¿«å°±èƒ½å®šä½åˆ°é—®é¢˜æ ¹æºã€‚

å¦ï¼Œå…³äº `python3`ä¸­ ç¼“å­˜`Exception`å¯¼è‡´çš„å†…å­˜æ³„æ¼é—®é¢˜ï¼ŒçŸ¥ä¹æœ‰ä¸€ç¯‡è®²çš„ç›¸å¯¹æ›´æ¸…æ¥šä¸€ç‚¹ï¼š<https://zhuanlan.zhihu.com/p/38600861>

è‡³æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºå¦‚ä¸‹ï¼š

ç”±äºæŠ›å‡ºçš„å¼‚å¸¸æ— æ³•å›æ”¶ï¼Œå¯¼è‡´å¯¹åº”çš„å¼‚å¸¸æ ˆã€è¯·æ±‚ä½“ç­‰å˜é‡éƒ½æ— æ³•è¢«å›æ”¶ï¼Œè€Œè¯·æ±‚ä½“ä¸­ç”±äºåŒ…å«å›¾ç‰‡ä¿¡æ¯å› æ­¤æ¯æ¬¡è¿™ç±»è¯·æ±‚éƒ½ä¼šå¯¼è‡´ MB çº§åˆ«çš„å†…å­˜æ³„æ¼ã€‚

å¦å¤–ï¼Œç ”ç©¶è¿‡ç¨‹ä¸­è¿˜å‘ç°`python3`è‡ªå¸¦äº†ä¸€ä¸ªå†…å­˜åˆ†æå·¥å…·`tracemalloc`ï¼Œé€šè¿‡å¦‚ä¸‹ä»£ç å°±å¯ä»¥è§‚å¯Ÿä»£ç è¡Œä¸å†…å­˜ä¹‹é—´çš„å…³ç³»ï¼Œè™½ç„¶å¯èƒ½æœªå¿…ç²¾ç¡®ï¼Œä½†ä¹Ÿèƒ½å¤§æ¦‚æä¾›ä¸€äº›çº¿ç´¢ã€‚
  
```python
import tracemalloc

tracemalloc.start(25)
snapshot = tracemalloc.take_snapshot()
global snapshot
gc.collect()
snapshot1 = tracemalloc.take_snapshot()
top_stats = snapshot1.compare_to(snapshot, 'lineno')
logger.warning("[ Top 20 differences ]")
for stat in top_stats[:20]:
    if stat.size_diff < 0:
        continue
    logger.warning(stat)
snapshot = tracemalloc.take_snapshot()
```

![](https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtybbs/029/274/683/0080086000029274683.20211123103146.58662755938515197784298923902619:50001231000000:2800:6F7BC06AB863FA4828E467941FD961285994553F629DB748867A81F93B47BA0A.png)

## å‚è€ƒæ–‡ç« 

1. [Python å†…å­˜æ³„æ¼é—®é¢˜](https://testerhome.com/articles/19870)
2. [ç³»ç»ŸæŠ¥é”™ä¿¡æ¯](https://blog.51cto.com/u_3423936/3019476)  
3. [python å†…å­˜æ³„éœ²æ’æŸ¥](https://segmentfault.com/a/1190000038277797)  
4. [Python ä¹‹å†…å­˜æ³„æ¼å’Œå†…å­˜æº¢å‡º](https://www.cnblogs.com/zzbj/p/13532156.html)  
5. [python è¿›ç¨‹å†…å­˜å¢é•¿é—®é¢˜, è§£å†³æ–¹æ³•å’Œå·¥å…·](https://drmingdrmer.github.io/tech/programming/2017/05/06/python-mem.html)  
6. [ä¸è¦åœ¨ Python 3 ä¸­ç¼“å­˜ Exception å¯¹è±¡](https://zhuanlan.zhihu.com/p/38600861)
7. [å¡«å‘æ€»ç»“ï¼špython å†…å­˜æ³„æ¼æ’æŸ¥å°æŠ€å·§-åä¸ºå¼€å‘è€…è¯é¢˜ | åä¸ºå¼€å‘è€…è”ç›Ÿ](https://developer.huawei.com/consumer/cn/forum/topic/0204730461496200808)
