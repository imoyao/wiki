---
title: Python æ ‡å‡†åº“ç³»åˆ—ä¹‹ xml æ¨¡å—

tags: 
  - ç¼–ç 
  - é¢å‘å¯¹è±¡
top: 5
categories: 
  - ğŸ’» å·¥ä½œ
  - ğŸPython
  - å…¨æ ˆä¹‹è·¯
  - æ ‡å‡†åº“
date: 2020-05-23 18:21:46
permalink: /pages/c67788/
---

> Pythonâ€™s interfaces for processing XML are grouped in the xml package.

å¸¦åˆ†éš”ç¬¦çš„æ–‡ä»¶ä»…æœ‰ä¸¤ç»´çš„æ•°æ®ï¼šè¡Œå’Œåˆ—ã€‚å¦‚æœä½ æƒ³åœ¨ç¨‹åºä¹‹é—´äº¤æ¢æ•°æ®ç»“æ„ï¼Œéœ€è¦ä¸€ç§æ–¹æ³•æŠŠå±‚æ¬¡ç»“æ„ã€åºåˆ—ã€é›†åˆå’Œå…¶ä»–çš„ç»“æ„ç¼–ç æˆæ–‡æœ¬ã€‚

`XML`æ˜¯æœ€çªå‡ºçš„å¤„ç†è¿™ç§è½¬æ¢çš„æ ‡è®°(markup)æ ¼å¼ï¼Œå®ƒä½¿ç”¨æ ‡ç­¾(tag)åˆ†ä¸ªæ•°æ®ï¼Œå¦‚ä¸‹é¢çš„å®ä¾‹æ–‡ä»¶ menu.xml æ‰€ç¤ºï¼š

```xml
<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>å®‰ç”Ÿ&#39;s Blog</title>
  <subtitle>å¤§å¥½æ—¶å…‰ï¼</subtitle>
  <link href="/atom.xml" rel="self"/>

  <link href="https://blog.ansheng.me/"/>
  <updated>2016-05-24T15:29:19.000Z</updated>
  <id>https://blog.ansheng.me/</id>

  <author>
    <name>å®‰ç”Ÿ</name>
  </author>
</feed>
```

## XML çš„ä¸€äº›é‡è¦ç‰¹æ€§

1. æ ‡ç­¾ä»¥ä¸€ä¸ª`<`å­—ç¬¦å¼€å¤´ï¼Œä¾‹å¦‚å®ä¾‹ä¸­çš„ feedã€titleã€subtitleã€authorã€‚
2. å¿½ç•¥ç©ºæ ¼
3. é€šå¸¸ä¸€ä¸ªå¼€å§‹æ ‡ç­¾è·Ÿä¸€æ®µå…¶ä»–çš„å†…å®¹ï¼Œç„¶åæ˜¯æœ€åç›¸åŒ¹é…çš„ç»“æŸæ ‡ç­¾ï¼Œä¾‹å¦‚<subtitle>å¤§å¥½æ—¶å…‰ï¼</subtitle>
4. æ ‡ç­¾ä¹‹é—´æ˜¯å¯ä»¥å­˜åœ¨å¤šçº§åµŒå¥—çš„
5. å¯é€‰å±æ€§(attribute)å¯ä»¥å‡ºç°åœ¨å¼€å§‹æ ‡ç­¾é‡Œ
6. æ ‡ç­¾ä¸­å¯ä»¥åŒ…å«å€¼(value)
7. å¦‚æœä¸€ä¸ªå‘½åä¸º`thing`çš„æ ‡ç­¾å†…æ²¡æœ‰å†…å®¹æˆ–è€…å­æ ‡ç­¾ï¼Œé‚£ä¹ˆå®ƒå¯ä»¥ç”¨åœ¨å³å°–æ‹¬å·çš„å‰é¢æ·»åŠ æ–œæ çš„ç®€å•æ ‡ç­¾æ‰€è¡¨ç¤ºï¼Œä¾‹å¦‚<thing/>ä»£æ›¿å¼€å§‹å’Œç»“æŸéƒ½å­˜åœ¨çš„æ ‡ç­¾ã€‚
8. å­˜æ”¾æ•°æ®çš„ä½ç½®å¯ä»¥æ˜¯ä»»æ„çš„---å±æ€§ã€å€¼æˆ–è€…å­æ ‡ç­¾ã€‚

XML é€šå¸¸ç”¨äºæ•°æ®ä¼ é€å’Œæ¶ˆæ¯ï¼Œå®ƒå­˜åœ¨ä¸€äº›å­æ ¼å¼ï¼Œå¦‚ RSS å’Œ Atomï¼Œä¾‹å¦‚ï¼šhttps://blog.ansheng.me/atom.xml

åœ¨ Python ä¸­è§£æ XML æœ€ç®€å•çš„æ–¹æ³•æ˜¯ä½¿ç”¨`ElementTree`ã€‚

|æ¨¡å—|è¯´æ˜|
|:--:|:--|
|xml.etree.ElementTree|the ElementTree API, a simple and lightweight XML processor|

## åˆ›å»º xml æ–‡ä»¶

å¯¼å…¥ ElementTree æ–¹æ³•ï¼Œèµ·ä¸€ä¸ªåˆ«åä¸º ET

```python
>>> from xml.etree import ElementTree as ET
```

åˆ›å»ºé¡¶çº§æ ‡ç­¾

```python
>>> level_1 = ET.Element("famliy")
```

åˆ›å»ºäºŒçº§æ ‡ç­¾ï¼Œtag å nameï¼Œattrib æ ‡ç­¾å±æ€§

```python
>>> level_2 = ET.SubElement(level_1, "name", attrib={"enrolled":"yes"})
```

åˆ›å»ºä¸‰çº§æ ‡ç­¾

```python
>>> level_3 = ET.SubElement(level_2, "age", attrib={"checked":"no"})
```

ç”Ÿæˆæ–‡æ¡£

```python
>>> tree = ET.ElementTree(level_1)
```

å†™å…¥æ–‡ä»¶ä¸­

```python
>>> tree.write('oooo.xml',encoding='utf-8', short_empty_elements=False)
```

å¯¼å…¥ os æ¨¡å—ï¼Œç”¨ os æ¨¡å—ä¸­çš„ system æ–¹æ³•æ‰§è¡Œ shell å‘½ä»¤æŸ¥çœ‹åˆšæ‰åˆ›å»ºçš„ oooo.xml æ–‡ä»¶

```python
>>> import os
>>> os.system("cat oooo.xml")
# ç”Ÿæˆå‡ºæ¥çš„æ–‡æ¡£æ˜¯æ²¡æœ‰æ¢è¡Œçš„
<famliy><name enrolled="yes"><age checked="no"></age></name></famliy>0
```

æŠŠåˆšæ‰ç”Ÿæˆçš„æ–‡ä»¶ä¸‹è½½åˆ°æœ¬åœ°ï¼Œç„¶åç”¨æµè§ˆå™¨æ‰“å¼€å°±å¯ä»¥çœ‹åˆ°åˆ†çº§å±‚æ¬¡äº†ã€‚

![xml-module-01](/images/2016/12/1483018595.png)

## åˆ›å»ºä¸€ä¸ªæœ‰æ¢è¡Œçš„ XML æ–‡ä»¶

ä»£ç 

```python
from xml.etree import ElementTree as ET
from xml.dom import minidom

root = ET.Element('level1',{"age":"1"})
son = ET.SubElement(root,"level2",{"age":"2"})
ET.SubElement(son, "level3", {"age":"3"})

# tree = ET.ElementTree(root)
# tree.write("abc.xml", encoding="utf-8",xml_declaration=True,short_empty_elements=False)

def prettify(root):
    rough_string = ET.tostring(root, 'utf-8')
    reparsed = minidom.parseString(rough_string)
    return reparsed.toprettyxml(indent="\t")

new_str = prettify(root)
f = open("new_out.xml", "w")
f.write(new_str)
f.close()
```

ç”Ÿæˆçš„ xml æ–‡ä»¶

```xml
<?xml version="1.0" ?>
<level1 age="1">
	<level2 age="2">
		<level3 age="3"/>
	</level2>
</level1>
```

## è§£æ XML

`first.xml`æ–‡ä»¶å†…å®¹ä¸ºï¼š

```xml
<data>
    <country name="Liechtenstein">
        <rank updated="yes">2</rank>
        <year age="19">2025</year>
        <gdppc>141100</gdppc>
        <neighbor direction="E" name="Austria" />
        <neighbor direction="W" name="Switzerland" />
    </country>
    <country name="Singapore">
        <rank updated="yes">5</rank>
        <year age="19">2028</year>
        <gdppc>59900</gdppc>
        <neighbor direction="N" name="Malaysia" />
    </country>
    <country name="Panama">
        <rank updated="yes">69</rank>
        <year age="19">2028</year>
        <gdppc>13600</gdppc>
        <neighbor direction="W" name="Costa Rica" />
        <neighbor direction="E" name="Colombia" />
    </country>
</data>
```

`first.xml`æ–‡ä»¶åœ¨`/root`ç›®å½•ä¸‹

åˆ©ç”¨ ElementTree.XML å°†å­—ç¬¦ä¸²è§£ææˆ xml å¯¹è±¡

```python
>>> from xml.etree import ElementTree as ET
# æ‰“å¼€æ–‡ä»¶ï¼Œè¯»å–XMLå†…å®¹ï¼Œå°†å­—ç¬¦ä¸²è§£ææˆxmlç‰¹æ®Šå¯¹è±¡ï¼Œrootä»£æŒ‡xmlæ–‡ä»¶çš„æ ¹èŠ‚ç‚¹
>>> root = ET.XML(open('first.xml', 'r').read())
>>> root.tag
'data'
>>> for node in root:
...  print(node.tag, node.attrib)
...
('country', {'name': 'Liechtenstein'})
('country', {'name': 'Singapore'})
('country', {'name': 'Panama'})
>>> print(node.find('rank').text)
69
```

åˆ©ç”¨ ElementTree.parse å°†æ–‡ä»¶ç›´æ¥è§£ææˆ xml å¯¹è±¡

```python

>>> from xml.etree import ElementTree as ET
# ç›´æ¥è§£æxmlæ–‡ä»¶
>>> tree = ET.parse("first.xml")
# è·å–xmlæ–‡ä»¶çš„æ ¹èŠ‚ç‚¹
>>> root = tree.getroot()
>>> root.tag
'data'
```

éå† XML ä¸­æŒ‡å®šçš„èŠ‚ç‚¹

```python
>>> from xml.etree import ElementTree as ET
>>> tree = ET.parse("first.xml")
>>> root = tree.getroot()
>>> for node in root.iter('year'):
        # è¾“å‡ºnodeçš„tagå’Œå†…å®¹
...     print(node.tag, node.text)
...
year 2025
year 2028
year 2028
```

## å¢ã€åˆ ã€æ”¹ XML

ä¸ºèŠ‚ç‚¹æ·»åŠ å±æ€§

```python
>>> from xml.etree import ElementTree as ET
>>> tree = ET.parse("first.xml")
>>> root = tree.getroot()
>>> for node in root.iter("year"):
        # æŸ¥çœ‹åŸæ¥çš„å±æ€§
...     print(node.attrib)
...
{}
{}
{}
>>> for node in root.iter("year"):
       # æ·»åŠ å±æ€§
...    node.set("OS","Linux")
...
>>> for node in root.iter("year"):
        # æŸ¥çœ‹æ·»åŠ çš„å±æ€§
...     print(node.attrib)
...
{'OS': 'Linux'}
{'OS': 'Linux'}
{'OS': 'Linux'}
# æŠŠå†…å®¹å†™å…¥æ–‡ä»¶
>>> tree.write("first.xml")
```

åˆ é™¤èŠ‚ç‚¹å±æ€§

```python
>>> from xml.etree import ElementTree as ET
>>> tree = ET.parse("first.xml")
>>> root = tree.getroot()
>>> for node in root.iter("year"):
        # åˆ é™¤èŠ‚ç‚¹çš„OSå±æ€§
...     del node.attrib['OS']
...
# å†™å…¥åˆ°æ–‡ä»¶å½“ä¸­
>>> tree.write("first.xml")
```

æŸ¥çœ‹å±æ€§

```python
>>> from xml.etree import ElementTree as ET
>>> tree = ET.parse("first.xml")
>>> root = tree.getroot()
>>> for node in root.iter("year"):
...  print(node.attrib)
...
# èŠ‚ç‚¹å†…å®¹ä¸ºç©º
{}
{}
{}
```

ä¿®æ”¹èŠ‚ç‚¹å†…å®¹

ä¿®æ”¹`year`å†…çš„æ•°å­—è‡ªåŠ  1

```python
>>> from xml.etree import ElementTree as ET
>>> tree = ET.parse("first.xml")
>>> root = tree.getroot()
>>> for node in root.iter("year"):
        # è¾“å‡ºåŸæ¥yearçš„å†…å®¹
...     print(node.text)
        # åŸæ¥çš„å€¼è‡ªåŠ +
...     new_year = int(node.text) + 1
...     node.text = str(new_year)
...
2025
2028
2028
# å†™å…¥æ–‡ä»¶ä¸­
>>> tree.write("first.xml")
>>> for node in root.iter("year"):
        # è¾“å‡ºå†™å…¥æ–‡ä»¶ä¹‹åyearçš„å†…å®¹
...     print(node.text)
...
2026
2029
2029
```

## å¯¹èŠ‚ç‚¹æ“ä½œçš„æ–¹æ³•

è·å–èŠ‚ç‚¹çš„æ–¹æ³•

```python
>>> from xml.etree import ElementTree as ET
>>> tree = ET.parse("first.xml")
>>> root = tree.getroot()
>>> print(dir(root))
['__class__', '__copy__', '__deepcopy__', '__delattr__', '__delitem__', '__dir__', '__doc__', '__eq__', '__format__', '__ge__', '__getattribute__', '__getitem__', '__getstate__', '__gt__', '__hash__', '__init__', '__le__', '__len__', '__lt__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__setitem__', '__setstate__', '__sizeof__', '__str__', '__subclasshook__', 'append', 'clear', 'extend', 'find', 'findall', 'findtext', 'get', 'getchildren', 'getiterator', 'insert', 'items', 'iter', 'iterfind', 'itertext', 'keys', 'makeelement', 'remove', 'set']
```

æ–¹æ³•æœ‰è¿™ä¹ˆå¤šï¼Œé‚£ä¹ˆæˆ‘ä»¬å¸¸ç”¨çš„ä¹Ÿå°±æ˜¯ä¸‹é¢çš„å‡ ä¸ª

|æ–¹æ³•å|è¯´æ˜|
|:--:|:--:|
|tag|è·å– tag æ ‡ç­¾å|
|attrib|è·å–èŠ‚ç‚¹çš„å±æ€§|
|find|è·å–èŠ‚ç‚¹çš„å†…å®¹|
|iter|è¿›è¡Œè¿­ä»£|
|set|è®¾ç½®å±æ€§|
|get|è·å–å±æ€§|

## å®ä¾‹

åˆ¤æ–­ QQ æ˜¯å¦åœ¨çº¿

è…¾è®¯æä¾›äº†èƒ½å¤ŸæŸ¥çœ‹ QQ å·ç æ˜¯å¦åœ¨çº¿çš„ APIï¼Œ`Y`=åœ¨çº¿ï¼›`N`=ç¦»çº¿ï¼›`E`=QQ å·ç é”™è¯¯ï¼›`A`=å•†ä¸šç”¨æˆ·éªŒè¯å¤±è´¥ï¼›`V`=å…è´¹ç”¨æˆ·è¶…è¿‡æ•°é‡

```python
>>> import requests
>>> from xml.etree import ElementTree as ET
>>> r = requests.get("http://www.webxml.com.cn//webservices/qqOnlineWebService.asmx/qqCheckOnline?qqCode=6087414")
>>> result = r.text
>>> from xml.etree import ElementTree as ET
>>> node = ET.XML(result)
>>> if node.text == "Y":
...    print("åœ¨çº¿")
... else:
...    print("ç¦»çº¿")
...
åœ¨çº¿
```

è·å–åˆ—è½¦èµ·æ­¢æ—¶é—´

ä»£ç 

```python
r = requests.get("http://www.webxml.com.cn/WebServices/TrainTimeWebService.asmx/getDetailInfoByTrainCode?TrainCode=K234&UserID=")
result = r.text
root = ET.XML(result)
for node in root.iter('TrainDetailInfo'):
    print(node.find('TrainStation').text,node.find('ArriveTime').text,node.find("StartTime").text)
```

æ‰§è¡Œç»“æœ

```python
C:\Python35\python.exe F:/Python_code/sublime/Week5/Day01/xml_mod.py
ä¸Šæµ·ï¼ˆè½¦æ¬¡ï¼šK234\K235ï¼‰ None 11:12:00
# åœ°ç‚¹ åœæ­¢    å¯åŠ¨
æ˜†å±± 11:45:00 11:48:00
è‹å· 12:12:00 12:16:00
æ— é”¡ 12:44:00 12:55:00
å¸¸å· 13:22:00 13:26:00
é•‡æ±Ÿ 14:13:00 14:16:00
å—äº¬ 15:04:00 15:16:00
èšŒåŸ  17:27:00 17:50:00
å¾å· 19:38:00 19:58:00
å•†ä¸˜ 22:12:00 22:17:00
å¼€å° 23:49:00 23:53:00
éƒ‘å· 00:37:00 01:14:00
æ–°ä¹¡ 02:20:00 02:22:00
é¹¤å£ 03:01:00 03:03:00
å®‰é˜³ 03:33:00 03:36:00
é‚¯éƒ¸ 04:11:00 04:16:00
é‚¢å° 04:47:00 04:51:00
çŸ³å®¶åº„ 06:05:00 None

Process finished with exit code 0
```