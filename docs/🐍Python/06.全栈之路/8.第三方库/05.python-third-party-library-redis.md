---
title: Python æ ‡å‡†åº“ç³»åˆ—ä¹‹ Redis æ¨¡å—

tags: 
  - ç¼–ç 
  - é¢å‘å¯¹è±¡
top: 4
categories: 
  - ğŸ’» å·¥ä½œ
  - ğŸPython
  - å…¨æ ˆä¹‹è·¯
  - ç¬¬ä¸‰æ–¹åº“
date: 2020-05-23 18:21:46
permalink: /pylibs/96c08d/
---

# Python æ ‡å‡†åº“ç³»åˆ—ä¹‹ Redis æ¨¡å—

## What is redis

Redis is an open source (BSD licensed), in-memory data structure store, used as database, cache and message broker. It supports data structures such as strings, hashes, lists, sets, sorted sets with range queries, bitmaps, hyperloglogs and geospatial indexes with radius queries. Redis has built-in replication, Lua scripting, LRU eviction, transactions and different levels of on-disk persistence, and provides high availability via Redis Sentinel and automatic partitioning with Redis Cluster.

Redis å®˜ç½‘ï¼šhttp://redis.io/

> ä»¥ä¸Šæ‘˜è‡ªå®˜ç½‘ä»‹ç»

## å®‰è£… Redis

å®‰è£…

æ¨¡å— GitHub åœ°å€ï¼šhttps://github.com/WoLpH/redis-py

```bash
[root@anshengme ~]# yum -y install redis
```

é…ç½®ç»‘å®šçš„ IP

```bash
[root@anshengme ~]# vim /etc/redis.conf
bind 0.0.0.0
```

å¯åŠ¨å¹¶è®¾ç½®å¼€æœºè‡ªå¯åŠ¨

```bash
[root@anshengme ~]# systemctl start redis
[root@anshengme ~]# systemctl enable redis
Created symlink from /etc/systemd/system/multi-user.target.wants/redis.service to /usr/lib/systemd/system/redis.service.
```

æ£€æŸ¥

æŸ¥çœ‹ç«¯å£

```bah
[root@anshengme ~]# netstat -tlnp | grep "redis"
tcp        0      0 0.0.0.0:6379            0.0.0.0:*               LISTEN      1439/redis-server 0
```

æ•°æ®å†™å…¥æµ‹è¯•

```bash
[root@anshengme ~]# /usr/bin/redis-cli
127.0.0.1:6379> set url https://blog.ansheng.me
OK
127.0.0.1:6379> get url
"https://blog.ansheng.me"
127.0.0.1:6379> exit
```

## å®‰è£… redis-py

å®‰è£… redis-py

```python
pip3 install redis
```

æˆ–æºç å®‰è£…

```python
python setup.py install
```

æ£€æŸ¥å®‰è£…æ˜¯å¦æˆåŠŸ

```python
# å¯¼å…¥æ¨¡å—æ²¡æŠ¥é”™åˆ™å®‰è£…æˆåŠŸ
>>> import redis
```

## å…¥é—¨åŠä½¿ç”¨

```python
# å¯¼å…¥æ¨¡å—
>>> import redis
# è¿æ¥åˆ°RedisæœåŠ¡å™¨
>>> conn = redis.Redis(host='192.168.56.100', port=6379)
# å†™å…¥ä¸€æ¡æ•°æ®
>>> conn.set('name','ansheng')
True
# è·å–ä¸€æ¡æ•°æ®
>>> conn.get('name')
b'ansheng'
>>> conn.get('url')
b'https://blog.ansheng.me'
```

ä½¿ç”¨è¿æ¥æ± è¿æ¥åˆ° Redis

> Behind the scenes, redis-py uses a connection pool to manage connections to a Redis server. By default, each Redis instance you create will in turn create its own connection pool. You can override this behavior and use an existing connection pool by passing an already created connection pool instance to the connection_pool argument of the Redis class. You may choose to do this in order to implement client side sharding or have finer grain control of how connections are managed.

```python
>>> pool = redis.ConnectionPool(host='192.168.56.100', port=6379)
>>> conn = redis.Redis(connection_pool=pool)
>>> conn.set('hello','world')
True
>>> conn.get('hello')
b'world'
```

ä½¿ç”¨å¥—æ¥å­—è¿æ¥

```python
>>> r = redis.Redis(unix_socket_path='/tmp/redis.sock')
```

## API

`redis-py`æä¾›çš„`API`ç”¨æ¥æ“ä½œ`redis`

### String API

**set(name, value, ex=None, px=None, nx=False, xx=False)**

|å‚æ•°|æè¿°|
|:--|:--|
|`ex`|è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰|
|`px`|è¿‡æœŸæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰|
|`nx`|å¦‚æœè®¾ç½®ä¸º Trueï¼Œåˆ™åªæœ‰ name ä¸å­˜åœ¨æ—¶ï¼Œå½“å‰ set æ“ä½œæ‰æ‰§è¡Œ|
|`xx`|å¦‚æœè®¾ç½®ä¸º Trueï¼Œåˆ™åªæœ‰ name å­˜åœ¨æ—¶ï¼Œå²—å‰ set æ“ä½œæ‰æ‰§è¡Œ|

```python
>>> conn.set('k1', 'v1', ex=10, nx=True)
True
>>> conn.get('k1')
b'v1'
>>> conn.get('k1')
```

**setex(name, value, time)**

è®¾ç½®è¿‡æœŸæ—¶é—´/ç§’

```python
>>> conn.setex('k','v',1)
True
>>> conn.get('k')
```

**psetex(name, time_ms, value)**

è®¾ç½®è¿‡æœŸæ—¶é—´/æ¯«ç§’

```bash
>>> conn.psetex('k',10,'v')
True
>>> conn.get('k')
```

**setnx(name, value)**

è®¾ç½®å€¼ï¼Œåªæœ‰ key ä¸å­˜åœ¨æ—¶ï¼Œæ‰§è¡Œè®¾ç½®æ“ä½œ

```python
>>> conn.get('k1')
>>> conn.setnx('k1','v1')
True
>>> conn.get('k1')
b'v1'
>>> conn.setnx('k2','v2')
False
```

**mset(\*args, \*\*kwargs)**

åŒæ—¶è®¾ç½®å¤šä¸ª key/value

```python
>>> conn.mset(k1='v1', k2='v2')
True
>>> conn.mset({'k1':'v1', 'k1':'v1'})
True
```

**get(name)**

è·å–å•ä¸ªå€¼

```python
>>> conn.get('k1')
b'v1'
```

**mget(keys, \*args)**

è·å–å¤šä¸ªå€¼

```python
>>> conn.mget('k1','k2')
[b'v1', b'v2']
# ä¼ å…¥åˆ—è¡¨
>>> conn.mget(['name','url'])
[b'ansheng', b'https://blog.ansheng.me']
```

**getset(name, value)**

è®¾ç½®æ–°å€¼å¹¶è·å–åŸæ¥çš„å€¼

```python
>>> conn.set('hello', 'world')
True
>>> result = conn.getset('hello', 'Linux')
>>> result
b'world'
>>> conn.get('hello')
b'Linux'
```

**getrange(key, start, end)**

é€šè¿‡ç´¢å¼•çš„æ–¹å¼æ¥è·å– value çš„å€¼

```python
>>> conn.set('key','value')
True
>>> conn.getrange('key', 1, 4)
b'alue'
```

**setrange(name, offset, value)**

æ ¹æ®ç´¢å¼•ä¿®æ”¹ value

```python
>>> conn.set('n','123456789')
True
>>> conn.setrange('n', 0, 'a')
9
>>> conn.get('n')
b'a23456789'
```

**setbit(name, offset, value)**

**getbit(name, offset)**

è·å– value å¯¹åº”æŸä¸€ä¸ªç´¢å¼•ä½ç½®å¯¹åº”çš„å€¼ 0/1

```python
>>> conn.getbit('k',1)
1
```

**bitcount(key, start=None, end=None)**

è·å– key å¯¹åº”äºŒè¿›åˆ¶ä¸­è¡¨ç¤º 1 çš„ä¸ªæ•°

**bitop(operation, dest, *keys)**

å°†å¤šä¸ªå€¼è¿›è¡Œå€¼è¿ç®—ï¼Œå¾—å‡ºçš„ç»“æœä¿å­˜åˆ°ä¸€ä¸ªæ–°å€¼å½“ä¸­

```python
>>> conn.mset(n1='abc',n2='cde',n3='adc')
True
>>> conn.bitop('AND','now_key','n1','n2','n3')
3
>>> conn.get('now_key')
b'a`a'
>>> conn.mget('n1','n2','n3')
[b'abc', b'cde', b'adc']
```

> operation æ”¯æŒ AND(å¹¶)ã€OR(æˆ–)ã€NOT(é)ã€XOR(å¼‚æˆ–)

**strlen(name)**

è·å– value çš„é•¿åº¦

```python
>>> conn.set('name','å®‰ç”Ÿ')
True
>>> conn.strlen('name')
6
```

**incr(name, amount=1)**

å¯¹ name çš„ value è¿›è¡Œè‡ªå¢ï¼Œå¦‚æœ name ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œå¦åˆ™è‡ªå¢

```python
>>> conn.get('number')
>>> conn.incr('number')
1
>>> conn.get('number')
b'1'
>>> conn.incr('number')
2
>>> conn.incr('number', 10)
12
```

**incrbyfloat(name, amount=1.0)**

åŒä¸Šï¼Œæ”¯æŒæµ®ç‚¹æ•°è‡ªå¢

```python
>>> conn.incrbyfloat('number', 1.5)
13.5
>>> conn.incrbyfloat('number', 1.1)
14.6
```

**decr(name, amount=1)**

è‡ªå‡ï¼ŒåŒè‡ªå¢ä¸€æ ·ï¼Œå¦‚æœè¿›è¡Œè‡ªå‡çš„ value ä¸æ˜¯æ•´æ•°å°±æŠ¥é”™

```python
>>> conn.set('n', 10)
True
>>> conn.decr('n')
9
>>> conn.decr('n', 9)
0
```

**append(key, value)**

åœ¨ value åé¢è¿½åŠ å†…å®¹

```python
>>> conn.set('blog','https://blog.ansheng.me')
True
>>> conn.append('blog','/')
26
>>> conn.get('blog')
b'https://blog.ansheng.me/'
```

### Hash API

**hset(name, key, value)**

è®¾ç½® name çš„é”®å€¼å¯¹ï¼Œæœ‰åˆ™ä¿®æ”¹ï¼Œæ²¡æœ‰åˆ™åˆ›å»º

```python
>>> conn.hset('dic','k1','v1')
1
>>> conn.hget('dic','k1')
b'v1'
```

**hmset(name, mapping)**

åŒæ—¶è®¾ç½®å¤šä¸ª name çš„ key/value

```python
>>> conn.hmset('dic', {'k1': 'v1', 'k2': 'v2'})
True
>>> conn.hget('dic','k2')
b'v2'
```

**hget(name, key)**

è·å– name ä¸­ key çš„å€¼

```python
>>> conn.hget('dic','k2')
b'v2'
```

**hmget(name, keys, \*args)**

åŒæ—¶è·å–å¤šä¸ª

```python
>>> conn.hmget('dic',['k1', 'k2'])
[b'v1', b'v2']
>>> conn.hmget('dic','k1', 'k2')
[b'v1', b'v2']
```

**hgetall(name)**

è·å– name å¯¹åº”çš„æ‰€æœ‰ key/value

```python
>>> conn.hgetall('dic')
{b'k1': b'v1', b'k2': b'v2'}
```

**hlen(name)**

è·å– name å¯¹åº”é”®å€¼å¯¹çš„ä¸ªæ•°

```python
>>> conn.hlen('dic')
2
```

**hkeys(name)**

è·å– name ä¸­æ‰€æœ‰çš„ key

```python
>>> conn.hkeys('dic')
[b'k1', b'k2']
```

**hvals(name)**

è·å– name ä¸­æ‰€æœ‰çš„ value

```python
>>> conn.hvals('dic')
[b'v1', b'v2']
```

**hexists(name, key)**

æ£€æŸ¥å½“å‰ name ä¸­æ˜¯å¦æœ‰ä¼ å…¥çš„ key

```python
>>> conn.hexists('dic','k1')
True
>>> conn.hexists('dic','kk')
False
```

**hdel(self, name, \*keys)**

åˆ é™¤ name ä¸­å¯¹åº”çš„ key

```python
>>> conn.hdel('dic','k1')
1
>>> conn.hget('dic','k1')
```

**hincrby(name, key, amount=1)**

name ä¸­ key å¯¹åº”çš„ value è¿›è¡Œè‡ªå¢ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º

```python
>>> conn.hincrby('dic','number')
1
>>> conn.hincrby('dic','number',10)
11
```

**hincrbyfloat(name, key, amount=1.0)**

value è‡ªå¢ï¼Œæ”¯æŒæµ®ç‚¹æ•°ï¼ŒåŒä¸Š

```python
>>> conn.hincrbyfloat('dic','float')
1.0
>>> conn.hincrbyfloat('dic','float',0.3)
1.3
```

**hscan(name, cursor=0, match=None, count=None)**

å¢é‡å¼è¿­ä»£è·å–ï¼Œhscan å¯ä»¥å®ç°åˆ†ç‰‡çš„è·å–æ•°æ®ï¼Œå¹¶éä¸€æ¬¡æ€§å°†æ•°æ®å…¨éƒ¨è·å–å®Œï¼Œä»è€Œæ”¾ç½®å†…å­˜è¢«æ’‘çˆ†

|å‚æ•°|æè¿°|
|:--|:--|
|`name`|redis çš„ name|
|`cursor`|æ¸¸æ ‡ï¼ˆåŸºäºæ¸¸æ ‡åˆ†æ‰¹å–è·å–æ•°æ®ï¼‰|
|`match`|åŒ¹é…æŒ‡å®š keyï¼Œé»˜è®¤ None è¡¨ç¤ºæ‰€æœ‰çš„ key|
|`count`|æ¯æ¬¡åˆ†ç‰‡æœ€å°‘è·å–ä¸ªæ•°ï¼Œé»˜è®¤ None è¡¨ç¤ºé‡‡ç”¨ Redis çš„é»˜è®¤åˆ†ç‰‡ä¸ªæ•°|

**hscan_iter(name, match=None, count=None)**

åˆ©ç”¨ yield å°è£… hscan åˆ›å»ºç”Ÿæˆå™¨ï¼Œå®ç°åˆ†æ‰¹å» redis ä¸­è·å–æ•°æ®

|å‚æ•°|æè¿°|
|:--|:--|
|`match`|åŒ¹é…æŒ‡å®š keyï¼Œé»˜è®¤ None è¡¨ç¤ºæ‰€æœ‰çš„ key|
|`count`|æ¯æ¬¡åˆ†ç‰‡æœ€å°‘è·å–ä¸ªæ•°ï¼Œé»˜è®¤ None è¡¨ç¤ºé‡‡ç”¨ Redis çš„é»˜è®¤åˆ†ç‰‡ä¸ªæ•°|

å¦‚ï¼š

```python
for item in r.hscan_iter('xx'):
    print item
```

**expire(name, time)**

è®¾ç½®è¿‡æœŸæ—¶é—´

```python
>>> conn.hset('info','BlogUrl','https://blog.ansheng.me')
1
>>> conn.expire('info', 10)
True
>>> conn.hget('info','BlogUrl')
b'https://blog.ansheng.me'
>>> conn.hget('info','BlogUrl')
```

### ListAPI

**lpush(name, \*values)**

åœ¨æœ€å·¦è¾¹æ·»åŠ å€¼

```python
>>> conn.lpush('li', 11,22,33)
3
>>> conn.lindex('li', 0)
b'33'
```

**rpush(name, \*values)**

åœ¨æœ€å³è¾¹æ·»åŠ å€¼

```python
>>> conn.rpush('lli', 11,22,33)
3
>>> conn.lindex('lli', 0)
b'11'
```

**lpushx(name, value)**

åªæœ‰ name å·²ç»å­˜åœ¨æ—¶ï¼Œå€¼æ·»åŠ åˆ°åˆ—è¡¨çš„æœ€å·¦è¾¹

```python
>>> conn.lpushx('li', 'aa')
4
>>> conn.lindex('li', 0)
b'aa'
```

**rpushx(name, value)**

åªæœ‰ name å·²ç»å­˜åœ¨æ—¶ï¼Œå€¼æ·»åŠ åˆ°åˆ—è¡¨çš„æœ€å³è¾¹

```python
>>> conn.rpushx('li', 'bb')
5
>>> conn.lindex('li', 0)
b'aa'
>>> conn.lindex('li', 4)
b'bb'
```

**llen(name)**

è·å– name å…ƒç´ çš„ä¸ªæ•°

```python
>>> conn.llen('li')
5
```

**linsert(name, where, refvalue, value)**

åœ¨ name çš„æŸä¸€ä¸ªå€¼å‰é¢æˆ–è€…åé¢æ’å…¥ä¸€ä¸ªæ–°å€¼

```python
>>> conn.linsert('li','AFTER','11','cc')
6
>>> conn.lindex('li', 3)
b'11'
>>> conn.lindex('li', 4)
b'cc'
```

**lset(name, index, value)**

å¯¹ name ä¸­ index ç´¢å¼•ä½ç½®çš„å€¼è¿›è¡Œé‡æ–°èµ‹å€¼

```python
>>> conn.lindex('li', 4)
b'cc'
>>> conn.lset('li', 4, 'hello')
True
>>> conn.lindex('li', 4)
b'hello'
```

**lrem(name, value, num=0)**

åˆ é™¤æŒ‡å®š value åé¢æˆ–è€…å‰é¢çš„å€¼

2. num=2,ä»å‰åˆ°åï¼Œåˆ é™¤ 2 ä¸ªï¼›
1. num=-2,ä»åå‘å‰ï¼Œåˆ é™¤ 2 ä¸ª

```python
>>> conn.llen('li')
6
>>> conn.lrem('li', 'hello')
1
>>> conn.llen('li')
5
>>> conn.lrem('li', '22', num=2)
2
>>> conn.llen('li')
3
```

**lpop(name)**

åˆ é™¤ name ä¸­å·¦ä¾§ç¬¬ä¸€ä¸ªå…ƒç´ 

```python
>>> conn.lindex('li', 0)
b'11'
>>> conn.lpop('li')
b'11'
```

**rpop(name)**

åˆ é™¤ name ä¸­å³ä¾§ç¬¬ä¸€ä¸ªå…ƒç´ 

```python
>>> conn.rpop('li')
b'33'
```

**lindex(name, index)**

è·å– name ä¸­å¯¹åº”ç´¢å¼•çš„å€¼

```python
>>> conn.lindex('li', 0)
b'aa'
```

**lrange(name, start, end)**

ä½¿ç”¨åˆ‡ç‰‡è·å–æ•°æ®

```python
>>> conn.llen('li')
8
>>> conn.lrange('li',0,5)
[b'3', b'23', b'34', b'235', b'2', b'1']
```

**ltrim(name, start, end)**

åœ¨ name å¯¹åº”çš„åˆ—è¡¨ä¸­ç§»é™¤æ²¡æœ‰åœ¨ start-end ç´¢å¼•ä¹‹é—´çš„å€¼

```python
>>> conn.ltrim('li',0,5)
True
>>> conn.llen('li')
6
```

**rpoplpush(src, dst)**

ä» src åˆ—è¡¨ä¸­å–å‡ºæœ€å³è¾¹çš„å…ƒç´ ï¼ŒåŒæ—¶å°†å…¶æ·»åŠ è‡³ dst åˆ—è¡¨çš„æœ€å·¦è¾¹

```python
>>> conn.lpush('li1', 1,2,3)
3
>>> conn.lpush('li2', 'a','b','c')
3
>>> conn.rpoplpush('li1','li2')
b'1'
```

**blpop(keys, timeout=0)**
**brpop(keys, timeout=0)**

**brpoplpush(src, dst, timeout=0)**

ä» src åˆ—è¡¨çš„å³ä¾§ç§»é™¤ä¸€ä¸ªå…ƒç´ å¹¶å°†å…¶æ·»åŠ åˆ° dst åˆ—è¡¨çš„å·¦ä¾§

```python
>>> conn.lpush('ll', 'a','b','c')
3
>>> conn.lpush('aa', 'a','b','c')
3
>>> conn.brpoplpush('ll','aa')
b'a'
```

> timeoutï¼Œå½“ src å¯¹åº”çš„åˆ—è¡¨ä¸­æ²¡æœ‰æ•°æ®æ—¶ï¼Œé˜»å¡ç­‰å¾…å…¶æœ‰æ•°æ®çš„è¶…æ—¶æ—¶é—´ï¼ˆç§’ï¼‰ï¼Œ0 è¡¨ç¤ºæ°¸è¿œé˜»å¡

è‡ªå®šä¹‰å¢é‡è¿­ä»£

ç”±äº`redis`ç±»åº“ä¸­æ²¡æœ‰æä¾›å¯¹åˆ—è¡¨å…ƒç´ çš„å¢é‡è¿­ä»£ï¼Œå¦‚æœæƒ³è¦å¾ªç¯`name`å¯¹åº”çš„åˆ—è¡¨çš„æ‰€æœ‰å…ƒç´ ï¼Œé‚£ä¹ˆå°±éœ€è¦ï¼š

1. è·å– name å¯¹åº”çš„æ‰€æœ‰åˆ—è¡¨
2. å¾ªç¯åˆ—è¡¨

ä½†æ˜¯ï¼Œå¦‚æœåˆ—è¡¨éå¸¸å¤§ï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½åœ¨ç¬¬ä¸€æ­¥æ—¶å°±å°†ç¨‹åºçš„å†…å®¹æ’‘çˆ†ï¼Œæ‰€æœ‰æœ‰å¿…è¦è‡ªå®šä¹‰ä¸€ä¸ªå¢é‡è¿­ä»£çš„åŠŸèƒ½ï¼š

```python
def list_iter(name):
    """
    è‡ªå®šä¹‰redisåˆ—è¡¨å¢é‡è¿­ä»£
    :param name: redisä¸­çš„nameï¼Œå³ï¼šè¿­ä»£nameå¯¹åº”çš„åˆ—è¡¨
    :return: yield è¿”å› åˆ—è¡¨å…ƒç´ 
    """
    list_count = r.llen(name)
    for index in xrange(list_count):
        yield r.lindex(name, index)
```

ä½¿ç”¨

```python
for item in list_iter('pp'):
    print item
```

### SET API

**sadd(name, \*values)**

ä¸º name æ·»åŠ å€¼ï¼Œå¦‚æœå­˜åœ¨åˆ™ä¸æ·»åŠ 

```python
>>> conn.sadd('s1', 1)
1
>>> conn.sadd('s1', 1)
0
```

**scard(name)**

è¿”å› name çš„å…ƒç´ æ•°é‡

```python
>>> conn.scard('s1')
1
```

**sdiff(keys, \*args)**

åœ¨ keys é›†åˆä¸­ä¸åœ¨å…¶ä»–é›†åˆä¸­çš„æ•°æ®

```python
>>> conn.sdiff('s1','s2')
{b'c', b'v', b'a'}
```

**sdiffstore(dest, keys, \*args)**

åœ¨ keys é›†åˆä¸­ä¸åœ¨å…¶ä»–é›†åˆä¸­çš„æ•°æ®ä¿å­˜åˆ° dest é›†åˆä¸­

```python
>>> conn.sdiffstore('news','s1','s2')
3
>>> conn.scard('news')
3
```

**sinter(keys, \*args)**

è·å– keys é›†åˆä¸­ä¸å…¶ä»–é›†åˆä¸­çš„å¹¶é›†

```python
>>> conn.sinter('s1','s2')
{b'2', b'3', b'1'}
```

**sinterstore(dest, keys, \*args)**

è·å– keys é›†åˆä¸­ä¸å…¶ä»–é›†åˆä¸­çš„å¹¶é›†æ•°æ®å¹¶ä¿å­˜åˆ° dest é›†åˆä¸­

```python
>>> conn.sinterstore('news1','s1','s2')
3
```

**sismember(name, value)**

è·å– value æ˜¯å¦æ˜¯ name é›†åˆä¸­çš„æˆå‘˜

```python
>>> conn.sismember('news1','1')
True
>>> conn.sismember('news1','aa1')
False
```

**smembers(name)**

è·å– name é›†åˆä¸­æ‰€æœ‰çš„æˆå‘˜

```python
>>> conn.smembers('news1')
{b'2', b'3', b'1'}
```

**smove(src, dst, value)**

å°† src ä¸­çš„ value ç§»åŠ¨åˆ° dst ä¸­

```python
>>> conn.smembers('s1')
{b'c', b'2', b'v', b'1', b'3', b'a'}
>>> conn.smembers('s2')
{b'2', b'3', b'1'}
>>> conn.smove('s1','s2','v')
True
>>> conn.smembers('s1')
{b'c', b'2', b'a', b'3', b'1'}
>>> conn.smembers('s2')
{b'2', b'v', b'3', b'1'}
```

**spop(name)**

åˆ é™¤å¹¶è¿”å› name ä¸­çš„éšæœºæˆå‘˜

```python
>>> conn.smembers('s2')
{b'2', b'v', b'3', b'1'}
>>> conn.spop('s2')
b'3'
>>> conn.smembers('s2')
{b'2', b'v', b'1'}
>>> conn.spop('s2')
b'2'
>>> conn.smembers('s2')
{b'v', b'1'}
>>> conn.spop('s2')
b'1'
>>> conn.smembers('s2')
{b'v'}
```

**srandmember(name, number=None)**

éšæœºè·å– name é›†åˆä¸­çš„ number ä¸ªæˆå‘˜ï¼Œé»˜è®¤ number=1

```python
>>> conn.smembers('s1')
{b'c', b'2', b'a', b'3', b'1'}
>>> conn.srandmember('s1')
b'1'
>>> conn.srandmember('s1')
b'a'
>>> conn.srandmember('s1',number=2)
[b'3', b'a']
>>> conn.srandmember('s1',number=2)
[b'1', b'2']
```

**srem(name, \*values)**

åˆ é™¤ name é›†åˆä¸­çš„ values æ•°æ®

```python
>>> conn.smembers('s1')
{b'c', b'2', b'a', b'3', b'1'}
>>> conn.srem('s1','1','2')
2
>>> conn.smembers('s1')
{b'c', b'a', b'3'}
```

**sunion(keys, \*args)**

è·å– keys é›†åˆä¸å…¶ä»–é›†åˆçš„å¹¶é›†

```python
>>> conn.sadd('a1',1,2,3)
3
>>> conn.sadd('a2',1,2,3,4,5,6,7)
7
>>> conn.sunion('a2','a1')
{b'2', b'7', b'1', b'3', b'6', b'5', b'4'}
```

**sunionstore(dest, keys, \*args)**

è·å– keys é›†åˆä¸å…¶ä»–é›†åˆçš„å¹¶é›†å¹¶ä¿å­˜åˆ° dest ä¸­

```python
>>> conn.sunionstore('a3', 'a2','a1')
7
>>> conn.smembers('a3')
{b'2', b'7', b'1', b'3', b'6', b'5', b'4'}
```

### Ordered set API

**zadd(name, \*args, \*\*kwargs)**

```python
>>> conn.zadd('h1','n1',11,'n2',22)
2
>>> conn.zadd('h2',n1=11,n2=22)
2
```

**zcard(name)**

è¿”å›æœ‰åºé›†åˆ name å…ƒç´ çš„æ•°é‡

```python
>>> conn.zcard('h1')
2
```

**zcount(name, min, max)**

è¿”å›åœ¨ name ä¸­å€¼åœ¨ min ä¸ max ä¹‹é—´çš„å€¼ä¸ªæ•°

```python
>>> conn.zcount('h1',10,30)
2
```

**zincrby(name, value, amount=1)**

name ä¸­è®© value çš„å€¼åŠ ä¸Š amount

```python
>>> conn.zincrby('h1','n1',10)
21.0
```

**zinterstore(dest, keys, aggregate=None)**
**zlexcount(name, min, max)**

**zrange(name, start, end, desc=False, withscores=False, score_cast_func=float)**

|å‚æ•°|æè¿°|
|:--|:--|
|`name`|redis çš„ name|
|`start`|æœ‰åºé›†åˆç´¢å¼•èµ·å§‹ä½ç½®ï¼ˆéåˆ†æ•°ï¼‰|
|`end`|æœ‰åºé›†åˆç´¢å¼•ç»“æŸä½ç½®ï¼ˆéåˆ†æ•°ï¼‰|
|`desc`|æ’åºè§„åˆ™ï¼Œé»˜è®¤æŒ‰ç…§åˆ†æ•°ä»å°åˆ°å¤§æ’åº|
|`withscores`|æ˜¯å¦è·å–å…ƒç´ çš„åˆ†æ•°ï¼Œé»˜è®¤åªè·å–å…ƒç´ çš„å€¼|
|`score_cast_func`|å¯¹åˆ†æ•°è¿›è¡Œæ•°æ®è½¬æ¢çš„å‡½æ•°|

```python
>>> conn.zrange('h1', 1, 2, desc=True, withscores=True, score_cast_func=float)
[(b'n1', 21.0)]
>>> conn.zrange('h1', 1, 2, desc=False, withscores=True, score_cast_func=float)
[(b'n2', 22.0)]
```

```python
# ä»å¤§åˆ°å°æ’åº
zrevrange(name, start, end, withscores=False, score_cast_func=float)
# æŒ‰ç…§åˆ†æ•°èŒƒå›´è·å–nameå¯¹åº”çš„æœ‰åºé›†åˆçš„å…ƒç´ 
zrangebyscore(name, min, max, start=None, num=None, withscores=False, score_cast_func=float)
# ä»å¤§åˆ°å°æ’åº
zrevrangebyscore(name, max, min, start=None, num=None, withscores=False, score_cast_func=float)
```

**zrangebylex(name, min, max, start=None, num=None)**

å½“æœ‰åºé›†åˆçš„æ‰€æœ‰æˆå‘˜éƒ½å…·æœ‰ç›¸åŒçš„åˆ†å€¼æ—¶ï¼Œæœ‰åºé›†åˆçš„å…ƒç´ ä¼šæ ¹æ®æˆå‘˜çš„ å€¼ ï¼ˆlexicographical orderingï¼‰æ¥è¿›è¡Œæ’åºï¼Œè€Œè¿™ä¸ªå‘½ä»¤åˆ™å¯ä»¥è¿”å›ç»™å®šçš„æœ‰åºé›†åˆé”® key ä¸­ï¼Œ å…ƒç´ çš„å€¼ä»‹äº min å’Œ max ä¹‹é—´çš„æˆå‘˜

å¯¹é›†åˆä¸­çš„æ¯ä¸ªæˆå‘˜è¿›è¡Œé€ä¸ªå­—èŠ‚çš„å¯¹æ¯”ï¼ˆbyte-by-byte compareï¼‰ï¼Œ å¹¶æŒ‰ç…§ä»ä½åˆ°é«˜çš„é¡ºåºï¼Œ è¿”å›æ’åºåçš„é›†åˆæˆå‘˜ã€‚ å¦‚æœä¸¤ä¸ªå­—ç¬¦ä¸²æœ‰ä¸€éƒ¨åˆ†å†…å®¹æ˜¯ç›¸åŒçš„è¯ï¼Œ é‚£ä¹ˆå‘½ä»¤ä¼šè®¤ä¸ºè¾ƒé•¿çš„å­—ç¬¦ä¸²æ¯”è¾ƒçŸ­çš„å­—ç¬¦ä¸²è¦å¤§

|å‚æ•°|æè¿°|
|:--|:--|
|`name`|redis çš„ name|
|`min`|å·¦åŒºé—´(å€¼) + è¡¨ç¤ºæ­£æ— é™ï¼› - è¡¨ç¤ºè´Ÿæ— é™ï¼› ( è¡¨ç¤ºå¼€åŒºé—´ï¼› [ åˆ™è¡¨ç¤ºé—­åŒºé—´|
|`min`|å³åŒºé—´ï¼ˆå€¼ï¼‰|
|`start`|å¯¹ç»“æœè¿›è¡Œåˆ†ç‰‡å¤„ç†ï¼Œç´¢å¼•ä½ç½®|
|`num`|å¯¹ç»“æœè¿›è¡Œåˆ†ç‰‡å¤„ç†ï¼Œç´¢å¼•åé¢çš„ num ä¸ªå…ƒç´ |

å¦‚ï¼š

```python
ZADD myzset 0 aa 0 ba 0 ca 0 da 0 ea 0 fa 0 ga
# r.zrangebylex('myzset', "-", "[ca") ç»“æœä¸ºï¼š['aa', 'ba', 'ca']
```

æ›´å¤šï¼š

```python
# ä»å¤§åˆ°å°æ’åº
zrevrangebylex(name, max, min, start=None, num=None)
```

**zrevrangebylex(name, max, min, start=None, num=None)**

zrangebyscore(name, min, max, start=None, num=None, withscores=False, score_cast_func=float)**

**zrank(name, value)**

è¿”å›åŸºäº 0 çš„å€¼ï¼ŒæŒ‡ç¤ºåœ¨æ’åºé›†åç§°çš„å€¼æ’å

```python
>>> conn.zrank('h1','n1')
0
>>> conn.zrank('h1','n2')
1
```

> zrevrank(name, value)ï¼Œä»å¤§åˆ°å°æ’åº

**zrem(name, \*values)**

åˆ é™¤ name ä¸­å¯¹åº”çš„ values

```python
>>> conn.zrem('h1','n2')
1
>>> conn.zrem('h2',['n1','n2'])
2
```

**zremrangebyrank(name, min, max)**

æ ¹æ®æ’è¡ŒèŒƒå›´è¿›è¡Œåˆ é™¤

```python
>>> conn.zremrangebyrank('h1',1,2)
1
```

**zremrangebyscore(name, min, max)**

æ ¹æ®åˆ†æ•°èŒƒå›´è¿›è¡Œåˆ é™¤

```python
>>> conn.zremrangebyscore('h1',10,20)
2
```

**zscore(name, value)**

è¿”å›æŒ‡å®š value çš„å€¼æ˜¯å¤šå°‘

```python
>>> conn.zscore('h1','n1')
11.0
```

**zunionstore(dest, keys, aggregate=None)**

### Global API

**delete(\*names)**

åœ¨ redis ä¸­åˆ é™¤ names

```python
>>> conn.delete('ooo')
1
```

**exists(name)**

æ£€æµ‹ name æ˜¯å¦å­˜åœ¨

```python
>>> conn.exists('iii')
False
>>> conn.exists('h1')
True
```

**keys(pattern='*')**

```python
# åŒ¹é…æ•°æ®åº“ä¸­æ‰€æœ‰ key
>>> conn.keys(pattern='*')
[b'h2', b'kasd1', b'n2', b'url', b'name', b'n', b'li1', b'n1', b's1', b'now_key', b'l', b's2', b'number', b'numbers', b'a2', b'dic', b'a1', b'news', b'news1', b'aa', b'key', b'lli', b'll', b'k', b'li', b'k2', b'h1', b'li2', b'ccc', b'k1', b'blog', b'kaasdsd1', b'a3', b'l1', b'l2', b'n3', b'a']
```

```python
# åŒ¹é…helloï¼Œhalloå’Œhxlloç­‰
conn.keys(pattern='h?llo')
# åŒ¹é…hlloå’Œheeeeello ç­‰
conn.keys(pattern='h*llo')
# åŒ¹é…helloå’Œhalloï¼Œä½†ä¸åŒ¹é… hillo
conn.keys(pattern='h[ae]llo')
```

**rename(src, dst)**

æŠŠ src é‡å‘½åæˆ dst

```python
>>> conn.set('k','v')
True
>>> conn.get('k')
b'v'
>>> conn.rename('k', 'kk')
True
>>> conn.get('k')
>>> conn.get('kk')
b'v'
```

**move(name, db)**

å°† redis çš„æŸä¸ªå€¼ç§»åŠ¨åˆ°æŒ‡å®šçš„ db ä¸‹

**randomkey()**

éšæœºè·å–ä¸€ä¸ª redis çš„ nameï¼Œä¸è¿›è¡Œåˆ é™¤

```python
>>> conn.randomkey()
b'll'
>>> conn.randomkey()
b'news1'
```

 **type(name)**

æŸ¥çœ‹ name çš„ç±»å‹

```python
>>> conn.type('kk')
b'string'
```

## ç®¡é“

`redis-py`é»˜è®¤åœ¨æ‰§è¡Œæ¯æ¬¡è¯·æ±‚éƒ½ä¼šåˆ›å»ºï¼ˆè¿æ¥æ± ç”³è¯·è¿æ¥ï¼‰å’Œæ–­å¼€ï¼ˆå½’è¿˜è¿æ¥æ± ï¼‰ä¸€æ¬¡è¿æ¥æ“ä½œï¼Œå¦‚æœæƒ³è¦åœ¨ä¸€æ¬¡è¯·æ±‚ä¸­æŒ‡å®šå¤šä¸ªå‘½ä»¤ï¼Œåˆ™å¯ä»¥ä½¿ç”¨`pipline`å®ç°ä¸€æ¬¡è¯·æ±‚æŒ‡å®šå¤šä¸ªå‘½ä»¤ï¼Œå¹¶ä¸”é»˜è®¤æƒ…å†µä¸‹ä¸€æ¬¡ pipline æ˜¯åŸå­æ€§æ“ä½œ(MySQL ä¸­çš„äº‹åŠ¡)ã€‚

```python
>>> import redis
>>> pool = redis.ConnectionPool(host='192.168.56.100', port=6379)
>>> r = redis.Redis(connection_pool=pool)
# åˆ›å»ºä¸€ä¸ªé€šé“æ”¯æŒäº‹åŠ¡
>>> pipe = r.pipeline(transaction=True)
#
>>> r.set('hello', 'world')
True
>>> r.set('blog', 'ansheng.me')
True
# å¦‚æœåœ¨è®¾ç½®ä¸Šé¢ä¸¤ä¸ªå€¼çš„è¿‡ç¨‹ä¸­å‡ºé”™äº†ï¼Œé‚£ä¹ˆè¿™æ¬¡æäº¤å°±ä¸ä¼šæ‰§è¡Œ
>>> pipe.execute()
[]
```

## å‘å¸ƒè®¢é˜…

```python
# monitor.py
#!/usr/bin/env python
# -*- coding:utf-8 -*-

import redis

class RedisHelper:
    def __init__(self):
        self.__conn = redis.Redis(host='192.168.56.100')
        self.chan_sub = 'fm104.5'
        self.chan_pub = 'fm104.5'

    def public(self, msg):
        self.__conn.publish(self.chan_pub, msg)
        return True

    def subscribe(self):
        pub = self.__conn.pubsub()
        pub.subscribe(self.chan_sub)
        pub.parse_response()
        return pub

# subscriber.py è®¢é˜…è€…
#!/usr/bin/env python
# -*- coding:utf-8 -*-

from monitor import RedisHelper

obj = RedisHelper()
redis_sub = obj.subscribe()

while True:
    msg = redis_sub.parse_response()
    print(msg)

# announcer.py å‘å¸ƒè€…
#!/usr/bin/env python
# -*- coding:utf-8 -*-

from monitor import RedisHelper

obj = RedisHelper()
obj.public('hello')
```


## å®ä¾‹

è®© redis ç¼“å­˜ tornado é¡µé¢

```python
# _*_coding:utf-8 _*_

import tornado.ioloop
import tornado.web
import time
import redis

poll = redis.ConnectionPool(host='192.168.56.100', port=6379)
conn = redis.Redis(connection_pool=poll)

class MainHandler(tornado.web.RequestHandler):
    def get(self):
        CurrentTim = conn.get('CurrentTim')
        if CurrentTim:
            self.write(CurrentTim)
        else:
            CurrentTim = time.strftime('%Y-%m-%d %H:%M:%S', time.localtime(time.time()))
            conn.set('CurrentTim', CurrentTim, ex=5)
            self.write(CurrentTim)

settings = {
    "tempalte_path": "template",
}

application = tornado.web.Application([
    (r'/', MainHandler),
], **settings)

if __name__ == "__main__":
    application.listen(9999)
    tornado.ioloop.IOLoop.instance().start()
```
æ•°æ®ç¼“å­˜ 5 ç§’ï¼Œå¦‚å›¾æ‰€ç¤º
![redis-02](https://cdn.jsdelivr.net/gh/masantu/statics/images/2016/12/1483068298.gif)

åŸºäº Redis çš„ Session å­˜å‚¨

**app.py**

```python
# _*_coding:utf-8 _*_

import tornado.ioloop
import tornado.web
import RedisToSession

class BaseHandler(tornado.web.RequestHandler):
    def initialize(self):
        self.session = RedisToSession.Session(self)

class MainHandler(BaseHandler):
    def get(self):
        Info = self.session.GetAll()

        self.render("template/index.html", Data=Info)

    def post(self, *args, **kwargs):
        # è·å–ä¼ è¿‡æ¥çš„å€¼
        Key = self.get_argument('key')
        Val = self.get_argument('val')
        action = self.get_argument('action')
        if action == 'set':
            # è®¾ç½®å€¼
            self.session[Key] = Val
        elif action == 'del':
            del self.session[Key]

        # è·å–æ‰€æœ‰ä¿¡æ¯
        Info = self.session.GetAll()
        # è¿”å›ç»™å‰ç«¯æ¸²æŸ“
        self.render("template/index.html", Data=Info)

settings = {
    "tempalte_path": "template",
    "cookie_secret": "508CE6152CB93994628D3E99934B83CC",
}

application = tornado.web.Application([
    (r'/', MainHandler),
], **settings)

if __name__ == "__main__":
    application.listen(9999)
    tornado.ioloop.IOLoop.instance().start()
```

**template\index.html**

```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>

<form action="/" method="post">
    set/delï¼š<input type="text" name="action" value="set"/>
    Key: <input type="text" name="key"/>
    Val: <input type="text" name="val"/>
    <input type="submit" value="è®¾ç½®"/>
</form>

{{ Data }}

</body>
</html>
```

**RedisToSession.py**

```python
# _*_ coding: utf-8 _*_

import redis
import hashlib
import uuid
import json

# è¿æ¥memcached
pool = redis.ConnectionPool(host='192.168.56.100', port=6379)
conn = redis.Redis(connection_pool=pool)


class Session:
    CookieID = 'uc'
    ExpiresTime = 60 * 20

    def __init__(self, handler):
        """
        ç”¨äºåˆ›å»ºç”¨æˆ·sessionåœ¨redisä¸­çš„å­—å…¸
        :param handler: è¯·æ±‚å¤´
        """
        self.handler = handler
        # ä»å®¢æˆ·ç«¯è·å–éšæœºå­—ç¬¦ä¸²
        SessionID = self.handler.get_secure_cookie(Session.CookieID, None)
        # å®¢æˆ·ç«¯å­˜åœ¨å¹¶ä¸”åœ¨æœåŠ¡ç«¯ä¹Ÿå­˜åœ¨
        if SessionID and conn.exists(SessionID):
            self.SessionID = SessionID
        else:
            # è·å–éšæœºå­—ç¬¦ä¸²
            self.SessionID = self.SessionKey()
            # æŠŠéšæœºå­—ç¬¦ä¸²å†™å…¥memcached,æ—¶é—´æ˜¯20åˆ†é’Ÿ
            conn.hset(self.SessionID, None, None)

        # æ¯æ¬¡è®¿é—®è¶…æ—¶æ—¶é—´å°±åŠ 20åˆ†é’Ÿ
        conn.expire(self.SessionID, Session.ExpiresTime)

        # è®¾ç½®Cookie
        self.handler.set_secure_cookie('uc', self.SessionID)

    def SessionKey(self):
        """
        :return: ç”Ÿæˆéšæœºå­—ç¬¦ä¸²
        """
        UUID = str(uuid.uuid1()).replace('-', '')
        MD5 = hashlib.md5()
        MD5.update(bytes(UUID, encoding='utf-8'))
        SessionKey = MD5.hexdigest()
        return SessionKey

    def __setitem__(self, key, value):
        """
        :param key: sessionä¿¡æ¯ä¸­çš„key
        :param value: å¯¹åº”çš„Value
        """
        conn.hset(self.SessionID, key, value)

    def __getitem__(self, item):
        """
        :param item: Sessionä¿¡æ¯ä¸­å¯¹åº”çš„Key
        :return: è·å–çš„Sessionä¿¡æ¯
        """
        # è·å–å¯¹åº”çš„æ•°æ®
        ResultData = conn.hget(self.SessionID, item)
        return ResultData

    def __delitem__(self, key):
        """
        :param key: è¦åˆ é™¤çš„Key
        """
        conn.hdel(self.SessionID, key)

    def GetAll(self):
        # è·å–Sessionä¸­æ‰€æœ‰çš„ä¿¡æ¯ï¼Œä»…ç”¨äºæµ‹è¯•
        SessionData = conn.hgetall(self.SessionID)
        return SessionData

```

æ¼”ç¤ºå¦‚å›¾ï¼š
![redis-03](https://cdn.jsdelivr.net/gh/masantu/statics/images/2016/12/1483068252.gif)