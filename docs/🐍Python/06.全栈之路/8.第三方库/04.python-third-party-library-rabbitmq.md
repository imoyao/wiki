---
title: Python å…¨æ ˆä¹‹è·¯ç³»åˆ—ä¹‹ RabbitMQ

tags: 
  - ç¼–ç 
  - RabbitMQ
top: 6
categories: 
  - ğŸ’» å·¥ä½œ
  - ğŸPython
  - å…¨æ ˆä¹‹è·¯
  - ç¬¬ä¸‰æ–¹åº“
date: 2020-05-23 18:21:46
permalink: /pages/dacc24/
---

RabbitMQ æ˜¯å®ç°äº†é«˜çº§æ¶ˆæ¯é˜Ÿåˆ—åè®®ï¼ˆAMQPï¼‰çš„å¼€æºæ¶ˆæ¯ä»£ç†è½¯ä»¶ã€‚RabbitMQ æœåŠ¡å™¨æ˜¯ç”¨ Erlang è¯­è¨€ç¼–å†™çš„ï¼Œå®ƒå¯ä»¥ä¸ºä½ çš„åº”ç”¨æä¾›ä¸€ä¸ªé€šç”¨çš„æ¶ˆæ¯å‘é€å’Œæ¥æ”¶å¹³å°ï¼Œå¹¶ä¸”ä¿è¯æ¶ˆæ¯åœ¨ä¼ è¾“è¿‡ç¨‹ä¸­çš„å®‰å…¨ï¼Œ[RabbitMQ å®˜ç½‘](https://www.rabbitmq.com)ï¼Œ[RabbitMQ ä¸­æ–‡æ–‡æ¡£](http://rabbitmq.mr-ping.com/)ã€‚

## å®‰è£… RabbitMQ

å®‰è£… EPEL æº

```bash
[root@anshengme ~]# yum -y install epel-release
```

å®‰è£… erlang

```bash
[root@anshengme ~]# yum -y install erlang
```

å®‰è£… RabbitMQ

```plain
[root@anshengme ~]# yum -y install rabbitmq-server
```

å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå™¨å¯åŠ¨

åœ¨å¯åŠ¨`RabbitMQ`ä¹‹å‰éœ€è¦ hostname çš„è§£æï¼Œè¦ä¸ç„¶å¯åŠ¨ä¸èµ·æ¥

```bash
[root@anshengme ~]# cat /etc/hosts
127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4 anshengme
::1         localhost localhost.localdomain localhost6 localhost6.localdomain6
```

```bash
[root@anshengme ~]# systemctl start rabbitmq-server
[root@anshengme ~]# systemctl enable rabbitmq-server
Created symlink from /etc/systemd/system/multi-user.target.wants/rabbitmq-server.service to /usr/lib/systemd/system/rabbitmq-server.service.
```

æŸ¥çœ‹å¯åŠ¨çŠ¶æ€

```bash
[root@anshengme ~]# netstat -tulnp |grep 5672
tcp        0      0 0.0.0.0:25672           0.0.0.0:*               LISTEN      37507/beam.smp
tcp6       0      0 :::5672                 :::*                    LISTEN      37507/beam.smp
```

## pika

`pika`æ¨¡å—æ˜¯å®˜æ–¹è®¤å¯çš„æ“ä½œ`RabbitMQ`çš„ API æ¥å£ã€‚

å®‰è£… pika

```bash
pip3 install pika
```

pikaï¼šhttps://pypi.python.org/pypi/pika

æµ‹è¯•

```python
>>> import pika
```

## Work Queues

å¦‚æœä½ å¯åŠ¨äº†å¤šä¸ªæ¶ˆè´¹è€…ï¼Œé‚£ä¹ˆç”Ÿäº§è€…ç”Ÿäº§çš„ä»»åŠ¡ä¼šæ ¹æ®é¡ºåºçš„ä¾æ¬¡è®©æ¶ˆè´¹è€…æ¥æ‰§è¡Œï¼Œè¿™å°±æ˜¯`Work Queues`æ¨¡å¼

![rabbitmq-work-queues](https://ansheng.me/wp-content/uploads/2016/12/1483068957.png)

ç”Ÿäº§è€…ä»£ç 

```python
# _*_ codin:utf-8 _*_

import pika

# è¿æ¥åˆ°RabbitMQ è¿™æ˜¯ä¸€ä¸ªé˜»å¡çš„è¿æ¥
connection = pika.BlockingConnection(pika.ConnectionParameters('192.168.56.100'))

# ç”Ÿæˆä¸€ä¸ªç®¡é“
channel = connection.channel()

# é€šè¿‡ç®¡é“åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—
channel.queue_declare(queue='hello')

# åœ¨é˜Ÿåˆ—å†…å‘é€æ•°æ®ï¼Œbodyå†…å®¹ï¼Œrouting_keyé˜Ÿåˆ—ï¼Œexchangeäº¤æ¢å™¨ï¼Œé€šè¿‡äº¤æ¢å™¨å¾€helloé˜Ÿåˆ—å†…å‘é€Hello World!æ•°æ®
channel.basic_publish(exchange='', routing_key='hello', body='Hello World!')

# å…³é—­è¿æ¥
connection.close()
```

æ¶ˆè´¹è€…ä»£ç 

```python
# _*_ codin:utf-8 _*_

import pika

# è¿æ¥åˆ°RabbitMQ è¿™æ˜¯ä¸€ä¸ªé˜»å¡çš„è¿æ¥
connection = pika.BlockingConnection(pika.ConnectionParameters('192.168.56.100'))

# ç”Ÿæˆä¸€ä¸ªç®¡é“
channel = connection.channel()

# å¦‚æœæ¶ˆè´¹è€…è¿æ¥åˆ°è¿™ä¸ªé˜Ÿåˆ—çš„æ—¶å€™ï¼Œé˜Ÿåˆ—æ²¡æœ‰ç”Ÿæˆï¼Œé‚£ä¹ˆæ¶ˆè´¹è€…å°±ç”Ÿæˆè¿™ä¸ªé˜Ÿåˆ—ï¼Œå¦‚æœè¿™ä¸ªé˜Ÿåˆ—å·²ç»ç”Ÿæˆäº†ï¼Œé‚£ä¹ˆå°±å¿½ç•¥å®ƒ
channel.queue_declare(queue='hello')


# å›è°ƒå‡½æ•°
def callback(ch, method, properties, body):
    print(" [x] Received %r" % body)


# æ¶ˆè´¹ï¼Œå½“æ”¶åˆ°helloé˜Ÿåˆ—çš„æ¶ˆæ¯çš„æ—¶å€™å°±ï¼Œå°±è°ƒç”¨callbackå‡½æ•°ï¼Œno_ackæ¶ˆè´¹è€…åœ¨å¤„ç†ä»»åŠ¡çš„æ—¶å€™è¦ä¸éœ€è¦ç¡®è®¤ä»»åŠ¡å·²ç»å¤„ç†å®Œæˆï¼Œæ”¹ä¸ºFalseåˆ™è¦ç¡®è®¤
channel.basic_consume(callback, queue='hello', no_ack=True)

# å¼€å§‹æ¥å—ä»»åŠ¡ï¼Œé˜»å¡
channel.start_consuming()
```

## æŒä¹…åŒ–

é˜Ÿåˆ—æŒä¹…åŒ–

è¯•æƒ³ï¼Œå¦‚æœæˆ‘ä»¬çš„æ¶ˆè´¹è€…åœ¨æ‰§è¡Œä»»åŠ¡æ‰§è¡Œåˆ°ä¸€åŠæ—¶ï¼Œçªç„¶ down æ‰äº†ï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ”¹`no_ack=False`æ¥è®©æ¶ˆè´¹è€…æ¯æ¬¡æ‰§è¡Œå®Œæˆå®Œæˆä¹‹åç¡®è®¤æ‰§è¡Œå®Œæ¯•äº†å†æŠŠè¿™ä¸ªä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­ç§»é™¤ç§»é™¤æ‰ï¼Œä½†æ˜¯å¦‚æœ RabbitMQ çš„æœåŠ¡å™¨åœæ­¢æˆ‘ä»¬çš„ä»»åŠ¡ä»ç„¶ä¼šä¸¢å¤±ã€‚

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿çš„`RabbitMQ`æ°¸è¿œä¸ä¼šåœ¨æˆ‘ä»¬çš„é˜Ÿåˆ—ä¸­å¤±å»ï¼Œä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦æŠŠ`durable=True`ï¼Œå£°æ˜ä¸€ä¸ªæ–°åç§°çš„é˜Ÿåˆ—ï¼Œä¸º`task_queue`ï¼š

```python
channel.queue_declare(queue='task_queue', durable=True)
```

`durable`éœ€è¦åœ¨ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ä¸Šé¢éƒ½éœ€è¦å†™ä¸Šï¼Œä¸”`durable`åªä¼šè®©æˆ‘ä»¬çš„é˜Ÿåˆ—æŒä¹…åŒ–ï¼Œå¹¶ä¸èƒ½å¤Ÿè®©æ¶ˆæ¯æŒä¹…åŒ–ã€‚

æ¶ˆæ¯æŒä¹…åŒ–

æ¶ˆæ¯æŒä¹…åŒ–åªéœ€è¦åœ¨æ·»åŠ æ¶ˆæ¯çš„æ—¶å€™æ·»åŠ ä¸€ä¸ª`delivery_mode=2`

```python
channel.basic_publish(exchange='',
                      routing_key='world',
                      body='Hello World!',
                      properties=pika.BasicProperties(
                          # 2=æ¶ˆæ¯æŒä¹…åŒ–
                          delivery_mode=2,
                      ))
```

åœ¨æ¶ˆè´¹è€…çš„ callback å‡½æ•°å†…æ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```python
ch.basic_ack(delivery_tag = method.delivery_tag)
```

## æ¶ˆæ¯å…¬å¹³åˆ†å‘

æ¯ä¸€ä¸ªæ¶ˆè´¹è€…åŒæ—¶åªå¤„ç†ä¸€ä¸ªä»»åŠ¡ï¼Œæ¯”å¦‚è¯´ç°åœ¨æœ‰ä¸‰ä¸ªæ¶ˆè´¹è€…ï¼Œåˆšå¼€å§‹æ¥äº†ä¸‰ä¸ªä»»åŠ¡ï¼Œå¹³å‡åˆ†é…ç»™äº†ä¸‰ä¸ªæ¶ˆè´¹è€…ï¼Œé‚£ä¹ˆè¿™ä¸‰ä¸ªæ¶ˆè´¹è€…ç›®å‰éƒ½åœ¨åŒæ—¶æ‰§è¡Œä»»åŠ¡ï¼Œå½“ç¬¬å››ä¸ªä»»åŠ¡åˆ°æ¥çš„æ—¶å€™ä¾æ—§ä¼šåˆ†é…ç»™ç¬¬ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œç¬¬äº”ä¸ªä»»åŠ¡åˆ°æ¥çš„æ—¶å€™ä¼šåˆ†é…ç»™ç¬¬äºŒä¸ªæ¶ˆè´¹è€…ï¼Œä»¥æ­¤ç±»æ¨ã€‚

é‚£ä¹ˆä»¥ä¸Šçš„çŠ¶å†µæœ‰ä»€ä¹ˆä¸å¦¥å‘¢ï¼Ÿè­¬å¦‚è¯´ä¸åŒçš„æ¶ˆè´¹è€…æ‰§è¡Œä»»åŠ¡çš„æ—¶é—´ä¸åŒï¼Œæˆ‘ä»¬ç°åœ¨éœ€è¦çš„æ—¶å€™ï¼Œå½“ä¸‰ä¸ªæ¶ˆè´¹è€…éƒ½åœ¨æ‰§è¡Œä»»åŠ¡çš„æ—¶å€™ï¼Œæ¯”å¦‚è¯´ç¬¬äºŒä¸ªæ¶ˆè´¹è€…ä»»åŠ¡æ‰§è¡Œå®Œäº†ï¼Œå…¶ä»–æ¶ˆè´¹è€…éƒ½è¿˜åœ¨æ‰§è¡Œä»»åŠ¡ï¼Œå½“ç¬¬å››ä¸ªä»»åŠ¡åˆ°æ¥çš„æ—¶å€™å¸Œæœ›äº¤ç»™ç¬¬äºŒä¸ªæ¶ˆè´¹è€…ï¼Œè‹¥è¦å®ç°æ­¤åŠŸèƒ½ï¼Œåªéœ€è¦åœ¨æ¶ˆè´¹è€…åŠ ä¸Šä¸€ä¸‹ä»£ç å³å¯ï¼š

```python
channel.basic_qos(prefetch_count=1)
```

å®Œæ•´çš„ä»£ç å¦‚ä¸‹

æ¶ˆè´¹è€…ä»£ç 

```python
#!/usr/bin/env python
import pika
import time

connection = pika.BlockingConnection(pika.ConnectionParameters(
    host='192.168.56.100'))
channel = connection.channel()

channel.queue_declare(queue='task_queue', durable=True)
print(' [*] Waiting for messages. To exit press CTRL+C')

def callback(ch, method, properties, body):
    print(" [x] Received %r" % body)
    time.sleep(10)
    print(" [x] Done")
    ch.basic_ack(delivery_tag=method.delivery_tag)


channel.basic_qos(prefetch_count=1)
channel.basic_consume(callback,
                      queue='task_queue')

channel.start_consuming()
```

ç”Ÿäº§è€…ä»£ç 

```python
#!/usr/bin/env python
import pika
import sys

connection = pika.BlockingConnection(pika.ConnectionParameters(
    host='192.168.56.100'))
channel = connection.channel()

channel.queue_declare(queue='task_queue', durable=True)

for n in range(10):
    message = "Hello World! %s" % (n + 1)
    channel.basic_publish(exchange='',
                          routing_key='task_queue',
                          body=message,
                          properties=pika.BasicProperties(
                              delivery_mode=2,  # make message persistent
                          ))
    print(" [x] Sent %r" % message)
connection.close()
```
## æ¶ˆæ¯ä¼ è¾“ç±»å‹

ä¹‹å‰çš„ä¾‹å­éƒ½åŸºæœ¬éƒ½æ˜¯ 1 å¯¹ 1 çš„æ¶ˆæ¯å‘é€å’Œæ¥æ”¶ï¼Œå³æ¶ˆæ¯åªèƒ½å‘é€åˆ°æŒ‡å®šçš„ queue é‡Œï¼Œä½†æœ‰äº›æ—¶å€™ä½ æƒ³è®©ä½ çš„æ¶ˆæ¯è¢«æ‰€æœ‰çš„ Queue æ”¶åˆ°ï¼Œç±»ä¼¼å¹¿æ’­çš„æ•ˆæœï¼Œè¿™æ—¶å€™å°±è¦ç”¨åˆ° exchange äº†ï¼Œ

Exchange åœ¨å®šä¹‰çš„æ—¶å€™æ˜¯æœ‰ç±»å‹çš„ï¼Œä»¥å†³å®šåˆ°åº•æ˜¯å“ªäº› Queue ç¬¦åˆæ¡ä»¶ï¼Œå¯ä»¥æ¥æ”¶æ¶ˆæ¯

|å±æ€§|æè¿°|
|:--|:--|
|`fanout`|æ‰€æœ‰ bind åˆ°æ­¤ exchange çš„ queue éƒ½å¯ä»¥æ¥æ”¶æ¶ˆæ¯|
|`direct`|é€šè¿‡ routingKey å’Œ exchange å†³å®šçš„é‚£ä¸ªå”¯ä¸€çš„ queue å¯ä»¥æ¥æ”¶æ¶ˆæ¯|
|`topic`|æ‰€æœ‰ç¬¦åˆ routingKey(æ­¤æ—¶å¯ä»¥æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼)çš„ routingKey æ‰€ bind çš„ queue å¯ä»¥æ¥æ”¶æ¶ˆæ¯|

fanout(å‘å¸ƒè®¢é˜…)

åªè¦æœ‰æ¶ˆè´¹è€…ï¼Œé‚£ä¹ˆæˆ‘ç”Ÿäº§è€…å‘å¸ƒä¸€æ¡æ¶ˆæ¯çš„æ—¶å€™æ‰€æœ‰çš„æ¶ˆè´¹è€…éƒ½ä¼šè¢«æ”¶åˆ°

![rabbitmq-fanout](https://ansheng.me/wp-content/uploads/2016/12/1483069006.png)

```python
# æ¶ˆè´¹è€…
import pika
connection = pika.BlockingConnection(pika.ConnectionParameters(host='192.168.56.100'))
channel = connection.channel()
channel.exchange_declare(exchange='logs', type='fanout')
# ä¸æŒ‡å®šqueueåå­—,rabbitä¼šéšæœºåˆ†é…ä¸€ä¸ªåå­—,exclusive=Trueä¼šåœ¨ä½¿ç”¨æ­¤queueçš„æ¶ˆè´¹è€…æ–­å¼€å,è‡ªåŠ¨å°†queueåˆ é™¤
result = channel.queue_declare(exclusive=True)
# è·å–queueçš„name
queue_name = result.method.queue
# æŠŠqueueç»‘å®šåˆ°exchange
channel.queue_bind(exchange='logs', queue=queue_name)
def callback(ch, method, properties, body):
    print(" [x] %r" % body)
channel.basic_consume(callback,queue=queue_name,no_ack=True)
channel.start_consuming()
```

```python
# ç”Ÿäº§è€…
import pika
connection = pika.BlockingConnection(pika.ConnectionParameters(host='192.168.56.100'))
channel = connection.channel()
# fanoutå‘é€ç»™æ‰€æœ‰äºº
channel.exchange_declare(exchange='logs', type='fanout')
channel.basic_publish(exchange='logs', routing_key='', body="Hello World!")
connection.close()
```

### direct(å…³é”®å­—)

RabbitMQ è¿˜æ”¯æŒæ ¹æ®å…³é”®å­—å‘é€ï¼Œå³ï¼šé˜Ÿåˆ—ç»‘å®šå…³é”®å­—ï¼Œå‘é€è€…å°†æ•°æ®æ ¹æ®å…³é”®å­—å‘é€åˆ°æ¶ˆæ¯ exchangeï¼Œexchange æ ¹æ® å…³é”®å­— åˆ¤å®šåº”è¯¥å°†æ•°æ®å‘é€è‡³æŒ‡å®šé˜Ÿåˆ—ã€‚

![rabbitmq-direct](https://ansheng.me/wp-content/uploads/2016/12/1483069041.png)

ç”Ÿäº§è€…ä»£ç 

```python
#!/usr/bin/env python
import pika
import sys

connection = pika.BlockingConnection(pika.ConnectionParameters(
    host='192.168.56.100'))
channel = connection.channel()

channel.exchange_declare(exchange='direct_logs',
                         type='direct')

severity = sys.argv[1] if len(sys.argv) > 1 else 'info'
message = ' '.join(sys.argv[2:]) or 'Hello World!'
channel.basic_publish(exchange='direct_logs',
                      routing_key=severity,
                      body=message)
print(" [x] Sent %r:%r" % (severity, message))
connection.close()
```

æ¶ˆè´¹è€…ä»£ç 

```python
#!/usr/bin/env python
import pika
import sys

connection = pika.BlockingConnection(pika.ConnectionParameters(
        host='192.168.56.100'))
channel = connection.channel()

channel.exchange_declare(exchange='direct_logs',
                         type='direct')

result = channel.queue_declare(exclusive=True)
queue_name = result.method.queue

severities = sys.argv[1:]
if not severities:
    sys.stderr.write("Usage: %s [info] [warning] [error]\n" % sys.argv[0])
    sys.exit(1)

for severity in severities:
    channel.queue_bind(exchange='direct_logs',
                       queue=queue_name,
                       routing_key=severity)

print(' [*] Waiting for logs. To exit press CTRL+C')

def callback(ch, method, properties, body):
    print(" [x] %r:%r" % (method.routing_key, body))

channel.basic_consume(callback,
                      queue=queue_name,
                      no_ack=True)

channel.start_consuming()
```

### topic(æ¨¡ç³ŠåŒ¹é…)

åœ¨ topic ç±»å‹ä¸‹ï¼Œå¯ä»¥è®©é˜Ÿåˆ—ç»‘å®šå‡ ä¸ªæ¨¡ç³Šçš„å…³é”®å­—ï¼Œä¹‹åå‘é€è€…å°†æ•°æ®å‘é€åˆ° exchangeï¼Œexchange å°†ä¼ å…¥â€è·¯ç”±å€¼â€œå’Œ â€å…³é”®å­—â€œè¿›è¡ŒåŒ¹é…ï¼ŒåŒ¹é…æˆåŠŸï¼Œåˆ™å°†æ•°æ®å‘é€åˆ°æŒ‡å®šé˜Ÿåˆ—ã€‚


**è¡¨è¾¾å¼ç¬¦å·è¯´æ˜ï¼š**

|ç¬¦å·|æè¿°|
|:--|:--|
|`#`|è¡¨ç¤ºå¯ä»¥åŒ¹é…`0ä¸ª`æˆ–`å¤šä¸ª`å•è¯|
|`*`|è¡¨ç¤ºåªèƒ½åŒ¹é…`ä¸€ä¸ª`å•è¯|

|å‘é€è€…è·¯ç”±å€¼|é˜Ÿåˆ—ä¸­|æ˜¯å¦åŒ¹é…|
|:--|:--|:--|
|ansheng.me|ansheng.*|ä¸åŒ¹é…
|ansheng.me|ansheng.#|åŒ¹é…

æ¶ˆè´¹è€…ä»£ç 

```python
#!/usr/bin/env python
import pika
import sys

connection = pika.BlockingConnection(pika.ConnectionParameters(
        host='192.168.56.100'))
channel = connection.channel()

channel.exchange_declare(exchange='topic_logs',
                         type='topic')

result = channel.queue_declare(exclusive=True)
queue_name = result.method.queue

binding_keys = sys.argv[1:]
if not binding_keys:
    sys.stderr.write("Usage: %s [binding_key]...\n" % sys.argv[0])
    sys.exit(1)

for binding_key in binding_keys:
    channel.queue_bind(exchange='topic_logs',
                       queue=queue_name,
                       routing_key=binding_key)

print(' [*] Waiting for logs. To exit press CTRL+C')

def callback(ch, method, properties, body):
    print(" [x] %r:%r" % (method.routing_key, body))

channel.basic_consume(callback,
                      queue=queue_name,
                      no_ack=True)

channel.start_consuming()
```
ç”Ÿäº§è€…ä»£ç 
```python
#!/usr/bin/env python
import pika
import sys

connection = pika.BlockingConnection(pika.ConnectionParameters(
        host='192.168.56.100'))
channel = connection.channel()

channel.exchange_declare(exchange='topic_logs',
                         type='topic')

routing_key = sys.argv[1] if len(sys.argv) > 1 else 'anonymous.info'
message = ' '.join(sys.argv[2:]) or 'Hello World!'
channel.basic_publish(exchange='topic_logs',
                      routing_key=routing_key,
                      body=message)
print(" [x] Sent %r:%r" % (routing_key, message))
connection.close()
```

## RPC(Remote procedure call)

å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªä»»åŠ¡åˆ°æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯æŠŠä»»åŠ¡çš„æ‰§è¡Œç»“æœå†è¿”å›ç»™å®¢æˆ·ç«¯

![rabbitmq-rpc](https://ansheng.me/wp-content/uploads/2016/12/1483069085.png)

- RPC Server

```python
# _*_coding:utf-8_*_
import pika

connection = pika.BlockingConnection(pika.ConnectionParameters(
    host='192.168.56.100'))
channel = connection.channel()
# å£°æ˜ä¸€ä¸ªRPC QUEUE
channel.queue_declare(queue='rpc_queue')

def fib(n):
    if n == 0:
        return 0
    elif n == 1:
        return 1
    else:
        return fib(n - 1) + fib(n - 2)

def on_request(ch, method, props, body):
    # æ¥å—ä¼ è¿‡æ¥çš„å€¼
    n = int(body)
    print(" [.] fib(%s)" % n)
    # äº¤ç»™fibå‡½æ•°è¿›è¡Œæ–æ³¢é‚£å¥‘å¤„ç†
    response = fib(n)
    # æŠŠç»“æœå‘å›å»ï¼Œæ­¤æ—¶æ¶ˆè´¹è€…å˜æˆç”Ÿäº§è€…
    ch.basic_publish(exchange='',
                     routing_key=props.reply_to,
                     # å®¢æˆ·ç«¯ä¼ è¿‡æ¥çš„UUIDé¡ºä¾¿å‘å›å»
                     properties=pika.BasicProperties(correlation_id=props.correlation_id),
                     body=str(response))
    # æŒä¹…åŒ–
    ch.basic_ack(delivery_tag=method.delivery_tag)

# åŒæ—¶åªå¤„ç†ä¸€ä¸ªä»»åŠ¡
channel.basic_qos(prefetch_count=1)
channel.basic_consume(on_request, queue='rpc_queue')
print(" [x] Awaiting RPC requests")
channel.start_consuming()
```

RPC Client

```python
# _*_coding:utf-8_*_
import pika
import uuid

class FibonacciRpcClient(object):
    def __init__(self):
        self.connection = pika.BlockingConnection(pika.ConnectionParameters(
            host='192.168.56.100'))

        self.channel = self.connection.channel()

        result = self.channel.queue_declare(exclusive=True)
        # æœåŠ¡ç«¯è¿”å›å¤„ç†å®Œæ¯•çš„æ•°æ®æ–°Queueåç§°
        self.callback_queue = result.method.queue

        self.channel.basic_consume(self.on_response, no_ack=True,
                                   queue=self.callback_queue)

    def on_response(self, ch, method, props, body):
        # corr_idç­‰äºåˆšåˆšå‘é€è¿‡å»çš„IDï¼Œå°±ä»£è¡¨è¿™æ¡æ¶ˆæ¯æ˜¯æˆ‘çš„
        if self.corr_id == props.correlation_id:
            self.response = body

    def call(self, n):
        self.response = None
        # ç”Ÿæˆä¸€ä¸ªå”¯ä¸€IDï¼Œç›¸å½“äºæ¯ä¸ªä»»åŠ¡çš„ID
        self.corr_id = str(uuid.uuid4())
        self.channel.basic_publish(exchange='',
                                   routing_key='rpc_queue',
                                   properties=pika.BasicProperties(
                                       # è®©æœåŠ¡ç«¯å¤„ç†å®Œæˆä¹‹åæŠŠæ•°æ®æ”¾åˆ°è¿™ä¸ªQueueé‡Œé¢
                                       reply_to=self.callback_queue,
                                       # åŠ ä¸Šä¸€ä¸ªä»»åŠ¡ID
                                       correlation_id=self.corr_id,
                                   ),
                                   body=str(n))
        while self.response is None:
            # ä¸æ–­åœ°å»Queueæ¥å—æ¶ˆæ¯ï¼Œä½†ä¸æ˜¯é˜»å¡çš„ï¼Œè€Œæ˜¯ä¸€ç›´å¾ªç¯çš„å»å–
            self.connection.process_data_events()
        return int(self.response)

fibonacci_rpc = FibonacciRpcClient()
print(" [x] Requesting fib(30)")
response = fibonacci_rpc.call(30)
print(" [.] Got %r" % response)
```