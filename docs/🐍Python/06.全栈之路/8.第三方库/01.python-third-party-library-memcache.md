---
title: Python æ ‡å‡†åº“ç³»åˆ—ä¹‹ Memcache æ¨¡å—

tags: 
  - ç¼–ç 
  - é¢å‘å¯¹è±¡
top: 3
categories: 
  - ğŸ’» å·¥ä½œ
  - ğŸPython
  - å…¨æ ˆä¹‹è·¯
  - ç¬¬ä¸‰æ–¹åº“
date: 2020-05-23 18:21:46
permalink: /pages/86dfe4/
---
# Python æ ‡å‡†åº“ç³»åˆ—ä¹‹ Memcache æ¨¡å—

è¿™ä¸ªæ¨¡å—æ˜¯ä¸€ä¸ª`Python`æ“ä½œ`memcached`çš„ä¸€ä¸ª API æ¥å£ã€‚

Memcached å®˜ç½‘ï¼šhttp://memcached.org/
æ¨¡å—å®˜ç½‘ï¼šhttps://pypi.python.org/pypi/python-memcached/

## What is Memcached

Free & open source, high-performance, distributed memory object caching system, generic in nature, but intended for use in speeding up dynamic web applications by alleviating database load.

Memcached is an in-memory key-value store for small chunks of arbitrary data (strings, objects) from results of database calls, API calls, or page rendering.

Memcached is simple yet powerful. Its simple design promotes quick deployment, ease of development, and solves many problems facing large data caches. Its API is available for most popular languages.

> ä»¥ä¸Šå†…å®¹æ‘˜è‡ªå®˜ç½‘çš„ä»‹ç»ï¼Œå…·ä½“ä¿¡æ¯è®¿é—®å®˜ç½‘

## å®‰è£… Memcached

åŒ…å®‰è£…

Ubuntu

```bash
apt-get install memcached
```

CentOS

```bash
yum install memcached
```

æºç å®‰è£…

`Memcached`æºç åŒ…å®‰è£…çš„æ—¶å€™éœ€è¦ä¾èµ–äº`libevent`

```bash
# Ubuntu
apt-get install libevent-dev
# CentOS
yum install libevent-devel
```

ç¼–è¯‘å®‰è£…`memcached`

```bash
wget https://memcached.org/latest
tar -zxf memcached-1.x.x.tar.gz
cd memcached-1.x.x
./configure --prefix=/usr/local/memcached
make && make test && sudo make install
```

å…·ä½“å‚æ•°è§`./configure --help`å…¨é€‰é¡¹ï¼ŒSASL æ”¯æŒéœ€è¦ä¸€äº›å¯é€‰é™„åŠ åº“ã€‚

å¯åŠ¨

æˆ‘è¿™é‡Œå®‰è£…çš„æ—¶å€™æ˜¯é‡‡ç”¨åŒ…çš„æ–¹å¼è¿›è¡Œå®‰è£…çš„ã€‚

```bash
[root@anshengme ~]# memcached -d -m 10 -u root -l 0.0.0.0 -p 11211 -c 256 -P /tmp/memcached.pid
```

å‚æ•°è¯´æ˜

|å‚æ•°|æè¿°|
|:--|:--|
|`-d`|æ˜¯å¯åŠ¨ä¸€ä¸ªå®ˆæŠ¤è¿›ç¨‹|
|`-m`|æ˜¯åˆ†é…ç»™ Memcache ä½¿ç”¨çš„å†…å­˜æ•°é‡ï¼Œå•ä½æ˜¯ MB|
|`-u`|æ˜¯è¿è¡Œ Memcache çš„ç”¨æˆ·|
|`-l`|æ˜¯ç›‘å¬çš„æœåŠ¡å™¨ IP åœ°å€|
|`-p`|æ˜¯è®¾ç½® Memcache ç›‘å¬çš„ç«¯å£,æœ€å¥½æ˜¯ 1024 ä»¥ä¸Šçš„ç«¯å£|
|`-c`|é€‰é¡¹æ˜¯æœ€å¤§è¿è¡Œçš„å¹¶å‘è¿æ¥æ•°ï¼Œé»˜è®¤æ˜¯ 1024ï¼ŒæŒ‰ç…§ä½ æœåŠ¡å™¨çš„è´Ÿè½½é‡æ¥è®¾å®š|
|`-P`|æ˜¯è®¾ç½®ä¿å­˜ Memcache çš„ pid æ–‡ä»¶|

è®¾ç½®å¼€æœºè‡ªå¯åŠ¨

```bash
[root@anshengme ~]# chmod +x /etc/rc.d/rc.local
[root@anshengme ~]# echo 'memcached -d -m 10 -u root -l 0.0.0.0 -p 11211 -c 256 -P /tmp/memcached.pid' >> /etc/rc.local
```

å…³é—­ memcached

```bash
[root@anshengme ~]# pkill `cat /tmp/memcached.pid`
```

æµ‹è¯•

å…ˆæŸ¥çœ‹ 11211 ç«¯å£æ˜¯å¦å¯åŠ¨

```bash
[root@anshengme ~]# netstat -tlnp | grep "11211"
tcp        0      0 0.0.0.0:11211           0.0.0.0:*               LISTEN      4245/memcached
```

ä½¿ç”¨ telnet æŸ¥çœ‹å¯åŠ¨çš„ 11211 ç«¯å£æ˜¯å¦å¯ä»¥ï¼Œå¯ä»¥åˆ™æµ‹è¯• OKï¼Œå¦åˆ™å°±éœ€è¦ä½ æ‹é”™äº†ï¼Œä½†æ„¿æ²¡æœ‰é—®é¢˜ã€‚

```bash
[root@anshengme ~]# telnet 127.0.0.1 11211
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is '^]'.

```

å¦‚æœå‡ºç°ä»¥ä¸‹å†…å®¹å°±ä»£è¡¨å¯åŠ¨æˆåŠŸï¼

## Memcache ä½¿ç”¨

å®‰è£… Memcache

ä¸‹è½½æ¨¡å—åŒ…ï¼Œç›®å‰æœ€æ–°ç‰ˆ

```bash
[root@anshengme ~]# wget https://pypi.python.org/packages/f7/62/14b2448cfb04427366f24104c9da97cf8ea380d7258a3233f066a951a8d8/python-memcached-1.58.tar.gz#md5=23b258105013d14d899828d334e6b044
```

è§£å‹å¹¶å®‰è£…

```bash
[root@anshengme ~]# tar xf python-memcached-1.58.tar.gz
[root@anshengme ~]# cd python-memcached-1.58
[root@anshengme python-memcached-1.58]# python setup.py install
```

è¿›å…¥ Python è§£é‡Šå™¨å¯¼å…¥æ¨¡å—ï¼Œå¦‚æœå¯¼å…¥æˆåŠŸå°±è¡¨ç¤ºæ¨¡å—å®‰è£…æˆåŠŸã€‚

```bash
[root@anshengme python-memcached-1.58]# python
>>> import memcache
>>>
```

é¦–æ¬¡ä½“éªŒ

```python
# å¯¼å…¥memcacheæ¨¡å—
>>> import memcache
# è¿æ¥åˆ°ä¸€å°MemcachedæœåŠ¡å™¨
>>> conn = memcache.Client(['192.168.56.100:11211'])
# è®¾ç½®ä¸€ä¸ªå€¼ï¼Œå¦‚æœå­˜åœ¨åˆ™è¦†ç›–
>>> conn.set('k1', 'v1')
True
# è·å–å€¼çš„å†…å®¹
>>> conn.get('k1')
'v1'
```

æ›´å¤šçš„ä½¿ç”¨æ–¹æ³•

è®¾ç½®è¶…æ—¶æ—¶é—´
```python
>>> conn.set('k', 'v', 1)
True
>>> conn.get('k')
```
è®¾ç½®å€¼ï¼Œå¦‚æœå­˜åœ¨å°±æŠ¥é”™
```python
>>> conn.add('k','hello')
# Falseè®¾ç½®å¤±è´¥
False
>>> conn.get('k')
# åŸå€¼æ²¡å˜
'v'
```
ä¿®æ”¹å€¼ï¼Œä¸å­˜åœ¨åˆ™è¿”å› False
```python
>>> conn.replace('k','helloworld')
# è®¾ç½®æˆåŠŸ
True
>>> conn.get('k')
# è¿”å›ä¿®æ”¹åçš„å€¼
'helloworld'
>>> conn.replace('kkkk','hello')
# ä¿®æ”¹ä¸€ä¸ªä¸å­˜åœ¨çš„å€¼
False
```
è®¾ç½®å¤šä¸ªå€¼ï¼Œå€¼ä¸å­˜åœ¨åˆ™åˆ›å»ºï¼Œå­˜åœ¨åˆ™ä¿®æ”¹
```python
>>> conn.get('key1')
>>> conn.set_multi({'key1':'value1','key2':'value2'})
[]
>>> conn.get('key1')
'value1'
```
åˆ é™¤ä¸€ä¸ªå€¼
```python
>>> conn.get('key1')
'value1'
>>> conn.delete('key1')
1
>>> conn.get('key1')
```
åˆ é™¤å¤šä¸ªå€¼
```python
>>> conn.set_multi({'key3':'value3','key4':'value4'})
[]
>>> conn.delete_multi(['key3', 'key4'])
1
```
è·å–ä¸€ä¸ªå€¼å’Œè·å–å¤šä¸ªå€¼
```python
>>> conn.set_multi({'key5':'value5','key6':'value6'})
[]
>>> conn.get('key5')
'value5'
>>> conn.get_multi(['key5','key6'])
{'key5': 'value5', 'key6': 'value6'}
```
ä¿®æ”¹æŒ‡å®š key çš„å€¼ï¼Œåœ¨è¯¥å€¼`åé¢`è¿½åŠ å†…å®¹
```python
>>> conn.append('key5','after')
True
>>> conn.get('key5')
'value5after'
```
ä¿®æ”¹æŒ‡å®š key çš„å€¼ï¼Œåœ¨è¯¥å€¼ å‰é¢ æ’å…¥å†…å®¹
```python
>>> conn.prepend('key5','before')
True
>>> conn.get('key5')
'beforevalue5after'
```
è‡ªå¢ä¸è‡ªå‡ï¼Œå°† Memcached ä¸­çš„æŸä¸€ä¸ªå€¼åŠ æˆ–å‡å°‘ N(N é»˜è®¤ä¸º 1)
```python
>>> conn.set('number','9')
True
# å¢åŠ 
>>> conn.incr('number')
10
# å¢åŠ 
>>> conn.incr('number', 10)
20
# å‡å°‘
>>> conn.decr('number')
19
# å‡å°‘
>>> conn.decr('number', 10)
9
```

æ¯”å¦‚è®¾ç½®äº†è¿™ä¹ˆä¸€ä¸ªå€¼ï¼š
```python
conn.set('n','10)
```
ç°åœ¨ A ç”¨æˆ·å’Œ B ç”¨æˆ·åŒæ—¶è·å–åˆ°äº†è¿™ä¸¤ä¸ªå€¼ï¼Œå¦‚æœæœ‰å…¶ä¸­çš„ä»»ä½•ä¸€ä¸ªç”¨æˆ·å¯¹è¿™ä¸ªå€¼è¿›è¡Œäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆå¦å¤–ä¸€ä¸ªç”¨æˆ·åœ¨å¯¹è¿™ä¸ªå€¼è¿›è¡Œæ“ä½œçš„æ—¶å€™å°±ä¼šæŠ¥é”™ã€‚

å¦‚æœè¦è§£å†³ä»¥ä¸Šçš„é—®é¢˜å¯ä»¥ä½¿ç”¨`gets`ä¸`cas`ï¼Œæµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š

```python
# -- s1.py
# _*_ coding:utf-8 _*_
import memcache
conn1 = memcache.Client(['192.168.56.100:11211'], debug=True, cache_cas=True)
conn1.set('n', 9)
# getsä¼šè·å–åˆ°å€¼å¹¶ä¸”è·å–è®¡æ•°å™¨
result = conn1.gets('n')
print(result)
# é˜»å¡
input('>>>')
# è®¾ç½®å€¼
conn1.cas('n', 99)

# -- s2
# _*_ coding:utf-8 _*_
import memcache
conn2 = memcache.Client(['192.168.56.100:11211'], debug=True, cache_cas=True)
# getsä¼šè·å–åˆ°å€¼å¹¶ä¸”è·å–è®¡æ•°å™¨
result = conn2.gets('n')
print(result)
# é˜»å¡
input('>>>')
# è®¾ç½®å€¼
conn2.cas('n', 100)
```
æ‰§è¡Œæ•ˆæœå¦‚ä¸‹å›¾ï¼š
![python-memcache-03](/images/2016/12/1483067689.gif)

å¤šèŠ‚ç‚¹çš„æ“ä½œ

é¦–å…ˆåœ¨æœåŠ¡å™¨ä¸Šé¢èµ·å››ä¸ª`memcached`å®ä¾‹ï¼Œæ¯ä¸ªå®ä¾‹éƒ½æ˜¯ä¸€ä¸ªå•ç‹¬çš„`memcached`æœåŠ¡

```bash
[root@anshengme ~]# netstat -tlnp | grep "memcached"
tcp        0      0 0.0.0.0:11211           0.0.0.0:*               LISTEN      1125/memcached
tcp        0      0 0.0.0.0:11212           0.0.0.0:*               LISTEN      1330/memcached
tcp        0      0 0.0.0.0:11213           0.0.0.0:*               LISTEN      1337/memcached
tcp        0      0 0.0.0.0:11214           0.0.0.0:*               LISTEN      1344/memcached
```

```python
# _*_ coding:utf-8 _*_

import memcache

# è¿æ¥åˆ°å¤šå°memcachedæœåŠ¡å™¨
conn = memcache.Client(
    # IP:ç«¯å£ï¼Œæƒé‡
    [('192.168.56.100:11211', 4),
     ('192.168.56.100:11212', 3),
     ('192.168.56.100:11213', 1),
     ('192.168.56.100:11214', 2)]
)

conn.set('k', 'v')
```

å¤šèŠ‚ç‚¹æ•°æ®å­˜å‚¨æµç¨‹

1. å…ˆå°†ä¸€ä¸ªå­—ç¬¦ä¸²è½¬æ¢ä¸ºä¸€ä¸ªæ•°å­—
2. å¾—å‡ºçš„ç»“æœå’ŒèŠ‚ç‚¹çš„æ•°é‡è¿›è¡Œé™¤æ³•è¿ç®—
3. å¾—å‡ºçš„ç»“æœè‚¯å®šåœ¨èŠ‚ç‚¹æ•°é‡ä¹‹é—´ï¼Œä½™æ•°æ˜¯å‡ ï¼Œå°±åœ¨é‚£å°èŠ‚ç‚¹ä¸Šé¢å­˜æ”¾æ•°æ®

å¦‚å›¾æ‰€ç¤º

![python-memcache-02](/images/2016/12/1483067656.png)

```python
# å°†å­—ç¬¦ä¸²è½¬æ¢ä¸ºæ•°å­—æ¨¡å—
import binascii

# æ‘˜è‡ªmemcacheæºç ä¸­çš„ä¸€éƒ¨åˆ†
def cmemcache_hash(key):
    return ((((binascii.crc32(key) & 0xffffffff) >> 16) & 0x7fff) or 1)

	# resultå°±æ˜¯è¿”å›çš„æ•°å­—
result = cmemcache_hash(bytes('k', encoding='utf-8'))
print(result)
```

## åŸºäº Memcached çš„ Session å®ä¾‹

ä¸»ç¨‹åºè„šæœ¬

```python
# _*_coding:utf-8 _*_

import tornado.ioloop
import tornado.web
import MemcacheToSession

class BaseHandler(tornado.web.RequestHandler):
    def initialize(self):
        self.session = MemcacheToSession.Session(self)
        # pass

class MainHandler(BaseHandler):
    def get(self):
        Info = self.session.GetAll()

        self.render("template/index.html", Data=Info)

    def post(self, *args, **kwargs):
        # è·å–ä¼ è¿‡æ¥çš„å€¼
        Key = self.get_argument('key')
        Val = self.get_argument('val')
        action = self.get_argument('action')
        if action == 'set':
            # è®¾ç½®å€¼
            self.session[Key] = Val
        elif action == 'del':
            del self.session[Key]

        # è·å–æ‰€æœ‰ä¿¡æ¯
        Info = self.session.GetAll()
        # è¿”å›ç»™å‰ç«¯æ¸²æŸ“
        self.render("template/index.html", Data=Info)

settings = {
    "tempalte_path": "template",
    "cookie_secret": "508CE6152CB93994628D3E99934B83CC",
}

application = tornado.web.Application([
    (r'/', MainHandler),
], **settings)

if __name__ == "__main__":
    application.listen(9999)
    tornado.ioloop.IOLoop.instance().start()
```
æ¨¡æ¿æ–‡ä»¶
```html
<!-- template\index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
</head>
<body>

<form action="/" method="post">
    set/delï¼š<input type="text" name="action" value="set"/>
    Key: <input type="text" name="key"/>
    Val: <input type="text" name="val"/>
    <input type="submit" value="è®¾ç½®"/>
</form>

{{ Data }}

</body>
</html>
```
è®¾ç½® Session çš„å°æ¨¡å—
```python
# _*_ coding: utf-8 _*_

import memcache
import hashlib
import uuid
import json

# è¿æ¥memcached
conn = memcache.Client(
    ['192.168.56.100:11211']
)


class Session:
    CookieID = 'uc'
    ExpiresTime = 60 * 20

    def __init__(self, handler):
        """
        ç”¨äºåˆ›å»ºç”¨æˆ·sessionåœ¨memcachedä¸­çš„å­—å…¸
        :param handler: è¯·æ±‚å¤´
        """
        self.handler = handler
        # ä»å®¢æˆ·ç«¯è·å–éšæœºå­—ç¬¦ä¸²
        SessionID = self.handler.get_secure_cookie(Session.CookieID, None)
        # å®¢æˆ·ç«¯å­˜åœ¨å¹¶ä¸”åœ¨æœåŠ¡ç«¯ä¹Ÿå­˜åœ¨
        if SessionID and conn.get(SessionID):
            self.SessionID = SessionID
        else:
            # è·å–éšæœºå­—ç¬¦ä¸²
            self.SessionID = self.SessionKey()
            # æŠŠéšæœºå­—ç¬¦ä¸²å†™å…¥memcached,æ—¶é—´æ˜¯20åˆ†é’Ÿ
            conn.set(self.SessionID, json.dumps({}), Session.ExpiresTime)
        # æ¯æ¬¡è®¿é—®è¶…æ—¶æ—¶é—´å°±åŠ 20åˆ†é’Ÿ
        conn.set(self.SessionID, conn.get(self.SessionID), Session.ExpiresTime)
        # è®¾ç½®Cookie
        self.handler.set_secure_cookie('uc', self.SessionID)

    def SessionKey(self):
        """
        :return: ç”Ÿæˆéšæœºå­—ç¬¦ä¸²
        """
        UUID = str(uuid.uuid1()).replace('-', '')
        MD5 = hashlib.md5()
        MD5.update(bytes(UUID, encoding='utf-8'))
        SessionKey = MD5.hexdigest()
        return SessionKey

    def __setitem__(self, key, value):
        """
        è®¾ç½®session
        :param key: sessionä¿¡æ¯ä¸­çš„key
        :param value: å¯¹åº”çš„Value
        """
        # è·å–session_id
        SessionDict = json.loads(conn.get(self.SessionID))
        # è®¾ç½®å­—å…¸çš„key
        SessionDict[key] = value
        # é‡æ–°èµ‹å€¼
        conn.set(self.SessionID, json.dumps(SessionDict), Session.ExpiresTime)

    def __getitem__(self, item):
        """
        :param item: Sessionä¿¡æ¯ä¸­å¯¹åº”çš„Key
        :return: è·å–çš„Sessionä¿¡æ¯
        """
        # è·å–SessionIDå¹¶è½¬æ¢ä¸ºå­—å…¸
        SessionDict = json.loads(conn.get(self.SessionID))
        # è·å–å¯¹åº”çš„æ•°æ®
        ResultData = SessionDict.get(item, None)
        return ResultData

    def __delitem__(self, key):
        """
        :param key: è¦åˆ é™¤çš„Key
        """
        # è·å–SessionIDå¹¶è½¬æ¢ä¸ºå­—å…¸
        SessionDict = json.loads(conn.get(self.SessionID))
        # åˆ é™¤å­—å…¸çš„key
        del SessionDict[key]
        # é‡æ–°èµ‹å€¼
        conn.set(self.SessionID, json.dumps(SessionDict), Session.ExpiresTime)

    def GetAll(self):
        # è·å–Sessionä¸­æ‰€æœ‰çš„ä¿¡æ¯ï¼Œä»…ç”¨äºæµ‹è¯•
        SessionData = conn.get(self.SessionID)
        return SessionData
```
æ¼”ç¤ºå¦‚ä¸‹ï¼š
![python-memcache-04](/images/2016/12/1483067610.gif)