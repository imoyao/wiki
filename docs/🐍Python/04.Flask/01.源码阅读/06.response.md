---
title: Flask æºç è§£æï¼šå“åº”

tags: 
  - Flask
  - web å¼€å‘
  - Python
categories: 
  - ğŸ’»å·¥ä½œ
  - ğŸPython
  - Flask
  - æºç é˜…è¯»
date: 2019-08-25 12:27:56
permalink: /flask-insight-response/
---
è¿™æ˜¯ Flask æºç è§£æç³»åˆ—æ–‡ç« çš„å…¶ä¸­ä¸€ç¯‡ï¼Œæœ¬ç³»åˆ—æ‰€æœ‰æ–‡ç« åˆ—è¡¨ï¼š

*   [Flask æºç è§£æï¼šç®€ä»‹](/flask-insight-introduction)
*   [Flask æºç è§£æï¼šåº”ç”¨å¯åŠ¨æµç¨‹](/flask-insight-start-process)
*   [Flask æºç è§£æï¼šè·¯ç”±](/flask-insight-routing)
*   [Flask æºç è§£æï¼šä¸Šä¸‹æ–‡](/flask-insight-context)
*   [Flask æºç è§£æï¼šè¯·æ±‚](/flask-insight-request)
*   [Flask æºç è§£æï¼šå“åº”](/flask-insight-response)
*   [Flask æºç è§£æï¼šé…ç½®](/flask-insight-config)
*   [Flask æºç è§£æï¼šsession](/flask-insight-session)

## response ç®€ä»‹

åœ¨ flask åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦ç¼–å†™ view å‡½æ•°ï¼Œå¹¶ä¸éœ€è¦ç›´æ¥å’Œå“åº”ï¼ˆresponseï¼‰æ‰“äº¤é“ï¼Œflask ä¼šè‡ªåŠ¨ç”Ÿæˆå“åº”è¿”å›ç»™å®¢æˆ·ç«¯ã€‚

> The return value from a view function is automatically converted into a response object for you.
> â€”â€” Flask docs

æˆ‘ä»¬çŸ¥é“ HTTP å“åº”åˆ†ä¸ºä¸‰ä¸ªéƒ¨åˆ†ï¼š
çŠ¶æ€æ ï¼ˆHTTP ç‰ˆæœ¬ã€çŠ¶æ€ç å’Œè¯´æ˜ï¼‰ã€å¤´éƒ¨ï¼ˆä»¥å†’å·éš”å¼€çš„å­—ç¬¦å¯¹ï¼Œç”¨äºå„ç§æ§åˆ¶å’Œåå•†ï¼‰ã€bodyï¼ˆæœåŠ¡ç«¯è¿”å›çš„æ•°æ®ï¼‰ã€‚æ¯”å¦‚ä¸‹é¢è®¿é—®[åšå®¢é¦–é¡µ](https://cizixs.com)çš„å“åº”ï¼š
```plain
    HTTP/1.1 200 OK

    Access-Control-Allow-Origin: *
    Cache-Control: max-age=600
    Content-Encoding: gzip
    Content-Type: text/html; charset=utf-8
    Date: Wed, 15 Feb 2017 07:50:41 GMT
    Expires: Wed, 15 Feb 2017 08:00:41 GMT
    Last-Modified: Wed, 15 Feb 2017 07:46:56 GMT
    Server: GitHub.com
    Transfer-Encoding: chunked
    X-GitHub-Request-Id: D2A7:7B6B:33C0628:47C44B9:58A40851

    <BODY>

```
flask è‡ªç„¶ä¹Ÿä¼šæä¾›æ‰€æœ‰è¿™äº›æ•°æ®çš„æ“ä½œï¼Œè§†å›¾å‡½æ•°å°±æ”¯æŒè¿”å›ä¸‰ä¸ªå€¼ï¼šç¬¬ä¸€ä¸ªæ˜¯è¿”å›çš„æ•°æ®ï¼Œç¬¬äºŒä¸ªæ˜¯çŠ¶æ€ç ï¼Œç¬¬ä¸‰ä¸ªæ˜¯å¤´éƒ¨å­—å…¸ã€‚æ¯”å¦‚ï¼š
```python
    @app.route('/')
    def hello_world():
        return 'Hello, World!', 201, {'X-Foo': 'bar'}
```

è¿™ç¯‡æ–‡ç« å°±è®²è®²è¿™èƒŒåçš„é­”æ³•ã€‚

## flask å“åº”ï¼ˆresponseï¼‰

åœ¨ [Flask æºç è§£æï¼šåº”ç”¨å¯åŠ¨æµç¨‹](https://cizixs.com/2017/01/11/flask-insight-start-process) çš„æœ€åï¼Œæˆ‘ä»¬è®²åˆ° `full_dispatch_request` åœ¨è°ƒç”¨è·¯ç”±çš„è§†å›¾å‡½æ•°ä¹‹åï¼Œä¼šè°ƒç”¨ `finalize_request` è¿›è¡Œæœ€åçš„å¤„ç†ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œå°±åŒ…å«äº† response å¯¹è±¡çš„ç”Ÿæˆå’Œå¤„ç†é€»è¾‘ã€‚

`finalize_request` çš„ä»£ç å¦‚ä¸‹ï¼š
```python
    def finalize_request(self, rv, from_error_handler=False):
        """Given the return value from a view function this finalizes
        the request by converting it into a response and invoking the
        postprocessing functions.  This is invoked for both normal
        request dispatching as well as error handlers.
        """
        response = self.make_response(rv)
        try:
            response = self.process_response(response)
            request_finished.send(self, response=response)
        except Exception:
            if not from_error_handler:
                raise
            self.logger.exception('Request finalizing failed with an '
                                  'error while handling an error')
        return response
```

é‡Œé¢æœ‰ä¸¤ä¸ªæ–¹æ³•è°ƒç”¨ï¼š`make_response` æ ¹æ®è§†å›¾å‡½æ•°çš„è¿”å›å€¼ç”Ÿæˆ response å¯¹è±¡ï¼Œ`process_response` å¯¹ response åšä¸€äº›åç»­çš„å¤„ç†ï¼ˆæ¯”å¦‚æ‰§è¡Œ hooks å‡½æ•°ï¼‰ã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ `make_response`ï¼š
```python
    def make_response(self, rv):
        """Converts the return value from a view function to a real
        response object that is an instance of :attr:`response_class`.
        """
        status_or_headers = headers = None
        if isinstance(rv, tuple):
            rv, status_or_headers, headers = rv + (None,) * (3 - len(rv))

        if isinstance(status_or_headers, (dict, list)):
            headers, status_or_headers = status_or_headers, None

        if not isinstance(rv, self.response_class):
            # When we create a response object directly, we let the constructor
            # set the headers and status.  We do this because there can be
            # some extra logic involved when creating these objects with
            # specific values (like default content type selection).
            if isinstance(rv, (text_type, bytes, bytearray)):
                rv = self.response_class(rv, headers=headers,
                                         status=status_or_headers)
                headers = status_or_headers = None

        if status_or_headers is not None:
            if isinstance(status_or_headers, string_types):
                rv.status = status_or_headers
            else:
                rv.status_code = status_or_headers
        if headers:
            rv.headers.extend(headers)

        return rv

```
`make_response` æ˜¯è§†å›¾å‡½æ•°èƒ½è¿”å›å¤šä¸ªä¸åŒæ•°é‡å’Œç±»å‹å€¼çš„å…³é”®ï¼Œå› ä¸ºå®ƒèƒ½å¤„ç†è¿™äº›æƒ…å†µï¼Œç»Ÿä¸€æŠŠå®ƒä»¬è½¬æ¢æˆ responseã€‚
å¦‚æœè¿”å›å€¼æœ¬èº«å°±æ˜¯ Response å®ä¾‹ï¼Œå°±ç›´æ¥ä½¿ç”¨å®ƒï¼›å¦‚æœè¿”å›å€¼æ˜¯å­—ç¬¦ä¸²ç±»å‹ï¼Œå°±æŠŠå®ƒä½œä¸ºå“åº”çš„ bodyï¼Œå¹¶è‡ªåŠ¨è®¾ç½®çŠ¶æ€ç å’Œå¤´éƒ¨ä¿¡æ¯ï¼›
å¦‚æœè¿”å›å€¼æ˜¯ tupleï¼Œä¼šå°è¯•ç”¨ (response, status, headers) æˆ–è€… (response, headers) å»è§£æã€‚

**NOTE**ï¼šå› ä¸ºè§†å›¾å‡½æ•°å¯ä»¥è¿”å› `Response` å¯¹è±¡ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç›´æ¥æ“ä½œ `Response`ã€‚

ä¸ç®¡è§†å›¾å‡½æ•°è¿”å›çš„æ˜¯ä»€ä¹ˆï¼Œæœ€ç»ˆéƒ½ä¼šå˜æˆ `Response` å¯¹è±¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ¥çœ‹çœ‹ `Response` çš„å®šä¹‰ï¼š
```python
    from werkzeug.wrappers import Response as ResponseBase


    class Response(ResponseBase):
        """The response object that is used by default in Flask.  Works like the
        response object from Werkzeug but is set to have an HTML mimetype by
        default.  Quite often you don't have to create this object yourself because
        :meth:`~flask.Flask.make_response` will take care of that for you.

        If you want to replace the response object used you can subclass this and
        set :attr:`~flask.Flask.response_class` to your subclass.
        """
        default_mimetype = 'text/html'
```

Flask çš„ `Response` ç±»éå¸¸ç®€å•ï¼Œå®ƒåªæ˜¯ç»§æ‰¿äº† `werkzeug.wrappers:Response`ï¼Œç„¶åè®¾ç½®é»˜è®¤è¿”å›ç±»å‹ä¸º htmlã€‚
ä¸è¿‡ä»æ³¨é‡Šä¸­ï¼Œæˆ‘ä»¬å¾—åˆ°ä¸¤æ¡å¾ˆæœ‰ç”¨çš„ä¿¡æ¯ï¼š

1.  ä¸€èˆ¬æƒ…å†µä¸‹ä¸è¦ç›´æ¥æ“ä½œ `Response` å¯¹è±¡ï¼Œè€Œæ˜¯ä½¿ç”¨ `make_response` æ–¹æ³•æ¥ç”Ÿæˆå®ƒ
2.  å¦‚æœéœ€è¦ä½¿ç”¨è‡ªå®šä¹‰çš„å“åº”å¯¹è±¡ï¼Œå¯ä»¥è¦†ç›– flask app å¯¹è±¡çš„ `response_class` å±æ€§ã€‚

ç»§ç»­ï¼Œä¸‹é¢å°±è¦åˆ†æ werkzeug å¯¹åº”çš„ä»£ç äº†ã€‚

## werkzeug response

werkzeug å®ç°çš„ response å®šä¹‰åœ¨ `werkzeug/wrappers.py` æ–‡ä»¶ä¸­ï¼š
```python
    class Response(BaseResponse, ETagResponseMixin, ResponseStreamMixin,
                   CommonResponseDescriptorsMixin,
                   WWWAuthenticateMixin):

        """Full featured response object implementing the following mixins:

        - :class:`ETagResponseMixin` for etag and cache control handling
        - :class:`ResponseStreamMixin` to add support for the `stream` property
        - :class:`CommonResponseDescriptorsMixin` for various HTTP descriptors
        - :class:`WWWAuthenticateMixin` for HTTP authentication support
        """
```

å’Œæˆ‘ä»¬åœ¨ [flask è¯·æ±‚](https://cizixs.com/2017/01/18/flask-insight-request)åˆ†æçš„ Request ç±»ä¸€æ ·ï¼Œè¿™é‡Œä½¿ç”¨äº† Mixin æœºåˆ¶ã€‚`BaseResponse` ç²¾ç®€åçš„å¤§æ¦‚æ¡†æ¶å¦‚ä¸‹ï¼š
```python
    class BaseResponse(object):
        """Base response class.  The most important fact about a response object
        is that it's a regular WSGI application.  It's initialized with a couple
        of response parameters (headers, body, status code etc.) and will start a
        valid WSGI response when called with the environ and start response
        callable.
        """

        charset = 'utf-8'
        default_status = 200
        default_mimetype = 'text/plain'
        automatically_set_content_length = True

        def __init__(self, response=None, status=None, headers=None,
                     mimetype=None, content_type=None, direct_passthrough=False):
            pass

```
`BaseResponse` æœ‰ä¸€äº›ç±»å±æ€§ï¼Œå®šä¹‰äº†é»˜è®¤çš„å€¼ï¼Œæ¯”å¦‚é»˜è®¤å­—ç¬¦ç¼–ç æ˜¯ utf-8ï¼Œé»˜è®¤çŠ¶æ€ç æ˜¯ 200 ç­‰ã€‚å®ä¾‹åŒ–çš„æ—¶å€™æ¥å—çš„å‚æ•°æœ‰ï¼š

*   responseï¼š å­—ç¬¦ä¸²æˆ–è€…å…¶ä»– iterable å¯¹è±¡ï¼Œä½œä¸ºå“åº”çš„ body
*   statusï¼š çŠ¶æ€ç ï¼Œå¯ä»¥æ˜¯æ•´æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯å­—ç¬¦ä¸²
*   headersï¼š å“åº”çš„å¤´éƒ¨ï¼Œå¯ä»¥æ˜¯ä¸ªåˆ—è¡¨ï¼Œä¹Ÿå¯ä»¥æ˜¯ `werkzeug.datastructures.Headers` å¯¹è±¡
*   mimetypeï¼š mimetype ç±»å‹ï¼Œå‘Šè¯‰å®¢æˆ·ç«¯å“åº” body çš„æ ¼å¼ï¼Œé»˜è®¤æ˜¯æ–‡æœ¬æ ¼å¼
*   content\_type: å“åº”å¤´éƒ¨çš„ `Content-Type` å†…å®¹

æ‰€æœ‰è¿™äº›å‚æ•°éƒ½æ˜¯å¯é€‰çš„ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šç”Ÿæˆä¸€ä¸ªçŠ¶æ€ç ä¸º 200ï¼Œæ²¡æœ‰ä»»ä½• body çš„å“åº”ã€‚statusã€status\_code ä½œä¸º `Response` çš„å±æ€§ï¼Œå¯ä»¥ç›´æ¥è¯»å–å’Œä¿®æ”¹ã€‚body æ•°æ®åœ¨å†…éƒ¨ä¿å­˜ä¸º iterable çš„ç±»å‹ï¼Œ
ä½†æ˜¯å¯¹å¤–ä¹Ÿæä¾›äº†ç›´æ¥è¯»å†™çš„æ¥å£ `self.data`ï¼š
```python
        def get_data(self, as_text=False):
            """The string representation of the request body.  Whenever you call
            this property the request iterable is encoded and flattened.
            """
            self._ensure_sequence()
            rv = b''.join(self.iter_encoded())
            if as_text:
                rv = rv.decode(self.charset)
            return rv

        def set_data(self, value):
            """Sets a new string as response.  The value set must either by a
            unicode or bytestring.
            """
            if isinstance(value, text_type):
                value = value.encode(self.charset)
            else:
                value = bytes(value)
            self.response = [value]
            if self.automatically_set_content_length:
                self.headers['Content-Length'] = str(len(value))

        data = property(get_data, set_data, doc='''
            A descriptor that calls :meth:`get_data` and :meth:`set_data`.  This
            should not be used and will eventually get deprecated.
            ''')
```

body å­—ç¬¦çš„ç¼–ç å’Œé•¿åº¦éƒ½æ˜¯è‡ªåŠ¨è®¾ç½®çš„ï¼Œç”¨æˆ·ä¸éœ€è¦æ‰‹åŠ¨å¤„ç†ã€‚

è‡³äºå¤´éƒ¨çš„å­˜å‚¨ï¼Œwerkzeug ä½¿ç”¨çš„æ˜¯ç±»ä¼¼äºå­—å…¸çš„ `werkzeug.datastructures:Headers` ç±»ã€‚åœ¨[Flask æºç è§£æï¼šè¯·æ±‚](https://cizixs.com/2017/01/18/flask-insight-request)è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰è¯¦ç»†
è§£é‡Šå¤´éƒ¨çš„å­˜å‚¨ï¼Œé‚£ä¹ˆè¿™ç¯‡æ–‡ç« å°±å…·ä½“åˆ†æä¸€ä¸‹å§ã€‚

`Headers` è¿™ä¸ªç±»çš„æä¾›äº†å¾ˆå¤šå’Œå­—å…¸ç›¸åŒçš„æ¥å£ï¼škeysã€valuesã€itermsï¼Œä½†æ˜¯å’Œå­—å…¸çš„åŒºåˆ«åœ¨äºå®ƒä¿å­˜çš„å€¼æ˜¯æœ‰åºçš„ï¼Œè€Œä¸”å…è®¸ç›¸åŒ key çš„å€¼å­˜åœ¨ã€‚
ä¸ºä»€ä¹ˆè¿™ä¹ˆè®¾è®¡å‘¢ï¼Ÿå› ä¸ºç€æ›´ç¬¦åˆ HTTP å¤´éƒ¨çš„ç‰¹æ€§ã€‚å…ˆæ¥çœ‹çœ‹æœ‰åºï¼Œåœ¨ HTTP ä¼ é€çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå¤´éƒ¨å„ä¸ª key-value é”®å€¼å¯¹é¡ºåºå‘ç”Ÿå˜åŒ–ï¼Œæœ‰äº›ä»£ç†æˆ–è€…å®¢æˆ·ç«¯ç­‰ç»„ä»¶ä¼šè®¤ä¸ºè¯·æ±‚è¢«ç¯¡æ”¹è€Œä¸¢å¼ƒæˆ–è€…æ‹’ç»è¯·æ±‚çš„å¤„ç†ï¼Œæ‰€ä»¥æœ€å¥½æŠŠå¤´éƒ¨è®¾ç½®ä¸ºæœ‰åºçš„ï¼Œç”¨æˆ·æŒ‰ç…§ä»€ä¹ˆé¡ºåºè®¾ç½®çš„ï¼Œå°±æŒ‰ç…§ä»€ä¹ˆé¡ºåºå­˜å‚¨ï¼›å†è¯´è¯´ç›¸åŒ key çš„é—®é¢˜ï¼Œè¿™æ˜¯å› ä¸º HTTP å¤´éƒ¨åŒä¸€ä¸ª key å¯èƒ½æœ‰å¤šä¸ª valueï¼ˆæ¯”å¦‚ Acceptã€SetCookie å¤´éƒ¨ï¼‰ã€‚é‚£ä¹ˆè¿™ä¸ªçœ‹èµ·æ¯”è¾ƒç‰¹æ®Šçš„å­—å…¸æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿæ¥çœ‹ä»£ç ï¼š
```python
    class Headers(object):
        """An object that stores some headers.  It has a dict-like interface
        but is ordered and can store the same keys multiple times.
        """

        def __init__(self, defaults=None):
            self._list = []
            if defaults is not None:
                if isinstance(defaults, (list, Headers)):
                    self._list.extend(defaults)
                else:
                    self.extend(defaults)

        def __getitem__(self, key, _get_mode=False):
            if not _get_mode:
                if isinstance(key, integer_types):
                    return self._list[key]
                elif isinstance(key, slice):
                    return self.__class__(self._list[key])
            if not isinstance(key, string_types):
                raise exceptions.BadRequestKeyError(key)
            ikey = key.lower()
            for k, v in self._list:
                if k.lower() == ikey:
                    return v
            if _get_mode:
                raise KeyError()
            raise exceptions.BadRequestKeyError(key)
```

å¯ä»¥çœ‹åˆ°ï¼Œå¤´éƒ¨ä¿¡æ¯åœ¨å†…éƒ¨å­˜å‚¨ä¸ºäºŒå…ƒç»„æ„æˆçš„åˆ—è¡¨ï¼Œè¿™æ ·å°±èƒ½åŒæ—¶ä¿è¯å®ƒçš„æœ‰åºæ€§å’Œé‡å¤æ€§ã€‚ä¸€ä¸ªæ ¸å¿ƒçš„æ–¹æ³•æ˜¯ `__getitem__`ï¼Œå®ƒå®šä¹‰äº†å¦‚ä½•è·å–å¤´éƒ¨ä¸­çš„ä¿¡æ¯ï¼š

*   é€šè¿‡ä¸‹æ ‡ `header[3]`ï¼Œç›´æ¥è¿”å›å¯¹åº”æœªçŸ¥å­˜å‚¨çš„é”®å€¼å¯¹å…ƒç»„
*   é€šè¿‡ keyï¼Œè¿”å› value `header['Accept']`ï¼Œè¿”å›åŒ¹é…çš„ç¬¬ä¸€ä¸ª value å€¼
*   é€šè¿‡ slice `header[3:7]`ï¼Œè¿”å›å¦å¤–ä¸€ä¸ª `Headers` å¯¹è±¡ï¼Œä¿å­˜äº† slice ä¸­æ‰€æœ‰çš„æ•°æ®

ç„¶åå®ç° `keys()`ã€`items()`ã€`pop()`ã€`setdefault()` ç­‰æ–¹æ³•è®©å®ƒè¡¨ç°å‡ºæ¥å­—å…¸çš„ç‰¹æ€§ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰ `add()`ã€`extend()`ã€`add_header()` ç­‰å’Œå­—å…¸æ— å…³çš„æ–¹æ³•æ–¹ä¾¿æ“ä½œã€‚

## è‡ªå®šä¹‰ response

å¦‚æœéœ€è¦æ‰©å±• flask `Response` çš„åŠŸèƒ½ï¼Œæˆ–è€…å¹²è„†æŠŠå®ƒæ›¿æ¢æ‰ï¼Œåªè¦ä¿®æ”¹ flask app çš„ `response_class` å±æ€§å°±å¯ä»¥äº†ï¼Œæ¯”å¦‚ï¼š
```python
    from flask import Flask, Response

    class MyResponse(Response):
        pass

    app = Flask(__name__)
    app.response_class = MyResponse

```
æ›´å¤šå¯èƒ½çš„ç”¨æ³•ï¼Œå¯ä»¥å‚è€ƒæ–‡ç« æœ«å°¾çš„å‚è€ƒèµ„æ–™ã€‚

## å‚è€ƒèµ„æ–™

*   [customizing the flask response class](https://blog.miguelgrinberg.com/post/customizing-the-flask-response-class)