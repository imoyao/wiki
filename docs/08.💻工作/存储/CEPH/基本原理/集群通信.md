---
title: é›†ç¾¤é€šä¿¡

categories: 
  - ğŸ’» å·¥ä½œ
  - å­˜å‚¨
  - CEPH
  - åŸºæœ¬åŸç†
date: 2020-05-23 11:02:28
tags: null
permalink: /pages/78029d/
---

# 1. Ceph é€šä¿¡æ¡†æ¶
## 1.1 Ceph é€šä¿¡æ¡†æ¶ç§ç±»ä»‹ç»
**ç½‘ç»œé€šä¿¡æ¡†æ¶ä¸‰ç§ä¸åŒçš„å®ç°æ–¹å¼ï¼š**
 - Simple çº¿ç¨‹æ¨¡å¼
    ç‰¹ç‚¹ï¼šæ¯ä¸€ä¸ªç½‘ç»œé“¾æ¥ï¼Œéƒ½ä¼šåˆ›å»ºä¸¤ä¸ªçº¿ç¨‹ï¼Œä¸€ä¸ªç”¨äºæ¥æ”¶ï¼Œä¸€ä¸ªç”¨äºå‘é€ã€‚
    ç¼ºç‚¹ï¼šå¤§é‡çš„é“¾æ¥ä¼šäº§ç”Ÿå¤§é‡çš„çº¿ç¨‹ï¼Œä¼šæ¶ˆè€— CPU èµ„æºï¼Œå½±å“æ€§èƒ½ã€‚
 - Async äº‹ä»¶çš„ I/O å¤šè·¯å¤ç”¨æ¨¡å¼
    ç‰¹ç‚¹ï¼šè¿™ç§æ˜¯ç›®å‰ç½‘ç»œé€šä¿¡ä¸­å¹¿æ³›é‡‡ç”¨çš„æ–¹å¼ã€‚k ç‰ˆé»˜è®¤å·²ç»ä½¿ç”¨ Asnyc äº†ã€‚
 - XIO æ–¹å¼ä½¿ç”¨äº†å¼€æºçš„ç½‘ç»œé€šä¿¡åº“ accelio æ¥å®ç°
    ç‰¹ç‚¹ï¼šè¿™ç§æ–¹å¼éœ€è¦ä¾èµ–ç¬¬ä¸‰æ–¹çš„åº“ accelio ç¨³å®šæ€§ï¼Œç›®å‰å¤„äºè¯•éªŒé˜¶æ®µã€‚

## 1.2 Ceph é€šä¿¡æ¡†æ¶è®¾è®¡æ¨¡å¼
**è®¾è®¡æ¨¡å¼(Subscribe/Publish)ï¼š**
è®¢é˜…å‘å¸ƒæ¨¡å¼åˆåè§‚å¯Ÿè€…æ¨¡å¼ï¼Œå®ƒæ„å›¾æ˜¯â€œå®šä¹‰å¯¹è±¡é—´çš„ä¸€ç§ä¸€å¯¹å¤šçš„ä¾èµ–å…³ç³»ï¼Œ
å½“ä¸€ä¸ªå¯¹è±¡çš„çŠ¶æ€å‘ç”Ÿæ”¹å˜æ—¶ï¼Œæ‰€æœ‰ä¾èµ–äºå®ƒçš„å¯¹è±¡éƒ½å¾—åˆ°é€šçŸ¥å¹¶è¢«è‡ªåŠ¨æ›´æ–°â€ã€‚

## 1.3 Ceph é€šä¿¡æ¡†æ¶æµç¨‹å›¾
![ceph_message.png](https://upload-images.jianshu.io/upload_images/2099201-8662667e6a06e931.png)

**æ­¥éª¤ï¼š**
 - Accepter ç›‘å¬ peer çš„è¯·æ±‚, è°ƒç”¨ SimpleMessenger::add_accept_pipe() åˆ›å»ºæ–°çš„ Pipe åˆ° SimpleMessenger::pipes æ¥å¤„ç†è¯¥è¯·æ±‚ã€‚
 - Pipe ç”¨äºæ¶ˆæ¯çš„è¯»å–å’Œå‘é€ã€‚è¯¥ç±»ä¸»è¦æœ‰ä¸¤ä¸ªç»„ä»¶ï¼ŒPipe::Readerï¼ŒPipe::Writer ç”¨æ¥å¤„ç†æ¶ˆæ¯è¯»å–å’Œå‘é€ã€‚
 - Messenger ä½œä¸ºæ¶ˆæ¯çš„å‘å¸ƒè€…, å„ä¸ª Dispatcher å­ç±»ä½œä¸ºæ¶ˆæ¯çš„è®¢é˜…è€…, Messenger æ”¶åˆ°æ¶ˆæ¯ä¹‹åï¼Œ  é€šè¿‡ Pipe è¯»å–æ¶ˆæ¯ï¼Œç„¶åè½¬ç»™ Dispatcher å¤„ç†ã€‚
 - Dispatcher æ˜¯è®¢é˜…è€…çš„åŸºç±»ï¼Œå…·ä½“çš„è®¢é˜…åç«¯ç»§æ‰¿è¯¥ç±»,åˆå§‹åŒ–çš„æ—¶å€™é€šè¿‡ Messenger::add_dispatcher_tail/head æ³¨å†Œåˆ° Messenger::dispatchers. æ”¶åˆ°æ¶ˆæ¯åï¼Œé€šçŸ¥è¯¥ç±»å¤„ç†ã€‚
 - DispatchQueue è¯¥ç±»ç”¨æ¥ç¼“å­˜æ”¶åˆ°çš„æ¶ˆæ¯, ç„¶åå”¤é†’ DispatchQueue::dispatch_thread çº¿ç¨‹æ‰¾åˆ°åç«¯çš„ Dispatch å¤„ç†æ¶ˆæ¯ã€‚

![ceph_message_2.png](https://upload-images.jianshu.io/upload_images/2099201-f7e6ef5c9d3fe38f.png)


## 1.4 Ceph é€šä¿¡æ¡†æ¶ç±»å›¾
![ceph_message_3.png](https://upload-images.jianshu.io/upload_images/2099201-a7d2248cb9963f1d.png)

## 1.5 Ceph é€šä¿¡æ•°æ®æ ¼å¼
é€šä¿¡åè®®æ ¼å¼éœ€è¦åŒæ–¹çº¦å®šæ•°æ®æ ¼å¼ã€‚

**æ¶ˆæ¯çš„å†…å®¹ä¸»è¦åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š**
 - header              //æ¶ˆæ¯å¤´ï¼Œç±»å‹æ¶ˆæ¯çš„ä¿¡å°
 - user data          //éœ€è¦å‘é€çš„å®é™…æ•°æ®
   - payload     //æ“ä½œä¿å­˜å…ƒæ•°æ®
   - middle      //é¢„ç•™å­—æ®µ
   - data          //è¯»å†™æ•°æ®
 - footer             //æ¶ˆæ¯çš„ç»“æŸæ ‡è®°
```plain
class Message : public RefCountedObject {
protected:
  ceph_msg_header  header;      // æ¶ˆæ¯å¤´
  ceph_msg_footer  footer;		// æ¶ˆæ¯å°¾
  bufferlist       payload;  // "front" unaligned blob
  bufferlist       middle;   // "middle" unaligned blob
  bufferlist       data;     // data payload (page-alignment will be preserved where possible)

  /* recv_stamp is set when the Messenger starts reading the
   * Message off the wire */
  utime_t recv_stamp;		//å¼€å§‹æ¥æ”¶æ•°æ®çš„æ—¶é—´æˆ³
  /* dispatch_stamp is set when the Messenger starts calling dispatch() on
   * its endpoints */
  utime_t dispatch_stamp;	//dispatch çš„æ—¶é—´æˆ³
  /* throttle_stamp is the point at which we got throttle */
  utime_t throttle_stamp;	//è·å–throttle çš„slotçš„æ—¶é—´æˆ³
  /* time at which message was fully read */
  utime_t recv_complete_stamp;	//æ¥æ”¶å®Œæˆçš„æ—¶é—´æˆ³

  ConnectionRef connection;		//ç½‘ç»œè¿æ¥

  uint32_t magic = 0;			//æ¶ˆæ¯çš„é­”æœ¯å­—

  bi::list_member_hook<> dispatch_q;	//boost::intrusive æˆå‘˜å­—æ®µ
};

struct ceph_msg_header {
	__le64 seq;       // å½“å‰sessionå†… æ¶ˆæ¯çš„å”¯ä¸€ åºå·
	__le64 tid;       // æ¶ˆæ¯çš„å…¨å±€å”¯ä¸€çš„ id
	__le16 type;      // æ¶ˆæ¯ç±»å‹
	__le16 priority;  // ä¼˜å…ˆçº§
	__le16 version;   // ç‰ˆæœ¬å·

	__le32 front_len; // payload çš„é•¿åº¦
	__le32 middle_len;// middle çš„é•¿åº¦
	__le32 data_len;  // data çš„ é•¿åº¦
	__le16 data_off;  // å¯¹è±¡çš„æ•°æ®åç§»é‡


	struct ceph_entity_name src; //æ¶ˆæ¯æº

	/* oldest code we think can decode this.  unknown if zero. */
	__le16 compat_version;
	__le16 reserved;
	__le32 crc;       /* header crc32c */
} __attribute__ ((packed));

struct ceph_msg_footer {
	__le32 front_crc, middle_crc, data_crc; //crcæ ¡éªŒç 
	__le64  sig; //æ¶ˆæ¯çš„64ä½signature
	__u8 flags; //ç»“æŸæ ‡å¿—
} __attribute__ ((packed));
```
