---
title: Metadata damage detected

categories: 
  - ğŸ’» å·¥ä½œ
  - å­˜å‚¨
  - CEPH
  - troubleshooting
date: 2020-05-23 11:02:28
tags: null
permalink: /pages/36584d/
---

## 1. æ•…éšœç°åœº

- é€šè¿‡ç›‘æ§å‘ç°é›†ç¾¤çŠ¶æ€æ˜¯ HEALTH_ERR çŠ¶æ€ï¼Œ å¹¶ä¸”å‘ç° mds0: Metadata damage detectedã€‚ é¡¾åæ€ä¹‰ï¼ŒçŒœæµ‹åº”è¯¥æ˜¯å…ƒä¿¡æ¯æŸåå¯¼è‡´çš„ã€‚ [![image.png](https://camo.githubusercontent.com/6286efebac7a7dacb10f8a3021fee6ca0c8bfc1d/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d333061626636643437623963666164662e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/6286efebac7a7dacb10f8a3021fee6ca0c8bfc1d/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d333061626636643437623963666164662e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

## 2. åˆ†æ damage æ˜¯å•¥åŸå› å¯¼è‡´

[![image.png](https://camo.githubusercontent.com/55edd8da7d9df5deeb29bae5aadb63ca766ab3fc/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d383661383263353665393663623363622e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/55edd8da7d9df5deeb29bae5aadb63ca766ab3fc/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d383661383263353665393663623363622e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

**å¤§æ¦‚æ„æ€æ˜¯ï¼š**

- ä»å…ƒæ•°æ®å­˜å‚¨æ± è¯»å–æ—¶ï¼Œé‡åˆ°äº†å…ƒæ•°æ®æŸåæˆ–ä¸¢å¤±çš„æƒ…å†µã€‚è¿™æ¡æ¶ˆæ¯è¡¨æ˜æŸåä¹‹å¤„å·²ç»è¢«å¦¥å–„éš”ç¦»äº†ï¼Œä»¥ä½¿ MDS ç»§ç»­è¿ä½œï¼Œå¦‚æ­¤ä¸€æ¥ï¼Œè‹¥æœ‰å®¢æˆ·ç«¯è®¿é—®æŸåçš„å­æ ‘å°±è¿”å› IO é”™è¯¯ã€‚å…³äºæŸåçš„ç»†èŠ‚ä¿¡æ¯å¯ç”¨ damage ls ç®¡ç†å¥—æ¥å­—å‘½ä»¤è·å–ã€‚åªè¦ä¸€é‡åˆ°å—æŸå…ƒæ•°æ®ï¼Œæ­¤æ¶ˆæ¯å°±ä¼šç«‹å³å‡ºç°ã€‚

## 3. æŸ¥çœ‹ damage ls

- é€šè¿‡æŒ‡ä»¤æŸ¥è¯¢åˆ° damage ls æ˜¾ç¤ºçš„ä¿¡æ¯ï¼Œå¯ä»¥å‘ç°é‡Œé¢æœ‰ä¸ª ino ç¼–å·ã€‚ [![image.png](https://camo.githubusercontent.com/0a3af6ec4e95cc210f5918d63e61bf274d6548f2/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d666662366162643732613862333138312e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/0a3af6ec4e95cc210f5918d63e61bf274d6548f2/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d666662366162643732613862333138312e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

## 4. é€šè¿‡è½¬æ¢æ‹¿åˆ°åå…­è¿›åˆ¶ ino

- é€šè¿‡ ino:1099519182934 -> ino: 10000734856 [![image.png](https://camo.githubusercontent.com/9ee23173b4514b1b5aef411ac3b309119f3fbc88/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d323535393532393566383065396534632e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/9ee23173b4514b1b5aef411ac3b309119f3fbc88/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d323535393532393566383065396534632e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

## 5. æ£€æŸ¥æ˜¯å¦å±äºç›®å½•(10000734856)

- é€šè¿‡æŒ‡ä»¤æŸ¥æ‰¾å‘ç°è¯¥ ino ç¡®å®šæ˜¯ç›®å½• [![image.png](https://camo.githubusercontent.com/5db8b7eb6f7530e7fe736922e947410ecfe32746/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d303039306538663131323734326533332e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/5db8b7eb6f7530e7fe736922e947410ecfe32746/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d303039306538663131323734326533332e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

## 6. ç¡®å®šç›®å½•å

[![image.png](https://camo.githubusercontent.com/81f9c6ba9062737fdba1871dd82437cdc3178d9a/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d313036396335623139383732313766662e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/81f9c6ba9062737fdba1871dd82437cdc3178d9a/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d313036396335623139383732313766662e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

## 7. è¯¥ç›®å½•ä¸‹é¢çš„æ‰€æœ‰æ–‡ä»¶

[![image.png](https://camo.githubusercontent.com/d33ad51dd15e5361720b312a55ab1f24992524cd/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d383865653336613335343733393561362e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/d33ad51dd15e5361720b312a55ab1f24992524cd/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d383865653336613335343733393561362e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

## 8. æŸ¥çœ‹ fs æŒ‚è½½çš„ç›®å½•æ˜¯å¦åŒ¹é…

```plain
ceph fs ls -f json-pretty
```

## 9. ä¿®å¤è¿™ä¸ªç›®å½•å…ƒä¿¡æ¯

```plain
ceph --admin-daemon /var/run/ceph/ceph-mds.00.asok  scrub_path /dir repair
```

[![image.png](https://camo.githubusercontent.com/501c2e06738e8814047da61a5d39b6c90cb7150e/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d313564346135613264373736646162622e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/501c2e06738e8814047da61a5d39b6c90cb7150e/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d313564346135613264373736646162622e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

## 10. è·Ÿè¸ªä»£ç 

**å‚è€ƒæ–‡ä»¶ï¼š**

- https://github.com/ceph/ceph/blob/5cdf9c3380098f5d2b1d988ab623c74baad55ee3/src/mds/MDSRank.cc#L2245
- https://github.com/ceph/ceph/blob/5cdf9c3380098f5d2b1d988ab623c74baad55ee3/src/mds/MDCache.cc#L12197

[![image.png](https://camo.githubusercontent.com/8dc0db0c416cf04adb7061a21d6225a848ed66d3/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d363337363639376438323438623730662e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/8dc0db0c416cf04adb7061a21d6225a848ed66d3/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d363337363639376438323438623730662e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)[![image.png](https://camo.githubusercontent.com/229338421b416e79bfec5195b63f96a45ed43466/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d363135383061623662323839326231632e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/229338421b416e79bfec5195b63f96a45ed43466/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d363135383061623662323839326231632e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

## 11. æ€»ç»“

### 11.1 é—®é¢˜è¿‡ç¨‹å›é¡¾

- é›†ç¾¤ ERR
- å‘ç° mds0: Metadata damage detected
- æŸ¥çœ‹ damage ino
- æ ¹æ® ino å®šä½è·Ÿè¸ªç›®å½•
- æ ¹æ®ç›®å½•åçŸ¥é“ä¸šåŠ¡å­˜å‚¨çš„æ•°æ®
- ä¿®å¤é—®é¢˜

## 12. ä¿®å¤æ–¹æ¡ˆ

### 12.1 æ–¹æ¡ˆä¸€ï¼šåˆ é™¤ ino å¯¹åº”çš„ç›®å½•ï¼ˆç”Ÿäº§ç¯å¢ƒå®æˆ˜æ¼”ç»ƒè¿‡)

1.ä¸šåŠ¡æ–¹å¤‡ä»½è¿ç§»æ•°æ® 2.æŸ¥çœ‹ damage ls [![image.png](https://camo.githubusercontent.com/dde5bafa1f821a9cbef87395bc3c2f25476eba77/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d366636613063663339643934613764392e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/dde5bafa1f821a9cbef87395bc3c2f25476eba77/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d366636613063663339643934613764392e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)3.æ£€æŸ¥è¯¥ ino ç¡®å®æ²¡æœ‰å¯¹åº”çš„ç›®å½• [![image.png](https://camo.githubusercontent.com/6567b413826a8283e6bd473256330d5c42d424d5/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d623630353038346431303361363665612e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/6567b413826a8283e6bd473256330d5c42d424d5/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d623630353038346431303361363665612e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)4.åˆ é™¤ damage rm ä¿¡æ¯ [![image.png](https://camo.githubusercontent.com/3324fe445f707cc79502082a0b74df8738f6a2f8/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d613266653464346531613533353031662e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/3324fe445f707cc79502082a0b74df8738f6a2f8/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d613266653464346531613533353031662e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

5.æ£€æŸ¥é›†ç¾¤çŠ¶æ€(é›†ç¾¤çŠ¶æ€ä» ERR æ¢å¤åˆ° WARN) [![image.png](https://camo.githubusercontent.com/a8ba2173f5880e0ee8a5aac5511219a3a79b52de/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d653064323435643835653635373339362e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)](https://camo.githubusercontent.com/a8ba2173f5880e0ee8a5aac5511219a3a79b52de/68747470733a2f2f75706c6f61642d696d616765732e6a69616e7368752e696f2f75706c6f61645f696d616765732f323039393230312d653064323435643835653635373339362e706e673f696d6167654d6f6772322f6175746f2d6f7269656e742f7374726970253743696d61676556696577322f322f772f31323430)

### 12.2 æ–¹æ¡ˆäºŒï¼šä¿®å¤è¯¥ç›®å½•å…ƒä¿¡æ¯

1.é€šè¿‡æŒ‡ä»¤ä¿®å¤ç›®å½•

```plain
ceph --admin-daemon /var/run/ceph/ceph-mds.ceph-newpublic-osd02.py.asok scrub_path /dir/xxx repair
```
