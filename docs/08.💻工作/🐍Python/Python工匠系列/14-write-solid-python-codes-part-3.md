---
title: Python å·¥åŒ ï¼šå†™å¥½é¢å‘å¯¹è±¡ä»£ç çš„åŸåˆ™ï¼ˆä¸‹ï¼‰

tags: 
  - ç¼–ç¨‹
  - Python
  - é¢å‘å¯¹è±¡
categories: 
  - ğŸ’» å·¥ä½œ
  - ğŸPython
  - Python å·¥åŒ ç³»åˆ—
date: 2020-08-13 18:34:46
permalink: /pages/5871c5/
---
## å‰è¨€

> è¿™æ˜¯ â€œPython å·¥åŒ â€ç³»åˆ—çš„ç¬¬ 14 ç¯‡æ–‡ç« ã€‚[[æŸ¥çœ‹ç³»åˆ—æ‰€æœ‰æ–‡ç« ]](https://github.com/piglei/one-python-craftsman)


<div style="text-align: center; color: #999; margin: 14px 0 14px;font-size: 12px;">
<img src="https://www.zlovezl.cn/static/uploaded/2020/02/carolina-garcia-tavizon-w1280.jpg" width="100%" />
</div>
 
åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†ç»§ç»­ä»‹ç» SOLID åŸåˆ™å‰©ä¸‹çš„ä¸¤ä½æˆå‘˜ï¼š**Iï¼ˆæ¥å£éš”ç¦»åŸåˆ™ï¼‰** å’Œ **Dï¼ˆä¾èµ–å€’ç½®åŸåˆ™ï¼‰**ã€‚ä¸ºäº†æ–¹ä¾¿ï¼Œè¿™ç¯‡æ–‡ç« å°†ä¼šä½¿ç”¨å…ˆ D å I çš„é¡ºåºã€‚

## Dï¼šä¾èµ–å€’ç½®åŸåˆ™

è½¯ä»¶æ˜¯ç”±ä¸€ä¸ªä¸ªæ¨¡å—ç»„åˆè€Œæˆçš„ã€‚å½“ä½ è·Ÿåˆ«äººè¯´ï¼š*â€œæˆ‘åœ¨å†™ä¸€ä¸ªå¾ˆå¤æ‚çš„è½¯ä»¶â€*ï¼Œå…¶å®ä½ å¹¶ä¸æ˜¯ç›´æ¥åœ¨å†™é‚£ä¸ªè½¯ä»¶ï¼Œä½ åªæ˜¯åœ¨ç¼–å†™å®ƒçš„ä¸€ä¸ªä¸ªæ¨¡å—ï¼Œæœ€åæŠŠå®ƒä»¬æ”¾åœ¨ä¸€èµ·ç»„åˆæˆä½ çš„è½¯ä»¶ã€‚

æœ‰äº†æ¨¡å—ï¼Œæ¨¡å—é—´è‡ªç„¶å°±æœ‰äº†ä¾èµ–å…³ç³»ã€‚æ¯”å¦‚ï¼Œä½ çš„ä¸ªäººåšå®¢å¯èƒ½ä¾èµ–ç€ Flask æ¡†æ¶ï¼Œè€Œ Flask åˆä¾èµ–äº† Werkzeugï¼ŒWerkzeug åˆç”±æ›´å¤šä¸ªä½å±‚æ¨¡å—ç»„æˆã€‚

ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDependency Inversion Principleï¼‰å°±æ˜¯ä¸€æ¡å’Œä¾èµ–å…³ç³»ç›¸å…³çš„åŸåˆ™ã€‚å®ƒè®¤ä¸ºï¼š**â€œé«˜å±‚æ¨¡å—ä¸åº”è¯¥ä¾èµ–äºä½å±‚æ¨¡å—ï¼ŒäºŒè€…éƒ½åº”è¯¥ä¾èµ–äºæŠ½è±¡ã€‚â€**

> High-level modules should not depend on low-level modules. Both should depend on abstractions.

è¿™ä¸ªåŸåˆ™çœ‹ä¸Šå»æœ‰ç‚¹åç›´è§‰ã€‚æ¯•ç«Ÿï¼Œåœ¨æˆ‘ä»¬çš„ç¬¬ä¸€å ‚ç¼–ç¨‹è¯¾ä¸Šï¼Œè€å¸ˆå°±æ˜¯è¿™ä¹ˆæ•™æˆ‘ä»¬å†™ä»£ç çš„ï¼š*â€œé«˜å±‚æ¨¡å—è¦ä¾èµ–ä½å±‚æ¨¡å—ï¼Œhello world ç¨‹åºä¾èµ– printf()ã€‚â€*é‚£ä¸ºä»€ä¹ˆè¿™æ¡åŸåˆ™åˆè¯´ä¸è¦è¿™æ ·åšå‘¢ï¼Ÿè€Œä¾èµ–å€’ç½®åŸåˆ™é‡Œçš„â€œå€’ç½®â€åˆæ˜¯æŒ‡ä»€ä¹ˆï¼Ÿ

è®©æˆ‘ä»¬å…ˆæŠŠè¿™äº›é—®é¢˜æ”¾åœ¨ä¸€è¾¹ï¼Œçœ‹çœ‹ä¸‹é¢è¿™ä¸ªå°éœ€æ±‚ã€‚ä¸Šé¢è¿™äº›é—®é¢˜çš„ç­”æ¡ˆéƒ½è—åœ¨è¿™ä¸ªéœ€æ±‚ä¸­ã€‚

### éœ€æ±‚ï¼šæŒ‰åŸŸååˆ†ç»„ç»Ÿè®¡ HN æ–°é—»æ•°é‡

è¿™æ¬¡å‡ºåœºçš„è¿˜æ˜¯æˆ‘ä»¬çš„è€æœ‹å‹ï¼šæ–°é—»ç«™ç‚¹ [Hacker News](https://news.ycombinator.com/)ã€‚åœ¨ HN ä¸Šï¼Œæ¯ä¸ªç”¨æˆ·æäº¤çš„æ¡ç›®æ ‡é¢˜åé¢ï¼Œéƒ½è·Ÿç€è¿™æ¡å†…å®¹çš„æ¥æºåŸŸåã€‚

æˆ‘æƒ³è¦æŒ‰ç…§æ¥æºåŸŸåæ¥åˆ†ç»„ç»Ÿè®¡æ¡ç›®æ•°é‡ï¼Œè¿™æ ·å°±èƒ½çŸ¥é“å“ªä¸ªç«™åœ¨ HN ä¸Šæœ€å—æ¬¢è¿ã€‚

<div style="text-align: center; color: #999; margin: 14px 0 14px;font-size: 12px;">
<img src="https://www.zlovezl.cn/static/uploaded/2020/02/SOLID_3_hn.jpg" width="100%" />
å›¾ï¼šHacker News æ¡ç›®æ¥æºæˆªå›¾
</div>

è¿™ä¸ªéœ€æ±‚éå¸¸ç®€å•ï¼Œä½¿ç”¨ `requests`ã€`lxml` æ¨¡å—å¯ä»¥å¾ˆå¿«å®Œæˆä»»åŠ¡ï¼š

```python
# file: hn_site_grouper.py
import requests
from lxml import etree
from typing import Dict
from collections import Counter


class SiteSourceGrouper:
    """å¯¹ HN é¡µé¢çš„æ–°é—»æ¥æºç«™ç‚¹è¿›è¡Œåˆ†ç»„ç»Ÿè®¡
    """
    def __init__(self, url: str):
        self.url = url

    def get_groups(self) -> Dict[str, int]:
        """è·å– (åŸŸå, ä¸ªæ•°) åˆ†ç»„
        """
        resp = requests.get(self.url)
        html = etree.HTML(resp.text)
        # é€šè¿‡ xpath è¯­æ³•ç­›é€‰æ–°é—»åŸŸåæ ‡ç­¾
        elems = html.xpath('//table[@class="itemlist"]//span[@class="sitestr"]')

        groups = Counter()
        for elem in elems:
            groups.update([elem.text])
        return groups


def main():
    groups = SiteSourceGrouper("https://news.ycombinator.com/").get_groups()
    # æ‰“å°æœ€å¸¸è§çš„ 3 ä¸ªåŸŸå
    for key, value in groups.most_common(3):
        print(f'Site: {key} | Count: {value}')


if __name__ == '__main__':
    main()
```

ä»£ç æ‰§è¡Œç»“æœï¼š

```bash
â¯ python hn_sitestr_grouper.py
Site: github.com | Count: 2
Site: howonlee.github.io | Count: 1
Site: latimes.com | Count: 1
```

è¿™æ®µä»£ç å¾ˆçŸ­ï¼Œæ ¸å¿ƒä»£ç æ€»å…±ä¸åˆ° 20 è¡Œã€‚ç°åœ¨ï¼Œè®©æˆ‘ä»¬æ¥ç†ä¸€ç†å®ƒé‡Œé¢çš„ä¾èµ–å…³ç³»ã€‚

`SiteSourceGrouper` æ˜¯æˆ‘ä»¬çš„æ ¸å¿ƒç±»ã€‚ä¸ºäº†å®Œæˆä»»åŠ¡ï¼Œå®ƒéœ€è¦ä½¿ç”¨ `requests` æ¨¡å—è·å–é¦–é¡µå†…å®¹ã€`lxml` æ¨¡å—è§£ææ ‡é¢˜ã€‚æ‰€ä»¥ï¼Œç°åœ¨çš„ä¾èµ–å…³ç³»æ˜¯â€œæ­£å‘â€çš„ï¼Œé«˜å±‚æ¨¡å— `SiteSourceGrouper` ä¾èµ–ä½å±‚æ¨¡å— `requests`ã€`lxml`ã€‚

<div style="text-align: center; color: #999; margin: 14px 0 14px;font-size: 12px;">
<img src="https://www.zlovezl.cn/static/uploaded/2020/02/SOLID_D_before.png" width="100%" />
å›¾ï¼šSiteSourceGrouper ä¾èµ– requestsã€lxml
</div>

ä¹Ÿè®¸ç°åœ¨è¿™å¼ å›¾åœ¨ä½ çœ¼é‡Œçœ‹èµ·æ¥ç‰¹åˆ«åˆç†ã€‚æ­£å¸¸çš„ä¾èµ–å…³ç³»ä¸å°±åº”è¯¥æ˜¯è¿™æ ·çš„å—ï¼Ÿåˆ«ç€æ€¥ï¼Œæˆ‘ä»¬è¿˜æ²¡ç»™ä»£ç å†™å•å…ƒæµ‹è¯•å‘¢ã€‚

### ä¸º SiteSourceGrouper ç¼–å†™å•å…ƒæµ‹è¯•

ç°åœ¨è®©æˆ‘æ¥ä¸ºè¿™æ®µä»£ç åŠ ä¸Šå•å…ƒæµ‹è¯•ã€‚é¦–å…ˆè®©æœ€æ™®é€šçš„æƒ…å†µå¼€å§‹ï¼š

```python
from hn_site_grouper import SiteSourceGrouper
from collections import Counter


def test_grouper_returning_valid_types():
    """æµ‹è¯• get_groups æ˜¯å¦è¿”å›äº†æ­£ç¡®ç±»å‹
    """
    grouper = SiteSourceGrouper('https://news.ycombinator.com/')
    result = grouper.get_groups()
    assert isinstance(result, Counter), "groups should be Counter instance"
```

è¿™æ˜¯ä¸€ä¸ªå†ç®€å•ä¸è¿‡çš„å•å…ƒæµ‹è¯•ï¼Œæˆ‘è°ƒç”¨äº† `SiteSourceGrouper.get_groups()` æ–¹æ³•ï¼Œç„¶åç®€å•æ ¡éªŒäº†ä¸€ä¸‹è¿”å›ç»“æœç±»å‹æ˜¯å¦æ­£å¸¸ã€‚

è¿™ä¸ªæµ‹è¯•åœ¨æœ¬åœ°ç”µè„‘ä¸Šæ‰§è¡Œæ—¶æ²¡æœ‰ä¸€ç‚¹é—®é¢˜ï¼Œå¯ä»¥æ­£å¸¸é€šè¿‡ã€‚ä½†å½“æˆ‘åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œè¿™æ®µå•å…ƒæµ‹è¯•ä»£ç æ—¶ï¼Œå´å‘ç°å®ƒæ ¹æœ¬æ²¡åŠæ³•æˆåŠŸã€‚å› ä¸º **æˆ‘çš„æœåŠ¡å™¨ä¸èƒ½è®¿é—®å¤–ç½‘ã€‚**

```python
# è¿è¡Œå•å…ƒæµ‹è¯•æ—¶æç¤ºç½‘ç»œé”™è¯¯
requests.exceptions.ConnectionError: HTTPSConnectionPool(host='news.ycombinator.com', port=443):  ... ... [Errno 8] nodename nor servname provided, or not known'))
```

åˆ°è¿™é‡Œï¼Œå•å…ƒæµ‹è¯•æš´éœ²äº† `SiteSourceGrouper` ç±»çš„ä¸€ä¸ªé—®é¢˜ï¼š*å®ƒçš„æ ¸å¿ƒé€»è¾‘ä¾èµ– requests æ¨¡å—å’Œç½‘ç»œè¿æ¥ï¼Œä¸¥æ ¼é™åˆ¶äº†å•å…ƒæµ‹è¯•çš„æ‰§è¡Œæ¡ä»¶ã€‚*

æ—¢ç„¶å¦‚æ­¤ï¼Œé‚£è¦å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿå¦‚æœä½ å»é—®ä¸€ä¸ªæœ‰ç»éªŒçš„ Python çš„å¼€å‘è€…ï¼Œåæœ‰å…«ä¹ä»–ä¼šç”©ç»™ä½ ä¸€å¥è¯ï¼š**â€œç”¨ mock å•Šï¼â€**

#### ä½¿ç”¨ mock æ¨¡å—

[mock](https://docs.python.org/3/library/unittest.mock.html) æ˜¯ unittest é‡Œçš„ä¸€ä¸ªæ¨¡å—ï¼ŒåŒæ—¶ä¹Ÿæ˜¯ä¸€ç±»æµ‹è¯•æ‰‹æ³•çš„ç»Ÿç§°ã€‚å‡å¦‚ä½ éœ€è¦æµ‹è¯•çš„æ¨¡å—é‡Œæœ‰ä¸€éƒ¨åˆ†ä¾èµ–å¾ˆéš¾è¢«æ»¡è¶³*ï¼ˆæ¯”å¦‚ä»£ç éœ€è¦è®¿é—®ä¸€æ•´å¥— Kubernetes é›†ç¾¤ï¼‰*ï¼Œæˆ–è€…ä½ æƒ³åœ¨æµ‹è¯•æ—¶æ•…æ„æ›¿æ¢æ‰æŸäº›ä¾èµ–ï¼Œé‚£ä¹ˆ mock å°±èƒ½æ´¾ä¸Šç”¨åœºã€‚

åœ¨è¿™ä¸ªä¾‹å­é‡Œï¼Œä½¿ç”¨ unittest.mock æ¨¡å—éœ€è¦åšä¸‹é¢è¿™äº›äº‹æƒ…ï¼š

- æŠŠä¸€ä»½æ­£ç¡®çš„ HN é¡µé¢å†…å®¹ä¿å­˜ä¸ºæœ¬åœ°æ–‡ä»¶ `static_hn.html`
- åœ¨æµ‹è¯•æ–‡ä»¶ä¸­å¯¼å…¥ `unittest.mock` æ¨¡å—
- åœ¨æµ‹è¯•å‡½æ•°ä¸­ï¼Œé€šè¿‡ [`mock.path('requests.get')`](https://docs.python.org/3/library/unittest.mock.html#unittest.mock.patch) æ›¿æ¢ç½‘ç»œè¯·æ±‚éƒ¨åˆ†
- å°†å…¶ä¿®æ”¹ä¸ºç›´æ¥è¿”å›æ–‡ä»¶ `static_hn.html` çš„å†…å®¹

ä½¿ç”¨ mock åçš„ä»£ç çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š

```python
from unittest import mock

def test_grouper_returning_valid_types():
    """æµ‹è¯• get_groups æ˜¯å¦è¿”å›äº†æ­£ç¡®ç±»å‹
    """
    resp = mock.Mock()
    # Mock æ‰ requests.get å‡½æ•°
    with mock.patch('hn_site_grouper.requests.get') as mocked_get:
        mocked_get.return_value = resp
        with open('static_hn.html', 'r') as fp:
            # Mock æ‰å“åº”çš„ text å­—æ®µ
            resp.text = fp.read()

        grouper = SiteSourceGrouper('https://news.ycombinator.com/')
        result = grouper.get_groups()
        assert isinstance(result, Counter), "groups should be Counter instance"
```

ä¸Šé¢çš„ä»£ç å¹¶ä¸ç®—å¤æ‚ã€‚å¯¹äº Python è¿™ç±»åŠ¨æ€è¯­è¨€æ¥è¯´ï¼Œä½¿ç”¨ mock æœ‰ç€ä¸€ç§å¾—å¤©ç‹¬åšçš„ä¼˜åŠ¿ã€‚å› ä¸ºåœ¨ Python é‡Œï¼Œè¿è¡Œæ—¶çš„ä¸€åˆ‡å¯¹è±¡å‡ ä¹éƒ½å¯ä»¥è¢«æ›¿æ¢æ‰ã€‚

ä¸è¿‡è™½ç„¶ mock ç”¨èµ·æ¥å¾ˆæ–¹ä¾¿ï¼Œä½†å®ƒä¸æ˜¯è§£å†³æˆ‘ä»¬é—®é¢˜çš„æœ€ä½³åšæ³•ã€‚å› ä¸º mock åœ¨å¸¦æ¥æ–¹ä¾¿çš„åŒæ—¶ï¼Œä¹Ÿè®©æµ‹è¯•ä»£ç å˜å¾—æ›´å¤æ‚å’Œéš¾ä»¥ç†è§£ã€‚è€Œä¸”ï¼Œç»™æµ‹è¯•åŠ ä¸Š mock ä¹Ÿä»…ä»…åªæ˜¯è®©æˆ‘çš„å•å…ƒæµ‹è¯•èƒ½å¤Ÿè·‘èµ·æ¥ï¼Œç³Ÿç³•è®¾è®¡ä»ç„¶æ˜¯ç³Ÿç³•è®¾è®¡ã€‚å®ƒæ— æ³•ä½“ç°å‡ºå•å…ƒæµ‹è¯•æœ€é‡è¦çš„ä»·å€¼ä¹‹ä¸€ï¼š**â€œé€šè¿‡ç¼–å†™æµ‹è¯•åå‘æ¨åŠ¨è®¾è®¡æ”¹è¿›â€**ã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦åšçš„æ˜¯æ”¹è¿›ä¾èµ–å…³ç³»ï¼Œè€Œä¸åªæ˜¯ç®€å•çš„åœ¨æµ‹è¯•æ—¶æŠŠä¾èµ–æ¨¡å—æ›¿æ¢æ‰ã€‚å¦‚ä½•æ”¹è¿›ä¾èµ–å…³ç³»ï¼Ÿè®©æˆ‘ä»¬çœ‹çœ‹â€œä¾èµ–å€’ç½®â€æ˜¯å¦‚ä½•åšçš„ã€‚

### å®ç°ä¾èµ–å€’ç½®åŸåˆ™

é¦–å…ˆï¼Œè®©æˆ‘ä»¬é‡æ¸©ä¸€ä¸‹â€œä¾èµ–å€’ç½®åŸåˆ™â€*ï¼ˆåç®€ç§° D åŸåˆ™ï¼‰*çš„å†…å®¹ï¼š**â€œé«˜å±‚æ¨¡å—ä¸åº”è¯¥ä¾èµ–äºä½å±‚æ¨¡å—ï¼ŒäºŒè€…éƒ½åº”è¯¥ä¾èµ–äºæŠ½è±¡ã€‚â€**

åœ¨ä¸Šé¢çš„ä»£ç é‡Œï¼Œé«˜å±‚æ¨¡å— `SiteSourceGrouper` å°±ç›´æ¥ä¾èµ–äº†ä½å±‚æ¨¡å— `requests`ã€‚ä¸ºäº†è®©ä»£ç ç¬¦åˆ D åŸåˆ™ï¼Œæˆ‘ä»¬é¦–å…ˆéœ€è¦åˆ›é€ ä¸€ä¸ªå¤„äºäºŒè€…ä¸­é—´çš„æŠ½è±¡ï¼Œç„¶åè®©ä¸¤ä¸ªæ¨¡å—å¯ä»¥éƒ½ä¾èµ–è¿™ä¸ªæ–°çš„æŠ½è±¡å±‚ã€‚

åˆ›å»ºæŠ½è±¡çš„ç¬¬ä¸€æ­¥*ï¼ˆå¯èƒ½ä¹Ÿæ˜¯æœ€é‡è¦çš„ä¸€æ­¥ï¼‰*ï¼Œå°±æ˜¯ç¡®å®šè¿™ä¸ªæŠ½è±¡å±‚çš„èŒè´£ã€‚åœ¨ä¾‹å­ä¸­ï¼Œé«˜å±‚æ¨¡å—ä¸»è¦ä¾èµ– `requests` åšäº†è¿™äº›äº‹ï¼š

- é€šè¿‡ `requests.get()` è·å– response
- é€šè¿‡ `response.text` è·å–å“åº”æ–‡æœ¬

æ‰€ä»¥ï¼Œè¿™ä¸ªæŠ½è±¡å±‚çš„ä¸»è¦èŒè´£å°±æ˜¯äº§ç”Ÿ HN ç«™ç‚¹çš„é¡µé¢æ–‡æœ¬ã€‚æˆ‘ä»¬å¯ä»¥ç»™å®ƒèµ·ä¸ªåå­—ï¼š`HNWebPage`ã€‚

ç¡®å®šäº†æŠ½è±¡å±‚çš„èŒè´£å’Œåå­—åï¼Œæ¥ä¸‹æ¥åº”è¯¥æ€ä¹ˆå®ç°å®ƒå‘¢ï¼Ÿåœ¨ Java æˆ– Go è¯­è¨€é‡Œï¼Œæ ‡å‡†ç­”æ¡ˆæ˜¯å®šä¹‰ **Interface**ï¼ˆæ¥å£ï¼‰ã€‚å› ä¸ºå¯¹äºè¿™äº›ç¼–ç¨‹è¯­è¨€æ¥è¯´ï¼Œâ€œæ¥å£â€è¿™ä¸¤ä¸ªå­—åŸºæœ¬å°±å¯ä»¥ç­‰åŒäºâ€œæŠ½è±¡â€ã€‚

æ‹¿ Go æ¥è¯´ï¼Œâ€œHacker News ç«™ç‚¹é¡µé¢â€è¿™å±‚æŠ½è±¡å°±å¯ä»¥è¢«å®šä¹‰æˆè¿™æ ·çš„ Interfaceï¼š

```go
type HNWebPage interface {
    // GetText è·å–é¡µé¢æ–‡æœ¬
	 GetText() (string, error)
}
```

ä¸è¿‡ï¼ŒPython æ ¹æœ¬æ²¡æœ‰æ¥å£è¿™ç§ä¸œè¥¿ã€‚é‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿè™½ç„¶ Python æ²¡æœ‰æ¥å£ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªéå¸¸ç±»ä¼¼çš„ä¸œè¥¿ï¼š**â€œæŠ½è±¡ç±»ï¼ˆAbstrace Classï¼‰â€**ã€‚ä½¿ç”¨ [`abc`](https://docs.python.org/3/library/abc.html) æ¨¡å—å°±å¯ä»¥è½»æ¾å®šä¹‰å‡ºä¸€ä¸ªæŠ½è±¡ç±»ï¼š

```plain
from abc import ABCMeta, abstractmethod


class HNWebPage(metaclass=ABCMeta):
    """æŠ½è±¡ç±»ï¼šHacker New ç«™ç‚¹é¡µé¢
    """

    @abstractmethod
    def get_text(self) -> str:
        raise NotImplementedError
```

æŠ½è±¡ç±»å’Œæ™®é€šç±»çš„åŒºåˆ«ä¹‹ä¸€å°±æ˜¯ä½ ä¸èƒ½å°†å®ƒå®ä¾‹åŒ–ã€‚å¦‚æœä½ å°è¯•å®ä¾‹åŒ–ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œè§£é‡Šå™¨ä¼šæŠ¥å‡ºä¸‹é¢çš„é”™è¯¯ï¼š

```plain
TypeError: Can't instantiate abstract class HNWebPage with abstract methods get_text
```

æ‰€ä»¥ï¼Œå…‰æœ‰æŠ½è±¡ç±»è¿˜ä¸èƒ½ç®—å®Œäº‹ï¼Œæˆ‘ä»¬è¿˜å¾—å®šä¹‰å‡ ä¸ªä¾èµ–è¿™ä¸ªæŠ½è±¡ç±»çš„å®ä½“ã€‚é¦–å…ˆå®šä¹‰çš„æ˜¯ `RemoteHNWebPage` ç±»ã€‚å®ƒçš„ä½œç”¨å°±æ˜¯é€šè¿‡ requests æ¨¡å—è¯·æ±‚ HN é¡µé¢ï¼Œè¿”å›é¡µé¢å†…å®¹ã€‚

```plain
class RemoteHNWebPage(HNWebPage):
    """è¿œç¨‹é¡µé¢ï¼Œé€šè¿‡è¯·æ±‚ HN ç«™ç‚¹è¿”å›å†…å®¹"""

    def __init__(self, url: str):
        self.url = url

    def get_text(self) -> str:
        resp = requests.get(self.url)
        return resp.text
```

å®šä¹‰äº† `RemoteHNWebPage` ç±»åï¼Œ`SiteSourceGrouper` ç±»çš„åˆå§‹åŒ–æ–¹æ³•å’Œ `get_groups` ä¹Ÿéœ€è¦åšå¯¹åº”çš„è°ƒæ•´ï¼š

```plain
class SiteSourceGrouper:
    """å¯¹ HN é¡µé¢çš„æ–°é—»æ¥æºç«™ç‚¹è¿›è¡Œåˆ†ç»„ç»Ÿè®¡
    """

    def __init__(self, page: HNWebPage):
        self.page = page

    def get_groups(self) -> Dict[str, int]:
        """è·å– (åŸŸå, ä¸ªæ•°) åˆ†ç»„
        """
        html = etree.HTML(self.page.get_text())
        # é€šè¿‡ xpath è¯­æ³•ç­›é€‰æ–°é—»åŸŸåæ ‡ç­¾
        elems = html.xpath('//table[@class="itemlist"]//span[@class="sitestr"]')

        groups = Counter()
        for elem in elems:
            groups.update([elem.text])
        return groups


def main():
    # å®ä¾‹åŒ– pageï¼Œä¼ å…¥ SiteSourceGrouper
    page = RemoteHNWebPage(url="https://news.ycombinator.com/")
    grouper = SiteSourceGrouper(page).get_groups()
```

åšå®Œè¿™äº›ä¿®æ”¹åï¼Œè®©æˆ‘ä»¬å†çœ‹çœ‹ç°åœ¨çš„æ¨¡å—ä¾èµ–å…³ç³»ï¼š

<div style="text-align: center; color: #999; margin: 14px 0 14px;font-size: 12px;">
<img src="https://www.zlovezl.cn/static/uploaded/2020/02/SOLID_D_after.png" width="100%" />
å›¾ï¼šSiteSourceGrouper å’Œ RemoteHNWebPage éƒ½ä¾èµ–æŠ½è±¡å±‚ HNWebPage
</div>

åœ¨å›¾ä¸­ï¼Œé«˜å±‚æ¨¡å—ä¸å†ä¾èµ–ä½å±‚æ¨¡å—ï¼ŒäºŒè€…åŒæ—¶ä¾èµ–äºæŠ½è±¡æ¦‚å¿µ `HNWebPage`ï¼Œä½å±‚æ¨¡å—çš„ä¾èµ–ç®­å¤´å’Œä¹‹å‰ç›¸æ¯”å€’è¿‡æ¥äº†ã€‚æ‰€ä»¥æˆ‘ä»¬ç§°å…¶ä¸º **ä¾èµ–å€’ç½®**ã€‚

### ä¾èµ–å€’ç½®åçš„å•å…ƒæµ‹è¯•

å†å›åˆ°ä¹‹å‰çš„å•å…ƒæµ‹è¯•ä¸Šæ¥ã€‚é€šè¿‡å¼•å…¥äº†æ–°çš„æŠ½è±¡å±‚ `HNWebPage`ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ªä¸ä¾èµ–å¤–éƒ¨ç½‘ç»œçš„æ–°ç±»å‹ `LocalHNWebPage`ã€‚

```plain
class LocalHNWebPage(HNWebPage):
    """æœ¬åœ°é¡µé¢ï¼Œæ ¹æ®æœ¬åœ°æ–‡ä»¶è¿”å›é¡µé¢å†…å®¹"""

    def __init__(self, path: str):
        self.path = path

    def get_text(self) -> str:
        with open(self.path, 'r') as fp:
            return fp.read()
```

æ‰€ä»¥ï¼Œå•å…ƒæµ‹è¯•ä¹Ÿå¯ä»¥æ”¹ä¸ºä½¿ç”¨ `LocalHNWebPage`ï¼š

```plain
def test_grouper_from_local():
    page = LocalHNWebPage(path="./static_hn.html")
    grouper = SiteSourceGrouper(page)
    result = grouper.get_groups()
    assert isinstance(result, Counter), "groups should be Counter instance"
```

è¿™æ ·å°±å¯ä»¥åœ¨æ²¡æœ‰å¤–ç½‘çš„æœåŠ¡å™¨ä¸Šæµ‹è¯• `SiteSourceGrouper` ç±»çš„æ ¸å¿ƒé€»è¾‘äº†ã€‚

> Hintï¼šå…¶å®ä¸Šé¢çš„æµ‹è¯•å‡½æ•° `test_grouper_from_local` è¿œè¿œç®—ä¸ä¸Šä¸€ä¸ªåˆæ ¼çš„æµ‹è¯•ç”¨ä¾‹ã€‚
> 
> å¦‚æœçœŸè¦æµ‹è¯• `SiteSourceGrouper` çš„æ ¸å¿ƒé€»è¾‘ã€‚æˆ‘ä»¬åº”è¯¥å‡†å¤‡ä¸€ä¸ªè™šæ„çš„ Hacker News é¡µé¢ *ï¼ˆæ¯”å¦‚åˆšå¥½åŒ…å« 5 ä¸ª æ¥æºè‡ª github.com çš„æ¡ç›®ï¼‰*ï¼Œç„¶ååˆ¤æ–­ç»“æœæ˜¯å¦åŒ…å« `assert result['github.com] == 5`

### é—®é¢˜ï¼šä¸€å®šè¦ä½¿ç”¨æŠ½è±¡ç±» abc å—

ä¸ºäº†å®ç°ä¾èµ–å€’ç½®ï¼Œæˆ‘ä»¬åœ¨ä¸Šé¢å®šä¹‰äº†æŠ½è±¡ç±»ï¼š`HNWebPage`ã€‚é‚£æ˜¯ä¸æ˜¯åªæœ‰å®šä¹‰äº†æŠ½è±¡ç±»æ‰èƒ½å®ç°ä¾èµ–å€’ç½®ï¼Ÿåªæœ‰ç”¨äº†æŠ½è±¡ç±»æ‰ç®—æ˜¯ä¾èµ–å€’ç½®å‘¢ï¼Ÿ

**ç­”æ¡ˆæ˜¯å¦å®šçš„ã€‚** å¦‚æœä½ æ„¿æ„ï¼Œä½ å¯ä»¥æŠŠä»£ç é‡Œçš„æŠ½è±¡ç±» `HNWebPage` ä»¥åŠæ‰€æœ‰çš„ç›¸å…³å¼•ç”¨éƒ½åˆ æ‰ï¼Œä½ ä¼šå‘ç°æ²¡æœ‰å®ƒä»¬ä»£ç ä»ç„¶å¯ä»¥æ­£å¸¸è¿è¡Œã€‚

è¿™æ˜¯å› ä¸º Python æ˜¯ä¸€é—¨â€œé¸­å­ç±»å‹â€è¯­è¨€ã€‚è¿™æ„å‘³ç€åªè¦ `RemoteHNWebPage` å’Œ `LocalHNWebPage` ç±»å‹ä¿æŒç€ç»Ÿä¸€çš„æ¥å£åè®®*ï¼ˆæä¾› .get_text() å…¬å¼€æ–¹æ³•ï¼‰*ï¼Œå¹¶ä¸”å®ƒä»¬çš„ **åè®®ç¬¦åˆæˆ‘ä»¬å®šä¹‰çš„æŠ½è±¡**ã€‚é‚£ä¹ˆé‚£ä¸ªä¸­é—´å±‚å°±å­˜åœ¨ï¼Œä¾èµ–å€’ç½®å°±æ˜¯æˆç«‹çš„ã€‚è‡³äºè¿™ä»½ **åè®®** æ˜¯é€šè¿‡æŠ½è±¡ç±»è¿˜æ˜¯æ™®é€šçˆ¶ç±»ï¼ˆç”šè‡³å¯ä»¥æ˜¯æ™®é€šå‡½æ•°ï¼‰å®šä¹‰çš„ï¼Œå°±æ²¡é‚£ä¹ˆé‡è¦äº†ã€‚

æ‰€ä»¥ï¼Œè™½ç„¶åœ¨æŸäº›ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œå®ç°ä¾èµ–å€’ç½®å¿…é¡»å¾—å®šä¹‰æ–°çš„æ¥å£ç±»å‹ï¼Œä½†åœ¨ Python é‡Œï¼Œä¾èµ–å€’ç½®å¹¶ä¸æ˜¯æŠ½è±¡ç±» abc çš„ç‰¹æƒã€‚

### é—®é¢˜ï¼šæŠ½è±¡ä¸€å®šæ˜¯å¥½ä¸œè¥¿å—

å‰é¢çš„æ‰€æœ‰å†…å®¹ï¼Œéƒ½æ˜¯åœ¨è¯´æ–°å¢ä¸€ä¸ªæŠ½è±¡å±‚ï¼Œç„¶åè®©ä¾èµ–å…³ç³»å€’è¿‡æ¥çš„ç§ç§å¥½å¤„ã€‚æ‰€ä»¥ï¼Œå¤šæŠ½è±¡çš„ä»£ç ä¸€å®šå°±æ˜¯å¥½çš„å—ï¼Ÿç¼ºå°‘æŠ½è±¡çš„ä»£ç å°±ä¸€å®šä¸å¤Ÿçµæ´»ï¼Ÿ

å’Œæ‰€æœ‰è¿™ç±»é—®é¢˜çš„æ ‡å‡†å›ç­”ä¸€æ ·ï¼Œç­”æ¡ˆæ˜¯ï¼š**è§†æƒ…å†µè€Œå®šã€‚**

å½“ä½ ä¹ æƒ¯äº†ä¾èµ–å€’ç½®åŸåˆ™ä»¥åï¼Œä½ ä¼šå‘ç° *æŠ½è±¡ï¼ˆAbstractï¼‰* å…¶å®æ˜¯ä¸€ç§æ€ç»´æ–¹å¼ï¼Œè€Œä¸ä»…ä»…æ˜¯ä¸€ç§ç¼–ç¨‹æ‰‹æ³•ã€‚å¦‚æœä½ æ„¿æ„ï¼Œä½ å¯ä»¥åœ¨ä»£ç é‡Œçš„æ‰€æœ‰åœ°æ–¹éƒ½ **ç¡¬æŒ¤** ä¸€å±‚é¢å¤–æŠ½è±¡å‡ºæ¥ï¼š

- æ¯”å¦‚ä»£ç ä¾èµ–äº† lxml æ¨¡å—çš„ xpath å…·ä½“å®ç°ï¼Œæˆ‘æ˜¯ä¸æ˜¯å¾—å®šä¹‰ä¸€å±‚  *â€œHNTitleDigesterâ€* æŠŠå®ƒæŠ½è±¡è¿›å»ï¼Ÿ
- æ¯”å¦‚ä»£ç é‡Œçš„å­—ç¬¦ä¸²å­—é¢é‡ä¹Ÿæ˜¯å…·ä½“å®ç°ï¼Œæˆ‘æ˜¯ä¸æ˜¯å¾—å®šä¹‰ä¸€ä¸ª *"StringLike"* ç±»å‹æŠŠå®ƒæŠ½è±¡è¿›å»ï¼Ÿ
- ... ...

äº‹å®ä¸Šï¼ŒæŠ½è±¡çš„å¥½å¤„æ˜¾è€Œæ˜“è§ï¼š**å®ƒè§£è€¦äº†é«˜å±‚æ¨¡å—å’Œä½å±‚æ¨¡å—é—´çš„ä¾èµ–å…³ç³»ï¼Œè®©ä»£ç å˜å¾—æ›´çµæ´»ã€‚** ä½†æŠ½è±¡åŒæ—¶ä¹Ÿå¸¦æ¥äº†é¢å¤–çš„ç¼–ç ä¸ç†è§£æˆæœ¬ã€‚æ‰€ä»¥ï¼Œäº†è§£ä½•æ—¶ **ä¸** æŠ½è±¡ä¸ä½•æ—¶æŠ½è±¡åŒæ ·é‡è¦ã€‚**åªæœ‰å¯¹ä»£ç ä¸­é‚£äº›ç°åœ¨æˆ–æœªæ¥ä¼šå‘ç”Ÿå˜åŒ–çš„ä¸œè¥¿è¿›è¡ŒæŠ½è±¡ï¼Œæ‰èƒ½è·å¾—æœ€å¤§çš„æ”¶ç›Šã€‚**

## Iï¼šæ¥å£éš”ç¦»åŸåˆ™

æ¥å£éš”ç¦»åŸåˆ™*ï¼ˆåç®€ç§° I åŸåˆ™ï¼‰*å…¨ç§°ä¸º *â€œInterface Segregation Principlesâ€*ã€‚é¡¾åæ€ä¹‰ï¼Œå®ƒæ˜¯ä¸€æ¡å’Œâ€œæ¥å£ï¼ˆInterfaceï¼‰â€æœ‰å…³çš„åŸåˆ™ã€‚

æˆ‘åœ¨å‰é¢è§£é‡Šè¿‡ä½•ä¸ºâ€œæ¥å£ï¼ˆInterfaceï¼‰â€ã€‚**æ¥å£æ˜¯æ¨¡å—é—´ç›¸äº’äº¤æµçš„æŠ½è±¡åè®®**ï¼Œå®ƒåœ¨ä¸åŒçš„ç¼–ç¨‹è¯­è¨€é‡Œæœ‰ç€ä¸åŒçš„è¡¨ç°å½¢æ€ã€‚æ¯”å¦‚åœ¨ Go é‡Œå®ƒæ˜¯ `type ... interface`ï¼Œè€Œåœ¨ Python ä¸­å®ƒå¯ä»¥æ˜¯æŠ½è±¡ç±»ã€æ™®é€šç±»æˆ–è€…å‡½æ•°ï¼Œç”šè‡³æŸä¸ªåªåœ¨ä½ å¤§è„‘é‡Œå­˜åœ¨çš„ä¸€å¥—åè®®ã€‚

I åŸåˆ™è®¤ä¸ºï¼š**â€œå®¢æˆ·ï¼ˆclientï¼‰åº”è¯¥ä¸ä¾èµ–äºå®ƒä¸ä½¿ç”¨çš„æ–¹æ³•â€**

> The interface-segregation principle (ISP) states that no client should be forced to depend on methods it does not use.

è¿™é‡Œè¯´çš„â€œå®¢æˆ·ï¼ˆClientï¼‰â€æŒ‡çš„æ˜¯æ¥å£çš„ä½¿ç”¨æ–¹ *ï¼ˆå®¢æˆ·ç¨‹åºï¼‰*ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨æ¥å£æ–¹æ³•çš„é«˜å±‚æ¨¡å—ã€‚æ‹¿ä¸Šä¸€ä¸ªç»Ÿè®¡ HN é¡µé¢æ¡ç›®çš„ä¾‹å­æ¥è¯´ï¼š

- `ä½¿ç”¨æ–¹ï¼ˆå®¢æˆ·ç¨‹åºï¼‰`ï¼šSiteSourceGrouper
- `æ¥å£ï¼ˆå…¶å®æ˜¯æŠ½è±¡ç±»ï¼‰`ï¼šHNWebPage
- `ä¾èµ–å…³ç³»`ï¼šè°ƒç”¨æ¥å£æ–¹æ³•ï¼š`get_text()` è·å–é¡µé¢æ–‡æœ¬

åœ¨ I åŸåˆ™çœ‹æ¥ï¼Œ**ä¸€ä¸ªæ¥å£æ‰€æä¾›çš„æ–¹æ³•ï¼Œåº”è¯¥å°±æ˜¯ä½¿ç”¨æ–¹æ‰€éœ€è¦çš„æ–¹æ³•ï¼Œä¸å¤šä¸å°‘åˆšåˆšå¥½ã€‚** æ‰€ä»¥ï¼Œåœ¨ä¸Šä¸ªä¾‹å­é‡Œï¼Œæˆ‘ä»¬è®¾è®¡çš„æ¥å£ `HNWebPage` æ˜¯ç¬¦åˆæ¥å£éš”ç¦»åŸåˆ™çš„ã€‚å› ä¸ºå®ƒæ²¡æœ‰å‘ä½¿ç”¨æ–¹æä¾›ä»»ä½•åè€…ä¸éœ€è¦çš„æ–¹æ³• ã€‚

> ä½ éœ€è¦ get_text()ï¼æˆ‘æä¾› get_text()ï¼åˆšåˆšå¥½ï¼

æ‰€ä»¥ï¼Œè¿™æ¡åŸåˆ™çœ‹ä¸Šå»ä¼¼ä¹å¾ˆå®¹æ˜“éµå®ˆã€‚æ—¢ç„¶å¦‚æ­¤ï¼Œè®©æˆ‘ä»¬è¯•è¯•æ¥è¿åå®ƒå§ï¼

### ä¾‹å­ï¼šå¼€å‘é¡µé¢å½’æ¡£åŠŸèƒ½

è®©æˆ‘ä»¬æ¥ç€ä¸Šä¸€ä¸ªä¾‹å­å¼€å§‹ã€‚åœ¨å®ç°äº†ä¸Šä¸ªéœ€æ±‚åï¼Œæˆ‘ç°åœ¨æœ‰ä¸€ä¸ªä»£è¡¨ Hacker News ç«™ç‚¹é¡µé¢çš„æŠ½è±¡ç±» `HNWebPage`ï¼Œå®ƒåªæä¾›äº†ä¸€ç§è¡Œä¸ºï¼Œå°±æ˜¯è·å–å½“å‰é¡µé¢çš„æ–‡æœ¬å†…å®¹ã€‚

```python
class HNWebPage(metaclass=ABCMeta):

    @abstractmethod
    def get_text(self) -> str:
        """è·å–é¡µé¢æ–‡æœ¬å†…å®¹"""
```

ç°åœ¨ï¼Œå‡è®¾æˆ‘è¦å¼€å‘ä¸€ä¸ªå’Œ HN é¡µé¢æœ‰å…³çš„æ–°åŠŸèƒ½ï¼š **æˆ‘æƒ³åœ¨ä¸åŒæ—¶é—´ç‚¹å¯¹ HN é¦–é¡µå†…å®¹è¿›è¡Œå½’æ¡£ï¼Œè§‚å¯Ÿçƒ­ç‚¹æ–°é—»åœ¨ä¸åŒæ—¶é—´ç‚¹å‘ç”Ÿçš„å˜åŒ–ã€‚** æ‰€ä»¥é™¤äº†é¡µé¢æ–‡æœ¬å†…å®¹å¤–ï¼Œæˆ‘è¿˜éœ€è¦æ‹¿åˆ°é¡µé¢çš„å¤§å°ã€ç”Ÿæˆæ—¶é—´è¿™äº›é¢å¤–ä¿¡æ¯ï¼Œç„¶åå°†å®ƒä»¬éƒ½ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚

ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œç°åœ¨çš„ `HNWebPage` ç±»éœ€è¦è¢«æ‰©å±•ä¸€ä¸‹ï¼š

```python
class HNWebPage(metaclass=ABCMeta):

    @abstractmethod
    def get_text(self) -> str:
        """è·å–é¡µé¢æ–‡æœ¬å†…å®¹"""
        
    # æ–°å¢ get_size ä¸ get_generated_at
        
    @abstractmethod
    def get_size(self) -> int:
        """è·å–é¡µé¢å¤§å°"""

    @abstractmethod
    def get_generated_at(self) -> datetime.datetime:
        """è·å–é¡µé¢ç”Ÿæˆæ—¶é—´"""
```

æˆ‘åœ¨åŸæ¥çš„ç±»ä¸Šå¢åŠ äº†ä¸¤ä¸ªæ–°çš„æŠ½è±¡æ–¹æ³•ï¼š`get_size` å’Œ `get_generated_at`ã€‚è¿™æ ·å½’æ¡£ç¨‹åºå°±èƒ½é€šè¿‡å®ƒä»¬æ‹¿åˆ°é¡µé¢å¤§å°å’Œç”Ÿæˆæ—¶é—´äº†ã€‚

æ”¹å®ŒæŠ½è±¡ç±»åï¼Œç´§æ¥ç€çš„ä»»åŠ¡å°±æ˜¯ä¿®æ”¹ä¾èµ–å®ƒçš„å®ä½“ç±»ã€‚

### é—®é¢˜ï¼šå®ä½“ç±»ä¸ç¬¦åˆ HNWebPage æ¥å£è§„èŒƒ

åœ¨ä¿®æ”¹æŠ½è±¡ç±»å‰ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªå®ç°äº†å®ƒåè®®çš„å®ä½“ç±»ï¼š`RemoteHNWebPage` å’Œ `LocalHNWebPage`ã€‚å¦‚ä»Šï¼Œ`HNWebPage` å¢åŠ äº†ä¸¤ä¸ªæ–°æ–¹æ³• `get_size` å’Œ `get_generated_at`ã€‚æˆ‘ä»¬è‡ªç„¶éœ€è¦æŠŠè¿™ä¸¤ä¸ªå®ä½“ç±»ä¹ŸåŠ ä¸Šè¿™ä¸¤ä¸ªæ–¹æ³•ã€‚

`RemoteHNWebPage` ç±»çš„ä¿®æ”¹å¾ˆå¥½åšï¼Œæˆ‘ä»¬åªè¦è®© `get_size` æ”¾å›é¡µé¢é•¿åº¦ï¼Œè®© `get_generated_at` è¿”å›å½“å‰æ—¶é—´å°±è¡Œäº†ã€‚

```python
# class RemoteHNWebPage:
#
def get_generated_at(self) -> datetime.datetime:
    # é¡µé¢ç”Ÿæˆæ—¶é—´ç­‰åŒäºé€šè¿‡ requests è¯·æ±‚çš„æ—¶é—´
    return datetime.datetime.now()
```

ä½†æ˜¯ï¼Œåœ¨ç»™ `LocalHNWebPage` æ·»åŠ  `get_generated_at` æ–¹æ³•æ—¶ï¼Œæˆ‘ç¢°åˆ°äº†ä¸€ä¸ªé—®é¢˜ã€‚`LocalHNWebPage` æ˜¯ä¸€ä¸ªå®Œå…¨åŸºäºæœ¬åœ°é¡µé¢æ–‡ä»¶ä½œä¸ºæ•°æ®æ¥æºçš„ç±»ï¼Œä»…ä»…é€šè¿‡ â€œstatic_hn.htmlâ€ è¿™ä¹ˆä¸€ä¸ªæœ¬åœ°æ–‡ä»¶ï¼Œæˆ‘æ ¹æœ¬å°±æ²¡æ³•çŸ¥é“å®ƒçš„å†…å®¹æ˜¯ä»€ä¹ˆæ—¶å€™ç”Ÿæˆçš„ã€‚

è¿™æ—¶æˆ‘åªèƒ½é€‰æ‹©è®©å®ƒçš„ `get_generated_at` æ–¹æ³•è¿”å›ä¸€ä¸ªé”™è¯¯çš„ç»“æœ*ï¼ˆæ¯”å¦‚æ–‡ä»¶çš„ä¿®æ”¹æ—¶é—´ï¼‰*ï¼Œæˆ–è€…ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚æ— è®ºæ˜¯å“ªç§åšæ³•ï¼Œæˆ‘éƒ½å¯èƒ½è¿å [é‡Œå¼æ›¿æ¢åŸåˆ™](https://www.zlovezl.cn/articles/write-solid-python-codes-part-2/)ã€‚

> Hintï¼šé‡Œå¼æ›¿æ¢åŸåˆ™è®¤ä¸ºå­ç±»ï¼ˆæ´¾ç”Ÿç±»ï¼‰å¯¹è±¡åº”è¯¥å¯ä»¥åœ¨ç¨‹åºä¸­æ›¿ä»£çˆ¶ç±»ï¼ˆåŸºç±»ï¼‰å¯¹è±¡ä½¿ç”¨ï¼Œè€Œä¸ç ´åç¨‹åºåŸæœ¬çš„åŠŸèƒ½ã€‚è®©æ–¹æ³•æŠ›å‡ºå¼‚å¸¸æ˜¾ç„¶ç ´åäº†è¿™ä¸€ç‚¹ã€‚

```python
# class LocalHNWebPage:
#
def get_generated_at(self) -> datetime.datetime:
    raise NotImplementedError("local web page can not provide generate_at info")
```

æ‰€ä»¥ï¼Œå¯¹ç°æœ‰æ¥å£çš„ç›²ç›®æ‰©å±•æš´éœ²å‡ºæ¥ä¸€ä¸ªé—®é¢˜ï¼š**æ›´å¤šçš„æ¥å£æ–¹æ³•æ„å‘³ç€æ›´é«˜çš„å®ç°æˆæœ¬ï¼Œç»™å®ç°æ–¹å¸¦æ¥éº»çƒ¦çš„æ¦‚ç‡ä¹Ÿå˜é«˜äº†ã€‚**

ä¸è¿‡ç°åœ¨è®©æˆ‘ä»¬æš‚ä¸”æŠŠè¿™ä¸ªé—®é¢˜æ”¾åˆ°ä¸€è¾¹ï¼Œç»§ç»­å†™ä¸€ä¸ª `SiteAchiever` ç±»å®Œæˆå½’æ¡£ä»»åŠ¡ï¼š

```python
class SiteAchiever:
    """å°†ä¸åŒæ—¶é—´ç‚¹çš„ HN é¡µé¢å½’æ¡£"""

    def save_page(self, page: HNWebPage):
        """å°†é¡µé¢ä¿å­˜åˆ°åç«¯æ•°æ®åº“
        """
        data = {
            "content": page.get_text(),
            "generated_at": page.get_generated_at(),
            "size": page.get_size(),
        }
        # å°† data ä¿å­˜åˆ°æ•°æ®åº“ä¸­
```

### æˆåŠŸè¿å I åè®®

ä»£ç å†™åˆ°è¿™ï¼Œè®©æˆ‘ä»¬å›å¤´çœ‹çœ‹ä¸Šä¸ªä¾‹å­é‡Œçš„ *æ¡ç›®æ¥æºåˆ†ç»„ç±» `SiteSourceGrouper`* ã€‚

<div style="text-align: center; color: #999; margin: 14px 0 14px;font-size: 12px;">
<img src="https://www.zlovezl.cn/static/uploaded/2020/02/SOLID_I_before.png" width="100%" />
å›¾ï¼šæˆåŠŸè¿åäº† I åè®®
</div>

å½“æˆ‘ä¿®æ”¹å®ŒæŠ½è±¡ç±»åï¼Œè™½ç„¶ `SiteSourceGrouper` ä»ç„¶ä¾èµ–ç€ `HNWebPage`ï¼Œä½†å®ƒå…¶å®åªä½¿ç”¨äº† `get_text` è¿™ä¸€ä¸ªæ–¹æ³•è€Œå·²ï¼Œå…¶ä»–  `get_size`ã€`get_generated` è¿™äº›å®ƒ **ä¸ä½¿ç”¨çš„æ–¹æ³•ä¹Ÿæˆä¸ºäº†å®ƒçš„ä¾èµ–ã€‚**

å¾ˆæ˜æ˜¾ï¼Œç°åœ¨çš„è®¾è®¡è¿åäº†æ¥å£éš”ç¦»åŸåˆ™ã€‚ä¸ºäº†ä¿®å¤è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦å°† `HNWebPage` æ‹†æˆæ›´å°çš„æ¥å£ã€‚

### å¦‚ä½•åˆ†æ‹†æ¥å£

è®¾è®¡æ¥å£æœ‰ä¸€ä¸ªæŠ€å·§ï¼š**è®©å®¢æˆ·ï¼ˆè°ƒç”¨æ–¹ï¼‰æ¥é©±åŠ¨åè®®è®¾è®¡**ã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹ï¼Œ`HNWebPage` åˆ°åº•æœ‰å“ªäº›å®¢æˆ·ï¼š

- `SiteSourceGrouper`ï¼šåŸŸåæ¥æºç»Ÿè®¡ï¼Œä¾èµ– `get_text()`
- `SiteAchiever`ï¼šHN é¡µé¢å½’æ¡£ç¨‹åºï¼Œä¾èµ– `get_text()`ã€`get_size()`ã€`get_generated_at()`

æŒ‰ç…§ä¸Šé¢çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠ `HNWebPage` åˆ†ç¦»æˆä¸¤ä¸ªç‹¬ç«‹çš„æŠ½è±¡ç±»ï¼š

```python
class ContentOnlyHNWebPage(metaclass=ABCMeta):
    """æŠ½è±¡ç±»ï¼šHacker New ç«™ç‚¹é¡µé¢ï¼ˆä»…æä¾›å†…å®¹ï¼‰
    """

    @abstractmethod
    def get_text(self) -> str:
        raise NotImplementedError


class HNWebPage(ContentOnlyHNWebPage):
    """æŠ½è±¡ç±»ï¼šHacker New ç«™ç‚¹é¡µé¢ï¼ˆå«å…ƒæ•°æ®ï¼‰
    """

    @abstractmethod
    def get_size(self) -> int:
        """è·å–é¡µé¢å¤§å°"""

    @abstractmethod
    def get_generated_at(self) -> datetime.datetime:
        """è·å–é¡µé¢ç”Ÿæˆæ—¶é—´"""
```

å°†æ—§ç±»æ‹†åˆ†æˆä¸¤ä¸ªä¸åŒçš„æŠ½è±¡ç±»åï¼Œ`SiteSourceGrouper` å’Œ `SiteAchiever` å°±å¯ä»¥åˆ†åˆ«ä¾èµ–ä¸åŒçš„æŠ½è±¡ç±»äº†ã€‚

åŒæ—¶ï¼Œå¯¹äº `LocalHNWebPage` ç±»æ¥è¯´ï¼Œå®ƒä¹Ÿåªéœ€è¦å®ç°é‚£ä¸ªåªè¿”å›çš„æ–‡æœ¬çš„ `ContentOnlyHNWebPage` å°±è¡Œã€‚

<div style="text-align: center; color: #999; margin: 14px 0 14px;font-size: 12px;">
<img src="https://www.zlovezl.cn/static/uploaded/2020/02/SOLID_I_after.png" width="100%" />
å›¾ï¼šå®æ–½æ¥å£éš”ç¦»åçš„ç»“æœ
</div>

### ä¸€äº›ä¸å®¹æ˜“å‘ç°çš„è¿åæƒ…å†µ

è™½ç„¶æˆ‘èŠ±äº†å¾ˆé•¿çš„ç¯‡å¹…ï¼Œç”¨äº†å¥½å‡ ä¸ªæŠ½è±¡ç±»æ‰æŠŠæ¥å£éš”ç¦»åŸåˆ™è®²æ˜ç™½ï¼Œä½†å…¶å®åœ¨æˆ‘ä»¬çš„æ—¥å¸¸ç¼–ç ä¸­ï¼Œå¯¹è¿™æ¡åŸåˆ™çš„è¿åç»å¸¸ä¼šå‡ºç°åœ¨ä¸€äº›æ›´å®¹æ˜“è¢«å¿½è§†çš„åœ°æ–¹ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œå½“æˆ‘ä»¬åœ¨ web ç«™ç‚¹é‡Œåˆ¤æ–­ç”¨æˆ·è¯·æ±‚çš„ Cookies æˆ–å¤´ä¿¡æ¯æ˜¯å¦åŒ…å«æŸä¸ªæ ‡è®°å€¼æ—¶ï¼Œæˆ‘ä»¬ç»å¸¸ç›´æ¥å†™ä¸€ä¸ªä¾èµ–æ•´ä¸ª `request` å¯¹è±¡çš„å‡½æ•°ï¼š

```python
def is_new_visitor(request: HttpRequest) -> bool:
    """ä» Cookies åˆ¤æ–­æ˜¯å¦æ–°è®¿å®¢
    """
    return request.COOKIES.get('is_new_visitor') == 'y'
```

ä½†äº‹å®ä¸Šï¼Œé™¤äº† `.COOKIES` ä»¥å¤–ï¼Œ`is_new_visitor` æ ¹æœ¬å°±ä¸éœ€è¦ `request` å¯¹è±¡é‡Œé¢çš„ä»»ä½•å…¶ä»–å†…å®¹ã€‚â€œç”¨æˆ·è¯·æ±‚å¯¹è±¡ï¼ˆrequestï¼‰â€æ˜¯ä¸€ä¸ªæ¯”â€œCookie å­—å…¸ï¼ˆrequest.COOKIESï¼‰â€å¤æ‚å¾—å¤šçš„æŠ½è±¡ã€‚æˆ‘ä»¬å®Œå…¨å¯ä»¥æŠŠå‡½æ•°æ”¹æˆåªæ¥æ”¶ cookies å­—å…¸ã€‚

```python
def is_new_visitor(cookies: Dict) -> bool:
    """ä» Cookies åˆ¤æ–­æ˜¯å¦æ–°è®¿å®¢
    """
    return cookies.get('is_new_visitor') == 'y'
```

ç±»ä¼¼çš„æƒ…å†µè¿˜æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ä¸€ä¸ªå‘çŸ­ä¿¡çš„å‡½æ•°æœ¬èº«åªéœ€è¦ä¸¤ä¸ªå‚æ•° `ç”µè¯å·ç ` å’Œ `ç”¨æˆ·å§“å`ï¼Œä½†æ˜¯å‡½æ•°å´ä¾èµ–äº†æ•´ä¸ªç”¨æˆ·å¯¹è±¡ `User`ï¼Œé‡Œé¢åŒ…å«ç€å‡ åä¸ªç”¨ä¸ä¸Šçš„å…¶ä»–å­—æ®µå’Œæ–¹æ³•ã€‚

å¯¹äºè¿™ç±»å‡½æ•°ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥é‡æ–°è€ƒè™‘ä¸€ä¸‹å®ƒä»¬çš„æŠ½è±¡æ˜¯å¦åˆç†ï¼Œæ˜¯å¦éœ€è¦åº”ç”¨æ¥å£éš”ç¦»åŸåˆ™ã€‚

### ç°å®ä¸–ç•Œä¸­çš„æ¥å£éš”ç¦»

å½“ä½ çŸ¥é“äº†æ¥å£éš”ç¦»åŸåˆ™çš„ç§ç§å¥½å¤„åï¼Œä½ å¾ˆè‡ªç„¶å°±ä¼šå…»æˆå†™å°ç±»ã€å°æ¥å£çš„ä¹ æƒ¯ã€‚åœ¨ç°å®ä¸–ç•Œé‡Œï¼Œå…¶å®å·²ç»æœ‰å¾ˆå¤šå°è€Œç²¾çš„æ¥å£è®¾è®¡å¯ä»¥ä¾›ä½ å‚è€ƒã€‚æ¯”å¦‚ï¼š

- Python çš„ [collections.abc](https://docs.python.org/3/library/collections.abc.html) æ¨¡å—é‡Œé¢æœ‰éå¸¸å¤šçš„å°æ¥å£
- Go é‡Œé¢çš„ [Reader å’Œ Writer](https://golang.org/pkg/io/#Reader) ä¹Ÿæ˜¯éå¸¸å¥½çš„ä¾‹å­

## æ€»ç»“

åœ¨è¿™ç¯‡æ–‡ç« é‡Œï¼Œæˆ‘å‘ä½ ä»‹ç»äº† SOLID åŸåˆ™çš„æœ€åä¸¤ä½æˆå‘˜ï¼š**â€œä¾èµ–å€’ç½®åŸåˆ™â€** ä¸ **â€œæ¥å£éš”ç¦»åŸåˆ™â€**ã€‚

è¿™ä¸¤æ¡åŸåˆ™ä¹‹é—´æœ‰ä¸€ä¸ªå…±åŒç‚¹ï¼Œé‚£å°±æ˜¯å®ƒä»¬éƒ½å’Œ **â€œæŠ½è±¡â€** æœ‰ç€ç´§å¯†çš„è”ç³»ã€‚å‰è€…å‘Šè¯‰æˆ‘ä»¬è¦é¢å‘æŠ½è±¡è€Œéå®ç°ç¼–ç¨‹ï¼Œåè€…åˆ™æ•™å¯¼æˆ‘ä»¬åœ¨è®¾è®¡æŠ½è±¡æ—¶åº”è¯¥åšåˆ°ç²¾å‡†ã€‚

æœ€åå†æ€»ç»“ä¸€ä¸‹ï¼š

- **â€œDï¼šä¾èµ–å€’ç½®åŸåˆ™â€** è®¤ä¸ºé«˜å±‚æ¨¡å—å’Œä½å±‚æ¨¡å—éƒ½åº”è¯¥ä¾èµ–äºæŠ½è±¡
- ä¾èµ–æŠ½è±¡ï¼Œæ„å‘³ç€æˆ‘ä»¬å¯ä»¥å®Œå…¨ä¿®æ”¹ä½å±‚å®ç°ï¼Œè€Œä¸å½±å“é«˜å±‚ä»£ç 
- åœ¨ Python ä¸­ä½ å¯ä»¥ä½¿ç”¨ abc æ¨¡å—æ¥å®šä¹‰æŠ½è±¡ç±»
- é™¤ abc å¤–ï¼Œä½ ä¹Ÿå¯ä»¥ä½¿ç”¨å…¶ä»–æŠ€æœ¯æ¥å®Œæˆä¾èµ–å€’ç½®
- **â€œIï¼šæ¥å£éš”ç¦»åŸåˆ™â€** è®¤ä¸ºå®¢æˆ·ä¸åº”è¯¥ä¾èµ–ä»»ä½•å®ƒä¸ä½¿ç”¨çš„æ–¹æ³•
- è®¾è®¡æ¥å£å°±æ˜¯è®¾è®¡æŠ½è±¡
- è¿åæ¥å£éš”ç¦»åŸåˆ™ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´è¿åå•ä¸€èŒè´£ä¸é‡Œå¼æ›¿æ¢åŸåˆ™
- å†™æ›´å°çš„ç±»ã€å†™æ›´å°çš„æ¥å£åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯ä¸ªå¥½ä¸»æ„

çœ‹å®Œæ–‡ç« çš„ä½ ï¼Œæœ‰æ²¡æœ‰ä»€ä¹ˆæƒ³åæ§½çš„ï¼Ÿè¯·ç•™è¨€æˆ–è€…åœ¨ [é¡¹ç›® Github Issues](https://github.com/piglei/one-python-craftsman) å‘Šè¯‰æˆ‘å§ã€‚

[>>>ä¸‹ä¸€ç¯‡ã€15.åœ¨è¾¹ç•Œå¤„æ€è€ƒã€‘](./15-thinking-in-edge-cases)

[<<<ä¸Šä¸€ç¯‡ã€13.å†™å¥½é¢å‘å¯¹è±¡ä»£ç çš„åŸåˆ™ï¼ˆä¸­ï¼‰ã€‘](./13-write-solid-python-codes-part-2)


## é™„å½•

- é¢˜å›¾æ¥æº: Photo by Carolina Garcia Tavizon on Unsplash
- æ›´å¤šç³»åˆ—æ–‡ç« åœ°å€ï¼šhttps://github.com/piglei/one-python-craftsman

ç³»åˆ—å…¶ä»–æ–‡ç« ï¼š

- [æ‰€æœ‰æ–‡ç« ç´¢å¼• [Github]](https://github.com/piglei/one-python-craftsman)
- [Python å·¥åŒ ï¼šå†™å¥½é¢å‘å¯¹è±¡ä»£ç çš„åŸåˆ™ï¼ˆä¸Šï¼‰](https://www.zlovezl.cn/articles/write-solid-python-codes-part-1/)
- [Python å·¥åŒ ï¼šå†™å¥½é¢å‘å¯¹è±¡ä»£ç çš„åŸåˆ™ï¼ˆä¸­ï¼‰](https://www.zlovezl.cn/articles/write-solid-python-codes-part-2/)
- [Python å·¥åŒ ï¼šå†™å¥½é¢å‘å¯¹è±¡ä»£ç çš„åŸåˆ™ï¼ˆä¸‹ï¼‰](https://www.zlovezl.cn/articles/write-solid-python-codes-part-3/)


