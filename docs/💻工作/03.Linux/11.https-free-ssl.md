---
title: Linux ä¸‹ä½¿ç”¨ acme.sh é…ç½® Let's Encrypt å…è´¹ SSL è¯ä¹¦ + é€šé…ç¬¦è¯ä¹¦
tags: 
  - ğŸ’» å·¥ä½œ
  - Linux
  - HTTPS
  - SSL
categories: 
  - ğŸ’» å·¥ä½œ
  - Linux
date: 2021-09-01 12:27:56
permalink: /pages/62f73e/
---

## ä¸€é”®éƒ¨ç½²

[OHTTPS - å…è´¹HTTPSè¯ä¹¦ã€è‡ªåŠ¨æ›´æ–°ã€è‡ªåŠ¨éƒ¨ç½²](https://www.ohttps.com/)

1ã€ä»€ä¹ˆæ˜¯ SSL è¯ä¹¦ï¼Ÿ
-------------

SSL æ˜¯ä¿æŠ¤ç”¨æˆ·æ•°æ®å’Œé˜²æ­¢èº«ä»½è¢«ç›—ç”¨çš„æœ€ä½³æ–¹å¼ã€‚æ‹¥æœ‰ SSL è¯ä¹¦çš„ç½‘ç«™å¯ä»¥å‘Šè¯‰ç”¨æˆ·ï¼Œä»–ä»¬å¯ä»¥æ”¾å¿ƒçš„æµè§ˆï¼ŒSSL å¯ä»¥ä¿æŠ¤ä»–ä»¬çš„æ•°æ®å®‰å…¨ã€‚ä¸åŒçš„ SSL è¯ä¹¦æä¾›ä¸åŒçº§åˆ«çš„éªŒè¯ã€‚[äº†è§£æ›´å¤š >](https://ssl.do/ssl/)

ç›®å‰æ¯”è¾ƒç«çš„é€‚åˆä¸ªäººç”¨æˆ·çš„è¯ä¹¦å°±æ˜¯ [Letâ€™s Encrypt](https://letsencrypt.org/)ï¼Œè¿™è´§æ˜¯å…è´¹çš„ï¼Œä¸‹é¢æˆ‘ä»¬å°±ä»‹ç»ä¸€ä¸‹å¦‚ä½•åœ¨ Linux æœåŠ¡å™¨ä¸Šé…ç½® SSL è¯ä¹¦

2ã€ä½¿ç”¨ acme.sh å®‰è£… Letâ€™s Encrypt è¯ä¹¦
--------------------------------

Letâ€™s Encrypt æä¾›å¾ˆå¤šæ–¹å¼ï¼Œç½‘ä¸Šä¹Ÿæœ‰ä¸å°‘æ•™ç¨‹ï¼Œä½†æ˜¯éƒ½ä¸æ–¹ä¾¿æ“ä½œï¼Œä¸‹é¢æˆ‘ä»¬å°±ä»‹ç»ä¸€æ¬¾å›½äººå†™çš„å¼€æºè„šæœ¬ [acme.sh](https://acme.sh/)

é¦–å…ˆï¼Œè¿›å…¥æœåŠ¡å™¨åè·å– acme.sh è„šæœ¬ï¼Œæ­¤æ“ä½œä¸ä¸€å®šéœ€è¦ `root` ç”¨æˆ·ç™»é™†

ä½¿ç”¨ `curl` æ–¹å¼è·å–ï¼Œç³»ç»Ÿéœ€è¦å®‰è£… `curl` è½¯ä»¶

    curl https://get.acme.sh | sh

ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨ `wget` æ–¹å¼

    wget -O - https://get.acme.sh | sh

æ›´å¤šå®‰è£…æ–¹å¼è¯·[æ‘¸](https://github.com/Neilpang/acme.sh/wiki/How-to-install)è¿™å„¿

å› ä¸ºè¿™è´§çš„è„šæœ¬æœåŠ¡å™¨æ”¾åœ¨äº† [Google Cloud Platform](https://cloud.google.com/)ï¼Œå›½å†…æœåŠ¡å™¨æ“ä½œå¶å°”ä¼šæŠ½é£ï¼Œè§£å†³æ–¹æ³•çš„è¯ï¼Œè¦ä¹ˆæŒ‚ä»£ç†ï¼Œè¦ä¹ˆé€‰æ‹©å¤§åŠå¤œç½‘ç»œå¥½çš„æ—¶å€™

æ¥ç€é‡æ–°åŠ è½½ Bash

    source ~/.bashrc

è¾“å…¥ `acme.sh --help` å³å¯æŸ¥çœ‹ acme.sh çš„å¸®åŠ©å‘½ä»¤

    root@sb-blog ~ # acme.sh --help
    https://github.com/Neilpang/acme.sh
    v2.7.8
    Usage: acme.sh  command ...[parameters]....
    Commands:
      --help, -h               Show this help message.
      --version, -v            Show version info.
      --install                Install acme.sh to your system.
      --uninstall              Uninstall acme.sh, and uninstall the cron job.
      --upgrade                Upgrade acme.sh to the latest code from https://github.com/Neilpang/acme.sh.
      --issue                  Issue a cert.
      --signcsr                Issue a cert from an existing csr.
      --deploy                 Deploy the cert to your server.
      --install-cert           Install the issued cert to apache/nginx or any other server.
      --renew, -r              Renew a cert.
      --renew-all              Renew all the certs.
      --revoke                 Revoke a cert.
      --remove                 Remove the cert from list of certs known to acme.sh.
      --list                   List all the certs.
      --showcsr                Show the content of a csr.
      --install-cronjob        Install the cron job to renew certs, you don't need to call this. The 'install' command can automatically install the cron job.
      --uninstall-cronjob      Uninstall the cron job. The 'uninstall' command can do this automatically.
      --cron                   Run cron job to renew all the certs.
      --toPkcs                 Export the certificate and key to a pfx file.
      --toPkcs8                Convert to pkcs8 format.
      --update-account         Update account info.
      --register-account       Register account key.
      --deactivate-account     Deactivate the account.
      --create-account-key     Create an account private key, professional use.
      --create-domain-key      Create an domain private key, professional use.
      --createCSR, -ccsr       Create CSR , professional use.
      --deactivate             Deactivate the domain authz, professional use.
    
    Parameters:
      --domain, -d   domain.tld         Specifies a domain, used to issue, renew or revoke etc.
      --challenge-alias domain.tld      The challenge domain alias for DNS alias mode: https://github.com/Neilpang/acme.sh/wiki/DNS-alias-mode
      --domain-alias domain.tld         The domain alias for DNS alias mode: https://github.com/Neilpang/acme.sh/wiki/DNS-alias-mode
      --force, -f                       Used to force to install or force to renew a cert immediately.
      --staging, --test                 Use staging server, just for test.
      --debug                           Output debug info.
      --output-insecure                 Output all the sensitive messages. By default all the credentials/sensitive messages are hidden from the output/debug/log for secure.
      --webroot, -w  /path/to/webroot   Specifies the web root folder for web root mode.
      --standalone                      Use standalone mode.
      --stateless                       Use stateless mode, see: https://github.com/Neilpang/acme.sh/wiki/Stateless-Mode
      --apache                          Use apache mode.
      --dns [dns_cf|dns_dp|dns_cx|/path/to/api/file]   Use dns mode or dns api.
      --dnssleep  [120]                  The time in seconds to wait for all the txt records to take effect in dns api mode. Default 120 seconds.
    
      --keylength, -k [2048]            Specifies the domain key length: 2048, 3072, 4096, 8192 or ec-256, ec-384.
      --accountkeylength, -ak [2048]    Specifies the account key length.
      --log    [/path/to/logfile]       Specifies the log file. The default is: "/root/.acme.sh/acme.sh.log" if you don't give a file path here.
      --log-level 1|2                   Specifies the log level, default is 1.
      --syslog [0|3|6|7]                Syslog level, 0: disable syslog, 3: error, 6: info, 7: debug.
    
      These parameters are to install the cert to nginx/apache or anyother server after issue/renew a cert:
    
      --cert-file                       After issue/renew, the cert will be copied to this path.
      --key-file                        After issue/renew, the key will be copied to this path.
      --ca-file                         After issue/renew, the intermediate cert will be copied to this path.
      --fullchain-file                  After issue/renew, the fullchain cert will be copied to this path.
    
      --reloadcmd "service nginx reload" After issue/renew, it's used to reload the server.
    
      --server SERVER                   ACME Directory Resource URI. (default: https://acme-v01.api.letsencrypt.org/directory)
      --accountconf                     Specifies a customized account config file.
      --home                            Specifies the home dir for acme.sh .
      --cert-home                       Specifies the home dir to save all the certs, only valid for '--install' command.
      --config-home                     Specifies the home dir to save all the configurations.
      --useragent                       Specifies the user agent string. it will be saved for future use too.
      --accountemail                    Specifies the account email, only valid for the '--install' and '--update-account' command.
      --accountkey                      Specifies the account key path, only valid for the '--install' command.
      --days                            Specifies the days to renew the cert when using '--issue' command. The max value is 60 days.
      --httpport                        Specifies the standalone listening port. Only valid if the server is behind a reverse proxy or load balancer.
      --local-address                   Specifies the standalone/tls server listening address, in case you have multiple ip addresses.
      --listraw                         Only used for '--list' command, list the certs in raw format.
      --stopRenewOnError, -se           Only valid for '--renew-all' command. Stop if one cert has error in renewal.
      --insecure                        Do not check the server certificate, in some devices, the api server's certificate may not be trusted.
      --ca-bundle                       Specifies the path to the CA certificate bundle to verify api server's certificate.
      --ca-path                         Specifies directory containing CA certificates in PEM format, used by wget or curl.
      --nocron                          Only valid for '--install' command, which means: do not install the default cron job. In this case, the certs will not be renewed automatically.
      --no-color                        Do not output color text.
      --ecc                             Specifies to use the ECC cert. Valid for '--install-cert', '--renew', '--revoke', '--toPkcs' and '--createCSR'
      --csr                             Specifies the input csr.
      --pre-hook                        Command to be run before obtaining any certificates.
      --post-hook                       Command to be run after attempting to obtain/renew certificates. No matter the obtain/renew is success or failed.
      --renew-hook                      Command to be run once for each successfully renewed certificate.
      --deploy-hook                     The hook file to deploy cert
      --ocsp-must-staple, --ocsp        Generate ocsp must Staple extension.
      --always-force-new-domain-key     Generate new domain key when renewal. Otherwise, the domain key is not changed by default.
      --auto-upgrade   [0|1]            Valid for '--upgrade' command, indicating whether to upgrade automatically in future.
      --listen-v4                       Force standalone/tls server to listen at ipv4.
      --listen-v6                       Force standalone/tls server to listen at ipv6.
      --openssl-bin                     Specifies a custom openssl bin location.
      --use-wget                        Force to use wget, if you have both curl and wget installed.

ç„¶åå¯ä»¥æ‰§è¡Œ `acme.sh --upgrade --auto-upgrade` è·å– acme.sh æ›´æ–°ï¼Œå¹¶è®¾ç½®ä¹‹åéƒ½è‡ªåŠ¨æ›´æ–° acme.sh è„šæœ¬

3ã€è·å– Letâ€™s Encrypt è¯ä¹¦
---------------------

å¦‚æœä½ æœ¬åœ°æ²¡æœ‰è£…ä»»ä½• Web æœåŠ¡å™¨è½¯ä»¶ï¼Œæˆ–è€…ä½ çš„ Web æœåŠ¡å™¨è½¯ä»¶å¹¶æ²¡æœ‰ç›‘å¬ TCP 80 ç«¯å£ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨ Standalone æ–¹å¼ç›´æ¥è·å–å¤šåŸŸåè¯ä¹¦ï¼Œæ³¨æ„ä»¥ä¸‹æ“ä½œå¿…é¡»ä½¿ç”¨ root æˆ– sudo åˆ‡æ¢

æˆ‘ä»¬ä»¥ `example.com` / `www.example.com` / `subdomain.example.com` è¿™ä¸‰ä¸ªåŸŸåä¸ºä¾‹

é¦–å…ˆï¼Œä½ éœ€è¦æŠŠè¿™ä¸‰ä¸ªåŸŸåéƒ½è§£æåˆ°ä½ çš„æœåŠ¡å™¨ IPv4 ä¸Šï¼Œå¹¶ä¸”ç¡®ä¿ä½ çš„æœåŠ¡å™¨å¯ä»¥è®¿é—®å…¬ç½‘ï¼Œæ— æ³•è®¿é—®å…¬ç½‘çš„å†…ç½‘æœåŠ¡å™¨æ˜¯ä¸è¡Œçš„

å¦å¤–ï¼Œä½ ä¹Ÿå¯ä»¥ç»™ `example.com` å¢åŠ ä¸€ä¸ª CAA è®°å½•ä¸º `0 issue "letsencrypt.org"` è¿™æ ·å¯ä»¥å‘Šè¯‰ Letâ€™s Encrypt çš„ CA ï¼Œä½ æˆæƒç»™ä»–ä»¬ç­¾å‘ SSL è¯ä¹¦

    acme.sh --issue --standalone -d example.com -d www.example.com -d subdomain.example.com

é€šè¿‡è¿™ä¸ªæ–¹å¼ï¼Œå³å¯ä¸º `example.com` `www.example.com` å’Œ `subdomain.example.com` ä¸‰ä¸ªåŸŸåç­¾å‘ä¸€å¼ å¤šåŸŸåè¯ä¹¦

ä½†æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½è£…äº† Web æœåŠ¡å™¨ï¼Œå¹¶ä¸”å®‰è£…äº† SSL ä»¥åå¾ˆå¤šç”¨æˆ·é€‰æ‹© http è·³è½¬åˆ° httpsï¼Œæ‰€ä»¥ä½ éœ€è¦ç¡®ä¿ Letâ€™s Encrypt èƒ½è®¿é—® 80 ç«¯å£ä¸‹çš„ `/.well-known/acme-challenge` ç›®å½•ï¼Œæˆ‘ä»¬ä»¥ Nginx ä¸ºä¾‹

ä»¥ä¸‹æ“ä½œä¹‹å‰å¯ä»¥é€šè¿‡æœ¬ç«™çš„æ•™ç¨‹å®‰è£… LEMP

[Debian 9 / Debian 8 ä½¿ç”¨æºå®‰è£… LEMP æ•™ç¨‹](https://sb.sb/blog/debian-install-nginx-php-mysql/)

[Ubuntu 16.04 / Ubuntu 14.04 ä½¿ç”¨æºå®‰è£… LEMP æ•™ç¨‹](https://sb.sb/blog/ubuntu-install-nginx-php-mysql/)

[CentOS / RHEL 7 ä½¿ç”¨ EPEL å®‰è£… LEMP æ•™ç¨‹](https://sb.sb/blog/centos-install-nginx-php-mysql/)

[Linux ä¸‹ç¼–è¯‘å®‰è£…æœ€æ–°ç‰ˆæœ¬ Nginx](https://sb.sb/blog/linux-install-nginx/)

é¦–å…ˆå»ºç«‹ä¸€ä¸ª `/var/www/letsencrypt` ç›®å½•

    mkdir -p /var/www/letsencrypt

ç„¶åä¿®æ”¹ `/etc/nginx/sites-enabled/default` æ–‡ä»¶

    server {
    	listen 80 default_server;
    	listen [::]:80 default_server;
    	server_name _;
    
    	location /.well-known/acme-challenge {
    		root /var/www/letsencrypt;
    	}
    
    	location / {
    		return 301 https://$host$request_uri;
    	}
    }

è¿™æ®µè¯çš„æ„æ€æ˜¯ï¼Œæ‰€æœ‰è®¿é—® 80 ç«¯å£çš„è¯·æ±‚ï¼Œéƒ½è‡ªåŠ¨è·³è½¬åˆ° https ï¼Œä½†æ˜¯ `/.well-known/acme-challenge` è¿™ä¸ªç›®å½•ä»ç„¶å¯ä»¥é€šè¿‡ 80 ç«¯å£è¿›è¡Œè®¿é—®

ç„¶åé‡å¯ Nginx

    nginx -t && nginx -s reload

æ¥ä¸‹æ¥ç»™ `example.com` `www.example.com` å’Œ `subdomain.example.com` ä¸‰ä¸ªåŸŸåç­¾å‘ä¸€å¼ å¤šåŸŸåè¯ä¹¦

    acme.sh --issue -d example.com -d www.example.com -d subdomain.example.com -w /var/www/letsencrypt

å¦‚æœæ²¡æœ‰é—®é¢˜ï¼Œå°±ä¼šçœ‹åˆ°å¦‚ä¸‹ç»“æœ

    root@example ~ # acme.sh --issue -d example.com -d www.example.com -w /var/www/letsencrypt
    [Tue Mar 20 15:50:37 HKT 2018] Domains have changed.
    [Tue Mar 20 15:50:37 HKT 2018] Multi domain='DNS:example.com,DNS:www.example.com'
    [Tue Mar 20 15:50:37 HKT 2018] Getting domain auth token for each domain
    [Tue Mar 20 15:50:37 HKT 2018] Getting webroot for domain='example.com'
    [Tue Mar 20 15:50:37 HKT 2018] Getting new-authz for domain='example.com'
    [Tue Mar 20 15:50:38 HKT 2018] The new-authz request is ok.
    [Tue Mar 20 15:50:38 HKT 2018] Getting webroot for domain='www.example.com'
    [Tue Mar 20 15:50:38 HKT 2018] Getting new-authz for domain='www.example.com'
    [Tue Mar 20 15:50:39 HKT 2018] The new-authz request is ok.
    [Tue Mar 20 15:50:39 HKT 2018] example.com is already verified, skip http-01.
    [Tue Mar 20 15:50:39 HKT 2018] Verifying:www.example.com
    [Tue Mar 20 15:50:43 HKT 2018] Success
    [Tue Mar 20 15:50:43 HKT 2018] Verify finished, start to sign.
    [Tue Mar 20 15:50:44 HKT 2018] Cert success.
    -----BEGIN CERTIFICATE-----
    è¿™é‡Œä¸€é•¿ä¸²å°±æ˜¯è¯ä¹¦æ–‡ä»¶è¾“å‡º
    -----END CERTIFICATE-----
    [Tue Mar 20 15:50:44 HKT 2018] Your cert is in  /root/.acme.sh/example.com/example.com.cer 
    [Tue Mar 20 15:50:44 HKT 2018] Your cert key is in  /root/.acme.sh/example.com/example.com.key 
    [Tue Mar 20 15:50:45 HKT 2018] The intermediate CA cert is in  /root/.acme.sh/example.com/ca.cer 
    [Tue Mar 20 15:50:45 HKT 2018] And the full chain certs is there:  /root/.acme.sh/example.com/fullchain.cer

ç­¾å‘å®Œæˆåï¼Œæˆ‘ä»¬å¯ä»¥å®‰è£…åˆ° Nginx

ä¸ºäº†è¿›åæ–¹ä¾¿ç»´æŠ¤ï¼Œæˆ‘ä»¬å»ºç«‹ä¸€ä¸ª `/etc/nginx/ssl` ç›®å½•ç”¨æ¥æ”¾è¯ä¹¦

    mkdir -p /etc/nginx/ssl

    acme.sh --install-cert -d example.com \
    --key-file       /etc/nginx/ssl/example.com.key  \
    --fullchain-file /etc/nginx/ssl/example.com.crt \
    --reloadcmd     "service nginx force-reload"

ä¸ç®¡å¤šåŸŸåè¯ä¹¦é‡Œæœ‰å‡ ä¸ªåŸŸåï¼Œè¿™é‡Œçš„ `-d` å‚æ•°åªéœ€è¦å¸¦ç¬¬ä¸€ä¸ªåŸŸåå³å¯

å¦‚æœæ˜¯ Apache 2.4.8 ä»¥ä¸Šç‰ˆæœ¬çš„è¯ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªå‘½ä»¤

    acme.sh --install-cert -d example.com \
    --key-file       /etc/apache2/ssl/example.com.key  \
    --fullchain-file /etc/apache2/ssl/example.com.crt \
    --reloadcmd     "service apache2 force-reload"

è¿™æ · SSL è¯ä¹¦å°±å·²ç»è·å–å®Œæ¯•å¹¶ä¸”åŠ å…¥äº†è‡ªåŠ¨æ›´æ–°

4ã€é…ç½® Nginx æˆ– Apache
-------------------

è¿™éƒ¨åˆ†æ•™ç¨‹ç½‘ç«™å®åœ¨å¤ªå¤šï¼Œæœ¬æ–‡ä¸åšä¸€ä¸€æè¿°ï¼Œç›´æ¥è´´ä¸Šæˆ‘ä»¬æ¨èçš„é…ç½®æ–‡ä»¶

### 4.1ã€Nginx é…ç½®

ä»¥ä¸‹ç‰ˆæœ¬é€‚ç”¨äº Nginx 1.10+ é»˜è®¤å¼€å¯äº† `HTTP/2.0` å’Œ `HSTS Preload` æ”¯æŒ

é¦–å…ˆæˆ‘ä»¬ç”Ÿæˆ DHE å‚æ•°æ–‡ä»¶ï¼Œè¿™è´§æ˜¯[è¿ªè²-èµ«å°”æ›¼å¯†é’¥äº¤æ¢](https://zh.wikipedia.org/wiki/%E8%BF%AA%E8%8F%B2-%E8%B5%AB%E7%88%BE%E6%9B%BC%E5%AF%86%E9%91%B0%E4%BA%A4%E6%8F%9B)ï¼Œä¸€ç§ç°å¸¸å¼ºå¤§çš„å®‰å…¨åè®®

    openssl dhparam -out /etc/nginx/ssl/dhparam.pem 2048

ç„¶åç¼–è¾‘ `/etc/nginx/sites-enable/example.com.conf`

    server {
    	listen 443 ssl http2 default_server;
    	listen [::]:443 ssl http2 default_server;
    
    	server_name example.com;
    
    	root /var/www/example.com;
    	index index.html index.htm index.php;
    
    # æˆ‘ä»¬é‡‡ç”¨å¼ºå¤§çš„è¿ªè²-èµ«å°”æ›¼å¯†é’¥äº¤æ¢ï¼Œç”Ÿæˆå‘½ä»¤ openssl dhparam -out /etc/nginx/ssl/dhparam.pem 2048
    	ssl_dhparam /etc/nginx/ssl/dhparam.pem;
    
    	ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    	ssl_ciphers 'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS';
    	ssl_prefer_server_ciphers on;
    
    	ssl_session_cache shared:SSL:50m;
    	ssl_session_timeout 1d;
    
    # å¦‚æœä½  Nginx é…ç½®äº† SNI å³å¤šä¸ªç«™ç‚¹ï¼Œå¤šä¸ªè¯ä¹¦ï¼Œåˆ™éœ€è¦ç”¨åˆ°å¦‚ä¸‹é…ç½®ï¼Œå…ˆç”Ÿæˆæ–‡ä»¶ openssl rand 48 > /etc/nginx/ssl/session_ticket.key
    #	ssl_session_ticket_key     /etc/nginx/ssl/session_ticket.key;
    #	ssl_session_tickets        off;
    
    # å¦‚æœéœ€è¦å¼€å¯ OSCP åŠŸèƒ½ï¼Œåˆ™éœ€è¦åŠ å…¥
    #	ssl_stapling               on;
    #	ssl_stapling_verify        on;
    # ssl_trusted_certificate /path/to/root_CA_cert_plus_intermediates;
    #	resolver                   8.8.8.8 8.8.4.4 valid=300s;
    #	resolver_timeout           10s;
    
    # æ­¤å¤„æ˜¯è¯ä¹¦æ–‡ä»¶
    
    	ssl_certificate /etc/nginx/ssl/example.com.crt;
    	ssl_certificate_key /etc/nginx/ssl/example.com.key;
    
    # å¼€å¯ HSTS Preload æ”¯æŒ
    
    	add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"; 
    	add_header X-Frame-Options SAMEORIGIN;
    	add_header X-Content-Type-Options nosniff;
    	add_header X-XSS-Protection "1; mode=block";
    
    # å¼€å¯ PHP7.2-fpm æ¨¡å¼ï¼Œå¦‚éœ€è¦å®‰è£… PHP 7.1.x è¯·ä¿®æ”¹ä¸º fastcgi_pass unix:/run/php/php7.1-fpm.sock;
    #	location ~ \.php$ {
    #	  include snippets/fastcgi-php.conf;
    #    fastcgi_pass unix:/run/php/php7.2-fpm.sock;
    #  }
    
    	access_log /var/log/nginx/example.com.access.log;
    	error_log /var/log/nginx/example.com.error.log;
    }

æ³¨æ„ ssl\_ciphers çš„é…ç½®ï¼Œè¿™é‡Œè´´çš„é…ç½®é€‚åˆå¤§å¤šæ•°çš„æµè§ˆå™¨ï¼Œæœ€ä½æµè§ˆå™¨æ”¯æŒæ˜¯ Firefox 1, Chrome 1, IE 7, Opera 5, Safari 1, Windows XP IE8, Android 2.3, Java 7

å¦‚æœéœ€è¦æ›´è€çš„æµè§ˆå™¨æ”¯æŒï¼Œå¯ä»¥æ”¹æˆ

    ssl_protocols SSLv3 TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers 'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:ECDHE-RSA-DES-CBC3-SHA:ECDHE-ECDSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:DES-CBC3-SHA:HIGH:SEED:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!RSAPSK:!aDH:!aECDH:!EDH-DSS-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA:!SRP';
    ssl_prefer_server_ciphers on;

æ­¤æ–¹æ¡ˆé€‚åˆæœ€ä½ IE6, Java 6 ä½†æ˜¯æˆ‘ä»¬å¼ºçƒˆä¸æ¨èï¼Œå› ä¸ºæ¼æ´å¤ªå¤šï¼Œ SSLv3 ç›®å‰å·²ç»åŸºæœ¬è¢«æ·˜æ±°ï¼Œå‚è€ƒ [#1](https://www.ibm.com/support/knowledgecenter/zh-tw/SSBDYH_3.0.1/com.ibm.zexpl.config.hostconfigref.doc/topics/sslv3support.html) [#2](http://www.freebuf.com/news/78855.html)

å½“ç„¶å¦‚æœéœ€è¦æ¿€è¿›ä¸€ç‚¹ï¼Œå¯ä»¥æ”¹æˆ

    ssl_protocols TLSv1.2;
    ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256';
    ssl_prefer_server_ciphers on;

æ­¤æ–¹æ¡ˆæœ€ä½æµè§ˆå™¨æ”¯æŒæ˜¯ Firefox 27, Chrome 30, IE 11 on Windows 7, Edge, Opera 17, Safari 9, Android 5.0, and Java 8

å†æ¿€è¿›ä¸€ç‚¹çš„ï¼Œå°±è¦ç”¨ TLSv1.3 äº†ï¼Œåç­‰å„ç§æµè§ˆå™¨éƒ½æ”¯æŒå§

ç„¶åæ£€æŸ¥é…ç½®å¹¶é‡å¯ Nginx

    nginx -t && nginx -s reload

### 4.2ã€Apache 2.4 é…ç½®

    <VirtualHost *:80>
    
      ServerName example.com
      Redirect permanent / https://example.com/
    </VirtualHost>
    
    LoadModule headers_module modules/mod_headers.so
    
    <VirtualHost *:443>
    
        SSLEngine on
        SSLCertificateFile      /etc/apache2/ssl/example.com.crt
        SSLCertificateKeyFile   /etc/apache2/ssl/example.com.key
    
        # Uncomment the following directive when using client certificate authentication
        #SSLCACertificateFile    /path/to/ca_certs_for_client_authentication
    
    
        # HSTS (mod_headers is required) (15768000 seconds = 6 months)
        Header always set Strict-Transport-Security "max-age=63072000; includeSubdomains;"
        Header always set X-Frame-Options SAMEORIGIN
        Header always set X-Content-Type-Options nosniff
        Header set X-XSS-Protection "1; mode=block"
    </VirtualHost>
    
    # intermediate configuration, tweak to your needs
    SSLProtocol             all -SSLv3
    SSLCipherSuite          ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS
    SSLHonorCipherOrder     on
    SSLCompression          off
    SSLSessionTickets       off
    
    # OCSP Stapling, only in httpd 2.3.3 and later
    # SSLUseStapling          on
    # SSLStaplingResponderTimeout 5
    # SSLStaplingReturnResponderErrors off
    # SSLStaplingCache        shmcb:/var/run/ocsp(128000)

ä»¥ä¸Š Apache 2.4 çš„é…ç½®å¹¶ä¸å®Œæ•´ï¼Œéœ€è¦ä½ æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´ï¼Œæ›´å¤šæœåŠ¡å™¨è½¯ä»¶çš„ SSL é…ç½®å¯ä»¥å‚è€ƒ [Mozilla SSL Configuration Generator](https://mozilla.github.io/server-side-tls/ssl-config-generator/)

é…ç½®å®Œæˆåé‡å¯ Apache 2.4

    service apache2 reload

å¦å¤–ï¼Œå¼€å¯äº† HSTS Preload åï¼Œå¯ä»¥å» [HSTS Preload List Submission](https://hstspreload.org/) æ£€æŸ¥å¹¶ä¸”æäº¤ä½ çš„ç½‘ç«™ï¼Œè¿™æ ·ä»¥åçš„å„ç§æµè§ˆå™¨å°±ä¼šæŠŠä½ çš„ç½‘å€åŠ å…¥åˆ° HSTS Preload List è®¿é—® example.com çš„æ—¶å€™å°±ä¸éœ€è¦é¢å¤–å»è¯·æ±‚ 80 ç«¯å£äº†

5ã€è·å– Letâ€™s Encrypt é€šé…ç¬¦è¯ä¹¦
------------------------

é€šé…ç¬¦è¯ä¹¦ï¼Œè‹±æ–‡ Wildcard Certificate å›½å†…é»‘è¯å«åšé‡å¡ï¼Œç»è¿‡ä¸€ä¸ªæœˆçš„è·³ç¥¨åï¼ŒLetâ€™s Encrypt ç›®å‰å·²ç»æ”¯æŒé€šé…ç¬¦çš„è¯ä¹¦ï¼ŒåŒæ · acme.sh ä¹Ÿæ˜¯æ”¯æŒçš„ï¼Œå’Œå¤šåŸŸåè¯ä¹¦ä¸åŒï¼Œé€šé…ç¬¦è¯ä¹¦å¿…é¡»ä½¿ç”¨ DNS TXT è®°å½•éªŒè¯æ–¹å¼ï¼Œæˆ‘ä»¬ä»¥ `example.com` å’Œ `*.example.com` ä¸ºä¾‹

    acme.sh --issue -d example.com -d '*.example.com' --dns

å¦‚æœä½ çš„ DNS æä¾›å•†æ”¯æŒ APIï¼Œä½ ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ API è€Œä¸éœ€è¦æ‰‹å·¥ä¿®æ”¹ TXT è®°å½•ï¼Œè¯¦ç»†ç”¨æ³•è¯·è§[è¿™é‡Œ](https://github.com/Neilpang/acme.sh/tree/master/dnsapi)

ç„¶åä¼šçœ‹åˆ°å¦‚ä¸‹çš„è¾“å‡º

    root@example ~ # acme.sh --issue -d example.com -d '*.example.com' --dns
    [Tue Mar 20 16:34:35 HKT 2018] Domains have changed.
    [Tue Mar 20 16:34:35 HKT 2018] Registering account
    [Tue Mar 20 16:34:36 HKT 2018] Registered
    [Tue Mar 20 16:34:36 HKT 2018] ACCOUNT_THUMBPRINT='blablablabla'
    [Tue Mar 20 16:34:36 HKT 2018] Multi domain='DNS:example.com,DNS:*.example.com'
    [Tue Mar 20 16:34:36 HKT 2018] Getting domain auth token for each domain
    [Tue Mar 20 16:34:38 HKT 2018] Getting webroot for domain='example.com'
    [Tue Mar 20 16:34:38 HKT 2018] Getting webroot for domain='*.example.com'
    [Tue Mar 20 16:34:38 HKT 2018] Add the following TXT record:
    [Tue Mar 20 16:34:38 HKT 2018] Domain: '_acme-challenge.example.com'
    [Tue Mar 20 16:34:38 HKT 2018] TXT value: 'blablablabla1'
    [Tue Mar 20 16:34:38 HKT 2018] Please be aware that you prepend _acme-challenge. before your domain
    [Tue Mar 20 16:34:38 HKT 2018] so the resulting subdomain will be: _acme-challenge.example.com
    [Tue Mar 20 16:34:38 HKT 2018] Add the following TXT record:
    [Tue Mar 20 16:34:38 HKT 2018] Domain: '_acme-challenge.example.com'
    [Tue Mar 20 16:34:38 HKT 2018] TXT value: 'blablablabla2'
    [Tue Mar 20 16:34:38 HKT 2018] Please be aware that you prepend _acme-challenge. before your domain
    [Tue Mar 20 16:34:38 HKT 2018] so the resulting subdomain will be: _acme-challenge.example.com
    [Tue Mar 20 16:34:38 HKT 2018] Please add the TXT records to the domains, and re-run with --renew.
    [Tue Mar 20 16:34:38 HKT 2018] Please add '--debug' or '--log' to check more details.
    [Tue Mar 20 16:34:38 HKT 2018] See: https://github.com/Neilpang/acme.sh/wiki/How-to-debug-acme.sh

æ¥ç€ä½ éœ€è¦ç»™ `_acme-challenge.example.com` å¢åŠ ä¸¤ä¸ª TXT è®°å½• `"blablablabla1"` å’Œ `"blablablabla2"`ï¼Œç„¶åæ…¢æ…¢ç­‰ DNS ç”Ÿæ•ˆ

    root@example ~ # dig TXT _acme-challenge.example.com @9.9.9.9 +short
    "blablablabla1"
    "blablablabla2"

ç”Ÿæ•ˆåç»™è¯ä¹¦ç»­ä¸€ç§’

    acme.sh --renew -d example.com -d '*.example.com'

è¾“å‡ºå¦‚ä¸‹

    root@example ~ # acme.sh --renew -d example.com -d '*.example.com' --force
    [Tue Mar 20 16:41:25 HKT 2018] Renew: 'example.com'
    [Tue Mar 20 16:41:26 HKT 2018] Multi domain='DNS:example.com,DNS:*.example.com'
    [Tue Mar 20 16:41:26 HKT 2018] Getting domain auth token for each domain
    [Tue Mar 20 16:41:26 HKT 2018] Verifying:example.com
    [Tue Mar 20 16:41:29 HKT 2018] Success
    [Tue Mar 20 16:41:29 HKT 2018] Verifying:*.example.com
    [Tue Mar 20 16:41:32 HKT 2018] Success
    [Tue Mar 20 16:41:32 HKT 2018] Verify finished, start to sign.
    [Tue Mar 20 16:41:33 HKT 2018] Cert success.
    -----BEGIN CERTIFICATE-----
    è¿™é‡Œæ˜¯è¯ä¹¦æ–‡ä»¶
    -----END CERTIFICATE-----
    [Tue Mar 20 16:41:33 HKT 2018] Your cert is in  /root/.acme.sh/example.com/example.com.cer 
    [Tue Mar 20 16:41:33 HKT 2018] Your cert key is in  /root/.acme.sh/example.com/example.com.key 
    [Tue Mar 20 16:41:33 HKT 2018] The intermediate CA cert is in  /root/.acme.sh/example.com/ca.cer 
    [Tue Mar 20 16:41:33 HKT 2018] And the full chain certs is there:  /root/.acme.sh/example.com/fullchain.cer 
    [Tue Mar 20 16:41:33 HKT 2018] It seems that you are using dns manual mode. please take care: The dns manual mode can not renew automatically, you must issue it again manually. You'd better use the other modes instead.
    [Tue Mar 20 16:41:33 HKT 2018] Call hook error.

ç„¶åå°±å¯ä»¥å‚è€ƒä¸Šé¢çš„ Nginx æˆ– Apache 2.4 çš„é…ç½®ï¼Œè¿™é‡Œä¸å†é‡å¤

ç†è®ºä¸ŠæŒ‰ç…§æœ¬ç«™çš„ Nginx é…ç½®æ•™ç¨‹é…ç½®å®Œæˆåï¼Œ SSL Lab å¾—åˆ†éƒ½ä¼šåœ¨ A+ï¼Œå‚è€ƒ[å¾—åˆ†](https://www.ssllabs.com/ssltest/analyze.html)ã€‚

## åŸæ–‡é“¾æ¥
[Linux ä¸‹ä½¿ç”¨ acme.sh é…ç½® Let's Encrypt å…è´¹ SSL è¯ä¹¦ + é€šé…ç¬¦è¯ä¹¦ - çƒ§é¥¼åšå®¢](https://sb.sb/blog/linux-acme-sh-lets-encrypt-ssl/)

[Linux ä¸‹ä½¿ç”¨ acme.sh å’Œ NS ä»£ç®¡ç”³è¯· Let's Encrypt å…è´¹é€šé…ç¬¦è¯ä¹¦ - çƒ§é¥¼åšå®¢](https://sb.sb/blog/linux-lets-encrypt-wildcard-ssl/)

[33ç§å…è´¹è·å–SSLè¯ä¹¦çš„æ–¹å¼ - çŸ¥ä¹](https://zhuanlan.zhihu.com/p/174755007)