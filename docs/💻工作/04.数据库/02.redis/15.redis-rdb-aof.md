---
title: Redis 持久化存储方案对比与选择
date: 2022-10-08 13:07:48
permalink: /redis/rdb-vs-aof/
categories:
  - 💻工作
  - 数据库
  - redis
tags:
  - redis
---


Redis 持久化选用哪种方案，要依据具体使用场景来判断。

### 一、是否该选择 Redis 持久化

1. **适用情形**

    - 当你需要把 Redis 当作数据库、缓存以及消息队列中间件（DB、Cache、MQ）来用，并且希望在重启后能恢复数据，这时就可以考虑使用 Redis 持久化。
    - 若业务对数据完整性有较高要求，比如支付、订单这类场景，持久化是必不可少的。

2. **不适用情形**

    - 如果 Redis 仅被用作纯缓存，而且数据可以通过后端数据库重新生成，那么持久化就不是必需的。
    - 要是业务更看重写入性能，对数据丢失不太敏感，像统计类业务，那么可以不进行持久化。

### 二、持久化方案对比与建议

1. **RDB（快照）**

    - **原理**：在特定的时间间隔内，将内存中的数据集快照写入磁盘。
    - **优点**：

        - 生成的文件紧凑，适合用于备份和灾难恢复。
        - 对 Redis 性能的影响较小，因为是 fork 子进程来完成持久化操作。
        - 恢复数据的速度比 AOF 快。

    - **缺点**：

        - 无法做到实时持久化，可能会丢失最后一次快照之后的数据。
        - fork 子进程时会占用一定的内存和 CPU 资源。

    - **适用场景**：

        - 适用于可以容忍几分钟数据丢失的场景。
        - 比较适合做冷备和灾难恢复。

    - **配置建议**：

    ```plain
    save 900 1        # 900秒（15分钟）内有1个key发生变化，就执行快照
    save 300 10       # 300秒（5分钟）内有10个key发生变化，就执行快照
    save 60 10000     # 60秒内有10000个key发生变化，就执行快照
    ``` 

2. **AOF（Append-Only File）**

    - **原理**：把每一个写操作追加到日志文件中，重启时重新执行这些命令来恢复数据。
    - **优点**：

        - 数据安全性更高，支持不同的同步策略，如每秒同步、每次写操作同步等。
        - 日志文件是增量追加的，不会出现文件损坏的问题。

    - **缺点**：

        - AOF 文件通常比 RDB 文件大。
        - 在某些同步策略下，写操作的性能会有所下降。
        - 恢复数据的速度比 RDB 慢。

    - **适用场景**：

        - 适用于对数据完整性要求较高的场景。
        - 适合用作热备。

    - **配置建议**：

    ```plain
    appendonly yes          # 开启AOF
    appendfsync everysec    # 每秒同步一次，兼顾性能和安全性
    no-appendfsync-on-rewrite yes  # 在重写AOF文件时不进行同步，提高性能
    auto-aof-rewrite-percentage 100  # 当AOF文件大小比上次重写增长100%时，触发重写
    auto-aof-rewrite-min-size 64mb   # AOF文件最小重写大小
    ```

3. **混合持久化（RDB + AOF）**
   在 Redis 4.0 及以后的版本中，**混合持久化（RDB+AOF）确实是大多数场景下的最佳选择**，但并非适用于所有情况。以下是具体分析和建议：

   混合持久化结合了 RDB 和 AOF 的优势：

   1. **恢复速度快**：重启时优先加载 RDB 快照（二进制格式，加载效率高）。
   2. **数据安全性高**：RDB 之后的增量操作通过 AOF 日志恢复，减少数据丢失。
   3. **文件体积更小**：AOF 重写时仅保存 RDB 快照 + 增量日志，避免 AOF 文件过大。

   **适用场景**：

- 既需要快速恢复，又希望尽量减少数据丢失的场景（如缓存 + 持久化存储）。
- 生产环境中对数据完整性和可用性要求较高的场景。

### 二、**不适合混合持久化的场景**

   1. **纯缓存场景**  
      如果 Redis 仅用作缓存，数据可从后端数据库重建，**无需持久化**（关闭 RDB 和 AOF）。

      - 原因：持久化会增加磁盘 I/O 开销，降低性能。

   2. **对恢复速度要求极高**  
      如果需要极快的恢复速度（如秒杀系统），且能接受几分钟的数据丢失，**仅使用 RDB**。

      - 原因：RDB 加载速度比混合持久化更快（无需执行 AOF 命令）。

   3. **磁盘空间有限或写入性能敏感**  
      如果磁盘空间紧张或写入操作频繁（如高频统计系统），**仅使用 RDB**。

      - 原因：AOF（尤其是混合模式）会增加磁盘占用和写入负担。

   4. **需要兼容旧版本 Redis**  
      混合持久化的 AOF 文件格式不兼容 Redis 4.0 之前的版本，若需降级或迁移，需谨慎选择。

### 三、配置建议总结

| 场景                     | 持久化方案       | 关键配置参数                                                                 |
|--------------------------|------------------|------------------------------------------------------------------------------|
| 缓存（可接受数据丢失）   | 关闭持久化       | `save ""`<br>`appendonly no`                                                |
| 快速恢复（可接受少量丢失）| 仅 RDB           | `save 60 10000`<br>`appendonly no`                                        |
| 高安全性（数据不可丢失） | 混合持久化（默认推荐） | `appendonly yes`<br>`aof-use-rdb-preamble yes`                              |
| 高安全性 + 高性能写入    | AOF（everysec）  | `appendonly yes`<br>`appendfsync everysec`                                  |

### 四、最佳实践

1. **定期备份 RDB 文件**  
    无论使用哪种持久化方案，都建议定期（如每天）备份 RDB 快照到远程存储，以防磁盘故障。

2. **监控磁盘空间和性能**

    - AOF 文件会不断增长，需通过`auto-aof-rewrite-percentage`控制重写频率。
    - 混合模式下，RDB 快照会增加 AOF 文件的初始体积，需预留足够磁盘空间。

3. **测试恢复流程**  
    在生产环境部署前，务必测试 Redis 重启后的恢复流程，确保数据能正确恢复。

### 结论

**混合持久化（RDB+AOF）是 4.0 + 版本的首选方案**，但需根据业务需求权衡：

- **优先选混合**：若需要兼顾恢复速度和数据安全性。
- **选纯 RDB**：若对恢复速度要求极高，且能接受数据丢失。
- **选纯 AOF**：若对数据完整性要求苛刻（如金融场景）,那么建议开启 AOF，并采用`everysec`的同步策略。
- **关闭持久化**：若仅用作缓存。
  