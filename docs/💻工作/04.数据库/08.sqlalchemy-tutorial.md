---
title: SQLAlchemy 2.0 æ•™ç¨‹
date: 2022-12-23 09:53:42
permalink: /sqlalchemy-tutorial/
categories:
  - ğŸ’»å·¥ä½œ
  - æ•°æ®åº“
tags:
  - SQLAlchemy
link: https://yifei.me/note/2652
author: yifei
---

SQLAlchemy æ˜¯ Python ç”Ÿæ€ç³»ç»Ÿä¸­æœ€æµè¡Œçš„ ORMã€‚SQLAlchemy è®¾è®¡éå¸¸ä¼˜é›…ï¼Œåˆ†ä¸ºäº†ä¸¤éƒ¨åˆ†â€”â€”åº•å±‚çš„ Core å’Œä¸Šå±‚çš„ä¼ ç»Ÿ ORMã€‚åœ¨ Python ä¹ƒè‡³å…¶ä»–è¯­è¨€çš„å¤§å¤šæ•° ORM ä¸­ï¼Œéƒ½æ²¡æœ‰å®ç°å¾ˆå¥½çš„åˆ†å±‚è®¾è®¡ï¼Œ æ¯”å¦‚ django çš„ ORMï¼Œæ•°æ®åº“é“¾æ¥å’Œ ORM æœ¬èº«å®Œå…¨æ··åœ¨ä¸€èµ·ã€‚

![sqla_arch](https://docs.sqlalchemy.org/en/14/_images/sqla_arch_small.png)

SQLAlchemy å½“å‰ç‰ˆæœ¬æ˜¯ 1.4. æœ‰ä¸¤å¥— APIï¼Œ1.3 åŠä¹‹å‰çš„è€ API å’Œ 1.4 åŠä¹‹åçš„ 2.0 å…¼å®¹ APIã€‚æœ¬æ–‡ä¸­åªä»‹ç» 2.0 APIã€‚

ä¸ºä»€ä¹ˆè¦æœ‰ Core
----------

Core å±‚ä¸»è¦å®ç°äº†å®¢æˆ·ç«¯è¿æ¥æ± ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œä½œä¸ºç°ä»£ Web åº”ç”¨çš„æ ¸å¿ƒï¼Œå…³ç³»å‹æ•°æ®åº“çš„å¹¶å‘è¿æ¥èƒ½åŠ›å¾€å¾€å¹¶ä¸æ˜¯å¾ˆå¼ºï¼Œä¸€èˆ¬ä¸è¦æå¥½å¤šçŸ­è¿æ¥è¿‡å»ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹éœ€è¦ä¸€ä¸ªè¿æ¥æ± ã€‚è¿æ¥æ± å¤§ä½“åˆ†ä¸º ä¸¤ç§ï¼Œä¸€ç§åœ¨æœåŠ¡ç«¯ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªä¸“é—¨çš„è¿æ¥æ± ä¸­é—´ä»¶ï¼Œç»™çŸ­è¿æ¥æ¯æ¬¡åˆ†é…ä¸€ä¸ªé•¿é“¾æ¥å¤ç”¨ã€‚å¦ä¸€ç§åœ¨å®¢æˆ·ç«¯ï¼Œä¸€èˆ¬ä½œä¸ºç¬¬ä¸‰æ–¹åº“å¼•å…¥ä»£ç ä¸­ã€‚SQLAlchemy çš„è¿æ¥æ± æ˜¾ç„¶æ˜¯å®¢æˆ·ç«¯çš„ã€‚åœ¨è¿™ä¸ªè¿æ¥æ± ä¸­ï¼Œ SQLAlchemy ç»´æŠ¤äº†ä¸€å®šæ•°é‡çš„é•¿è¿æ¥ï¼Œå½“è°ƒç”¨ `connect` æ—¶ï¼Œå®é™…æ˜¯ä»æ± å­ä¸­å–å‡ºäº†ä¸€ä¸ªé“¾æ¥ï¼Œè°ƒç”¨ close æ—¶ï¼Œå®é™…æ˜¯æ”¾å›åˆ°äº†æ± å­ä¸­ä¸€ä¸ªé“¾æ¥ã€‚

åˆ›å»ºé“¾æ¥
----

SQLAlchemy ä¸­ä½¿ç”¨ `create_engine` æ¥åˆ›å»ºè¿æ¥ï¼ˆæ± ï¼‰ã€‚create\_engine çš„å‚æ•°æ˜¯æ•°æ®åº“çš„ URLã€‚

```python
from sqlalchemy import create_engine

engine = create_engine(
    "mysql://user:password@localhost:3306/dbname",
    echo=True,  # echo è®¾ä¸º True ä¼šæ‰“å°å‡ºå®é™…æ‰§è¡Œçš„ sqlï¼Œè°ƒè¯•çš„æ—¶å€™æ›´æ–¹ä¾¿
    future=True,  # ä½¿ç”¨ SQLAlchemy 2.0 APIï¼Œå‘åå…¼å®¹
    pool_size=5, # è¿æ¥æ± çš„å¤§å°é»˜è®¤ä¸º 5 ä¸ªï¼Œè®¾ç½®ä¸º 0 æ—¶è¡¨ç¤ºè¿æ¥æ— é™åˆ¶
    pool_recycle=3600, # è®¾ç½®æ—¶é—´ä»¥é™åˆ¶æ•°æ®åº“è‡ªåŠ¨æ–­å¼€
)

# åˆ›å»ºä¸€ä¸ª SQLite çš„å†…å­˜æ•°æ®åº“ï¼Œå¿…é¡»åŠ ä¸Š check_same_thread=Falseï¼Œå¦åˆ™æ— æ³•åœ¨å¤šçº¿ç¨‹ä¸­ä½¿ç”¨
engine = create_engine("sqlite:///:memory:", echo=True, future=True,
    connect_args={"check_same_thread": False})

# pip install mysqlclient
engine = create_engine('mysql+mysqldb://user:password@localhost/foo?charset=utf8mb4')
```

Core å±‚ -- ç›´æ¥ä½¿ç”¨ SQL
------------------

### CRUD

```python
from sqlachemy import text

with engine.connect() as conn:
    result = conn.execute(text("select * from users"))
    print(result.all())

# result å¯ä»¥éå†ï¼Œæ¯ä¸€ä¸ªè¡Œç»“æœæ˜¯ä¸€ä¸ª Row å¯¹è±¡
for row in result:
    # row å¯¹è±¡ä¸‰ç§è®¿é—®æ–¹å¼éƒ½æ”¯æŒ
    print(row.x, row.y)
    print(row[0], row[1])
    print(row["x"], row["y"])

# ä¼ é€’å‚æ•°ï¼Œä½¿ç”¨ `:var` ä¼ é€’
result = conn.execute(
    text("SELECT x, y FROM some_table WHERE y > :y"),
    {"y": 2}
)
# ä¹Ÿå¯ä»¥é¢„å…ˆç¼–è¯‘å¥½å‚æ•°
stmt = text("SELECT x, y FROM some_table WHERE y > :y ORDER BY x, y").bindparams(y=6)

# æ’å…¥æ—¶ï¼Œå¯ä»¥ç›´æ¥æ’å…¥å¤šæ¡
conn.execute(
    text("INSERT INTO some_table (x, y) VALUES (:x, :y)"),
    [{"x": 11, "y": 12}, {"x": 13, "y": 14}]
)
```

### äº‹åŠ¡ä¸ commit

SQLAlchemy æä¾›ä¸¤ç§æäº¤çš„æ–¹å¼ï¼Œä¸€ç§æ˜¯æ‰‹å·¥ commitï¼Œä¸€ç§æ˜¯åŠè‡ªåŠ¨ commitã€‚å®˜æ–¹æ–‡æ¡£å»ºè®®ä½¿ç”¨ engine.begin()ã€‚è¿˜æœ‰ä¸€ç§å®Œå…¨è‡ªåŠ¨çš„ï¼Œæ¯ä¸€è¡Œæäº¤ä¸€æ¬¡çš„ autocommit æ–¹å¼ï¼Œä¸å»ºè®®ä½¿ç”¨ã€‚

```python
# "commit as you go"  éœ€è¦æ‰‹åŠ¨ commit
with engine.connect() as conn:
    conn.execute(text("CREATE TABLE some_table (x int, y int)"))
    conn.execute(
        text("INSERT INTO some_table (x, y) VALUES (:x, :y)"),
        [{"x": 1, "y": 1}, {"x": 2, "y": 4}]
    )
    conn.commit()  # æ³¨æ„è¿™é‡Œçš„ commit

# "begin once"  åŠè‡ªåŠ¨ commit
with engine.begin() as conn:
    conn.execute(
        text("INSERT INTO some_table (x, y) VALUES (:x, :y)"),
        [{"x": 6, "y": 8}, {"x": 9, "y": 10}]
    )
```

ORM
---

Session **ä¸æ˜¯**çº¿ç¨‹å®‰å…¨çš„ã€‚ä½†æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œweb æ¡†æ¶åº”è¯¥åœ¨æ¯ä¸ªè¯·æ±‚å¼€å§‹æ—¶è·å–ä¸€ä¸ª sessionï¼Œ æ‰€ä»¥ä¹Ÿä¸æ˜¯é—®é¢˜ã€‚

```python
from sqlalchemy.orm import Session

with Session(engine) as session:
    session.add(foo)
    session.commit()

# è¿˜å¯ä»¥ä½¿ç”¨ sessionmaker æ¥åˆ›å»ºä¸€ä¸ªå·¥å‚å‡½æ•°ï¼Œè¿™æ ·å°±ä¸ç”¨æ¯æ¬¡éƒ½è¾“å…¥å‚æ•°äº†

from sqlachemy.orm import sessionmaker
new_session = sessionmaker(engine)

with new_session() as session:
    ...
```

### å£°æ˜å¼ API

* ä½¿ç”¨ `__tablename__` æŒ‡å®šæ•°æ®åº“è¡¨å
* ä½¿ç”¨ Column å£°æ˜æ¯ä¸ªå­—æ®µ
* ä½¿ç”¨ Integer/String... æŒ‡å®šå­—æ®µç±»å‹
* ä½¿ç”¨ index å‚æ•°æŒ‡å®šç´¢å¼•
* ä½¿ç”¨ unique å‚æ•°æŒ‡å®šå”¯ä¸€ç´¢å¼•
* ä½¿ç”¨ `__table_args__` æŒ‡å®šå…¶ä»–å±æ€§ï¼Œæ¯”å¦‚è”åˆç´¢å¼•

```python
from datetime import datetime
from sqlalchemy import Integer, Column, String, func, UniqueConstraint
from sqlalchemy.orm import declarative_base, relationship

Base = declarative_base()

class User(Base):
    __tablename__ = "users"
    __table_args__ = (UniqueConstraint("name", "time_created"),)
    id = Column(Integer, primary_key=True)
    name = Column(String(30), index=True)
    fullname = Column(String, unique=True)
    # å¯¹äºç‰¹åˆ«å¤§çš„å­—æ®µï¼Œè¿˜å¯ä»¥ä½¿ç”¨ deferredï¼Œè¿™æ ·é»˜è®¤ä¸åŠ è½½è¿™ä¸ªå­—æ®µ
    description = deferred(Column(Text))
    # é»˜è®¤å€¼ï¼Œæ³¨æ„ä¼ é€’çš„æ˜¯å‡½æ•°ï¼Œä¸æ˜¯ç°åœ¨çš„æ—¶é—´
    time_created = Column(DateTime(Timezone=True), default=datetime.now)
    # æˆ–è€…ä½¿ç”¨æœåŠ¡å™¨é»˜è®¤å€¼ï¼Œä½†æ˜¯å¿…é¡»åœ¨è¡¨åˆ›å»ºçš„æ—¶å€™å°±è®¾ç½®å¥½ï¼Œä¼šæˆä¸ºè¡¨çš„ schema çš„ä¸€éƒ¨åˆ†
    time_created = Column(DateTime(timezone=True), server_default=func.now())
    time_updated = Column(DateTime(timezone=True), onupdate=func.now())

class Address(Base):
    __tablename__ = "address"
    id = Column(Integer, primary_key=True)
    email_address = Column(String, nullable=False)

# è°ƒç”¨ create_all åˆ›å»ºæ‰€æœ‰æ¨¡å‹

Base.metadata.create_all(engine)

# å¦‚æœåªéœ€è¦åˆ›å»ºä¸€ä¸ªæ¨¡å‹

User.__table__.create(engine)
```

### å¤–é”®

ä½¿ç”¨ relationship æ¥åˆ¶å®šæ¨¡å‹ä¹‹é—´çš„å…³è”å…³ç³»ã€‚

ä¸€å¯¹å¤šå…³ç³»çš„åŒå‘æ˜ å°„

```python
from sqlalchemy import create_engine, Column, Integer, String, ForeignKey
from sqlalchemy.orm import declarative_base, relationship, Session

Base = declarative_base()

class Group(Base):
    __tablename__ = 'groups'
    id = Column(Integer, primary_key=True)
    name = Column(String)
    # å¯¹åº”çš„å¤šä¸ª usersï¼Œè¿™é‡Œä½¿ç”¨æ¨¡å‹åä½œä¸ºå‚æ•°
    members = relationship('User')

class User(Base):
    __tablename__ = 'users'
    id = Column(Integer, primary_key=True)
    name = Column(String)
    # group_id æ˜¯æ•°æ®åº“ä¸­çœŸå®å­˜åœ¨çš„å¤–é”®åï¼Œç¬¬äºŒä¸ªå­—æ®µ ForeignKey ç”¨æ¥æŒ‡å®šå¯¹åº”çš„ ID
    group_id = Column(Integer, ForeignKey('groups.id'))
    # æ¨¡å‹ä¸­å¯¹åº”çš„ group å­—æ®µï¼Œéœ€è¦å£°æ˜å’Œå¯¹åº”æ¨¡å‹ä¸­çš„å“ªä¸ªå­—æ®µæ˜¯é‡åˆçš„
    group = relationship('Group', overlaps="members")
```

å¤šå¯¹å¤šæ˜ å°„ï¼Œéœ€è¦ä½¿ç”¨ä¸€ä¸ªå…³è”è¡¨ã€‚

```python
# å…³è”è¡¨
class UserPermissions(Base):
    __tablename__ = 'user_permissions'
    id = Column(Integer, primary_key=True)
    # åŒæ ·ç”¨ foreign key æŒ‡å®šå¤–é”®
    user_id = Column(Integer, ForeignKey('users.id'))
    permission_id = Column(String, ForeignKey('permissions.id'))

class User(Base):
    __tablename__ = 'users'
    id = Column(Integer, primary_key=True)
    name = Column(String)
    # ä½¿ç”¨ secondary æŒ‡å®šå…³è”è¡¨ï¼ŒåŒæ ·ç”¨ overlaps æŒ‡å®šå¯¹åº”æ¨¡å‹ä¸­çš„å­—æ®µ
    permissions = relationship('Permission', secondary="user_permissions", overlaps="users")

class Permission(Base):
    __tablename__ = 'permissions'
    id = Column(Integer, primary_key=True)
    name = Column(String)
    # åŒä¸Š
    users = relationship('User', secondary="user_permissions", overlaps="permissions")


user1 = User(name='user1', group_id=1)
user2 = User(name='user2')
group1 = Group(name='group1')
group2 = Group(name='group2', members=[user2])
permission1 = Permission(name="open_file")
permission2 = Permission(name="save_file")
user1.permissions.append(permission1)

db.add_all([user1, user2, group1, group2, permission1, permission2])

db.commit()

print(user1.permissions[0].id)
```

å…¶ä»–çš„æ•™ç¨‹ä¸­å¤§å¤šä½¿ç”¨ `backref` æ¥ç”Ÿæˆå¯¹åº”æ¨¡å‹çš„å±æ€§ï¼Œæˆ‘å¹¶ä¸å–œæ¬¢è¿™æ ·ï¼Œæ›´å€¾å‘äºåœ¨å¯¹åº”çš„æ¨¡å‹ä¸­ éƒ½æ˜¾å¼å£°æ˜å¯ä»¥è®¿é—®çš„å±æ€§ã€‚

### CRUD

å’Œ 1.x API ä¸åŒï¼Œ2.0 API ä¸­ä¸å†ä½¿ç”¨ queryï¼Œè€Œæ˜¯ä½¿ç”¨ select æ¥æŸ¥è¯¢æ•°æ®ã€‚ç½‘ä¸Šçš„è¯¸å¤šæ•™ç¨‹è¿˜åœ¨ è®²è§£ query APIï¼Œæœ€å¥½ä¸è¦å‚è€ƒè¿™äº›æ•™ç¨‹äº†ã€‚

```python
from sqlalchemy import select

# where çš„å‚æ•°æ˜¯ `==` æ„æˆçš„è¡¨è¾¾å¼ï¼Œå¥½å¤„æ˜¯å†™ä»£ç çš„æ—¶å€™ï¼Œæ‹¼å†™é”™è¯¯å°±ä¼šè¢«æ£€æŸ¥åˆ°
stmt = select(User).where(User.name == "john").order_by(User.id)
# filter_by ä½¿ç”¨ **kwargs ä½œä¸ºå‚æ•°
stmt = select(User).filter_by(name="some_user")
# order_by è¿˜å¯ä»¥ä½¿ç”¨ User.id.desc() è¡¨ç¤ºé€†åºæ’åˆ—

result = session.execute(stmt)

# ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå½“é€‰å–æ•´ä¸ªå¯¹è±¡çš„æ—¶å€™ï¼Œéƒ½è¦ç”¨ scalars æ–¹æ³•ï¼Œå¦åˆ™è¿”å›çš„æ˜¯ä¸€ä¸ªåŒ…å«ä¸€ä¸ªå¯¹è±¡çš„ tuple
for user in result.scalars():
    print(user.name)

# æŸ¥è¯¢æ¨¡å‹å•ä¸ªå±æ€§æ—¶ï¼Œä¸éœ€è¦ä½¿ç”¨ scalars
result = session.execute(select(User.name))
for row in result:
    print(row.name)

# æŒ‰ç…§ id æŸ¥è¯¢è¿˜æœ‰ä¸€ä¸ªå¿«æ·æ–¹å¼ï¼š
user = session.get(User, pk=1)

# æ›´æ–°æ•°æ®éœ€è¦ä½¿ç”¨ update è¯­å¥
from sqlalchemy import update
# synchronize_session æœ‰ä¸‰ç§é€‰é¡¹ï¼š false, "fetch", "evaluate"ï¼Œé»˜è®¤æ˜¯ evaluate
# false è¡¨ç¤ºå®Œå…¨ä¸æ›´æ–° Python ä¸­çš„å¯¹è±¡
# fetch è¡¨ç¤ºé‡æ–°ä»æ•°æ®åº“ä¸­åŠ è½½ä¸€ä»½å¯¹è±¡
# evaluate è¡¨ç¤ºåœ¨æ›´æ–°æ•°æ®åº“çš„åŒæ—¶ï¼Œä¹Ÿå°½é‡åœ¨ Python ä¸­çš„å¯¹è±¡ä¸Šä½¿ç”¨åŒæ ·çš„æ“ä½œ
stmt = update(User).where(User.name == "john").values(name="John").execution_options(synchronize_session="fetch")
session.execute(stmt)

# æˆ–è€…ç›´æ¥å¯¹å±æ€§èµ‹å€¼
user.name = "John"
session.commit()

# è¿™é‡Œæœ‰ä¸€ä¸ªå¯èƒ½å¼•å…¥ race conditionï¼ˆç«æ€æ¡ä»¶ï¼‰çš„åœ°æ–¹
# é”™è¯¯ï¼å¦‚æœä¸¤ä¸ªè¿›ç¨‹åŒæ—¶æ›´æ–°è¿™ä¸ªå€¼ï¼Œå¯èƒ½å¯¼è‡´åªæ›´æ–°äº†ä¸€ä¸ªå€¼ã€‚
# ä¸¤è€…éƒ½èµ‹å€¼ä¸ºè‡ªèº«è®¤ä¸ºçš„æ­£ç¡®å€¼ 2ï¼Œå®é™…æ­£ç¡®å€¼ä¸º 1 + 1 + 1 = 3
# å¯¹åº” SQLï¼šUpdate users set visit_count = 2 where user.id = 1
user.visit_count += 1
# æ­£ç¡®åšæ³•ï¼šæ³¨æ„å¤§å†™çš„ Uï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨äº†æ¨¡å‹çš„å±æ€§ï¼Œç”Ÿæˆçš„ SQL æ˜¯åœ¨ SQL æœåŠ¡ç«¯ +1
# å¯¹åº” SQL: Update users set visit_count = visit_count + 1 where user.id = 1
user.visit_count = User.visit_count + 1

# æ·»åŠ å¯¹è±¡ç›´æ¥ä½¿ç”¨ session.add æ–¹æ³•
session.add(user)
# æˆ–è€… add_all
session.add_all([user1, user2, group1])

# å¦‚æœè¦è·å–æ’å…¥åçš„ IDï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ commit ä¹‹åå†è¯»
session.flush()   # flush å¹¶ä¸æ˜¯ commitï¼Œå¹¶æ²¡æœ‰æäº¤äº‹åŠ¡ï¼Œåº”è¯¥æ˜¯å¯é‡å¤è¯»ï¼Œå’Œæ•°æ®åº“çš„éš”ç¦»çº§åˆ«æœ‰å…³ã€‚
print(user.id)

# åˆ é™¤ä½¿ç”¨ session.delete
session.delete(user)
```

### åŠ è½½å¤–é”®å…³è”æ¨¡å‹

å¦‚æœæˆ‘ä»¬åœ¨è¯»å–ä¸€ä¸ª N ä¸ªè®°å½•çš„åˆ—è¡¨ä¹‹åï¼Œå†å»æ•°æ®åº“ä¸­ä¸€ä¸€è¯»å–æ¯ä¸ªé¡¹ç›®çš„å…·ä½“å€¼ï¼Œå°±ä¼šäº§ç”Ÿ N+1 ä¸ª æŸ¥è¯¢ã€‚è¿™å°±æ˜¯æ•°æ®åº“ä¸­æœ€å¸¸çŠ¯çš„é”™è¯¯ï¼šN+1 é—®é¢˜ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒæŸ¥è¯¢ä¸­ä¸ä¼šåŠ è½½å¤–é”®å…³è”çš„æ¨¡å‹ï¼Œå¯ä»¥ä½¿ç”¨ selectinload é€‰é¡¹æ¥åŠ è½½å¤–é”®ï¼Œä»è€Œé¿å… N+1 é—®é¢˜ã€‚`select(Model).options(selectinload(Model.field))`

```python
- session.execute(select(User)).scalars().all()  # æ²¡æœ‰åŠ è½½ parent å¤–é”®
+ session.execute(select(User).options(selectinload(User.groups))).scalars().all()
```

Selectinload çš„åŸç†åœ¨äºä½¿ç”¨äº† `select in` å­æŸ¥è¯¢ï¼Œè¿™ä¹Ÿæ˜¯åå­—çš„åˆæ¥ã€‚é™¤äº† selectinload å¤–ï¼Œ è¿˜å¯ä»¥ä½¿ç”¨ä¼ ç»Ÿçš„ joinedloadï¼Œå®ƒçš„åŸç†å°±æ˜¯æœ€æ™®é€šçš„ join table

```python
# ä½¿ç”¨ joinedload åŠ è½½å¤–é”®ï¼Œæ³¨æ„éœ€è¦ä½¿ç”¨ unique æ–¹æ³•ï¼Œè¿™æ˜¯ 2.0 ä¸­è§„å®šçš„ã€‚
session.execute(select(User).options(joinedload(User.groups))).unique().scalars().all()
```

åœ¨ 2.0 ä¸­ï¼Œæ›´æ¨èä½¿ç”¨ selectinload è€Œä¸æ˜¯ joinedloadï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œselectinload éƒ½è¦å¥½ï¼Œ è€Œä¸”ä¸ç”¨ä½¿ç”¨ unique.

### å¤–é”®çš„å†™å…¥

SQLAlchemy ä¸­ï¼Œç›´æ¥åƒå¤„ç†æ•°ç»„ä¸€æ ·å¤„ç†å¤–é”®å°±å¥½äº†ï¼Œè¿™ç‚¹éå¸¸æ–¹ä¾¿ã€‚

```python
user.permissions.append(open_permission)  # æ·»åŠ 
user.permissions.remove(save_permission)  # åˆ é™¤
# æ¸…ç©ºæ‰€æœ‰å¤–é”®
user.permissions.clear()
user.permissions = []
```

### JSON å­—æ®µçš„ç‰¹æ®Šå¤„ç†

å¤§å¤šæ•°çš„æ•°æ®åº“ç°åœ¨éƒ½æ”¯æŒ JSON å­—æ®µäº†ï¼Œåœ¨ SQLAlchemy ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ä»å­—æ®µè¯»å– json å¯¹è±¡ æˆ–è€…å†™å…¥ json å¯¹è±¡ã€‚ä½†æ˜¯ï¼Œåƒä¸‡ä¸è¦ç›´æ¥å¯¹è¿™ä¸ª json å¯¹è±¡åš update å¹¶æœŸæœ›å†™å›æ•°æ®åº“ä¸­ï¼Œè¿™æ˜¯ ä¸å¯é çš„ã€‚ä¸€å®šè¦å¤åˆ¶åè¯»å†™ï¼Œç„¶åå†èµ‹å€¼å›å»ã€‚

```python
    article = session.get(Article, 1)
    tags = copy.copy(article.tags)
    tags.append("iOS")
    article.tags = tags
    session.commit()
```

### æ‰¹é‡æ’å…¥

å½“éœ€è¦æ’å…¥å¤§é‡æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœä¾ç„¶é‡‡ç”¨é€ä¸ªæ’å…¥çš„æ–¹æ³•ï¼Œé‚£ä¹ˆå°±ä¼šåœ¨å’Œæ•°æ®åº“çš„äº¤äº’ä¸Šæµªè´¹å¾ˆå¤š æ—¶é—´ï¼Œæ•ˆç‡å¾ˆä½ã€‚MySQL ç­‰å¤§å¤šæ•°æ•°æ®åº“éƒ½æä¾›äº† `insert ... values (...), (...) ...` è¿™ç§ æ‰¹é‡æ’å…¥çš„ APIï¼Œåœ¨ SQLAlchemy ä¸­ä¹Ÿå¯ä»¥å¾ˆå¥½åœ°åˆ©ç”¨è¿™ä¸€ç‚¹ã€‚

```python
# ä½¿ç”¨ session.bulk_save_objects(...) ç›´æ¥æ’å…¥å¤šä¸ªå¯¹è±¡

s = Session()
objects = [
    User(name="u1"),
    User(name="u2"),
    User(name="u3")
]
s.bulk_save_objects(objects)
s.commit()

# ä½¿ç”¨ bulk_insert_mappings å¯ä»¥çœå»åˆ›å»ºå¯¹è±¡çš„å¼€é”€ï¼Œç›´æ¥æ’å…¥å­—å…¸
users = [
    {"name": "u1"},
    {"name": "u2"},
    {"name": "u3"},
]
s.bulk_insert_mappings(User, users)
s.commit()

# ä½¿ç”¨ bulk_update_mappings å¯ä»¥æ‰¹é‡æ›´æ–°å¯¹è±¡ï¼Œå­—å…¸ä¸­çš„ id ä¼šè¢«ç”¨ä½œ where æ¡ä»¶ï¼Œ
# å…¶ä»–å­—æ®µå…¨éƒ¨ç”¨äºæ›´æ–°
session.bulk_update_mappings(User, users)
```

ä» 1.X API è¿ç§»åˆ° 2.0 API
---------------------

```python
- session.query(User).get(42)
+ session.get(User, 42)

- session.query(User).all()
+ session.execute(select(User)).scalars().all()

- session.query(User).filter_by(name="some_user").one()
+ session.execute(select(User).filter_by(name="some_user")).scalar_one()

- session.query(User).from_statememt(text("select * from users")).a..()
+ session.execute(select(User).from_statement(text("selct * from users"))).scalars().all()

- session.query(User).filter(User.name == "foo").update({"fullname": "FooBar"}, synchronize_session="evaluate")
+ session.execute(update(User).where(User.name == "foo").values(fullname="FooBar").execute_options(synchronize_session="evaluate"))
```

import
------

SQLAlchemy çš„å¯¼å‡ºç±»å‹ä¸»è¦åˆ†å¸ƒåœ¨ä»¥ä¸‹ä¸‰ä¸ªéƒ¨åˆ†ï¼š

```python
# SQL ç›¸å…³çš„ç›´æ¥ä»æ ¹ç›®å½•å¯¼å…¥ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ Column å’Œ Integer ä¹Ÿåœ¨è¿™é‡Œ
from sqlalchemy import text, insert, select, create_engine, Column, Integer, String

# ORM ç›¸å…³çš„ä» orm å­åŒ…ä¸­å¯¼å…¥
from sqlalchemy.orm import declarative_base, Session, sessionmaker

# å¼‚å¸¸ä» exc ä¸­å¯¼å…¥
from sqlalchemy.exc import IntegrityError, SQLAlchemyError
```

### åå°„â€”â€”ä»æ•°æ®åº“åˆ›å»ºæ¨¡å‹

TODO

åœ¨ FastAPI ä¸­ä½¿ç”¨
-------------

å¤šè¿›ç¨‹ç¯å¢ƒä¸‹çš„ä½¿ç”¨
---------

ç”±äº Python ä¸­ GIL çš„åŸå› ï¼Œè¦åˆ©ç”¨å¤šæ ¸å¤„ç†å™¨éœ€è¦ä½¿ç”¨å¤šè¿›ç¨‹ã€‚è€Œå¤šè¿›ç¨‹ä¸­ï¼Œèµ„æºå¹¶ä¸èƒ½å…±äº«ï¼Œ å¯¹åº”åˆ° SQLAlchemyï¼Œä¹Ÿå°±æ˜¯è¿æ¥æ± ä¸èƒ½å…±äº«ã€‚

æˆ‘ä»¬éœ€è¦æ‰‹å·¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæœ€å¥½ä¸è¦å°è¯•åœ¨å¤šä¸ªè¿›ç¨‹ä¸­å…±äº«åŒä¸€ä¸ª Sessionã€‚æœ€å¥½åœ¨æ¯ä¸ªè¿›ç¨‹åˆå§‹åŒ–æ—¶åˆ›å»º Sessionã€‚

### ä»…åœ¨è®¾å®šå€¼æ—¶å¢åŠ  where æ¡ä»¶

åœ¨ URL ä¸­ï¼Œç»å¸¸éœ€è¦æ ¹æ®ç”¨æˆ·æŒ‡å®šäº†å“ªäº›é€‰é¡¹æ¥è¿”å›å¯¹åº”çš„ç»“æœã€‚

```python
query = select(User)
if username is not None:
    query = query.where(User.username == username)
if password is not None:
    query = query.where(User.password == password)
```

## å‚è€ƒ

0. [åŸæ–‡](https://yifei.me/note/2652)
1. [https://docs.sqlalchemy.org/en/14/tutorial/orm\_related\_objects.html](https://docs.sqlalchemy.org/en/14/tutorial/orm_related_objects.html)
2. [https://stackoverflow.com/questions/25668092/flask-sqlalchemy-many-to-many-insert-data](https://stackoverflow.com/questions/25668092/flask-sqlalchemy-many-to-many-insert-data)
3. [https://stackoverflow.com/questions/9667138/how-to-update-sqlalchemy-row-entry](https://stackoverflow.com/questions/9667138/how-to-update-sqlalchemy-row-entry)
4. [https://docs.sqlalchemy.org/en/14/changelog/migration\_20.html](https://docs.sqlalchemy.org/en/14/changelog/migration_20.html)
5. [https://stackoverflow.com/questions/13370317/sqlalchemy-default-datetime](https://stackoverflow.com/questions/13370317/sqlalchemy-default-datetime)
6. [https://amercader.net/blog/beware-of-json-fields-in-sqlalchemy/](https://amercader.net/blog/beware-of-json-fields-in-sqlalchemy/)
7. [https://stackoverflow.com/questions/26948397/how-to-delete-records-from-many-to-many-secondary-table-in-sqlalchemy](https://stackoverflow.com/questions/26948397/how-to-delete-records-from-many-to-many-secondary-table-in-sqlalchemy)
8. [Count by many to many foreign key](https://stackoverflow.com/questions/22876946/how-to-order-by-count-of-many-to-many-relationship-in-sqlalchemy "null")
9. [https://stackoverflow.com/questions/19175311/how-to-create-only-one-table-with-sqlalchemy/19175907](https://stackoverflow.com/questions/19175311/how-to-create-only-one-table-with-sqlalchemy/19175907)
10. [https://stackoverflow.com/questions/63220132/sqlalchemy-insert-to-mysql-db-unicodeencodeerror-for-cyrlic-data](https://stackoverflow.com/questions/63220132/sqlalchemy-insert-to-mysql-db-unicodeencodeerror-for-cyrlic-data)
11. [https://stackoverflow.com/questions/41279157/connection-problems-with-sqlalchemy-and-multiple-processes](https://stackoverflow.com/questions/41279157/connection-problems-with-sqlalchemy-and-multiple-processes)
12. [https://docs.sqlalchemy.org/en/14/core/pooling.html](https://docs.sqlalchemy.org/en/14/core/pooling.html)
13. [https://stackoverflow.com/questions/10059345/sqlalchemy-unique-across-multiple-columns](https://stackoverflow.com/questions/10059345/sqlalchemy-unique-across-multiple-columns)
14. [https://stackoverflow.com/questions/22876946/how-to-order-by-count-of-many-to-many-relationship-in-sqlalchemy](https://stackoverflow.com/questions/22876946/how-to-order-by-count-of-many-to-many-relationship-in-sqlalchemy)
