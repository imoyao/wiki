---
title: å­˜å‚¨æœåŠ¡ï¼ˆOSDï¼‰ç›¸å…³

categories: 
  - ğŸ’» å·¥ä½œ
  - å­˜å‚¨
  - CEPH
  - Ceph è¿ç»´
date: 2020-12-11 12:49:17
permalink: /pages/76e927/
tags: 
---
# 1.è¯´æ˜
## 1.1 ä»‹ç»
`OSD`å…¨ç§°`Object Storage Device`ï¼Œæ˜¯è´Ÿè´£å“åº”å®¢æˆ·ç«¯è¯·æ±‚å¹¶è¿”å›å…·ä½“æ•°æ®çš„è¿›ç¨‹ï¼›ä¸€ä¸ª Ceph é›†ç¾¤ä¸€èˆ¬æœ‰å¤šä¸ª OSDï¼›

# 2. å¸¸ç”¨æ“ä½œ
## 2.1 æŸ¥çœ‹ osd çŠ¶æ€
```plain
$ ceph osd stat
5 osds: 5 up, 5 in
```
**çŠ¶æ€è¯´æ˜ï¼š**
- é›†ç¾¤å†…(in)
- é›†ç¾¤å¤–(out)
- æ´»ç€ä¸”åœ¨è¿è¡Œ(up)
- æŒ‚äº†ä¸”ä¸å†è¿è¡Œ(down)

**è¯´æ˜ï¼š** 
- å¦‚æœ OSD æ´»ç€ï¼Œå®ƒä¹Ÿå¯ä»¥æ˜¯ in æˆ–è€… out é›†ç¾¤ï¼›å¦‚æœå®ƒä»¥å‰æ˜¯ in ä½†æœ€è¿‘ out äº†ï¼Œ Ceph ä¼šæŠŠå…¶å½’ç½®ç»„è¿ç§»åˆ°å…¶ä»– OSD ï¼›
- å¦‚æœ OSD out äº†ï¼Œ CRUSH å°±ä¸ä¼šå†åˆ†é…å½’ç½®ç»„ç»™å®ƒï¼›å¦‚æœå®ƒæŒ‚äº†ï¼ˆ down ï¼‰å…¶çŠ¶æ€ä¹Ÿåº”è¯¥æ˜¯ out ï¼›
- å¦‚æœ OSD çŠ¶æ€ä¸º down ä¸” in ï¼Œå¿…å®šæœ‰é—®é¢˜ï¼Œè€Œä¸”é›†ç¾¤å¤„äºéå¥åº·çŠ¶æ€ï¼›


## 2.2 æŸ¥çœ‹ osd æ˜ å°„ä¿¡æ¯
```plain
$ ceph osd dump
epoch 4971
fsid 97219550-d917-4154-b745-32bac14f99f2
created 2017-08-31 16:14:26.155920
modified 2017-11-15 13:48:39.834169
flags sortbitwise,recovery_deletes
crush_version 113
full_ratio 0.95
backfillfull_ratio 0.9
nearfull_ratio 0.85
require_min_compat_client jewel
min_compat_client jewel
require_osd_release luminous
pool 1 'rbd' replicated size 3 min_size 2 crush_rule 0 object_hash rjenkins pg_num 2048 pgp_num 2048 last_change 3845 lfor 0/187 flags hashpspool stripe_width 0 application rbd
 removed_snaps [1~3,7~8,11~5,17~4,1c~4,21~1]
pool 2 'test_data' replicated size 3 min_size 2 crush_rule 0 object_hash rjenkins pg_num 512 pgp_num 512 last_change 1575 lfor 0/227 flags hashpspool stripe_width 0 application cephfs
 removed_snaps [1~3,5~4]
osd.0 up in weight 1 up_from 4959 up_thru 4966 down_at 4789 last_clean_interval [4551,4788) 10.1.1.34:6817/477028 10.1.1.34:6818/477028 10.1.1.34:6819/477028 10.1.1.34:6820/477028 exists,up 1c43b2d1-fc59-4e55-8511-2480964fef41
osd.1 up in weight 1 up_from 4577 up_thru 4966 down_at 4575 last_clean_interval [4521,4574) 10.1.1.34:6825/338609 10.1.1.34:6827/338609 10.1.1.34:6841/338609 10.1.1.34:6844/338609 exists,up 68630ac4-09a4-4b50-9dba-4bbe161bc6b3
osd.2 up in weight 1 up_from 4568 up_thru 4966 down_at 4566 last_clean_interval [4533,4565) 10.1.1.34:6805/337916 10.1.1.34:6806/337916 10.1.1.34:6807/337916 10.1.1.34:6808/337916 exists,up 752ffd2c-6cdc-4377-bbde-b89a5a46f449
osd.3 up in weight 1 up_from 4572 up_thru 4966 down_at 4570 last_clean_interval [4529,4569) 10.1.1.34:6801/338244 10.1.1.34:6802/338244 10.1.1.34:6803/338244 10.1.1.34:6804/338244 exists,up c59c5ef7-6f55-4fe5-9952-4f4c602b4c1a
osd.4 up in weight 1 up_from 4564 up_thru 4966 down_at 4562 last_clean_interval [4537,4561) 10.1.1.34:6809/337796 10.1.1.34:6810/337796 10.1.1.34:6811/337796 10.1.1.34:6812/337796 exists,up d264e02b-3f93-4125-a40b-8e1515158b3c
```

## 2.3 æŸ¥çœ‹ osd ç›®å½•æ ‘
```plain
$ ceph osd tree
ID  CLASS WEIGHT    TYPE NAME                 STATUS REWEIGHT PRI-AFF
 -1       200.12276 root default
 -3        40.02455     host ceph-xx-osd00
  0   hdd   3.63860         osd.0                 up  1.00000 1.00000
  1   hdd   3.63860         osd.1                 up  1.00000 1.00000
  2   hdd   3.63860         osd.2                 up  1.00000 1.00000
  3   hdd   3.63860         osd.3                 up  1.00000 1.00000
  4   hdd   3.63860         osd.4                 up  1.00000 1.00000
```

## 2.4 ä¸‹çº¿ osd
```plain
#è®©ç¼–å·ä¸º0çš„osd down æ‰,æ­¤æ—¶è¯¥ osd ä¸æ¥å—è¯»å†™è¯·æ±‚,ä½† osd è¿˜æ˜¯å­˜æ´»çš„
 
$ ceph osd down 0
marked down osd.0.
 
$ ceph osd tree
ID  CLASS WEIGHT    TYPE NAME                 STATUS REWEIGHT PRI-AFF
 -1       200.12276 root default
 -3        40.02455     host ceph-xx-osd00
  0   hdd   3.63860         osd.0               down  1.00000 1.00000
  1   hdd   3.63860         osd.1                 up  1.00000 1.00000
  2   hdd   3.63860         osd.2                 up  1.00000 1.00000
  3   hdd   3.63860         osd.3                 up  1.00000 1.00000
  4   hdd   3.63860         osd.4                 up  1.00000 1.00000
```

## 2.5 æ‹‰èµ· osd
```plain
#è®©ç¼–å·ä¸º0çš„osd up æ‰,æ­¤æ—¶è¯¥ osd æ¥å—è¯»å†™è¯·æ±‚
 
$ ceph osd up 0
marked up osd.0.
 
$ ceph osd tree
ID  CLASS WEIGHT    TYPE NAME                 STATUS REWEIGHT PRI-AFF
 -1       200.12276 root default
 -3        40.02455     host ceph-bench-osd00
  0   hdd   3.63860         osd.0                 up  1.00000 1.00000
  1   hdd   3.63860         osd.1                 up  1.00000 1.00000
  2   hdd   3.63860         osd.2                 up  1.00000 1.00000
  3   hdd   3.63860         osd.3                 up  1.00000 1.00000
  4   hdd   3.63860         osd.4                 up  1.00000 1.00000
```

## 2.6 osd é€å‡ºé›†ç¾¤
```plain
#å°†ä¸€ä¸ª osd é€å‡ºé›†ç¾¤,å³ä¸‹çº¿ä¸€ä¸ª osd,æ­¤æ—¶å¯ä»¥å¯¹è¯¥ osd è¿›è¡Œç»´æŠ¤
$ ceph osd out 0
```

## 2.7 osd åŠ å…¥é›†ç¾¤
```plain
#æŠŠä¸€ä¸ª osd åŠ å…¥é›†ç¾¤,å³ä¸Šçº¿ä¸€ä¸ª osd
$ ceph osd in 0
```

## 2.8 åˆ é™¤ osd
```plain
#åœ¨é›†ç¾¤ä¸­åˆ é™¤ä¸€ä¸ª osd,å¯èƒ½éœ€è¦å…ˆ stop è¯¥ osd,å³ stop osd.0
$ ceph osd rm 0
```

## 2.9 ä» crush map ä¸­åˆ é™¤ osd
```plain
#ä» crush map ä¸­åˆ é™¤ä¸€ä¸ª osd
$ ceph osd crush rm osd.0
```

## 2.10 åˆ é™¤ host èŠ‚ç‚¹
```plain
#åœ¨é›†ç¾¤ä¸­åˆ é™¤ä¸€ä¸ªhostèŠ‚ç‚¹
$ ceph osd crush rm node1
```

## 2.11 æŸ¥çœ‹æœ€å¤§ osd ä¸ªæ•°
```plain
#æŸ¥çœ‹æœ€å¤§osdçš„ä¸ªæ•°ï¼Œé»˜è®¤æœ€å¤§æ˜¯4ä¸ªosdèŠ‚ç‚¹
$ ceph osd getmaxosd
```

## 2.12 è®¾ç½®æœ€å¤§ osd ä¸ªæ•°
```plain
#è®¾ç½®æœ€å¤§osdçš„ä¸ªæ•°ï¼Œå½“æ‰©å¤§osdèŠ‚ç‚¹çš„æ—¶å€™å¿…é¡»æ‰£å¤§è¿™ä¸ªå€¼
$ ceph osd setmaxosd 60
```

## 2.13 è®¾ç½®æœ€å¤§ osd ä¸ªæ•°
```plain
#è®¾ç½®æœ€å¤§osdçš„ä¸ªæ•°ï¼Œå½“æ‰©å¤§osdèŠ‚ç‚¹çš„æ—¶å€™å¿…é¡»æ‰£å¤§è¿™ä¸ªå€¼
$ ceph osd setmaxosd 60
```

## 2.14 è®¾ç½® osd çš„ crush æƒé‡
```plain
#ceph osd crush set {id} {weight} [{loc1} [{loc2} ...]]

$ ceph osd crush set 3 3.0 host=node4
#æˆ–è€…
$ ceph osd crush reweight osd.3 1.0
```

## 2.15 è®¾ç½® osd çš„æƒé‡
```plain
#ceph osd reweight {id} {weight}
$ ceph osd reweight 3 0.5
```

## 2.16 æš‚åœ osd
```plain
#æš‚åœåæ•´ä¸ªé›†ç¾¤ä¸å†æ¥æ”¶æ•°æ®
$ ceph osd pause
```

## 2.17  å¼€å¯ osd
```plain
#å¼€å¯åå†æ¬¡æ¥æ”¶æ•°æ®
$ ceph osd unpause
```

## 2.18 æŸ¥çœ‹ osd å‚æ•°é…ç½®
```plain
#æŸ¥çœ‹æŸä¸ªosdçš„é…ç½®å‚æ•°
$ ceph --admin-daemon /var/run/ceph/ceph-osd.2.asok config show | less
```

## 2.19 osd æ‰“æ‘†å­
```plain
#æˆ‘ä»¬å»ºè®®åŒæ—¶éƒ¨ç½²å…¬ç½‘ï¼ˆå‰ç«¯ï¼‰å’Œé›†ç¾¤ç½‘ï¼ˆåç«¯ï¼‰ï¼Œè¿™æ ·èƒ½æ›´å¥½åœ°æ»¡è¶³å¯¹è±¡å¤åˆ¶çš„å®¹é‡éœ€æ±‚ã€‚
#ç„¶è€Œï¼Œå¦‚æœé›†ç¾¤ç½‘ï¼ˆåç«¯ï¼‰å¤±è´¥ã€æˆ–å‡ºç°äº†æ˜æ˜¾çš„å»¶æ—¶ï¼ŒåŒæ—¶å…¬ç½‘ï¼ˆå‰ç«¯ï¼‰å´è¿è¡Œè‰¯å¥½ï¼Œ OSD ç°åœ¨ä¸èƒ½å¾ˆå¥½åœ°å¤„ç†è¿™ç§æƒ…å†µã€‚
#è¿™æ—¶ OSD ä»¬ä¼šå‘ç›‘è§†å™¨æŠ¥å‘Šé‚»å±… down äº†ã€åŒæ—¶æŠ¥å‘Šè‡ªå·±æ˜¯ up çš„ï¼Œæˆ‘ä»¬æŠŠè¿™ç§æƒ…å½¢ç§°ä¸ºæ‰“æ‘†å­ï¼ˆ flapping ï¼‰ã€‚
#å¦‚æœæœ‰ä¸œè¥¿å¯¼è‡´ OSD æ‰“æ‘†å­ï¼ˆåå¤åœ°è¢«æ ‡è®°ä¸º down ï¼Œç„¶ååˆ up ï¼‰ï¼Œä½ å¯ä»¥å¼ºåˆ¶ç›‘è§†å™¨åœæ­¢ã€‚ ä¸»è¦ç”¨äºosdæŠ–åŠ¨çš„æ—¶å€™
 
$ ceph osd set noup      # prevent OSDs from getting marked up
$ ceph osd set nodown    # prevent OSDs from getting marked down
 
#è¿™äº›æ ‡è®°è®°å½•åœ¨ osdmap æ•°æ®ç»“æ„é‡Œï¼š
ceph osd dump | grep flags
flags no-up,no-down
 
#ä¸‹åˆ—å‘½ä»¤å¯æ¸…é™¤æ ‡è®°ï¼š
ceph osd unset noup
ceph osd unset nodown
```

## 2.20 osd åŠ¨æ€ä¿®æ”¹å‚æ•°
```plain
#ä¿®æ”¹æ‰€æœ‰osdå‚æ•°,é‡å¯å¤±æ•ˆï¼Œéœ€è¦å†™åˆ°é…ç½®æ–‡ä»¶ä¸­æŒä¹…åŒ–
$ ceph tell osd.* injectargs "--rbd_default_format 2 "   
```

## 2.21 æŸ¥çœ‹å»¶è¿Ÿæƒ…å†µ
```plain
#ä¸»è¦è§£å†³å•å—ç£ç›˜é—®é¢˜ï¼Œå¦‚æœæœ‰é—®é¢˜åº”åŠæ—¶å‰”é™¤osdã€‚ç»Ÿè®¡çš„æ˜¯å¹³å‡å€¼
#fs_commit_latency è¡¨ç¤ºä»æ¥æ”¶è¯·æ±‚åˆ°è®¾ç½® commit çŠ¶æ€çš„æ—¶é—´é—´éš”
#é€šè¿‡ fs_apply_latency è¡¨ç¤ºä»æ¥å—è¯·æ±‚åˆ°è®¾ç½®ä¸º apply çŠ¶æ€çš„æ—¶é—´é—´éš”
 
$ ceph osd perf
osd commit_latency(ms) apply_latency(ms)
 0 0 0
 1 37 37
 2 0 0
```

## 2.22 ä¸»äº²å’Œæ€§
```plain
#Ceph å®¢æˆ·ç«¯è¯»å†™æ•°æ®æ—¶ï¼Œæ€»æ˜¯è¿æ¥ acting set é‡Œçš„ä¸» OSD ï¼ˆå¦‚ [2, 3, 4] ä¸­ï¼Œ osd.2 æ˜¯ä¸»çš„ï¼‰ã€‚
#æœ‰æ—¶å€™æŸä¸ª OSD ä¸å…¶å®ƒçš„ç›¸æ¯”å¹¶ä¸é€‚åˆåšä¸» OSD ï¼ˆæ¯”å¦‚å…¶ç¡¬ç›˜æ…¢ã€æˆ–æ§åˆ¶å™¨æ…¢ï¼‰ï¼Œæœ€å¤§åŒ–ç¡¬ä»¶åˆ©ç”¨ç‡æ—¶ä¸ºé˜²æ­¢æ€§èƒ½ç“¶é¢ˆï¼ˆç‰¹åˆ«æ˜¯è¯»æ“ä½œï¼‰ï¼Œ
#ä½ å¯ä»¥è°ƒæ•´ OSD çš„ä¸»äº²å’Œæ€§ï¼Œè¿™æ · CRUSH å°±å°½é‡ä¸æŠŠå®ƒç”¨ä½œ acting set é‡Œçš„ä¸» OSD äº†ã€‚
 
#ceph osd primary-affinity <osd-id> <weight>   
 
$ ceph osd primary-affinity 2 1.0#ä¸»äº²å’Œæ€§é»˜è®¤ä¸º 1 ï¼ˆå°±æ˜¯è¯´æ­¤ OSD å¯ä½œä¸ºä¸» OSD ï¼‰ã€‚æ­¤å€¼åˆæ³•èŒƒå›´ä¸º 0-1 ï¼Œå…¶ä¸­ 0 æ„ä¸ºæ­¤ OSD ä¸èƒ½ç”¨ä½œä¸»çš„ï¼Œ#1 æ„ä¸º OSD å¯ç”¨ä½œä¸»çš„ï¼›æ­¤æƒé‡å°äº 1 æ—¶ï¼Œ CRUSH é€‰æ‹©ä¸» OSD æ—¶é€‰ä¸­å®ƒçš„å¯èƒ½æ€§ä½
```

## 2.23 æå– crush å›¾
```plain
#æå–æœ€æ–°crushå›¾
#ceph osd getcrushmap -o {compiled-crushmap-filename}
 
$ ceph osd getcrushmap -o /tmp/crush
 
#åç¼–è¯‘crushå›¾
# crushtool -d {compiled-crushmap-filename} -o {decompiled-crushmap-filename}
$ crushtool -d /tmp/crush -o /tmp/decompiled_crush
```

## 2.24 æ³¨å…¥ crush å›¾
```plain
#ç¼–è¯‘crushå›¾
#crushtool -c {decompiled-crush-map-filename} -o {compiled-crush-map-filename}
 
$ crushtool -c /tmp/decompiled_crush -o /tmp/crush_new
#æ³¨å…¥crushå›¾
# ceph osd setcrushmap -i {compiled-crushmap-filename}
$ ceph osd setcrushmap -i /tmp/crush_new
```

## 2.25 åœæ­¢è‡ªåŠ¨é‡å‡è¡¡
```plain
#ä½ å¾—å‘¨æœŸæ€§åœ°ç»´æŠ¤é›†ç¾¤çš„å­ç³»ç»Ÿã€æˆ–è§£å†³æŸä¸ªå¤±è´¥åŸŸçš„é—®é¢˜ï¼ˆå¦‚ä¸€æœºæ¶ï¼‰ã€‚å¦‚æœä½ ä¸æƒ³åœ¨åœæœºç»´æŠ¤ OSD æ—¶è®© CRUSH è‡ªåŠ¨é‡å‡è¡¡ï¼Œæå‰è®¾ç½® noout
$ ceph osd set noout
```

## 2.26 å–æ¶ˆåœæ­¢è‡ªåŠ¨å‡è¡¡
```plain
#è·Ÿceph osd set nooutç›¸åçš„æ“ä½œ
$ ceph osd unset noout
```

## 2.27 æŸ¥çœ‹åˆ†åŒºæƒ…å†µ
```plain
ceph-disk list
```









