---
title: äº†è§£ Linux IO è°ƒåº¦ç®—æ³•

tags: 
  - ceph
categories: 
  - ğŸ’» å·¥ä½œ
  - å­˜å‚¨
  - CEPH
  - çŸ¥è¯†æ‹“å±•
date: 2020-05-23 11:02:28
permalink: /pages/45c1ad/
---

## I/O è°ƒåº¦ç¨‹åºçš„æ€»ç»“


![img](https://images0.cnblogs.com/i/609710/201403/051225079271803.jpg)

 

1) å½“å‘è®¾å¤‡å†™å…¥æ•°æ®å—æˆ–æ˜¯ä»è®¾å¤‡è¯»å‡ºæ•°æ®å—æ—¶,è¯·æ±‚éƒ½è¢«å®‰ç½®åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­ç­‰å¾…å®Œæˆ.

2) æ¯ä¸ªå—è®¾å¤‡éƒ½æœ‰å®ƒè‡ªå·±çš„é˜Ÿåˆ—.

3) I/O è°ƒåº¦ç¨‹åºè´Ÿè´£ç»´æŠ¤è¿™äº›é˜Ÿåˆ—çš„é¡ºåº,ä»¥æ›´æœ‰æ•ˆåœ°åˆ©ç”¨ä»‹è´¨.I/O è°ƒåº¦ç¨‹åºå°†æ— åºçš„ I/O æ“ä½œå˜ä¸ºæœ‰åºçš„ I/O æ“ä½œ.

4) å†…æ ¸å¿…é¡»é¦–å…ˆç¡®å®šé˜Ÿåˆ—ä¸­ä¸€å…±æœ‰å¤šå°‘ä¸ªè¯·æ±‚,ç„¶åæ‰å¼€å§‹è¿›è¡Œè°ƒåº¦.

 

## I/O è°ƒåº¦çš„ 4 ç§ç®—æ³•

1) CFQ(Completely Fair Queuing, å®Œå…¨å…¬å¹³æ’é˜Ÿ)

ç‰¹ç‚¹:

åœ¨æœ€æ–°çš„å†…æ ¸ç‰ˆæœ¬å’Œå‘è¡Œç‰ˆä¸­,éƒ½é€‰æ‹© CFQ åšä¸ºé»˜è®¤çš„ I/O è°ƒåº¦å™¨,å¯¹äºé€šç”¨çš„æœåŠ¡å™¨ä¹Ÿæ˜¯æœ€å¥½çš„é€‰æ‹©.

CFQ è¯•å›¾å‡åŒ€åœ°åˆ†å¸ƒå¯¹ I/O å¸¦å®½çš„è®¿é—®,é¿å…è¿›ç¨‹è¢«é¥¿æ­»å¹¶å®ç°è¾ƒä½çš„å»¶è¿Ÿ,æ˜¯ deadline å’Œ as è°ƒåº¦å™¨çš„æŠ˜ä¸­.

CFQ å¯¹äºå¤šåª’ä½“åº”ç”¨(video,audio)å’Œæ¡Œé¢ç³»ç»Ÿæ˜¯æœ€å¥½çš„é€‰æ‹©.

CFQ èµ‹äºˆ I/O è¯·æ±‚ä¸€ä¸ªä¼˜å…ˆçº§,è€Œ I/O ä¼˜å…ˆçº§è¯·æ±‚ç‹¬ç«‹äºè¿›ç¨‹ä¼˜å…ˆçº§,é«˜ä¼˜å…ˆçº§è¿›ç¨‹çš„è¯»å†™ä¸èƒ½è‡ªåŠ¨åœ°ç»§æ‰¿é«˜çš„ I/O ä¼˜å…ˆçº§.

 

å·¥ä½œåŸç†:

CFQ ä¸ºæ¯ä¸ªè¿›ç¨‹/çº¿ç¨‹å•ç‹¬åˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—æ¥ç®¡ç†è¯¥è¿›ç¨‹æ‰€äº§ç”Ÿçš„è¯·æ±‚,ä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªè¿›ç¨‹ä¸€ä¸ªé˜Ÿåˆ—,å„é˜Ÿåˆ—ä¹‹é—´çš„è°ƒåº¦ä½¿ç”¨æ—¶é—´ç‰‡æ¥è°ƒåº¦,ä»¥æ­¤æ¥ä¿è¯æ¯ä¸ªè¿›ç¨‹éƒ½èƒ½è¢«å¾ˆå¥½çš„åˆ†é…åˆ° I/O å¸¦å®½.I/O è°ƒåº¦å™¨æ¯æ¬¡æ‰§è¡Œä¸€ä¸ªè¿›ç¨‹çš„ 4 æ¬¡è¯·æ±‚.

 

2) NOOP(ç”µæ¢¯å¼è°ƒåº¦ç¨‹åº)

ç‰¹ç‚¹:

åœ¨ Linux2.4 æˆ–æ›´æ—©çš„ç‰ˆæœ¬çš„è°ƒåº¦ç¨‹åº,é‚£æ—¶åªæœ‰è¿™ä¸€ç§ I/O è°ƒåº¦ç®—æ³•.

NOOP å®ç°äº†ä¸€ä¸ª FIFO é˜Ÿåˆ—,å®ƒåƒç”µæ¢¯çš„å·¥ä½œä¸»æ³•ä¸€æ ·å¯¹ I/O è¯·æ±‚è¿›è¡Œç»„ç»‡,å½“æœ‰ä¸€ä¸ªæ–°çš„è¯·æ±‚åˆ°æ¥æ—¶,å®ƒå°†è¯·æ±‚åˆå¹¶åˆ°æœ€è¿‘çš„è¯·æ±‚ä¹‹å,ä»¥æ­¤æ¥ä¿è¯è¯·æ±‚åŒä¸€ä»‹è´¨.

NOOP å€¾å‘é¥¿æ­»è¯»è€Œåˆ©äºå†™.

NOOP å¯¹äºé—ªå­˜è®¾å¤‡,RAM,åµŒå…¥å¼ç³»ç»Ÿæ˜¯æœ€å¥½çš„é€‰æ‹©.

 

ç”µæ¢¯ç®—æ³•é¥¿æ­»è¯»è¯·æ±‚çš„è§£é‡Š:

å› ä¸ºå†™è¯·æ±‚æ¯”è¯»è¯·æ±‚æ›´å®¹æ˜“.

å†™è¯·æ±‚é€šè¿‡æ–‡ä»¶ç³»ç»Ÿ cache,ä¸éœ€è¦ç­‰ä¸€æ¬¡å†™å®Œæˆ,å°±å¯ä»¥å¼€å§‹ä¸‹ä¸€æ¬¡å†™æ“ä½œ,å†™è¯·æ±‚é€šè¿‡åˆå¹¶,å †ç§¯åˆ° I/O é˜Ÿåˆ—ä¸­.

è¯»è¯·æ±‚éœ€è¦ç­‰åˆ°å®ƒå‰é¢æ‰€æœ‰çš„è¯»æ“ä½œå®Œæˆ,æ‰èƒ½è¿›è¡Œä¸‹ä¸€æ¬¡è¯»æ“ä½œ.åœ¨è¯»æ“ä½œä¹‹é—´æœ‰å‡ æ¯«ç§’æ—¶é—´,è€Œå†™è¯·æ±‚åœ¨è¿™ä¹‹é—´å°±åˆ°æ¥,é¥¿æ­»äº†åé¢çš„è¯»è¯·æ±‚.

 

3) Deadline(æˆªæ­¢æ—¶é—´è°ƒåº¦ç¨‹åº)

ç‰¹ç‚¹:

é€šè¿‡æ—¶é—´ä»¥åŠç¡¬ç›˜åŒºåŸŸè¿›è¡Œåˆ†ç±»,è¿™ä¸ªåˆ†ç±»å’Œåˆå¹¶è¦æ±‚ç±»ä¼¼äº noop çš„è°ƒåº¦ç¨‹åº.

Deadline ç¡®ä¿äº†åœ¨ä¸€ä¸ªæˆªæ­¢æ—¶é—´å†…æœåŠ¡è¯·æ±‚,è¿™ä¸ªæˆªæ­¢æ—¶é—´æ˜¯å¯è°ƒæ•´çš„,è€Œé»˜è®¤è¯»æœŸé™çŸ­äºå†™æœŸé™.è¿™æ ·å°±é˜²æ­¢äº†å†™æ“ä½œå› ä¸ºä¸èƒ½è¢«è¯»å–è€Œé¥¿æ­»çš„ç°è±¡.

Deadline å¯¹æ•°æ®åº“ç¯å¢ƒ(ORACLE RAC,MYSQL ç­‰)æ˜¯æœ€å¥½çš„é€‰æ‹©.

 

4) AS(é¢„æ–™ I/O è°ƒåº¦ç¨‹åº)

ç‰¹ç‚¹:

æœ¬è´¨ä¸Šä¸ Deadline ä¸€æ ·,ä½†åœ¨æœ€åä¸€æ¬¡è¯»æ“ä½œå,è¦ç­‰å¾… 6ms,æ‰èƒ½ç»§ç»­è¿›è¡Œå¯¹å…¶å®ƒ I/O è¯·æ±‚è¿›è¡Œè°ƒåº¦.

å¯ä»¥ä»åº”ç”¨ç¨‹åºä¸­é¢„è®¢ä¸€ä¸ªæ–°çš„è¯»è¯·æ±‚,æ”¹è¿›è¯»æ“ä½œçš„æ‰§è¡Œ,ä½†ä»¥ä¸€äº›å†™æ“ä½œä¸ºä»£ä»·.

å®ƒä¼šåœ¨æ¯ä¸ª 6ms ä¸­æ’å…¥æ–°çš„ I/O æ“ä½œ,è€Œä¼šå°†ä¸€äº›å°å†™å…¥æµåˆå¹¶æˆä¸€ä¸ªå¤§å†™å…¥æµ,ç”¨å†™å…¥å»¶æ—¶æ¢å–æœ€å¤§çš„å†™å…¥ååé‡.

AS é€‚åˆäºå†™å…¥è¾ƒå¤šçš„ç¯å¢ƒ,æ¯”å¦‚æ–‡ä»¶æœåŠ¡å™¨

AS å¯¹æ•°æ®åº“ç¯å¢ƒè¡¨ç°å¾ˆå·®.

 

ä¸‰) I/O è°ƒåº¦æ–¹æ³•çš„æŸ¥çœ‹ä¸è®¾ç½®

 1) æŸ¥çœ‹å½“å‰ç³»ç»Ÿçš„ I/O è°ƒåº¦

```plain
[root@localhost ~]# cat /sys/block/sda/queue/scheduler
noop anticipatory deadline [cfq] 
```

 

2) ä¸´æ—¶æ›´æ”¹ I/O è°ƒåº¦

ä¾‹å¦‚:æƒ³æ›´æ”¹åˆ° noop ç”µæ¢¯è°ƒåº¦ç®—æ³•:

```plain
[root@localhost ~]# echo noop > /sys/block/sda/queue/scheduler
```

 

3) æ°¸ä¹…æ›´æ”¹ I/O è°ƒåº¦

ä¿®æ”¹å†…æ ¸å¼•å¯¼å‚æ•°,åŠ å…¥ elevator=è°ƒåº¦ç¨‹åºå

```plain
[root@localhost ~]# echo noop > /sys/block/sda/queue/scheduler
```

 

æ›´æ”¹åˆ°å¦‚ä¸‹å†…å®¹:

```plain
kernel /boot/vmlinuz-2.6.18-8.el5 ro root=LABEL=/ elevator=deadline rhgb quiet
```

 

é‡å¯æœåŠ¡å™¨å,æŸ¥çœ‹è°ƒåº¦æ–¹æ³•:

```plain
[root@localhost ~]# cat /sys/block/sda/queue/scheduler
noop anticipatory [deadline] cfq
```

å¯ä»¥çœ‹è§å·²ç»æ˜¯ deadline äº†

 

å››) ionice

ionice å¯ä»¥æ›´æ”¹ä»»åŠ¡çš„ç±»å‹å’Œä¼˜å…ˆçº§,ä¸è¿‡åªæœ‰ cfq è°ƒåº¦ç¨‹åºå¯ä»¥ç”¨ ionice.

æœ‰ä¸‰ä¸ªä¾‹å­è¯´æ˜ ionice çš„åŠŸèƒ½:

é‡‡ç”¨ cfq çš„å®æ—¶è°ƒåº¦,ä¼˜å…ˆçº§ä¸º 7

```plain
[root@localhost ~]# ionice -c1 -n7  -ptime dd if=/dev/sda1 f=/tmp/test bs=2M count=300&
```

é‡‡ç”¨ç¼ºçœçš„ç£ç›˜ I/O è°ƒåº¦,ä¼˜å…ˆçº§ä¸º 3

```plain
[root@localhost ~]# ionice -c2 -n3  -ptime dd if=/dev/sda1 f=/tmp/test bs=2M count=300&
```

é‡‡ç”¨ç©ºé—²çš„ç£ç›˜è°ƒåº¦,ä¼˜å…ˆçº§ä¸º 0

```plain
[root@localhost ~]# ionice -c3 -n0  -ptime dd if=/dev/sda1 f=/tmp/test bs=2M count=300&
```

ionice çš„ä¸‰ç§è°ƒåº¦æ–¹æ³•,å®æ—¶è°ƒåº¦æœ€é«˜,å…¶æ¬¡æ˜¯ç¼ºçœçš„ I/O è°ƒåº¦,æœ€åæ˜¯ç©ºé—²çš„ç£ç›˜è°ƒåº¦.

ionice çš„ç£ç›˜è°ƒåº¦ä¼˜å…ˆçº§æœ‰ 8 ç§,æœ€é«˜æ˜¯ 0,æœ€ä½æ˜¯ 7.

**æ³¨æ„**:ç£ç›˜è°ƒåº¦çš„ä¼˜å…ˆçº§ä¸è¿›ç¨‹ nice çš„ä¼˜å…ˆçº§æ²¡æœ‰å…³ç³».

ä¸€ä¸ªæ˜¯é’ˆå¯¹è¿›ç¨‹ I/O çš„ä¼˜å…ˆçº§,ä¸€ä¸ªæ˜¯é’ˆå¯¹è¿›ç¨‹ CPU çš„ä¼˜å…ˆçº§ã€‚

## å‚è€ƒé“¾æ¥
- [IO è°ƒåº¦ç®—æ³•çš„é€‰æ‹©](https://www.cnblogs.com/gomysql/p/3582185.html)