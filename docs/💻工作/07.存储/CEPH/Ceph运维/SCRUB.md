---
title: SCRUB ç›¸å…³
categories: 
  - ğŸ’» å·¥ä½œ
  - å­˜å‚¨
  - CEPH
  - Ceph è¿ç»´
date: 2020-12-11 12:49:18
permalink: /pages/0512aa/
tags: 
  - 
---
# 1. åŸºæœ¬æ¦‚å¿µ
## 1.1 ä»€ä¹ˆæ˜¯ Scrub
Scrub æ˜¯ Ceph é›†ç¾¤å‰¯æœ¬è¿›è¡Œæ•°æ®æ‰«æçš„æ“ä½œï¼Œç”¨äºæ£€æµ‹å‰¯æœ¬é—´æ•°æ®çš„ä¸€è‡´æ€§ï¼ŒåŒ…æ‹¬ scrub å’Œ deep-scrubã€‚
å…¶ä¸­ scrub åªå¯¹å…ƒæ•°æ®ä¿¡æ¯è¿›è¡Œæ‰«æï¼Œç›¸å¯¹æ¯”è¾ƒå¿«ï¼›è€Œ deep-scrub ä¸ä»…å¯¹å…ƒæ•°æ®è¿›è¡Œæ‰«æï¼Œè¿˜ä¼šå¯¹å­˜å‚¨çš„æ•°æ®è¿›è¡Œæ‰«æï¼Œç›¸å¯¹æ¯”è¾ƒæ…¢ã€‚

## 1.2 Scrub é»˜è®¤æ‰§è¡Œå‘¨æœŸ
OSD çš„ scrub é»˜è®¤ç­–ç•¥æ˜¯æ¯å¤©åˆ°æ¯å‘¨ï¼ˆå¦‚æœé›†ç¾¤è´Ÿè½½å¤§å‘¨æœŸå°±æ˜¯ä¸€å‘¨ï¼Œå¦‚æœé›†ç¾¤è´Ÿè½½å°å‘¨æœŸå°±æ˜¯ä¸€å¤©ï¼‰è¿›è¡Œä¸€æ¬¡ï¼Œ
æ—¶é—´åŒºåŸŸé»˜è®¤ä¸ºå…¨ä½“ï¼ˆ0 æ—¶-24 æ—¶ï¼‰ï¼Œdeep-scrub é»˜è®¤ç­–ç•¥æ˜¯æ¯å‘¨ä¸€æ¬¡ã€‚

# 2. é…ç½®
ä¸ºäº†é¿å¼€å®¢æˆ·ä¸šåŠ¡é«˜å³°æ—¶æ®µï¼Œå»ºè®®åœ¨æ™šä¸Š 0 ç‚¹åˆ°ç¬¬äºŒå¤©æ—©ä¸Š 5 ç‚¹ä¹‹é—´ï¼Œæ‰§è¡Œ scrub æ“ä½œã€‚

## 2.1 è®¾ç½®æ ‡è¯†ä½
åœ¨ä»»ä¸€ monitor èŠ‚ç‚¹è¿›è¡Œå¦‚ä¸‹æ“ä½œ:
```plain
ceph osd set noscrub
ceph osd set nodeep-scrub
```

## 2.2 ä¸´æ—¶é…ç½®
å…ˆé€šè¿‡ tell æ–¹å¼ï¼Œè®© scrub æ—¶é—´åŒºé—´é…ç½®ç«‹å³ç”Ÿæ•ˆï¼Œåœ¨ä»»ä¸€ monitor èŠ‚ç‚¹è¿›è¡Œå¦‚ä¸‹æ“ä½œ:
```plain
ceph tell osd.* injectargs '--osd_scrub_begin_hour 0'
ceph tell osd.* injectargs '--osd_scrub_end_hour 5'
ceph tell mon.* injectargs '--osd_scrub_begin_hour 0'
ceph tell mon.* injectargs '--osd_scrub_end_hour 5'
```

## 2.3 ä¿®æ”¹é…ç½®æ–‡ä»¶
ä¸ºäº†ä¿è¯é›†ç¾¤æœåŠ¡é‡å¯æˆ–è€…èŠ‚ç‚¹é‡å¯ä¾ç„¶æœ‰æ•ˆï¼Œéœ€è¦ä¿®æ”¹ Ceph é›†ç¾¤æ‰€æœ‰èŠ‚ç‚¹çš„é…ç½®æ–‡ä»¶ /etc/ceph/ceph.conf
```plain
# vim /etc/ceph/ceph.conf
[osd]
osd_scrub_begin_hour = 0    # scrubæ“ä½œçš„èµ·å§‹æ—¶é—´ä¸º0ç‚¹
osd_scrub_end_hour = 5      # scrubæ“ä½œçš„ç»“æŸæ—¶é—´ä¸º5ç‚¹#ps: è¯¥æ—¶é—´è®¾ç½®éœ€è¦å‚è€ƒç‰©ç†èŠ‚ç‚¹çš„æ—¶åŒºè®¾ç½®
 
osd_scrub_chunk_min = 1  #æ ‡è®°æ¯æ¬¡scrubçš„æœ€å°æ•°
osd_scrub_chunk_max = 1  #æ ‡è®°æ¯æ¬¡scrubçš„æœ€å¤§æ•°æ®å—
osd_scrub_sleep = 3  #æ ‡è®°å½“å‰scrubç»“æŸï¼Œæ‰§è¡Œä¸‹æ¬¡scrubçš„ç­‰å¾…æ—¶é—´ï¼Œå¢åŠ è¯¥å€¼ï¼Œä¼šå¯¼è‡´scrubå˜æ…¢ï¼Œå®¢æˆ·ç«¯å½±å“åè€Œä¼šå‡å°
```

## 2.4 å–æ¶ˆæ ‡è¯†ä½
```plain
ceph osd unset noscrub
ceph osd unset nodeep-scrub
```

