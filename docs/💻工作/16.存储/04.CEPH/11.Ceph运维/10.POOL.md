---
title: Pool ç›¸å…³

categories: 
  - ğŸ’» å·¥ä½œ
  - å­˜å‚¨
  - CEPH
  - Ceph è¿ç»´
date: 2020-12-11 12:49:18
permalink: /pages/3d69ab/
tags: 
---
# 1.è¯´æ˜
## 1.1 ä»‹ç»
pool æ˜¯ ceph å­˜å‚¨æ•°æ®æ—¶çš„é€»è¾‘åˆ†åŒºï¼Œå®ƒèµ·åˆ° namespace çš„ä½œç”¨ã€‚å…¶ä»–åˆ†å¸ƒå¼å­˜å‚¨ç³»ç»Ÿï¼Œæ¯”å¦‚ Mogilefsã€Couchbaseã€Swift éƒ½æœ‰ pool çš„æ¦‚å¿µï¼Œåªæ˜¯å«æ³•ä¸åŒã€‚
æ¯ä¸ª pool åŒ…å«ä¸€å®šæ•°é‡çš„ PGï¼ŒPG é‡Œçš„å¯¹è±¡è¢«æ˜ å°„åˆ°ä¸åŒçš„ OSD ä¸Šï¼Œå› æ­¤ pool æ˜¯åˆ†å¸ƒåˆ°æ•´ä¸ªé›†ç¾¤çš„ã€‚

# 2. å¸¸ç”¨æ“ä½œ
## 2.1 æŸ¥çœ‹ pool æ•°é‡
```plain
$ ceph osd lspools
1 rbd,2 test_data,3 test_metadata,5 test,6 benmark_test,7 .rgw.root,8 default.rgw.control,9 default.rgw.meta,10 default.rgw.log,11 default.rgw.buckets.index,12 web-services,13 test_pool,15 cephfs_data,16 cephfs_metadata,
```

## 2.2 åˆ›å»º pool
```plain
$ ceph osd pool create test_lihang 100  #è¿™é‡Œçš„100æŒ‡çš„æ˜¯PGç»„
pool 'test_lihang' created
```

## 2.3 ä¸º pool é…ç½®é…é¢
```plain
$ ceph osd pool set-quota test_lihang max_objects 10000
set-quota max_objects = 10000 for pool test_lihang
```

## 2.4 åˆ é™¤ pool
```plain
$ ceph osd pool delete test_lihang test_lihang --yes-i-really-really-mean-it    #poolçš„åå­—éœ€è¦é‡å¤ä¸¤æ¬¡
pool 'test_lihang' removed
```

## 2.5 æŸ¥çœ‹ pool è¯¦ç»†ä¿¡æ¯
```plain
$ rados df
POOL_NAME                 USED   OBJECTS CLONES COPIES  MISSING_ON_PRIMARY UNFOUND DEGRADED RD_OPS  RD     WR_OPS   WR
.rgw.root                   1113       4      0      12                  0       0        0    1578  1052k        4   4096
benmark_test               8131M 1975366      0 5926098                  0       0        0       0      0        0      0
cephfs_data                    0       0      0       0                  0       0        0       0      0        0      0
cephfs_metadata             2246      21      0      63                  0       0        0       0      0       42   8192
default.rgw.buckets.index      0       1      0       3                  0       0        0       0      0        7      0
default.rgw.control            0       8      0      24                  0       0        0       0      0        0      0
default.rgw.log                0     191      0     573                  0       0        0 4706893  4596M  3134451      0
default.rgw.meta            1014       6      0      18                  0       0        0     107 100352       47  11264
rbd                       29047M   19619    176   58857                  0       0        0 1014831   835M   354490 11459M
test                        3606      10      0      30                  0       0        0      34  31744        0      0
test_data                   130G  292511      0  877533                  0       0        0   44647  5692k 59192695 56594M
test_lihang                    0       0      0       0                  0       0        0       0      0        0      0
test_metadata             42036k     164      0     492                  0       0        0   25567   491M   177927  2779M
test_pool                   305G  100678      0  302034                  0       0        0    3966   709M   337549   305G
web-services                  36       1      0       3                  0       0        0       0      0        1   1024
total_objects    2388580
total_used       1915G
total_avail      154T
total_space      156T
```

## 2.6 ç»™ä¸€ä¸ª pool åˆ›å»ºå¿«ç…§
```plain
$ ceph osd pool delete test_lihang test_lihang --yes-i-really-really-mean-it    #poolçš„åå­—éœ€è¦é‡å¤ä¸¤æ¬¡
pool 'test_lihang' removed
```

## 2.7 åˆ›å»º pool å¿«ç…§
```plain
$ ceph osd pool mksnap test_lihang date-snap
created pool test_lihang snap date-snap
```

## 2.8 åˆ é™¤ pool å¿«ç…§
```plain
$ ceph osd pool rmsnap test_lihang date-snap
removed pool test_lihang snap date-snap
```

## 2.9 æŸ¥çœ‹ pool æ±  pg æ•°é‡
```plain
$ ceph osd pool get test_lihang pg_num
pg_num: 100
```

## 2.10 è®¾ç½® pool æ± å‰¯æœ¬æ•°
```plain
$ ceph osd pool set test_lihang size 3
set pool 18 size to 3
```

## 2.11 æŸ¥çœ‹ pool æ± å‰¯æœ¬æ•°
```plain
$ ceph osd pool get test_lihang size
size: 3
```

## 2.12 è®¾ç½® pool æ± å†™æœ€å°å‰¯æœ¬
```plain
#è®¾ç½®poolæ± å†™æ“ä½œæœ€å°å‰¯æœ¬ä¸º2
 
$ ceph osd pool set test_lihang min_size 2
set pool 18 min_size to 2
```

## 2.13 æŸ¥çœ‹é›†ç¾¤æ‰€æœ‰ pool å‰¯æœ¬å°ºå¯¸
```plain
$ ceph osd dump | grep 'replicated size'
pool 1 'rbd' replicated size 3 min_size 2 crush_rule 0 object_hash rjenkins pg_num 2048 pgp_num 2048 last_change 5493 lfor 0/187 flags hashpspool stripe_width 0 application rbd
pool 2 'test_data' replicated size 3 min_size 2 crush_rule 0 object_hash rjenkins pg_num 512 pgp_num 512 last_change 1575 lfor 0/227 flags hashpspool stripe_width 0 application cephfs
```

## 2.14 è·å– pool çš„ pg æ•°é‡
```plain
$ ceph osd dump | grep 'replicated size'
pool 1 'rbd' replicated size 3 min_size 2 crush_rule 0 object_hash rjenkins pg_num 2048 pgp_num 2048 last_change 5493 lfor 0/187 flags hashpspool stripe_width 0 application rbd
pool 2 'test_data' replicated size 3 min_size 2 crush_rule 0 object_hash rjenkins pg_num 512 pgp_num 512 last_change 1575 lfor 0/227 flags hashpspool stripe_width 0 application cephfs
```

## 2.15 è®¾ç½® pool çš„ pg æ•°é‡
```plain
$ ceph osd pool set test_lihang pg_num 100
specified pg_num 100 <= current 100
 
$ ceph osd pool get test_lihang pg_num
pg_num: 100
```

## 2.16 è®¾ç½® pool çš„ pgp æ•°é‡
```plain
$ ceph osd pool set test_lihang pgp_num 100
set pool 18 pgp_num to 100
 
$ ceph osd pool get test_lihang pgp_num
pgp_num: 100
```

## 2.17 è®¾ç½®å­˜å‚¨æ± ç±»å‹
```plain
$ ceph osd pool application enable rbd rbd
enabled application 'rbd' on pool 'rbd' 
```

## 2.18 è®¾ç½®å­˜å‚¨æ±  crush rule
```plain
$ ceph osd pool set <poolname> crush_ruleset <ruleset>
ceph osd pool set ssd crush_ruleset 4
```

## 2.19 è·å–å­˜å‚¨æ±  crush rule
```plain
$ ceph osd pool get <poolname> crush_rule
ceph osd pool get test_pool crush_rule
crush_rule: replicated_rule
```

## 2.20 è·å– pool->pg->osd å…³ç³»
```plain
$ ceph osd getmap -o om
 
$ ceph osd getcrushmap -o cm
 
$ osdmaptool om --import-crush cm --test-map-pgs-dump --pool {pool_id}
```

## 2.21 è®¾ç½® pool åŠå…³è”çš„æ–‡ä»¶ç³»ç»Ÿç›®å½•çš„ quota
```plain
#create pool
ceph osd pool create sns_data 64

#add pool
ceph mds add_data_pool sns_data


# è®¾ç½® pool åä¸º sns_data çš„ quotaï¼Œå¦‚: 120T
$ ceph osd pool set-quota sns_data max_bytes $((120 * 1024 * 1024 * 1024 * 1024))

# mount cephfsçš„æ ¹ç›®å½•
$ ceph-fuse /mnt/

# 3. è®¾ç½®æ ¹ç›®å½•é‡Œçš„å­ç›®å½• sns_data çš„ quato(å­ç›®å½• sns_data å…³è”çš„poolä¸º sns_data)
$ setfattr -n ceph.quota.max_bytes -v  $((120 * 1024 * 1024 * 1024 * 1024)) /mnt/sns_data

# change layout
$setfattr -n ceph.dir.layout.pool -v sns_data /mnt/sns_data

#add user
ceph auth get-or-create client.trade mon 'allow r' mds 'allow r, allow rw path=/trade' osd 'allow rw pool=cephfs_data'

#modify user caps
ceph auth caps client.sns mds 'allow rw path=/mnt/sns_data' mon 'allow r' osd 'allow rw pool=sns_data'

# æŸ¥çœ‹å­ç›®å½• sns_data 
$ ceph-fuse -r /sns_data /test --user sns
$ df -h
```


















