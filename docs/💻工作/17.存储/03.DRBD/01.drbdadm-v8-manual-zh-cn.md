---
title: drbdadm ä¸­æ–‡æ‰‹å†Œ

tags: 
  - DRBD
  - drbdadm
  - å­˜å‚¨
categories: 
  - ğŸ’»å·¥ä½œ
  - å­˜å‚¨
  - DRBD
date: 2018-09-16 12:27:56
permalink: /pages/7cd2c7/
---
## æè¿°

drbdadm - DRBD é«˜çº§ç®¡ç†å·¥å…·

## æŒ‡ä»¤

```plain
drbdadm [-d] [-c {_file_}] [-t {_file_}] [-s {_cmd_}] [-m {_cmd_}] [-S] [-h {_host_}] [-- {_backend-options_}] {_command_} [{all} | {_resource__[/volume>]_...}]
```
## è¯´æ˜

`drbdadm`æ˜¯ DRBD ç¨‹åºä¸­çš„é«˜çº§ç®¡ç†å·¥å…·ã€‚ `drbdadm`æ˜¯`drbdsetup`å’Œ`drbdmeta`çš„è¾ƒé«˜çº§æ¥å£ã€‚ è¿™ç±»ä¼¼äº`ifconfig`ä¸`ifup/ifdown`å‘½ä»¤çš„å…³ç³»ã€‚ `drbdadm`è¯»å–é…ç½®æ–‡ä»¶ï¼Œç„¶åè°ƒç”¨`drbdsetup`æˆ–`drbdmeta`ä»¥è¿è¡Œå‘½ä»¤ã€‚

`drbdadm`å¯ä»¥å¯¹æ‰€æœ‰èµ„æºå’Œèµ„æºä¸­çš„å·æ‰§è¡Œæ“ä½œã€‚ å­å‘½ä»¤åŒ…æ‹¬ï¼š `attach`, `detach`, `primary`, `secondary`, `invalidate`, `invalidate-remote`, `outdate`, `resize`, `verify`, `pause-sync`, `resume-sync`, `role`, `csytate`, `dstate`, `create-md`, `show-gi`, `get-gi`, `dump-md`, `wipe-md`ç­‰ï¼Œå®ƒä»¬é€‚ç”¨äºæ‰€æœ‰èµ„æºå’Œå·ã€‚

ä»…èµ„æºçº§å‘½ä»¤å¦‚ä¸‹æ‰€ç¤ºï¼š `connect`, `disconnect`, `up`, `down`, `wait-connect` å’Œ `dump`.

## é€‰é¡¹

`-d`ï¼Œ `--dry-run`

å°†æ‰§è¡Œçš„`drbdsetup`å‘½ä»¤å†™å…¥æ ‡å‡†è¾“å‡ºï¼Œä½†ä¸å®é™…è¿è¡Œè¯¥å‘½ä»¤ã€‚

`-c`ï¼Œ `--config-file` *file*

æŒ‡å®š drbdadm ä½¿ç”¨çš„é…ç½®æ–‡ä»¶ã€‚ å¦‚æœçœç•¥æ­¤å‚æ•°ï¼Œåˆ™å¼•ç”¨ /etc/drbd-84.confã€/etc/drbd-83.confã€/etc/drbd-08.confã€/etc/drbd.confã€‚

`-t`ï¼Œ `--config-to-test` *file*

æŒ‡å®šè¦æ£€æŸ¥çš„é…ç½®æ–‡ä»¶ã€‚ ä»…åœ¨ä¸è½¬å‚¨æˆ– sh-nop å‘½ä»¤ä¸€èµ·ä½¿ç”¨æ—¶æœ‰æ•ˆã€‚

`-s`ï¼Œ `--drbdsetup` *file*

æŒ‡å®š`drbdsetup`ç¨‹åºçš„å®Œæ•´è·¯å¾„ã€‚ å¦‚æœçœç•¥ï¼Œåˆ™å¼•ç”¨è‡ªå·±çš„å‘½ä»¤ä½ç½®å’Œ$PATHã€‚

`-m`ï¼Œ `--drbdmeta` *file*

æŒ‡å®š`drbdmeta`ç¨‹åºçš„å®Œæ•´è·¯å¾„ã€‚ å¦‚æœçœç•¥ï¼Œåˆ™å¼•ç”¨è‡ªå·±çš„å‘½ä»¤ä½ç½®å’Œ$PATHã€‚

`-S`ï¼Œ `--stacked`

æŒ‡å®šæŒ‡ç¤ºå¯¹å †å çš„çˆ¶èµ„æºçš„æ“ä½œã€‚

`-P`ï¼Œ `--peer`

æŒ‡å®šè¦è¿æ¥åˆ°çš„ç›¸åèŠ‚ç‚¹ã€‚ ä»…å½“ä¸ºèµ„æºå®šä¹‰æŒ‡å®šäº†ä¸‰ä¸ªæˆ–æ›´å¤šä¸»æœºæ—¶ï¼Œæ‰éœ€è¦å®ƒã€‚

`--backend-options`

åŒè¿å­—ç¬¦åé¢çš„æ‰€æœ‰é€‰é¡¹éƒ½è¢«è§†ä¸º*åç«¯é€‰é¡¹*ã€‚ å®ƒä»¬ä¼ é€’ç»™åç«¯å‘½ä»¤ã€‚ æ¢å¥è¯è¯´ï¼Œå®ƒä¼ é€’ç»™`drbdsetup`ã€`drbdmeta`ã€`drbd-proxy-ctl`ç­‰ã€‚

## æŒ‡ä»¤

- attach

è¿æ¥ä¸ DRBD èµ„æºå¯¹åº”çš„ä½çº§æœ¬åœ°å—è®¾å¤‡ã€‚

- detach

å°†ä»å±å­˜å‚¨è®¾å¤‡ä¸ DRBD èµ„æºè®¾å¤‡åˆ†ç¦»ã€‚

- connect

ä¸ºèµ„æºè®¾å¤‡å¯ç”¨ç½‘ç»œè®¾ç½®ã€‚ å¦‚æœå·²é…ç½®ç›¸åº”çš„ç›®æ ‡ï¼Œåˆ™ä¸¤ä¸ª DRBD è®¾å¤‡å°†ç›¸äº’è¿æ¥ã€‚ å¦‚æœåœ¨èµ„æºå®šä¹‰æœŸé—´æŒ‡å®šäº†ä¸‰ä¸ªæˆ–æ›´å¤šä¸»æœºï¼Œåˆ™è¿˜å¿…é¡»æŒ‡å®š`--peer`æ¥æŒ‡å®šè¦è¿æ¥åˆ°çš„ä¸»æœºã€‚

- disconnect

ç¦ç”¨èµ„æºçš„ç½‘ç»œè®¾ç½®ã€‚ å½“ç„¶ï¼Œè®¾å¤‡å°†å¤„äºç‹¬ç«‹çŠ¶æ€ã€‚

- syncer

åŠ è½½è®¾å¤‡é‡æ–°åŒæ­¥çš„å‚æ•°ã€‚

- up

åŒæ—¶æ‰§è¡Œ`attach` å’Œ`connect`çš„å¿«æ·æ–¹å¼ã€‚

- down

åŒæ—¶æ‰§è¡Œ`disconnect`å’Œ`detach`çš„å¿«æ·æ–¹å¼ã€‚

- primary

å°†èµ„æºè®¾å¤‡æå‡ä¸ºä¸»(primary)çŠ¶æ€ã€‚ åœ¨ DRBD ç®¡ç†çš„è®¾å¤‡ä¸­åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿæˆ–è£…è½½æ–‡ä»¶ç³»ç»Ÿä¹‹å‰ï¼Œåº”å§‹ç»ˆè¿è¡Œæ­¤å‘½ä»¤ã€‚

- secondary

å°†è®¾å¤‡åˆ‡æ¢åˆ°è¾…åŠ©ï¼ˆsecondaryï¼‰çŠ¶æ€ã€‚ æ­¤å‘½ä»¤æ˜¯å¿…éœ€çš„ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªè¿æ¥çš„ DRBD è®¾å¤‡å¯¹å¯ä»¥å¤„äºä¸»ï¼ˆprimaryï¼‰çŠ¶æ€ï¼ˆé™¤éåœ¨é…ç½®æ–‡ä»¶ä¸­æ˜¾å¼æŒ‡å®šäº†`allow-two-primaries`ï¼‰ã€‚

- invalidate

å¼ºåˆ¶ DRBD å°†æœ¬åœ°å¤‡ä»½å­˜å‚¨è®¾å¤‡ä¸Šçš„æ•°æ®è§†ä¸ºä¸åŒæ­¥ï¼ˆout-of-syncï¼‰ã€‚å› æ­¤ï¼ŒDRBD å°†å¤åˆ¶å…¶å¯¹ç­‰æ–¹çš„æ¯ä¸ªå—ï¼Œä»¥å°†æœ¬åœ°å­˜å‚¨è®¾å¤‡æ¢å¤åŒæ­¥ã€‚ ä¸ºäº†é¿å…ç«äº‰ï¼Œæ‚¨éœ€è¦å»ºç«‹å¤åˆ¶é“¾æ¥ï¼Œæˆ–æ–­å¼€æ¬¡è¦è¿æ¥ã€‚

- invalidate-remote

æ­¤å‘½ä»¤ç±»ä¼¼äº`invalidate`å‘½ä»¤ï¼Œä½†æ˜¯ï¼Œå¯¹ç­‰æ–¹çš„åå¤‡å­˜å‚¨æ— æ•ˆï¼Œå› æ­¤ç”¨æœ¬åœ°èŠ‚ç‚¹çš„æ•°æ®é‡å†™ã€‚ ä¸ºäº†é¿å…ç«æ€ï¼Œæ‚¨éœ€è¦å·²å»ºç«‹çš„å¤åˆ¶é“¾æ¥æˆ–è€…å·²æ–­å¼€ä¸»è¿æ¥ã€‚

- resize

è®© DRBD é‡æ–°è¯„ä¼°ä¸ç£ç›˜å¤§å°é™åˆ¶ï¼Œå¹¶åœ¨å¿…è¦æ—¶è°ƒæ•´ç›¸åº”è®¾å¤‡çš„å¤§å°ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœä¸¤ä¸ªèŠ‚ç‚¹ä¸Šæ‰©å±•ä»å±è®¾å¤‡çš„å¤§å°ï¼Œåˆ™åœ¨å…¶ä¸­ä¸€ä¸ªèŠ‚ç‚¹ä¸Šè¿è¡Œæ­¤å‘½ä»¤åï¼ŒDRBD å°†æ¥å—æ–°å¤§å°ã€‚ ç”±äºæ–°çš„å­˜å‚¨åŒºåŸŸéœ€è¦åŒæ­¥ï¼Œå› æ­¤ä»…å½“è‡³å°‘æœ‰ä¸€ä¸ªä¸»èŠ‚ç‚¹æ—¶ï¼Œæ­¤å‘½ä»¤æ‰æœ‰æ•ˆã€‚

`--size`é€‰é¡¹ç”¨äºåœ¨çº¿å‡å° DRBD è®¾å¤‡å¯ç”¨çš„å¤§å°ã€‚ ç”¨æˆ·æœ‰è´£ä»»ç¡®ä¿æ–‡ä»¶ç³»ç»Ÿä¸ä¼šå› æ­¤æ“ä½œè€ŒæŸåã€‚ ç¤ºä¾‹ï¼š

```bash
# drbdadm -- --size=10G resize r0
```
`--assume-peer-has-space`é€‰é¡¹å…è®¸æ‚¨è°ƒæ•´å½“å‰æœªè¿æ¥åˆ°ç›®æ ‡èŠ‚ç‚¹çš„è®¾å¤‡çš„å¤§å°ã€‚ è¯·æ³¨æ„ï¼Œå¦‚æœä¸ä»¥åŒæ ·çš„æ–¹å¼æ›´æ”¹å¯¹åº”èŠ‚ç‚¹çš„ç£ç›˜å¤§å°ï¼Œåˆ™åç»­è¿æ¥å°†å¤±è´¥ã€‚

`--assume-clean`é€‰é¡¹å…è®¸æ‚¨è°ƒæ•´ç°æœ‰è®¾å¤‡çš„å¤§å°ï¼Œå¹¶é¿å…åŒæ­¥æ–°è®¾å¤‡ç©ºé—´ã€‚ å°†é¢å¤–çš„ç©ºç™½å­˜å‚¨æ·»åŠ åˆ°è®¾å¤‡æ—¶ï¼Œè¿™å¾ˆæœ‰ç”¨åˆ™éå¸¸æœ‰ç”¨ã€‚ ç¤ºä¾‹ï¼š

```bash
# drbdadm -- --assume-clean resize r0
```
`--al-stripes` å’Œ `--al-stripe-size-kB` é€‰é¡¹åœ¨çº¿æ›´æ”¹æ´»åŠ¨æ—¥å¿—çš„å¸ƒå±€ã€‚ å¯¹äºå†…éƒ¨å…ƒæ•°æ®ï¼Œéœ€è¦åŒæ—¶ç¼©å°æˆ–æ‰©å±•å­è®¾å¤‡çš„ç”¨æˆ·å¯è§çš„å¤§å°ï¼ˆä½¿ç”¨`--size`ï¼‰ã€‚

- check-resize

è°ƒç”¨ drbdmeta ç§»åŠ¨å†…éƒ¨å…ƒæ•°æ®ã€‚ å¦‚æœåœ¨ DRBD åœæ­¢æœŸé—´è°ƒæ•´ä»å±è®¾å¤‡çš„å¤§å°ï¼Œåˆ™å¿…é¡»å°†å…ƒæ•°æ®ç§»åŠ¨åˆ°è®¾å¤‡çš„æœ«å°¾ï¼Œä»¥ä¾¿ä¸‹ä¸€ä¸ª`attach`å‘½ä»¤æˆåŠŸæ‰§è¡Œã€‚

- create-md

åˆå§‹åŒ–å…ƒæ•°æ®åŒºåŸŸã€‚ å¦‚æœè¿™æ˜¯æ‚¨ç¬¬ä¸€æ¬¡ä½¿ç”¨ DRBD èµ„æºï¼Œåˆ™éœ€è¦åœ¨è”æœºä¹‹å‰è¿è¡Œæ­¤å‘½ä»¤ã€‚ å¦‚æœå‡ºç°é—®é¢˜ï¼Œè¯·å‚é˜…ä»¥ä¸‹æ–‡æ¡£[ï¼šdbdmetaï¼ˆ8ï¼‰](https://manpages.debian.org/testing/drbd-utils/drbdmeta.8.ja.html)

- get-gi

å°†æ•°æ®ç”Ÿæˆæ ‡è¯†ç¬¦ä¿¡æ¯æ˜¾ç¤ºä¸ºç®€æ´çš„æ–‡æœ¬ä¿¡æ¯ã€‚

- show-gi

å°†æ•°æ®ç”Ÿæˆæ ‡è¯†ç¬¦ä¿¡æ¯ä¸æè¿°æ€§æ–‡æœ¬ä¸€èµ·æ˜¾ç¤ºä¸ºæ–‡æœ¬ä¿¡æ¯ã€‚

- dump-md

ä»¥çº¯æ–‡æœ¬å½¢å¼è½¬å‚¨å…ƒæ•°æ®çš„å…¨éƒ¨å†…å®¹ã€‚ è½¬å‚¨è¿˜åŒ…æ‹¬ä½å›¾ï¼ˆ bit-map ï¼‰å’Œæ´»åŠ¨æ—¥å¿—ï¼ˆactivity-logï¼‰ã€‚

- outdate

å…ƒæ•°æ®è®¾ç½® outdated æ ‡å¿—ã€‚

- adjust

æ ¹æ®é…ç½®æ–‡ä»¶çš„è®¾ç½®è°ƒæ•´è®¾å¤‡çš„è®¾ç½®çŠ¶æ€ã€‚ åœ¨å®é™…è¿è¡Œä¹‹å‰ï¼Œåº”è¿è¡Œ `dry-run` æ¨¡å¼ï¼Œä»¥æ£€æŸ¥ç”Ÿæˆçš„è¾“å‡ºã€‚

- wait-connect

ç­‰å¾…ç›´åˆ°è¿æ¥åˆ°å…¶ä»–èŠ‚ç‚¹ä¸Šçš„è®¾å¤‡ã€‚

- role

ä»¥"æœ¬æœº/èŠ‚ç‚¹"ï¼ˆlocal/peerï¼‰çš„å½¢å¼æ˜¾ç¤ºè®¾å¤‡åœ¨æœºå™¨å’Œå¯¹å°èŠ‚ç‚¹ä¸Šçš„å½“å‰è§’è‰²ã€‚ ç¤ºä¾‹ï¼Œ`Primary/Secondary`

- state

å·²å¼ƒç”¨çš„"role"åˆ«åã€‚ å‚è§å‰æ¬¾è§„å®šã€‚

- cstate

æ˜¾ç¤ºä¸¤ä¸ªèŠ‚ç‚¹ä¸Šè®¾å¤‡çš„è¿æ¥çŠ¶æ€ã€‚

- dump

åˆ†æé…ç½®æ–‡ä»¶å¹¶å°†å…¶è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºã€‚ å¯ç”¨äºä¿®æ”¹é…ç½®æ–‡ä»¶çš„è¯­æ³•ã€‚

å¦å¤–ï¼š`drbdadm dump-xml`å¯ä»¥è§£æ drbd é…ç½®å¹¶ç”Ÿæˆ xml æ–‡ä»¶ã€‚[python - Is the DRBD configuration-file format a standard one? - StackOverflow](https://stackoverflow.com/questions/51499610/is-the-drbd-configuration-file-format-a-standard-one)

- outdate

ä½¿èŠ‚ç‚¹çš„æ•°æ®çŠ¶æ€æ— æ•ˆã€‚ é€šå¸¸ç”±å…¶ä»–èŠ‚ç‚¹çš„ `fence-peer` å¤„ç†ç¨‹åºè®¾ç½®ã€‚

- verify

å¼€å§‹è”æœºåŒ¹é…ã€‚ æ¯”è¾ƒä¸¤ä¸ªèŠ‚ç‚¹çš„æ•°æ®ï¼Œå¹¶æ£€æŸ¥æ˜¯å¦å­˜åœ¨ä¸ä¸€è‡´ã€‚ è¿›åº¦æ˜¾ç¤ºåœ¨ /proc/drbd ä¸­ã€‚ å¦‚æœæ‰¾åˆ°å¼‚æ­¥å—(out-of-sync)åˆ™ä¸ä¼šè‡ªåŠ¨é‡æ–°åŒæ­¥ã€‚ è¦åŒæ­¥ï¼Œè¯·åœ¨æ£€æŸ¥å®Œæˆå`disconnect`ï¼Œç„¶å`connect`èµ„æºã€‚

å¦è¯·å‚é˜… drbd.conf æ‰‹å†Œé¡µçš„æ•°æ®å®Œæ•´æ€§è¯´æ˜ã€‚

-  pause-sync

è®¾ç½®æœ¬åœ°å…ƒæ•°æ®çš„æš‚åœæ ‡å¿—ä»¥æš‚åœæ­£åœ¨è¿›è¡Œçš„é‡æ–°åŒæ­¥ã€‚ è‹¥è¦æ¢å¤ï¼Œå¿…é¡»æ¸…é™¤æœ¬åœ°èŠ‚ç‚¹å’Œå…¶ä»–èŠ‚ç‚¹çš„æš‚åœæ ‡å¿—ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœæ­£åœ¨é‡æ–°é…ç½®ä»å±è®¾å¤‡çš„ RAIDï¼Œåˆ™å¯ä»¥æš‚æ—¶åœæ­¢ DRBD é‡æ–°åŒæ­¥ã€‚

- resume-sync

æ¸…é™¤æœºå™¨çš„æš‚åœæ ‡å¿—ã€‚

- new-current-uuid

ç”Ÿæˆæ–°çš„å½“å‰ UUID å¹¶æ—‹è½¬ï¼ˆrotates ï¼‰æ‰€æœ‰å…¶ä»– UUIDã€‚

æ­¤å‘½ä»¤å¯ç”¨äºç¼©çŸ­åˆå§‹åŒæ­¥æ—¶é—´ã€‚ æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… drbdsetup æ‰‹å†Œé¡µã€‚

- dstate

æ˜¾ç¤ºä»å±ï¼ˆlocal/peerï¼‰è®¾å¤‡çš„åŒæ­¥çŠ¶æ€ã€‚ 

- hidden-commands

æ˜¾ç¤ºæœ¬æ–‡æ¡£ä¸­æœªåˆ—å‡ºçš„æ‰€æœ‰å‘½ä»¤ã€‚
```plain
These additional commands might be useful for writing nifty shell scripts around drbdadm:

 sh-nop                             sh-resources                       
 sh-resource                        sh-mod-parms                       
 sh-dev                             sh-udev                            
 sh-minor                           sh-ll-dev                          
 sh-md-dev                          sh-md-idx                          
 sh-ip                              sh-lr-of                           
 sh-b-pri                           sh-status                          
 proxy-up                           proxy-down                         
 new-resource                       

These commands are used by the kernel part of DRBD to invoke user mode helper programs:

 before-resync-target               after-resync-target                
 before-resync-source               pri-on-incon-degr                  
 pri-lost-after-sb                  fence-peer                         
 unfence-peer                       local-io-error                     
 pri-lost                           initial-split-brain                
 split-brain                        out-of-sync                        

These commands ought to be used by experts and developers:

 sh-new-minor                       new-minor                          
 suspend-io                         resume-io                          
 set-gi                             new-current-uuid                   
 check-resize                       

```

## ç‰ˆæœ¬

æœ¬æ–‡æ¡£å·²é’ˆå¯¹ DRBD ç‰ˆæœ¬ 8.4.0 è¿›è¡Œäº†ä¿®è®¢ã€‚

## ä½œè€…


philipp.Reisner <philipp.reisner@linbit.com> lars.ellenberg <lars.ellenberg@linbit.com>

## æŠ¥å‘Š BUGS

æŠ¥å‘Š bugs ç»™ <drbd-user@lists.linbit.com>ã€‚

## COPYRIGHT

Copyright 2001-2011 LINBIT Information Technologies, Philipp Reisner, Lars Ellenberg. This is free software; see the source for copying conditions. There is NO warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

## å‚è§

[drbd.conf(5)](https://manpages.debian.org/testing/drbd-utils/drbd.conf.5.en.html), [drbd(8)](https://manpages.debian.org/testing/drbd-utils/drbd.8.en.html), [drbddisk(8)](https://manpages.debian.org/testing/drbd-utils/drbddisk.8.en.html), [drbdsetup(8)](https://manpages.debian.org/testing/drbd-utils/drbdsetup.8.en.html), [drbdmeta(8)](https://manpages.debian.org/testing/drbd-utils/drbdmeta.8.en.html) and the `DRBD project web site`[1]

## å‚è€ƒé“¾æ¥
[Ubuntu Manpage: drbdadm - Administration tool for DRBD .](http://manpages.ubuntu.com/manpages/trusty/man8/drbdadm.8.html)