---
title: mds å…ƒä¿¡æ¯ç¼“å­˜ä¸é‡Šæ”¾é—®é¢˜

categories: 
  - ğŸ’»å·¥ä½œ
  - å­˜å‚¨
  - CEPH
  - troubleshooting
date: 2020-05-23 11:02:28
tags: null
permalink: /pages/bfa2c4/
---

# 1. é—®é¢˜
ceph é›†ç¾¤è­¦å‘Šä¿¡æ¯å¦‚ä¸‹ï¼š
```plain
ceph -s
health HEALTH_WARN
mds0: Client xxx-online00.gz01 failing to respond to cache pressure
```

# 2. åˆ†æé—®é¢˜è¿‡ç¨‹
## 2.1 å®˜æ–¹è§£é‡Š
ç±»å‹ | æè¿° |
---|---|
 æ¶ˆæ¯: |  â€œClient name failing to respond to cache pressureâ€ |
| ä»£ç :	| MDS_HEALTH_CLIENT_RECALL,MDS_HEALTH_CLIENT_RECALL_MANY |
| æè¿°:	| å®¢æˆ·ç«¯æœ‰å„è‡ªçš„å…ƒæ•°æ®ç¼“å­˜ï¼Œå®¢æˆ·ç«¯ç¼“å­˜ä¸­çš„æ¡ç›®ï¼ˆæ¯”å¦‚ç´¢å¼•èŠ‚ç‚¹ï¼‰ä¹Ÿä¼šå­˜åœ¨äº MDS ç¼“å­˜ä¸­ï¼Œæ‰€ä»¥å½“ MDS éœ€è¦å‰Šå‡å…¶ç¼“å­˜æ—¶ï¼ˆä¿æŒåœ¨ mds_cache_size ä»¥ä¸‹ï¼‰ï¼Œå®ƒä¹Ÿä¼šå‘æ¶ˆæ¯ç»™å®¢æˆ·ç«¯è®©å®ƒä»¬å‰Šå‡è‡ªå·±çš„ç¼“å­˜ã€‚å¦‚æœæœ‰å®¢æˆ·ç«¯æ²¡å“åº”æˆ–è€…æœ‰ç¼ºé™·ï¼Œå°±ä¼šå¦¨ç¢ MDS å°†ç¼“å­˜ä¿æŒåœ¨ mds_cache_size ä»¥ä¸‹ï¼Œ MDS å°±æœ‰å¯èƒ½è€—å°½å†…å­˜è€Œåå´©æºƒã€‚å¦‚æœæŸä¸ªå®¢æˆ·ç«¯çš„å“åº”æ—¶é—´è¶…è¿‡äº† mds_recall_state_timeout ï¼ˆé»˜è®¤ä¸º 60s ï¼‰ï¼Œè¿™æ¡æ¶ˆæ¯å°±ä¼šå‡ºç°ã€‚|

## 2.2  æŸ¥çœ‹å®¢æˆ·ç«¯ session
```plain
$ ceph daemon mds.ceph-epnfs-mds01.gz01 session ls
[
    {
        "id": 4746087,
        "num_leases": 9,
        "num_caps": 57368,
        "state": "open",
        "replay_requests": 0,
        "completed_requests": 1,
        "reconnecting": false,
        "inst": "client.4746087 10.1.7.1:0\/1700679012",
        "client_metadata": {
            "entity_id": "admin",
            "hostname": "test-hostname00",
            "kernel_version": "3.10.0-514.16.1.el7.x86_64"
        }
    }
]
```
## 2.3  æŸ¥çœ‹å®¢æˆ·ç«¯ inode
è·Ÿè¸ªä»£ç å‘ç° num_caps å°±æ˜¯ç»Ÿè®¡çš„å®¢æˆ·ç«¯çš„ inode æ•°é‡, å¤§æ¦‚ç»Ÿè®¡äº†ä¸‹å·²ç»æ‰“å¼€çš„ inode æ•°é‡ã€‚
![image.png](https://upload-images.jianshu.io/upload_images/2099201-96c167e0f8ac3861.png)

## 2.4  å°è¯• mds ä¸»ä»åˆ‡æ¢
### 2.4.1 æ‰§è¡Œè¿‡ç¨‹å¦‚ä¸‹

**ä¸»ä»åˆ‡æ¢æµç¨‹ï¼š**
- handle_mds_map state change up:boot --> up:replay
- handle_mds_map state change up:replay --> up:reconnect
- handle_mds_map state change up:reconnect --> up:rejoin
- handle_mds_map state change up:rejoin --> up:active

## 2.5.  ä¸»ä» mds åˆ‡æ¢ç»“è®º
æˆåŠŸåˆ‡æ¢ä¸»ä»è§’è‰²


## 2.6. ä¸»ä» mds åˆ‡æ¢é—®é¢˜
- mds åœ¨åˆ‡æ¢è¿‡ç¨‹ä¸­ï¼Œå¯¼è‡´ç¹å¿™ cpu å¾ˆé«˜ï¼Œåœ¨ mds_beacon_grace(é»˜è®¤ 15s)æ—¶é—´å†…æ²¡æœ‰å‘ monitor æ³¨å†Œï¼Œæ²¡æœ‰åŠæ—¶æ±‡æŠ¥å¿ƒè·³ç»™ monï¼Œå¯¼è‡´ mds è‡ªæ€ã€‚
- mds ä¸»ä»åˆ‡æ¢ open inode å¹¶æ²¡æœ‰é‡Šæ”¾

# 3. æ·±å…¥é—®é¢˜åˆ†æ
## 3.1 mds åˆ‡æ¢è¿‡ç¨‹å¯¼è‡´ mds è‡ªæ€
é—®é¢˜ï¼šmds åœ¨åˆ‡æ¢è¿‡ç¨‹ä¸­ï¼Œå¯¼è‡´ç¹å¿™ cpu å¾ˆé«˜ï¼Œåœ¨ mds_beacon_grace(é»˜è®¤ 15s)æ—¶é—´å†…æ²¡æœ‰å‘ monitor æ³¨å†Œï¼Œæ²¡æœ‰åŠæ—¶æ±‡æŠ¥å¿ƒè·³ç»™ monï¼Œå¯¼è‡´ mds è‡ªæ€ã€‚

**mds å­˜å‚¨ï¼š**
- å…ƒæ•°æ®çš„å†…å­˜ç¼“å­˜ï¼Œä¸ºäº†åŠ å¿«å…ƒæ•°æ®çš„è®¿é—®ã€‚
- ä¿å­˜äº†æ–‡ä»¶ç³»ç»Ÿçš„å…ƒæ•°æ®(å¯¹è±¡é‡Œä¿å­˜äº†å­ç›®å½•å’Œå­æ–‡ä»¶çš„åç§°å’Œ inode ç¼–å·)
- è¿˜ä¿å­˜ cephfs æ—¥å¿— journalï¼Œæ—¥å¿—æ˜¯ç”¨æ¥æ¢å¤ mds é‡Œçš„å…ƒæ•°æ®ç¼“å­˜
- é‡å¯ mds çš„æ—¶å€™ä¼šé€šè¿‡ replay çš„æ–¹å¼ä» osd ä¸ŠåŠ è½½ä¹‹å‰ç¼“å­˜çš„å…ƒæ•°æ®

**mds å†·å¤‡/çƒ­å¤‡ï¼š**
- å†·å¤‡å°±æ˜¯å¤‡ä»½çš„ mdsï¼Œåªèµ·åˆ°ä¸€ä¸ªè¿›ç¨‹å¤‡ä»½çš„ä½œç”¨ï¼Œå¹¶ä¸å¤‡ä»½ lru å…ƒæ•°æ®ã€‚ä¸»å¤‡è¿›ç¨‹ä¿æŒå¿ƒè·³å…³ç³»ï¼Œä¸€æ—¦ä¸»çš„ mds æŒ‚äº†ï¼Œå¤‡ä»½ mds replay()å…ƒæ•°æ®åˆ°ç¼“å­˜ï¼Œå½“ç„¶è¿™éœ€è¦æ¶ˆè€—ä¸€ç‚¹æ—¶é—´ã€‚
- çƒ­å¤‡é™¤äº†è¿›ç¨‹å¤‡ä»½ï¼Œå…ƒæ•°æ®ç¼“å­˜è¿˜æ—¶æ—¶åˆ»åˆ»çš„ä¸ä¸» mds ä¿æŒåŒæ­¥ï¼Œå½“ active mds æŒ‚æ‰åï¼Œçƒ­å¤‡çš„ mds ç›´æ¥å˜æˆä¸» mdsï¼Œå¹¶ä¸”æ²¡æœ‰ replay()çš„æ“ä½œï¼Œå…ƒæ•°æ®ç¼“å­˜å¤§å°å’Œä¸» mds ä¿æŒä¸€è‡´ã€‚
**è¯´æ˜ï¼š**
  - rejoin æŠŠå®¢æˆ·ç«¯çš„ inode åŠ è½½åˆ° mds cache
  - replay æŠŠä» cephfs çš„ journal æ¢å¤å†…å­˜

**mds ä¸»å¤‡åˆ‡æ¢ç­–ç•¥ï¼š**
- é»˜è®¤æ¯ä¸ª standby éƒ½ä¸€æ ·
- æŒ‡å®šåè¡¥
  - mds standby for name æŒ‡å®šä¸€ MDS å®ˆæŠ¤è¿›ç¨‹çš„åå­—ï¼Œæ­¤è¿›ç¨‹å°†ä½œä¸ºå®ƒçš„å€™è¡¥
  - mds standby for rank æ­¤ MDS å°†ä½œä¸ºæœ¬æœºæ¶ä¸Š MDS å®ˆæŠ¤è¿›ç¨‹çš„å€™è¡¥
- ä¼˜å…ˆçº§æœ€é«˜ standby replay

**èŠ‚ç‚¹å¤±æ•ˆæœºåˆ¶ï¼š**
- ä¸€ä¸ªæ´»è·ƒçš„ MDS å®šæœŸå‘ monitor å‘é€äº¤äº’ä¿¡æ¯ï¼Œå¦‚æœä¸€ä¸ª MDS åœ¨ mds_beacon_grace(é»˜è®¤ 15s)æ—¶é—´å†…æ²¡æœ‰å‘ monitor æ³¨å†Œï¼Œåˆ™è®¤ä¸ºè¯¥ MDS å¤±æ•ˆã€‚

**æ¢å¤è¿‡ç¨‹ï¼š**
- å¤±æ•ˆèŠ‚ç‚¹çš„ç›¸å…³æ—¥å¿—è¢«è¯»å…¥å†…å­˜ï¼›
- å¤„ç†æœ‰äº‰è®®çš„å­æ ‘åˆ†é…é—®é¢˜å’Œæ¶‰åŠå¤šä¸ª MDS çš„ transactionï¼›
- ä¸ client é‡æ–°å»ºç«‹ä¼šè¯å¹¶é‡æ–°ä¿å­˜æ‰“å¼€æ–‡ä»¶çš„çŠ¶æ€ï¼›
- æ¥æ›¿å¤±æ•ˆèŠ‚ç‚¹çš„ MDS åŠ å…¥åˆ° MDS é›†ç¾¤çš„åˆ†å¸ƒå¼ç¼“å­˜ä¸­

**resolve é˜¶æ®µçš„äº‹ä»¶ï¼š**
- æ¢å¤èŠ‚ç‚¹å‘æ‰€æœ‰ MDS å‘é€ä¸€ä¸ª resolve ä¿¡æ¯ï¼Œè¯¥ä¿¡æ¯ä¸­åŒ…å«äº†å½“å‰æ¢å¤èŠ‚ç‚¹ç®¡ç†çš„å­æ ‘ã€åœ¨è¿ç§»è¿‡ç¨‹ä¸­å‡ºç°æ•…éšœçš„å­æ ‘ï¼›
- å…¶ä»–æ­£å¸¸è¿è¡Œçš„ MDS ä¹Ÿè¦å°†è¿™äº›ä¿¡æ¯å‘é€ç»™æ­£åœ¨æ¢å¤çš„ MDSï¼›
- æ¢å¤ä¸­çš„ MDS æ ¹æ®æ”¶åˆ°çš„å­æ ‘ä¿¡æ¯é‡å»ºè‡ªå·±ç¼“å­˜ä¸­çš„å­æ ‘å±‚æ¬¡ç»“æ„ã€‚

**é‡å»ºåˆ†å¸ƒå¼ç¼“å­˜å’Œé”çŠ¶æ€ï¼š**
- æ¢å¤èŠ‚ç‚¹å‘æ‰€æœ‰ MDS å‘é€ä¸€ä¸ª rejoin ä¿¡æ¯ï¼Œè¯¥ä¿¡æ¯åŒ…å«äº†æ¢å¤èŠ‚ç‚¹æ‰€çŸ¥é“çš„æ¥å—èŠ‚ç‚¹æ‹¥æœ‰çš„å…ƒæ•°æ®å‰¯æœ¬ä¿¡æ¯å¹¶å®£ç§°è‡ªå·±æ²¡æœ‰ç®¡ç†çš„æ¢å¤æ–‡ä»¶ï¼›
- åŸæ¥æœ‰æ•ˆçš„èŠ‚ç‚¹å‘æ¢å¤èŠ‚ç‚¹å‘é€ä¿¡æ¯ï¼Œå‘Šè¯‰æ¢å¤èŠ‚ç‚¹è‡ªå·±æ‹¥æœ‰çš„å…ƒæ•°æ®å‰¯æœ¬ï¼Œå¹¶ä¸”å‘æ¢å¤èŠ‚ç‚¹åŠ å…¥é”çŠ¶æ€
- æ¢å¤èŠ‚ç‚¹å°†è‡ªå·±åŸæœ¬ä¸çŸ¥é“çš„å‰¯æœ¬ä¿¡æ¯åŠ å…¥åˆ°è‡ªå·±çš„ç¼“å­˜ä¸­

**ä¸ºå•¥ mds åˆ‡æ¢å¯¼è‡´ cpu é«˜ï¼Ÿ**
- 1. åˆ†ææ—¥å¿—(å‘ç°æ‰§è¡Œ rejoin_start åŠ¨ä½œåªä¼šå°±è¶…æ—¶)
```plain
2018-04-27 19:12:21.909280 7f8268805700 1 mds.0.2665 rejoin_start
2018-04-27 19:12:37.294438 7f826a809700 1 heartbeat_map is_healthy 'MDSRank' had timed out after 15
2018-04-27 19:12:40.961787 7f82656fe700 1 heartbeat_map is_healthy 'MDSRank' had timed out after 15
2018-04-27 19:12:40.961796 7f82656fe700 1 mds.beacon.ceph-xxx-mds01.gz01 _send skipping beacon, heartbeat map not healthy
2018-04-27 19:12:42.294507 7f826a809700 1 heartbeat_map is_healthy 'MDSRank' had timed out after 15
```
- 2.è·Ÿè¸ªä»£ç åˆ†æ(åœ¨æ‰§è¡Œ process_imported_caps è¶…æ—¶äº†ï¼Œ è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯æ‰“å¼€ inodes åŠ è½½åˆ° cache ä¸­)
![image.png](https://upload-images.jianshu.io/upload_images/2099201-1652420b5cfd4d8f.png)

- 3. è·Ÿè¸ªå®˜æ–¹ bug åˆ—è¡¨å‘ç°è¡¥ä¸(è§£å†³ä¸»ä» mds åˆ‡æ¢è¶…æ—¶è‡ªæ€, ä»¥åŠ merge åˆ°ç›®æ ‡ç‰ˆæœ¬ 13.0.0)Â [https://github.com/ceph/ceph/pull/21144](https://github.com/ceph/ceph/pull/21144)
![image.png](https://upload-images.jianshu.io/upload_images/2099201-e9a88d18f2b61b2b.png)

- 4.è·Ÿè¸ªè¡¥ä¸ä»£ç åˆ†æ(inode åˆ°äº† 1000 ä¸ªï¼Œmds å¿ƒè·³ reset, ç¦æ­¢è‡ªæ€è¡Œä¸º)
![image.png](https://upload-images.jianshu.io/upload_images/2099201-348e433c658229e6.png)
![image.png](https://upload-images.jianshu.io/upload_images/2099201-06ca87bcd4d4ad0d.png)

## 3.2 mds ä¸»ä»åˆ‡æ¢ open inode æ²¡æœ‰é‡Šæ”¾
é—®é¢˜ï¼šmds ä¸»ä»åˆ‡æ¢ open inode æ²¡æœ‰é‡Šæ”¾ï¼Œmds é›†ç¾¤æ˜¾ç¤º mds0: Client xxx-online00.gz01 failing to respond to cache pressure
è§£å†³æ–¹å¼ï¼š(ç”±äº inode éƒ½ç¼“å­˜åœ¨ client ç«¯,æ‰€ä»¥å¿…é¡»çš„æƒ³åŠæ³•é‡Šæ”¾ inode)

*   æ–¹æ¡ˆ 1ï¼ševict client(ä¸»åŠ¨è¸¢å‡ºæœ‰é—®é¢˜çš„å®¢æˆ·ç«¯)
*   æ–¹æ¡ˆ 2ï¼šclient remount(æœ‰é—®é¢˜çš„å®¢æˆ·ç«¯é‡æ–° mount æŒ‚è½½)
*   æ–¹æ¡ˆ 3ï¼šdrop_cache(å®˜æ–¹æä¾›çš„ mds ä¸»åŠ¨åˆ é™¤ cacheï¼Œè¡¥ä¸åœ¨ review è¿‡ç¨‹ä¸­ä¸ªï¼Œç›®æ ‡ç‰ˆæœ¬æ˜¯ ceph-14.0.0)Â [https://github.com/ceph/ceph/pull/21566](https://github.com/ceph/ceph/pull/21566)
![image.png](https://upload-images.jianshu.io/upload_images/2099201-5279fc57af33fb76.png)

