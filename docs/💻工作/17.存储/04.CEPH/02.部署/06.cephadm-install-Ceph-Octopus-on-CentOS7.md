---
title: CentOS7 å®‰è£… Octopus ç‰ˆ CEPHï¼ˆä½¿ç”¨ cephadmï¼‰
tags: 
  - CEPH
  - ç¯å¢ƒæ­å»º
  - CentOS7
cover: /images/logos/ceph-logo.svg
subtitle: æ­£æ‰€è°“â€œæ±Ÿä¸Šä»£æœ‰æ‰äººå‡ºï¼Œå„é¢†é£éªšæ•°ç™¾å¹´ã€‚â€ï¼Œä» Octopus ç‰ˆå¼€å§‹ ceph-deploy ä¸å†è¢«ä½œä¸ºå®˜æ–¹æ¨èçš„éƒ¨ç½² ceph é›†ç¾¤çš„å·¥å…·ï¼ˆNautilus ç‰ˆä»ç„¶æ”¯æŒï¼‰ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯æ–°ç§€ cephadmã€‚ä½¿ç”¨å¼€æºäº§å“æœ€é‡è¦çš„æ˜¯è·Ÿä¸Šç¤¾åŒºèŠ‚å¥ï¼Œæœ¬æ–‡ä»¥å®˜æ–¹æ–‡æ¡£ä¸ºåŸºç¡€å®è·µäº† ceph é›†ç¾¤çš„éƒ¨ç½²æµç¨‹ã€‚
categories: 
  - ğŸ’»å·¥ä½œ
  - å­˜å‚¨
  - CEPH

date: 2020-03-22 16:38:42
permalink: /pages/bc8e78/
---
## ç‰ˆæœ¬ä¿¡æ¯
- ç³»ç»Ÿä¿¡æ¯
    ```plain
    [root@cepho ~]# uname -r
    3.10.0-957.el7.x86_64
    [root@cepho ~]# cat /etc/system-release
    CentOS Linux release 7.6.1810 (Core) 
    ```
- Python3 ç‰ˆæœ¬
    ```plain
    [root@cepho ~]# python3 -V
    Python 3.8.2
    ```
    ç”Ÿäº§ç¯å¢ƒä¸­æˆ‘ä»¬æ²¡æœ‰å¿…è¦è¿½æ±‚æœ€æ–°ï¼Œå®‰è£… 3.6 ç‰ˆæœ¬å³å¯ã€‚å½“ç„¶å¦‚æœä½ è¿½æ±‚æœ€æ–°ï¼Œé‚£ä¹ˆå°±ç”¨æœ€æ–°çš„ä¹Ÿå¥½ã€‚
- Docker ä¿¡æ¯
    ```plain
    [root@cepho ~]# docker --version
    Docker version 19.03.8, build afacb8b
    ```
- CEPH ç‰ˆæœ¬
 ```shell
 ceph --version
 ceph version 15.1.1 (4536217610b4c55c08a293e67f5ae1f1129190be) octopus (rc)
 ```
å› ä¸ºå®‰è£…çš„æ˜¯æ™®é€šç‰ˆæœ¬è€Œä¸æ˜¯æœ€å°å®‰è£…ï¼Œæ‰€ä»¥ ntpã€lvm ç®¡ç†å·¥å…·ç­‰é»˜è®¤å·²ç»å®‰è£…ã€‚

## å®‰è£… cephadm
- ä¸‹è½½ cephadm å¹¶èµ‹æƒ
```plain
curl --silent --remote-name --location https://github.com/ceph/ceph/raw/octopus/src/cephadm/cephadm
chmod +x cephadm
```
- æ·»åŠ æºä¿¡æ¯ï¼ŒæŒ‡å®šä¸º Octopus ç‰ˆæœ¬
```shell
./cephadm add-repo --release octopus
./cephadm install
```
æ­¤æ—¶ä¼šæ›´æ–° repo ä¿¡æ¯
```plain
./cephadm add-repo --release octopus
INFO:root:Writing repo to /etc/yum.repos.d/ceph.repo...
INFO:cephadm:Enabling EPEL...
```
éªŒè¯ï¼š
```plain
[root@cepho yum.repos.d]# ll -t
total 48
```
æ›´æ–°å‰ï¼š
```plain
# before
total 36
-rw-r--r--. 1 root root  413 Mar 15 12:36 ceph.repo
-rw-r--r--. 1 root root 1664 Nov 23  2018 CentOS-Base.repo
-rw-r--r--. 1 root root 1309 Nov 23  2018 CentOS-CR.repo
-rw-r--r--. 1 root root  649 Nov 23  2018 CentOS-Debuginfo.repo
-rw-r--r--. 1 root root  314 Nov 23  2018 CentOS-fasttrack.repo
-rw-r--r--. 1 root root  630 Nov 23  2018 CentOS-Media.repo
-rw-r--r--. 1 root root 1331 Nov 23  2018 CentOS-Sources.repo
-rw-r--r--. 1 root root 5701 Nov 23  2018 CentOS-Vault.repo

```
æ›´æ–°å
```plain
# after
-rw-r--r--. 1 root root  477 Mar 22 17:33 ceph.repo
-rw-r--r--. 1 root root 2424 Oct 19 05:57 docker-ce.repo
-rw-r--r--. 1 root root 1050 Sep 18  2019 epel.repo
-rw-r--r--. 1 root root 1149 Sep 18  2019 epel-testing.repo
-rw-r--r--. 1 root root 1664 Nov 23  2018 CentOS-Base.repo
-rw-r--r--. 1 root root 1309 Nov 23  2018 CentOS-CR.repo
-rw-r--r--. 1 root root  649 Nov 23  2018 CentOS-Debuginfo.repo
-rw-r--r--. 1 root root  314 Nov 23  2018 CentOS-fasttrack.repo
-rw-r--r--. 1 root root  630 Nov 23  2018 CentOS-Media.repo
-rw-r--r--. 1 root root 1331 Nov 23  2018 CentOS-Sources.repo
-rw-r--r--. 1 root root 5701 Nov 23  2018 CentOS-Vault.repo
```
å…¶ä¸­å‰ä¸‰è¡Œå³æ˜¯æ›´æ–°ä¹‹åçš„æºä¿¡æ¯ã€‚
{%note info no-icon%}
### æŠ¥é”™å¤„ç†
1. æ²¡æœ‰è£… Python3
    æ‰§è¡Œç¬¬ä¸€æ¡æŒ‡ä»¤*å¯èƒ½*æŠ¥é”™
    ```plain
    ./cephadm add-repo --release octopus
    -bash: ./cephadm: /usr/bin/python3: bad interpreter: No such file or directory
    ```
    è¿™æ˜¯å› ä¸ºç³»ç»Ÿä¸­ç¼ºå°‘ Python3 æ”¯æŒï¼Œæ‰€ä»¥è¦å®‰è£… Python3ï¼Œå…³äº Python3 çš„å®‰è£…å¯ä»¥å‚è€ƒæ­¤å¤„ğŸ‘‰
    - [Python3 ç¯å¢ƒæ­å»º | èœé¸Ÿæ•™ç¨‹](https://www.runoob.com/python3/python3-install.html) 
    - [Linux ä¸‹å®‰è£… Python æŠ¥é”™ï¼šzlib not available - å¯’çˆµ - åšå®¢å›­](https://www.cnblogs.com/Jimc/p/10218062.html)    
    å®‰è£…ä¹‹åéªŒè¯ï¼š
    ```shell
    python3 -V
    ```
    ```plain
    Python 3.8.2
    ```
2. æ²¡æœ‰è£… podman/docker
    ```plain
    Unable to locate any of ['podman', 'docker']
    ```
    å®‰è£… Docker å‚è€ƒ[CentOS Docker å®‰è£… | èœé¸Ÿæ•™ç¨‹](https://www.runoob.com/docker/centos-docker-install.html)
    éªŒè¯
    ```plain
    docker --version
    Docker version 19.03.8, build afacb8b
    ```
    {%endnote%}

- å®‰è£… cephadm
    ```plain
    ./cephadm install
    ```
    ```plain
    INFO:cephadm:Installing packages ['cephadm']...
    ```
- éªŒè¯ cephadm å®‰è£…å®Œæˆ
    ```plain
    which cephadm
    ```
    ```plain
    /usr/sbin/cephadm
    ```

## å¼•å¯¼æ–°é›†ç¾¤
ä½ éœ€è¦çŸ¥é“ç”¨äºç¾¤é›†çš„ç¬¬ä¸€ä¸ªç›‘è§†å™¨å®ˆæŠ¤ç¨‹åºçš„ IP åœ°å€ã€‚ é€šå¸¸ï¼Œè¿™æ˜¯ç¬¬ä¸€å°ä¸»æœºçš„ IPã€‚ å¦‚æœå­˜åœ¨å¤šä¸ªç½‘ç»œå’Œæ¥å£ï¼Œè¯·ç¡®ä¿é€‰æ‹©ä»»ä½•å¯ä¾›è®¿é—® Ceph ç¾¤é›†çš„ä¸»æœºè®¿é—®çš„ç½‘ç»œå’Œæ¥å£ã€‚
```plain
mkdir -p /etc/ceph
```
```plain
cephadm bootstrap --mon-ip *<mon-ip>*   # æ­¤å¤„æŒ‡å®šmoniteråœ°å€
```
æ³¨æ„ï¼Œæ­¤å¤„æŒ‡å®šä¸º ssh ç™»å½•çš„ ip æ—¶ä¸€ç›´æç¤ºç«¯å£å ç”¨ï¼Œä¸” mon è¿›ç¨‹ä¸€ç›´å¯ä¸æ¥ï¼Œåæ¥æ”¹æˆå¦ä¸€ä¸ªèŠ‚ç‚¹ä¹‹åå¯ä»¥æ­£å¸¸éƒ¨ç½²ï¼Œæ­¤å¤„éœ€è¦æŸ¥é˜…æ›´å¤šèµ„æ–™ï¼ # TODO
```shell
cephadm bootstrap --mon-ip 172.18.1.128
```
```plain
INFO:cephadm:Using recent ceph image ceph/daemon-base:latest
INFO:cephadm:Verifying podman|docker is present...  # éªŒè¯podman|docker
INFO:cephadm:Verifying lvm2 is present...           # éªŒè¯lvm2
INFO:cephadm:Verifying time synchronization is in place... # éªŒè¯æ—¶é—´åŒæ­¥
INFO:cephadm:Unit chronyd.service is enabled and running        # chronyd
INFO:cephadm:Repeating the final host check...
INFO:cephadm:podman|docker (/usr/bin/docker) is present
INFO:cephadm:systemctl is present
INFO:cephadm:lvcreate is present
INFO:cephadm:Unit chronyd.service is enabled and running
INFO:cephadm:Host looks OK
INFO:root:Cluster fsid: d0d73402-6c28-11ea-8165-00505625d3e6    # ç”Ÿæˆé›†ç¾¤fsid
INFO:cephadm:Verifying IP 172.18.1.128 port 3300 ...
INFO:cephadm:Verifying IP 172.18.1.128 port 6789 ...            # éªŒè¯ç«¯å£
INFO:cephadm:Pulling latest ceph/daemon-base:latest container...
INFO:cephadm:Extracting ceph user uid/gid from container image...   # pullå®¹å™¨
INFO:cephadm:Creating initial keys...
INFO:cephadm:Creating initial monmap...                     # åˆå§‹åŒ–keysã€monmap
INFO:cephadm:Creating mon...
INFO:cephadm:Waiting for mon to start...
INFO:cephadm:Waiting for mon...                                # åˆ›å»ºå¹¶å¯åŠ¨mon
INFO:cephadm:Assimilating anything we can from ceph.conf...
INFO:cephadm:Generating new minimal ceph.conf...                # ç”Ÿæˆé…ç½®
INFO:cephadm:Restarting the monitor...                      
INFO:cephadm:Creating mgr...                                    # åˆ›å»ºmgr
INFO:cephadm:Non-zero exit code 1 from /usr/bin/firewall-cmd --permanent --query-service ceph
INFO:cephadm:/usr/bin/firewall-cmd:stdout no
INFO:cephadm:Enabling firewalld service ceph in current zone...
INFO:cephadm:Non-zero exit code 1 from /usr/bin/firewall-cmd --permanent --query-port 8080/tcp
INFO:cephadm:/usr/bin/firewall-cmd:stdout no
INFO:cephadm:Enabling firewalld port 8080/tcp in current zone...
INFO:cephadm:Non-zero exit code 1 from /usr/bin/firewall-cmd --permanent --query-port 8443/tcp
INFO:cephadm:/usr/bin/firewall-cmd:stdout no
INFO:cephadm:Enabling firewalld port 8443/tcp in current zone...
INFO:cephadm:Non-zero exit code 1 from /usr/bin/firewall-cmd --permanent --query-port 9283/tcp
INFO:cephadm:/usr/bin/firewall-cmd:stdout no
INFO:cephadm:Enabling firewalld port 9283/tcp in current zone...        # æ‰“å¼€é˜²ç«å¢™ç«¯å£
INFO:cephadm:Wrote keyring to ceph.client.admin.keyring
INFO:cephadm:Wrote config to ceph.conf
INFO:cephadm:Waiting for mgr to start...
INFO:cephadm:Waiting for mgr...
INFO:cephadm:mgr not available, waiting (1/10)...
â€¦â€¦
INFO:cephadm:mgr not available, waiting (5/10)...
INFO:cephadm:Enabling cephadm module...
INFO:cephadm:Waiting for the mgr to restart...                          # é‡å¯mgr
INFO:cephadm:Waiting for Mgr epoch 5...
INFO:cephadm:Setting orchestrator backend to cephadm...
INFO:cephadm:Generating ssh key...
INFO:cephadm:Wrote public SSH key to to ceph.pub
INFO:cephadm:Adding key to root@localhost's authorized_keys...
INFO:cephadm:Adding host cepho...
INFO:cephadm:Deploying mon service with default placement...
INFO:cephadm:Deploying mgr service with default placement...
INFO:cephadm:Deploying crash service with default placement...
INFO:cephadm:Enabling the dashboard module...
INFO:cephadm:Waiting for the mgr to restart...
INFO:cephadm:Waiting for Mgr epoch 9...
INFO:cephadm:Generating a dashboard self-signed certificate...      # åˆå§‹åŒ–dashboard
INFO:cephadm:Creating initial admin user...
INFO:cephadm:Fetching dashboard port number...
INFO:cephadm:Ceph Dashboard is now available at:

	     URL: https://cepho:8443/
	    User: admin
	Password: tkl507cgh3                                            # åˆå§‹å¯†ç ï¼Œé»˜è®¤ç™»å½•ä¹‹åéœ€è¦ä¿®æ”¹

INFO:cephadm:You can access the Ceph CLI with:

	sudo /usr/sbin/cephadm shell --fsid d0d73402-6c28-11ea-8165-00505625d3e6 -c ceph.conf -k ceph.client.admin.keyring

INFO:cephadm:Please consider enabling telemetry to help improve Ceph:

	ceph telemetry on

For more information see:

	https://docs.ceph.com/docs/master/mgr/telemetry/

INFO:cephadm:Bootstrap complete.
```
è¯¥å‘½ä»¤ä¼šåšä»¥ä¸‹æ“ä½œï¼š

- åœ¨æœ¬åœ°ä¸»æœºä¸Šä¸ºé›†ç¾¤åˆ›å»º`mon`å’Œ`mgr`å®ˆæŠ¤ç¨‹åºã€‚

- ä¸º Ceph é›†ç¾¤ç”Ÿæˆä¸€ä¸ªæ–°çš„ SSH å¯†é’¥ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°`root`ç”¨æˆ·çš„`/root/.ssh/authorized_keys`æ–‡ä»¶ä¸­ã€‚

- å°†ä¸æ–°é›†ç¾¤é€šä¿¡æ‰€éœ€çš„æœ€å°é…ç½®æ–‡ä»¶å†™å…¥`/etc/ceph/ceph.conf`ã€‚

- å°†`client.admin`ç®¡ç†ï¼ˆç‰¹æƒï¼ï¼‰ç§˜å¯†å¯†é’¥çš„å‰¯æœ¬å†™å…¥`/etc/ceph/ceph.client.admin.keyring`ã€‚

- å°†å…¬å…±å¯†é’¥çš„å‰¯æœ¬å†™å…¥`/etc/ceph/ceph.pub`ã€‚

{%note info%}
**æ³¨æ„**ï¼š æ‰§è¡Œä¸Šè¿°å‘½ä»¤ä¼šå» docker ä¸Šé¢æ‹‰å–æœ€æ–°çš„`ceph/daemon-base`ï¼Œå›½å†…éœ€è¦æ¢æºã€‚å…·ä½“æ“ä½œå¦‚ä¸‹ï¼š
1. ç¼–è¾‘æˆ–æ–°å»ºé…ç½®æ–‡ä»¶ï¼š
 ```shell
 vi /etc/docker/daemon.json
 ```
 å†™å…¥ï¼š
 ```plain
{
"registry-mirrors" : [
    "http://ovfftd6p.mirror.aliyuncs.com",
    "http://registry.docker-cn.com",
    "http://docker.mirrors.ustc.edu.cn",
    "http://hub-mirror.c.163.com"
],
"insecure-registries" : [
    "registry.docker-cn.com",
    "docker.mirrors.ustc.edu.cn"
],
"debug" : true,
"experimental" : true
}
```
2. é‡å¯ docker æœåŠ¡
    ```plain
    systemctl restart docker
    ```
3. æ‰‹åŠ¨æ‹‰å–é•œåƒ
 ```shell
 docker pull ceph/daemon-base
 ```
ç”±äºæœ¬äººç¬¬ä¸€æ¬¡ä½¿ç”¨ dockerï¼Œæ‰€ä»¥ä¸€äº›è¡¨è¿°å¯èƒ½å­˜åœ¨é—®é¢˜ã€‚
:::
### è®¿é—® dashboard
![overview](https://cdn.jsdelivr.net/gh/masantu/statics/images/Ceph-dashboard-overview.png)
![Ceph-dashboard](https://cdn.jsdelivr.net/gh/masantu/statics/images/Ceph-dashboard-host.png)

é»˜è®¤çš„å¼•å¯¼è¡Œä¸ºé€‚ç”¨äºç»å¤§å¤šæ•°ç”¨æˆ·ã€‚ è¯·å‚é˜…ä»¥ä¸‹æœ‰å…³é€‰é¡¹å¯¹æŸäº›ç”¨æˆ·å¯èƒ½æœ‰ç”¨çš„ä¸€äº›ï¼Œæˆ–è¿è¡Œ `cephadm bootstrap -h` ä»¥æŸ¥çœ‹æ‰€æœ‰å¯ç”¨é€‰é¡¹ï¼š

- æ–¹ä¾¿èµ·è§ï¼ŒBootstrap ä¼šå°†è®¿é—®æ–°é›†ç¾¤æ‰€éœ€çš„æ–‡ä»¶å†™åˆ°`/etc/ceph`ä¸­ï¼Œä»¥ä¾¿ä¸»æœºæœ¬èº«å®‰è£…çš„ä»»ä½• Ceph è½¯ä»¶åŒ…ï¼ˆä¾‹å¦‚ï¼Œè®¿é—®å‘½ä»¤è¡Œç•Œé¢ï¼‰éƒ½å¯ä»¥è½»æ¾æ‰¾åˆ°å®ƒä»¬ã€‚

 ä½†æ˜¯ï¼Œä½¿ç”¨`cephadm`éƒ¨ç½²çš„å®ˆæŠ¤ç¨‹åºå®¹å™¨æ ¹æœ¬ä¸éœ€è¦`/etc/ceph`ã€‚ ä½¿ç”¨`--output-dir *directory>*`é€‰é¡¹å°†å®ƒä»¬æ”¾åœ¨ä¸åŒçš„ç›®å½•ï¼ˆå¦‚.<å½“å‰ç›®å½•>ï¼‰ä¸­ï¼Œé¿å…ä¸åŒä¸€ä¸»æœºä¸Šçš„ç°æœ‰ Ceph é…ç½®ï¼ˆ`cephadm`æˆ–å…¶ä»–ï¼‰ä¹‹é—´çš„æ½œåœ¨å†²çªã€‚

- æˆ‘ä»¬å¯ä»¥å°†ä»»ä½•åˆå§‹ Ceph é…ç½®é€‰é¡¹ä¼ é€’åˆ°æ–°é›†ç¾¤ï¼Œæ–¹æ³•æ˜¯å°†å®ƒä»¬æ”¾ç½®åœ¨æ ‡å‡†`ini`æ ·å¼çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œå¹¶ä½¿ç”¨`--config * <config-file> *`é€‰é¡¹ã€‚

### ä½¿èƒ½ CEPH CLI
ceph å®˜æ–¹å»ºè®®å¯ç”¨å¯¹ ceph å‘½ä»¤çš„è½»æ¾è®¿é—®ï¼Œæˆ‘ä»¬æœ‰ä»¥ä¸‹é€”å¾„å¯ä»¥å®ç°ï¼š
- è°ƒç”¨ cephadm shell å‘½ä»¤å¯åŠ¨å®¹å™¨ä¸­çš„ bash
    ```plain
    sudo /usr/sbin/cephadm shell --fsid d0d73402-6c28-11ea-8165-00505625d3e6 -c ceph.conf -k ceph.client.admin.keyring
    ```
    å…¶ä¸­çš„`fsid`å¯ä»¥åœ¨ä¸Šä¸€æ¡è¿”å›ä¿¡æ¯ä¸­æ‰¾åˆ°ï¼Œæˆ–è€…åœ¨`ceph.conf`ä¸­è¿›è¡ŒæŸ¥çœ‹ã€‚
    ```plain
    INFO:cephadm:Using recent ceph image ceph/daemon-base:latest
    
- å®‰è£… ceph-common åŒ…ï¼ŒåŒ…å«äº†`ceph`, `rbd`, `mount.ceph` (ç”¨äºæŒ‚è½½ CephFS æ–‡ä»¶ç³»ç»Ÿ)ç­‰ï¼›
    ```shell
    cephadm add-repo --release octopus          # æ­¤å¤„ä¼šæ›´æ–°æºï¼Œå¦‚æœéœ€è¦ä½¿ç”¨å›½å†…æºè¯·ä¸è¦æ‰§è¡Œ
    yum install ceph-common # æ­¤å¤„å®˜ç½‘æš‚ä¸ºcephadm install xxxï¼Œä½†æ˜¯æˆ‘æ‰§è¡Œä¹‹åæŠ¥é”™ï¼Œæ‰€ä»¥ä¿®æ”¹ã€‚
    ```
- è°ƒç”¨`ceph`å‘½ä»¤æŸ¥çœ‹é›†ç¾¤çŠ¶æ€
    ```plain
    ceph -s
    cluster:
        id:     d0d73402-6c28-11ea-8165-00505625d3e6
        health: HEALTH_WARN
                Reduced data availability: 1 pg inactive
                OSD count 0 < osd_pool_default_size 3

    services:
        mon: 1 daemons, quorum cepho (age 20m)
        mgr: cepho.lgqcve(active, since 18m)
        osd: 0 osds: 0 up, 0 in

    data:
        pools:   1 pools, 1 pgs
        objects: 0 objects, 0 B
        usage:   0 B used, 0 B / 0 B avail
        pgs:     100.000% pgs unknown
                1 unknown
    ```
- åœ¨`cephadm shell`ä¸­æŸ¥çœ‹é›†ç¾¤å¥åº·ä¿¡æ¯
    ```plain
    [ceph: root@cepho /]# ceph health
    HEALTH_WARN Reduced data availability: 1 pg inactive; OSD count 0 < osd_pool_default_size 3
    ```

---
TODO:ä»¥ä¸‹å¾…éªŒè¯

### é›†ç¾¤æ·»åŠ æ–°èŠ‚ç‚¹
1. åœ¨æ–°çš„èŠ‚ç‚¹æ‹·è´è®¤è¯`ssh key`è®¤è¯å¯†é’¥
åœ¨ bash ä¸­æ‰§è¡Œ
```plain
ssh-copy-id -f -i ceph.pub root@*<new-host>*    # æ–°èŠ‚ç‚¹çš„hostname
```
2. å‘Šè¯‰æ–°èŠ‚ç‚¹æ˜¯é›†ç¾¤çš„ä¸€éƒ¨åˆ†
åœ¨ cephadm shell ä¸­æ‰§è¡Œ
```plain
ceph orch host add *newhost*
```

## å‚è€ƒé“¾æ¥
- [Deploying a new Ceph cluster â€” Ceph Documentation](https://docs.ceph.com/docs/octopus/cephadm/install/#)