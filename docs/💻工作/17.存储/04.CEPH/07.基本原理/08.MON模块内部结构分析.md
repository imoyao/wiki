---
title: MON æ¨¡å—å†…éƒ¨ç»“æ„åˆ†æ

categories: 
  - ğŸ’»å·¥ä½œ
  - å­˜å‚¨
  - CEPH
  - åŸºæœ¬åŸç†
date: 2020-05-23 11:02:28
tags: null
permalink: /pages/a84bf8/
---

# 1. æ¨¡å—ç®€ä»‹
Monitor ä½œä¸º Ceph çš„ Metada Server ç»´æŠ¤äº†é›†ç¾¤çš„ä¿¡æ¯ï¼Œå®ƒåŒ…æ‹¬äº† 6 ä¸ª Mapï¼Œ
åˆ†åˆ«æ˜¯ MONMapï¼ŒOSDMapï¼ŒPGMapï¼ŒLogMapï¼ŒAuthMapï¼ŒMDSMapã€‚
å…¶ä¸­ PGMap å’Œ OSDMap æ˜¯æœ€é‡è¦çš„ä¸¤å¼  Mapã€‚

# 2. æ¨¡å—çš„åŸºæœ¬ç»“æ„
![image.png](https://upload-images.jianshu.io/upload_images/2099201-beca04aae58bef45.png)

1. Monitor å†…éƒ¨ä½¿ç”¨ä¸€å¥— Paxos æ¥å®ç°å„ç§æ•°æ®çš„æ›´æ–°ï¼Œæ‰€ä»¥æ‰€æœ‰ç»§æ‰¿è‡ª PaxosService çš„ Monitor
   å®ç°æ•°æ®æ›´æ–°æ—¶éœ€è¦é€šè¿‡ Paxos è¾¾æˆä¸€è‡´åæ‰èƒ½è¿›è¡Œã€‚
2. PaxosService çš„ dispatch å†…éƒ¨è°ƒç”¨å­ç±»çš„ preprocess_query è¿›è¡ŒæŸ¥è¯¢ç›¸å…³æ“ä½œï¼Œå¦‚æœéæŸ¥è¯¢ç±»å¤„ç†ï¼Œ
å†è°ƒç”¨å­ç±»çš„ prepare_update æ¥å£å®ç°æ•°æ®çš„æ›´æ–°ï¼Œæ‰€ä»¥å­ç±» Monitor å®ç°ä¸¤ä¸ªæ¥å£æ¥å¤„ç†ç›¸å…³çš„ä¸šåŠ¡æ¶ˆæ¯ã€‚

# 3. Monitor ä¸šåŠ¡æ¶ˆæ¯
## 3.1 Monitor è‡ªèº«
| æ¶ˆæ¯ç±»å‹ | æ¶ˆæ¯ç»“æ„ä½“ | æ¶ˆæ¯ä½œç”¨ | å¤„ç†æ¥å£ |
|:---:|:---:|:---:|:---:|
| CEPH_MSG_PING | MPing | å®šæœŸ Ping Monitor ç¡®è®¤ Monitor çš„å­˜åœ¨ | handle_ping |
| CEPH_MSG_MON_GET_MAP | MMonGetMap | è®¤è¯å‰è·å– MonMap | handle_mon_get_map |
| CEPH_MSG_MON_METADATA | MMonMetadata | å¤„ç†ä¿å­˜æŸä¸ª Monitor çš„ç³»ç»Ÿä¿¡æ¯ï¼ˆcpuï¼Œå†…å­˜ç­‰ï¼‰| handle_mon_metadata |
| MSG_MON_COMMAND | MMonCommand | ä¼ é€’å‘½ä»¤è¡Œæ¶ˆæ¯ç»™ Monitorï¼ŒMonitor å†åˆ†å‘ç»™ç›¸åº”çš„ XXXMonitor è¿›è¡Œå¤„ç† | handle_command |
| CEPH_MSG_MON_GET_VERSION | MMonGetVersion | è·å– cluster map çš„ç‰ˆæœ¬ä¿¡æ¯ | handle_get_version |
| CEPH_MSG_MON_SUBSCRIBE | MMonSubscribe | Cluster map è®¢é˜…æ›´æ–° | handle_subscribe |
| MSG_ROUTE | MRoute | è·¯ç”±è¯·æ±‚è½¬å‘ï¼ˆå¾…ç¡®è®¤ï¼‰ | handle_route |
| MSG_MON_PROBE | MMonProbe | å¯åŠ¨åŠ å…¥æ—¶éœ€è¦å‘å…¶ä»– Monitor å‘é€ Probe è¯·æ±‚ | handle_probe |
| MSG_MON_SYNC | MMonSync | åŒæ­¥ Paxos çŠ¶æ€æ•°æ® | handle_sync |
| MSG_MON_SCRUB | MMonScrub | MonitorDBStore æ•°æ®ä¸€è‡´æ€§æ£€æµ‹ | handle_scrub |
| MSG_MON_JOIN | MMonJoin | å¦‚æœä¸åœ¨ MonMap ä¸­ç”³è¯·åŠ å…¥åˆ° MonMap | MonmapMonitor::prepare_join |
| MSG_MON_PAXOS | MMonPaxos | é€‰ä¸¾å®Œæˆåï¼Œleader ä¼šè§¦å‘ Paxos::leader_initï¼ŒçŠ¶æ€ç½®ä¸º STATE_RECOVERINGï¼Œå¹¶å‘èµ·è¯¥æ¶ˆæ¯çš„ OP_COLLECT æµç¨‹ | Paxos::dispatch |
| MSG_MON_ELECTION | MMonElection | å‘èµ·é€‰ä¸¾æµç¨‹ | Elector::dispatch |
| MSG_FORWARD | MForward | å°†è¯·æ±‚è½¬å‘åˆ° leader | handle_forward |
| MSG_TIMECHECK | MTimeCheck | Monitor æ¯éš” mon_timecheck_interval æ£€æµ‹æ‰€æœ‰ Monitor çš„ç³»ç»Ÿæ—¶é—´æ¥æ£€æµ‹èŠ‚ç‚¹ä¹‹é—´çš„æ—¶é—´å·® | handle_timecheck |
| MSG_MON_HEALTH | MMonHealth | æ¯éš” mon_health_data_update_interval æ£€æµ‹å­˜æ”¾ Monitor ä¸Šé¢ä½¿ç”¨çš„ leveldb æ•°æ®çš„çŠ¶æ€ | HealthMonitor::service_dispatch |

## 3.2 AuthMonitor
| æ¶ˆæ¯ç±»å‹ | æ¶ˆæ¯ç»“æ„ä½“ | æ¶ˆæ¯ä½œç”¨ | å¤„ç†æ¥å£ |
|:---:|:---:|:---:|:---:|
| MSG_MON_COMMAND | MMonCommand | å¤„ç† ceph auth xxx å‘½ä»¤è¡Œç›¸å…³å¤„ç† | preprocess_command å¤„ç† ceph auth get/export/list ç­‰<br/>prepare_command å¤„ç† ceph auth import/add/get-or-create/caps ç­‰ |
| CEPH_MSG_AUTH | MAuth | å®ç°è®¤è¯å’Œæˆæƒæ¶ˆæ¯å¤„ç† | prep_auth |

## 3.3 OSDMonitor
| æ¶ˆæ¯ç±»å‹ | æ¶ˆæ¯ç»“æ„ä½“ | æ¶ˆæ¯ä½œç”¨ | å¤„ç†æ¥å£ |
|:---:|:---:|:---:|:---:|
| CEPH_MSG_MON_GET_OSDMAP | MMonGetOSDMap | è·å– OSDMap | preprocess_get_osdmap |
| MSG_OSD_MARK_ME_DOWN | MOSDMarkMeDown | OSD shutdown ä¹‹å‰é€šçŸ¥ Monitor å‘é€è¯¥æ¶ˆæ¯ | preprocess_mark_me_down <br/> prepare_mark_me_down |
| MSG_OSD_FAILURE | MOSDFailure | 1. OSD æ¯éš” OSD_TICK_INTERVAL æ£€æµ‹å¿ƒè·³æ— å“åº”çš„ OSDï¼Œå¹¶å°†å¤±è´¥çš„ OSD report ç»™ Monitor<br/> 2. Monitor åˆ¤æ–­ä¸ŠæŠ¥æ¬¡æ•°>=mon_osd_min_down_reportsï¼Œé‚£ä¹ˆå°±å°† target_osd æ ‡è¯†ä¸º down | preprocess_failure |
| MSG_OSD_BOOT | MOSDBoot | æ–° OSD åŠ å…¥æ—¶å‘é€è¯·æ±‚åˆ° Monitorï¼Œå‚è€ƒæ–° OSD çš„åŠ å…¥æµç¨‹ | preprocess_bootprepare_boot |
| MSG_OSD_ALIVE | MOSDAlive | OSD åˆ¤æ–­ up_thru_wanted å†³å®šæ˜¯å¦å‘é€è¯·æ±‚ç»™ Monitorï¼ŒMonitor å‘é€ Incremental OSDMap è¿”å›ç»™ OSD |preprocess_alive <br/>prepare_alive |
| MSG_OSD_PGTEMP | MOSDPGTemp | Primary OSD å¤„äº backfilling çŠ¶æ€æ— æ³•æä¾›è¯»å–æœåŠ¡æ—¶ï¼Œä¼šå‘é€è¯¥æ¶ˆæ¯åˆ° Monitorï¼Œå°† PG ä¸´æ—¶æ˜ å°„åˆ°å…¶ä»–çš„ OSD ä¸Šæä¾›å»æœåŠ¡ | preprocess_pgtemp<br/> prepare_pgtemp |
| MSG_REMOVE_SNAPS | MRemoveSnaps | åˆ é™¤å¿«ç…§ä¿¡æ¯ | prepare_remove_snaps |
| CEPH_MSG_POOLOP | MPoolOp | åˆ é™¤/åˆ›å»º Poolï¼Œåˆ›å»º/åˆ é™¤ pool å¿«ç…§ç­‰ | prepare_pool_op |

## 3.4  PGMonitor
| æ¶ˆæ¯ç±»å‹ | æ¶ˆæ¯ç»“æ„ä½“ | æ¶ˆæ¯ä½œç”¨ | å¤„ç†æ¥å£ |
|:---:|:---:|:---:|:---:|
| CEPH_MSG_STATFS | MStatfs | è¿”å›æ–‡ä»¶ç³»ç»Ÿ osd å ç”¨çš„ kb å®¹é‡ | handle_statfs |
| MSG_PGSTATS | MPGStats | æŸ¥è¯¢æˆ–è€…æ›´æ–° pg çŠ¶æ€ | preprocess_pg_stats <br/>prepare_pg_stats |
| MSG_GETPOOLSTATS | MGetPoolStats | è·å– pool æ±‡æ€»çŠ¶æ€ä¿¡æ¯ | preprocess_getpoolstats |
| MSG_MON_COMMAND | MMonCommand | å¤„ç† ceph pg xxx ç›¸å…³å‘½ä»¤è¡Œ | preprocess_command |

## 3.5 MonMapMonitor
| æ¶ˆæ¯ç±»å‹ | æ¶ˆæ¯ç»“æ„ä½“ | æ¶ˆæ¯ä½œç”¨ | å¤„ç†æ¥å£ |
|:---:|:---:|:---:|:---:|
| MSG_MON_JOIN | MMonJoin | æ›´æ–° MonMap | preprocess_join<br/>prepare_join |
| MSG_MON_COMMAND | MMonCommand | å¤„ç† ceph mon xxx ç›¸å…³å‘½ä»¤è¡Œ | preprocess_command<br/> prepare_command |

## 3.6 MDSMonitor
| æ¶ˆæ¯ç±»å‹ | æ¶ˆæ¯ç»“æ„ä½“ | æ¶ˆæ¯ä½œç”¨ | å¤„ç†æ¥å£ |
|:---:|:---:|:---:|:---:|
| MSG_MDS_BEACON | | | |
| MSG_MDS_OFFLOAD_TARGETS  | | | |

## 3.7 LogMonitor
| æ¶ˆæ¯ç±»å‹ | æ¶ˆæ¯ç»“æ„ä½“ | æ¶ˆæ¯ä½œç”¨ | å¤„ç†æ¥å£ |
|:---:|:---:|:---:|:---:|
| MSG_LOG | | | |
