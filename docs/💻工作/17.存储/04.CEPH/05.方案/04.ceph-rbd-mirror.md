---
title: ceph-rbd-mirror ç¾å¤‡æ–¹æ¡ˆ

tags: 
  - ceph
categories: 
  - ğŸ’»å·¥ä½œ
  - å­˜å‚¨
  - CEPH
  - æ–¹æ¡ˆ
date: 2020-05-23 11:02:28
permalink: /pages/6f7771/
---
## 1.1 åŸºæœ¬åŸç†
![image.png](https://upload-images.jianshu.io/upload_images/2099201-ecfd775a52afa2ee.png)

RBD Mirror åŸç†å…¶å®å’Œ MySQL çš„ä¸»ä»åŒæ­¥åŸç†éå¸¸ç±»ä¼¼ï¼Œå‰è€…åŸºäº journalingï¼Œåè€…åŸºäº binlogï¼Œç®€å•åœ°è¯´å°±æ˜¯åˆ©ç”¨æ—¥å¿—è¿›è¡Œå›æ”¾(replay)ï¼šé€šè¿‡åœ¨å­˜å‚¨ç³»ç»Ÿä¸­å¢åŠ  Mirror ç»„ä»¶ï¼Œé‡‡ç”¨å¼‚æ­¥å¤åˆ¶çš„æ–¹å¼ï¼Œå®ç°å¼‚åœ°å¤‡ä»½ã€‚(æ­¤å¤„çš„ journal æ˜¯æŒ‡ Ceph RBD çš„ journalï¼Œè€Œä¸æ˜¯ OSD çš„ journal)

è¯¥èƒ½åŠ›åˆ©ç”¨äº† RBD image çš„æ—¥å¿—ç‰¹æ€§ï¼Œä»¥ç¡®ä¿é›†ç¾¤é—´çš„å‰¯æœ¬å´©æºƒä¸€è‡´æ€§ã€‚é•œåƒåŠŸèƒ½éœ€è¦åœ¨åŒä¼´é›†ç¾¤ï¼ˆ peer clusters ï¼‰ä¸­çš„æ¯ä¸€ä¸ªå¯¹åº”çš„ pool ä¸Šè¿›è¡Œé…ç½®ï¼Œå¯è®¾å®šè‡ªåŠ¨å¤‡ä»½æŸä¸ªå­˜å‚¨æ± å†…çš„æ‰€æœ‰ images æˆ–ä»…å¤‡ä»½ images çš„ä¸€ä¸ªç‰¹å®šå­é›†ã€‚ rbd-mirror å®ˆæŠ¤è¿›ç¨‹è´Ÿè´£ä»è¿œç«¯é›†ç¾¤æ‹‰å– image çš„æ›´æ–°ï¼Œå¹¶å†™å…¥æœ¬åœ°é›†ç¾¤çš„å¯¹åº” image ä¸­ã€‚

å½“ RBD Journal åŠŸèƒ½æ‰“å¼€åï¼Œæ‰€æœ‰çš„æ•°æ®æ›´æ–°è¯·æ±‚ä¼šå…ˆå†™å…¥ RBD Journalï¼Œç„¶ååå°çº¿ç¨‹å†æŠŠæ•°æ®ä» Journal åŒºåŸŸåˆ·æ–°åˆ°å¯¹åº”çš„ image åŒºåŸŸã€‚RBD journal æä¾›äº†æ¯”è¾ƒå®Œæ•´çš„æ—¥å¿—è®°å½•ã€è¯»å–ã€å˜æ›´é€šçŸ¥ä»¥åŠæ—¥å¿—å›æ”¶å’Œç©ºé—´é‡Šæ”¾ç­‰åŠŸèƒ½ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼çš„æ—¥å¿—ç³»ç»Ÿã€‚

## 1.2 å·¥ä½œæµç¨‹
![image.png](https://upload-images.jianshu.io/upload_images/2099201-7594cafde2621a95.png)

1ã€å½“æ¥æ”¶åˆ°ä¸€ä¸ªå†™å…¥è¯·æ±‚åï¼ŒI/O ä¼šå…ˆå†™å…¥ä¸»é›†ç¾¤çš„ Image Journal
2ã€Journal å†™å…¥æˆåŠŸåï¼Œé€šçŸ¥å®¢æˆ·ç«¯
3ã€å®¢æˆ·ç«¯å¾—åˆ°å“åº”åï¼Œå¼€å§‹å†™å…¥ image
3ã€å¤‡ä»½é›†ç¾¤çš„ mirror è¿›ç¨‹å‘ç°ä¸»é›†ç¾¤çš„ Journal æœ‰æ›´æ–°åï¼Œä»ä¸»é›†ç¾¤çš„ Journal è¯»å–æ•°æ®ï¼Œå†™å…¥å¤‡ä»½é›†ç¾¤ï¼ˆå’Œä¸Šé¢åºå·ä¸€æ ·ï¼Œæ˜¯å› ä¸ºè¿™ä¸¤ä¸ªè¿‡ç¨‹åŒæ—¶å‘ç”Ÿï¼‰
4ã€å¤‡ä»½é›†ç¾¤å†™å…¥æˆåŠŸåï¼Œä¼šæ›´æ–°ä¸»é›†ç¾¤ Journal ä¸­çš„å…ƒæ•°æ®ï¼Œè¡¨ç¤ºè¯¥ I/O çš„ Journal å·²ç»åŒæ­¥å®Œæˆ
5ã€ä¸»é›†ç¾¤ä¼šå®šæœŸæ£€æŸ¥ï¼Œåˆ é™¤å·²ç»å†™å…¥å¤‡ä»½é›†ç¾¤çš„ Journal æ•°æ®ã€‚
ä»¥ä¸Šå°±æ˜¯ä¸€ä¸ª rbd-mirror å·¥ä½œå‘¨æœŸå†…çš„æµç¨‹ï¼Œåœ¨ç°æœ‰çš„ Jewel ç‰ˆæœ¬ä¸­ 30s ä¸ºä¸€æ¬¡å·¥ä½œå‘¨æœŸï¼Œæš‚æ—¶ä¸èƒ½æ”¹å˜è¿™ä¸ªå‘¨æœŸæ—¶é—´ã€‚

## 1.3 ä¼˜ç‚¹
1ã€å½“å‰¯æœ¬åœ¨å¼‚åœ°çš„æƒ…å†µä¸‹ï¼Œå‡å°‘äº†å•ä¸ªé›†ç¾¤ä¸åŒèŠ‚ç‚¹é—´çš„æ•°æ®å†™å…¥å»¶æ—¶ï¼›

2ã€å‡å°‘æœ¬åœ°é›†ç¾¤æˆ–å¼‚åœ°é›†ç¾¤ç”±äºæ„å¤–æ–­ç”µå¯¼è‡´çš„æ•°æ®ä¸¢å¤±ã€‚

## 1.4 å•å‘å¤‡ä»½ä¸åŒå‘å¤‡ä»½
åŒå‘å¤‡ä»½ï¼šä¸¤ä¸ªé›†ç¾¤ä¹‹é—´äº’ç›¸åŒæ­¥ï¼Œä¸¤ä¸ªé›†ç¾¤éƒ½è¦è¿è¡Œ rbd-mirror è¿›ç¨‹ã€‚
å•å‘å¤‡ä»½ï¼šåˆ†ä¸ºä¸»é›†ç¾¤å’Œä»é›†ç¾¤ï¼Œåªåœ¨ä»é›†ç¾¤è¿è¡Œ rbd-mirror è¿›ç¨‹ï¼Œä¸»é›†ç¾¤çš„ä¿®æ”¹ä¼šè‡ªåŠ¨åŒæ­¥åˆ°ä»é›†ç¾¤ã€‚

## 1.5 å®‰è£…é¡»çŸ¥
 - RBD é•œåƒåŠŸèƒ½éœ€è¦ Ceph Jewel æˆ–æ›´æ–°çš„å‘è¡Œç‰ˆæœ¬ã€‚
 - ç›®å‰ Jewel ç‰ˆæœ¬åªæ”¯æŒä¸€å¯¹ä¸€ï¼Œä¸æ”¯æŒä¸€å¯¹å¤šã€‚
 - ä¸¤ä¸ªé›†ç¾¤ (local å’Œ remote) éœ€è¦èƒ½å¤Ÿäº’é€šã€‚
 - RBD éœ€è¦å¼€å¯ journal ç‰¹æ€§ï¼Œ å¯åŠ¨åä¼šè®°å½• image çš„äº‹ä»¶ã€‚

# 2. mirroring æ¨¡å¼
mirroring æ˜¯åŸºäºå­˜å‚¨æ± è¿›è¡Œçš„ peerï¼Œceph æ”¯æŒä¸¤ç§æ¨¡å¼çš„é•œåƒï¼Œæ ¹æ®é•œåƒæ¥åˆ’åˆ†æœ‰ï¼š

**å­˜å‚¨æ± æ¨¡å¼**

*   ä¸€ä¸ªå­˜å‚¨æ± å†…çš„æ‰€æœ‰é•œåƒéƒ½ä¼šè¿›è¡Œå¤‡ä»½

**é•œåƒæ¨¡å¼**

*   åªæœ‰æŒ‡å®šçš„é•œåƒæ‰ä¼šè¿›è¡Œå¤‡ä»½

[å‚è§](http://wiki.intra.xiaojukeji.com/pages/viewpage.action?pageId=117858533)

## 2.1 å­˜å‚¨æ± æ¨¡å¼
### 2.1.1 åˆ›å»ºå­˜å‚¨æ± 
åˆ›å»ºä¸€ä¸ªç”¨äºæµ‹è¯•çš„å­˜å‚¨æ± ï¼š
```plain
#localé›†ç¾¤
ceph osd pool create test_pool 100 100 replicated --cluster=local
pool 'test_pool' created

#remoteé›†ç¾¤
ceph osd pool create test_pool 100 100 replicated --cluster=remote
pool 'test_pool' created
```
### 2.1.2 å¯ç”¨å­˜å‚¨æ± æ¨¡å¼
å¼€å¯å­˜å‚¨æ±  rbdmirror çš„é•œåƒåŠŸèƒ½ï¼š
```plain
#localé›†ç¾¤
rbd  mirror pool enable test_pool pool --cluster=local

#remoteé›†ç¾¤
rbd mirror pool enable test_pool pool --cluster=remote
```
### 2.1.3 åˆ›å»º RBD
ä¸»é›†ç¾¤åˆ›å»ºä¸€ä¸ªæµ‹è¯•ç”¨çš„ RBDï¼š
```plain
rbd create test_pool/test_image --size=1024 --cluster=local
```
### 2.1.4 ä¸»é›†ç¾¤å¼€å¯ jounaling ç‰¹æ€§
å¯åŠ¨åä¼šæ‰ä¼šè®°å½• image çš„äº‹ä»¶ï¼Œæ‰å¯ä»¥è¢« rbd-mirror æ£€æµ‹åˆ°å¹¶åŒæ­¥åˆ°ä»é›†ç¾¤ï¼š
```plain
rbd feature enable test_pool/test_image exclusive-lock
rbd feature enable test_pool/test_image journaling
```
### 2.1.5. å¢åŠ åŒä¼´é›†ç¾¤
æŠŠ local å’Œ remote è®¾ä¸ºåŒä¼´ï¼Œè¿™ä¸ªæ˜¯ä¸ºäº†è®© rbd-mirror è¿›ç¨‹æ‰¾åˆ°å®ƒ peer çš„é›†ç¾¤çš„å­˜å‚¨æ± ï¼š
```plain
rbd mirror pool peer add test_pool client.admin@remote --cluster=local

rbd mirror pool peer add test_pool client.admin@local --cluster=remote

#å¦‚æœéœ€è¦åˆ é™¤peer è¯­æ³•ï¼š
rbd mirror pool peer remove <pool-name> <peer-uuid>
```
æŸ¥çœ‹ peer çš„æƒ…å†µï¼š
```plain
rbd mirror pool info --pool=test_pool --cluster=local
Mode: pool
Peers:
UUID NAME CLIENT
f0929e85-259d-450b-917e-9eb231b7e43b remote client.admin


rbd mirror pool info --pool=test_pool --cluster=remote
Mode: pool
Peers:
UUID NAME CLIENT
5851ba6a-e383-4ef0-9b9d-5ae34c9518a6 local client.admin
```
### 2.1.6 å¼€å¯ rbd-mirror çš„åŒæ­¥è¿›ç¨‹
a. å…ˆç”¨è°ƒè¯•æ¨¡å¼å¯åŠ¨è¿›ç¨‹çœ‹çœ‹æƒ…å†µï¼Œåœ¨ remote çš„æœºå™¨ä¸Šæ‰§è¡Œ
```plain
#remote:
rbd-mirror -d --setuser ceph --setgroup ceph --cluster remote -i admin
```
b. å¦‚æœç¡®è®¤æ²¡é—®é¢˜å°±ç”¨æœåŠ¡æ¥æ§åˆ¶å¯åŠ¨
```plain
#remote
vim /usr/lib/systemd/system/ceph-rbd-mirror@.service

#ä¿®æ”¹
Environment=CLUSTER=remote
```
c. åœ¨ remote æœºå™¨ä¸Šå¯åŠ¨
```plain
systemctl start ceph-rbd-mirror@admin
ps -ef|grep rbd
ceph 4325 1 1 17:59 ? 00:00:00 /usr/bin/rbd-mirror -f --cluster remote --id admin --setuser ceph --setgroup ceph
```
### 2.1.7 æ£€æŸ¥åŒæ­¥ç»“æœ
a. æŸ¥è¯¢ local é›†ç¾¤é•œåƒçš„åŒæ­¥çš„çŠ¶æ€
```plain
#local
rbd mirror image status test_pool/test_image --cluster remote
test_image:
 global_id: dabdbbed-7c06-4e1d-b860-8dd104509565
 state: up+replaying
 description: replaying, master_position=[object_number=2, tag_tid=2, entry_tid=3974], mirror_position=[object_number=3, tag_tid=2, entry_tid=2583], entries_behind_master=1391
 last_update: 2017-01-22 17:54:22
```
b. æ£€æŸ¥æ•°æ®æ˜¯å¦åŒæ­¥åˆ° remote é›†ç¾¤
```plain
#remote
rbd info test_pool/test_image
```

## 2.2 é•œåƒæ¨¡å¼
### 2.2.1 ä¸»é›†ç¾¤å¼€å¯ jounaling ç‰¹æ€§
å¯åŠ¨åä¼šæ‰ä¼šè®°å½• image çš„äº‹ä»¶ï¼Œæ‰å¯ä»¥è¢« rbd-mirror æ£€æµ‹åˆ°å¹¶åŒæ­¥åˆ°ä»é›†ç¾¤
```plain
#local
rbd feature enable test_pool/test_image exclusive-lock
rbd feature enable test_pool/test_image journaling
```
### 2.2.2 å¼€å¯å­˜å‚¨æ± çš„ mirror çš„æ¨¡å¼
```plain
#local:
rbd mirror pool enable test_pool image

#remote:
ceph osd pool create test_pool 100 100 replicated --cluster=remote
pool 'rbdmirror' created

rbd mirror pool enable test_pool image
```
### 2.2.3 å¼€å¯ image çš„ mirror
```plain
#local
rbd mirror image enable test_pool/test_image
Mirroring enabled

rbd info test_pool/test_image --cluster=local
rbd image 'test_image':
 size 10240 MB in 2560 objects
 order 22 (4096 kB objects)
 block_name_prefix: rbd_data.105774b0dc51
 format: 2
 features: layering, exclusive-lock, journaling
 flags:
 create_timestamp: Wed Dec 13 16:46:08 2017
 journal: 105774b0dc51
 mirroring state: enabled
 mirroring global id: 013f9e35-9d08-40fc-bf24-1e11a07a0910
 mirroring primary: true
```
### 2.2.4 å¢åŠ åŒä¼´é›†ç¾¤
æŠŠ local å’Œ remote è®¾ä¸ºåŒä¼´ï¼Œè¿™ä¸ªæ˜¯ä¸ºäº†è®© rbd-mirror è¿›ç¨‹æ‰¾åˆ°å®ƒ peer çš„é›†ç¾¤çš„å­˜å‚¨æ± ï¼š
```plain
rbd mirror pool peer add test_pool client.admin@remote --cluster=local

rbd mirror pool peer add test_pool client.admin@local --cluster=remote

#å¦‚æœéœ€è¦åˆ é™¤peer è¯­æ³•ï¼š
rbd mirror pool peer remove <pool-name> <peer-uuid>
```
æŸ¥çœ‹ peer çš„æƒ…å†µï¼š
```plain
rbd mirror pool info --pool=test_pool --cluster=local
Mode: pool
Peers:
UUID NAME CLIENT
f0929e85-259d-450b-917e-9eb231b7e43b remote client.admin


rbd mirror pool info --pool=test_pool --cluster=remote
Mode: pool
Peers:
UUID NAME CLIENT
5851ba6a-e383-4ef0-9b9d-5ae34c9518a6 local client.admin
```
### 2.2.5 å¼€å¯ rbd-mirror çš„åŒæ­¥è¿›ç¨‹
a. å…ˆç”¨è°ƒè¯•æ¨¡å¼å¯åŠ¨è¿›ç¨‹çœ‹çœ‹æƒ…å†µï¼Œåœ¨ remote çš„æœºå™¨ä¸Šæ‰§è¡Œ
```plain
#remote:
rbd-mirror -d --setuser ceph --setgroup ceph --cluster remote -i admin
```
b. å¦‚æœç¡®è®¤æ²¡é—®é¢˜å°±ç”¨æœåŠ¡æ¥æ§åˆ¶å¯åŠ¨
```plain
#remote
vim /usr/lib/systemd/system/ceph-rbd-mirror@.service

#ä¿®æ”¹
Environment=CLUSTER=remote
```
c. åœ¨ remote æœºå™¨ä¸Šå¯åŠ¨
```plain
systemctl start ceph-rbd-mirror@admin
ps -ef|grep rbd
ceph 4325 1 1 17:59 ? 00:00:00 /usr/bin/rbd-mirror -f --cluster remote --id admin --setuser ceph --setgroup ceph
```
### 2.2.6 æ£€æŸ¥åŒæ­¥ç»“æœ
a. æŸ¥è¯¢ local é›†ç¾¤é•œåƒçš„åŒæ­¥çš„çŠ¶æ€
```plain
#local
rbd mirror image status test_pool/test_image --cluster remote
test_image:
 global_id: dabdbbed-7c06-4e1d-b860-8dd104509565
 state: up+replaying
 description: replaying, master_position=[object_number=2, tag_tid=2, entry_tid=3974], mirror_position=[object_number=3, tag_tid=2, entry_tid=2583], entries_behind_master=1391
 last_update: 2017-01-22 17:54:22
```
b. æ£€æŸ¥æ•°æ®æ˜¯å¦åŒæ­¥åˆ° remote é›†ç¾¤
```plain
#remote
rbd info test_pool/test_image
```

# 3. æµ‹è¯•å¯¹æ¯”æŠ¥å‘Š
## 3.1 å•ä¸»é›†ç¾¤æ€§èƒ½
### 3.1.1 rbd æ€§èƒ½æµ‹è¯•
1. é¡ºåºè¯»å†™
//block size æ˜¯ 4Mï¼Œ30 ä¸ªçº¿ç¨‹å¹¶å‘
æµ‹è¯•ç»“æœï¼š30 çº¿ç¨‹å¹¶å‘ï¼Œå¸¦å®½ï¼š935 MB/s  å¹³å‡ IOPSï¼š228.33
```plain
rbd bench-write test_image  --io-threads 30  --pool=test_pool   --io-pattern seq --io-total 17199730000 --io-size 4096000
elapsed:    18  ops:     4200  ops/sec:   228.33  bytes/sec: 935243763.72
```
2. éšæœºè¯»å†™
//block size æ˜¯ 4Mï¼Œ30 ä¸ªçº¿ç¨‹å¹¶å‘
æµ‹è¯•ç»“æœï¼š30 çº¿ç¨‹å¹¶å‘ï¼Œå¸¦å®½ï¼š936 MB/s  å¹³å‡ IOPSï¼š 228.57
```plain
rbd bench-write test_image  --io-threads 30  --pool=test_pool   --io-pattern rand --io-total 17199730000 --io-size 4096000
elapsed:    18  ops:     4200  ops/sec:   228.57  bytes/sec: 936229596.77
```
## 3.2 ä¸»å¤‡é›†ç¾¤æ€§èƒ½
### 3.2.1 rbd æ€§èƒ½æµ‹è¯•
1. é¡ºåºè¯»å†™
//block size æ˜¯ 4Mï¼Œ30 ä¸ªçº¿ç¨‹å¹¶å‘
æµ‹è¯•ç»“æœï¼š30 çº¿ç¨‹å¹¶å‘ï¼Œå¸¦å®½ï¼š182 MB/s å¹³å‡ IOPSï¼š44.53
```plain
rbd bench-write test_image  --io-threads 30  --pool=test_pool   --io-pattern seq --io-total 17199730000 --io-size 4096000
elapsed:    94  ops:     4200  ops/sec:    44.53  bytes/sec: 182382108.66
```
2. éšæœºè¯»å†™
//block size æ˜¯ 4Mï¼Œ30 ä¸ªçº¿ç¨‹å¹¶å‘
æµ‹è¯•ç»“æœï¼š30 çº¿ç¨‹å¹¶å‘ï¼Œå¸¦å®½ï¼š149 MB/s  å¹³å‡ IOPSï¼š 36.50
```plain
rbd bench-write test_image  --io-threads 30  --pool=test_pool   --io-pattern rand --io-total 17199730000 --io-size 4096000
elapsed:   115  ops:     4200  ops/sec:    36.50  bytes/sec: 149499469.69
```
## 3.3 æµ‹è¯•ç»“æœ
é€šè¿‡æµ‹è¯•ç»“æœå¯ä»¥çœ‹å‡ºå¯ç”¨ rbd-mirror ä¼šå¯¼è‡´ä¸»é›†ç¾¤æ€§èƒ½ä¸‹é™ 5 å€å¤šã€‚
å·¥å…· |  é›†ç¾¤æ¨¡å¼ | å—å¤§å° | å¹¶å‘æ•° | é¡ºåºè¯»å†™ | éšæœºè¯»å†™ |
---|---|---|---|---|---|
rbd bench-write | å•ä¸»é›†ç¾¤ | 4M | 30 | å¸¦å®½ï¼š935 MB/s <br/>å¹³å‡ IOPSï¼š228.33 | å¸¦å®½ï¼š936 MB/s <br/>å¹³å‡ IOPSï¼š 228.57
rbd bench-write | ä¸»å¤‡é›†ç¾¤ | 4M | 30 | å¸¦å®½ï¼š182 MB/s <br/>å¹³å‡ IOPSï¼š44.53 | å¸¦å®½ï¼š149 MB/s <br/>å¹³å‡ IOPSï¼š 36.50

# 4. åˆ†æåŸå› 
## 4.1 journal æµç¨‹
1. å½“ RBD Journal åŠŸèƒ½æ‰“å¼€åï¼Œæ‰€æœ‰çš„æ•°æ®æ›´æ–°è¯·æ±‚ä¼šå…ˆå†™å…¥ Image Journal
2. å†™å…¥æˆåŠŸåï¼Œé€šçŸ¥å®¢æˆ·ç«¯
3. å®¢æˆ·ç«¯å¾—åˆ°å“åº”åï¼Œå¼€å§‹å†™ image
4. å¤‡ä»½é›†ç¾¤çš„ mirror è¿›ç¨‹å‘ç°ä¸»é›†ç¾¤çš„ Journal æœ‰æ›´æ–°åï¼Œä»ä¸»é›†ç¾¤çš„ Journal è¯»å–æ•°æ®ï¼Œå†™å…¥å¤‡ä»½é›†ç¾¤
5. å¤‡ä»½é›†ç¾¤å†™å…¥æˆåŠŸåï¼Œä¼šæ›´æ–°ä¸»é›†ç¾¤ Journal ä¸­çš„å…ƒæ•°æ®ï¼Œè¡¨ç¤ºè¯¥ I/O çš„ Journal å·²ç»åŒæ­¥å®Œæˆ

## 4.2 ä¼˜åŒ–
 - Use a small SSD/NVMe-backed pool for journals
     - â€˜rbd journal pool = <fast pool name>â€™
 - Batch multiple events into a single journal append
     - â€˜rbd journal object flush age = <seconds>â€™
 - Increase journal data width to match queue depth
    - â€˜rbd journal splay width = <number of objects>â€™
 - Future work: potentially parallelize journal append + image write between write barriers
```plain
1. rbd journal pool åŠŸèƒ½æ²¡å®ç°
sudo ceph daemon osd.0 config set rbd_journal_pool = test_pool3
{
    "error": "error setting 'rbd_journal_pool' to '= test_pool3': (38) Function not implemented"
}

2. è°ƒæ•´å‚æ•°ä»10-100ï¼Œæ•ˆæœä¸æ˜æ˜¾
rbd_journal_object_flush_age = 100
rbd_journal_splay_width = 100
```
## 4.3 å®˜æ–¹å¾…æ”¹è¿›
### 4.3.1 å¼•å…¥ä¸€è‡´æ€§ç»„
1. journaling å¯ä»¥çœ‹åšæ˜¯å¦ä¸€ä¸ª rbd çš„ imageï¼ˆä¸€äº› rados å¯¹è±¡ï¼‰ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå…ˆå†™æ—¥å¿—ï¼Œç„¶åè¿”å›å®¢æˆ·ç«¯ï¼Œç„¶åè¢«å†™å…¥åº•å±‚çš„ rbd çš„ imageï¼Œå‡ºäºæ€§èƒ½è€ƒè™‘ï¼Œè¿™ä¸ª journal å¯ä»¥è·Ÿå®ƒçš„é•œåƒä¸åœ¨ä¸€ä¸ªå­˜å‚¨æ± å½“ä¸­ã€‚

2. ç›®å‰æ˜¯ä¸€ä¸ª image ä¸€ä¸ª journalï¼Œæœ€è¿‘åº”è¯¥ä¼šæ²¿ç”¨è¿™ä¸ªç­–ç•¥ï¼Œç›´åˆ° ceph å¼•å…¥ä¸€è‡´æ€§ç»„ã€‚å…³äºä¸€è‡´æ€§ç»„çš„æ¦‚å¿µå°±æ˜¯ä¸€ç»„å·ï¼Œç„¶åç”¨çš„æ˜¯ä¸€ä¸ª RBD imageã€‚å¯ä»¥åœ¨æ‰€æœ‰çš„ç»„ä¸­æ‰§è¡Œå¿«ç…§æ“ä½œï¼Œæœ‰äº†ä¸€è‡´æ€§çš„ä¿è¯ï¼Œæ‰€æœ‰çš„å·å°±éƒ½åœ¨ä¸€è‡´çš„çŠ¶æ€ã€‚

3.å½“ä¸€è‡´æ€§ç»„å®ç°çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨ä¸€ä¸ª journal æ¥ç®¡ç†æ‰€æœ‰çš„ RBD çš„é•œåƒï¼Œå¯ä»¥ç»™ä¸€ä¸ªå·²ç»å­˜åœ¨ image å¼€å¯ journalï¼Œceph å°†ä¼šå°†ä½ çš„é•œåƒåšä¸€ä¸ªå¿«ç…§ï¼Œç„¶åå¯¹å¿«ç…§åšä¸€ä¸ªå¤åˆ¶ï¼Œç„¶åå¼€å¯ journalï¼Œè¿™éƒ½æ˜¯åå°æ‰§è¡Œçš„ä¸€ä¸ªä»»åŠ¡å¯ä»¥å¯ç”¨å’Œå…³é—­å•ä¸ªé•œåƒæˆ–è€…å­˜å‚¨æ± çš„ mirror åŠŸèƒ½ï¼Œ

å¦‚æœå¯ç”¨äº† journal åŠŸèƒ½ï¼Œé‚£ä¹ˆæ¯ä¸ªé•œåƒå°†ä¼šè¢«å¤åˆ¶å¯ä»¥ä½¿ç”¨ rbd mirror pool enable å¯ç”¨å®ƒã€‚

### 4.3.2 å¹¶è¡Œå†™

1.Â Future work: potentially parallelize journal append + image write between write barriers

2. å‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://events.static.linuxfound.org/sites/events/files/slides/Disaster%20Recovery%20and%20Ceph%20Block%20Storage-%20Introducing%20Multi-Site%20Mirroring_0.pdf)å¦‚ä¸‹ï¼š
![image.png](https://upload-images.jianshu.io/upload_images/2099201-a6a5353f44dc4c15.png)

3. å®˜æ–¹ç±»ä¼¼é—®é¢˜ï¼š[https://www.spinics.net/lists/ceph-users/msg31676.html](https://www.spinics.net/lists/ceph-users/msg31676.html)
![image.png](https://upload-images.jianshu.io/upload_images/2099201-27c244104df33dbd.png)

## 4.4 ç»“è®º
ç”±äºæ ¸å¿ƒæµç¨‹å°±æ˜¯å…ˆå†™æ—¥å¿—ï¼Œç„¶åå†™ image éœ€è¦å†™ä¸¤ä»½çš„é€»è¾‘ï¼Œæ‰€ä»¥å¯¼è‡´æ€§èƒ½å°±ä¼šæœ‰æŸå¤±ã€‚
æ ¹æ®å®˜æ–¹çš„å‚æ•°ä¼˜åŒ–ä¹Ÿæ²¡æœ‰æ˜æ˜¾çš„æ•ˆæœï¼Œå»ºè®®ç­‰å¾…å®˜æ–¹æ›´æ–° featuresã€‚
