---
title: æ”¯ä»˜ç³»ç»Ÿç­–ç•¥æ¨¡å¼å®ç°ä»£ç 
date: 2025-06-04 15:11:39
permalink: /pages/purchase-strage/
categories:
  - ğŸ’»å·¥ä½œ
  - å¤‡å¿˜å½•
tags:
  - è®¾è®¡æ¨¡å¼
  - é¡¹ç›®
  - æ”¯ä»˜ç³»ç»Ÿ
---
æ ¹æ®éœ€æ±‚æè¿°ï¼Œæˆ‘ä»¬ä½¿ç”¨ç­–ç•¥æ¨¡å¼æ¥å®ç°æ”¯ä»˜ç³»ç»Ÿä¸­çš„ä¸åŒè´­ä¹°è¡Œä¸ºï¼ˆæ–°è´­ã€å‡çº§ã€ç»­è´¹ï¼‰ã€‚ç­–ç•¥æ¨¡å¼é€‚ç”¨äºéœ€è¦æ ¹æ®ä¸åŒæ¡ä»¶é€‰æ‹©ä¸åŒç®—æ³•çš„åœºæ™¯ï¼Œè¿™é‡Œæ¯ç§è´­ä¹°è¡Œä¸ºéƒ½æœ‰ç‹¬ç«‹çš„æ”¯ä»˜é‡‘é¢å’Œæœ‰æ•ˆæœŸè®¡ç®—é€»è¾‘ï¼Œå› æ­¤ç­–ç•¥æ¨¡å¼æ˜¯åˆé€‚çš„é€‰æ‹©ã€‚

### å®ç°æ–¹æ¡ˆ

1. å®šä¹‰æŠ½è±¡ç­–ç•¥æ¥å£ `PurchaseStrategy`ï¼ŒåŒ…å«è®¡ç®—æ”¯ä»˜é‡‘é¢å’Œæœ‰æ•ˆæœŸçš„æŠ½è±¡æ–¹æ³•
2. å®ç°ä¸‰ç§å…·ä½“ç­–ç•¥ï¼š
   - `NewPurchaseStrategy`ï¼šå¤„ç†æ–°è´­é€»è¾‘
   - `UpgradeStrategy`ï¼šå¤„ç†å‡çº§é€»è¾‘
   - `RenewalStrategy`ï¼šå¤„ç†ç»­è´¹é€»è¾‘
3. ä½¿ç”¨ä¸Šä¸‹æ–‡ç±» `PurchaseContext` æ¥æ‰§è¡Œç­–ç•¥

### ä»£ç å®ç°

```python
from abc import ABC, abstractmethod
from datetime import datetime, timedelta

class PurchaseStrategy(ABC):
    """è´­ä¹°ç­–ç•¥æŠ½è±¡æ¥å£"""
    @abstractmethod
    def calculate_amount(self, context: dict) -> float:
        pass
    
    @abstractmethod
    def calculate_expiration(self, context: dict) -> datetime:
        pass

class NewPurchaseStrategy(PurchaseStrategy):
    """æ–°è´­ç­–ç•¥"""
    def calculate_amount(self, context: dict) -> float:
        # æ–°è´­ç›´æ¥ä½¿ç”¨æœåŠ¡ä»·æ ¼
        return context['service_price']
    
    def calculate_expiration(self, context: dict) -> datetime:
        # æ–°è´­é»˜è®¤ä¸€å¹´æœ‰æ•ˆæœŸ
        return context['current_time'] + timedelta(days=365)

class UpgradeStrategy(PurchaseStrategy):
    """å‡çº§ç­–ç•¥"""
    def calculate_amount(self, context: dict) -> float:
        # è®¡ç®—å·®ä»· = (æ–°æœåŠ¡ä»·æ ¼ - æ—§æœåŠ¡ä»·æ ¼) * å‰©ä½™æ—¶é—´æ¯”ä¾‹
        time_used = (context['current_time'] - context['original_start_time']).days
        total_duration = 365  # å‡è®¾åŸæœåŠ¡ä¸€å¹´æœŸ
        remaining_ratio = 1 - time_used / total_duration
        return (context['new_service_price'] - context['original_service_price']) * remaining_ratio
    
    def calculate_expiration(self, context: dict) -> datetime:
        # æ–°åˆ°æœŸæ—¶é—´ = å½“å‰æ—¶é—´ + å‰©ä½™æ—¶é—´ + æ–°æœåŠ¡æ—¶é•¿
        original_remaining = context['original_expiration'] - context['current_time']
        new_duration = timedelta(days=365)  # æ–°æœåŠ¡ä¸€å¹´
        return context['current_time'] + original_remaining + new_duration

class RenewalStrategy(PurchaseStrategy):
    """ç»­è´¹ç­–ç•¥"""
    def calculate_amount(self, context: dict) -> float:
        # ç»­è´¹ä»·æ ¼ = æœåŠ¡ä»·æ ¼ Ã— ç»­è´¹å¹´é™
        return context['service_price'] * context['renewal_years']
    
    def calculate_expiration(self, context: dict) -> datetime:
        # åœ¨åŸå§‹åˆ°æœŸæ—¶é—´ä¸Šå¢åŠ ç»­è´¹å¹´é™
        return context['original_expiration'] + timedelta(days=365 * context['renewal_years'])

class PurchaseContext:
    """è´­ä¹°ä¸Šä¸‹æ–‡ï¼Œæ‰§è¡Œå…·ä½“ç­–ç•¥"""
    def __init__(self, strategy: PurchaseStrategy):
        self._strategy = strategy
    
    def execute_calculation(self, context: dict) -> dict:
        """æ‰§è¡Œç­–ç•¥è®¡ç®—"""
        return {
            "amount": self._strategy.calculate_amount(context),
            "expiration": self._strategy.calculate_expiration(context)
        }

# ç¤ºä¾‹ä½¿ç”¨
if __name__ == "__main__":
    # å…¬å…±å‚æ•°
    current_time = datetime.now()
    original_start_time = current_time - timedelta(days=100)  # å‡è®¾100å¤©å‰è´­ä¹°
    original_expiration = original_start_time + timedelta(days=365)  # åŸæœåŠ¡æœ‰æ•ˆæœŸ
    
    # æ–°è´­ç¤ºä¾‹
    new_purchase_context = {
        'current_time': current_time,
        'service_price': 100.0
    }
    context = PurchaseContext(NewPurchaseStrategy())
    result = context.execute_calculation(new_purchase_context)
    print(f"æ–°è´­ç»“æœ: é‡‘é¢={result['amount']}, åˆ°æœŸæ—¶é—´={result['expiration']}")
    
    # å‡çº§ç¤ºä¾‹
    upgrade_context = {
        'current_time': current_time,
        'original_start_time': original_start_time,
        'original_expiration': original_expiration,
        'original_service_price': 80.0,
        'new_service_price': 120.0
    }
    context = PurchaseContext(UpgradeStrategy())
    result = context.execute_calculation(upgrade_context)
    print(f"å‡çº§ç»“æœ: é‡‘é¢={result['amount']:.2f}, åˆ°æœŸæ—¶é—´={result['expiration']}")
    
    # ç»­è´¹ç¤ºä¾‹
    renewal_context = {
        'original_expiration': original_expiration,
        'service_price': 90.0,
        'renewal_years': 2  # ç»­è´¹ä¸¤å¹´
    }
    context = PurchaseContext(RenewalStrategy())
    result = context.execute_calculation(renewal_context)
    print(f"ç»­è´¹ç»“æœ: é‡‘é¢={result['amount']}, åˆ°æœŸæ—¶é—´={result['expiration']}")
```

### ç­–ç•¥è¯´æ˜

1. **æ–°è´­ç­–ç•¥**ï¼š
   - æ”¯ä»˜é‡‘é¢ï¼šç›´æ¥ä½¿ç”¨æœåŠ¡ä»·æ ¼
   - æœ‰æ•ˆæœŸï¼šä»å½“å‰æ—¶é—´å¼€å§‹è®¡ç®—ä¸€å¹´

2. **å‡çº§ç­–ç•¥**ï¼š
   - æ”¯ä»˜é‡‘é¢ï¼šè®¡ç®—æ–°æ—§æœåŠ¡å·®ä»· Ã— å‰©ä½™æ—¶é—´æ¯”ä¾‹
   - æœ‰æ•ˆæœŸï¼šåŸå§‹å‰©ä½™æ—¶é—´ + æ–°æœåŠ¡æ—¶é•¿ï¼ˆä¸€å¹´ï¼‰

3. **ç»­è´¹ç­–ç•¥**ï¼š
   - æ”¯ä»˜é‡‘é¢ï¼šæœåŠ¡ä»·æ ¼ Ã— ç»­è´¹å¹´é™
   - æœ‰æ•ˆæœŸï¼šåœ¨åŸå§‹åˆ°æœŸæ—¶é—´ä¸Šå¢åŠ ç»­è´¹å¹´é™

### ç­–ç•¥æ¨¡å¼é€‰æ‹©ç†ç”±

- **æ‰©å±•æ€§**ï¼šæ–°å¢è´­ä¹°ç±»å‹åªéœ€æ·»åŠ æ–°ç­–ç•¥ç±»
- **è§£è€¦**ï¼šå°†ä¸šåŠ¡é€»è¾‘ä¸å®¢æˆ·ç«¯ä»£ç åˆ†ç¦»
- **å¤ç”¨æ€§**ï¼šå…±ç”¨è®¡ç®—æ¥å£ï¼Œä¾¿äºç»Ÿä¸€ç®¡ç†

æ­¤å®ç°ä¸¥æ ¼éµå¾ªéœ€æ±‚æè¿°ï¼Œå¯¹æ—¶é—´è®¡ç®—ä½¿ç”¨å¤©æ•°ä¸ºå•ä½ï¼ˆæŒ‰ 365 å¤©/å¹´ï¼‰ï¼Œå®é™…ç”Ÿäº§ç¯å¢ƒå¯æ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´æ—¶é—´è®¡ç®—ç²¾åº¦ã€‚
