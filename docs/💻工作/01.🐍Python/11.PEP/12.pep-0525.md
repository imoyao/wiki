---
title: '[è¯‘] PEP 525--å¼‚æ­¥ç”Ÿæˆå™¨'
categories: 
  - ğŸ’» å·¥ä½œ
  - ğŸPython
  - PEP
tags: 
  - ç”Ÿæˆå™¨
  - å¼‚æ­¥
date: 2016-07-18 23:34:31
permalink: /peps/8c6f63/
---

| PEP:             | 525                                                        |
|------------------|------------------------------------------------------------|
| Title:           | Asynchronous Generators                                    |
| Author:          | Yury Selivanov <yury at edgedb\.com>                       |
| Discussions\-To: | <python\-dev at python\.org>                               |
| Status:          | Final                                                      |
| Type:            | Standards Track                                            |
| Created:         | 28\-Jul\-2016                                              |
| Python\-Version: | 3\.6                                                       |
| Post\-History:   | 02\-Aug\-2016, 23\-Aug\-2016, 01\-Sep\-2016, 06\-Sep\-2016 |


**è¯‘è€…** ï¼š[CXA](https://www.cnblogs.com/c-x-a)ï¼ˆ**python å­¦ä¹ å¼€å‘** å…¬ä¼—å·ä½œè€…ï¼‰

------

### ç®€è¿°
PEP492 å¼•å…¥äº†å¯¹ Python 3.5 çš„åŸç”Ÿåç¨‹å’Œ async/await å¥æ³•çš„æ”¯æŒã€‚æœ¬æ¬¡ææ¡ˆæ·»åŠ äº†å¯¹å¼‚æ­¥ç”Ÿæˆå™¨çš„æ”¯æŒè¿›è€Œæ¥æ‰©å±• Python çš„å¼‚æ­¥åŠŸèƒ½ã€‚
### ç†è®ºå’Œç›®æ ‡
å¸¸è§„ç”Ÿæˆå™¨ï¼ˆåœ¨ PEP 255 ä¸­å¼•å…¥ï¼‰çš„å®ç°ï¼Œä½¿å¾—ç¼–å†™å¤æ‚æ•°æ®å˜å¾—æ›´ä¼˜é›…ï¼Œå®ƒä»¬çš„è¡Œä¸ºç±»ä¼¼äºè¿­ä»£å™¨ã€‚
å½“æ—¶æ²¡æœ‰æä¾› async for ä½¿ç”¨çš„å¼‚æ­¥ç”Ÿæˆå™¨ã€‚ ç¼–å†™å¼‚æ­¥æ•°æ®ç”Ÿæˆå™¨å˜å¾—éå¸¸å¤æ‚ï¼Œå› ä¸ºå¿…é¡»å®šä¹‰ä¸€ä¸ªå®ç°\__aiter__å’Œ\__anext__çš„æ–¹æ³•ï¼Œæ‰èƒ½åœ¨ async for è¯­å¥ä¸­ä½¿ç”¨å®ƒã€‚
ä¸ºäº†è¯´æ˜å¼‚æ­¥ç”Ÿæˆå™¨çš„é‡è¦æ€§ï¼Œä¸“é—¨åšäº†æ€§èƒ½æµ‹è¯•,æµ‹è¯•ç»“æœè¡¨æ˜ä½¿ç”¨å¼‚æ­¥ç”Ÿæˆå™¨è¦æ¯”ä½¿ç”¨å¼‚æ­¥è¿­ä»£å™¨å¿« 2 å€å¤šã€‚
ä¸‹é¢çš„ä»£ç æ˜¯æ¼”ç¤ºäº†åœ¨è¿­ä»£çš„è¿‡ç¨‹ä¸­ç­‰å¾…å‡ ç§’
```python
class Ticker:
    """Yield numbers from 0 to `to` every `delay` seconds."""

    def __init__(self, delay, to):
        self.delay = delay
        self.i = 0
        self.to = to

    def __aiter__(self):
        return self

    async def __anext__(self):
        i = self.i
        if i >= self.to:
            raise StopAsyncIteration
        self.i += 1
        if i:
            await asyncio.sleep(self.delay)
        return i
```
 æˆ‘ä»¬é‚£å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç å®ç°åŒæ ·çš„åŠŸèƒ½ï¼š
```python
async def ticker(delay, to):
    """Yield numbers from 0 to `to` every `delay` seconds."""
    for i in range(to):
        yield i
        await asyncio.sleep(delay)
```
### è¯¦ç»†è¯´æ˜
#### å¼‚æ­¥ç”Ÿæˆå™¨
æˆ‘ä»¬ç›´åˆ°åœ¨å‡½æ•°ä¸­ä½¿ç”¨ä¸€ä¸ªæˆ–å¤šä¸ª yield è¯¥å‡½æ•°å°†å˜æˆä¸€ä¸ªç”Ÿæˆå™¨ã€‚
```python
def func():            # æ–¹æ³•
    return

def genfunc():         # ç”Ÿæˆå™¨æ–¹æ³•
    yield
```
æˆ‘ä»¬æè®®ä½¿ç”¨ç±»ä¼¼çš„åŠŸèƒ½å®ç°ä¸‹é¢å¼‚æ­¥ç”Ÿæˆå™¨ï¼š
```python
async def coro():      # ä¸€ä¸ªåç¨‹æ–¹æ³•
    await smth()

async def asyncgen():  # ä¸€ä¸ªå¼‚æ­¥ç”Ÿæˆå™¨æ–¹æ³•
    await smth()
    yield 42
```
è°ƒç”¨å¼‚æ­¥ç”Ÿæˆå™¨å‡½æ•°çš„ç»“æœæ˜¯å¼‚æ­¥ç”Ÿæˆå™¨å¯¹è±¡ï¼Œå®ƒå®ç°äº† PEP 492 ä¸­å®šä¹‰çš„å¼‚æ­¥è¿­ä»£åè®®ã€‚
æ³¨æ„ï¼šåœ¨å¼‚æ­¥ç”Ÿæˆå™¨ä¸­ä½¿ç”¨éç©º return è¯­å¥ä¼šå¼•å‘ SyntaxError é”™è¯¯ã€‚
#### å¯¹å¼‚æ­¥è¿­ä»£åè®®çš„æ”¯æŒ
è¯¥åè®®éœ€è¦å®ç°ä¸¤ç§ç‰¹æ®Šæ–¹æ³•ï¼š
\__aiter__æ–¹æ³•è¿”å›ä¸€ä¸ªå¼‚æ­¥è¿­ä»£å™¨ã€‚
\__anext__æ–¹æ³•è¿”å›ä¸€ä¸ª awaitable å¯¹è±¡ï¼Œå®ƒä½¿ç”¨ StopIteration å¼‚å¸¸æ¥æ•è· yield çš„å€¼ï¼Œä½¿ç”¨ StopAsyncIteration å¼‚å¸¸æ¥è¡¨ç¤ºè¿­ä»£ç»“æŸã€‚
å¼‚æ­¥ç”Ÿæˆå™¨å®šä¹‰äº†è¿™ä¸¤ç§æ–¹æ³•ã€‚ è®©æˆ‘ä»¬å®ç°ä¸€ä¸ªä¸€ä¸ªç®€å•çš„å¼‚æ­¥ç”Ÿæˆå™¨ï¼š
```python
import asyncio
async def genfunc():
    yield 1
    yield 2

gen = genfunc()

async def start():
    assert gen.__aiter__() is gen
    assert await gen.__anext__() == 1
    assert await gen.__anext__() == 2
    await gen.__anext__()  # This line will raise StopAsyncIteration.

if __name__ == '__main__':
    asyncio.run(start())
```
#### ç»ˆæ­¢
PEP 492 æåˆ°éœ€è¦ä½¿ç”¨äº‹ä»¶å¾ªç¯æˆ–è°ƒåº¦ç¨‹åºæ¥è¿è¡Œåç¨‹ã€‚ å› ä¸ºå¼‚æ­¥ç”Ÿæˆå™¨æ˜¯åœ¨åç¨‹ä½¿ç”¨çš„ï¼Œæ‰€ä»¥è¿˜éœ€è¦åˆ›å»ºä¸€ä¸ªäº‹ä»¶å¾ªç¯æ¥è¿è¡Œã€‚
å¼‚æ­¥ç”Ÿæˆå™¨å¯ä»¥æœ‰ try..finally å—ï¼Œä¹Ÿå¯ä»¥ç”¨ async with å¼‚æ­¥ä¸Šä¸‹æ–‡ç®¡ç†ä»£ç å¿«ã€‚ é‡è¦çš„æ˜¯æä¾›ä¸€ç§ä¿è¯ï¼Œå³ä½¿åœ¨éƒ¨åˆ†è¿­ä»£æ—¶ï¼Œä¹Ÿå¯ä»¥è¿›è¡Œåƒåœ¾æ”¶é›†ï¼Œç”Ÿæˆå™¨å¯ä»¥å®‰å…¨ç»ˆæ­¢ã€‚ 
```plain
async def square_series(con, to):
    async with con.transaction():
        cursor = con.cursor(
            'SELECT generate_series(0, $1) AS i', to)
        async for row in cursor:
            yield row['i'] ** 2

async for i in square_series(con, 1000):
    if i == 100:
        break
```
ä¸Šé¢ä»£ç æ¼”ç¤ºäº†å¼‚æ­¥ç”Ÿæˆå™¨åœ¨ async with ä¸­ä½¿ç”¨ï¼Œç„¶åä½¿ç”¨ async for å¯¹å¼‚æ­¥ç”Ÿæˆå™¨å¯¹è±¡è¿›è¡Œè¿­ä»£å¤„ç†ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥è®¾ç½®ä¸€ä¸ªä¸­æ–­æ¡ä»¶ã€‚
square_series()ç”Ÿæˆå™¨å°†è¢«åƒåœ¾æ”¶é›†ï¼Œå¹¶æ²¡æœ‰å¼‚æ­¥å…³é—­ç”Ÿæˆå™¨çš„æœºåˆ¶ï¼ŒPython è§£é‡Šå™¨å°†æ— æ³•æ‰§è¡Œä»»ä½•æ“ä½œã€‚
ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¿™é‡Œæå‡ºä»¥ä¸‹æ”¹è¿›å»ºè®®ï¼š
1.åœ¨å¼‚æ­¥ç”Ÿæˆå™¨ä¸Šå®ç°ä¸€ä¸ª aclose æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªç‰¹æ®Š awaittable å¯¹è±¡ã€‚ å½“ awaitable æŠ›å‡º GeneratorExit å¼‚å¸¸çš„æ—¶å€™,æŠ›å‡ºåˆ°æŒ‚èµ·çš„ç”Ÿæˆå™¨ä¸­å¹¶å¯¹å…¶è¿›è¡Œè¿­ä»£ï¼Œç›´åˆ°å‘ç”Ÿ GeneratorExit æˆ– StopAsyncIterationã€‚è¿™å°±æ˜¯åœ¨å¸¸è§„å‡½æ•°ä¸­ä½¿ç”¨ close æ–¹æ³•å…³é—­å¯¹è±¡ä¸€æ ·ï¼Œåªä¸è¿‡ aclose éœ€è¦ä¸€ä¸ªäº‹ä»¶å¾ªç¯å»æ‰§è¡Œã€‚
2.ä¸è¦åœ¨å¼‚æ­¥ç”Ÿæˆå™¨ä¸­ä½¿ç”¨ yield è¯­å¥ï¼Œåªèƒ½ç”¨ awaitã€‚
3.åœ¨ sys æ¨¡å—ä¸­åŠ ä¸¤ä¸ªæ–¹æ³•ï¼šset_asyncgen_hooks() and get_asyncgen_hooks().
sys.set_asyncgen_hooks()èƒŒåçš„æ€æƒ³æ˜¯å…è®¸äº‹ä»¶å¾ªç¯æ‹¦æˆªå¼‚æ­¥ç”Ÿæˆå™¨çš„è¿­ä»£å’Œç»ˆç»“ï¼Œè¿™æ ·æœ€ç»ˆç”¨æˆ·å°±ä¸éœ€è¦å…³å¿ƒç»ˆç»“é—®é¢˜äº†ï¼Œä¸€åˆ‡æ­£å¸¸ã€‚
sys.set_asyncgen_hooks() å¯ä»¥ç»“æŸä¸¤ä¸ªå‚æ•°
firstiterï¼šä¸€ä¸ªå¯è°ƒç”¨çš„ï¼Œå½“ç¬¬ä¸€æ¬¡è¿­ä»£å¼‚æ­¥ç”Ÿæˆå™¨æ—¶å°†è°ƒç”¨å®ƒã€‚
finalizerï¼šä¸€ä¸ªå¯è°ƒç”¨çš„ï¼Œå½“å¼‚æ­¥ç”Ÿæˆå™¨å³å°†è¢« GC æ—¶å°†è¢«è°ƒç”¨ã€‚
å½“ç¬¬ä¸€è¿­ä»£å¼‚æ­¥ç”Ÿæˆå™¨æ—¶ï¼Œå®ƒä¼šå¼•ç”¨åˆ°å½“å‰çš„ finalizerã€‚
å½“å¼‚æ­¥ç”Ÿæˆå™¨å³å°†è¢«åƒåœ¾æ”¶é›†æ—¶,å®ƒä¼šè°ƒç”¨å…¶ç¼“å­˜çš„ finalizerã€‚å‡æƒ³åœ¨äº‹ä»¶å¾ªç¯æ¿€æ´»å¼‚æ­¥ç”Ÿæˆå™¨å¼€å§‹è¿­ä»£çš„æ—¶å€™,finalizer å°†è°ƒç”¨ä¸€ä¸ª aclose()æ–¹æ³•.
ä¾‹å¦‚ï¼Œä»¥ä¸‹æ˜¯å¦‚ä½•ä¿®æ”¹ asyncio ä»¥å…è®¸å®‰å…¨åœ°å®Œæˆå¼‚æ­¥ç”Ÿæˆå™¨ï¼š
```plain
# asyncio/base_events.py

class BaseEventLoop:

    def run_forever(self):
        ...
        old_hooks = sys.get_asyncgen_hooks()
        sys.set_asyncgen_hooks(finalizer=self._finalize_asyncgen)
        try:
            ...
        finally:
            sys.set_asyncgen_hooks(*old_hooks)
            ...

    def _finalize_asyncgen(self, gen):
        self.create_task(gen.aclose())

```
ç¬¬äºŒä¸ªå‚æ•° firstiter,å…è®¸äº‹ä»¶å¾ªç¯ç»´æŠ¤åœ¨å…¶æ§åˆ¶ä¸‹å®ä¾‹åŒ–çš„å¼±å¼‚æ­¥ç”Ÿæˆå™¨é›†ã€‚è¿™ä½¿å¾—å¯ä»¥å®ç°â€œshutdownâ€æœºåˆ¶,æ¥å®‰å…¨åœ°æ‰“å¼€çš„ç”Ÿæˆå™¨å¹¶å…³é—­äº‹ä»¶å¾ªç¯ã€‚
sys.set_asyncgen_hooks()æ˜¯ç‰¹å®šçº¿ç¨‹ï¼Œå› æ­¤åœ¨å¤šä¸ªäº‹ä»¶å¾ªç¯å¹¶è¡Œçš„æ—¶å€™æ˜¯å®‰å…¨çš„ã€‚
sys.get_asyncgen_hooks()è¿”å›ä¸€ä¸ªå¸¦æœ‰ firstiter å’Œ finalizer å­—æ®µçš„ç±»ä¼¼äºç±»çš„ç»“æ„ã€‚
### asyncio
asyncio äº‹ä»¶å¾ªç¯å°†ä½¿ç”¨ sys.set_asyncgen_hooks()API æ¥ç»´æŠ¤æ‰€æœ‰è¢«è°ƒåº¦çš„å¼±å¼‚æ­¥ç”Ÿæˆå™¨ï¼Œå¹¶åœ¨ç”Ÿæˆå™¨è¢«åƒåœ¾å›æ”¶æ—¶ä¾¯è°ƒåº¦å®ƒä»¬çš„ aclose()æ–¹æ³•ã€‚
ä¸ºäº†ç¡®ä¿ asyncio ç¨‹åºå¯ä»¥å¯é åœ°å®Œæˆæ‰€æœ‰è¢«è°ƒåº¦çš„å¼‚æ­¥ç”Ÿæˆå™¨ï¼Œæˆ‘ä»¬å»ºè®®æ·»åŠ ä¸€ä¸ªæ–°çš„äº‹ä»¶å¾ªç¯åç¨‹æ–¹æ³• loop.shutdown_asyncgens()ã€‚ è¯¥æ–¹æ³•å°†ä½¿ç”¨ aclose()è°ƒç”¨å…³é—­æ‰€æœ‰å½“å‰æ‰“å¼€çš„å¼‚æ­¥ç”Ÿæˆå™¨ã€‚
åœ¨è°ƒç”¨ loop.shutdown_asyncgens()æ–¹æ³•ä¹‹åï¼Œé¦–æ¬¡è¿­ä»£æ–°çš„å¼‚æ­¥ç”Ÿæˆå™¨ï¼Œäº‹ä»¶å¾ªç¯å°±ä¼šå‘å‡ºè­¦å‘Šã€‚ æˆ‘ä»¬çš„æƒ³æ³•æ˜¯ï¼Œåœ¨è¯·æ±‚å…³é—­æ‰€æœ‰å¼‚æ­¥ç”Ÿæˆå™¨ä¹‹åï¼Œç¨‹åºä¸åº”è¯¥æ‰§è¡Œè¿­ä»£æ–°å¼‚æ­¥ç”Ÿæˆå™¨çš„ä»£ç ã€‚
ä¸‹é¢æ˜¯ä¸€ä¸ªå…³äºå¦‚ä½•ä½¿ç”¨ Ashutdown_asyncgens çš„ä¾‹å­:
```plain
try:
    loop.run_forever()
finally:
    loop.run_until_complete(loop.shutdown_asyncgens())#å…³é—­æ‰€æœ‰å¼‚æ­¥è¿­ä»£å™¨
    loop.close()
```
### å¼‚æ­¥ç”Ÿæˆå™¨å¯¹è±¡
è¯¥å¯¹è±¡ä»¥æ ‡å‡† Python ç”Ÿæˆå™¨å¯¹è±¡ä¸ºæ¨¡å‹ã€‚ æœ¬è´¨ä¸Šå¼‚æ­¥ç”Ÿæˆå™¨çš„è¡Œä¸ºå¤åˆ¶äº†åŒæ­¥ç”Ÿæˆå™¨çš„è¡Œä¸ºï¼Œå”¯ä¸€çš„åŒºåˆ«åœ¨äº API æ˜¯å¼‚æ­¥çš„ã€‚
å®šä¹‰äº†ä»¥ä¸‹æ–¹æ³•å’Œå±æ€§ï¼š
1.agen.\__aiter__(): è¿”å› agen.
2.agen.\__anext__(): è¿”å›ä¸€ä¸ª awaitable å¯¹è±¡, è°ƒç”¨ä¸€æ¬¡å¼‚æ­¥ç”Ÿæˆå™¨çš„å…ƒç´ ã€‚
3.agen.asend(val): è¿”å›ä¸€ä¸ª awaitable å¯¹è±¡ï¼Œå®ƒåœ¨ agen ç”Ÿæˆå™¨ä¸­æ¨é€ val å¯¹è±¡ã€‚ å½“ agen è¿˜æ²¡è¿­ä»£æ—¶ï¼Œval å¿…é¡»ä¸º Noneã€‚
ä¸Šé¢çš„æ–¹æ³•ç±»ä¼¼åŒæ­¥ç”Ÿæˆå™¨çš„ä½¿ç”¨ã€‚
ä»£ç ä¾‹å­:
```plain
import asyncio


async def gen():
    await asyncio.sleep(0.1)
    v = yield 42
    print(v)
    await asyncio.sleep(0.2)



async def start():
    g = gen()

    await g.asend(None)  # Will return 42 after sleeping
    # for 0.1 seconds.

    await g.asend('hello')  # Will print 'hello' and
    # raise StopAsyncIteration
    # (after sleeping for 0.2 seconds.)


if __name__ == '__main__':
    loop = asyncio.get_event_loop()
    try:
        loop.run_until_complete(start())
    finally:
        loop.run_until_complete(loop.shutdown_asyncgens())
        loop.close()

```
4.agen.athrow(typ, [val, [tb]]): è¿”å›ä¸€ä¸ª awaitable å¯¹è±¡, è¿™ä¼šå‘ agen ç”Ÿæˆå™¨æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚
ä»£ç å¦‚ä¸‹:
```plain
import asyncio


async def gen():
    try:
        await asyncio.sleep(0.1)
        yield 'hello'
    except IndexError:
        await asyncio.sleep(0.2)
        yield 'world'


async def start():
    g = gen()
    v = await g.asend(None)
    print(v)  # Will print 'hello' after
    # sleeping for 0.1 seconds.

    v = await g.athrow(IndexError)
    print(v)  # Will print 'world' after
    # $ sleeping 0.2 seconds.


if __name__ == '__main__':
    loop = asyncio.get_event_loop()
    try:
        loop.run_until_complete(start())
    finally:
        loop.run_until_complete(loop.shutdown_asyncgens())
        loop.close()
```
5.agen.aclose(): è¿”å›ä¸€ä¸ª awaitable å¯¹è±¡, è°ƒç”¨è¯¥æ–¹æ³•ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ç»™ç”Ÿæˆå™¨ã€‚
```python
import asyncio


async def gen():
    try:
        await asyncio.sleep(0.1)
        v = yield 42
        print(v)
        await asyncio.sleep(0.2)
    except:
         print("è¿è¡Œç»“æŸ") 


async def start():
    g = gen()
    v=await g.asend(None)
    print(v)
    await g.aclose() #ä¸åšå¼‚å¸¸å¤„ç†ä¼šæŠ¥é”™


if __name__ == '__main__':
    loop = asyncio.get_event_loop()
    try:
        loop.run_until_complete(start())
    finally:
        loop.run_until_complete(loop.shutdown_asyncgens())
        loop.close()
```
6.`agen.__name__` å’Œ `agen.__qualname__`:å¯ä»¥è¿”å›å¼‚æ­¥ç”Ÿæˆå™¨å‡½æ•°çš„åå­—ã€‚
```python
async def gen():
    try:
        await asyncio.sleep(0.1)
        v = yield 42
        print(v)
        await asyncio.sleep(0.2)
    except:
         print("è¿è¡Œç»“æŸ")

async def start():
    g = gen()
    print(g.__aiter__())#è¾“å‡ºasync_generatorå¯¹è±¡
    print(g.__name__)#è¾“å‡ºgen
    print(g.__qualname__)#è¾“å‡ºgen
```
7. `agen.ag_await`ï¼š`agen` å½“å‰æ­£åœ¨ç­‰å¾…çš„å¯¹è±¡ï¼Œæˆ–`None`ã€‚ è¿™ç±»ä¼¼äºå½“å‰å¯ç”¨äºç”Ÿæˆå™¨çš„`gi_yieldfrom`å’Œå¯ç”¨äºåç¨‹çš„`cr_await`ã€‚

8. `agen.ag_frame`ï¼Œ`agen.ag_running`å’Œ`agen.ag_code`ï¼šä»¥ä¸æ ‡å‡†ç”Ÿæˆå™¨çš„ç›¸ä¼¼å±æ€§ç›¸åŒçš„æ–¹å¼å®šä¹‰ã€‚

`StopIteration` å’Œ `StopAsyncIteration` è¢«æ›¿æ¢ä¸º `RuntimeError`ï¼Œå¹¶ä¸”ä¸ä¸ŠæŠ›ã€‚
### æºç å®ç°ç»†èŠ‚
å¼‚æ­¥ç”Ÿæˆå™¨å¯¹è±¡ï¼ˆPyAsyncGenObjectï¼‰ä¸ PyGenObject å…±äº«ç»“æ„å¸ƒå±€ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œå‚è€ƒå®ç°è¿˜å¼•å…¥äº†ä¸‰ä¸ªæ–°å¯¹è±¡ï¼š
PyAsyncGenASendï¼šå®ç°\__anext__å’Œ asend()æ–¹æ³•çš„ç­‰å¾…å¯¹è±¡ã€‚
PyAsyncGenAThrowï¼šå®ç° athrow()å’Œ aclose()æ–¹æ³•çš„ç­‰å¾…å¯¹è±¡ã€‚
_PyAsyncGenWrappedValueï¼šæ¥è‡ªå¼‚æ­¥ç”Ÿæˆå™¨çš„æ¯ä¸ªç›´æ¥ç”Ÿæˆçš„å¯¹è±¡éƒ½éšå¼åœ°è£…å…¥æ­¤ç»“æ„ä¸­ã€‚ è¿™å°±æ˜¯ç”Ÿæˆå™¨å®ç°å¦‚ä½•ä½¿ç”¨å¸¸è§„è¿­ä»£åè®®ä»ä½¿ç”¨å¼‚æ­¥è¿­ä»£åè®®ç”Ÿæˆçš„å¯¹è±¡ä¸­åˆ†ç¦»å‡ºçš„å¯¹è±¡ã€‚
PyAsyncGenASend å’Œ PyAsyncGenAThrow æ˜¯ awaitable å¯¹è±¡ï¼ˆå®ƒä»¬æœ‰\__await__æ–¹æ³•è¿”å› selfï¼‰ç±»ä¼¼äº coroutine çš„å¯¹è±¡ï¼ˆå®ç°\__iter__,\__ next__ï¼Œsend()å’Œ throw()æ–¹æ³•ï¼‰ã€‚ æœ¬è´¨ä¸Šï¼Œå®ƒä»¬æ§åˆ¶å¼‚æ­¥ç”Ÿæˆå™¨çš„è¿­ä»£æ–¹å¼
### PyAsyncGenASend å’Œ PyAsyncGenAThrow
PyAsyncGenASend ç±»ä¼¼ç”Ÿæˆå™¨å¯¹è±¡é©±åŠ¨ `__anext__` å’Œ `asend()` æ–¹æ³•,å®è£…äº†å¼‚æ­¥è¿­ä»£åè®®ã€‚
`agen.asend(val)` å’Œ `agen.__anext__()` è¿”å›ä¸€ä¸ª PyAsyncGenASend å¯¹è±¡çš„ä¸€ä¸ªå¼•ç”¨ã€‚ (å®ƒå°†å¼•ç”¨ä¿å­˜å›çˆ¶ç±» agen å¯¹è±¡ã€‚)
æ•°æ®æµå®šä¹‰å¦‚ä¸‹ï¼š
1.é¦–æ¬¡è°ƒç”¨ PyAsyncGenASend.send(val)æ—¶, val å°†æ¨å…¥åˆ°çˆ¶ç±» agen å¯¹è±¡ (PyGenObject åˆ©ç”¨ç°æœ‰å¯¹è±¡ã€‚)
å¯¹ PyAsyncGenASend å¯¹è±¡è¿›è¡Œåç»­è¿­ä»£ï¼Œå°† None æ¨é€åˆ° agenã€‚
2.é¦–æ¬¡è°ƒç”¨\_PyAsyncGenWrappedValue å¯¹è±¡æ—¶ï¼Œå®ƒå°†è¢«æ‹†ç®±ï¼Œå¹¶ä¸”ä»¥æœªè¢«è£…é¥°çš„å€¼ä½œä¸ºå‚æ•°ä¼šå¼•å‘ StopIteration å¼‚å¸¸ã€‚
3.å¼‚æ­¥ç”Ÿæˆå™¨ä¸­çš„ return è¯­å¥å¼•å‘ StopAsyncIteration å¼‚å¸¸ï¼Œè¯¥å¼‚å¸¸é€šè¿‡ PyAsyncGenASend.send()å’Œ PyAsyncGenASend.throw()æ–¹æ³•ä¼ æ’­ã€‚
4.PyAsyncGenAThrow ä¸ PyAsyncGenASend éå¸¸ç›¸ä¼¼ã€‚ å”¯ä¸€çš„åŒºåˆ«æ˜¯ PyAsyncGenAThrow.send()åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ä¼šå‘çˆ¶ç±» agen å¯¹è±¡æŠ›å‡ºå¼‚å¸¸ï¼ˆè€Œä¸æ˜¯å°†å€¼æ¨å…¥å…¶ä¸­ã€‚ï¼‰
### æ–°çš„æ ‡å‡†åº“æ–¹æ³•å’Œ Types
1.types.AsyncGeneratorType -- åˆ¤æ–­æ˜¯å¦æ˜¯å¼‚æ­¥ç”Ÿæˆå™¨å¯¹è±¡
2.sys.set_asyncgen_hooks()å’Œ sys.get_asyncgen_hooks()--
åœ¨äº‹ä»¶å¾ªç¯ä¸­è®¾ç½®å¼‚æ­¥ç”Ÿæˆå™¨ç»ˆç»“å™¨å’Œè¿­ä»£æ‹¦æˆªå™¨ã€‚
3.inspect.isasyncgen()å’Œ inspect.isasyncgenfunction() :æ–¹æ³•å†…çœã€‚
4.asyncio åŠ å…¥æ–°æ–¹æ³•:loop.shutdown_asyncgens().
5.collections.abc.AsyncGenerator:æŠ½è±¡åŸºç±»çš„æ·»åŠ ã€‚
### æ˜¯å¦æ”¯æŒå‘åå…¼å®¹
è¯¥ææ¡ˆå®Œå…¨æ”¯æŒå‘åå…¼å®¹
åœ¨ python3.5ï¼Œasync def é‡Œä½¿ç”¨ yield ä¼šæŠ¥é”™,å› æ­¤åœ¨ python3.6 å¼•å…¥äº†å®‰å…¨çš„å¼‚æ­¥ç”Ÿæˆå™¨
### æ€§èƒ½å±•ç¤º
#### å¸¸è§„ç”Ÿæˆå™¨
```plain
def gen():
    i = 0
    while i < 100000000:
        yield i
        i += 1

if __name__ == '__main__':
    list(gen())
```
#### å¼‚æ­¥è¿­ä»£å™¨çš„æ”¹è¿›
##### å¼‚æ­¥è¿­ä»£å™¨
å¼‚æ­¥è¿­ä»£å™¨éœ€æ±‚é€šè¿‡\__aiter__å’Œ\__anext__æ–¹æ³•è‡ªå·±å®ç°ã€‚
```plain
import time
import asyncio

N = 10 ** 7
class AIter:
    def __init__(self):
        self.i = 0

    def __aiter__(self):
        return self

    async def __anext__(self):
        i = self.i
        if i >= N:
            raise StopAsyncIteration
        self.i += 1
        return i

async def start():
    [_ async for _ in AIter()]
    
if __name__ == '__main__':
    s=time.time()
    loop=asyncio.get_event_loop()
    try:
     loop.run_until_complete(start())
    finally:
        loop.run_until_complete(loop.shutdown_asyncgens())
        loop.close()
    e=time.time()
    print("total time",e-s)
```
è¾“å‡º
```plain
total time 5.441649913787842
```
##### å¼‚æ­¥ç”Ÿæˆå™¨
```plain
import time
import asyncio
N = 10 ** 7

async def agen():
    for i in range(N):
        yield i


async def start():
    [_ async for _ in agen()]
    
if __name__ == '__main__':
    s=time.time()
    loop=asyncio.get_event_loop()
    try:
     loop.run_until_complete(start())
    finally:
        loop.run_until_complete(loop.shutdown_asyncgens())
        loop.close()
    e=time.time()
    print("total time",e-s)

```
è¾“å‡º
```plain
total time 2.1055827140808105
```
åŸºå‡†æµ‹è¯•è¡¨æ˜å¼‚æ­¥ç”Ÿæˆå™¨çš„é€Ÿåº¦æ¯”å¼‚æ­¥è¿­ä»£å™¨å¿«äº†ä¸¤å€å¤šã€‚

### è®¾è®¡ä¸­è¦æ³¨æ„çš„äº‹é¡¹
å†…å»ºå‡½æ•°:aiter() and anext() 
æœ€åˆï¼ŒPEP 492 å°†\__aiter__å®šä¹‰ä¸ºåº”è¿”å›ç­‰å¾…å¯¹è±¡çš„æ–¹æ³•ï¼Œä»è€Œäº§ç”Ÿå¼‚æ­¥è¿­ä»£å™¨ã€‚
ä½†æ˜¯ï¼Œåœ¨ CPython 3.5.2 ä¸­ï¼Œé‡æ–°å®šä¹‰äº†\__aiter__å¯ä»¥ç›´æ¥è¿”å›å¼‚æ­¥è¿­ä»£å™¨ã€‚
ä¸ºäº†é¿å…ç ´åå‘åå…¼å®¹æ€§ï¼Œå†³å®š Python 3.6 å°†æ”¯æŒä¸¤ç§æ–¹å¼ï¼š\__aiter__ä»ç„¶å¯ä»¥åœ¨å‘å‡º DeprecationWarning æ—¶è¿”å›ç­‰å¾…çŠ¶æ€ã€‚ç”±äº Python 3.6 ä¸­\__aiter__çš„è¿™ç§åŒé‡æ€§è´¨ï¼Œæˆ‘ä»¬æ— æ³•æ·»åŠ å†…ç½®çš„ aiter()çš„åŒæ­¥å®ç°ã€‚ å› æ­¤ï¼Œå»ºè®®ç­‰åˆ° Python 3.7ã€‚
#### å¼‚æ­¥ list/dict/set æ¨å¯¼å¼
å°†æ”¾åœ¨å•ç‹¬çš„ pep ä¸­ä¹Ÿå°±æ˜¯åæ¥çš„ pep530.
#### å¼‚æ­¥ yield from
å¯¹äºå¼‚æ­¥ç”Ÿæˆå™¨ï¼Œyield from ä¹Ÿä¸é‚£ä¹ˆé‡è¦ï¼Œå› ä¸ºä¸éœ€è¦æä¾›åœ¨åç¨‹ä¹‹ä¸Šå®ç°å¦ä¸€ä¸ªååŒç¨‹åºåè®®çš„æœºåˆ¶ã€‚ä¸ºäº†ç»„åˆå¼‚æ­¥ç”Ÿæˆå™¨ï¼Œå¯ä»¥ä½¿ç”¨ async for ç®€åŒ–è¿™ä¸ªè¿‡ç¨‹ï¼š
```plain
async def g1():
    yield 1
    yield 2

async def g2():
    async for v in g1():
        yield v
```
#### ä¸ºäº† asend()å’Œ athrow()æ˜¯å¿…é¡»çš„
å®ƒä»¬å¯ä»¥ä½¿ç”¨å¼‚æ­¥ç”Ÿæˆå™¨å®ç°ç±»ä¼¼äº contextlib.contextmanager çš„æ¦‚å¿µã€‚ ä¾‹å¦‚ï¼Œå¯ä»¥å®ç°ä»¥ä¸‹æ¨¡å¼ï¼š
```plain
@async_context_manager
async def ctx():
    await open()
    try:
        yield
    finally:
        await close()

async with ctx():
    await ...
```
å¦ä¸€ä¸ªåŸå› æ˜¯ä»\__anext__å¯¹è±¡è¿”å›çš„å¯¹è±¡æ¥æ¨é€æ•°æ®å¹¶å°†å¼‚å¸¸æŠ›å‡ºåˆ°å¼‚æ­¥ç”Ÿæˆå™¨ä¸­ï¼Œå¾ˆéš¾æ­£ç¡®åœ°æ‰§è¡Œæ­¤æ“ä½œã€‚ æ·»åŠ æ˜¾å¼çš„ asend()å’Œ athrow()æ›´è·å–å¼‚å¸¸åçš„æ•°æ®ã€‚
åœ¨å®ç°æ–¹é¢ï¼Œasend()æ˜¯\__anext__æ›´é€šç”¨çš„ç‰ˆæœ¬ï¼Œè€Œ athrow()ä¸ aclose()éå¸¸ç›¸ä¼¼ã€‚ å› æ­¤ï¼Œä¸ºå¼‚æ­¥ç”Ÿæˆå™¨å®šä¹‰è¿™äº›æ–¹æ³•ä¸ä¼šå¢åŠ ä»»ä½•é¢å¤–çš„å¤æ‚æ€§ã€‚
### ä»£ç ç¤ºä¾‹
```plain
async def ticker(delay, to):
    for i in range(to):
        yield i
        await asyncio.sleep(delay)


async def run():
    async for i in ticker(1, 10):
        print(i)


import asyncio
loop = asyncio.get_event_loop()
try:
    loop.run_until_complete(run())
finally:
    loop.close()
```
è¿™ä»£ç å°†æ‰“å‡º 0-9,æ¯ä¸ªæ•°å­—ä¹‹é—´çš„é—´éš”ä¸º 1sã€‚
### æè®®è€…
Guido, 2016 å¹´ 9 æœˆ 6 æ—¥
### å‚è€ƒèµ„æ–™
[1]	https://github.com/1st1/cpython/tree/async_gen
[2]	https://mail.python.org/pipermail/python-dev/2016-September/146267.html
[3]	http://bugs.python.org/issue28003
### ç‰ˆæƒå£°æ˜
æœ¬æ–‡ç« ç¿»è¯‘æ•´ç†è‡ªï¼Œpep525
Source: https://github.com/python/peps/blob/master/pep-0525.txt
ç¿»è¯‘èƒ½åŠ›æœ‰é™è¿˜è¯·å¤§å®¶å¤šå¤šæŒ‡æ•™ã€‚
