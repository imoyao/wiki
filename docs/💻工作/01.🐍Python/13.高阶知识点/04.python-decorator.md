---
title: Python è£…é¥°å™¨âœ¨

tags: 
  - è£…é¥°å™¨
categories: 
  - ğŸ’» å·¥ä½œ
  - ğŸPython
  - é«˜é˜¶çŸ¥è¯†ç‚¹
date: 2020-08-29 12:27:56
permalink: /advance/decorator/
---
## ä»‹ç»

Python 2.2 å¼€å§‹æä¾›äº†è£…é¥°å™¨ï¼ˆdecoratorï¼‰ï¼Œè£…é¥°å™¨ä½œä¸ºä¿®æ”¹å‡½æ•°çš„ä¸€ç§ä¾¿æ·æ–¹å¼ï¼Œä¸ºç¨‹åºå‘˜ç¼–å†™ç¨‹åºæä¾›äº†ä¾¿åˆ©æ€§å’Œçµæ´»æ€§ï¼Œé€‚å½“ä½¿ç”¨è£…é¥°å™¨ï¼Œèƒ½å¤Ÿæœ‰æ•ˆçš„æé«˜ä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œç„¶è€Œï¼Œè£…é¥°å™¨å¹¶æ²¡æœ‰è¢«å¹¿æ³›çš„ä½¿ç”¨ï¼Œä¸»è¦è¿˜æ˜¯å› ä¸ºå¤§å¤šæ•°äººå¹¶ä¸ç†è§£è£…é¥°å™¨çš„å·¥ä½œæœºåˆ¶ã€‚

æœ¬æ–‡é¦–å…ˆä»‹ç»äº†è£…é¥°å™¨çš„æ¦‚å¿µå’Œç”¨æ³•ï¼ˆç¬¬ 2 èŠ‚ï¼‰ï¼Œç„¶åä»‹ç»äº†è£…é¥°å™¨ä½¿ç”¨è¿‡ç¨‹ä¸­çš„æ³¨æ„äº‹é¡¹ï¼ˆç¬¬ 3 èŠ‚ï¼‰ï¼Œä¹‹åè®¨è®ºäº†è£…é¥°å™¨çš„ä½¿ç”¨åœºæ™¯å’Œæ³¨æ„æ˜¯æƒ³ï¼ˆç¬¬ 4 èŠ‚ï¼‰ï¼Œæœ€åæä¾›äº†ä¸€äº›è£…é¥°å™¨çš„å­¦ä¹ ç´ æï¼ˆç¬¬ 5 èŠ‚ï¼‰ã€‚

## è£…é¥°å™¨

è£…é¥°å™¨æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¥æ”¶å…¶ä»–å‡½æ•°ä½œä¸ºå‚æ•°ä¼ é€’ï¼Œå¹¶å°†å…¶ä»¥ä¸€ä¸ªæ–°çš„ä¿®æ”¹åçš„å‡½æ•°è¿›è¡ŒåµŒå¥—ã€‚æ¦‚å¿µæ¯”è¾ƒæŠ½è±¡ï¼Œä¸€èµ·æ¥çœ‹ä¸¤ä¸ªè£…é¥°å™¨çš„ä¾‹å­ã€‚

### è£…é¥°å™¨çš„æ¦‚å¿µ

è€ƒè™‘è¿™æ ·ä¸€ç»„å‡½æ•°ï¼Œå®ƒä»¬åœ¨è¢«è°ƒç”¨æ—¶éœ€è¦å¯¹æŸäº›å‚æ•°è¿›è¡Œæ£€æŸ¥ï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼Œéœ€è¦å¯¹ç”¨æˆ·åè¿›è¡Œæ£€æŸ¥ï¼Œä»¥åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰ç›¸åº”çš„æƒé™è¿›è¡ŒæŸäº›æ“ä½œã€‚

```python
    class Store(object):
        def get_food(self, username, food):
            if username != 'admin':
                raise Exception("This user is not allowed to get food")
            return self.storage.get(food)

        def put_food(self, username, food):
            if username != 'admin':
                raise Exception("This user is not allowed to put food")
            self.storage.put(food)
```
æ˜¾ç„¶ï¼Œä»£ç æœ‰é‡å¤ï¼Œä½œä¸ºä¸€ä¸ªæœ‰è¿½æ±‚çš„å·¥ç¨‹å¸ˆï¼Œæˆ‘ä»¬ä¸¥æ ¼éµå®ˆ DRY(Donâ€™tÂ repeat yourself)åŸåˆ™ï¼Œäºæ˜¯ï¼Œä»£ç è¢«æ”¹å†™æˆäº†ç¨‹åºæ¸…å• 2 è¿™æ ·ï¼š

```python
    def check_is_admin(username):
        if username != 'admin':
            raise Exception("This user is not allowed to get food")

    class Store(object):
        def get_food(self, username, food):
            check_is_admin(username)
            return self.storage.get(food)

        def put_food(self, username, food):
            check_is_admin(username)
            return self.storage.put(food)

```
ç°åœ¨ä»£ç æ•´æ´ä¸€ç‚¹äº†ï¼Œä½†æ˜¯ï¼Œæœ‰è£…é¥°å™¨èƒ½å¤Ÿåšçš„æ›´å¥½ï¼š

```python
    def check_is_admin(f):
        def wrapper(*args, **kwargs):
            if kwargs.get('username') != 'admin':
                raise Exception("This user is not allowed to get food")
            return f(*arg, **kargs)
        return wrapper

    class Storage(object):
        @check_is_admin
        def get_food(self, username, food):
            return self.storage.get(food)

        @check_is_admin
        def put_food(self, username, food):
            return storage.put(food)
```
ä¸Šé¢è¿™æ®µä»£ç å°±æ˜¯ä½¿ç”¨è£…é¥°å™¨çš„å…¸å‹ä¾‹å­ï¼šå‡½æ•°é‡Œé¢å®šä¹‰äº†ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶å°†å®šä¹‰çš„è¿™ä¸ªå‡½æ•°ä½œä¸ºè¿”å›å€¼ã€‚è¿™ä¸ªä¾‹å­è¶³å¤Ÿç®€å•ï¼Œæ‰€ä»¥å®ƒçš„å¥½å¤„ä¹Ÿä¸å¤Ÿæ˜æ˜¾ï¼Œä½†æ˜¯ï¼Œå´å¯ä»¥å¾ˆå¥½çš„æ¼”ç¤ºè£…é¥°å™¨çš„è¯­æ³•ã€‚

å³ä½¿è¿™æ ·ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è¯´ï¼Œç¨‹åºæ¸…å• 3 æ¯”ç¨‹åºæ¸…å• 2 æ›´å¥½ï¼Œå› ä¸ºç¨‹åºæ¸…å• 3 èƒ½å¤Ÿå°†æ¡ä»¶æ£€æŸ¥ä¸å…·ä½“é€»è¾‘åˆ†éš”å¼€æ¥ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œ`check_is_admin`åªæ˜¯é¢„æ£€æŸ¥ï¼Œå®ƒçš„é‡è¦æ€§ä¸å¦‚å…·ä½“çš„ä¸šåŠ¡é€»è¾‘ã€‚æˆ‘ä»¬å°†ä¸šåŠ¡é€»è¾‘çœ‹åšæ˜¯è¿™æ®µç¨‹åºçš„â€é‡ç‚¹â€çš„è¯ï¼Œé‚£ä¹ˆï¼Œç¨‹åºæ¸…å• 3 ä¸€çœ¼çœ‹è¿‡å»å°±èƒ½çœ‹åˆ°â€é‡ç‚¹â€ï¼Œè€Œç¨‹åºæ¸…å• 2 åˆ™ä¸èƒ½ï¼Œéœ€è¦ç®€å•çš„æ€è€ƒï¼ˆè½¬ä¸ªå¼¯ï¼‰æ‰èƒ½åŒºåˆ†æ¡ä»¶æ£€æŸ¥å’Œä¸šåŠ¡é€»è¾‘ã€‚å½“ç„¶ï¼Œä½ å¯èƒ½è§‰å¾—è¿™æ²¡ä»€ä¹ˆï¼Œä½†æ˜¯ï¼Œä½œä¸ºä¸€åæœ‰è¿½æ±‚çš„å·¥ç¨‹å¸ˆï¼Œæˆ‘ä»¬å¸Œæœ›æˆ‘ä»¬å†™å‡ºçš„ä»£ç èƒ½å’Œæ•£æ–‡ä¸€æ ·ä¼˜ç¾ã€‚

### è£…é¥°å™¨çš„æœ¬è´¨

å‰é¢è¯´è¿‡ï¼Œ**è£…é¥°å™¨æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¥æ”¶å…¶ä»–å‡½æ•°ä½œä¸ºå‚æ•°ï¼Œå¹¶å°†å…¶ä»¥ä¸€ä¸ªæ–°çš„ä¿®æ”¹åçš„å‡½æ•°è¿›è¡Œæ›¿æ¢**ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­èƒ½å¤Ÿæ›´å¥½åœ°ç†è§£è¿™å¥è¯ã€‚

```python
    def bread(func):
        def wrapper():
            print "</''''''\>"
            func()
            print "</______\>"
        return wrapper

    sandwich_copy = bread(sandwich)
    sandwich_copy()
```
è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š
```plain
    </''''''\>
    --ham--
    </______\>
```
**åˆ†æå¦‚ä¸‹ï¼š** bread æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒæ¥å—ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œç„¶åè¿”å›ä¸€ä¸ªæ–°çš„å‡½æ•°ï¼Œæ–°çš„å‡½æ•°å¯¹åŸæ¥çš„å‡½æ•°è¿›è¡Œäº†ä¸€äº›ä¿®æ”¹å’Œæ‰©å±•ï¼Œä¸”è¿™ä¸ªæ–°å‡½æ•°å¯ä»¥å½“åšæ™®é€šå‡½æ•°è¿›è¡Œè°ƒç”¨ã€‚

ä¸‹é¢è¿™æ®µä»£ç å’Œç¨‹åºæ¸…å• 4 è¾“å‡ºç»“æœä¸€æ‘¸ä¸€æ ·ï¼Œåªæ˜¯ç”¨äº† python æä¾›çš„è£…é¥°å™¨è¯­æ³•ï¼Œçœ‹èµ·æ¥æ›´åŠ ç®€å•ç›´æ¥ã€‚

```python
    def bread(func):
        def wrapper():
            print "</''''''\>"
            func()
            print "</______\>"
        return wrapper

    @bread
    def sandwich(food="--ham--"):
        print food
```
åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬åº”è¯¥å·²ç»èƒ½å¤Ÿç†è§£è£…é¥°å™¨çš„ä½œç”¨å’Œç”¨æ³•äº†ï¼Œå†å¼ºè°ƒä¸€éï¼šè£…é¥°å™¨æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ¥æ”¶å…¶ä»–å‡½æ•°ä½œä¸ºå‚æ•°ï¼Œå¹¶å°†å…¶ä»¥ä¸€ä¸ªæ–°çš„ä¿®æ”¹åçš„å‡½æ•°è¿›è¡Œæ›¿æ¢

## ä½¿ç”¨è£…é¥°å™¨éœ€è¦æ³¨æ„çš„åœ°æ–¹

æˆ‘ä»¬åœ¨ä¸Šä¸€èŠ‚ä¸­æ¼”ç¤ºäº†è£…é¥°å™¨çš„ç”¨æ³•ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œè£…é¥°å™¨å…¶å®å¾ˆå¥½ç†è§£ï¼Œä¹Ÿéå¸¸ç®€å•ã€‚ä½†æ˜¯ï¼Œè¦ç”¨å¥½è£…é¥°å™¨ï¼Œè¿˜æœ‰ä¸€äº›æˆ‘ä»¬éœ€è¦æ³¨æ„çš„åœ°æ–¹ï¼Œè¿™ä¸€èŠ‚å°±å¯¹è¿™äº›éœ€è¦æ³¨æ„çš„åœ°æ–¹è¿›è¡Œäº†è®¨è®ºï¼Œé¦–å…ˆè®¨è®ºäº†åœ¨ä½¿ç”¨è£…é¥°å™¨çš„æƒ…å†µä¸‹ï¼Œå¦‚ä½•ä¿ç•™åŸæœ‰å‡½æ•°çš„å±æ€§(è§ 3.1 èŠ‚)ï¼›ç„¶åè®¨è®ºäº†å¦‚ä½•å®ç°ä¸€ä¸ªæ›´åŠ æ™ºèƒ½çš„è£…é¥°å™¨ï¼›ä¹‹åè®¨è®ºäº†ä½¿ç”¨å¤šä¸ªè£…é¥°å™¨æ—¶ï¼Œå„ä¸ªè£…é¥°å™¨çš„è°ƒç”¨é¡ºåº(è§ 3.3 èŠ‚)ï¼›æœ€åè¯´æ˜äº†å¦‚ä½•ç»™è£…é¥°å™¨ä¼ é€’å‚æ•°(è§ 3.4 èŠ‚)ã€‚

### å‡½æ•°çš„å±æ€§å˜åŒ–

è£…é¥°å™¨åŠ¨æ€åˆ›å»ºçš„æ–°å‡½æ•°æ›¿æ¢åŸæ¥çš„å‡½æ•°ï¼Œä½†æ˜¯ï¼Œæ–°å‡½æ•°ç¼ºå°‘å¾ˆå¤šåŸå‡½æ•°çš„å±æ€§ï¼Œå¦‚ docstring å’Œåå­—ã€‚
```python
    def is_admin(f):
        def wrapper(*args, **kwargs):
            if kwargs.get("username") != 'admin':
                raise Exception("This user is not allowed to get food")
            return f(*args, **kwargs)
        return wrapper

    def foobar(username='someone'):
        """Do crazy stuff"""
        pass

    @is_admin
    def barfoo(username='someone'):
        """Do crazy stuff"""
        pass

    def main():
        print foobar.func_doc
        print foobar.__name__

        print barfoo.func_doc
        print barfoo.__name__

    if __name__ == '__main__':
        main()
```
ç¨‹åºæ¸…å• 6 çš„è¾“å‡ºç»“æœï¼š
```plain
    Do crazy stuff
    foobar

    None
    wrapper
```
ç¨‹åºæ¸…å• 6 ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸¤ä¸ªå‡½æ•°`foobar`ä¸`barfoo`ï¼Œå…¶ä¸­ï¼Œ`barfoo`ä½¿ç”¨è£…é¥°å™¨è¿›è¡Œäº†å°è£…ï¼Œæˆ‘ä»¬è·å–`foobar`ä¸`barfoo`çš„ docstring å’Œå‡½æ•°åå­—ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨äº†è£…é¥°å™¨çš„å‡½æ•°ï¼Œä¸èƒ½å¤Ÿæ­£ç¡®è·å–å‡½æ•°åŸæœ‰çš„ docstring ä¸åå­—ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨ python å†…ç½®çš„ functools æ¨¡å—ã€‚

```python
    import functools

    def is_admin(f):
        @functools.wraps(f)
        def wrapper(*args, **kwargs):
            if kwargs.get("username") != 'admin':
                raise Exception("This user is not allowed to get food")
            return f(*arg, **kwargs)
        return wrapper
```
æˆ‘ä»¬åªéœ€è¦å¢åŠ ä¸€è¡Œä»£ç ï¼Œå°±èƒ½å¤Ÿæ­£ç¡®åœ°è·å–å‡½æ•°çš„å±æ€§ã€‚

æ­¤å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å‘ä¸‹é¢è¿™æ ·ï¼š
```python
    def is_admin(f):
        def wrapper(*args, **kwargs):
            if kwargs.get("username") != 'admin':
                raise Exception("This user is not allowed to get food")
            return f(*args, **kwargs)
        return functools.wraps(f)(wrapper) # important
```
å½“ç„¶ï¼Œä¸ªäººæ¨èç¬¬ä¸€ç§æ–¹æ³•ï¼Œå› ä¸ºç¬¬ä¸€ç§æ–¹æ³•å¯è¯»æ€§æ›´å¼ºã€‚

### ä½¿ç”¨ inspect è·å–å‡½æ•°å‚æ•°

ä¸‹é¢çœ‹ä¸€ä¸‹ç¨‹åºæ¸…å• 8,å®ƒæ˜¯å¦ä¼šæ­£ç¡®è¾“å‡ºç»“æœå‘¢ï¼Ÿ
```python
# **ç¨‹åºæ¸…å•8**

    import functools

    def check_is_admin(f):
        @functools.wraps(f)
        def wrapper(*args, **kwargs):
            print kwargs
            if kwargs.get('username') != 'admin':
                raise Exception("This user is not allowed to get food")
            return f(*args, **kwargs)
        return wrapper


    @check_is_admin
    def get_food(username, food='chocolate'):
        return "{0} get food: {1}".format(username, food)


    def main():
        print get_food('admin')

    if __name__ == '__main__':
        main()
```
ç¨‹åºæ¸…å• 8 ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œå› ä¸ºæˆ‘ä»¬ä¼ å…¥çš„`admin`æ˜¯ä¸€ä¸ªä½ç½®å‚æ•°ï¼Œè€Œæˆ‘ä»¬å´å»å…³é”®å­—å‚æ•°(kwargs)è·å–ç”¨æˆ·åï¼Œå› æ­¤ï¼Œ\`kwargs.get(â€˜usernameâ€™)è¿”å› Noneï¼Œé‚£ä¹ˆï¼Œæƒé™æ£€æŸ¥å‘ç°ï¼Œç”¨æˆ·æ²¡æœ‰ç›¸åº”çš„æƒé™ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚

ä¸ºäº†æä¾›ä¸€ä¸ªæ›´åŠ æ™ºèƒ½çš„è£…é¥°å™¨ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ python çš„ inspect æ¨¡å—ã€‚inspect èƒ½å¤Ÿå–å‡ºå‡½æ•°çš„ç­¾åï¼Œå¹¶å¯¹å…¶è¿›è¡Œæ“ä½œï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```python
# **ç¨‹åºæ¸…å•9**

    import functools
    import inspect

    def check_is_admin(f):
        @functools.wraps(f)
        def wrapper(*args, **kwargs):
            func_args = inspect.getcallargs(f, *args, **kwargs)
            print func_args
            if func_args.get('username') != 'admin':
                raise Exception("This user is not allowed to get food")
            return f(*args, **kwargs)
        return wrapper


    @check_is_admin
    def get_food(username, food='chocolate'):
        return "{0} get food: {1}".format(username, food)


    def main():
        print get_food('admin')

    if __name__ == '__main__':
        main()
```
æ‰¿æ‹…ä¸»è¦å·¥ä½œçš„å‡½æ•°æ˜¯ inspect.getcallargsï¼Œå®ƒè¿”å›ä¸€ä¸ªå°†å‚æ•°åå­—å’Œå€¼ä½œä¸ºé”®å€¼å¯¹çš„å­—å…¸ï¼Œè¿™ç¨‹åºæ¸…å• 7 ä¸­ï¼Œè¿™ä¸ªå‡½æ•°è¿”å›`{'username':'admin', 'food':'chocolate'}`ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬çš„è£…é¥°å™¨ä¸å¿…æ£€æŸ¥å‚æ•° username æ˜¯åŸºäºä½ç½®çš„å‚æ•°è¿˜æ˜¯åŸºäºå…³é”®å­—çš„å‚æ•°ï¼Œè€Œåªéœ€åœ¨å­—å…¸ä¸­æŸ¥æ‰¾å³å¯ã€‚

### å¤šä¸ªè£…é¥°å™¨çš„è°ƒç”¨é¡ºåº

å¤šä¸ªè£…é¥°å™¨çš„è°ƒç”¨é¡ºåºä¹Ÿå¾ˆå¥½ç†è§£ï¼Œæˆ‘ä»¬ä¸€ stackoverflow ä¸Šçš„[è¿™ä¸ª](http://stackoverflow.com/questions/739654/how-can-i-make-a-chain-of-function-decorators-in-python/1594484)é—®é¢˜ä¸ºä¾‹è¿›è¡Œè¯´æ˜ã€‚

- é—®é¢˜

```plain
How can I make two decorators in Python that would do the following?

@makebold
@makeitalic
def say():
   return "Hello"
which should return

<b><i>Hello</i></b>
```
- ç­”æ¡ˆ
```python
    def makebold(fn):
        def wrapped():
            return "<b>" + fn() + "</b>"
        return wrapped

    def makeitalic(fn):
        def wrapped():
            return "<i>" + fn() + "</i>"
        return wrapped

    @makebold
    @makeitalic
    def hello():
        return "hello world"

    print hello() ## returns <b><i>hello world</i></b>
```
- åˆ†æ
æˆ‘ä»¬åœ¨ 2.2 èŠ‚è¯´è¿‡ï¼Œè£…é¥°å™¨å°±æ˜¯åœ¨å¤–å±‚è¿›è¡Œäº†å°è£…ï¼š
 ```python
    @bread
    sandwich()

    sandwich_copy = bread(sandwich)
 ```
 é‚£ä¹ˆï¼Œå°è£…ä¸¤å±‚å¯ä»¥åƒè¿™æ ·ç†è§£ï¼š
 ```python
    @makebold
    @makeitalic
    hello()

    hello-copy = makebold(makeitalic(helo))
 ```
 å› æ­¤ï¼Œè¿™æ ·ç†è§£ä»¥åï¼Œå¯¹äºå¤šä¸ªè£…é¥°å™¨çš„è°ƒç”¨é¡ºåºï¼Œå°±ä¸å†æœ‰ç–‘é—®äº†ã€‚

### ç»™è£…é¥°å™¨ä¼ é€’å‚æ•°
ä¸‹é¢é€šè¿‡ä¸€ä¸ªå®˜æ–¹çš„[ä¾‹å­](https://wiki.python.org/moin/PythonDecoratorLibrary)æ¥çœ‹å¦‚ä½•ç»™è£…é¥°å™¨ä¼ é€’å‚æ•°ã€‚å®˜æ–¹ä»‹ç»äº†ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„è£…é¥°å™¨ï¼Œå³è®¾ç½®è¶…æ—¶å™¨ã€‚å¦‚æœå‡½æ•°è°ƒç”¨è¶…æ—¶ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚

```python
# **ç¨‹åºæ¸…å•10**

    def timeout(seconds, error_message = 'Function call timed out'):
       def decorated(func):
           def _handle_timeout(signum, frame):
               raise TimeoutError(error_message)

           def wrapper(*args, **kwargs):
               signal.signal(signal.SIGALRM, _handle_timeout)
               signal.alarm(seconds)
               try:
                   result = func(*args, **kwargs)
               finally:
                   signal.alarm(0)
               return result

           return functools.wraps(func)(wrapper)

       return decorated
```
ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š
```python
    import time

    @timeout(1, 'Function slow; aborted')
    def slow_function():
        time.sleep(5)
```
å¯¹åº”äºæˆ‘ä»¬è¿™ç¯‡åšå®¢ä¸€ç›´è®¨è®ºçš„ä¾‹å­ï¼Œä¼ é€’å‚æ•°çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š
```python
# **ç¨‹åºæ¸…å•11**

    def is_admin(admin='admin'):
        def decorated(f):
            @functools.wraps(f)
            def wrapper(*args, **kwargs):
                if kwargs.get("username") != admin:
                    raise Exception("This user is not allowed to get food")
                return f(*args, **kwargs)
            return wrapper
        return decorated


    @is_admin(admin='root')
    def barfoo(username='someone'):
        """Do crazy stuff"""
        print '{0} get food'.format(username)


    if __name__ == '__main__':
        barfoo(username='root')
```
## è£…é¥°å™¨çš„ä½¿ç”¨åœºæ™¯ä¸ç¼ºç‚¹


### è£…é¥°å™¨çš„ä½¿ç”¨åœºæ™¯

è£…é¥°å™¨è™½ç„¶è¯­æ³•æ¯”è¾ƒå¤æ‚ï¼Œä½†æ˜¯ï¼Œåœ¨ä¸€äº›åœºæ™¯ä¸‹ï¼Œä¹Ÿç¡®å®æ¯”è¾ƒæœ‰ç”¨ã€‚åŒ…æ‹¬ï¼š

*   æ³¨å…¥å‚æ•°ï¼ˆæä¾›é»˜è®¤å‚æ•°ï¼Œç”Ÿæˆå‚æ•°ï¼‰
*   è®°å½•å‡½æ•°è¡Œä¸ºï¼ˆæ—¥å¿—ã€ç¼“å­˜ã€è®¡æ—¶ä»€ä¹ˆçš„ï¼‰
*   é¢„å¤„ç†ï¼åå¤„ç†ï¼ˆé…ç½®ä¸Šä¸‹æ–‡ä»€ä¹ˆçš„ï¼‰
*   ä¿®æ”¹è°ƒç”¨æ—¶çš„ä¸Šä¸‹æ–‡ï¼ˆçº¿ç¨‹å¼‚æ­¥æˆ–è€…å¹¶è¡Œï¼Œç±»æ–¹æ³•ï¼‰

ä¸‹é¢è¿™ä¸ªä¾‹å­æ¼”ç¤ºäº†ä¸Šé¢æåˆ°çš„ 3 ä¸­æƒ…å†µï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š
```python
# **ç¨‹åºæ¸…å•12**

    def benchmark(func):
        """
        A decorator that prints the time a function takes
        to execute.
        """
        import time
        def wrapper(*args, **kwargs):
            t = time.clock()
            res = func(*args, **kwargs)
            print func.__name__, time.clock()-t
            return res
        return wrapper


    def logging(func):
        """
        A decorator that logs the activity of the script.
        (it actually just prints it, but it could be logging!)
        """
        def wrapper(*args, **kwargs):
            res = func(*args, **kwargs)
            print func.__name__, args, kwargs
            return res
        return wrapper


    def counter(func):
        """
        A decorator that counts and prints the number of times a function has been executed
        """
        def wrapper(*args, **kwargs):
            wrapper.count = wrapper.count + 1
            res = func(*args, **kwargs)
            print "{0} has been used: {1}x".format(func.__name__, wrapper.count)
            return res
        wrapper.count = 0
        return wrapper

    @counter
    @benchmark
    @logging
    def reverse_string(string):
        return str(reversed(string))
```
å…³äºè£…é¥°å™¨çš„ä¾‹å­ï¼Œå®˜æ–¹åˆ—å‡ºäº†ä¸€ä¸ªé•¿é•¿çš„åˆ—è¡¨ï¼Œè¿™é‡Œå¾ˆå¤šä»£ç å¯ä»¥ç›´æ¥æ‹¿æ¥ä½¿ç”¨ï¼Œå¦‚æœéœ€è¦è¯¦ç»†åœ°äº†è§£è£…é¥°å™¨çš„ä½¿ç”¨åœºæ™¯ï¼Œå¯ä»¥å­¦ä¹ ä¸€ä¸‹è¿™ä»½[åˆ—è¡¨](https://wiki.python.org/moin/PythonDecoratorLibrary)ã€‚

### è£…é¥°å™¨æœ‰å“ªäº›ç¼ºç‚¹

åœ¨æˆ‘ä»¬ç›®å‰çš„å®é™…é¡¹ç›®ä¸­ï¼Œè£…é¥°å™¨ä½¿ç”¨è¿˜ä¸å¤Ÿå¤šï¼Œæ‰€ä»¥æ²¡æœ‰ç§¯ç´¯å¾ˆå¤šçš„ç»éªŒï¼Œä¸‹é¢æ˜¯å›½å¤–å¤§ç¥ç»™å‡ºçš„[è£…é¥°å™¨çš„ç¼ºç‚¹](https://stackoverflow.com/questions/739654/how-to-make-a-chain-of-function-decorators/1594484#1594484)ï¼Œä»¥ä¾›å‚è€ƒï¼š

*   Decorators were introduced in Python 2.4, so be sure your code will be run on >= 2.4.
*   Decorators slow down the function call. Keep that in mind.
*   **You cannot un-decorate a function.** (There are hacks to create decorators that can be removed, but nobody uses them.) So once a function is decorated, itâ€™s decorated for all the code.
*   Decorators wrap functions, which can make them hard to debug.

## æ¨èé˜…è¯»

æœ¬æ–‡è¾ƒä¸ºå…¨é¢åœ°ä»‹ç»äº†è£…é¥°å™¨çš„ç”¨æ³•ï¼Œä¹Ÿç»™å‡ºäº†è£…é¥°å™¨çš„ä½¿ç”¨åœºæ™¯å’Œç¼ºç‚¹ã€‚å¦‚æœè¿˜éœ€è¦è¿›ä¸€æ­¥çš„å­¦ä¹ è£…é¥°å™¨ï¼Œå¯ä»¥äº†è§£ä¸€ä¸‹ä¸‹é¢è¿™å‡ ä»½èµ„æ–™ï¼š

*   [python decorator library](https://wiki.python.org/moin/PythonDecoratorLibrary)
*   [source code of flask](http://flask.pocoo.org/docs/0.10/)
*   [Magic decorator syntax for asynchronous code in Python](https://github.com/lalor/Tomorrow)
*   [A Python decorator that helps ensure that a Python Process is running only once](https://github.com/chriscannon/highlander)
- [æ·±å…¥æµ…å‡º Python è£…é¥°å™¨ | é˜¿é©¹](https://aju.space/2016/01/14/dive-into-python-decorator.html)